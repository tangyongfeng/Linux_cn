<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>在 Linux 命令行中使用 tcpdump 抓包</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Ricardo Gerardi tcpdump 是一款灵活、功能强大的抓包工具，能有效地帮助排查网络故障问题。 以我作为管理员的经验，在网络连接中经常 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2018/11/zai-linux-ming-ling-xing-zhong-shi-yong-tcpdump-zhua-bao.html" rel="bookmark"
           title="Permalink to 在 Linux 命令行中使用 tcpdump 抓包">在 Linux 命令行中使用 tcpdump 抓包</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-11-04T00:20:35+01:00">
                Published: Sun 04 November 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Ricardo Gerardi</p>
<blockquote>
<p><code>tcpdump</code> 是一款灵活、功能强大的抓包工具，能有效地帮助排查网络故障问题。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/201811/04/002029aif53buzlzlrbei2.jpg"></p>
<p>以我作为管理员的经验，在网络连接中经常遇到十分难以排查的故障问题。对于这类情况，<code>tcpdump</code> 便能派上用场。</p>
<p><code>tcpdump</code> 是一个命令行实用工具，允许你抓取和分析经过系统的流量数据包。它通常被用作于网络故障分析工具以及安全工具。</p>
<p><code>tcpdump</code> 是一款强大的工具，支持多种选项和过滤规则，适用场景十分广泛。由于它是命令行工具，因此适用于在远程服务器或者没有图形界面的设备中收集数据包以便于事后分析。它可以在后台启动，也可以用 cron 等定时工具创建定时任务启用它。</p>
<p>本文中，我们将讨论 <code>tcpdump</code> 最常用的一些功能。</p>
<h3>1、在 Linux 中安装 tcpdump</h3>
<p><code>tcpdump</code> 支持多种 Linux 发行版，所以你的系统中很有可能已经安装了它。用下面的命令检查一下是否已经安装了 <code>tcpdump</code>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>which<span class="w"> </span>tcpdump
/usr/sbin/tcpdump
</code></pre></div>

<p>如果还没有安装 <code>tcpdump</code>，你可以用软件包管理器安装它。 例如，在 CentOS 或者 Red Hat Enterprise 系统中，用如下命令安装 <code>tcpdump</code>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>tcpdump
</code></pre></div>

<p><code>tcpdump</code> 依赖于 <code>libpcap</code>，该库文件用于捕获网络数据包。如果该库文件也没有安装，系统会根据依赖关系自动安装它。</p>
<p>现在你可以开始抓包了。</p>
<h3>2、用 tcpdump 抓包</h3>
<p>使用 <code>tcpdump</code> 抓包，需要管理员权限，因此下面的示例中绝大多数命令都是以 <code>sudo</code> 开头。</p>
<p>首先，先用 <code>tcpdump -D</code> 命令列出可以抓包的网络接口：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">D</span>
<span class="mf">1.</span><span class="n">eth0</span>
<span class="mf">2.</span><span class="n">virbr0</span>
<span class="mf">3.</span><span class="n">eth1</span>
<span class="mf">4.</span><span class="ow">any</span><span class="w"> </span><span class="p">(</span><span class="n">Pseudo</span><span class="o">-</span><span class="n">device</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">captures</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">interfaces</span><span class="p">)</span>
<span class="mf">5.</span><span class="n">lo</span><span class="w"> </span><span class="o">[</span><span class="n">Loopback</span><span class="o">]</span>
</code></pre></div>

<p>如上所示，可以看到我的机器中所有可以抓包的网络接口。其中特殊接口 <code>any</code> 可用于抓取所有活动的网络接口的数据包。</p>
<p>我们就用如下命令先对 <code>any</code> 接口进行抓包：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>any
tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="w"> </span>or<span class="w"> </span>-vv<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
listening<span class="w"> </span>on<span class="w"> </span>any,<span class="w"> </span>link-type<span class="w"> </span>LINUX_SLL<span class="w"> </span><span class="o">(</span>Linux<span class="w"> </span>cooked<span class="o">)</span>,<span class="w"> </span>capture<span class="w"> </span>size<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
<span class="m">09</span>:56:18.293641<span class="w"> </span>IP<span class="w"> </span>rhel75.localdomain.ssh<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.56322:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">3770820720</span>:3770820916,<span class="w"> </span>ack<span class="w"> </span><span class="m">3503648727</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">76577898</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">510770929</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">196</span>
<span class="m">09</span>:56:18.293794<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.1.56322<span class="w"> </span>&gt;<span class="w"> </span>rhel75.localdomain.ssh:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">196</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">391</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">510771017</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">76577898</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">09</span>:56:18.295058<span class="w"> </span>IP<span class="w"> </span>rhel75.59883<span class="w"> </span>&gt;<span class="w"> </span>gateway.domain:<span class="w"> </span><span class="m">2486</span>+<span class="w"> </span>PTR?<span class="w"> </span><span class="m">1</span>.64.168.192.in-addr.arpa.<span class="w"> </span><span class="o">(</span><span class="m">43</span><span class="o">)</span>
<span class="m">09</span>:56:18.310225<span class="w"> </span>IP<span class="w"> </span>gateway.domain<span class="w"> </span>&gt;<span class="w"> </span>rhel75.59883:<span class="w"> </span><span class="m">2486</span><span class="w"> </span>NXDomain*<span class="w"> </span><span class="m">0</span>/1/0<span class="w"> </span><span class="o">(</span><span class="m">102</span><span class="o">)</span>
<span class="m">09</span>:56:18.312482<span class="w"> </span>IP<span class="w"> </span>rhel75.49685<span class="w"> </span>&gt;<span class="w"> </span>gateway.domain:<span class="w"> </span><span class="m">34242</span>+<span class="w"> </span>PTR?<span class="w"> </span><span class="m">28</span>.64.168.192.in-addr.arpa.<span class="w"> </span><span class="o">(</span><span class="m">44</span><span class="o">)</span>
<span class="m">09</span>:56:18.322425<span class="w"> </span>IP<span class="w"> </span>gateway.domain<span class="w"> </span>&gt;<span class="w"> </span>rhel75.49685:<span class="w"> </span><span class="m">34242</span><span class="w"> </span>NXDomain*<span class="w"> </span><span class="m">0</span>/1/0<span class="w"> </span><span class="o">(</span><span class="m">103</span><span class="o">)</span>
<span class="m">09</span>:56:18.323164<span class="w"> </span>IP<span class="w"> </span>rhel75.56631<span class="w"> </span>&gt;<span class="w"> </span>gateway.domain:<span class="w"> </span><span class="m">29904</span>+<span class="w"> </span>PTR?<span class="w"> </span><span class="m">1</span>.122.168.192.in-addr.arpa.<span class="w"> </span><span class="o">(</span><span class="m">44</span><span class="o">)</span>
<span class="m">09</span>:56:18.323342<span class="w"> </span>IP<span class="w"> </span>rhel75.localdomain.ssh<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.56322:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">196</span>:584,<span class="w"> </span>ack<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">76577928</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">510771017</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">388</span>
<span class="m">09</span>:56:18.323563<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.1.56322<span class="w"> </span>&gt;<span class="w"> </span>rhel75.localdomain.ssh:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">584</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">411</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">510771047</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">76577928</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">09</span>:56:18.335569<span class="w"> </span>IP<span class="w"> </span>gateway.domain<span class="w"> </span>&gt;<span class="w"> </span>rhel75.56631:<span class="w"> </span><span class="m">29904</span><span class="w"> </span>NXDomain*<span class="w"> </span><span class="m">0</span>/1/0<span class="w"> </span><span class="o">(</span><span class="m">103</span><span class="o">)</span>
<span class="m">09</span>:56:18.336429<span class="w"> </span>IP<span class="w"> </span>rhel75.44007<span class="w"> </span>&gt;<span class="w"> </span>gateway.domain:<span class="w"> </span><span class="m">61677</span>+<span class="w"> </span>PTR?<span class="w"> </span><span class="m">98</span>.122.168.192.in-addr.arpa.<span class="w"> </span><span class="o">(</span><span class="m">45</span><span class="o">)</span>
<span class="m">09</span>:56:18.336655<span class="w"> </span>IP<span class="w"> </span>gateway.domain<span class="w"> </span>&gt;<span class="w"> </span>rhel75.44007:<span class="w"> </span><span class="m">61677</span>*<span class="w"> </span><span class="m">1</span>/0/0<span class="w"> </span>PTR<span class="w"> </span>rhel75.<span class="w"> </span><span class="o">(</span><span class="m">65</span><span class="o">)</span>
<span class="m">09</span>:56:18.337177<span class="w"> </span>IP<span class="w"> </span>rhel75.localdomain.ssh<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.56322:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">584</span>:1644,<span class="w"> </span>ack<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">76577942</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">510771047</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">1060</span>

----<span class="w"> </span>SKIPPING<span class="w"> </span>LONG<span class="w"> </span>OUTPUT<span class="w"> </span>-----

<span class="m">09</span>:56:19.342939<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.1.56322<span class="w"> </span>&gt;<span class="w"> </span>rhel75.localdomain.ssh:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">1752016</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">1444</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">510772067</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">76578948</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
^C
<span class="m">9003</span><span class="w"> </span>packets<span class="w"> </span>captured
<span class="m">9010</span><span class="w"> </span>packets<span class="w"> </span>received<span class="w"> </span>by<span class="w"> </span>filter
<span class="m">7</span><span class="w"> </span>packets<span class="w"> </span>dropped<span class="w"> </span>by<span class="w"> </span>kernel
$
</code></pre></div>

<p><code>tcpdump</code> 会持续抓包直到收到中断信号。你可以按 <code>Ctrl+C</code> 来停止抓包。正如上面示例所示，<code>tcpdump</code> 抓取了超过 9000 个数据包。在这个示例中，由于我是通过 <code>ssh</code> 连接到服务器，所以 <code>tcpdump</code> 也捕获了所有这类数据包。<code>-c</code> 选项可以用于限制 <code>tcpdump</code> 抓包的数量：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>any<span class="w"> </span>-c<span class="w"> </span><span class="m">5</span>
tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="w"> </span>or<span class="w"> </span>-vv<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
listening<span class="w"> </span>on<span class="w"> </span>any,<span class="w"> </span>link-type<span class="w"> </span>LINUX_SLL<span class="w"> </span><span class="o">(</span>Linux<span class="w"> </span>cooked<span class="o">)</span>,<span class="w"> </span>capture<span class="w"> </span>size<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
<span class="m">11</span>:21:30.242740<span class="w"> </span>IP<span class="w"> </span>rhel75.localdomain.ssh<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.56322:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">3772575680</span>:3772575876,<span class="w"> </span>ack<span class="w"> </span><span class="m">3503651743</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">81689848</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">515883153</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">196</span>
<span class="m">11</span>:21:30.242906<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.1.56322<span class="w"> </span>&gt;<span class="w"> </span>rhel75.localdomain.ssh:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">196</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">1443</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">515883235</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">81689848</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">11</span>:21:30.244442<span class="w"> </span>IP<span class="w"> </span>rhel75.43634<span class="w"> </span>&gt;<span class="w"> </span>gateway.domain:<span class="w"> </span><span class="m">57680</span>+<span class="w"> </span>PTR?<span class="w"> </span><span class="m">1</span>.64.168.192.in-addr.arpa.<span class="w"> </span><span class="o">(</span><span class="m">43</span><span class="o">)</span>
<span class="m">11</span>:21:30.244829<span class="w"> </span>IP<span class="w"> </span>gateway.domain<span class="w"> </span>&gt;<span class="w"> </span>rhel75.43634:<span class="w"> </span><span class="m">57680</span><span class="w"> </span>NXDomain<span class="w"> </span><span class="m">0</span>/0/0<span class="w"> </span><span class="o">(</span><span class="m">43</span><span class="o">)</span>
<span class="m">11</span>:21:30.247048<span class="w"> </span>IP<span class="w"> </span>rhel75.33696<span class="w"> </span>&gt;<span class="w"> </span>gateway.domain:<span class="w"> </span><span class="m">37429</span>+<span class="w"> </span>PTR?<span class="w"> </span><span class="m">28</span>.64.168.192.in-addr.arpa.<span class="w"> </span><span class="o">(</span><span class="m">44</span><span class="o">)</span>
<span class="m">5</span><span class="w"> </span>packets<span class="w"> </span>captured
<span class="m">12</span><span class="w"> </span>packets<span class="w"> </span>received<span class="w"> </span>by<span class="w"> </span>filter
<span class="m">0</span><span class="w"> </span>packets<span class="w"> </span>dropped<span class="w"> </span>by<span class="w"> </span>kernel
$
</code></pre></div>

<p>如上所示，<code>tcpdump</code> 在抓取 5 个数据包后自动停止了抓包。这在有些场景中十分有用 —— 比如你只需要抓取少量的数据包用于分析。当我们需要使用过滤规则抓取特定的数据包（如下所示）时，<code>-c</code> 的作用就十分突出了。</p>
<p>在上面示例中，<code>tcpdump</code> 默认是将 IP 地址和端口号解析为对应的接口名以及服务协议名称。而通常在网络故障排查中，使用 IP 地址和端口号更便于分析问题；用 <code>-n</code> 选项显示 IP 地址，<code>-nn</code> 选项显示端口号：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>any<span class="w"> </span>-c5<span class="w"> </span>-nn
tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="w"> </span>or<span class="w"> </span>-vv<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
listening<span class="w"> </span>on<span class="w"> </span>any,<span class="w"> </span>link-type<span class="w"> </span>LINUX_SLL<span class="w"> </span><span class="o">(</span>Linux<span class="w"> </span>cooked<span class="o">)</span>,<span class="w"> </span>capture<span class="w"> </span>size<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
<span class="m">23</span>:56:24.292206<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.28.22<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.35110:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">166198580</span>:166198776,<span class="w"> </span>ack<span class="w"> </span><span class="m">2414541257</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">615664</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">540031155</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">196</span>
<span class="m">23</span>:56:24.292357<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.1.35110<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.28.22:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">196</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">1377</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">540031229</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">615664</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">23</span>:56:24.292570<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.28.22<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.35110:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">196</span>:568,<span class="w"> </span>ack<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">615664</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">540031229</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">372</span>
<span class="m">23</span>:56:24.292655<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.1.35110<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.28.22:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">568</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">1400</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">540031229</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">615664</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">23</span>:56:24.292752<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.64.28.22<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.64.1.35110:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">568</span>:908,<span class="w"> </span>ack<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">309</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">615664</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">540031229</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">340</span>
<span class="m">5</span><span class="w"> </span>packets<span class="w"> </span>captured
<span class="m">6</span><span class="w"> </span>packets<span class="w"> </span>received<span class="w"> </span>by<span class="w"> </span>filter
<span class="m">0</span><span class="w"> </span>packets<span class="w"> </span>dropped<span class="w"> </span>by<span class="w"> </span>kernel
</code></pre></div>

<p>如上所示，抓取的数据包中显示 IP 地址和端口号。这样还可以阻止 <code>tcpdump</code> 发出 DNS 查找，有助于在网络故障排查中减少数据流量。</p>
<p>现在你已经会抓包了，让我们来分析一下这些抓包输出的含义吧。</p>
<h3>3、理解抓取的报文</h3>
<p><code>tcpdump</code> 能够抓取并解码多种协议类型的数据报文，如 TCP、UDP、ICMP 等等。虽然这里我们不可能介绍所有的数据报文类型，但可以分析下 TCP 类型的数据报文，来帮助你入门。更多有关 <code>tcpdump</code> 的详细介绍可以参考其 <a href="http://www.tcpdump.org/manpages/tcpdump.1.html#lbAG">帮助手册</a>。<code>tcpdump</code> 抓取的 TCP 报文看起来如下：</p>
<div class="highlight"><pre><span></span><code><span class="mi">08</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mf">13.729687</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">64.28</span><span class="o">.</span><span class="mi">22</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">64.1</span><span class="o">.</span><span class="mi">41916</span><span class="o">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P</span><span class="o">.],</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">196</span><span class="o">:</span><span class="mi">568</span><span class="o">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">309</span><span class="o">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop</span><span class="o">,</span><span class="n">nop</span><span class="o">,</span><span class="n">TS</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="mi">117964079</span><span class="w"> </span><span class="n">ecr</span><span class="w"> </span><span class="mi">816509256</span><span class="o">],</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">372</span>
</code></pre></div>

<p>具体的字段根据不同的报文类型会有不同，但上面这个例子是一般的格式形式。</p>
<p>第一个字段 <code>08:41:13.729687</code> 是该数据报文被抓取的系统本地时间戳。</p>
<p>然后，<code>IP</code> 是网络层协议类型，这里是 <code>IPv4</code>，如果是 <code>IPv6</code> 协议，该字段值是 <code>IP6</code>。</p>
<p><code>192.168.64.28.22</code> 是源 ip 地址和端口号，紧跟其后的是目的 ip 地址和其端口号，这里是 <code>192.168.64.1.41916</code>。</p>
<p>在源 IP 和目的 IP 之后，可以看到是 TCP 报文标记段 <code>Flags [P.]</code>。该字段通常取值如下：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>标志类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>S</td>
<td>SYN</td>
<td>Connection Start</td>
</tr>
<tr>
<td>F</td>
<td>FIN</td>
<td>Connection Finish</td>
</tr>
<tr>
<td>P</td>
<td>PUSH</td>
<td>Data push</td>
</tr>
<tr>
<td>R</td>
<td>RST</td>
<td>Connection reset</td>
</tr>
<tr>
<td>.</td>
<td>ACK</td>
<td>Acknowledgment</td>
</tr>
</tbody>
</table>
<p>该字段也可以是这些值的组合，例如 <code>[S.]</code> 代表 <code>SYN-ACK</code> 数据包。</p>
<p>接下来是该数据包中数据的序列号。对于抓取的第一个数据包，该字段值是一个绝对数字，后续包使用相对数值，以便更容易查询跟踪。例如此处 <code>seq 196:568</code> 代表该数据包包含该数据流的第 196 到 568 字节。</p>
<p>接下来是 ack 值：<code>ack 1</code>。该数据包是数据发送方，ack 值为 1。在数据接收方，该字段代表数据流上的下一个预期字节数据，例如，该数据流中下一个数据包的 ack 值应该是 568。</p>
<p>接下来字段是接收窗口大小 <code>win 309</code>，它表示接收缓冲区中可用的字节数，后跟 TCP 选项如 MSS（最大段大小）或者窗口比例值。更详尽的 TCP 协议内容请参考 <a href="https://www.iana.org/assignments/tcp-parameters/tcp-parameters.xhtml">Transmission Control Protocol(TCP) Parameters</a>。</p>
<p>最后，<code>length 372</code> 代表数据包有效载荷字节长度。这个长度和 seq 序列号中字节数值长度是不一样的。</p>
<p>现在让我们学习如何过滤数据报文以便更容易的分析定位问题。</p>
<h3>4、过滤数据包</h3>
<p>正如上面所提，<code>tcpdump</code> 可以抓取很多种类型的数据报文，其中很多可能和我们需要查找的问题并没有关系。举个例子，假设你正在定位一个与 web 服务器连接的网络问题，就不必关系 SSH 数据报文，因此在抓包结果中过滤掉 SSH 报文可能更便于你分析问题。</p>
<p><code>tcpdump</code> 有很多参数选项可以设置数据包过滤规则，例如根据源 IP 以及目的 IP 地址，端口号，协议等等规则来过滤数据包。下面就介绍一些最常用的过滤方法。</p>
<h4>协议</h4>
<p>在命令中指定协议便可以按照协议类型来筛选数据包。比方说用如下命令只要抓取 ICMP 报文：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>any<span class="w"> </span>-c5<span class="w"> </span>icmp
tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="w"> </span>or<span class="w"> </span>-vv<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
listening<span class="w"> </span>on<span class="w"> </span>any,<span class="w"> </span>link-type<span class="w"> </span>LINUX_SLL<span class="w"> </span><span class="o">(</span>Linux<span class="w"> </span>cooked<span class="o">)</span>,<span class="w"> </span>capture<span class="w"> </span>size<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
</code></pre></div>

<p>然后再打开一个终端，去 ping 另一台机器：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ping<span class="w"> </span>opensource.com
PING<span class="w"> </span>opensource.com<span class="w"> </span><span class="o">(</span><span class="m">54</span>.204.39.132<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span>ec2-54-204-39-132.compute-1.amazonaws.com<span class="w"> </span><span class="o">(</span><span class="m">54</span>.204.39.132<span class="o">)</span>:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">47</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">39</span>.6<span class="w"> </span>ms
</code></pre></div>

<p>回到运行 <code>tcpdump</code> 命令的终端中，可以看到它筛选出了 ICMP 报文。这里 <code>tcpdump</code> 并没有显示有关 <code>opensource.com</code> 的域名解析数据包：</p>
<div class="highlight"><pre><span></span><code><span class="mi">09</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mf">20.136766</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">rhel75</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ec2</span><span class="o">-</span><span class="mi">54</span><span class="o">-</span><span class="mi">204</span><span class="o">-</span><span class="mi">39</span><span class="o">-</span><span class="mi">132</span><span class="o">.</span><span class="na">compute</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="na">amazonaws</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="w"> </span><span class="n">ICMP</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">request</span><span class="o">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">20361</span><span class="o">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">64</span>
<span class="mi">09</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mf">20.176402</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">ec2</span><span class="o">-</span><span class="mi">54</span><span class="o">-</span><span class="mi">204</span><span class="o">-</span><span class="mi">39</span><span class="o">-</span><span class="mi">132</span><span class="o">.</span><span class="na">compute</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="na">amazonaws</span><span class="o">.</span><span class="na">com</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rhel75</span><span class="o">:</span><span class="w"> </span><span class="n">ICMP</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">reply</span><span class="o">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">20361</span><span class="o">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">64</span>
<span class="mi">09</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mf">21.140230</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">rhel75</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ec2</span><span class="o">-</span><span class="mi">54</span><span class="o">-</span><span class="mi">204</span><span class="o">-</span><span class="mi">39</span><span class="o">-</span><span class="mi">132</span><span class="o">.</span><span class="na">compute</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="na">amazonaws</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="w"> </span><span class="n">ICMP</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">request</span><span class="o">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">20361</span><span class="o">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">64</span>
<span class="mi">09</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mf">21.180020</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">ec2</span><span class="o">-</span><span class="mi">54</span><span class="o">-</span><span class="mi">204</span><span class="o">-</span><span class="mi">39</span><span class="o">-</span><span class="mi">132</span><span class="o">.</span><span class="na">compute</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="na">amazonaws</span><span class="o">.</span><span class="na">com</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rhel75</span><span class="o">:</span><span class="w"> </span><span class="n">ICMP</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">reply</span><span class="o">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">20361</span><span class="o">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">64</span>
<span class="mi">09</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mf">22.141777</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">rhel75</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ec2</span><span class="o">-</span><span class="mi">54</span><span class="o">-</span><span class="mi">204</span><span class="o">-</span><span class="mi">39</span><span class="o">-</span><span class="mi">132</span><span class="o">.</span><span class="na">compute</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="na">amazonaws</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="w"> </span><span class="n">ICMP</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="n">request</span><span class="o">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">20361</span><span class="o">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">64</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<h4>主机</h4>
<p>用 <code>host</code> 参数只抓取和特定主机相关的数据包：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="o">-</span><span class="n">c5</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="k">host</span><span class="w"> </span><span class="mf">54.204.39.132</span>
<span class="nl">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">suppressed</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">decode</span>
<span class="n">listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">),</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="n">bytes</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">54</span><span class="err">:</span><span class="mf">20.042023</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39326</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1375157070</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">29200</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 122350391 ecr 0,nop,wscale 7</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">54</span><span class="err">:</span><span class="mf">20.088127</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39326</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1935542841</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1375157071</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">28960</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 522713542 ecr 122350391,nop,wscale 9</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">54</span><span class="err">:</span><span class="mf">20.088204</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39326</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 122350437 ecr 522713542</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">54</span><span class="err">:</span><span class="mf">20.088734</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39326</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 122350438 ecr 522713542</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">112</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">54</span><span class="err">:</span><span class="mf">20.129733</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39326</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 522713552 ecr 122350438</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<p>如上所示，只抓取和显示与 <code>54.204.39.132</code> 有关的数据包。</p>
<h4>端口号</h4>
<p><code>tcpdump</code> 可以根据服务类型或者端口号来筛选数据包。例如，抓取和 HTTP 服务相关的数据包：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="o">-</span><span class="n">c5</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">80</span>
<span class="nl">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">suppressed</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">decode</span>
<span class="n">listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">),</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="n">bytes</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">58</span><span class="err">:</span><span class="mf">28.790548</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39330</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1745665159</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">29200</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 122599140 ecr 0,nop,wscale 7</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">58</span><span class="err">:</span><span class="mf">28.834026</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39330</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">4063583040</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1745665160</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">28960</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 522775728 ecr 122599140,nop,wscale 9</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">58</span><span class="err">:</span><span class="mf">28.834093</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39330</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 122599183 ecr 522775728</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">58</span><span class="err">:</span><span class="mf">28.834588</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39330</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 122599184 ecr 522775728</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">112</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="mi">09</span><span class="err">:</span><span class="mi">58</span><span class="err">:</span><span class="mf">28.878445</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39330</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 522775739 ecr 122599184</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<h4>IP 地址/主机名</h4>
<p>同样，你也可以根据源 IP 地址或者目的 IP 地址或者主机名来筛选数据包。例如抓取源 IP 地址为 <code>192.168.122.98</code> 的数据包：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="o">-</span><span class="n">c5</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="mf">192.168.122.98</span>
<span class="nl">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">suppressed</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">decode</span>
<span class="n">listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">),</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="n">bytes</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">02</span><span class="err">:</span><span class="mf">15.220824</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39436</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.1.53</span><span class="err">:</span><span class="w"> </span><span class="mi">59332</span><span class="o">+</span><span class="w"> </span><span class="n">A</span><span class="vm">?</span><span class="w"> </span><span class="n">opensource</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">02</span><span class="err">:</span><span class="mf">15.220862</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39436</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.1.53</span><span class="err">:</span><span class="w"> </span><span class="mi">20749</span><span class="o">+</span><span class="w"> </span><span class="n">AAAA</span><span class="vm">?</span><span class="w"> </span><span class="n">opensource</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">02</span><span class="err">:</span><span class="mf">15.364062</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39334</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1108640533</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">29200</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 122825713 ecr 0,nop,wscale 7</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">02</span><span class="err">:</span><span class="mf">15.409229</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39334</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">669337581</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 122825758 ecr 522832372</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">02</span><span class="err">:</span><span class="mf">15.409667</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39334</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 122825759 ecr 522832372</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">112</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<p>注意此处示例中抓取了来自源 IP 地址 <code>192.168.122.98</code> 的 53 端口以及 80 端口的数据包，它们的应答包没有显示出来因为那些包的源 IP 地址已经变了。</p>
<p>相对的，使用 <code>dst</code> 就是按目的 IP/主机名来筛选数据包。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>tcpdump<span class="w"> </span>-i<span class="w"> </span>any<span class="w"> </span>-c5<span class="w"> </span>-nn<span class="w"> </span>dst<span class="w"> </span><span class="m">192</span>.168.122.98
tcpdump:<span class="w"> </span>verbose<span class="w"> </span>output<span class="w"> </span>suppressed,<span class="w"> </span>use<span class="w"> </span>-v<span class="w"> </span>or<span class="w"> </span>-vv<span class="w"> </span><span class="k">for</span><span class="w"> </span>full<span class="w"> </span>protocol<span class="w"> </span>decode
listening<span class="w"> </span>on<span class="w"> </span>any,<span class="w"> </span>link-type<span class="w"> </span>LINUX_SLL<span class="w"> </span><span class="o">(</span>Linux<span class="w"> </span>cooked<span class="o">)</span>,<span class="w"> </span>capture<span class="w"> </span>size<span class="w"> </span><span class="m">262144</span><span class="w"> </span>bytes
<span class="m">10</span>:05:03.572931<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.122.1.53<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.47049:<span class="w"> </span><span class="m">2248</span><span class="w"> </span><span class="m">1</span>/0/0<span class="w"> </span>A<span class="w"> </span><span class="m">54</span>.204.39.132<span class="w"> </span><span class="o">(</span><span class="m">48</span><span class="o">)</span>
<span class="m">10</span>:05:03.572944<span class="w"> </span>IP<span class="w"> </span><span class="m">192</span>.168.122.1.53<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.47049:<span class="w"> </span><span class="m">33770</span><span class="w"> </span><span class="m">0</span>/0/0<span class="w"> </span><span class="o">(</span><span class="m">32</span><span class="o">)</span>
<span class="m">10</span>:05:03.621833<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39338:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">3474204576</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">3256851264</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">28960</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1460</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">522874425</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">122993922</span>,nop,wscale<span class="w"> </span><span class="m">9</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">10</span>:05:03.667767<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39338:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">113</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">57</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">522874436</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">122993972</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">10</span>:05:03.672221<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39338:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1</span>:643,<span class="w"> </span>ack<span class="w"> </span><span class="m">113</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">57</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">522874437</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">122993972</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">642</span>:<span class="w"> </span>HTTP:<span class="w"> </span>HTTP/1.1<span class="w"> </span><span class="m">302</span><span class="w"> </span>Found
<span class="m">5</span><span class="w"> </span>packets<span class="w"> </span>captured
<span class="m">5</span><span class="w"> </span>packets<span class="w"> </span>received<span class="w"> </span>by<span class="w"> </span>filter
<span class="m">0</span><span class="w"> </span>packets<span class="w"> </span>dropped<span class="w"> </span>by<span class="w"> </span>kernel
</code></pre></div>

<h4>多条件筛选</h4>
<p>当然，可以使用多条件组合来筛选数据包，使用 <code>and</code> 以及 <code>or</code> 逻辑操作符来创建过滤规则。例如，筛选来自源 IP 地址 <code>192.168.122.98</code> 的 HTTP 数据包：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="o">-</span><span class="n">c5</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="mf">192.168.122.98</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">80</span>
<span class="nl">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">suppressed</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">decode</span>
<span class="n">listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">),</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="n">bytes</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">08</span><span class="err">:</span><span class="mf">00.472696</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39342</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">2712685325</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">29200</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 123170822 ecr 0,nop,wscale 7</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">08</span><span class="err">:</span><span class="mf">00.516118</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39342</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">268723504</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 123170865 ecr 522918648</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">08</span><span class="err">:</span><span class="mf">00.516583</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39342</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 123170866 ecr 522918648</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">112</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">08</span><span class="err">:</span><span class="mf">00.567044</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39342</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">643</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 123170916 ecr 522918661</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">08</span><span class="err">:</span><span class="mf">00.788153</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39342</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">F.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">643</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 123171137 ecr 522918661</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<p>你也可以使用括号来创建更为复杂的过滤规则，但在 shell 中请用引号包含你的过滤规则以防止被识别为 shell 表达式：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="o">-</span><span class="n">c5</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="ss">&quot;port 80 and (src 192.168.122.98 or src 54.204.39.132)&quot;</span>
<span class="nl">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">suppressed</span><span class="p">,</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="n">vv</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">decode</span>
<span class="n">listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">),</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="n">bytes</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mf">37.602214</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39346</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">871108679</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">29200</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 123327951 ecr 0,nop,wscale 7</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mf">37.650651</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39346</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">854753193</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">871108680</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">28960</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 522957932 ecr 123327951,nop,wscale 9</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mf">37.650708</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39346</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 123328000 ecr 522957932</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mf">37.651097</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39346</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 123328000 ecr 522957932</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">112</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="mi">10</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mf">37.692900</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39346</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 522957942 ecr 123328000</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">5</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<p>该例子中我们只抓取了来自源 IP 为 <code>192.168.122.98</code> 或者 <code>54.204.39.132</code> 的 HTTP （端口号80）的数据包。使用该方法就很容易抓取到数据流中交互双方的数据包了。</p>
<h3>5、检查数据包内容</h3>
<p>在以上的示例中，我们只按数据包头部的信息来建立规则筛选数据包，例如源地址、目的地址、端口号等等。有时我们需要分析网络连接问题，可能需要分析数据包中的内容来判断什么内容需要被发送、什么内容需要被接收等。<code>tcpdump</code> 提供了两个选项可以查看数据包内容，<code>-X</code> 以十六进制打印出数据报文内容，<code>-A</code> 打印数据报文的 ASCII 值。</p>
<p>例如，HTTP 请求报文内容如下：</p>
<div class="highlight"><pre><span></span><code>$ sudo tcpdump -i any -c10 -nn -A port 80
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
13:02:14.871803 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [S], seq 2546602048, win 29200, options [mss 1460,sackOK,TS val 133625221 ecr 0,nop,wscale 7], length 0
E..<span class="p">&lt;</span><span class="nt">..</span><span class="err">@.@.....</span><span class="na">zb6</span><span class="err">.&#39;....</span><span class="na">P</span><span class="err">...@......</span><span class="na">r</span><span class="err">............</span>
<span class="err">............................</span>
<span class="na">13:02:14</span><span class="err">.</span><span class="na">910734</span> <span class="na">IP</span> <span class="na">54</span><span class="err">.</span><span class="na">204</span><span class="err">.</span><span class="na">39</span><span class="err">.</span><span class="na">132</span><span class="err">.</span><span class="na">80</span> <span class="p">&gt;</span> 192.168.122.98.39366: Flags [S.], seq 1877348646, ack 2546602049, win 28960, options [mss 1460,sackOK,TS val 525532247 ecr 133625221,nop,wscale 9], length 0
E..<span class="p">&lt;</span><span class="nt">..</span><span class="err">@./..</span><span class="na">a6</span><span class="err">.&#39;...</span><span class="na">zb</span><span class="err">.</span><span class="na">P</span><span class="err">..</span><span class="na">o</span><span class="err">..&amp;...</span><span class="na">A</span><span class="err">..</span><span class="na">q</span> <span class="na">a</span><span class="err">..........</span>
<span class="err">.</span><span class="na">R</span><span class="err">.</span><span class="na">W</span><span class="err">.......</span>     <span class="err">................</span>
<span class="na">13:02:14</span><span class="err">.</span><span class="na">910832</span> <span class="na">IP</span> <span class="na">192</span><span class="err">.</span><span class="na">168</span><span class="err">.</span><span class="na">122</span><span class="err">.</span><span class="na">98</span><span class="err">.</span><span class="na">39366</span> <span class="p">&gt;</span> 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 133625260 ecr 525532247], length 0
E..4..@.@.....zb6.&#39;....P...Ao..&#39;...........
.....R.W................
13:02:14.911808 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 133625261 ecr 525532247], length 112: HTTP: GET / HTTP/1.1
E.....@.@..1..zb6.&#39;....P...Ao..&#39;...........
.....R.WGET / HTTP/1.1
User-Agent: Wget/1.14 (linux-gnu)
Accept: */*
Host: opensource.com
Connection: Keep-Alive

................
13:02:14.951199 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [.], ack 113, win 57, options [nop,nop,TS val 525532257 ecr 133625261], length 0
E..4.F@./..&quot;6.&#39;...zb.P..o..&#39;.......9.2.....
.R.a....................
13:02:14.955030 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 525532258 ecr 133625261], length 642: HTTP: HTTP/1.1 302 Found
E....G@./...6.&#39;...zb.P..o..&#39;.......9.......
.R.b....HTTP/1.1 302 Found
Server: nginx
Date: Sun, 23 Sep 2018 17:02:14 GMT
Content-Type: text/html; charset=iso-8859-1
Content-Length: 207
X-Content-Type-Options: nosniff
Location: https://opensource.com/
Cache-Control: max-age=1209600
Expires: Sun, 07 Oct 2018 17:02:14 GMT
X-Request-ID: v-6baa3acc-bf52-11e8-9195-22000ab8cf2d
X-Varnish: 632951979
Age: 0
Via: 1.1 varnish (Varnish/5.2)
X-Cache: MISS
Connection: keep-alive

<span class="cp">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>302 Found<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Found<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>The document has moved <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://opensource.com/&quot;</span><span class="p">&gt;</span>here<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
................
13:02:14.955083 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 133625304 ecr 525532258], length 0
E..4..@.@.....zb6.&#39;....P....o..............
.....R.b................
13:02:15.195524 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [F.], seq 113, ack 643, win 239, options [nop,nop,TS val 133625545 ecr 525532258], length 0
E..4..@.@.....zb6.&#39;....P....o..............
.....R.b................
13:02:15.236592 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 525532329 ecr 133625545], length 0
E..4.H@./.. 6.&#39;...zb.P..o..........9.I.....
.R......................
13:02:15.236656 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 644, win 239, options [nop,nop,TS val 133625586 ecr 525532329], length 0
E..4..@.@.....zb6.&#39;....P....o..............
.....R..................
10 packets captured
10 packets received by filter
0 packets dropped by kernel
</code></pre></div>

<p>这对定位一些普通 HTTP 调用 API 接口的问题很有用。当然如果是加密报文，这个输出也就没多大用了。</p>
<h3>6、保存抓包数据</h3>
<p><code>tcpdump</code> 提供了保存抓包数据的功能以便后续分析数据包。例如，你可以夜里让它在那里抓包，然后早上起来再去分析它。同样当有很多数据包时，显示过快也不利于分析，将数据包保存下来，更有利于分析问题。</p>
<p>使用 <code>-w</code> 选项来保存数据包而不是在屏幕上显示出抓取的数据包：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="o">-</span><span class="n">c10</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="o">-</span><span class="n">w</span><span class="w"> </span><span class="n">webserver</span><span class="p">.</span><span class="n">pcap</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="mi">80</span>
<span class="o">[</span><span class="n">sudo</span><span class="o">]</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nl">ricardo</span><span class="p">:</span>
<span class="nl">tcpdump</span><span class="p">:</span><span class="w"> </span><span class="n">listening</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="ow">any</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">),</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="n">bytes</span>
<span class="mi">10</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">captured</span>
<span class="mi">10</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">filter</span>
<span class="mi">0</span><span class="w"> </span><span class="n">packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">kernel</span>
</code></pre></div>

<p>该命令将抓取的数据包保存到文件 <code>webserver.pcap</code>。后缀名 <code>pcap</code> 表示文件是抓取的数据包格式。</p>
<p>正如示例中所示，保存数据包到文件中时屏幕上就没有任何有关数据报文的输出，其中 <code>-c10</code> 表示抓取到 10 个数据包后就停止抓包。如果想有一些反馈来提示确实抓取到了数据包，可以使用 <code>-v</code> 选项。</p>
<p><code>tcpdump</code> 将数据包保存在二进制文件中，所以不能简单的用文本编辑器去打开它。使用 <code>-r</code> 选项参数来阅读该文件中的报文内容：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">tcpdump</span><span class="w"> </span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="n">webserver</span><span class="p">.</span><span class="n">pcap</span>
<span class="n">reading</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">webserver</span><span class="p">.</span><span class="n">pcap</span><span class="p">,</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">LINUX_SLL</span><span class="w"> </span><span class="p">(</span><span class="n">Linux</span><span class="w"> </span><span class="n">cooked</span><span class="p">)</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.679494</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">3709732619</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">29200</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 135708029 ecr 0,nop,wscale 7</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.718932</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">S.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1999298316</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">3709732620</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">28960</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">mss 1460,sackOK,TS val 526052949 ecr 135708029,nop,wscale 9</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.719005</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 135708068 ecr 526052949</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.719186</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 135708068 ecr 526052949</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">112</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.756979</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 526052959 ecr 135708068</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.760122</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">P.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="mi">643</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 526052959 ecr 135708068</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">642</span><span class="err">:</span><span class="w"> </span><span class="nl">HTTP</span><span class="p">:</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">302</span><span class="w"> </span><span class="k">Found</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.760182</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">643</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 135708109 ecr 526052959</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">57.977602</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">F.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">643</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 135708327 ecr 526052959</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">58.022089</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">F.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">643</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 526053025 ecr 135708327</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">13</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">58.022132</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="mf">192.168.122.98.39378</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">54.204.39.132.80</span><span class="err">:</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="o">[</span><span class="n">.</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="w"> </span><span class="mi">644</span><span class="p">,</span><span class="w"> </span><span class="n">win</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">[</span><span class="n">nop,nop,TS val 135708371 ecr 526053025</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">0</span>
<span class="err">$</span>
</code></pre></div>

<p>这里不需要管理员权限 <code>sudo</code> 了，因为此刻并不是在网络接口处抓包。</p>
<p>你还可以使用我们讨论过的任何过滤规则来过滤文件中的内容，就像使用实时数据一样。 例如，通过执行以下命令从源 IP 地址 <code>54.204.39.132</code> 检查文件中的数据包：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>tcpdump<span class="w"> </span>-nn<span class="w"> </span>-r<span class="w"> </span>webserver.pcap<span class="w"> </span>src<span class="w"> </span><span class="m">54</span>.204.39.132
reading<span class="w"> </span>from<span class="w"> </span>file<span class="w"> </span>webserver.pcap,<span class="w"> </span>link-type<span class="w"> </span>LINUX_SLL<span class="w"> </span><span class="o">(</span>Linux<span class="w"> </span>cooked<span class="o">)</span>
<span class="m">13</span>:36:57.718932<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39378:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>S.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1999298316</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">3709732620</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">28960</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>mss<span class="w"> </span><span class="m">1460</span>,sackOK,TS<span class="w"> </span>val<span class="w"> </span><span class="m">526052949</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">135708029</span>,nop,wscale<span class="w"> </span><span class="m">9</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">13</span>:36:57.756979<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39378:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>.<span class="o">]</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">113</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">57</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">526052959</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">135708068</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
<span class="m">13</span>:36:57.760122<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39378:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>P.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">1</span>:643,<span class="w"> </span>ack<span class="w"> </span><span class="m">113</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">57</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">526052959</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">135708068</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">642</span>:<span class="w"> </span>HTTP:<span class="w"> </span>HTTP/1.1<span class="w"> </span><span class="m">302</span><span class="w"> </span>Found
<span class="m">13</span>:36:58.022089<span class="w"> </span>IP<span class="w"> </span><span class="m">54</span>.204.39.132.80<span class="w"> </span>&gt;<span class="w"> </span><span class="m">192</span>.168.122.98.39378:<span class="w"> </span>Flags<span class="w"> </span><span class="o">[</span>F.<span class="o">]</span>,<span class="w"> </span>seq<span class="w"> </span><span class="m">643</span>,<span class="w"> </span>ack<span class="w"> </span><span class="m">114</span>,<span class="w"> </span>win<span class="w"> </span><span class="m">57</span>,<span class="w"> </span>options<span class="w"> </span><span class="o">[</span>nop,nop,TS<span class="w"> </span>val<span class="w"> </span><span class="m">526053025</span><span class="w"> </span>ecr<span class="w"> </span><span class="m">135708327</span><span class="o">]</span>,<span class="w"> </span>length<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<h3>下一步做什么？</h3>
<p>以上的基本功能已经可以帮助你使用强大的 <code>tcpdump</code> 抓包工具了。更多的内容请参考 <a href="http://www.tcpdump.org/#">tcpdump 网站</a> 以及它的 <a href="http://www.tcpdump.org/manpages/tcpdump.1.html">帮助文件</a>。</p>
<p><code>tcpdump</code> 命令行工具为分析网络流量数据包提供了强大的灵活性。如果需要使用图形工具来抓包请参考 <a href="https://www.wireshark.org/">Wireshark</a>。</p>
<p>Wireshark 还可以用来读取 <code>tcpdump</code> 保存的 pcap 文件。你可以使用 <code>tcpdump</code> 命令行在没有 GUI 界面的远程机器上抓包然后在 Wireshark 中分析数据包。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>