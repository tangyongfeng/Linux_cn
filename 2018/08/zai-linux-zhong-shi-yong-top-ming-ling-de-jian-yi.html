<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>在 Linux 中使用 top 命令的建议</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Katie Mclaughlin 通过这篇教程提升你的 top 命令的知识。 尝试找出你的机器正在运行什么程序，以及哪个进程耗尽了内存导致系统 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2018/08/zai-linux-zhong-shi-yong-top-ming-ling-de-jian-yi.html" rel="bookmark"
           title="Permalink to 在 Linux 中使用 top 命令的建议">在 Linux 中使用 top 命令的建议</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-08-21T08:56:00+02:00">
                Published: Tue 21 August 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Katie Mclaughlin</p>
<blockquote>
<p>通过这篇教程提升你的 <code>top</code> 命令的知识。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/201808/21/085602sp8lg15nxbp9l18b.jpg"></p>
<p>尝试找出你的机器正在运行什么程序，以及哪个进程耗尽了内存导致系统非常非常慢 —— 这是 <code>top</code> 命令所能胜任的工作。</p>
<p><code>top</code> 是一个非常有用的程序，其作用类似于 Windows 任务管理器或 MacOS 的活动监视器。在 *nix 机器上运行 <code>top</code> 将实时显示系统上运行的进程的情况。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>top
</code></pre></div>

<p>取决于你运行的 <code>top</code> 版本，你会看到类似如下内容：</p>
<div class="highlight"><pre><span></span><code><span class="n">top</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">08</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">32</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">day</span><span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="p">:</span><span class="mi">09</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w">  </span><span class="nb">load</span><span class="w"> </span><span class="n">average</span><span class="p">:</span><span class="w"> </span><span class="mf">0.20</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12</span><span class="p">,</span><span class="w"> </span><span class="mf">0.10</span>
<span class="n">Tasks</span><span class="p">:</span><span class="w">   </span><span class="mi">3</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="n">running</span><span class="p">,</span><span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="n">sleeping</span><span class="p">,</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="n">stopped</span><span class="p">,</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="n">zombie</span>
<span class="o">%</span><span class="n">Cpu</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="w">  </span><span class="mf">0.5</span><span class="w"> </span><span class="n">us</span><span class="p">,</span><span class="w">  </span><span class="mf">0.3</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w">  </span><span class="mf">0.0</span><span class="w"> </span><span class="n">ni</span><span class="p">,</span><span class="w"> </span><span class="mf">99.2</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w">  </span><span class="mf">0.0</span><span class="w"> </span><span class="n">wa</span><span class="p">,</span><span class="w">  </span><span class="mf">0.0</span><span class="w"> </span><span class="n">hi</span><span class="p">,</span><span class="w">  </span><span class="mf">0.0</span><span class="w"> </span><span class="n">si</span><span class="p">,</span><span class="w">  </span><span class="mf">0.0</span><span class="w"> </span><span class="n">st</span>
<span class="n">KiB</span><span class="w"> </span><span class="n">Mem</span><span class="p">:</span><span class="w">   </span><span class="mi">4042284</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w">  </span><span class="mi">2523744</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w">  </span><span class="mi">1518540</span><span class="w"> </span><span class="n">free</span><span class="p">,</span><span class="w">   </span><span class="mi">263776</span><span class="w"> </span><span class="n">buffers</span>
<span class="n">KiB</span><span class="w"> </span><span class="n">Swap</span><span class="p">:</span><span class="w">  </span><span class="mi">1048572</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w">  </span><span class="mi">1048572</span><span class="w"> </span><span class="n">free</span><span class="o">.</span><span class="w">  </span><span class="mi">1804264</span><span class="w"> </span><span class="n">cached</span><span class="w"> </span><span class="n">Mem</span>

<span class="w">  </span><span class="n">PID</span><span class="w"> </span><span class="n">USER</span><span class="w">      </span><span class="n">PR</span><span class="w">  </span><span class="n">NI</span><span class="w">    </span><span class="n">VIRT</span><span class="w">    </span><span class="n">RES</span><span class="w">    </span><span class="n">SHR</span><span class="w"> </span><span class="n">S</span><span class="w">  </span><span class="o">%</span><span class="n">CPU</span><span class="w"> </span><span class="o">%</span><span class="n">MEM</span><span class="w">     </span><span class="n">TIME</span><span class="o">+</span><span class="w"> </span><span class="n">COMMAND</span>
<span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">20</span><span class="w">   </span><span class="mi">0</span><span class="w">   </span><span class="mi">21964</span><span class="w">   </span><span class="mi">3632</span><span class="w">   </span><span class="mi">3124</span><span class="w"> </span><span class="n">S</span><span class="w">   </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.1</span><span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="mf">00.23</span><span class="w"> </span><span class="n">bash</span>
<span class="w">  </span><span class="mi">193</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">20</span><span class="w">   </span><span class="mi">0</span><span class="w">  </span><span class="mi">123520</span><span class="w">  </span><span class="mi">29636</span><span class="w">   </span><span class="mi">8640</span><span class="w"> </span><span class="n">S</span><span class="w">   </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.7</span><span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="mf">00.58</span><span class="w"> </span><span class="n">flask</span>
<span class="w">  </span><span class="mi">195</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">20</span><span class="w">   </span><span class="mi">0</span><span class="w">   </span><span class="mi">23608</span><span class="w">   </span><span class="mi">2724</span><span class="w">   </span><span class="mi">2400</span><span class="w"> </span><span class="n">R</span><span class="w">   </span><span class="mf">0.0</span><span class="w">  </span><span class="mf">0.1</span><span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="mf">00.21</span><span class="w"> </span><span class="n">top</span>
</code></pre></div>

<p>你所用的 <code>top</code> 版本可能跟这个看起来不一样，特别是在显示的列上。</p>
<h3>如何阅读输出的内容</h3>
<p>你可以根据输出判断你正在运行的内容，但尝试去解释结果你可能会有些困惑。</p>
<p>前几行包含一堆统计信息（详细信息），后跟一个包含结果列的表（列）。让我们从后者开始吧。</p>
<h4>列</h4>
<p>这些是系统正在运行的进程。默认按 CPU 使用率降序排序。这意味着在列表顶部的程序正使用更多的 CPU 资源并对你的系统造成更重的负担。对于资源使用而言，这些程序是字面上的消耗资源最多的（top）进程。不得不说，<code>top</code> 这个名字起得很妙。</p>
<p>最右边的 <code>COMMAND</code> 一列报告进程名（启动它们的命令）。在这个例子里，进程名是 <code>bash</code>（一个我们正在运行 <code>top</code> 的命令解释器）、<code>flask</code>（一个 Python 写的 web 框架）和 <code>top</code> 自身。</p>
<p>其它列提供了关于进程的有用信息：</p>
<ul>
<li><code>PID</code>：进程 ID，一个用来定位进程的唯一标识符</li>
<li><code>USER</code>：运行进程的用户</li>
<li><code>PR</code>：任务的优先级</li>
<li><code>NI</code>：Nice 值，优先级的一个更好的表现形式</li>
<li><code>VIRT</code>：虚拟内存的大小，单位是 KiB（kibibytes）</li>
<li><code>RES</code>：常驻内存大小，单位是 KiB（物理内存和虚拟内存的一部分）</li>
<li><code>SHR</code>：共享内存大小，单位是 KiB（共享内存和虚拟内存的一部分）</li>
<li><code>S</code>：进程状态，一般 <strong>I</strong> 代表空闲，<strong>R</strong> 代表运行，<strong>S</strong> 代表休眠，<strong>Z</strong> 代表僵尸进程，<strong>T</strong> 或 <strong>t</strong> 代表停止（还有其它更少见的选项）</li>
<li><code>%CPU</code>：自从上次屏幕更新后的 CPU 使用率</li>
<li><code>%MEM</code>：自从上次屏幕更新后的 <code>RES</code> 常驻内存使用率</li>
<li><code>TIME+</code>：自从程序启动后总的 CPU 使用时间</li>
<li><code>COMMAND</code>：启动命令，如之前描述那样</li>
</ul>
<p>确切知道 <code>VIRT</code>，<code>RES</code> 和 <code>SHR</code> 值代表什么在日常操作中并不重要。重要的是要知道 <code>VIRT</code> 值最高的进程就是内存使用最多的进程。当你在用 <code>top</code> 排查为什么你的电脑运行无比卡的时候，那个 <code>VIRT</code> 数值最大的进程就是元凶。如果你想要知道共享内存和物理内存的确切意思，请查阅 <a href="http://man7.org/linux/man-pages/man1/top.1.html">top 手册</a>的 Linux Memory Types 段落。</p>
<p>是的，我说的是 kibibytes 而不是 kilobytes。通常称为 kilobyte 的 1024 值实际上是 kibibyte。希腊语的 kilo（χίλιοι）意思是一千（例如一千米是 1000 米，一千克是 1000 克）。Kibi 是 kilo 和 binary 的合成词，意思是 1024 字节（或者 2<sup> 10</sup> ）。但是，因为这个词很难说，所以很多人在说 1024 字节的时候会说 kilobyte。<code>top</code> 试图在这里使用恰当的术语，所以按它说的理解就好。</p>
<h4>屏幕更新说明</h4>
<p>实时屏幕更新是 Linux 程序可以做的 <strong>非常酷</strong> 的事之一。这意味着程序能实时更新它们显示的内容，所以看起来是动态的，即使它们用的是文本。非常酷！在我们的例子中，更新时间间隔很重要，因为一些统计数据（<code>%CPU</code> 和 <code>%MEM</code>）是基于上次屏幕更新的数值的。</p>
<p>因为我们运行在一个持久性的程序中，我们就可以输入一些命令来实时修改配置（而不是停止应用，然后用一个不同的命令行选项再次运行）。</p>
<p>按下 <code>h</code> 调用帮助界面，该界面也显示了默认延迟（屏幕更新的时间间隔）。这个值默认（大约）是 3 秒，但你可以输入 <code>d</code>（大概是 delay 的意思）或者 <code>s</code>（可能是 screen 或 seconds 的意思）来修改它。</p>
<h4>细节</h4>
<p>在进程列表上面有一大堆有用的信息。有些细节看起来有点儿奇怪，让人困惑。但是一旦你花点儿时间来逐个过一遍，你会发现，在紧要关头，这些是非常有用的。</p>
<p>第一行包含系统的大致信息：</p>
<ul>
<li><code>top</code>：我们正在运行 <code>top</code>！你好！<code>top</code>！</li>
<li><code>XX:YY:XX</code>：当前时间，每次屏幕更新的时候更新</li>
<li><code>up</code>（接下去是 <code>X day, YY:ZZ</code>）：系统的 <a href="https://en.wikipedia.org/wiki/Uptime">uptime</a>，或者自从系统启动后已经过去了多长时间</li>
<li><code>load average</code>（后跟三个数字）：分别是过去一分钟、五分钟、15 分钟的<a href="https://en.wikipedia.org/wiki/Load_(computing)">系统负载</a></li>
</ul>
<p>第二行（<code>Task</code>）显示了正在运行的任务的信息，不用解释。它显示了进程总数和正在运行的、休眠中的、停止的进程数和僵尸进程数。这实际上是上述 <code>S</code>（状态）列的总和。</p>
<p>第三行（<code>%Cpu(s)</code>）显示了按类型划分的 CPU 使用情况。数据是屏幕刷新之间的值。这些值是：</p>
<ul>
<li><code>us</code>：用户进程</li>
<li><code>sy</code>：系统进程</li>
<li><code>ni</code>：<a href="https://en.wikipedia.org/wiki/Nice_(Unix)#Etymology">nice</a> 用户进程</li>
<li><code>id</code>：CPU 的空闲时间，这个值比较高时说明系统比较空闲</li>
<li><code>wa</code>：等待时间，或者消耗在等待 I/O 完成的时间</li>
<li><code>hi</code>：消耗在硬件中断的时间</li>
<li><code>si</code>：消耗在软件中断的时间</li>
<li><code>st</code>：“虚拟机管理程序从该虚拟机窃取的时间”</li>
</ul>
<p>你可以通过点击 <code>t</code>（toggle）来展开或折叠 <code>Task</code> 和 <code>%Cpu(s)</code> 行。</p>
<p>第四行（<code>Kib Mem</code>）和第五行（<code>KiB Swap</code>）提供了内存和交换空间的信息。这些数值是：</p>
<ul>
<li>总内存容量</li>
<li>已用内存</li>
<li>空闲内存</li>
<li>内存的缓冲值</li>
<li>交换空间的缓存值</li>
</ul>
<p>默认它们是用 KiB 为单位展示的，但是按下 <code>E</code>（扩展内存缩放 extend memory scaling）可以轮换不同的单位：KiB、MiB、GiB、TiB、PiB、EiB（kilobytes、megabytes、gigabytes、terabytes、petabytes 和 exabytes）</p>
<p><code>top</code> 用户手册有更多选项和配置项信息。你可以运行 <code>man top</code> 来查看你系统上的文档。还有很多 <a href="http://man7.org/linux/man-pages/man1/top.1.html">HTML 版的 man 手册</a>，但是请留意，这些手册可能是针对不同 top 版本的。</p>
<h3>两个 top 的替代品</h3>
<p>你不必总是用 <code>top</code> 查看系统状态。你可以根据你的情况用其它工具来协助排查问题，尤其是当你想要更图形化或更专业的界面的时候。</p>
<h4>htop</h4>
<p><code>htop</code> 很像 <code>top</code>，但是它带来了一些非常有用的东西：它可以以图形界面展示 CPU 和内存使用情况。</p>
<p><img alt="" src="/data/attachment/album/201808/21/085623piirpzvx4rpxpyry.png"></p>
<p>这是我们在刚才运行 <code>top</code> 的同一环境中 <code>htop</code> 的样子。显示更简洁，但功能却很丰富。</p>
<p>任务统计、负载、uptime 和进程列表仍然在，但是它有了漂亮、彩色、动态的每核 CPU 使用情况，还有图形化的内存使用情况。</p>
<p>以下是不同颜色的含义（你也可以通过按下 <code>h</code> 来获得这些信息的帮助）。</p>
<p>CPU 任务优先级或类型：</p>
<ul>
<li>蓝色：低优先级</li>
<li>绿色：正常优先级</li>
<li>红色：内核任务</li>
<li>蓝色：虚拟任务</li>
<li>条状图末尾的值是已用 CPU 的百分比</li>
</ul>
<p>内存：</p>
<ul>
<li>绿色：已经使用的内存</li>
<li>蓝色：缓冲的内存</li>
<li>黄色：缓存内存</li>
<li>条状图末尾的值显示已用内存和总内存</li>
</ul>
<p>如果颜色对你没用，你可以运行 <code>htop -C</code> 来禁用它们；那样 <code>htop</code> 将使用不同的符号来展示 CPU 和内存类型。</p>
<p>它的底部有一组激活的快捷键提示，可以用来操作过滤结果或改变排序顺序。试着按一些快捷键看看它们能做什么。不过尝试 <code>F9</code> 时要小心，它会调出一个信号列表，这些信号会杀死（即停止）一个过程。我建议在生产环境之外探索这些选项。</p>
<p><code>htop</code> 的作者 Hisham Muhammad（是的，<code>htop</code> 的名字就是源自 Hisham 的）在二月份的 <a href="https://fosdem.org/2018/schedule/event/htop/">FOSDEM 2018</a> 做了一个<a href="https://www.youtube.com/watch?v=L25waVhy78o">简短的演讲</a>。他阐述了 <code>htop</code> 不仅有简洁的图形界面，还有更现代的进程信息统计展示方式，这都是之前的工具（如 <code>top</code>）所不具备的。</p>
<p>你可以在<a href="https://linux.die.net/man/1/htop">手册页面</a>或 <a href="https://hisham.hm/htop/index.php">htop 网站</a>阅读更多关于 <code>htop</code> 的信息。（提示：网站背景是一个动态的 <code>htop</code>。）</p>
<h4>docker stats</h4>
<p>如果你在用 Docker，你可以运行 <code>docker stats</code> 来为容器状态生成一个有丰富上下文的界面。</p>
<p>这可能比 <code>top</code> 更有帮助，因为它不是按进程分类，而是按容器分类的。这点特别有用，当某个容器运行缓慢时，查看哪个容器耗资源最多比运行 <code>top</code> 再找到容器的进程要快。</p>
<p>借助于上面对 <code>top</code> 和 <code>htop</code> 术语的解释，你应该会更容易理解 <code>docker stats</code> 中的那些。然而，<a href="https://docs.docker.com/engine/reference/commandline/stats/">docker stats 文档</a>对每一列都提供了详尽的描述。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>