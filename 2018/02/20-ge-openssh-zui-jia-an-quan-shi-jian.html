<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>20 个 OpenSSH 最佳安全实践</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Vivek Gite OpenSSH 是 SSH 协议的一个实现。一般通过 scp 或 sftp 用于远程登录、备份、远程文件传输等功能。SSH能够完美保障两个网络或系统间数据传输的保密性和完整性。尽管如此，它最大的优势是使 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2018/02/20-ge-openssh-zui-jia-an-quan-shi-jian.html" rel="bookmark"
           title="Permalink to 20 个 OpenSSH 最佳安全实践">20 个 OpenSSH 最佳安全实践</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-02-28T15:45:00+01:00">
                Published: Wed 28 February 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Vivek Gite</p>
<p><img alt="" src="/data/attachment/album/201802/28/154506wnfo36ipba3fxfya.jpg"></p>
<p>OpenSSH 是 SSH 协议的一个实现。一般通过 <code>scp</code> 或 <code>sftp</code> 用于远程登录、备份、远程文件传输等功能。SSH能够完美保障两个网络或系统间数据传输的保密性和完整性。尽管如此，它最大的优势是使用公匙加密来进行服务器验证。时不时会出现关于 OpenSSH 零日漏洞的<a href="https://isc.sans.edu/diary/OpenSSH+Rumors/6742">传言</a>。本文将描述如何设置你的 Linux 或类 Unix 系统以提高 sshd 的安全性。</p>
<h3>OpenSSH 默认设置</h3>
<ul>
<li>TCP 端口 - 22</li>
<li>OpenSSH 服务配置文件 - <code>sshd_config</code> (位于 <code>/etc/ssh/</code>）</li>
</ul>
<h3>1、 基于公匙的登录</h3>
<p>OpenSSH 服务支持各种验证方式。推荐使用公匙加密验证。首先，使用以下 <code>ssh-keygen</code> 命令在本地电脑上创建密匙对：</p>
<blockquote>
<p>1024 位或低于它的 DSA 和 RSA 加密是很弱的，请不要使用。当考虑 ssh 客户端向后兼容性的时候，请使用 RSA密匙代替 ECDSA 密匙。所有的 ssh 密钥要么使用 ED25519 ，要么使用 RSA，不要使用其它类型。</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>key_type<span class="w"> </span>-b<span class="w"> </span>bits<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;comment&quot;</span>
</code></pre></div>

<p>示例：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;Login to production cluster at xyz corp&quot;</span>
或
$<span class="w"> </span>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>rsa<span class="w"> </span>-b<span class="w"> </span><span class="m">4096</span><span class="w"> </span>-f<span class="w"> </span>~/.ssh/id_rsa_aws_<span class="k">$(</span>date<span class="w"> </span>+%Y-%m-%d<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;AWS key for abc corp clients&quot;</span>
</code></pre></div>

<p>下一步，使用 <code>ssh-copy-id</code> 命令安装公匙：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh-copy-id<span class="w"> </span>-i<span class="w"> </span>/path/to/public-key-file<span class="w"> </span>user@host
或
$<span class="w"> </span>ssh-copy-id<span class="w"> </span>user@remote-server-ip-or-dns-name
</code></pre></div>

<p>示例：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh-copy-id<span class="w"> </span>vivek@rhel7-aws-server
</code></pre></div>

<p>提示输入用户名和密码的时候，确认基于 ssh 公匙的登录是否工作：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh<span class="w"> </span>vivek@rhel7-aws-server
</code></pre></div>

<p><a href="https://www.cyberciti.biz/tips/wp-content/uploads/2009/07/OpenSSH-server-security-best-practices.png"><img alt="OpenSSH 服务安全最佳实践" src="/data/attachment/album/201802/28/154555diiz80sscg33mrci.png"></a></p>
<p>更多有关 ssh 公匙的信息，参照以下文章：</p>
<ul>
<li><a href="https://www.cyberciti.biz/faq/ssh-passwordless-login-with-keychain-for-scripts/">为备份脚本设置无密码安全登录</a></li>
<li><a href="/article-8086-1.html">sshpass：使用脚本密码登录 SSH 服务器</a></li>
<li><a href="https://www.cyberciti.biz/faq/how-to-set-up-ssh-keys-on-linux-unix/">如何为一个 Linux/类 Unix 系统设置 SSH 登录密匙</a></li>
<li><a href="https://www.cyberciti.biz/faq/how-to-upload-ssh-public-key-to-as-authorized_key-using-ansible/">如何使用 Ansible 工具上传 ssh 登录授权公匙</a></li>
</ul>
<h3>2、 禁用 root 用户登录</h3>
<p>禁用 root 用户登录前，确认普通用户可以以 root 身份登录。例如，允许用户 vivek 使用 <code>sudo</code> 命令以 root 身份登录。</p>
<h4>在 Debian/Ubuntu 系统中如何将用户 vivek 添加到 sudo 组中</h4>
<p>允许 sudo 组中的用户执行任何命令。 <a href="https://www.cyberciti.biz/faq/how-to-create-a-sudo-user-on-ubuntu-linux-server/">将用户 vivek 添加到 sudo 组中</a>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>adduser<span class="w"> </span>vivek<span class="w"> </span>sudo
</code></pre></div>

<p>使用 <a href="https://www.cyberciti.biz/faq/unix-linux-id-command-examples-usage-syntax/" title="See Linux/Unix id command examples for more info">id 命令</a> 验证用户组。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>id<span class="w"> </span>vivek
</code></pre></div>

<h4>在 CentOS/RHEL 系统中如何将用户 vivek 添加到 sudo 组中</h4>
<p>在 CentOS/RHEL 和 Fedora 系统中允许 wheel 组中的用户执行所有的命令。使用 <code>usermod</code> 命令将用户 vivek 添加到 wheel 组中：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>usermod<span class="w"> </span>-aG<span class="w"> </span>wheel<span class="w"> </span>vivek
$<span class="w"> </span>id<span class="w"> </span>vivek
</code></pre></div>

<h4>测试 sudo 权限并禁用 ssh root 登录</h4>
<p>测试并确保用户 vivek 可以以 root 身份登录执行以下命令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-i
$<span class="w"> </span>sudo<span class="w"> </span>/etc/init.d/sshd<span class="w"> </span>status
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>httpd
</code></pre></div>

<p>添加以下内容到 <code>sshd_config</code> 文件中来禁用 root 登录：</p>
<div class="highlight"><pre><span></span><code>PermitRootLogin no
ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no
</code></pre></div>

<p>更多信息参见“<a href="https://www.cyberciti.biz/faq/how-to-disable-ssh-password-login-on-linux/">如何通过禁用 Linux 的 ssh 密码登录来增强系统安全</a>” 。</p>
<h3>3、 禁用密码登录</h3>
<p>所有的密码登录都应该禁用，仅留下公匙登录。添加以下内容到 <code>sshd_config</code> 文件中：</p>
<div class="highlight"><pre><span></span><code>AuthenticationMethods publickey
PubkeyAuthentication yes
</code></pre></div>

<p>CentOS 6.x/RHEL 6.x 系统中老版本的 sshd 用户可以使用以下设置：</p>
<div class="highlight"><pre><span></span><code>PubkeyAuthentication yes
</code></pre></div>

<h3>4、 限制用户的 ssh 访问</h3>
<p>默认状态下，所有的系统用户都可以使用密码或公匙登录。但是有些时候需要为 FTP 或者 email 服务创建 UNIX/Linux 用户。然而，这些用户也可以使用 ssh 登录系统。他们将获得访问系统工具的完整权限，包括编译器和诸如 Perl、Python（可以打开网络端口干很多疯狂的事情）等的脚本语言。通过添加以下内容到 <code>sshd_config</code> 文件中来仅允许用户 root、vivek 和 jerry 通过 SSH 登录系统：</p>
<div class="highlight"><pre><span></span><code>AllowUsers vivek jerry
</code></pre></div>

<p>当然，你也可以添加以下内容到 <code>sshd_config</code> 文件中来达到仅拒绝一部分用户通过 SSH 登录系统的效果。</p>
<div class="highlight"><pre><span></span><code>DenyUsers root saroj anjali foo
</code></pre></div>

<p>你也可以通过<a href="https://www.cyberciti.biz/tips/linux-pam-configuration-that-allows-or-deny-login-via-the-sshd-server.html">配置 Linux PAM</a> 来禁用或允许用户通过 sshd 登录。也可以允许或禁止一个<a href="https://www.cyberciti.biz/tips/openssh-deny-or-restrict-access-to-users-and-groups.html">用户组列表</a>通过 ssh 登录系统。</p>
<h3>5、 禁用空密码</h3>
<p>你需要明确禁止空密码账户远程登录系统，更新 <code>sshd_config</code> 文件的以下内容：</p>
<div class="highlight"><pre><span></span><code>PermitEmptyPasswords no
</code></pre></div>

<h3>6、 为 ssh 用户或者密匙使用强密码</h3>
<p>为密匙使用强密码和短语的重要性再怎么强调都不过分。暴力破解可以起作用就是因为用户使用了基于字典的密码。你可以强制用户避开<a href="https://www.cyberciti.biz/tips/linux-check-passwords-against-a-dictionary-attack.html">字典密码</a>并使用<a href="https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/">约翰的开膛手工具</a>来检测弱密码。以下是一个随机密码生成器（放到你的 <code>~/.bashrc</code> 下）：</p>
<div class="highlight"><pre><span></span><code>genpasswd()<span class="w"> </span>{
<span class="w">    </span>local<span class="w"> </span>l=$1
<span class="w">    </span>[<span class="w"> </span>&quot;<span class="nv">$l</span>&quot;<span class="w"> </span>==<span class="w"> </span>&quot;&quot;<span class="w"> </span>]<span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>l=20
<span class="w">    </span>tr<span class="w"> </span>-dc<span class="w"> </span>A-Za-z0-9_<span class="w"> </span><span class="err">&lt;</span><span class="w"> </span>/dev/urandom<span class="w"> </span>|<span class="w"> </span>head<span class="w"> </span>-c<span class="w"> </span><span class="cp">${</span><span class="n">l</span><span class="cp">}</span><span class="w"> </span>|<span class="w"> </span>xargs
}
</code></pre></div>

<p>运行：</p>
<div class="highlight"><pre><span></span><code>genpasswd 16
</code></pre></div>

<p>输出：</p>
<div class="highlight"><pre><span></span><code>uw8CnDVMwC6vOKgW
</code></pre></div>

<ul>
<li><a href="https://www.cyberciti.biz/faq/generating-random-password/">使用 mkpasswd / makepasswd / pwgen 生成随机密码</a></li>
<li><a href="https://www.cyberciti.biz/faq/linux-unix-generating-passwords-command/">Linux / UNIX: 生成密码</a></li>
<li><a href="https://www.cyberciti.biz/faq/linux-random-password-generator/">Linux 随机密码生成命令</a></li>
</ul>
<h3>7、 为 SSH 的 22端口配置防火墙</h3>
<p>你需要更新 <code>iptables</code>/<code>ufw</code>/<code>firewall-cmd</code> 或 pf 防火墙配置来为 ssh 的 TCP 端口 22 配置防火墙。一般来说，OpenSSH 服务应该仅允许本地或者其他的远端地址访问。</p>
<h4>Netfilter（Iptables） 配置</h4>
<p>更新 <a href="https://www.cyberciti.biz/faq/rhel-fedorta-linux-iptables-firewall-configuration-tutorial/">/etc/sysconfig/iptables （Redhat 和其派生系统特有文件）</a>  实现仅接受来自于 192.168.1.0/24 和 202.54.1.5/29 的连接，输入：</p>
<div class="highlight"><pre><span></span><code>-A RH-Firewall-1-INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -s 202.54.1.5/29 -m state --state NEW -p tcp --dport 22 -j ACCEPT
</code></pre></div>

<p>如果同时使用 IPv6 的话，可以编辑 <code>/etc/sysconfig/ip6tables</code> （Redhat 和其派生系统特有文件），输入：</p>
<div class="highlight"><pre><span></span><code>-A RH-Firewall-1-INPUT -s ipv6network::/ipv6mask -m tcp -p tcp --dport 22 -j ACCEPT
</code></pre></div>

<p>将 <code>ipv6network::/ipv6mask</code> 替换为实际的 IPv6 网段。</p>
<h4>Debian/Ubuntu Linux 下的 UFW</h4>
<p><a href="https://www.cyberciti.biz/faq/howto-configure-setup-firewall-with-ufw-on-ubuntu-linux/">UFW 是 Uncomplicated FireWall 的首字母缩写，主要用来管理 Linux 防火墙</a>，目的是提供一种用户友好的界面。输入<a href="https://www.cyberciti.biz/faq/ufw-allow-incoming-ssh-connections-from-a-specific-ip-address-subnet-on-ubuntu-debian/">以下命令使得系统仅允许网段 202.54.1.5/29 接入端口 22</a>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>ufw<span class="w"> </span>allow<span class="w"> </span>from<span class="w"> </span><span class="m">202</span>.54.1.5/29<span class="w"> </span>to<span class="w"> </span>any<span class="w"> </span>port<span class="w"> </span><span class="m">22</span>
</code></pre></div>

<p>更多信息请参见 “<a href="https://www.cyberciti.biz/tips/linux-iptables-examples.html">Linux：菜鸟管理员的 25 个 Iptables Netfilter 命令</a>”。</p>
<h4>*BSD PF 防火墙配置</h4>
<p>如果使用 PF 防火墙 <a href="https://bash.cyberciti.biz/firewall/pf-firewall-script/">/etc/pf.conf</a> 配置如下：</p>
<div class="highlight"><pre><span></span><code>pass in on $ext_if inet proto tcp from {192.168.1.0/24, 202.54.1.5/29} to $ssh_server_ip port ssh flags S/SA synproxy state
</code></pre></div>

<h3>8、 修改 SSH 端口和绑定 IP</h3>
<p>ssh 默认监听系统中所有可用的网卡。修改并绑定 ssh 端口有助于避免暴力脚本的连接（许多暴力脚本只尝试端口 22）。更新文件 <code>sshd_config</code> 的以下内容来绑定端口 300 到 IP 192.168.1.5 和 202.54.1.5：</p>
<div class="highlight"><pre><span></span><code>Port 300 
ListenAddress 192.168.1.5
ListenAddress 202.54.1.5
</code></pre></div>

<p>当需要接受动态广域网地址的连接时，使用主动脚本是个不错的选择，比如 fail2ban 或 denyhosts。</p>
<h3>9、 使用 TCP wrappers （可选的）</h3>
<p>TCP wrapper 是一个基于主机的访问控制系统，用来过滤来自互联网的网络访问。OpenSSH 支持 TCP wrappers。只需要更新文件 <code>/etc/hosts.allow</code> 中的以下内容就可以使得 SSH 只接受来自于 192.168.1.2 和 172.16.23.12 的连接：</p>
<div class="highlight"><pre><span></span><code><span class="n">sshd</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span><span class="w"> </span><span class="mf">172.16</span><span class="o">.</span><span class="mf">23.12</span>
</code></pre></div>

<p>在 Linux/Mac OS X 和类 UNIX 系统中参见 <a href="https://www.cyberciti.biz/faq/tcp-wrappers-hosts-allow-deny-tutorial/">TCP wrappers 设置和使用的常见问题</a>。</p>
<h3>10、 阻止 SSH 破解或暴力攻击</h3>
<p>暴力破解是一种在单一或者分布式网络中使用大量（用户名和密码的）组合来尝试连接一个加密系统的方法。可以使用以下软件来应对暴力攻击：</p>
<ul>
<li><a href="https://www.cyberciti.biz/faq/block-ssh-attacks-with-denyhosts/">DenyHosts</a> 是一个基于 Python SSH 安全工具。该工具通过监控授权日志中的非法登录日志并封禁原始 IP 的方式来应对暴力攻击。<ul>
<li>RHEL / Fedora 和 CentOS Linux 下如何设置 <a href="https://www.cyberciti.biz/faq/rhel-linux-block-ssh-dictionary-brute-force-attacks/">DenyHosts</a>。</li>
</ul>
</li>
<li><a href="https://www.fail2ban.org">Fail2ban</a> 是另一个类似的用来预防针对 SSH 攻击的工具。</li>
<li><a href="https://sshguard.sourceforge.net/">sshguard</a> 是一个使用 pf 来预防针对 SSH 和其他服务攻击的工具。</li>
<li><a href="http://www.bsdconsulting.no/tools/">security/sshblock</a> 阻止滥用 SSH 尝试登录。</li>
<li><a href="https://savannah.nongnu.org/projects/ipqbdb/">IPQ BDB filter</a> 可以看做是 fail2ban 的一个简化版。</li>
</ul>
<h3>11、 限制 TCP 端口 22 的传入速率（可选的）</h3>
<p>netfilter 和 pf 都提供速率限制选项可以对端口 22 的传入速率进行简单的限制。</p>
<h4>Iptables 示例</h4>
<p>以下脚本将会阻止 60 秒内尝试登录 5 次以上的客户端的连入。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">inet_if</span><span class="o">=</span>eth1
<span class="nv">ssh_port</span><span class="o">=</span><span class="m">22</span>
<span class="nv">$IPT</span><span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="si">${</span><span class="nv">ssh_port</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="si">${</span><span class="nv">inet_if</span><span class="si">}</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW<span class="w"> </span>-m<span class="w"> </span>recent<span class="w"> </span>--set
<span class="nv">$IPT</span><span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="si">${</span><span class="nv">ssh_port</span><span class="si">}</span><span class="w"> </span>-i<span class="w"> </span><span class="si">${</span><span class="nv">inet_if</span><span class="si">}</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW<span class="w"> </span>-m<span class="w"> </span>recent<span class="w"> </span>--update<span class="w"> </span>--seconds<span class="w"> </span><span class="m">60</span><span class="w"> </span>--hitcount<span class="w"> </span><span class="m">5</span>
</code></pre></div>

<p>在你的 iptables 脚本中调用以上脚本。其他配置选项：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$IPT</span><span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span><span class="cp">${</span><span class="n">inet_if</span><span class="cp">}</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="cp">${</span><span class="n">ssh_port</span><span class="cp">}</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW<span class="w"> </span>-m<span class="w"> </span>limit<span class="w"> </span>--limit<span class="w"> </span>3/min<span class="w"> </span>--limit-burst<span class="w"> </span>3<span class="w"> </span>-j<span class="w"> </span>ACCEPT
<span class="nv">$IPT</span><span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span><span class="cp">${</span><span class="n">inet_if</span><span class="cp">}</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="cp">${</span><span class="n">ssh_port</span><span class="cp">}</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
<span class="nv">$IPT</span><span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-o<span class="w"> </span><span class="cp">${</span><span class="n">inet_if</span><span class="cp">}</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--sport<span class="w"> </span><span class="cp">${</span><span class="n">ssh_port</span><span class="cp">}</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
#<span class="w"> </span>another<span class="w"> </span>one<span class="w"> </span>line<span class="w"> </span>example
#<span class="w"> </span><span class="nv">$IPT</span><span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-i<span class="w"> </span><span class="cp">${</span><span class="n">inet_if</span><span class="cp">}</span><span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>NEW,ESTABLISHED,RELATED<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span>22<span class="w"> </span>-m<span class="w"> </span>limit<span class="w"> </span>--limit<span class="w"> </span>5/minute<span class="w"> </span>--limit-burst<span class="w"> </span>5-j<span class="w"> </span>ACCEPT
</code></pre></div>

<p>其他细节参见 iptables 用户手册。</p>
<h4>*BSD PF 示例</h4>
<p>以下脚本将限制每个客户端的连入数量为 20，并且 5 秒内的连接不超过 15 个。如果客户端触发此规则，则将其加入 abusive_ips 表并限制该客户端连入。最后 flush 关键词杀死所有触发规则的客户端的连接。</p>
<div class="highlight"><pre><span></span><code><span class="n">sshd_server_ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;202.54.1.5&quot;</span><span class="w"> </span>
<span class="n">table</span><span class="w"> </span><span class="o">&lt;</span><span class="n">abusive_ips</span><span class="o">&gt;</span><span class="w"> </span><span class="n">persist</span>
<span class="n">block</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">quick</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">&lt;</span><span class="n">abusive_ips</span><span class="o">&gt;</span>
<span class="k">pass</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">$</span><span class="n">ext_if</span><span class="w"> </span><span class="n">proto</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">$</span><span class="n">sshd_server_ip</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="n">S</span><span class="o">/</span><span class="n">SA</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="p">(</span><span class="nb">max</span><span class="o">-</span><span class="n">src</span><span class="o">-</span><span class="n">conn</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="o">-</span><span class="n">src</span><span class="o">-</span><span class="n">conn</span><span class="o">-</span><span class="n">rate</span><span class="w"> </span><span class="mi">15</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">overload</span><span class="w"> </span><span class="o">&lt;</span><span class="n">abusive_ips</span><span class="o">&gt;</span><span class="w"> </span><span class="n">flush</span><span class="p">)</span><span class="w"> </span>
</code></pre></div>

<h3>12、 使用端口敲门（可选的）</h3>
<p><a href="https://en.wikipedia.org/wiki/Port_knocking">端口敲门</a>是通过在一组预先指定的封闭端口上生成连接尝试，以便从外部打开防火墙上的端口的方法。一旦指定的端口连接顺序被触发，防火墙规则就被动态修改以允许发送连接的主机连入指定的端口。以下是一个使用 iptables 实现的端口敲门的示例：</p>
<div class="highlight"><pre><span></span><code>$IPT -N stage1
$IPT -A stage1 -m recent --remove --name knock
$IPT -A stage1 -p tcp --dport 3456 -m recent --set --name knock2

$IPT -N stage2
$IPT -A stage2 -m recent --remove --name knock2
$IPT -A stage2 -p tcp --dport 2345 -m recent --set --name heaven

$IPT -N door
$IPT -A door -m recent --rcheck --seconds 5 --name knock2 -j stage2
$IPT -A door -m recent --rcheck --seconds 5 --name knock -j stage1
$IPT -A door -p tcp --dport 1234 -m recent --set --name knock

$IPT -A INPUT -m --state ESTABLISHED,RELATED -j ACCEPT
$IPT -A INPUT -p tcp --dport 22 -m recent --rcheck --seconds 5 --name heaven -j ACCEPT
$IPT -A INPUT -p tcp --syn -j door
</code></pre></div>

<p>更多信息请参见：</p>
<p><a href="https://www.cyberciti.biz/faq/debian-ubuntu-linux-iptables-knockd-port-knocking-tutorial/">Debian / Ubuntu: 使用 Knockd and Iptables 设置端口敲门</a></p>
<h3>13、 配置空闲超时注销时长</h3>
<p>用户可以通过 ssh 连入服务器，可以配置一个超时时间间隔来避免无人值守的 ssh 会话。 打开 <code>sshd_config</code> 并确保配置以下值：</p>
<div class="highlight"><pre><span></span><code>ClientAliveInterval 300
ClientAliveCountMax 0
</code></pre></div>

<p>以秒为单位设置一个空闲超时时间（300秒 = 5分钟）。一旦空闲时间超过这个值，空闲用户就会被踢出会话。更多细节参见<a href="https://www.cyberciti.biz/faq/linux-unix-login-bash-shell-force-time-outs/">如何自动注销空闲超时的 BASH / TCSH / SSH 用户</a>。</p>
<h3>14、 为 ssh 用户启用警示标语</h3>
<p>更新 <code>sshd_config</code> 文件如下行来设置用户的警示标语：</p>
<div class="highlight"><pre><span></span><code>Banner /etc/issue
</code></pre></div>

<p>`/etc/issue 示例文件：</p>
<div class="highlight"><pre><span></span><code><span class="o">----------------------------------------------------------------------------------------------</span>
<span class="n">You</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">accessing</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">XYZ</span><span class="w"> </span><span class="n">Government</span><span class="w"> </span><span class="p">(</span><span class="n">XYZG</span><span class="p">)</span><span class="w"> </span><span class="n">Information</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="p">(</span><span class="n">IS</span><span class="p">)</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">provided</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">authorized</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">only</span><span class="o">.</span>
<span class="n">By</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="p">(</span><span class="n">which</span><span class="w"> </span><span class="n">includes</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="n">attached</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">IS</span><span class="p">),</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">consent</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">conditions</span><span class="p">:</span>

<span class="o">+</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">XYZG</span><span class="w"> </span><span class="n">routinely</span><span class="w"> </span><span class="n">intercepts</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">monitors</span><span class="w"> </span><span class="n">communications</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">purposes</span><span class="w"> </span><span class="n">including</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">limited</span><span class="w"> </span><span class="n">to</span><span class="p">,</span>
<span class="n">penetration</span><span class="w"> </span><span class="n">testing</span><span class="p">,</span><span class="w"> </span><span class="n">COMSEC</span><span class="w"> </span><span class="n">monitoring</span><span class="p">,</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">defense</span><span class="p">,</span><span class="w"> </span><span class="n">personnel</span><span class="w"> </span><span class="n">misconduct</span><span class="w"> </span><span class="p">(</span><span class="n">PM</span><span class="p">),</span>
<span class="n">law</span><span class="w"> </span><span class="n">enforcement</span><span class="w"> </span><span class="p">(</span><span class="n">LE</span><span class="p">),</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">counterintelligence</span><span class="w"> </span><span class="p">(</span><span class="n">CI</span><span class="p">)</span><span class="w"> </span><span class="n">investigations</span><span class="o">.</span>

<span class="o">+</span><span class="w"> </span><span class="n">At</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">XYZG</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">inspect</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">seize</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">IS</span><span class="o">.</span>

<span class="o">+</span><span class="w"> </span><span class="n">Communications</span><span class="w"> </span><span class="n">using</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">on</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">private</span><span class="p">,</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">routine</span><span class="w"> </span><span class="n">monitoring</span><span class="p">,</span>
<span class="n">interception</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">search</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">disclosed</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">XYZG</span><span class="w"> </span><span class="n">authorized</span><span class="w"> </span><span class="n">purpose</span><span class="o">.</span>

<span class="o">+</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="n">includes</span><span class="w"> </span><span class="n">security</span><span class="w"> </span><span class="n">measures</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">controls</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">protect</span><span class="w"> </span><span class="n">XYZG</span><span class="w"> </span><span class="n">interests</span><span class="o">--</span><span class="ow">not</span>
<span class="k">for</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">personal</span><span class="w"> </span><span class="n">benefit</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">privacy</span><span class="o">.</span>

<span class="o">+</span><span class="w"> </span><span class="n">Notwithstanding</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">above</span><span class="p">,</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">IS</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">constitute</span><span class="w"> </span><span class="n">consent</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">PM</span><span class="p">,</span><span class="w"> </span><span class="n">LE</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">CI</span><span class="w"> </span><span class="n">investigative</span><span class="w"> </span><span class="n">searching</span>
<span class="ow">or</span><span class="w"> </span><span class="n">monitoring</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">privileged</span><span class="w"> </span><span class="n">communications</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="n">related</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">personal</span><span class="w"> </span><span class="n">representation</span>
<span class="ow">or</span><span class="w"> </span><span class="n">services</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">attorneys</span><span class="p">,</span><span class="w"> </span><span class="n">psychotherapists</span><span class="p">,</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">clergy</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">their</span><span class="w"> </span><span class="n">assistants</span><span class="o">.</span><span class="w"> </span><span class="n">Such</span><span class="w"> </span><span class="n">communications</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">work</span>
<span class="n">product</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">confidential</span><span class="o">.</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Agreement</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">details</span><span class="o">.</span>
<span class="o">----------------------------------------------------------------------------------------------</span>
</code></pre></div>

<p>以上是一个标准的示例，更多的用户协议和法律细节请咨询你的律师团队。</p>
<h3>15、 禁用 .rhosts 文件（需核实）</h3>
<p>禁止读取用户的 <code>~/.rhosts</code> 和 <code>~/.shosts</code> 文件。更新 <code>sshd_config</code> 文件中的以下内容：</p>
<div class="highlight"><pre><span></span><code>IgnoreRhosts yes
</code></pre></div>

<p>SSH 可以模拟过时的 rsh 命令，所以应该禁用不安全的 RSH 连接。</p>
<h3>16、 禁用基于主机的授权（需核实）</h3>
<p>禁用基于主机的授权，更新 <code>sshd_config</code> 文件的以下选项：</p>
<div class="highlight"><pre><span></span><code>HostbasedAuthentication no
</code></pre></div>

<h3>17、 为 OpenSSH 和操作系统打补丁</h3>
<p>推荐你使用类似 <a href="https://www.cyberciti.biz/faq/rhel-centos-fedora-linux-yum-command-howto/">yum</a>、<a href="https://www.cyberciti.biz/tips/linux-debian-package-management-cheat-sheet.html">apt-get</a> 和 <a href="https://www.cyberciti.biz/tips/howto-keep-freebsd-system-upto-date.html">freebsd-update</a> 等工具保持系统安装了最新的安全补丁。</p>
<h3>18、 Chroot OpenSSH （将用户锁定在主目录）</h3>
<p>默认设置下用户可以浏览诸如 <code>/etc</code>、<code>/bin</code> 等目录。可以使用 chroot 或者其他专有工具如 <a href="https://www.cyberciti.biz/tips/rhel-centos-linux-install-configure-rssh-shell.html">rssh</a> 来保护 ssh 连接。从版本 4.8p1 或 4.9p1 起，OpenSSH 不再需要依赖诸如 rssh 或复杂的 chroot(1) 等第三方工具来将用户锁定在主目录中。可以使用新的 <code>ChrootDirectory</code> 指令将用户锁定在其主目录，参见<a href="https://www.debian-administration.org/articles/590">这篇博文</a>。</p>
<h3>19. 禁用客户端的 OpenSSH 服务</h3>
<p>工作站和笔记本不需要 OpenSSH 服务。如果不需要提供 ssh 远程登录和文件传输功能的话，可以禁用 sshd 服务。CentOS / RHEL 用户可以使用 <a href="https://www.cyberciti.biz/faq/rhel-centos-fedora-linux-yum-command-howto/" title="See Linux/Unix yum command examples for more info">yum 命令</a> 禁用或删除 openssh-server：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>yum<span class="w"> </span>erase<span class="w"> </span>openssh-server
</code></pre></div>

<p>Debian / Ubuntu 用户可以使用 <a href="https://www.cyberciti.biz/faq/ubuntu-lts-debian-linux-apt-command-examples/" title="See Linux/Unix apt command examples for more info">apt 命令</a>/<a href="https://www.cyberciti.biz/tips/linux-debian-package-management-cheat-sheet.html" title="See Linux/Unix apt-get command examples for more info">apt-get 命令</a> 删除 openssh-server：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>remove<span class="w"> </span>openssh-server
</code></pre></div>

<p>有可能需要更新 iptables 脚本来移除 ssh 的例外规则。CentOS / RHEL / Fedora 系统可以编辑文件 <code>/etc/sysconfig/iptables</code> 和 <code>/etc/sysconfig/ip6tables</code>。最后<a href="https://www.cyberciti.biz/faq/howto-rhel-linux-open-port-using-iptables/">重启 iptables</a> 服务：</p>
<div class="highlight"><pre><span></span><code># service iptables restart
# service ip6tables restart
</code></pre></div>

<h3>20. 来自 Mozilla 的额外提示</h3>
<p>如果使用 6.7+ 版本的 OpenSSH，可以尝试下<a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH">以下设置</a>：</p>
<div class="highlight"><pre><span></span><code><span class="err">#################</span><span class="o">[</span><span class="n"> WARNING </span><span class="o">]</span><span class="err">########################</span>
<span class="err">#</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="n">blindly</span><span class="p">.</span><span class="w"> </span><span class="k">Read</span><span class="w"> </span><span class="n">sshd_config</span><span class="w"> </span><span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">man</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">understand</span><span class="w"> </span><span class="n">cryptography</span><span class="w"> </span><span class="k">to</span><span class="w">    </span><span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">tweak</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="w"> </span><span class="n">Otherwise</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">defaults</span><span class="w"> </span><span class="err">#</span>
<span class="err">####################################################</span>

<span class="err">#</span><span class="w"> </span><span class="n">Supported</span><span class="w"> </span><span class="n">HostKey</span><span class="w"> </span><span class="n">algorithms</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">preference</span><span class="p">.</span>
<span class="n">HostKey</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">ssh_host_ed25519_key</span>
<span class="n">HostKey</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">ssh_host_rsa_key</span>
<span class="n">HostKey</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">ssh_host_ecdsa_key</span>

<span class="err">#</span><span class="w"> </span><span class="n">Specifies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">KEX</span><span class="w"> </span><span class="p">(</span><span class="k">Key</span><span class="w"> </span><span class="n">Exchange</span><span class="p">)</span><span class="w"> </span><span class="n">algorithms</span><span class="p">.</span>
<span class="n">KexAlgorithms</span><span class="w"> </span><span class="n">curve25519</span><span class="o">-</span><span class="n">sha256</span><span class="nv">@libssh</span><span class="p">.</span><span class="n">org</span><span class="p">,</span><span class="n">ecdh</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="n">nistp521</span><span class="p">,</span><span class="n">ecdh</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="n">nistp384</span><span class="p">,</span><span class="n">ecdh</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="n">nistp256</span><span class="p">,</span><span class="n">diffie</span><span class="o">-</span><span class="n">hellman</span><span class="o">-</span><span class="k">group</span><span class="o">-</span><span class="n">exchange</span><span class="o">-</span><span class="n">sha256</span>

<span class="err">#</span><span class="w"> </span><span class="n">Specifies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ciphers</span><span class="w"> </span><span class="n">allowed</span>
<span class="n">Ciphers</span><span class="w"> </span><span class="n">chacha20</span><span class="o">-</span><span class="n">poly1305</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">aes256</span><span class="o">-</span><span class="n">gcm</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">aes128</span><span class="o">-</span><span class="n">gcm</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">aes256</span><span class="o">-</span><span class="n">ctr</span><span class="p">,</span><span class="n">aes192</span><span class="o">-</span><span class="n">ctr</span><span class="p">,</span><span class="n">aes128</span><span class="o">-</span><span class="n">ctr</span>

<span class="n">#Specifies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">MAC</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="n">algorithms</span>
<span class="n">MACs</span><span class="w"> </span><span class="n">hmac</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="mi">512</span><span class="o">-</span><span class="n">etm</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="mi">256</span><span class="o">-</span><span class="n">etm</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">umac</span><span class="o">-</span><span class="mi">128</span><span class="o">-</span><span class="n">etm</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span><span class="p">,</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span><span class="n">hmac</span><span class="o">-</span><span class="n">sha2</span><span class="o">-</span><span class="mi">256</span><span class="p">,</span><span class="n">umac</span><span class="o">-</span><span class="mi">128</span><span class="nv">@openssh</span><span class="p">.</span><span class="n">com</span>

<span class="err">#</span><span class="w"> </span><span class="n">LogLevel</span><span class="w"> </span><span class="n">VERBOSE</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="k">user</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">fingerprint</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">login</span><span class="p">.</span><span class="w"> </span><span class="n">Needed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="n">audit</span><span class="w"> </span><span class="n">track</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nf">log</span><span class="w"> </span><span class="ow">in</span><span class="p">.</span>
<span class="n">LogLevel</span><span class="w"> </span><span class="n">VERBOSE</span>

<span class="err">#</span><span class="w"> </span><span class="nf">Log</span><span class="w"> </span><span class="n">sftp</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="p">(</span><span class="k">read</span><span class="o">/</span><span class="k">write</span><span class="o">/</span><span class="n">etc</span><span class="p">.)</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">easily</span><span class="w"> </span><span class="n">logged</span><span class="w"> </span><span class="n">otherwise</span><span class="p">.</span>
<span class="n">Subsystem</span><span class="w"> </span><span class="n">sftp</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sftp</span><span class="o">-</span><span class="n">server</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">AUTHPRIV</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="n">INFO</span>
</code></pre></div>

<p>使用以下命令获取 OpenSSH 支持的加密方法：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh<span class="w"> </span>-Q<span class="w"> </span>cipher
$<span class="w"> </span>ssh<span class="w"> </span>-Q<span class="w"> </span>cipher-auth
$<span class="w"> </span>ssh<span class="w"> </span>-Q<span class="w"> </span>mac
$<span class="w"> </span>ssh<span class="w"> </span>-Q<span class="w"> </span>kex
$<span class="w"> </span>ssh<span class="w"> </span>-Q<span class="w"> </span>key
</code></pre></div>

<p><a href="https://www.cyberciti.biz/tips/wp-content/uploads/2009/07/OpenSSH-Security-Tutorial-Query-Ciphers-and-algorithms-choice.jpg"><img alt="OpenSSH安全教程查询密码和算法选择" src="/data/attachment/album/201802/28/154556yizvchkjzgh3pim3.jpg"></a></p>
<h3>如何测试 sshd_config 文件并重启/重新加载 SSH 服务？</h3>
<p>在重启 sshd 前检查配置文件的有效性和密匙的完整性，运行：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>sshd<span class="w"> </span>-t
</code></pre></div>

<p>扩展测试模式：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>sshd<span class="w"> </span>-T
</code></pre></div>

<p>最后，根据系统的的版本<a href="https://www.cyberciti.biz/faq/howto-restart-ssh/">重启 Linux 或类 Unix 系统中的 sshd 服务</a>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="o">[</span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>ssh<span class="o">][</span><span class="m">38</span><span class="o">]</span><span class="w"> </span><span class="c1">## Debian/Ubunt Linux##</span>
$<span class="w"> </span><span class="o">[</span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>sshd.service<span class="o">][</span><span class="m">39</span><span class="o">]</span><span class="w"> </span><span class="c1">## CentOS/RHEL/Fedora Linux##</span>
$<span class="w"> </span>doas<span class="w"> </span>/etc/rc.d/sshd<span class="w"> </span>restart<span class="w"> </span><span class="c1">## OpenBSD##</span>
$<span class="w"> </span>sudo<span class="w"> </span>service<span class="w"> </span>sshd<span class="w"> </span>restart<span class="w"> </span><span class="c1">## FreeBSD## </span>
</code></pre></div>

<h3>其他建议</h3>
<ol>
<li><a href="https://www.cyberciti.biz/open-source/howto-protect-linux-ssh-login-with-google-authenticator/">使用 2FA 加强 SSH 的安全性</a> - 可以使用 <a href="http://www.nongnu.org/oath-toolkit/">OATH Toolkit</a> 或 <a href="https://duo.com">DuoSecurity</a> 启用多重身份验证。</li>
<li><a href="https://www.cyberciti.biz/faq/ssh-passwordless-login-with-keychain-for-scripts/">基于密匙链的身份验证</a> - 密匙链是一个 bash 脚本，可以使得基于密匙的验证非常的灵活方便。相对于无密码密匙，它提供更好的安全性。</li>
</ol>
<h3>更多信息</h3>
<ul>
<li><a href="https://www.openssh.com/">OpenSSH 官方</a> 项目。</li>
<li>用户手册: sshd(8)、ssh(1)、ssh-add(1)、ssh-agent(1)。</li>
</ul>
<p>如果知道这里没用提及的方便的软件或者技术，请在下面的评论中分享，以帮助读者保持 OpenSSH 的安全。</p>
<h3>关于作者</h3>
<p>作者是 nixCraft 的创始人，一个经验丰富的系统管理员和 Linux/Unix 脚本培训师。他曾与全球客户合作，领域涉及 IT，教育，国防和空间研究以及非营利部门等多个行业。请在 <a href="https://twitter.com/nixcraft">Twitter</a>、<a href="https://facebook.com/nixcraft">Facebook</a>、<a href="https://plus.google.com/+CybercitiBiz">Google+</a> 上关注他。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>