<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>使用 gorilla/mux 进行 HTTP 请求路由和验证</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Marty Kalin gorilla/mux 包以直观的 API 提供了 HTTP 请求路由、验证和其它服务。 Go 网络库包括 http.ServeMux 结构类型，它支持 HTTP 请求多路复用（路由 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2018/12/shi-yong-gorillamux-jin-xing-http-qing-qiu-lu-you-he-yan-zheng.html" rel="bookmark"
           title="Permalink to 使用 gorilla/mux 进行 HTTP 请求路由和验证">使用 gorilla/mux 进行 HTTP 请求路由和验证</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-12-15T09:10:42+01:00">
                Published: Sat 15 December 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Marty Kalin</p>
<blockquote>
<p>gorilla/mux 包以直观的 API 提供了 HTTP 请求路由、验证和其它服务。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/201812/15/091045efoxfuuutxkos2xo.png"></p>
<p>Go 网络库包括 <code>http.ServeMux</code> 结构类型，它支持 HTTP 请求多路复用（路由）：Web 服务器将托管资源的 HTTP 请求与诸如 <code>/sales4today</code> 之类的 URI 路由到代码处理程序；处理程序在发送 HTTP 响应（通常是 HTML 页面）之前执行适当的逻辑。 这是该体系的草图：</p>
<div class="highlight"><pre><span></span><code><span class="c">             </span><span class="nb">+-----------+</span><span class="c">     </span><span class="nb">+--------+</span><span class="c">     </span><span class="nb">+---------+</span>
<span class="c">HTTP 请求</span><span class="nb">----</span><span class="nv">&gt;</span><span class="c">| web 服务器 |</span><span class="nb">----</span><span class="nv">&gt;</span><span class="c">| 路由   |</span><span class="nb">----</span><span class="nv">&gt;</span><span class="c">| 处理程序  |</span>
<span class="c">             </span><span class="nb">+-----------+</span><span class="c">     </span><span class="nb">+--------+</span><span class="c">     </span><span class="nb">+---------+</span>
</code></pre></div>

<p>调用 <code>ListenAndServe</code> 方法后启动 HTTP 服务器：</p>
<div class="highlight"><pre><span></span><code>http.ListenAndServe(&quot;:8888&quot;, nil) // args: port &amp; router
</code></pre></div>

<p>第二个参数 <code>nil</code> 意味着 <code>DefaultServeMux</code> 用于请求路由。</p>
<p><code>gorilla/mux</code> 库包含 <code>mux.Router</code> 类型，可替代 <code>DefaultServeMux</code> 或自定义请求多路复用器。 在 <code>ListenAndServe</code> 调用中，<code>mux.Router</code> 实例将代替 <code>nil</code> 作为第二个参数。 下面的示例代码很好的说明了为什么 <code>mux.Router</code>如此吸引人：</p>
<h3>1、一个简单的 CRUD web 应用程序</h3>
<p>crud web 应用程序（见下文）支持四种 CRUD（创建/读取/更新/删除）操作，它们分别对应四种 HTTP 请求方法：POST、GET、PUT 和 DELETE。 在这个 CRUD 应用程序中，所管理的资源是套话与反套话的列表，每个都是套话及其反面的的套话，例如这对：</p>
<div class="highlight"><pre><span></span><code>Out of sight, out of mind. Absence makes the heart grow fonder.
</code></pre></div>

<p>可以添加新的套话对，可以编辑或删除现有的套话对。</p>
<p>CRUD web 应用程序：</p>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
   <span class="s2">&quot;gorilla/mux&quot;</span>
   <span class="s2">&quot;net/http&quot;</span>
   <span class="s2">&quot;fmt&quot;</span>
   <span class="s2">&quot;strconv&quot;</span>
<span class="p">)</span>

<span class="n">const</span> <span class="n">GETALL</span> <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;GETALL&quot;</span>
<span class="n">const</span> <span class="n">GETONE</span> <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;GETONE&quot;</span>
<span class="n">const</span> <span class="n">POST</span> <span class="n">string</span>   <span class="o">=</span> <span class="s2">&quot;POST&quot;</span>
<span class="n">const</span> <span class="n">PUT</span> <span class="n">string</span>    <span class="o">=</span> <span class="s2">&quot;PUT&quot;</span>
<span class="n">const</span> <span class="n">DELETE</span> <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;DELETE&quot;</span>

<span class="nb">type</span> <span class="n">clichePair</span> <span class="n">struct</span> <span class="p">{</span>
   <span class="n">Id</span>      <span class="nb">int</span>
   <span class="n">Cliche</span>  <span class="n">string</span>
   <span class="n">Counter</span> <span class="n">string</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Message</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">goroutine</span> <span class="n">that</span> <span class="n">accesses</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">resource</span><span class="o">.</span>
<span class="nb">type</span> <span class="n">crudRequest</span> <span class="n">struct</span> <span class="p">{</span>
   <span class="n">verb</span>     <span class="n">string</span>
   <span class="n">cp</span>       <span class="o">*</span><span class="n">clichePair</span>
   <span class="nb">id</span>       <span class="nb">int</span>
   <span class="n">cliche</span>   <span class="n">string</span>
   <span class="n">counter</span>  <span class="n">string</span>
   <span class="n">confirm</span>  <span class="n">chan</span> <span class="n">string</span>
<span class="p">}</span>

<span class="n">var</span> <span class="n">clichesList</span> <span class="o">=</span> <span class="p">[]</span><span class="o">*</span><span class="n">clichePair</span><span class="p">{}</span>
<span class="n">var</span> <span class="n">masterId</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">var</span> <span class="n">crudRequests</span> <span class="n">chan</span> <span class="o">*</span><span class="n">crudRequest</span>

<span class="o">//</span> <span class="n">GET</span> <span class="o">/</span>
<span class="o">//</span> <span class="n">GET</span> <span class="o">/</span><span class="n">cliches</span>
<span class="n">func</span> <span class="n">ClichesAll</span><span class="p">(</span><span class="n">res</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">crudRequest</span><span class="p">{</span><span class="n">verb</span><span class="p">:</span> <span class="n">GETALL</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">string</span><span class="p">)}</span>
   <span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;read all&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">GET</span> <span class="o">/</span><span class="n">cliches</span><span class="o">/</span><span class="nb">id</span>
<span class="n">func</span> <span class="n">ClichesOne</span><span class="p">(</span><span class="n">res</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
   <span class="nb">id</span> <span class="o">:=</span> <span class="n">getIdFromRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
   <span class="n">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">crudRequest</span><span class="p">{</span><span class="n">verb</span><span class="p">:</span> <span class="n">GETONE</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">string</span><span class="p">)}</span>
   <span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;read one&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">POST</span> <span class="o">/</span><span class="n">cliches</span>
<span class="n">func</span> <span class="n">ClichesCreate</span><span class="p">(</span><span class="n">res</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">cliche</span><span class="p">,</span> <span class="n">counter</span> <span class="o">:=</span> <span class="n">getDataFromRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
   <span class="n">cp</span> <span class="o">:=</span> <span class="n">new</span><span class="p">(</span><span class="n">clichePair</span><span class="p">)</span>
   <span class="n">cp</span><span class="o">.</span><span class="n">Cliche</span> <span class="o">=</span> <span class="n">cliche</span>
   <span class="n">cp</span><span class="o">.</span><span class="n">Counter</span> <span class="o">=</span> <span class="n">counter</span>
   <span class="n">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">crudRequest</span><span class="p">{</span><span class="n">verb</span><span class="p">:</span> <span class="n">POST</span><span class="p">,</span> <span class="n">cp</span><span class="p">:</span> <span class="n">cp</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">string</span><span class="p">)}</span>
   <span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">PUT</span> <span class="o">/</span><span class="n">cliches</span><span class="o">/</span><span class="nb">id</span>
<span class="n">func</span> <span class="n">ClichesEdit</span><span class="p">(</span><span class="n">res</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
   <span class="nb">id</span> <span class="o">:=</span> <span class="n">getIdFromRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
   <span class="n">cliche</span><span class="p">,</span> <span class="n">counter</span> <span class="o">:=</span> <span class="n">getDataFromRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
   <span class="n">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">crudRequest</span><span class="p">{</span><span class="n">verb</span><span class="p">:</span> <span class="n">PUT</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="n">cliche</span><span class="p">:</span> <span class="n">cliche</span><span class="p">,</span> <span class="n">counter</span><span class="p">:</span> <span class="n">counter</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">string</span><span class="p">)}</span>
   <span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;edit&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">DELETE</span> <span class="o">/</span><span class="n">cliches</span><span class="o">/</span><span class="nb">id</span>
<span class="n">func</span> <span class="n">ClichesDelete</span><span class="p">(</span><span class="n">res</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
   <span class="nb">id</span> <span class="o">:=</span> <span class="n">getIdFromRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
   <span class="n">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">crudRequest</span><span class="p">{</span><span class="n">verb</span><span class="p">:</span> <span class="n">DELETE</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="n">confirm</span><span class="p">:</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">string</span><span class="p">)}</span>
   <span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span> <span class="o">*</span><span class="n">crudRequest</span><span class="p">,</span> <span class="n">res</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">logMsg</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">crudRequests</span><span class="o">&lt;-</span><span class="n">cr</span>
   <span class="n">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">cr</span><span class="o">.</span><span class="n">confirm</span>
   <span class="n">res</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
   <span class="n">logIt</span><span class="p">(</span><span class="n">logMsg</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">populateClichesList</span><span class="p">()</span>

   <span class="o">//</span> <span class="n">From</span> <span class="n">now</span> <span class="n">on</span><span class="p">,</span> <span class="n">this</span> <span class="n">gorountine</span> <span class="n">alone</span> <span class="n">accesses</span> <span class="n">the</span> <span class="n">clichesList</span><span class="o">.</span>
   <span class="n">crudRequests</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="o">*</span><span class="n">crudRequest</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
   <span class="n">go</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span> <span class="o">//</span> <span class="n">resource</span> <span class="n">manager</span>
      <span class="k">for</span> <span class="p">{</span>
         <span class="n">select</span> <span class="p">{</span>
         <span class="k">case</span> <span class="n">req</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">crudRequests</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">verb</span> <span class="o">==</span> <span class="n">GETALL</span> <span class="p">{</span>
            <span class="n">req</span><span class="o">.</span><span class="n">confirm</span><span class="o">&lt;-</span><span class="n">readAll</span><span class="p">()</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">verb</span> <span class="o">==</span> <span class="n">GETONE</span> <span class="p">{</span>
            <span class="n">req</span><span class="o">.</span><span class="n">confirm</span><span class="o">&lt;-</span><span class="n">readOne</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">verb</span> <span class="o">==</span> <span class="n">POST</span> <span class="p">{</span>
            <span class="n">req</span><span class="o">.</span><span class="n">confirm</span><span class="o">&lt;-</span><span class="n">addPair</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">cp</span><span class="p">)</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">verb</span> <span class="o">==</span> <span class="n">PUT</span> <span class="p">{</span>
            <span class="n">req</span><span class="o">.</span><span class="n">confirm</span><span class="o">&lt;-</span><span class="n">editPair</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">cliche</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">verb</span> <span class="o">==</span> <span class="n">DELETE</span> <span class="p">{</span>
            <span class="n">req</span><span class="o">.</span><span class="n">confirm</span><span class="o">&lt;-</span><span class="n">deletePair</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}()</span>
   <span class="n">startServer</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">startServer</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">router</span> <span class="o">:=</span> <span class="n">mux</span><span class="o">.</span><span class="n">NewRouter</span><span class="p">()</span>

   <span class="o">//</span> <span class="n">Dispatch</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">CRUD</span> <span class="n">operations</span><span class="o">.</span>
   <span class="n">router</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">ClichesAll</span><span class="p">)</span><span class="o">.</span><span class="n">Methods</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>
   <span class="n">router</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&quot;/cliches&quot;</span><span class="p">,</span> <span class="n">ClichesAll</span><span class="p">)</span><span class="o">.</span><span class="n">Methods</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>
   <span class="n">router</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&quot;/cliches/{id:[0-9]+}&quot;</span><span class="p">,</span> <span class="n">ClichesOne</span><span class="p">)</span><span class="o">.</span><span class="n">Methods</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>

   <span class="n">router</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&quot;/cliches&quot;</span><span class="p">,</span> <span class="n">ClichesCreate</span><span class="p">)</span><span class="o">.</span><span class="n">Methods</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
   <span class="n">router</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&quot;/cliches/{id:[0-9]+}&quot;</span><span class="p">,</span> <span class="n">ClichesEdit</span><span class="p">)</span><span class="o">.</span><span class="n">Methods</span><span class="p">(</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
   <span class="n">router</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s2">&quot;/cliches/{id:[0-9]+}&quot;</span><span class="p">,</span> <span class="n">ClichesDelete</span><span class="p">)</span><span class="o">.</span><span class="n">Methods</span><span class="p">(</span><span class="s2">&quot;DELETE&quot;</span><span class="p">)</span>

   <span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span> <span class="o">//</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">router</span>

   <span class="o">//</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">server</span><span class="o">.</span>
   <span class="n">port</span> <span class="o">:=</span> <span class="s2">&quot;:8888&quot;</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Listening on port &quot;</span> <span class="o">+</span> <span class="n">port</span><span class="p">)</span>
   <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">router</span><span class="p">);</span> <span class="o">//</span> <span class="n">mux</span><span class="o">.</span><span class="n">Router</span> <span class="n">now</span> <span class="ow">in</span> <span class="n">play</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Return</span> <span class="n">entire</span> <span class="nb">list</span> <span class="n">to</span> <span class="n">requester</span><span class="o">.</span>
<span class="n">func</span> <span class="n">readAll</span><span class="p">()</span> <span class="n">string</span> <span class="p">{</span>
   <span class="n">msg</span> <span class="o">:=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cliche</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">clichesList</span> <span class="p">{</span>
      <span class="nb">next</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">cliche</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">cliche</span><span class="o">.</span><span class="n">Cliche</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">cliche</span><span class="o">.</span><span class="n">Counter</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="nb">next</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">msg</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Return</span> <span class="n">specified</span> <span class="n">clichePair</span> <span class="n">to</span> <span class="n">requester</span><span class="o">.</span>
<span class="n">func</span> <span class="n">readOne</span><span class="p">(</span><span class="nb">id</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
   <span class="n">msg</span> <span class="o">:=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;Bad Id: &quot;</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

   <span class="n">index</span> <span class="o">:=</span> <span class="n">findCliche</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="n">cliche</span> <span class="o">:=</span> <span class="n">clichesList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">cliche</span><span class="o">.</span><span class="n">Cliche</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">cliche</span><span class="o">.</span><span class="n">Counter</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">msg</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">clichePair</span> <span class="ow">and</span> <span class="n">add</span> <span class="n">to</span> <span class="nb">list</span>
<span class="n">func</span> <span class="n">addPair</span><span class="p">(</span><span class="n">cp</span> <span class="o">*</span><span class="n">clichePair</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
   <span class="n">cp</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">masterId</span>
   <span class="n">masterId</span><span class="o">++</span>
   <span class="n">clichesList</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">clichesList</span><span class="p">,</span> <span class="n">cp</span><span class="p">)</span>
   <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Created: &quot;</span> <span class="o">+</span> <span class="n">cp</span><span class="o">.</span><span class="n">Cliche</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cp</span><span class="o">.</span><span class="n">Counter</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Edit</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">clichePair</span>
<span class="n">func</span> <span class="n">editPair</span><span class="p">(</span><span class="nb">id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cliche</span> <span class="n">string</span><span class="p">,</span> <span class="n">counter</span> <span class="n">string</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
   <span class="n">msg</span> <span class="o">:=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;Bad Id: &quot;</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="n">index</span> <span class="o">:=</span> <span class="n">findCliche</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="n">clichesList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Cliche</span> <span class="o">=</span> <span class="n">cliche</span>
      <span class="n">clichesList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Counter</span> <span class="o">=</span> <span class="n">counter</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cliche edited: &quot;</span> <span class="o">+</span> <span class="n">cliche</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">counter</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">msg</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Delete</span> <span class="n">a</span> <span class="n">clichePair</span>
<span class="n">func</span> <span class="n">deletePair</span><span class="p">(</span><span class="nb">id</span> <span class="nb">int</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
   <span class="n">idStr</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
   <span class="n">msg</span> <span class="o">:=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;Bad Id: &quot;</span> <span class="o">+</span> <span class="n">idStr</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="n">index</span> <span class="o">:=</span> <span class="n">findCliche</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="n">clichesList</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">clichesList</span><span class="p">[:</span><span class="n">index</span><span class="p">],</span> <span class="n">clichesList</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cliche &quot;</span> <span class="o">+</span> <span class="n">idStr</span> <span class="o">+</span> <span class="s2">&quot; deleted</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">msg</span>
<span class="p">}</span>

<span class="o">//***</span> <span class="n">utility</span> <span class="n">functions</span>
<span class="n">func</span> <span class="n">findCliche</span><span class="p">(</span><span class="nb">id</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
   <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clichesList</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="n">clichesList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">//</span> <span class="ow">not</span> <span class="n">found</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">getIdFromRequest</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
   <span class="nb">vars</span> <span class="o">:=</span> <span class="n">mux</span><span class="o">.</span><span class="n">Vars</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
   <span class="nb">id</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
   <span class="k">return</span> <span class="nb">id</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">getDataFromRequest</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
   <span class="o">//</span> <span class="n">Extract</span> <span class="n">the</span> <span class="n">user</span><span class="o">-</span><span class="n">provided</span> <span class="n">data</span> <span class="k">for</span> <span class="n">the</span> <span class="n">new</span> <span class="n">clichePair</span>
   <span class="n">req</span><span class="o">.</span><span class="n">ParseForm</span><span class="p">()</span>
   <span class="n">form</span> <span class="o">:=</span> <span class="n">req</span><span class="o">.</span><span class="n">Form</span>
   <span class="n">cliche</span> <span class="o">:=</span> <span class="n">form</span><span class="p">[</span><span class="s2">&quot;cliche&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>    <span class="o">//</span> <span class="mi">1</span><span class="n">st</span> <span class="ow">and</span> <span class="n">only</span> <span class="n">member</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">list</span>
   <span class="n">counter</span> <span class="o">:=</span> <span class="n">form</span><span class="p">[</span><span class="s2">&quot;counter&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="o">//</span> <span class="n">ditto</span>
   <span class="k">return</span> <span class="n">cliche</span><span class="p">,</span> <span class="n">counter</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">logIt</span><span class="p">(</span><span class="n">msg</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">populateClichesList</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">var</span> <span class="n">cliches</span> <span class="o">=</span> <span class="p">[]</span><span class="n">string</span> <span class="p">{</span>
      <span class="s2">&quot;Out of sight, out of mind.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;A penny saved is a penny earned.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;He who hesitates is lost.&quot;</span><span class="p">,</span>
   <span class="p">}</span>
   <span class="n">var</span> <span class="n">counterCliches</span> <span class="o">=</span> <span class="p">[]</span><span class="n">string</span> <span class="p">{</span>
      <span class="s2">&quot;Absence makes the heart grow fonder.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Penny-wise and dollar-foolish.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Look before you leap.&quot;</span><span class="p">,</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cliches</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="n">cp</span> <span class="o">:=</span> <span class="n">new</span><span class="p">(</span><span class="n">clichePair</span><span class="p">)</span>
      <span class="n">cp</span><span class="o">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">masterId</span>
      <span class="n">masterId</span><span class="o">++</span>
      <span class="n">cp</span><span class="o">.</span><span class="n">Cliche</span> <span class="o">=</span> <span class="n">cliches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">cp</span><span class="o">.</span><span class="n">Counter</span> <span class="o">=</span> <span class="n">counterCliches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">clichesList</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">clichesList</span><span class="p">,</span> <span class="n">cp</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>为了专注于请求路由和验证，CRUD 应用程序不使用 HTML 页面作为请求响应。 相反，请求会产生明文响应消息：套话对的列表是对 GET 请求的响应，确认新的套话对已添加到列表中是对 POST 请求的响应，依此类推。 这种简化使得使用命令行实用程序（如 <a href="https://curl.haxx.se/">curl</a>）可以轻松地测试应用程序，尤其是 <code>gorilla/mux</code> 组件。</p>
<p><code>gorilla/mux</code> 包可以从 <a href="https://github.com/gorilla/mux">GitHub</a> 安装。 CRUD app 无限期运行；因此，应使用 <code>Control-C</code> 或同等命令终止。 CRUD 应用程序的代码，以及自述文件和简单的 curl 测试，可以在<a href="http://condor.depaul.edu/mkalin">我的网站</a>上找到。</p>
<h3>2、请求路由</h3>
<p><code>mux.Router</code> 扩展了 REST 风格的路由，它赋给 HTTP 方法（例如，GET）和 URL 末尾的 URI 或路径（例如 <code>/cliches</code>）相同的权重。 URI 用作 HTTP 动词（方法）的名词。 例如，在HTTP请求中有一个起始行，例如：</p>
<div class="highlight"><pre><span></span><code>GET /cliches
</code></pre></div>

<p>意味着得到所有的套话对，而一个起始线，如：</p>
<div class="highlight"><pre><span></span><code>POST /cliches
</code></pre></div>

<p>意味着从 HTTP 正文中的数据创建一个套话对。</p>
<p>在 CRUD web 应用程序中，有五个函数充当 HTTP 请求的五种变体的请求处理程序：</p>
<div class="highlight"><pre><span></span><code>ClichesAll(...)    # GET: 获取所有的套话对
ClichesOne(...)    # GET: 获取指定的套话对
ClichesCreate(...) # POST: 创建新的套话对
ClichesEdit(...)   # PUT: 编辑现有的套话对
ClichesDelete(...) # DELETE: 删除指定的套话对
</code></pre></div>

<p>每个函数都有两个参数：一个 <code>http.ResponseWriter</code> 用于向请求者发送一个响应，一个指向 <code>http.Request</code> 的指针，该指针封装了底层 HTTP 请求的信息。 使用 <code>gorilla/mux</code> 包可以轻松地将这些请求处理程序注册到Web服务器，并执行基于正则表达式的验证。</p>
<p>CRUD 应用程序中的 <code>startServer</code> 函数注册请求处理程序。 考虑这对注册，<code>router</code> 作为 <code>mux.Router</code> 实例：</p>
<div class="highlight"><pre><span></span><code>router.HandleFunc(&quot;/&quot;, ClichesAll).Methods(&quot;GET&quot;)
router.HandleFunc(&quot;/cliches&quot;, ClichesAll).Methods(&quot;GET&quot;)
</code></pre></div>

<p>这些语句意味着对单斜线 <code>/</code> 或 <code>/cliches</code> 的 GET 请求应该路由到 <code>ClichesAll</code> 函数，然后处理请求。 例如，curl 请求（使用 <code>％</code> 作为命令行提示符）：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request GET localhost:8888/</span>
</code></pre></div>

<p>会产生如下结果：</p>
<div class="highlight"><pre><span></span><code><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">Out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">sight</span><span class="o">,</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">mind</span><span class="o">.</span><span class="w">  </span><span class="n">Absence</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">heart</span><span class="w"> </span><span class="n">grow</span><span class="w"> </span><span class="n">fonder</span><span class="o">.</span>
<span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">penny</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">penny</span><span class="w"> </span><span class="n">earned</span><span class="o">.</span><span class="w">  </span><span class="n">Penny</span><span class="o">-</span><span class="n">wise</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">dollar</span><span class="o">-</span><span class="n">foolish</span><span class="o">.</span>
<span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">He</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">hesitates</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">lost</span><span class="o">.</span><span class="w">  </span><span class="n">Look</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">leap</span><span class="o">.</span>
</code></pre></div>

<p>这三个套话对是 CRUD 应用程序中的初始数据。</p>
<p>在这句注册语句中：</p>
<div class="highlight"><pre><span></span><code>router.HandleFunc(&quot;/cliches&quot;, ClichesAll).Methods(&quot;GET&quot;)
router.HandleFunc(&quot;/cliches&quot;, ClichesCreate).Methods(&quot;POST&quot;)
</code></pre></div>

<p>URI 是相同的（<code>/cliches</code>），但动词不同：第一种情况下为 GET 请求，第二种情况下为 POST 请求。 此注册举例说明了 REST 样式的路由，因为仅动词的不同就足以将请求分派给两个不同的处理程序。</p>
<p>注册中允许多个 HTTP 方法，尽管这会影响 REST 风格路由的精髓：</p>
<div class="highlight"><pre><span></span><code>router.HandleFunc(&quot;/cliches&quot;, DoItAll).Methods(&quot;POST&quot;, &quot;GET&quot;)
</code></pre></div>

<p>除了动词和 URI 之外，还可以在功能上路由 HTTP 请求。 例如，注册</p>
<div class="highlight"><pre><span></span><code>router.HandleFunc(&quot;/cliches&quot;, ClichesCreate).Schemes(&quot;https&quot;).Methods(&quot;POST&quot;)
</code></pre></div>

<p>要求对 POST 请求进行 HTTPS 访问以创建新的套话对。以类似的方式，注册可能需要具有指定的 HTTP 头元素（例如，认证凭证）的请求。</p>
<h3>3、 Request validation</h3>
<p><code>gorilla/mux</code> 包采用简单，直观的方法通过正则表达式进行请求验证。 考虑此请求处理程序以获取一个操作：</p>
<div class="highlight"><pre><span></span><code>router.HandleFunc(&quot;/cliches/{id:[0-9]+}&quot;, ClichesOne).Methods(&quot;GET&quot;)
</code></pre></div>

<p>此注册排除了 HTTP 请求，例如：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request GET localhost:8888/cliches/foo</span>
</code></pre></div>

<p>因为 foo 不是十进制数字。该请求导致熟悉的 404（未找到）状态码。 在此处理程序注册中包含正则表达式模式可确保仅在请求 URI 以十进制整数值结束时才调用 <code>ClichesOne</code> 函数来处理请求：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request GET localhost:8888/cliches/3  # ok</span>
</code></pre></div>

<p>另一个例子，请求如下：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request PUT --data &quot;...&quot; localhost:8888/cliches</span>
</code></pre></div>

<p>此请求导致状态代码为 405（错误方法），因为 /cliches URI 在 CRUD 应用程序中仅在 GET 和 POST 请求中注册。 像 GET 请求一样，PUT 请求必须在 URI 的末尾包含一个数字 id：</p>
<div class="highlight"><pre><span></span><code>router.HandleFunc(&quot;/cliches/{id:[0-9]+}&quot;, ClichesEdit).Methods(&quot;PUT&quot;)
</code></pre></div>

<h3>4、并发问题</h3>
<p><code>gorilla/mux</code> 路由器作为单独的 Go 协程执行对已注册的请求处理程序的每次调用，这意味着并发性被内置于包中。 例如，如果有十个同时发出的请求，例如</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request POST --data &quot;...&quot; localhost:8888/cliches</span>
</code></pre></div>

<p>然后 <code>mux.Router</code> 启动十个 Go 协程来执行 <code>ClichesCreate</code> 处理程序。</p>
<p>GET all、GET one、POST、PUT 和 DELETE 中的五个请求操作中，最后三个改变了所请求的资源，即包含套话对的共享 <code>clichesList</code>。 因此，CRUD app 需要通过协调对 <code>clichesList</code> 的访问来保证安全的并发性。 在不同但等效的术语中，CRUD app 必须防止 <code>clichesList</code> 上的竞争条件。 在生产环境中，可以使用数据库系统来存储诸如 <code>clichesList</code> 之类的资源，然后可以通过数据库事务来管理安全并发。</p>
<p>CRUD 应用程序采用推荐的Go方法来实现安全并发：</p>
<ul>
<li>只有一个 Go 协程，资源管理器在 CRUD app <code>startServer</code> 函数中启动，一旦 Web 服务器开始侦听请求，就可以访问 <code>clichesList</code>。</li>
<li>诸如 <code>ClichesCreate</code> 和 <code>ClichesAll</code> 之类的请求处理程序向 Go 通道发送（指向）<code>crudRequest</code> 实例（默认情况下是线程安全的），并且资源管理器单独从该通道读取。 然后，资源管理器对 <code>clichesList</code> 执行请求的操作。</li>
</ul>
<p>安全并发体系结构绘制如下：</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="n">crudRequest</span><span class="w">                </span><span class="err">读</span><span class="o">/</span><span class="err">写</span>

<span class="err">请求处理程序</span><span class="w"> </span><span class="o">-------------&gt;</span><span class="w"> </span><span class="err">资源托管者</span><span class="w"> </span><span class="o">------------&gt;</span><span class="w"> </span><span class="err">套话列表</span>
</code></pre></div>

<p>在这种架构中，不需要显式锁定 <code>clichesList</code>，因为一旦 CRUD 请求开始进入，只有一个 Go 协程（资源管理器）访问 <code>clichesList</code>。</p>
<p>为了使 CRUD 应用程序尽可能保持并发，在一方请求处理程序与另一方的单一资源管理器之间进行有效的分工至关重要。 在这里，为了审查，是 <code>ClichesCreate</code> 请求处理程序：</p>
<div class="highlight"><pre><span></span><code><span class="k">func</span><span class="w"> </span><span class="n">ClichesCreate</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">cliche</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">getDataFromRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="w">   </span><span class="n">cp</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="p">(</span><span class="n">clichePair</span><span class="p">)</span>
<span class="w">   </span><span class="n">cp</span><span class="o">.</span><span class="n">Cliche</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cliche</span>
<span class="w">   </span><span class="n">cp</span><span class="o">.</span><span class="n">Counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span>
<span class="w">   </span><span class="n">cr</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">crudRequest</span><span class="p">{</span><span class="n">verb</span><span class="p">:</span><span class="w"> </span><span class="n">POST</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">:</span><span class="w"> </span><span class="n">cp</span><span class="p">,</span><span class="w"> </span><span class="n">confirm</span><span class="p">:</span><span class="w"> </span><span class="n">make</span><span class="p">(</span><span class="n">chan</span><span class="w"> </span><span class="n">string</span><span class="p">)}</span>
<span class="w">   </span><span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;create&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p><code>ClichesCreate</code> 调用实用函数 <code>getDataFromRequest</code>，它从 POST 请求中提取新的套话和反套话。 然后 <code>ClichesCreate</code> 函数创建一个新的 <code>ClichePair</code>，设置两个字段，并创建一个 <code>crudRequest</code> 发送给单个资源管理器。 此请求包括一个确认通道，资源管理器使用该通道将信息返回给请求处理程序。 所有设置工作都可以在不涉及资源管理器的情况下完成，因为尚未访问 <code>clichesList</code>。</p>
<p>请求处理程序调用实用程序函数，该函数从 POST 请求中提取新的套话和反套话。 然后，该函数创建一个新的，设置两个字段，并创建一个 crudRequest 发送到单个资源管理器。 此请求包括一个确认通道，资源管理器使用该通道将信息返回给请求处理程序。 所有设置工作都可以在不涉及资源管理器的情况下完成，因为尚未访问它。</p>
<p><code>completeRequest</code> 实用程序函数在 <code>ClichesCreate</code> 函数和其他请求处理程序的末尾调用：</p>
<div class="highlight"><pre><span></span><code>completeRequest(cr, res, &quot;create&quot;) // shown above
</code></pre></div>

<p>通过将 <code>crudRequest</code> 放入 <code>crudRequests</code> 频道，使资源管理器发挥作用：</p>
<div class="highlight"><pre><span></span><code><span class="k">func</span><span class="w"> </span><span class="n">completeRequest</span><span class="p">(</span><span class="n">cr</span><span class="w"> </span><span class="o">*</span><span class="n">crudRequest</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="n">logMsg</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">crudRequests</span><span class="o">&lt;-</span><span class="n">cr</span><span class="w">          </span><span class="o">//</span><span class="w"> </span><span class="err">向资源托管者发送请求</span>
<span class="w">   </span><span class="n">msg</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">cr</span><span class="o">.</span><span class="n">confirm</span><span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="err">等待确认</span>
<span class="w">   </span><span class="n">res</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">向请求方发送确认</span>
<span class="w">   </span><span class="n">logIt</span><span class="p">(</span><span class="n">logMsg</span><span class="p">)</span><span class="w">             </span><span class="o">//</span><span class="w"> </span><span class="err">打印到标准输出</span>
<span class="p">}</span>
</code></pre></div>

<p>对于 POST 请求，资源管理器调用实用程序函数 <code>addPair</code>，它会更改 <code>clichesList</code> 资源：</p>
<div class="highlight"><pre><span></span><code><span class="k">func</span><span class="w"> </span><span class="n">addPair</span><span class="p">(</span><span class="n">cp</span><span class="w"> </span><span class="o">*</span><span class="n">clichePair</span><span class="p">)</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">cp</span><span class="o">.</span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">masterId</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">分配一个唯一的</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span>
<span class="w">   </span><span class="n">masterId</span><span class="o">++</span><span class="w">        </span><span class="o">//</span><span class="w"> </span><span class="err">更新</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="err">计数器</span>
<span class="w">   </span><span class="n">clichesList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">append</span><span class="p">(</span><span class="n">clichesList</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">更新列表</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Created: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cp</span><span class="o">.</span><span class="n">Cliche</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cp</span><span class="o">.</span><span class="n">Counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>资源管理器为其他 CRUD 操作调用类似的实用程序函数。 值得重复的是，一旦 Web 服务器开始接受请求，资源管理器就是唯一可以读取或写入 <code>clichesList</code> 的 goroutine。</p>
<p>对于任何类型的 Web 应用程序，<code>gorilla/mux</code> 包在简单直观的 API 中提供请求路由、请求验证和相关服务。 CRUD web 应用程序突出了软件包的主要功能。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>