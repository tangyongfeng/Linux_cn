<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>用 Python 测试 API 的 3 种方式</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Miguel Brito 单元测试可能令人生畏，但是这些 Python 模块会使你的生活变得更容易。 在这个教程中，你将学到如何对执行 HTTP 请求代 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2022/08/yong-python-ce-shi-api-de-3-chong-fang-shi.html" rel="bookmark"
           title="Permalink to 用 Python 测试 API 的 3 种方式">用 Python 测试 API 的 3 种方式</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2022-08-18T18:08:00+02:00">
                Published: Thu 18 August 2022
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Miguel Brito</p>
<blockquote>
<p>单元测试可能令人生畏，但是这些 Python 模块会使你的生活变得更容易。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202208/18/180800clp08p82pi838zrs.jpg"></p>
<p>在这个教程中，你将学到如何对执行 HTTP 请求代码的进行单元测试。也就是说，你将看到用 Python 对 API 进行单元测试的艺术。</p>
<p>单元测试是指对单个行为的测试。在测试中，一个众所周知的经验法则就是隔离那些需要外部依赖的代码。</p>
<p>比如，当测试一段执行 HTTP 请求的代码时，建议在测试过程中，把真正的调用替换成一个假的的调用。这种情况下，每次运行测试的时候，就可以对它进行单元测试，而不需要执行一个真正的 HTTP 请求。</p>
<p>问题就是，<em>怎样才能隔离这些代码？</em></p>
<p>这就是我希望在这篇博文中回答的问题！我不仅会向你展示如果去做，而且也会权衡不同方法之间的优点和缺点。</p>
<p>要求：</p>
<ul>
<li><a href="https://miguendes.me/how-i-set-up-my-python-workspace">Python 3.8</a></li>
<li>pytest-mock</li>
<li>requests</li>
<li>flask</li>
<li>responses</li>
<li><a href="http://VCR.py">VCR.py</a></li>
</ul>
<h3>使用一个天气状况 REST API 的演示程序</h3>
<p>为了更好的解决这个问题，假设你正在创建一个天气状况的应用。这个应用使用第三方天气状况 REST API 来检索一个城市的天气信息。其中一个需求是生成一个简单的 HTML 页面，像下面这个图片：</p>
<p><img alt="web page displaying London weather" src="/data/attachment/album/202208/18/181132ceoyfizljzu94qi0.jpg"></p>
<p><em>伦敦的天气，OpenWeatherMap。图片是作者自己制作的。</em></p>
<p>为了获得天气的信息，必须得去某个地方找。幸运的是，通过 <a href="https://miguendes.me/how-i-set-up-my-python-workspace">OpenWeatherMap</a> 的 REST API 服务，可以获得一切需要的信息。</p>
<p><em>好的，很棒，但是我该怎么用呢？</em></p>
<p>通过发送一个 <code>GET</code> 请求到：<code>https://api.openweathermap.org/data/2.5/weather?q={city_name}&amp;appid={api_key}&amp;units=metric</code>，就可以获得你所需要的所有东西。在这个教程中，我会把城市名字设置成一个参数，并确定使用公制单位。</p>
<h3>检索数据</h3>
<p>使用 <code>requests</code> 模块来检索天气数据。你可以创建一个接收城市名字作为参数的函数，然后返回一个 JSON。JSON 包含温度、天气状况的描述、日出和日落时间等数据。</p>
<p>下面的例子演示了这样一个函数：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">find_weather_for</span><span class="p">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="o">:</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;Queries the weather API and returns the weather data for a particular city.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">API</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">city_name</span><span class="o">=</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
<span class="w">    </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>这个 URL 是由两个全局变量构成：</p>
<div class="highlight"><pre><span></span><code><span class="nt">BASE_URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span>
<span class="nt">API</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">BASE_URL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;?q={city_name}&amp;amp;appid={api_key}&amp;amp;units=metric&quot;</span>
</code></pre></div>

<p>API 以这个格式返回了一个 JSON：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;coord&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;lon&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="m m-Double">0.13</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;lat&quot;</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">51.51</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;weather&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Clear&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;clear sky&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;icon&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;01d&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s">&quot;base&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;stations&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;temp&quot;</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">16.53</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;feels_like&quot;</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">15.52</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;temp_min&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;temp_max&quot;</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">17.78</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;pressure&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1023</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;humidity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">72</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;visibility&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;wind&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;speed&quot;</span><span class="p">:</span><span class="w"> </span><span class="m m-Double">2.1</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;deg&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;clouds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;all&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;dt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1600420164</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;sys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1414</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;country&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;GB&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;sunrise&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1600407646</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;sunset&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1600452509</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;timezone&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2643743</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;London&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;cod&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span>
</code></pre></div>

<p>当调用 <code>resp.json()</code> 的时候，数据是以 Python 字典的形式返回的。为了封装所有细节，可以用 <code>dataclass</code> 来表示它们。这个类有一个工厂方法，可以获得这个字典并且返回一个 <code>WeatherInfo</code> 实例。</p>
<p>这种办法很好，因为可以保持这种表示方法的稳定。比如，如果 API 改变了 JSON 的结构，就可以在同一个地方（<code>from_dict</code> 方法中）修改逻辑。其他代码不会受影响。你也可以从不同的源获得信息，然后把它们都整合到 <code>from_dict</code> 方法中。</p>
<div class="highlight"><pre><span></span><code><span class="nv">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nl">WeatherInfo</span><span class="p">:</span>
<span class="w">    </span><span class="nl">temp</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span>
<span class="w">    </span><span class="nl">sunset</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span>
<span class="w">    </span><span class="nl">sunrise</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span>
<span class="w">    </span><span class="nl">temp_min</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span>
<span class="w">    </span><span class="nl">temp_max</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span>
<span class="w">    </span><span class="k">desc</span><span class="err">:</span><span class="w"> </span><span class="nf">str</span>

<span class="w">    </span><span class="nv">@classmethod</span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="err">:</span><span class="w"> </span><span class="n">dict</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">&quot;WeatherInfo&quot;</span><span class="err">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cls</span><span class="p">(</span>
<span class="w">            </span><span class="n">temp</span><span class="o">=</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;main&quot;</span><span class="o">][</span><span class="n">&quot;temp&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="n">temp_min</span><span class="o">=</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;main&quot;</span><span class="o">][</span><span class="n">&quot;temp_min&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="n">temp_max</span><span class="o">=</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;main&quot;</span><span class="o">][</span><span class="n">&quot;temp_max&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="k">desc</span><span class="o">=</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;weather&quot;</span><span class="o">][</span><span class="n">0</span><span class="o">][</span><span class="n">&quot;main&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">            </span><span class="n">sunset</span><span class="o">=</span><span class="n">format_date</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;sys&quot;</span><span class="o">][</span><span class="n">&quot;sunset&quot;</span><span class="o">]</span><span class="p">),</span>
<span class="w">            </span><span class="n">sunrise</span><span class="o">=</span><span class="n">format_date</span><span class="p">(</span><span class="k">data</span><span class="o">[</span><span class="n">&quot;sys&quot;</span><span class="o">][</span><span class="n">&quot;sunrise&quot;</span><span class="o">]</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
</code></pre></div>

<p>现在来创建一个叫做 <code>retrieve_weather</code> 的函数。使用这个函数调用 API，然后返回一个 <code>WeatherInfo</code>，这样就可创建你自己的 HTML 页面。</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">retrieve_weather</span><span class="p">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="o">:</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;Finds the weather for a city and returns a WeatherInfo instance.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="kt">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_weather_for</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p>很好，我们的 app 现在有一些基础了。在继续之前，对这些函数进行单元测试。</p>
<h3>1、使用 mock 测试 API</h3>
<p><a href="https://en.wikipedia.org/wiki/Mock_object">根据维基百科</a>，<ruby> 模拟对象 <rt>  mock object </rt></ruby>是通过模仿真实对象来模拟它行为的一个对象。在 Python 中，你可以使用 <code>unittest.mock</code> 库来<ruby> 模拟 <rt>  mock </rt></ruby>任何对象，这个库是标准库中的一部分。为了测试 <code>retrieve_weather</code> 函数，可以模拟 <code>requests.get</code>，然后返回静态数据。</p>
<h4>pytest-mock</h4>
<p>在这个教程中，会使用 <code>pytest</code> 作为测试框架。通过插件，<code>pytest</code> 库是非常具有扩展性的。为了完成我们的模拟目标，要用 <code>pytest-mock</code>。这个插件抽象化了大量 <code>unittest.mock</code> 中的设置，也会让你的代码更简洁。如果你感兴趣的话，我在 <a href="https://miguendes.me/7-pytest-plugins-you-must-definitely-use">另一篇博文中</a> 会有更多的讨论。</p>
<p><em>好的，言归正传，现在看代码。</em></p>
<p>下面是一个 <code>retrieve_weather</code> 函数的完整测试用例。这个测试使用了两个 <code>fixture</code>：一个是由 <code>pytest-mock</code> 插件提供的 <code>mocker</code> fixture, 还有一个是我们自己的。就是从之前请求中保存的静态数据。</p>
<div class="highlight"><pre><span></span><code><span class="err">@</span><span class="n">pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="n">def</span><span class="w"> </span><span class="n">fake_weather_info</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture that returns a static weather data.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;tests/resources/weather.json&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>def test_retrieve_weather_using_mocks(mocker, fake_weather_info):
    &quot;&quot;&quot;Given a city name, test that a HTML report about the weather is generated
    correctly.&quot;&quot;&quot;
    # Creates a fake requests response object
    fake_resp = mocker.Mock()
    # Mock the json method to return the static weather data
    fake_resp.json = mocker.Mock(return_value=fake_weather_info)
    # Mock the status code
    fake_resp.status_code = HTTPStatus.OK

    mocker.patch(&quot;weather_app.requests.get&quot;, return_value=fake_resp)

    weather_info = retrieve_weather(city=&quot;London&quot;)
    assert weather_info == WeatherInfo.from_dict(fake_weather_info)
</code></pre></div>

<p>如果运行这个测试，会获得下面的输出：</p>
<div class="highlight"><pre><span></span><code><span class="o">=============================</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="o">==============================</span>
<span class="p">...</span><span class="o">[</span><span class="n">omitted</span><span class="o">]</span><span class="p">...</span>
<span class="n">tests</span><span class="o">/</span><span class="n">test_weather_app</span><span class="p">.</span><span class="nl">py</span><span class="p">:</span><span class="err">:</span><span class="n">test_retrieve_weather_using_mocks</span><span class="w"> </span><span class="n">PASSED</span><span class="w">      </span><span class="o">[</span><span class="n">100%</span><span class="o">]</span>
<span class="o">==============================</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">0.20</span><span class="n">s</span><span class="w"> </span><span class="o">===============================</span>
<span class="n">Process</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">exit</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>很好，测试通过了！但是...生活并非一帆风顺。这个测试有优点，也有缺点。现在来看一下。</p>
<h4>优点</h4>
<p>好的，有一个之前讨论过的优点就是，通过模拟 API 的返回值，测试变得简单了。将通信和 API 隔离，这样测试就可以预测了。这样总会返回你需要的东西。</p>
<h4>缺点</h4>
<p>对于缺点，问题就是，如果不再想用 <code>requests</code> 了，并且决定回到标准库的 <code>urllib</code>，怎么办。每次改变 <code>find_weather_for</code> 的代码，都得去适配测试。好的测试是，当你修改代码实现的时候，测试时不需要改变的。所以，通过模拟，你最终把测试和实现耦合在了一起。</p>
<p>而且，另一个不好的方面是你需要在调用函数之前进行大量设置——至少是三行代码。</p>
<div class="highlight"><pre><span></span><code>...
    # Creates a fake requests response object
    fake_resp = mocker.Mock()
    # Mock the json method to return the static weather data
    fake_resp.json = mocker.Mock(return_value=fake_weather_info)
    # Mock the status code
    fake_resp.status_code = HTTPStatus.OK
...
</code></pre></div>

<p><em>我可以做的更好吗？</em></p>
<p>是的，请继续看。我现在看看怎么改进一点。</p>
<h3>使用 responses</h3>
<p>用 <code>mocker</code> 功能模拟 <code>requests</code> 有点问题，就是有很多设置。避免这个问题的一个好办法就是使用一个库，可以拦截 <code>requests</code> 调用并且给它们 <ruby> 打补丁 <rt>  patch </rt></ruby>。有不止一个库可以做这件事，但是对我来说最简单的是 <code>responses</code>。我们来看一下怎么用，并且替换 <code>mock</code>。</p>
<div class="highlight"><pre><span></span><code><span class="nv">@responses</span><span class="p">.</span><span class="n">activate</span>
<span class="n">def</span><span class="w"> </span><span class="n">test_retrieve_weather_using_responses</span><span class="p">(</span><span class="n">fake_weather_info</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Given a city name, test that a HTML report about the weather is generated</span>
<span class="ss">    correctly.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">api_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">API</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">city_name</span><span class="o">=</span><span class="ss">&quot;London&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
<span class="w">    </span><span class="n">responses</span><span class="p">.</span><span class="k">add</span><span class="p">(</span><span class="n">responses</span><span class="p">.</span><span class="k">GET</span><span class="p">,</span><span class="w"> </span><span class="n">api_uri</span><span class="p">,</span><span class="w"> </span><span class="n">json</span><span class="o">=</span><span class="n">fake_weather_info</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="p">.</span><span class="n">OK</span><span class="p">)</span>

<span class="w">    </span><span class="n">weather_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retrieve_weather</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="ss">&quot;London&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">weather_info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fake_weather_info</span><span class="p">)</span>
</code></pre></div>

<p>这个函数再次使用了我们的 <code>fake_weather_info</code> fixture。</p>
<p>然后运行测试：</p>
<div class="highlight"><pre><span></span><code>============================= test session starts ==============================
...
tests/test_weather_app.py::test_retrieve_weather_using_responses PASSED  [100%]
============================== 1 passed in 0.19s ===============================
</code></pre></div>

<p>非常好！测试也通过了。但是...并不是那么棒。</p>
<h4>优点</h4>
<p>使用诸如 <code>responses</code> 这样的库，好的方面就是不需要再给 <code>requests</code> <ruby> 打补丁 <rt>  patch </rt></ruby>。通过将这层抽象交给库，可以减少一些设置。然而，如果你没注意到的话，还是有一些问题。</p>
<h4>缺点</h4>
<p>和 <code>unittest.mock</code> 很像，测试和实现再一次耦合了。如果替换 <code>requests</code>，测试就不能用了。</p>
<h3>2、使用适配器测试 API</h3>
<p><em>如果用模拟让测试耦合了，我能做什么？</em></p>
<p>设想下面的场景：假如说你不能再用 <code>requests</code> 了，而且必须要用 <code>urllib</code> 替换，因为这是 Python 自带的。不仅仅是这样，你了解了不要把测试代码和实现耦合，并且你想今后都避免这种情况。你想替换 <code>urllib</code>，也不想重写测试了。</p>
<p>事实证明，你可以抽象出执行 <code>GET</code> 请求的代码。</p>
<p><em>真的吗？怎么做？</em></p>
<p>可以使用<ruby> 适配器 <rt>  adapter </rt></ruby>来抽象它。适配器是一种用来封装其他类的接口，并作为新接口暴露出来的一种设计模式。用这种方式，就可以修改适配器而不需要修改代码了。比如，在 <code>find_weather_for</code> 函数中，封装关于 <code>requests</code> 的所有细节，然后把这部分暴露给只接受 URL 的函数。</p>
<p>所以，这个：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">find_weather_for</span><span class="p">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="o">:</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;Queries the weather API and returns the weather data for a particular city.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">API</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">city_name</span><span class="o">=</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
<span class="w">    </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>变成这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">find_weather_for</span><span class="p">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="o">:</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;Queries the weather API and returns the weather data for a particular city.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">API</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">city_name</span><span class="o">=</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">api_key</span><span class="o">=</span><span class="n">API_KEY</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">adapter</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>

<p>然后适配器变成这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">requests_adapter</span><span class="p">(</span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="o">:</span>
<span class="w">    </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>现在到了重构 <code>retrieve_weather</code> 函数的时候：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">retrieve_weather</span><span class="p">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="o">:</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;Finds the weather for a city and returns a WeatherInfo instance.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="kt">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_weather_for</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">adapter</span><span class="o">=</span><span class="n">requests_adapter</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p>所以，如果你决定改为使用 <code>urllib</code> 的实现，只要换一下适配器：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">urllib_adapter</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An adapter that encapsulates urllib.urlopen&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">with</span><span class="w"> </span><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">response</span><span class="p">:</span>
<span class="w">        </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">retrieve_weather</span><span class="p">(</span><span class="n">city</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="o">:</span>
<span class="w">    </span><span class="s">&quot;&quot;&quot;Finds the weather for a city and returns a WeatherInfo instance.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="kt">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_weather_for</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">adapter</span><span class="o">=</span><span class="n">urllib_adapter</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>

<p><em>好的，那测试怎么做？</em></p>
<p>为了测试 <code>retrieve_weather</code>, 只要创建一个在测试过程中使用的假的适配器：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@responses</span><span class="p">.</span><span class="n">activate</span>
<span class="n">def</span><span class="w"> </span><span class="n">test_retrieve_weather_using_adapter</span><span class="p">(</span>
<span class="w">    </span><span class="n">fake_weather_info</span><span class="p">,</span>
<span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">fake_adapter</span><span class="p">(</span><span class="nl">url</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fake_weather_info</span>

<span class="w">    </span><span class="n">weather_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retrieve_weather</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="ss">&quot;London&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">adapter</span><span class="o">=</span><span class="n">fake_adapter</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">weather_info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fake_weather_info</span><span class="p">)</span>
</code></pre></div>

<p>如果运行测试，会获得：</p>
<div class="highlight"><pre><span></span><code>============================= test session starts ==============================
tests/test_weather_app.py::test_retrieve_weather_using_adapter PASSED    [100%]
============================== 1 passed in 0.22s ===============================
</code></pre></div>

<h4>优点</h4>
<p>这个方法的优点是可以成功将测试和实现解耦。使用<ruby> <a href="https://stackoverflow.com/questions/130794/what-is-dependency-injection">  依赖注入 </a> <rt>  dependency injection </rt></ruby>在测试期间注入一个假的适配器。你也可以在任何时候更换适配器，包括在运行时。这些事情都不会改变任何行为。</p>
<h4>缺点</h4>
<p>缺点就是，因为你在测试中用了假的适配器，如果在实现中往适配器中引入了一个 bug，测试的时候就不会发现。比如说，往 <code>requests</code> 传入了一个有问题的参数，像这样：</p>
<div class="highlight"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">requests_adapter</span><span class="p">(</span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">dict</span><span class="o">:</span>
<span class="w">    </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">headers</span><span class="o">=&lt;</span><span class="n">some</span><span class="w"> </span><span class="n">broken</span><span class="w"> </span><span class="n">headers</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<p>在生产环境中，适配器会有问题，而且单元测试没办法发现。但是事实是，之前的方法也会有同样的问题。这就是为什么不仅要单元测试，并且总是要集成测试。也就是说，要考虑另一个选项。</p>
<h3>3、使用 VCR.py 测试 API</h3>
<p>现在终于到了讨论我们最后一个选项了。诚实地说，我也是最近才发现这个。我用<ruby> 模拟 <rt>  mock </rt></ruby>也很长时间了，而且总是有一些问题。<code>VCR.py</code> 是一个库，它可以简化很多 HTTP 请求的测试。</p>
<p>它的工作原理是将第一次运行测试的 HTTP 交互记录为一个 YAML 文件，叫做 <code>cassette</code>。请求和响应都会被序列化。当第二次运行测试的时候，<code>VCT.py</code> 将拦截对请求的调用，并且返回一个响应。</p>
<p>现在看一下下面如何使用 <code>VCR.py</code> 测试 <code>retrieve_weather</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@vcr</span><span class="p">.</span><span class="n">use_cassette</span><span class="p">()</span>
<span class="n">def</span><span class="w"> </span><span class="n">test_retrieve_weather_using_vcr</span><span class="p">(</span><span class="n">fake_weather_info</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">weather_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retrieve_weather</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="ss">&quot;London&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">weather_info</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WeatherInfo</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fake_weather_info</span><span class="p">)</span>
</code></pre></div>

<p><em>天呐，就这样？没有设置？<code>@vcr.use_cassette()</code> 是什么？</em></p>
<p>是的，就这样！没有设置，只要一个 <code>pytest</code> 标注告诉 VCR 去拦截调用，然后保存 cassette 文件。</p>
<p><em>cassette 文件是什么样？</em></p>
<p>好问题。这个文件里有很多东西。这是因为 VCR 保存了交互中的所有细节。</p>
<div class="highlight"><pre><span></span><code><span class="s s-Atom">interactions</span><span class="p">:</span>
<span class="o">-</span> <span class="s s-Atom">request</span><span class="p">:</span>
    <span class="s s-Atom">body</span><span class="p">:</span> <span class="s s-Atom">null</span>
    <span class="s s-Atom">headers</span><span class="p">:</span>
      <span class="nv">Accept</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">&#39;*/*&#39;</span>
      <span class="nv">Accept</span><span class="o">-</span><span class="nv">Encoding</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">gzip</span><span class="p">,</span> <span class="s s-Atom">deflate</span>
      <span class="nv">Connection</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">keep</span><span class="o">-</span><span class="s s-Atom">alive</span>
      <span class="nv">User</span><span class="o">-</span><span class="nv">Agent</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">python</span><span class="o">-</span><span class="s s-Atom">requests</span><span class="o">/</span><span class="mf">2.24.0</span>
    <span class="s s-Atom">method</span><span class="p">:</span> <span class="nv">GET</span>
    <span class="s s-Atom">uri</span><span class="p">:</span> <span class="s s-Atom">https</span><span class="p">:</span><span class="o">//</span><span class="s s-Atom">api</span><span class="p">.</span><span class="s s-Atom">openweathermap</span><span class="p">.</span><span class="s s-Atom">org</span><span class="o">/</span><span class="s s-Atom">data</span><span class="o">/</span><span class="mf">2.5</span><span class="o">/</span><span class="s s-Atom">weather</span><span class="nb">?</span><span class="s s-Atom">q</span><span class="o">=</span><span class="nv">London</span><span class="s s-Atom">&amp;appid</span><span class="o">=&lt;</span><span class="nv">YOUR</span> <span class="nv">API</span> <span class="nv">KEY</span> <span class="nv">HERE</span><span class="s s-Atom">&gt;&amp;units</span><span class="o">=</span><span class="s s-Atom">metric</span>
  <span class="s s-Atom">response</span><span class="p">:</span>
    <span class="s s-Atom">body</span><span class="p">:</span>
      <span class="s s-Atom">string</span><span class="p">:</span> <span class="s s-Atom">&#39;{&quot;coord&quot;:{&quot;lon&quot;:-0.13,&quot;lat&quot;:51.51},&quot;weather&quot;:[{&quot;id&quot;:800,&quot;main&quot;:&quot;Clear&quot;,&quot;description&quot;:&quot;clearsky&quot;,&quot;icon&quot;:&quot;01d&quot;}],&quot;base&quot;:&quot;stations&quot;,&quot;main&quot;:{&quot;temp&quot;:16.53,&quot;feels_like&quot;:15.52,&quot;temp_min&quot;:15,&quot;temp_max&quot;:17.78,&quot;pressure&quot;:1023,&quot;humidity&quot;:72},&quot;visibility&quot;:10000,&quot;wind&quot;:{&quot;speed&quot;:2.1,&quot;deg&quot;:40},&quot;clouds&quot;:{&quot;all&quot;:0},&quot;dt&quot;:1600420164,&quot;sys&quot;:{&quot;type&quot;:1,&quot;id&quot;:1414,&quot;country&quot;:&quot;GB&quot;,&quot;sunrise&quot;:1600407646,&quot;sunset&quot;:1600452509},&quot;timezone&quot;:3600,&quot;id&quot;:2643743,&quot;name&quot;:&quot;London&quot;,&quot;cod&quot;:200}&#39;</span>
    <span class="s s-Atom">headers</span><span class="p">:</span>
      <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Credentials</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">&#39;true&#39;</span>
      <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Methods</span><span class="o">:</span>
      <span class="o">-</span> <span class="nv">GET</span><span class="p">,</span> <span class="nv">POST</span>
      <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Origin</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">&#39;*&#39;</span>
      <span class="nv">Connection</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">keep</span><span class="o">-</span><span class="s s-Atom">alive</span>
      <span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">&#39;454&#39;</span>
      <span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">application</span><span class="o">/</span><span class="s s-Atom">json</span><span class="p">;</span> <span class="s s-Atom">charset</span><span class="o">=</span><span class="s s-Atom">utf</span><span class="o">-</span><span class="mi">8</span>
      <span class="nv">Date</span><span class="o">:</span>
      <span class="o">-</span> <span class="nv">Fri</span><span class="p">,</span> <span class="mi">18</span> <span class="nv">Sep</span> <span class="mi">2020</span> <span class="mi">10</span><span class="o">:</span><span class="mi">53</span><span class="o">:</span><span class="mi">25</span> <span class="nv">GMT</span>
      <span class="nv">Server</span><span class="o">:</span>
      <span class="o">-</span> <span class="s s-Atom">openresty</span>
      <span class="nv">X</span><span class="o">-</span><span class="nv">Cache</span><span class="o">-</span><span class="nv">Key</span><span class="o">:</span>
      <span class="o">-</span> <span class="o">/</span><span class="s s-Atom">data</span><span class="o">/</span><span class="mf">2.5</span><span class="o">/</span><span class="s s-Atom">weather</span><span class="nb">?</span><span class="s s-Atom">q</span><span class="o">=</span><span class="s s-Atom">london&amp;amp</span><span class="p">;</span><span class="s s-Atom">units</span><span class="o">=</span><span class="s s-Atom">metric</span>
    <span class="s s-Atom">status</span><span class="p">:</span>
      <span class="s s-Atom">code</span><span class="p">:</span> <span class="mi">200</span>
      <span class="s s-Atom">message</span><span class="p">:</span> <span class="nv">OK</span>
<span class="s s-Atom">version</span><span class="p">:</span> <span class="mi">1</span>
</code></pre></div>

<p><em>确实很多！</em></p>
<p>真的！好的方面就是你不需要留意它。<code>VCR.py</code> 会为你安排好一切。</p>
<h4>优点</h4>
<p>现在看一下优点，我可以至少列出五个：</p>
<ul>
<li>没有设置代码。</li>
<li>测试仍然是分离的，所以很快。</li>
<li>测试是确定的。</li>
<li>如果你改了请求，比如说用了错误的 header，测试会失败。</li>
<li>没有与代码实现耦合，所以你可以换适配器，而且测试会通过。唯一有关系的东西就是请求必须是一样的。</li>
</ul>
<h4>缺点</h4>
<p>再与模拟相比较，除了避免了错误，还是有一些问题。</p>
<p>如果 API 提供者出于某种原因修改了数据格式，测试仍然会通过。幸运的是，这种情况并不经常发生，而且在这种重大改变之前，API 提供者通常会给他们的 API 提供不同版本。</p>
<p>另一个需要考虑的事情是<ruby> 就地 <rt>  in place </rt></ruby><ruby> 端到端 <rt>  end-to-end </rt></ruby>测试。每次服务器运行的时候，这些测试都会调用。顾名思义，这是一个范围更广、更慢的测试。它们会比单元测试覆盖更多。事实上，并不是每个项目都需要使用它们。所以，就我看来，<code>VCR.py</code> 对于大多数人的需求来说都绰绰有余。</p>
<h3>总结</h3>
<p>就这么多了。我希望今天你了解了一些有用的东西。测试 API 客户端应用可能会有点吓人。然而，当武装了合适的工具和知识，你就可以驯服这个野兽。</p>
<p>在 <a href="https://github.com/miguendes/tutorials/tree/master/testing_http">我的 Github</a> 上可以找到这个完整的应用。</p>
<p><em>这篇文章最早发表在 <a href="https://miguendes.me/3-ways-to-test-api-client-applications-in-python">作者的个人博客</a>，授权转载</em></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>