<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>在树莓派上创建一个最小化的服务器</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Alan Formy-duval 不要急着丢弃那台旧树莓派，这个详细步骤的指南展示了我怎样用最小化设置来充分利用我珍贵的树莓派系统 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li class="active"><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2022/03/zai-shu-mei-pai-shang-chuang-jian-yi-ge-zui-xiao-hua-de-fu-wu-qi.html" rel="bookmark"
           title="Permalink to 在树莓派上创建一个最小化的服务器">在树莓派上创建一个最小化的服务器</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2022-03-28T16:12:28+02:00">
                Published: Mon 28 March 2022
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/shu-mei-pai">树莓派</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Alan Formy-duval</p>
<blockquote>
<p>不要急着丢弃那台旧树莓派，这个详细步骤的指南展示了我怎样用最小化设置来充分利用我珍贵的树莓派系统资源。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202203/28/161221byrmba9ayvvmbbkx.jpg" title="Raspberry Pi board Model B"></p>
<p>最近，我的 <a href="https://opensource.com/resources/raspberry-pi">树莓派</a> 上的 microSD 储存卡不工作了。它已经作为服务器持续使用将近两年了，这为我提供了一个开始探索和修正问题的好机会。在初始化安装完成以后，它开始出现一些磁盘方面的问题，并且官方的树莓派操作系统发布了一个有重大意义的更新（并从 Raspbian 更名为<ruby> 树莓派操作系统 <rt>  Raspberr Pi OS </rt></ruby>）。所以我买了一个新的储存卡并开始重装。</p>
<p>尽管树莓派 3B 不是最新的硬件，但对于运行多样化服务的最小化的服务器还是足够的。我认为我之前的安装使用了完整的安装镜像，包括了图形用户界面和许多其他的软件包是没有必要的。</p>
<p>这个详细步骤的指南展示了我怎样用最小化设置来充分利用我珍贵的树莓派系统资源。</p>
<h3>开始</h3>
<p>首先，要为树莓派创建一个新的系统驱动器。这需要两样东西：系统镜像文件和一张 microSD 储存卡。</p>
<h4>下载树莓派系统镜像文件</h4>
<p>虽然有好几种操作系统可供选择，但我坚持选择树莓派官方支持的系统。</p>
<p>第一步是从 <a href="https://www.raspberrypi.org/software/operating-systems">树莓派操作系统</a> 官方网站上下载最新的系统镜像文件到计算机，然后后写入储存卡。他们提供了三个不同的镜像，我选择了精简版。它是最小化的操作系统，只包含基本系统必要的文件，所以它占用最少的磁盘空间和系统内存。（当我下载系统的时候，发布日期是 2020 年 8 月 20 日，但是它现在肯定已经更新了。我觉得不会有什么巨大不同，但是我建议读一下发行说明。）</p>
<h4>将树莓派系统镜像写到储存卡</h4>
<p>第二步是写下载的系统镜像到储存卡。我的卡之前用过，当我把它插入我的 Linux 桌面计算机之后，它自动加载了两个存在的分区。在我卸载这两个分区前，我不能写入镜像。</p>
<p>要这样做，我必须得用下面的 <code>lsblk</code> 命令来确定它们的路径，经确定，该设备路径为 <code>/dev/mmcblk0</code>：</p>
<div class="highlight"><pre><span></span><code># lsblk -p
</code></pre></div>

<p>我用 <code>umount</code> 命令卸载了这两个分区：</p>
<div class="highlight"><pre><span></span><code># umount /dev/mmcblk0p2
# umount /dev/mmcblk0p1
</code></pre></div>

<p>一旦分区被卸载，就可以将镜像文件写入到储存卡了。尽管有许多图形化的写入工具，我还是习惯是用古老的 <code>dd</code> 命令：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dd bs=4M if=/home/alan/Downloads/raspios/2020-08-20-raspios-buster-armhf-lite.img of=/dev/mmcblk0 status=progress conv=fsync</span>
</code></pre></div>

<h4>启动树莓派</h4>
<p>你只需要一个显示器、键盘、电源适配器来使用树莓派。我还有一个以太网网线用于网络连接，相比无线网络，我更喜欢通过网线来连接一个专用的服务器。</p>
<p>插入储存卡并打开树莓派的电源。一旦成功启动，用默认的缺省密码来进行登录：用户名 <code>pi</code>，密码<code>raspberry</code>。</p>
<h3>系统设置</h3>
<p>按照以下步骤尽可能最小化设置磁盘空间、内存使用等。我建议尽可能的花时间研究每个配置，使之尽量正确。通常有几种应用配置的方法，有些配置文件和选项可能会被丢弃，所以要查看产品文档确保你没有应用过时的配置。</p>
<h4>运行 raspi-config</h4>
<p>树莓派系统的主设置程序叫做 <code>raspi-config</code>。登录以后立即运行它：</p>
<div class="highlight"><pre><span></span><code># raspi-config
</code></pre></div>

<p><img alt="Raspberry Pi config main window" src="/data/attachment/album/202203/28/161230t2l8k1h7bx1xbflh.png" title="Raspberry Pi config main window"></p>
<p>它出现了一个扩展根文件系统的选项，可以利用储存卡上所有可利用的空间。选择这个选项之后，重启并重新登录。</p>
<p>用 <code>df</code> 命令来验证储存卡的总容量是否被完全使用：</p>
<div class="highlight"><pre><span></span><code># df -h
</code></pre></div>

<p>如果你需要设置其他选项，请再次运行 <code>raspi-config</code>。它们中的一些选项可以根据你的偏好和配置进行变化。仔细检查所有这些选项，确定没有任何遗漏。为了获得最佳性能，我建议做以下调整。（我跳过了一些我们没有做任何变化的选项。）</p>
<ul>
<li><ruby> 系统选项 <rt>  System options </rt></ruby>：在此你可以设置主机名，最好使用完全限定的域名（FQDN）。你也能在这里更改你的密码，这始终是强烈建议的。</li>
<li><ruby> 接口选项 <rt>  Interface options </rt></ruby>：开启 SSH 服务。</li>
<li><ruby> 性能选项 <rt>  Performance options </rt></ruby>：将 GPU 内存减少到最低值（16MB）。</li>
<li><ruby> 本地化选项 <rt>  Localization options </rt></ruby>：选择你的时区、位置、键盘类型。</li>
<li><ruby> 高级选项 <rt>  Advanced options </rt></ruby>：这个选项包括扩展根文件系统的选项。如果你在上面没扩展，一定要在这里做。这样你可以访问储存卡上的所有可用空间。</li>
<li><ruby> 更新 <rt>  Update </rt></ruby>：进入更新选项会立即检查 <code>raspi-config</code> 工具是否有更新。如果更新可用，它将被下载并应用，<code>raspi-config</code> 将在几秒钟后重启。</li>
</ul>
<p>一旦你在 <code>raspi-config</code> 中完成这些配置，选择“<ruby> 完成 <rt>  Finish </rt></ruby>”退出该工具。</p>
<h4>手动配置</h4>
<p>我还建议几个其他更改，它们全都要求编辑某种配置文件来手动更改设置。</p>
<h5>设置静态 IP 地址</h5>
<p>一般来说，最好用静态 IP 地址设置服务器。通过 <code>ip</code> 命令来验证网络接口，并设置 IP 地址和你的缺省网关（路由器）和域名服务（DNS）地址：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> ip link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether b8:27:eb:48:3f:46 brd ff:ff:ff:ff:ff:ff
</code></pre></div>

<p>你还需要知道你的缺省网关和一个及以上的 DNS 服务器地址。将这些信息添加到 <code>/etc/dhcpcd.conf</code> 配置文件中（我强烈建议更改之前对这个文件做一个备份）：</p>
<div class="highlight"><pre><span></span><code># cd /etc
# cp -a dhcpcd.conf dhcpcd.conf.original
</code></pre></div>

<p>按照以下来编辑文件：</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">vi</span><span class="w"> </span><span class="nx">dhcpcd</span><span class="p">.</span><span class="nx">conf</span>

<span class="err">#</span><span class="w"> </span><span class="nx">static</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">configuration</span><span class="p">:</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">eth0</span>
<span class="nx">static</span><span class="w"> </span><span class="nx">ip_address</span><span class="p">=</span><span class="m m-Double">192.168.1.5</span><span class="o">/</span><span class="mi">24</span>
<span class="nx">static</span><span class="w"> </span><span class="nx">routers</span><span class="p">=</span><span class="m m-Double">192.168.1.1</span>
<span class="nx">static</span><span class="w"> </span><span class="nx">domain_name_servers</span><span class="p">=</span><span class="m m-Double">192.168.1.3</span><span class="w"> </span><span class="m m-Double">192.168.1.4</span>
</code></pre></div>

<h5>关闭 IPv6 协议</h5>
<p>除非你有特别需要使用 IPv6，否则你可能倾向于禁用它。为此，你可以创建两个新文件，其中包括一个单行指令，指示 Linux 内核不要使用 IPv6。</p>
<p>首先，创建 <code>/etc/sysctl.d/disable-ipv6.conf</code> 文件，其中包含一行指令：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> cd /etc/sysctl.d
<span class="gh">#</span> echo &quot;net.ipv6.conf.all.disable_ipv6 = 1&quot; &gt; disable-ipv6.conf
</code></pre></div>

<p>然后创建 <code>/etc/modprobe.d/blacklist-ipv6.conf</code> 文件包含一行指令：</p>
<div class="highlight"><pre><span></span><code># cd /etc/modprobe.d
# echo &quot;blacklist ipv6&quot; &gt; blacklist-ipv6.conf
</code></pre></div>

<h5>关闭 Wi-Fi、蓝牙和音频</h5>
<p>我的服务器的具体用途并不需要蓝牙和音频，同时，它用以太网连接，并不使用无线（Wi-Fi）。除非你计划用它们，否则按照以下步骤来关闭它们。</p>
<p>对 <code>/boot/config.txt</code> 这个文件做以下更改（再次强调，我建议为这个文件做个备份）：</p>
<div class="highlight"><pre><span></span><code># cd /boot
# cp -a config.txt config.txt.original
</code></pre></div>

<p>加入以下两个指令到文件底部来禁用蓝牙和 Wi-Fi：</p>
<ul>
<li><code>dtoverlay=disable-bt</code></li>
<li><code>dtoverlay=disable-wifi</code></li>
</ul>
<p>这些 <code>echo</code> 命令就可以完成：</p>
<div class="highlight"><pre><span></span><code># cd /boot
# echo &quot;dtoverlay=disable-bt&quot; &gt;&gt; config.txt
# echo &quot;dtoverlay=disable-wifi&quot; &gt;&gt; config.txt
</code></pre></div>

<p>要关闭音频，更改 <code>dtparam=audio</code> 的参数为 <code>off</code>。你可以用一个简短的命令 <code>sed</code> 来完成：</p>
<div class="highlight"><pre><span></span><code># sed -i &#39;/dtparam=audio/c dtparam=audio=off&#39; config.txt
</code></pre></div>

<p>最后一步是禁用 Wi-Fi 服务，用 <code>systemctl mask</code> 命令来操作：</p>
<div class="highlight"><pre><span></span><code>systemctl mask wpa_supplicant.service
</code></pre></div>

<p>如果你不需要其他服务的话，也可以禁用它们：</p>
<ul>
<li>禁用调制解调器服务：<code>systemctl disable hciuart</code></li>
<li>禁用 Avahi 守护进程：<code>systemctl disable avahi-daemon.service</code></li>
</ul>
<h3>最后一步</h3>
<p>检查你的内存使用量：</p>
<div class="highlight"><pre><span></span><code># free -h
</code></pre></div>

<p>我震惊了：我的系统只用了 30MB 的内存。</p>
<p>创建个人账户：建议为登录这台服务器的个人创建用户账户。你能分配他们到 <code>sudo</code> 组允许他们运行管理命令。举个例子，创建一个用户名为 George 的一个账户。</p>
<div class="highlight"><pre><span></span><code># adduser george
# usermod -a -G adm,sudo,users george 
</code></pre></div>

<p>进行更新：这是一个重要的步骤。应用更新来获取树莓派操作系统的最新修复。</p>
<div class="highlight"><pre><span></span><code># apt update
# apt full-upgrade
</code></pre></div>

<p>重启：重启你的新服务器是一个好主意:</p>
<div class="highlight"><pre><span></span><code># systemctl reboot`
</code></pre></div>

<p>安装 Cockpit：你可以在树莓派系统上安装著名的 Linux Web 控制台 <a href="https://cockpit-project.org/">Cockpit</a>，它提供了一个基于 HTML 界面来远程管理和监控你的服务器。我最近写了一篇 <a href="https://opensource.com/article/20/11/cockpit-server-management">Cockpit 入门</a> 的文章。用这个命令来安装它</p>
<div class="highlight"><pre><span></span><code># apt install cockpit
</code></pre></div>

<p>现在我的树莓派服务器已经准备好托管服务器了，我能用它来做 <a href="https://opensource.com/article/17/3/building-personal-web-server-raspberry-pi-3">网页服务器</a>、<a href="https://opensource.com/article/19/6/raspberry-pi-vpn-server">VPN 服务器</a>、 <a href="https://github.com/minetest">Minetest</a> 等游戏服务器，或者就像我做的基于 <a href="https://opensource.com/article/18/2/block-ads-raspberry-pi">Pi-Hole 的广告屏蔽器</a> 。</p>
<h3>保持旧硬件的活力</h3>
<p>不论你有什么硬件，仔细地精简并控制你的操作系统和软件包，可以使你的系统资源使用量保持在低水平，以便你获得最大收益。这还可以通过减少试图利用漏洞的潜在恶意行为者可用的服务和软件包数量，提高了安全性。</p>
<p>因此，在你丢弃旧硬件之前，考虑一下能够继续使用的各种可能性。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>