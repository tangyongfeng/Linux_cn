<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>用 SELinux 保护你的容器</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Mike Calizo 黑掉你的系统，了解为什么配置 SELinux 作为你的第一道容器防线是很重要的。 当有些事情在你的 Linux 环境中不能正常工 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li class="active"><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2022/03/yong-selinux-bao-hu-ni-de-rong-qi.html" rel="bookmark"
           title="Permalink to 用 SELinux 保护你的容器">用 SELinux 保护你的容器</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2022-03-02T09:36:24+01:00">
                Published: Wed 02 March 2022
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/rong-qi-yu-yun">容器与云</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Mike Calizo</p>
<blockquote>
<p>黑掉你的系统，了解为什么配置 SELinux 作为你的第一道容器防线是很重要的。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202203/02/093614t53cfb857841qzzk.jpg" title="Three closed doors"></p>
<p>当有些事情在你的 Linux 环境中不能正常工作时，最简单的方法就是禁用<ruby> 安全增强型 Linux <rt>  Security-Enhanced Linux </rt></ruby>（<a href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux">SELinux</a>）。而当它突然可以工作了，你就会忘记了禁用这件事 —— 这是一个常见的陷阱，意味着你已经失去了一个非常强大的安全工具。</p>
<p>随着容器、微服务和分布式架构的兴起，威胁也在上升。这是由于一个老的、众所周知的问题：速度。容器的优势在于它们能让你快速行动，做更多的事情，并迅速改变。这意味着容器的采用已经飞速发展，但它所提供的速度也意味着你会遇到更多的问题和漏洞。当你越来越快地做更多的事情时，这自然会发生。</p>
<h3>如何减轻威胁</h3>
<p>正如孙子所说，“不战而屈人之兵”。当涉及到容器的基本防御时，这句话真的很有共鸣。为了避免问题（战斗），确保你的容器主机是安全的，你可以使用 SELinux 作为你的第一道防线。</p>
<p>SELinux 是一个开源项目，于 2000 年发布，2003 年集成到 Linux 内核中。根据 <a href="https://www.redhat.com/en/topics/linux/what-is-selinux">红帽公司的解释</a>，“SELinux 是 <a href="https://www.redhat.com/en/topics/linux/what-is-linux">Linux 系统</a> 的一个安全架构，允许管理员对谁可以访问系统有更多的控制。它最初是由美国国家安全局（NSA）开发的，是使用 Linux 安全模块（LSM）对 <a href="https://www.redhat.com/en/topics/linux/what-is-the-linux-kernel">Linux 内核</a> 的一系列补丁。”</p>
<h3>开始吧</h3>
<p>当你想到容器时，首先想到的可能是 <a href="https://opensource.com/resources/what-docker">Docker</a>。Docker 在 2013 年出现后掀起了一场容器采用革命。它是容器爆炸性流行的主要原因之一，但如上所述，大量采用增加了用户对安全风险的脆弱性。</p>
<p>在你用 SELinux 保护你的 Docker 容器之前，你需要设置一些东西。</p>
<h4>前置条件</h4>
<ul>
<li>安装并配置了 CentOS 8/RHEL 8。</li>
<li>安装并配置好 Docker CE</li>
<li>创建两个账户：root 和 非 root 用户（下面的例子中是 <code>mcalizo</code>）。</li>
</ul>
<p>如果你需要在你的 RHEL 8/CentOS 8 服务器上设置 Docker，你可以按照这些 <a href="https://www.linuxtechi.com/install-docker-ce-centos-8-rhel-8/">说明</a>。如果你运行的是 RHEL 8，你需要在开始之前删除预装的 Podman 和 runc 包。</p>
<p>首先，确保 SELinux 被启用：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">mcalizo@Rhel82 ~</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">sestatus</span>
<span class="n">SELinux</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span><span class="w">                 </span><span class="n">enabled</span>
<span class="n">SELinuxfs</span><span class="w"> </span><span class="nl">mount</span><span class="p">:</span><span class="w">                </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">selinux</span>
<span class="n">SELinux</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="nl">directory</span><span class="p">:</span><span class="w">         </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span>
<span class="n">Loaded</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w">             </span><span class="n">targeted</span>
<span class="k">Current</span><span class="w"> </span><span class="nl">mode</span><span class="p">:</span><span class="w">                   </span><span class="n">enforcing</span>
<span class="n">Mode</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="k">file</span><span class="err">:</span><span class="w">          </span><span class="n">enforcing</span>
<span class="n">Policy</span><span class="w"> </span><span class="n">MLS</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span><span class="w">              </span><span class="n">enabled</span>
<span class="n">Policy</span><span class="w"> </span><span class="n">deny_unknown</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span><span class="w">     </span><span class="n">allowed</span>
<span class="n">Memory</span><span class="w"> </span><span class="n">protection</span><span class="w"> </span><span class="nl">checking</span><span class="p">:</span><span class="w">     </span><span class="n">actual</span><span class="w"> </span><span class="p">(</span><span class="n">secure</span><span class="p">)</span>
<span class="nf">Max</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="nl">version</span><span class="p">:</span><span class="w">      </span><span class="mi">31</span>
<span class="o">[</span><span class="n">mcalizo@Rhel82 ~</span><span class="o">]</span><span class="err">$</span>
</code></pre></div>

<p>然后，验证你的操作系统版本和 Docker 正在运行。以 root 身份登录并运行：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">rhel82</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># cat /etc/redhat-release</span>
<span class="n">Red</span><span class="w"> </span><span class="n">Hat</span><span class="w"> </span><span class="n">Enterprise</span><span class="w"> </span><span class="n">Linux</span><span class="w"> </span><span class="n">release</span><span class="w"> </span><span class="mf">8.2</span><span class="w"> </span><span class="p">(</span><span class="n">Ootpa</span><span class="p">)</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">rhel82</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">rhel82</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># systemctl status docker</span>
<span class="err">●</span><span class="w"> </span><span class="n">docker</span><span class="o">.</span><span class="n">service</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Engine</span>
<span class="w">   </span><span class="n">Loaded</span><span class="p">:</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">service</span><span class="p">;</span><span class="w"> </span><span class="n">enabled</span><span class="p">;</span><span class="w"> </span><span class="n">vendor</span><span class="w"> </span><span class="n">preset</span><span class="p">:</span><span class="w"> </span><span class="n">disabled</span><span class="p">)</span>
<span class="w">   </span><span class="n">Active</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">Wed</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">EDT</span><span class="p">;</span><span class="w"> </span><span class="mi">15</span><span class="n">s</span><span class="w"> </span><span class="n">ago</span>
<span class="w">     </span><span class="n">Docs</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span>
<span class="w"> </span><span class="n">Main</span><span class="w"> </span><span class="n">PID</span><span class="p">:</span><span class="w"> </span><span class="mi">30768</span><span class="w"> </span><span class="p">(</span><span class="n">dockerd</span><span class="p">)</span>
<span class="w">    </span><span class="n">Tasks</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span>
<span class="w">   </span><span class="n">Memory</span><span class="p">:</span><span class="w"> </span><span class="mf">39.0</span><span class="n">M</span>
<span class="w">   </span><span class="n">CGroup</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">system</span><span class="o">.</span><span class="n">slice</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">service</span>
<span class="w">           </span><span class="err">└─</span><span class="mi">30768</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dockerd</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="n">fd</span><span class="p">:</span><span class="o">//</span><span class="w"> </span><span class="o">--</span><span class="n">containerd</span><span class="o">=/</span><span class="n">run</span><span class="o">/</span><span class="n">containerd</span><span class="o">/</span><span class="n">containerd</span><span class="o">.</span><span class="n">sock</span>

<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">13</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:13.889602941-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">error</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">13</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:13.903413613-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">warning</span><span class="w"> </span><span class="n">msg</span><span class="o">&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">13</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:13.903427451-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">warning</span><span class="w"> </span><span class="n">msg</span><span class="o">&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">13</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:13.903538271-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;L&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:14.132060506-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;D&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:14.308943088-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;L&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:14.319438549-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;D&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:14.319570298-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;D&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">dockerd</span><span class="p">[</span><span class="mi">30768</span><span class="p">]:</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;2020-10-28T19:10:14.333419209-04:00&quot;</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="n">info</span><span class="w"> </span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;A&gt;</span>
<span class="n">Oct</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">rhel82</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">labs</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">systemd</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="w"> </span><span class="n">Started</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">Engine</span>
</code></pre></div>

<p>检查你的 Docker 版本：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">Docker</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">19.03.13</span><span class="p">,</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="mi">4484</span><span class="n">c46d9d</span>
</code></pre></div>

<h3>黑掉主机</h3>
<p>了解一个问题的最好方法之一就是去体验它。因此，我将告诉你，如果你的安全设置不当，向 Docker 主机注入恶意代码是多么容易。</p>
<p>为了能够在 Docker 主机上做坏事，“恶意”的非 root 用户（本教程中为 <code>mcalizo</code>）必须是可以实例化 Docker 容器的组的成员。</p>
<p>首先，确认 <code>mcalizo</code> 用户属于哪个组：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="n">mcalizo</span>
<span class="n">mcalizo</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">mcalizo</span>
</code></pre></div>

<p>输出显示，<code>mcalizo</code> 只属于它自己的组。这意味着 <code>mcalizo</code> 不能实例化 Docker 容器，如果它试图这样做，将会得到这个错误：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">mcalizo</span><span class="err">@</span><span class="n">Rhel82</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="n">centos</span><span class="p">:</span><span class="n">latest</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="n">docker</span><span class="p">:</span><span class="w"> </span><span class="n">Got</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="n">denied</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">daemon</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//%</span><span class="mi">2</span><span class="n">Fvar</span><span class="o">%</span><span class="mi">2</span><span class="n">Frun</span><span class="o">%</span><span class="mi">2</span><span class="n">Fdocker</span><span class="o">.</span><span class="n">sock</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mi">40</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">create</span><span class="p">:</span><span class="w"> </span><span class="n">dial</span><span class="w"> </span><span class="n">unix</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span><span class="w"> </span><span class="n">connect</span><span class="p">:</span><span class="w"> </span><span class="n">permission</span><span class="w"> </span><span class="n">denied</span><span class="o">.</span>
<span class="n">See</span><span class="w"> </span><span class="s1">&#39;docker run --help&#39;</span><span class="o">.</span>
</code></pre></div>

<p>要允许 <code>mcalizo</code> 实例化容器，将用户加入 <code>docker</code> 组：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">usermod</span><span class="w"> </span><span class="o">-</span><span class="n">G</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="n">mcalizo</span>
<span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="n">mcalizo</span>
<span class="n">mcalizo</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">mcalizo</span><span class="w"> </span><span class="n">docker</span>
</code></pre></div>

<p>接下来，部署一个 <code>fedora:latest</code> 的容器，并登录到实例化的容器中去探索它：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">mcalizo</span><span class="err">@</span><span class="n">Rhel82</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="n">fedora</span><span class="p">:</span><span class="n">latest</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="s1">&#39;fedora:latest&#39;</span><span class="w"> </span><span class="n">locally</span>
<span class="n">latest</span><span class="p">:</span><span class="w"> </span><span class="n">Pulling</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">fedora</span>
<span class="n">ee7e89337106</span><span class="p">:</span><span class="w"> </span><span class="n">Pull</span><span class="w"> </span><span class="n">complete</span>
<span class="n">Digest</span><span class="p">:</span><span class="w"> </span><span class="n">sha256</span><span class="p">:</span><span class="n">b9ec86d36fca7b1d3de39cd7c258e8d90c377d312c21a7748071ce49069b8db4</span>
<span class="n">Status</span><span class="p">:</span><span class="w"> </span><span class="n">Downloaded</span><span class="w"> </span><span class="n">newer</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fedora</span><span class="p">:</span><span class="n">latest</span>
<span class="n">sh</span><span class="o">-</span><span class="mf">5.0</span><span class="c1"># cat /etc/redhat-release</span>
<span class="n">Fedora</span><span class="w"> </span><span class="n">release</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="p">(</span><span class="n">Thirty</span><span class="w"> </span><span class="n">Three</span><span class="p">)</span>
</code></pre></div>

<p>当你登录到新创建的容器时，你可以看到你是以 root 身份自动登录的：</p>
<div class="highlight"><pre><span></span><code>sh-5.0# whoami
root
sh-5.0#
</code></pre></div>

<p>作为 <code>root</code> 用户，你可以在这个容器中做任何事情，这意味着你可以利用容器主机，做很多破坏。因为你可以实例化一个容器，即使你不属于主机的 sudoers 账户，你也可以对主机做一些事情。</p>
<p>退出你刚刚创建的容器，并创建一个新的容器来演示这个漏洞：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">mcalizo</span><span class="p">@</span><span class="n">Rhel82</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="n">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/:/</span><span class="n">exploit</span><span class="w"> </span><span class="n">fedora</span><span class="o">:</span><span class="n">latest</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="p">[</span><span class="n">root</span><span class="mf">@131043f2e306</span><span class="w"> </span><span class="o">/</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<p><a href="https://docs.docker.com/storage/volumes/">-v 选项</a> 将 Docker 主机的 <code>/</code> 目录挂载到 <code>/exploit</code> 目录下的容器：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="mf">@131043f2e306</span><span class="w"> </span><span class="o">/</span><span class="p">]</span><span class="err">#</span><span class="n">ls</span><span class="w"> </span><span class="n">exploit</span><span class="o">/</span>
<span class="n">bin</span><span class="w">  </span><span class="n">boot</span><span class="w">  </span><span class="n">dev</span><span class="w">  </span><span class="n">etc</span><span class="w">  </span><span class="n">home</span><span class="w">  </span><span class="n">lib</span><span class="w">  </span><span class="n">lib64</span><span class="w">  </span><span class="n">media</span><span class="w">  </span><span class="n">mnt</span><span class="w">  </span><span class="n">opt</span><span class="w">  </span><span class="n">proc</span><span class="w">  </span><span class="n">root</span><span class="w">  </span><span class="n">run</span><span class="w">  </span><span class="n">sbin</span><span class="w">  </span><span class="n">srv</span><span class="w">  </span><span class="n">sys</span><span class="w">  </span><span class="n">tmp</span><span class="w">  </span><span class="n">usr</span><span class="w">  </span><span class="n">var</span>
</code></pre></div>

<p>因为它已被挂载，你可以在 Docker 主机上做任何事情。例如，你可以删除文件、编辑特定的配置来破害系统，甚至安装木马程序或其他恶意软件来窃取重要信息。</p>
<h3>为什么会发生这种情况？</h3>
<p>你可能想知道，既然 SELinux 处于强制模式，为什么会出现这种情况？深入挖掘 SELinux，看看哪里出了问题。</p>
<p>验证 SELinux 是否有一个 <a href="https://docs.docker.com/engine/reference/commandline/context/">Docker 上下文</a>：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">mcalizo@Rhel82 ~</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">-</span><span class="n">eZ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">docker</span>
<span class="nl">system_u</span><span class="p">:</span><span class="nl">system_r</span><span class="p">:</span><span class="nl">container_runtime_t</span><span class="p">:</span><span class="n">s0</span><span class="w"> </span><span class="mi">30768</span><span class="w"> </span><span class="vm">?</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">04</span><span class="w"> </span><span class="n">dockerd</span>
<span class="o">[</span><span class="n">mcalizo@Rhel82 ~</span><span class="o">]</span><span class="err">$</span>
</code></pre></div>

<p>正如预期的那样，它确实有。这意味着 SELinux 管理着 Docker 守护进程。检查 Docker 守护进程，看看 SELinux 是否默认启用：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">mcalizo@Rhel82 ~</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="o">-</span><span class="n">A3</span>
<span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="nl">Options</span><span class="p">:</span>
<span class="w">  </span><span class="n">seccomp</span>
<span class="w">   </span><span class="nl">Profile</span><span class="p">:</span><span class="w"> </span><span class="k">default</span>
<span class="w"> </span><span class="n">Kernel</span><span class="w"> </span><span class="nl">Version</span><span class="p">:</span><span class="w"> </span><span class="mf">4.18.0</span><span class="o">-</span><span class="mf">193.</span><span class="n">el8</span><span class="p">.</span><span class="n">x86_64</span>
</code></pre></div>

<p>Docker 守护进程中的 SELinux 在默认情况下是 <strong>不启用</strong> 的。 这就是问题所在！要解决这个问题，按 <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">文档</a> 说明，通过更新或创建文件 <code>/etc/docker/daemon.json</code> 来启用 SELinux 来控制和管理 Docker（你必须有 root 权限才能这样做）：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">daemon</span><span class="p">.</span><span class="n">json</span>
<span class="err">{</span>
<span class="w">  </span><span class="ss">&quot;selinux-enabled&quot;</span><span class="err">:</span><span class="w"> </span><span class="k">true</span>
<span class="err">}</span>
<span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span>
<span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">docker</span>
</code></pre></div>

<p>在创建或更新该文件并重启 Docker 后，你应该看到 Docker 守护进程中启用了 SELinux 支持：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@Rhel82 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">docker</span>
<span class="o">[</span><span class="n">mcalizo@Rhel82 root</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="o">-</span><span class="n">A3</span>
<span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="nl">Options</span><span class="p">:</span>
<span class="w">  </span><span class="n">seccomp</span>
<span class="w">   </span><span class="nl">Profile</span><span class="p">:</span><span class="w"> </span><span class="k">default</span>
<span class="w">  </span><span class="n">selinux</span>
<span class="o">[</span><span class="n">mcalizo@Rhel82 root</span><span class="o">]</span><span class="err">$</span>
</code></pre></div>

<p>虽然仍然可以在你的 Docker 容器上挂载 Docker 主机中的特定文件系统，但不再允许更新或访问该文件：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">mcalizo@Rhel82 root</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="err">:</span><span class="o">/</span><span class="n">exploit</span><span class="w"> </span><span class="nl">fedora</span><span class="p">:</span><span class="n">latest</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@ecb5836da1f6 /</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadow</span><span class="p">.</span><span class="n">sh</span>
<span class="nl">touch</span><span class="p">:</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="s1">&#39;/exploit/etc/shadow.sh&#39;</span><span class="err">:</span><span class="w"> </span><span class="n">Permission</span><span class="w"> </span><span class="n">denied</span>
<span class="o">[</span><span class="n">root@ecb5836da1f6 /</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<h3>了解更多</h3>
<p>你在容器世界中的第一道防线取决于你对容器主机的操作系统的设置有多强。有许多方法可以实现 Linux 的安全性，包括市场上可供选择的方案，以增强你的安全态势。</p>
<p>SELinux 是一个额外的安全层，默认情况下内置于 <a href="https://www.redhat.com/en/topics/linux/whats-the-best-linux-distro-for-you">Linux 发行版</a> 中。为了借助它保护你的系统不被破坏，请确保 SELinux 保持开启状态。</p>
<p>如果你想了解更多，请参阅：</p>
<ul>
<li><a href="https://www.linuxtechi.com/install-docker-ce-centos-8-rhel-8/">如何在 CentOS 8 / RH 上安装 Docker CE</a></li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html">Docker 安全速查表</a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/dockerd/">dockerd 文档</a></li>
<li><a href="https://docs.docker.com/storage/volumes/">卷的使用文档</a></li>
<li><a href="https://www.redhat.com/en/topics/linux/what-is-selinux">什么是 SELinux？</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>