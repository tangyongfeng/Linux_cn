<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>一个用 Java 实现的超轻量级 RESTful Web 服务示例</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Marty Kalin 通过管理一套图书的完整代码示例，来探索轻量级的 RESTful 服务。 Web 服务，以这样或那样的形式，已经存在了近二十年。比 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2020/08/yi-ge-yong-java-shi-xian-de-chao-qing-liang-ji-restful-web-fu-wu-shi-li.html" rel="bookmark"
           title="Permalink to 一个用 Java 实现的超轻量级 RESTful Web 服务示例">一个用 Java 实现的超轻量级 RESTful Web 服务示例</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-08-27T07:19:00+02:00">
                Published: Thu 27 August 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Marty Kalin</p>
<blockquote>
<p>通过管理一套图书的完整代码示例，来探索轻量级的 RESTful 服务。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202008/27/071808tt9zlno3b6lmbgl8.jpg"></p>
<p>Web 服务，以这样或那样的形式，已经存在了近二十年。比如，<a href="http://xmlrpc.com/">XML-RPC 服务</a>出现在 90 年代后期，紧接着是用 SOAP 分支编写的服务。在 XML-RPC 和 SOAP 这两个开拓者之后出现后不久，REST 架构风格的服务在大约 20 年前也出现了。<a href="https://www.redhat.com/en/topics/integration/whats-the-difference-between-soap-rest">REST</a> 风格（以下简称 Restful）服务现在主导了流行的网站，比如 eBay、Facebook 和 Twitter。尽管分布式计算的 Web 服务有很多替代品（如 Web 套接字、微服务和远程过程调用的新框架），但基于 Restful 的 Web 服务依然具有吸引力，原因如下：</p>
<ul>
<li>Restful 服务建立在现有的基础设施和协议上，特别是 Web 服务器和 HTTP/HTTPS 协议。一个拥有基于 HTML 的网站的组织可以很容易地为客户添加 Web 服务，这些客户对数据和底层功能更感兴趣，而不是对 HTML 的表现形式感兴趣。比如，亚马逊就率先通过网站和 Web 服务（基于 SOAP 或 Restful）提供相同的信息和功能。</li>
<li>Restful 服务将 HTTP 当作 API，因此避免了复杂的软件分层，这种分层是基于 SOAP 的 Web 服务的明显特征。比如，Restful API 支持通过 HTTP 命令（POST-GET-PUT-DELETE）进行标准的 CRUD（增加-读取-更新-删除）操作；通过 HTTP 状态码可以知道请求是否成功或者为什么失败。</li>
<li>Restful Web 服务可以根据需要变得简单或复杂。Restful 是一种风格，实际上是一种非常灵活的风格，而不是一套关于如何设计和构造服务的规定。（伴随而来的缺点是，可能很难确定哪些服务不能算作 Restful 服务。）</li>
<li>作为使用者或者客户端，Restful Web 服务与语言和平台无关。客户端发送 HTTP(S) 请求，并以适合现代数据交换的格式（如 JSON）接收文本响应。</li>
<li>几乎每一种通用编程语言都至少对 HTTP/HTTPS 有足够的（通常是强大的）支持，这意味着 Web 服务的客户端可以用这些语言来编写。</li>
</ul>
<p>这篇文章将通过一段完整的 Java 代码示例来探讨轻量级的 Restful 服务。</p>
<h3>基于 Restful 的“小说” Web 服务</h3>
<p>基于 Restful 的“小说” web 服务包含三个程序员定义的类：</p>
<ul>
<li><code>Novel</code> 类代表一个小说，只有三个属性：机器生成的 ID、作者和标题。属性可以根据实际情况进行扩展，但我还是想让这个例子看上去更简单一些。</li>
<li><code>Novels</code> 类包含了用于各种任务的工具类：将一个 <code>Novel</code> 或者它们的列表的纯文本编码转换成 XML 或者 JSON；支持在小说集合上进行 CRUD 操作；以及从存储在文件中的数据初始化集合。<code>Novels</code> 类在 <code>Novel</code> 实例和 servlet 之间起中介作用。</li>
<li><code>NovelsServlet</code> 类是从 <code>HttpServlet</code> 中继承的，<code>HttpServlet</code> 是一段健壮且灵活的代码，自 90 年代末的早期企业级 Java 就已经存在了。对于客户端的 CRUD 请求，servlet 可以当作 HTTP 的端点。 servlet 代码主要用于处理客户端的请求和生成相应的响应，而将复杂的细节留给 <code>Novels</code> 类中的工具类进行处理。</li>
</ul>
<p>一些 Java 框架，比如 Jersey（JAX-RS）和 Restlet，就是为 Restful 服务设计的。尽管如此，<code>HttpServlet</code> 本身为完成这些服务提供了轻量、灵活、强大且充分测试过的 API。我会通过下面的“小说”例子来说明。</p>
<h3>部署“小说” Web 服务</h3>
<p>当然，部署“小说” Web 服务需要一个 Web 服务器。我的选择是 <a href="http://tomcat.apache.org/">Tomcat</a>，但是如果该服务托管在 Jetty 或者甚至是 Java 应用服务器上，那么这个服务应该至少可以工作（著名的最后一句话！）。<a href="https://condor.depaul.edu/mkalin">在我的网站上</a>有总结了如何安装 Tomcat 的 README 文件和代码。还有一个附带文档的 Apache Ant 脚本，可以用来构建“小说”服务（或者任何其他服务或网站），并且将它部署在 Tomcat 或相同的服务。</p>
<p>Tomcat 可以从它的<a href="https://tomcat.apache.org/download-90.cgi">官网</a>上下载。当你在本地安装后，将 <code>TOMCAT_HOME</code> 设置为安装目录。有两个子目录值得关注：</p>
<ul>
<li><code>TOMCAT_HOME/bin</code> 目录包含了类 Unix 系统（<code>startup.sh</code> 和 <code>shutdown.sh</code>）和 Windows（<code>startup.bat</code> 和 <code>shutdown.bat</code>） 的启动和停止脚本。Tomcat 作为 Java 应用程序运行。Web 服务器的 servlet 容器叫做 Catalina。（在 Jetty 中，Web 服务器和容器的名字一样。）当 Tomcat 启动后，在浏览器中输入 <code>http://localhost:8080/</code>可以查看详细文档，包括示例。</li>
<li><code>TOMCAT_HOME/webapps</code> 目录是已部署的 Web 网站和服务的默认目录。部署网站或 Web 服务的直接方法是复制以 <code>.war</code> 结尾的 JAR 文件（也就是 WAR 文件）到 <code>TOMCAT_HOME/webapps</code> 或它的子目录下。然后 Tomcat 会将 WAR 文件解压到它自己的目录下。比如，Tomcat 会将 <code>novels.war</code> 文件解压到一个叫做 <code>novels</code> 的子目录下，并且保留 <code>novels.war</code> 文件。一个网站或 Web 服务可以通过删除 WAR 文件进行移除，也可以用一个新版 WAR 文件来覆盖已有文件进行更新。顺便说一下，调试网站或服务的第一步就是检查 Tomcat 已经正确解压 WAR 文件；如果没有的话，网站或服务就无法发布，因为代码或配置中有致命错误。</li>
<li>因为 Tomcat 默认会监听 8080 端口上的 HTTP 请求，所以本机上的 URL 请求以 <code>http://localhost:8080/</code> 开始。</li>
</ul>
<p>通过添加不带 <code>.war</code> 后缀的 WAR 文件名来访问由程序员部署的 WAR 文件：</p>
<div class="highlight"><pre><span></span><code>http://locahost:8080/novels/
</code></pre></div>

<p>如果服务部署在 <code>TOMCAT_HOME</code> 下的一个子目录中（比如，<code>myapps</code>），这会在 URL 中反映出来：</p>
<div class="highlight"><pre><span></span><code>http://locahost:8080/myapps/novels/
</code></pre></div>

<p>我会在靠近文章结尾处的测试部分提供这部分的更多细节。</p>
<p>如前所述，我的主页上有一个包含 Ant 脚本的 ZIP 文件，这个文件可以编译并且部署网站或者服务。（这个 ZIP 文件中也包含一个 <code>novels.war</code> 的副本。）对于“小说”这个例子，命令的示例（<code>%</code> 是命令行提示符）如下：</p>
<div class="highlight"><pre><span></span><code><span class="c">% ant -Dwar.name=novels deploy</span>
</code></pre></div>

<p>这个命令首先会编译 Java 源代码，并且创建一个可部署的 <code>novels.war</code> 文件，然后将这个文件保存在当前目录中，再复制到 <code>TOMCAT_HOME/webapps</code> 目录中。如果一切顺利，<code>GET</code> 请求（使用浏览器或者命令行工具，比如 <code>curl</code>）可以用来做一个测试：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl http://localhost:8080/novels/</span>
</code></pre></div>

<p>默认情况下，Tomcat 设置为 <ruby> 热部署 <rt>  hot deploys </rt></ruby>：Web 服务器不需要关闭就可以进行部署、更新或者移除一个 web 应用。</p>
<h3>“小说”服务的代码</h3>
<p>让我们回到“小说”这个例子，不过是在代码层面。考虑下面的 <code>Novel</code> 类：</p>
<h4>例 1：Novel 类</h4>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">novels</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">Novel</span> <span class="n">implements</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">Novel</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">static</span> <span class="n">final</span> <span class="n">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1</span><span class="n">L</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">author</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">title</span><span class="p">;</span>
    <span class="n">private</span> <span class="nb">int</span> <span class="nb">id</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">Novel</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">setAuthor</span><span class="p">(</span><span class="n">final</span> <span class="n">String</span> <span class="n">author</span><span class="p">)</span> <span class="p">{</span> <span class="n">this</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">author</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">getAuthor</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">author</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">setTitle</span><span class="p">(</span><span class="n">final</span> <span class="n">String</span> <span class="n">title</span><span class="p">)</span> <span class="p">{</span> <span class="n">this</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">getTitle</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">title</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">setId</span><span class="p">(</span><span class="n">final</span> <span class="nb">int</span> <span class="nb">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">this</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="nb">int</span> <span class="n">getId</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">id</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">public</span> <span class="nb">int</span> <span class="n">compareTo</span><span class="p">(</span><span class="n">final</span> <span class="n">Novel</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">id</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>这个类实现了 <code>Comparable</code> 接口中的 <code>compareTo</code> 方法，因为 <code>Novel</code> 实例是存储在一个线程安全的无序 <code>ConcurrentHashMap</code> 中。在响应查看集合的请求时，“小说”服务会对从映射中提取的集合（一个 <code>ArrayList</code>）进行排序；<code>compareTo</code> 的实现通过 <code>Novel</code> 的 ID 将它按升序排序。</p>
<p><code>Novels</code> 类中包含多个实用工具函数：</p>
<h4>例 2：Novels 实用工具类</h4>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">novels</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.beans.XMLEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletContext</span><span class="p">;</span> <span class="o">//</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">JavaSE</span>
<span class="kn">import</span> <span class="nn">org.json.JSONObject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.json.XML</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">Novels</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">final</span> <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;/WEB-INF/data/novels.db&quot;</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Novel</span><span class="o">&gt;</span> <span class="n">novels</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">ServletContext</span> <span class="n">sctx</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">AtomicInteger</span> <span class="n">mapKey</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">Novels</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">novels</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Novel</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">mapKey</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AtomicInteger</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">setServletContext</span><span class="p">(</span><span class="n">ServletContext</span> <span class="n">sctx</span><span class="p">)</span> <span class="p">{</span> <span class="n">this</span><span class="o">.</span><span class="n">sctx</span> <span class="o">=</span> <span class="n">sctx</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">public</span> <span class="n">ServletContext</span> <span class="n">getServletContext</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">sctx</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">public</span> <span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Novel</span><span class="o">&gt;</span> <span class="n">getConcurrentMap</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getServletContext</span><span class="p">()</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">null</span><span class="p">;</span> <span class="o">//</span> <span class="ow">not</span> <span class="n">initialized</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">novels</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">populate</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">novels</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">String</span> <span class="n">toXml</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span> <span class="n">default</span> <span class="n">encoding</span>
        <span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ByteArrayOutputStream</span><span class="p">();</span>
            <span class="n">XMLEncoder</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">new</span> <span class="n">XMLEncoder</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">encoder</span><span class="o">.</span><span class="n">writeObject</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
            <span class="n">encoder</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">catch</span><span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">xml</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">String</span> <span class="n">toJson</span><span class="p">(</span><span class="n">String</span> <span class="n">xml</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span> <span class="n">option</span> <span class="k">for</span> <span class="n">requester</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">JSONObject</span> <span class="n">jobt</span> <span class="o">=</span> <span class="n">XML</span><span class="o">.</span><span class="n">toJSONObject</span><span class="p">(</span><span class="n">xml</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">jobt</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="o">//</span> <span class="mi">3</span> <span class="ow">is</span> <span class="n">indentation</span> <span class="n">level</span>
        <span class="p">}</span>
        <span class="n">catch</span><span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="nb">int</span> <span class="n">addNovel</span><span class="p">(</span><span class="n">Novel</span> <span class="n">novel</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">int</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">mapKey</span><span class="o">.</span><span class="n">incrementAndGet</span><span class="p">();</span>
        <span class="n">novel</span><span class="o">.</span><span class="n">setId</span><span class="p">(</span><span class="nb">id</span><span class="p">);</span>
        <span class="n">novels</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">novel</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">private</span> <span class="n">void</span> <span class="n">populate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">InputStream</span> <span class="ow">in</span> <span class="o">=</span> <span class="n">sctx</span><span class="o">.</span><span class="n">getResourceAsStream</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">fileName</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Convert</span> <span class="n">novel</span><span class="o">.</span><span class="n">db</span> <span class="n">string</span> <span class="n">data</span> <span class="n">into</span> <span class="n">novels</span><span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">in</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">InputStreamReader</span> <span class="n">isr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="ow">in</span><span class="p">);</span>
                <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span>

                <span class="n">String</span> <span class="n">record</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">record</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">readLine</span><span class="p">())</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">String</span><span class="p">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">parts</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">Novel</span> <span class="n">novel</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Novel</span><span class="p">();</span>
                        <span class="n">novel</span><span class="o">.</span><span class="n">setAuthor</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                        <span class="n">novel</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                        <span class="n">addNovel</span><span class="p">(</span><span class="n">novel</span><span class="p">);</span> <span class="o">//</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">Id</span><span class="p">,</span> <span class="n">adds</span> <span class="n">to</span> <span class="nb">map</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="ow">in</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>最复杂的方法是 <code>populate</code>，这个方法从一个包含在 WAR 文件中的文本文件读取。这个文本文件包括了“小说”的初始集合。要打开此文件，<code>populate</code> 方法需要 <code>ServletContext</code>，这是一个 Java 映射类型，包含了关于嵌入在 servlet 容器中的 servlet 的所有关键信息。这个文本文件有包含了像下面这样的记录：</p>
<div class="highlight"><pre><span></span><code>Jane Austen!Persuasion
</code></pre></div>

<p>这一行被解析为两部分（作者和标题），由感叹号（<code>!</code>）分隔。然后这个方法创建一个 <code>Novel</code> 实例，设置作者和标题属性，并且将“小说”加到容器中，保存在内存中。</p>
<p><code>Novels</code> 类也有一些实用工具函数，可以将“小说”容器编码为 XML 或 JSON，取决于发出请求的人所要求的格式。默认是 XML 格式，但是也可以请求 JSON 格式。一个轻量级的 XML 转 JSON 包提供了 JSON。下面是关于编码的更多细节。</p>
<h4>例 3：NovelsServlet 类</h4>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">novels</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServlet</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayInputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.beans.XMLEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONObject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.json.XML</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">NovelsServlet</span> <span class="n">extends</span> <span class="n">HttpServlet</span> <span class="p">{</span>
    <span class="n">static</span> <span class="n">final</span> <span class="n">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1</span><span class="n">L</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Novels</span> <span class="n">novels</span><span class="p">;</span> <span class="o">//</span> <span class="n">back</span><span class="o">-</span><span class="n">end</span> <span class="n">bean</span>

    <span class="o">//</span> <span class="n">Executed</span> <span class="n">when</span> <span class="n">servlet</span> <span class="ow">is</span> <span class="n">first</span> <span class="n">loaded</span> <span class="n">into</span> <span class="n">container</span><span class="o">.</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">this</span><span class="o">.</span><span class="n">novels</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Novels</span><span class="p">();</span>
        <span class="n">novels</span><span class="o">.</span><span class="n">setServletContext</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">getServletContext</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">GET</span> <span class="o">/</span><span class="n">novels</span>
    <span class="o">//</span> <span class="n">GET</span> <span class="o">/</span><span class="n">novels</span><span class="err">?</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doGet</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
        <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="err">?</span> <span class="n">null</span> <span class="p">:</span> <span class="n">Integer</span><span class="o">.</span><span class="n">valueOf</span><span class="p">((</span><span class="n">param</span><span class="o">.</span><span class="n">trim</span><span class="p">()));</span>

        <span class="o">//</span> <span class="n">Check</span> <span class="n">user</span> <span class="n">preference</span> <span class="k">for</span> <span class="n">XML</span> <span class="ow">or</span> <span class="n">JSON</span> <span class="n">by</span> <span class="n">inspecting</span>
        <span class="o">//</span> <span class="n">the</span> <span class="n">HTTP</span> <span class="n">headers</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Accept</span> <span class="n">key</span><span class="o">.</span>
        <span class="n">boolean</span> <span class="n">json</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">accept</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getHeader</span><span class="p">(</span><span class="s2">&quot;accept&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">accept</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">accept</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">))</span> <span class="n">json</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>

        <span class="o">//</span> <span class="n">If</span> <span class="n">no</span> <span class="n">query</span> <span class="n">string</span><span class="p">,</span> <span class="n">assume</span> <span class="n">client</span> <span class="n">wants</span> <span class="n">the</span> <span class="n">full</span> <span class="nb">list</span><span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Novel</span><span class="o">&gt;</span> <span class="nb">map</span> <span class="o">=</span> <span class="n">novels</span><span class="o">.</span><span class="n">getConcurrentMap</span><span class="p">();</span>
            <span class="n">Object</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">toArray</span><span class="p">();</span>
            <span class="n">Arrays</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">);</span>

            <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="nb">list</span><span class="p">);</span>        <span class="o">//</span> <span class="n">defaults</span> <span class="n">to</span> <span class="n">Xml</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">novels</span><span class="o">.</span><span class="n">toJson</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span> <span class="o">//</span> <span class="n">Json</span> <span class="n">preferred</span><span class="err">?</span>
            <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="o">//</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="k">return</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">Novel</span><span class="o">.</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">Novel</span> <span class="n">novel</span> <span class="o">=</span> <span class="n">novels</span><span class="o">.</span><span class="n">getConcurrentMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">novel</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span> <span class="n">no</span> <span class="n">such</span> <span class="n">Novel</span>
                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; does not map to a novel.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
                <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span> <span class="o">//</span> <span class="n">requested</span> <span class="n">Novel</span> <span class="n">found</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toJson</span><span class="p">(</span><span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">novel</span><span class="p">)));</span>
                <span class="k">else</span> <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">novel</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">POST</span> <span class="o">/</span><span class="n">novels</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doPost</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">title</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Are</span> <span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">novel</span> <span class="n">present</span><span class="err">?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">author</span> <span class="o">==</span> <span class="n">null</span> <span class="o">||</span> <span class="n">title</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_BAD_REQUEST</span><span class="p">));</span>

        <span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">novel</span><span class="o">.</span>
        <span class="n">Novel</span> <span class="n">n</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Novel</span><span class="p">();</span>
        <span class="n">n</span><span class="o">.</span><span class="n">setAuthor</span><span class="p">(</span><span class="n">author</span><span class="p">);</span>
        <span class="n">n</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Save</span> <span class="n">the</span> <span class="n">ID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">newly</span> <span class="n">created</span> <span class="n">Novel</span><span class="o">.</span>
        <span class="nb">int</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">novels</span><span class="o">.</span><span class="n">addNovel</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Generate</span> <span class="n">the</span> <span class="n">confirmation</span> <span class="n">message</span><span class="o">.</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Novel &quot;</span> <span class="o">+</span> <span class="nb">id</span> <span class="o">+</span> <span class="s2">&quot; created.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">PUT</span> <span class="o">/</span><span class="n">novels</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doPut</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">/</span>\<span class="o">*</span> <span class="n">A</span> <span class="n">workaround</span> <span class="ow">is</span> <span class="n">necessary</span> <span class="k">for</span> <span class="n">a</span> <span class="n">PUT</span> <span class="n">request</span> <span class="n">because</span> <span class="n">Tomcat</span> <span class="n">does</span> <span class="ow">not</span>
 <span class="n">generate</span> <span class="n">a</span> <span class="n">workable</span> <span class="n">parameter</span> <span class="nb">map</span> <span class="k">for</span> <span class="n">the</span> <span class="n">PUT</span> <span class="n">verb</span><span class="o">.</span> \<span class="o">*/</span>
        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
        <span class="n">boolean</span> <span class="n">author</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>

        <span class="o">/</span>\<span class="o">*</span> <span class="n">Let</span> <span class="n">the</span> <span class="n">hack</span> <span class="n">begin</span><span class="o">.</span> \<span class="o">*/</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span>
                <span class="n">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="n">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()));</span>
            <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">readLine</span><span class="p">();</span>
            <span class="o">/</span>\<span class="o">*</span> <span class="n">To</span> <span class="n">simplify</span> <span class="n">the</span> <span class="n">hack</span><span class="p">,</span> <span class="n">assume</span> <span class="n">that</span> <span class="n">the</span> <span class="n">PUT</span> <span class="n">request</span> <span class="n">has</span> <span class="n">exactly</span>
 <span class="n">two</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">the</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">either</span> <span class="n">author</span> <span class="ow">or</span> <span class="n">title</span><span class="o">.</span> <span class="n">Assume</span><span class="p">,</span> <span class="n">further</span><span class="p">,</span>
 <span class="n">that</span> <span class="n">the</span> <span class="nb">id</span> <span class="n">comes</span> <span class="n">first</span><span class="o">.</span> <span class="n">From</span> <span class="n">the</span> <span class="n">client</span> <span class="n">side</span><span class="p">,</span> <span class="n">a</span> <span class="nb">hash</span> <span class="n">character</span>
 <span class="c1"># separates the id and the author/title, e.g.,</span>

 <span class="nb">id</span><span class="o">=</span><span class="mi">33</span><span class="c1">#title=War and Peace</span>
 \<span class="o">*/</span>
            <span class="n">String</span><span class="p">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">);</span>      <span class="o">//</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rest</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">String</span><span class="p">[]</span> <span class="n">parts1</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">);</span> <span class="o">//</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">parts1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">parts1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

            <span class="n">String</span><span class="p">[]</span> <span class="n">parts2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">);</span> <span class="o">//</span> <span class="n">parts2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">key</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">parts2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">))</span> <span class="n">author</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">parts2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">catch</span><span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_INTERNAL_SERVER_ERROR</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">If</span> <span class="n">no</span> <span class="n">key</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">ill</span> <span class="n">formed</span><span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_BAD_REQUEST</span><span class="p">));</span>

        <span class="o">//</span> <span class="n">Look</span> <span class="n">up</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">novel</span><span class="o">.</span>
        <span class="n">Novel</span> <span class="n">p</span> <span class="o">=</span> <span class="n">novels</span><span class="o">.</span><span class="n">getConcurrentMap</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">valueOf</span><span class="p">((</span><span class="n">key</span><span class="o">.</span><span class="n">trim</span><span class="p">())));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span> <span class="o">//</span> <span class="ow">not</span> <span class="n">found</span>
            <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; does not map to a novel.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span> <span class="o">//</span> <span class="n">found</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_BAD_REQUEST</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">editing</span><span class="o">.</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="n">p</span><span class="o">.</span><span class="n">setAuthor</span><span class="p">(</span><span class="n">rest</span><span class="p">);</span>
                <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">rest</span><span class="p">);</span>

                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Novel &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; has been edited.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
                <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">DELETE</span> <span class="o">/</span><span class="n">novels</span><span class="err">?</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doDelete</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
        <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="err">?</span> <span class="n">null</span> <span class="p">:</span> <span class="n">Integer</span><span class="o">.</span><span class="n">valueOf</span><span class="p">((</span><span class="n">param</span><span class="o">.</span><span class="n">trim</span><span class="p">()));</span>
        <span class="o">//</span> <span class="n">Only</span> <span class="n">one</span> <span class="n">Novel</span> <span class="n">can</span> <span class="n">be</span> <span class="n">deleted</span> <span class="n">at</span> <span class="n">a</span> <span class="n">time</span><span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_BAD_REQUEST</span><span class="p">));</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">novels</span><span class="o">.</span><span class="n">getConcurrentMap</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Novel &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; removed.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="n">sendResponse</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">novels</span><span class="o">.</span><span class="n">toXml</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">catch</span><span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_INTERNAL_SERVER_ERROR</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Methods</span> <span class="n">Not</span> <span class="n">Allowed</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doTrace</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_METHOD_NOT_ALLOWED</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doHead</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_METHOD_NOT_ALLOWED</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">doOptions</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_METHOD_NOT_ALLOWED</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">response</span> <span class="n">payload</span> <span class="p">(</span><span class="n">Xml</span> <span class="ow">or</span> <span class="n">Json</span><span class="p">)</span> <span class="n">to</span> <span class="n">the</span> <span class="n">client</span><span class="o">.</span>
    <span class="n">private</span> <span class="n">void</span> <span class="n">sendResponse</span><span class="p">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="n">String</span> <span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">();</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">getBytes</span><span class="p">());</span>
            <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">catch</span><span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="n">Integer</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="n">SC_INTERNAL_SERVER_ERROR</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>上面的 <code>NovelsServlet</code> 类继承了 <code>HttpServlet</code> 类，<code>HttpServlet</code> 类继承了 <code>GenericServlet</code> 类，后者实现了 <code>Servlet</code> 接口：</p>
<div class="highlight"><pre><span></span><code><span class="n">NovelsServlet</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">HttpServlet</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">GenericServlet</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="n">Servlet</span>
</code></pre></div>

<p>从名字可以很清楚的看出来，<code>HttpServlet</code> 是为实现 HTTP(S) 上的 servlet 设计的。这个类提供了以标准 HTTP 请求动词（官方说法，<ruby> 方法 <rt>  methods </rt></ruby>）命名的空方法：</p>
<ul>
<li><code>doPost</code> （Post = 创建）</li>
<li><code>doGet</code> （Get = 读取）</li>
<li><code>doPut</code> （Put = 更新）</li>
<li><code>doDelete</code> （Delete = 删除）</li>
</ul>
<p>其他一些 HTTP 动词也会涉及到。<code>HttpServlet</code> 的子类，比如 <code>NovelsServlet</code>，会重载相关的 <code>do</code> 方法，并且保留其他方法为<ruby> 空 <rt>  no-ops </rt></ruby>。<code>NovelsServlet</code> 重载了七个 <code>do</code> 方法。</p>
<p>每个 <code>HttpServlet</code> 的 CRUD 方法都有两个相同的参数。下面以 <code>doPost</code> 为例：</p>
<div class="highlight"><pre><span></span><code>public void doPost(HttpServletRequest request, HttpServletResponse response) {
</code></pre></div>

<p><code>request</code> 参数是一个 HTTP 请求信息的映射，而 <code>response</code> 提供了一个返回给请求者的输出流。像 <code>doPost</code> 的方法，结构如下：</p>
<ul>
<li>读取 <code>request</code> 信息，采取任何适当的措施生成一个响应。如果该信息丢失或者损坏了，就会生成一个错误。</li>
<li>使用提取的请求信息来执行适当的 CRUD 操作（在本例中，创建一个 <code>Novel</code>），然后使用 <code>response</code> 输出流为请求者编码一个适当的响应。在 <code>doPost</code> 例子中，响应就是已经成功生成一个新“小说”并且添加到容器中的一个确认。当响应被发送后，输出流就关闭了，同时也将连接关闭了。</li>
</ul>
<h3>关于方法重载的更多内容</h3>
<p>HTTP 请求的格式相对比较简单。下面是一个非常熟悉的 HTTP 1.1 的格式，注释由双井号分隔：</p>
<div class="highlight"><pre><span></span><code><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="n">novels</span><span class="w">              </span><span class="err">##</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">line</span>
<span class="k">Host</span><span class="err">:</span><span class="w"> </span><span class="nl">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="w">     </span><span class="err">##</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="k">element</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="nc">text</span><span class="o">/</span><span class="n">plain</span><span class="w">  </span><span class="err">##</span><span class="w"> </span><span class="n">ditto</span>
<span class="p">...</span>
<span class="o">[</span><span class="n">body</span><span class="o">]</span><span class="w">                   </span><span class="err">##</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">PUT</span><span class="w"> </span><span class="k">only</span>
</code></pre></div>

<p>第一行由 HTTP 动词（在本例中是 <code>GET</code>）和以名词（在本例中是 <code>novels</code>）命名目标资源的 URI 开始。报头中包含键-值对，用冒号分隔左面的键和右面的值。报头中的键 <code>Host</code>（大小写敏感）是必须的；主机名 <code>localhost</code> 是当前机器上的本地符号地址，<code>8080</code> 端口是 Tomcat web 服务器上等待 HTTP 请求的默认端口。（默认情况下，Tomcat 在 8443 端口上监听 HTTP 请求。）报头元素可以以任意顺序出现。在这个例子中，<code>Accept-type</code> 报头的值是 MIME 类型 <code>text/plain</code>。</p>
<p>一些请求（特别是 <code>POST</code> 和 <code>PUT</code>）会有报文，而其他请求（特别是 <code>GET</code> 和 <code>DELETE</code>）没有。如果有报文（可能为空），以两个换行符将报头和报文分隔开；HTTP 报文包含一系列键-值对。对于无报文的请求，比如说查询字符串，报头元素就可以用来发送信息。下面是一个用 ID 2 对 <code>/novels</code> 资源的 <code>GET</code> 请求：</p>
<div class="highlight"><pre><span></span><code>GET /novels?id=2
</code></pre></div>

<p>通常来说，查询字符串以问号开始，并且包含一个键-值对，尽管这个键-值可能值为空。</p>
<p>带有 <code>getParameter</code> 和 <code>getParameterMap</code> 等方法的 <code>HttpServlet</code> 很好地回避了有报文和没有报文的 HTTP 请求之前的差异。在“小说”例子中，<code>getParameter</code> 方法用来从 <code>GET</code>、<code>POST</code> 和 <code>DELETE</code> 方法中提取所需的信息。（处理 <code>PUT</code>请求需要更底层的代码，因为 Tomcat 没有提供可以解析 <code>PUT</code> 请求的参数映射。）下面展示了一段在 <code>NovelsServlet</code>中被重载的 <code>doPost</code> 方法：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@Override</span>
<span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">doPost</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">String</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">getParameter</span><span class="p">(</span><span class="ss">&quot;author&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">getParameter</span><span class="p">(</span><span class="ss">&quot;title&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">...</span>
</code></pre></div>

<p>对于没有报文的 <code>DELETE</code> 请求，过程基本是一样的：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@Override</span>
<span class="k">public</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">doDelete</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">   </span><span class="n">String</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">getParameter</span><span class="p">(</span><span class="ss">&quot;id&quot;</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">novel</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">removed</span>
<span class="w">   </span><span class="p">...</span>
</code></pre></div>

<p><code>doGet</code> 方法需要区分 <code>GET</code> 请求的两种方式：一种是“获得所有”，而另一种是“获得某一个”。如果 <code>GET</code> 请求 URL 中包含一个键是一个 ID 的查询字符串，那么这个请求就被解析为“获得某一个”：</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/novels?id=2  ## GET specified
</code></pre></div>

<p>如果没有查询字符串，<code>GET</code> 请求就会被解析为“获得所有”：</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/novels       ## GET all
</code></pre></div>

<h3>一些值得注意的细节</h3>
<p>“小说”服务的设计反映了像 Tomcat 这样基于 Java 的 web 服务器是如何工作的。在启动时，Tomcat 构建一个线程池，从中提取请求处理程序，这种方法称为 “<ruby> 每个请求一个线程 <rt>  one thread per request </rt></ruby>” 模型。现在版本的 Tomcat 使用非阻塞 I/O 来提高个性能。</p>
<p>“小说”服务是作为 <code>NovelsServlet</code> 类的单个实例来执行的，该实例也就维护了一个“小说”集合。相应的，也就会出现竞态条件，比如出现两个请求同时被处理：</p>
<ul>
<li>一个请求向集合中添加一个新“小说”。</li>
<li>另一个请求获得集合中的所有“小说”。</li>
</ul>
<p>这样的结果是不确定的，取决与 <em>读</em> 和 <em>写</em> 的操作是以怎样的顺序进行操作的。为了避免这个问题，“小说”服务使用了线程安全的 <code>ConcurrentMap</code>。这个映射的关键是生成了一个线程安全的 <code>AtomicInteger</code>。下面是相关的代码片段：</p>
<div class="highlight"><pre><span></span><code>public class Novels {
    private ConcurrentMap&lt;Integer, Novel&gt; novels;
    private AtomicInteger mapKey;
    ...
</code></pre></div>

<p>默认情况下，对客户端请求的响应被编码为 XML。为了简单，“小说”程序使用了以前的 <code>XMLEncoder</code> 类；另一个包含更丰富功能的方式是使用 JAX-B 库。代码很简单：</p>
<div class="highlight"><pre><span></span><code><span class="nv">public</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">toXml</span><span class="ss">(</span><span class="nv">Object</span><span class="w"> </span><span class="nv">obj</span><span class="ss">)</span><span class="w"> </span>{<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nv">default</span><span class="w"> </span><span class="nv">encoding</span>
<span class="w">   </span><span class="nv">String</span><span class="w"> </span><span class="nv">xml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>
<span class="w">   </span><span class="nv">try</span><span class="w"> </span>{
<span class="w">      </span><span class="nv">ByteArrayOutputStream</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">ByteArrayOutputStream</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">      </span><span class="nv">XMLEncoder</span><span class="w"> </span><span class="nv">encoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">new</span><span class="w"> </span><span class="nv">XMLEncoder</span><span class="ss">(</span><span class="nv">out</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">      </span><span class="nv">encoder</span>.<span class="nv">writeObject</span><span class="ss">(</span><span class="nv">obj</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">      </span><span class="nv">encoder</span>.<span class="nv">close</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">      </span><span class="nv">xml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">out</span>.<span class="nv">toString</span><span class="ss">()</span><span class="c1">;</span>
<span class="w">   </span>}
<span class="w">   </span><span class="nv">catch</span><span class="ss">(</span><span class="nv">Exception</span><span class="w"> </span><span class="nv">e</span><span class="ss">)</span><span class="w"> </span>{<span class="w"> </span>}
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">xml</span><span class="c1">;</span>
}
</code></pre></div>

<p><code>Object</code> 参数要么是一个有序的“小说” <code>ArraList</code>（用以响应“<ruby> 获得所有 <rt>  get all </rt></ruby>”请求），要么是一个 <code>Novel</code> 实例（用以响应“<ruby> 获得一个 <rt>  get one </rt></ruby>”请求），又或者是一个 <code>String</code>（确认消息）。</p>
<p>如果 HTTP 请求报头指定 JSON 作为所需要的类型，那么 XML 就被转化成 JSON。下面是 <code>NovelsServlet</code> 中的 <code>doGet</code> 方法中的检查：</p>
<div class="highlight"><pre><span></span><code><span class="nv">String</span><span class="w"> </span><span class="nv">accept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">request</span>.<span class="nv">getHeader</span><span class="ss">(</span><span class="s2">&quot;accept&quot;</span><span class="ss">)</span><span class="c1">; // &quot;accept&quot; is case insensitive</span>
<span class="k">if</span><span class="w"> </span><span class="ss">(</span><span class="nv">accept</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nv">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">accept</span>.<span class="nv">contains</span><span class="ss">(</span><span class="s2">&quot;json&quot;</span><span class="ss">))</span><span class="w"> </span><span class="nv">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">true</span><span class="c1">;</span>
</code></pre></div>

<p><code>Novels</code>类中包含了 <code>toJson</code> 方法，可以将 XML 转换成 JSON：</p>
<div class="highlight"><pre><span></span><code><span class="nv">public</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="nv">toJson</span><span class="ss">(</span><span class="nv">String</span><span class="w"> </span><span class="nv">xml</span><span class="ss">)</span><span class="w"> </span>{<span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nv">option</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">requester</span>
<span class="w">   </span><span class="nv">try</span><span class="w"> </span>{
<span class="w">      </span><span class="nv">JSONObject</span><span class="w"> </span><span class="nv">jobt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">XML</span>.<span class="nv">toJSONObject</span><span class="ss">(</span><span class="nv">xml</span><span class="ss">)</span><span class="c1">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nv">jobt</span>.<span class="nv">toString</span><span class="ss">(</span><span class="mi">3</span><span class="ss">)</span><span class="c1">; // 3 is indentation level</span>
<span class="w">   </span>}
<span class="w">   </span><span class="nv">catch</span><span class="ss">(</span><span class="nv">Exception</span><span class="w"> </span><span class="nv">e</span><span class="ss">)</span><span class="w"> </span>{<span class="w"> </span>}
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nv">null</span><span class="c1">;</span>
}
</code></pre></div>

<p><code>NovelsServlet</code>会对各种类型进行错误检查。比如，<code>POST</code> 请求应该包含新“小说”的作者和标题。如果有一个丢了，<code>doPost</code> 方法会抛出一个异常：</p>
<div class="highlight"><pre><span></span><code>if (author == null || title == null)
   throw new RuntimeException(Integer.toString(HttpServletResponse.SC_BAD_REQUEST));
</code></pre></div>

<p><code>SC_BAD_REQUEST</code> 中的 <code>SC</code> 代表的是 <ruby> 状态码 <rt>  status code </rt></ruby>，<code>BAD_REQUEST</code> 的标准 HTTP 数值是 400。如果请求中的 HTTP 动词是 <code>TRACE</code>，会返回一个不同的状态码：</p>
<div class="highlight"><pre><span></span><code>public void doTrace(HttpServletRequest request, HttpServletResponse response) {
   throw new RuntimeException(Integer.toString(HttpServletResponse.SC_METHOD_NOT_ALLOWED));
}
</code></pre></div>

<h3>测试“小说”服务</h3>
<p>用浏览器测试 web 服务会很不顺手。在 CRUD 动词中，现代浏览器只能生成 <code>POST</code>（创建）和 <code>GET</code>（读取）请求。甚至从浏览器发送一个 <code>POST</code> 请求都有点不好办，因为报文需要包含键-值对；这样的测试通常通过 HTML 表单完成。命令行工具，比如说 <a href="https://curl.haxx.se/">curl</a>，是一个更好的选择，这个部分展示的一些 <code>curl</code> 命令，已经包含在我网站的 ZIP 文件中了。</p>
<p>下面是一些测试样例，没有展示相应的输出结果：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl localhost:8080/novels/</span>
<span class="c">% curl localhost:8080/novels?id=1</span>
<span class="c">% curl --header &quot;Accept: application/json&quot; localhost:8080/novels/</span>
</code></pre></div>

<p>第一条命令请求所有“小说”，默认是 XML 编码。第二条命令请求 ID 为 1 的“小说”，XML 编码。最后一条命令通过 <code>application/json</code> 添加了 <code>Accept</code> 报头元素，作为所需要的 MIME 类型。“<ruby> 获得一个 <rt>  get one </rt></ruby>”命令也可以用这个报头。这些请求用了 JSON 而不是 XML 编码作为响应。</p>
<p>下面两条命令在集合中创建了一个新“小说”，并且确认添加了进去：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request POST --data &quot;author=Tolstoy&amp;amp;title=War and Peace&quot; localhost:8080/novels/</span>
<span class="c">% curl localhost:8080/novels?id=4</span>
</code></pre></div>

<p><code>curl</code> 中的 <code>PUT</code> 命令与 <code>POST</code> 命令相似，不同的地方是 <code>PUT</code> 的报文没有使用标准的语法。在 <code>NovelsServlet</code> 中关于 <code>doPut</code> 方法的文档中有详细的介绍，但是简单来说，Tomcat 不会对 <code>PUT</code> 请求生成合适的映射。下面是一个 <code>PUT</code> 命令和确认命令的的例子：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request PUT --data &quot;id=3#title=This is an UPDATE&quot; localhost:8080/novels/</span>
<span class="c">% curl localhost:8080/novels?id=3</span>
</code></pre></div>

<p>第二个命令确认了集合已经更新。</p>
<p>最后，<code>DELETE</code> 命令会正常运行：</p>
<div class="highlight"><pre><span></span><code><span class="c">% curl --request DELETE localhost:8080/novels?id=2</span>
<span class="c">% curl localhost:8080/novels/</span>
</code></pre></div>

<p>这个请求是删除 ID 为 2 的“小说”。第二个命令会显示剩余的“小说”。</p>
<h3>web.xml 配置文件</h3>
<p>尽管官方规定它是可选的，<code>web.xml</code> 配置文件是一个生产级别网站或服务的重要组成部分。这个配置文件可以配置独立于代码的路由、安全性，或者网站或服务的其他功能。“小说”服务的配置通过为该服务的请求分配一个 URL 模式来配置路由：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;xml</span><span class="w"> </span><span class="na">version =</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="w"> </span><span class="na">encoding =</span><span class="w"> </span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;web-app&gt;</span>
<span class="w">   </span><span class="nt">&lt;servlet&gt;</span>
<span class="w">     </span><span class="nt">&lt;servlet-name&gt;</span>novels<span class="nt">&lt;/servlet-name&gt;</span>
<span class="w">     </span><span class="nt">&lt;servlet-class&gt;</span>novels.NovelsServlet<span class="nt">&lt;/servlet-class&gt;</span>
<span class="w">   </span><span class="nt">&lt;/servlet&gt;</span>
<span class="w">   </span><span class="nt">&lt;servlet-mapping&gt;</span>
<span class="w">     </span><span class="nt">&lt;servlet-name&gt;</span>novels<span class="nt">&lt;/servlet-name&gt;</span>
<span class="w">     </span><span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="w">   </span><span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div>

<p><code>servlet-name</code> 元素为 servlet 全名（<code>novels.NovelsServlet</code>）提供了一个缩写（<code>novels</code>），然后这个名字在下面的 <code>servlet-mapping</code> 元素中使用。</p>
<p>回想一下，一个已部署服务的 URL 会在端口号后面有 WAR 文件的文件名：</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/novels/
</code></pre></div>

<p>端口号后斜杠后的 URI，是所请求资源的“路径”，在这个例子中，就是“小说”服务。因此，<code>novels</code> 出现在了第一个单斜杠后。</p>
<p>在 <code>web.xml</code> 文件中，<code>url-patter</code> 被指定为 <code>/*</code>，代表 “以 <code>/novels</code> 为起始的任意路径”。假设 Tomcat 遇到了一个不存在的 URL，像这样：</p>
<div class="highlight"><pre><span></span><code>http://localhost:8080/novels/foobar/
</code></pre></div>

<p><code>web.xml</code> 配置也会指定这个请求被分配到“小说” servlet 中，因为 <code>/*</code> 模式也包含 <code>/foobar</code>。因此，这个不存在的 URL 也会得到像上面合法路径的相同结果。</p>
<p>生产级别的配置文件可能会包含安全相关的信息，包括<ruby> 连接级别 <rt>  wire-level </rt></ruby>和<ruby> 用户角色 <rt>  users-roles </rt></ruby>。即使在这种情况下，配置文件的大小也只会是这个例子中的两到三倍大。</p>
<h3>总结</h3>
<p><code>HttpServlet</code> 是 Java web 技术的核心。像“小说”这样的网站或 web 服务继承了这个类，并且根据需求重载了相应的 <code>do</code> 动词方法。像 Jersay（JAX-RS）或 Restlet 这样的 Restful 框架通过提供定制的 servlet 完成了基本相同的功能，针对框架中的 web 应用程序的请求，这个 servlet 扮演着 HTTP(S) <ruby> 终端 <rt>  endpoint </rt></ruby>的角色。</p>
<p>当然，基于 servlet 的应用程序可以访问 web 应用程序中所需要的任何 Java 库。如果应用程序遵循<ruby> 关注点分离 <rt>  separation-of-concerns </rt></ruby>原则，那么 servlet 代码仍然相当简单：代码会检查请求，如果存在缺陷，就会发出适当的错误；否则，代码会调用所需要的功能（比如，查询数据库，以特定格式为响应编码），然后向请求这发送响应。<code>HttpServletRequest</code> 和 <code>HttpServletReponse</code> 类型使得读取请求和编写响应变得简单。</p>
<p>Java 的 API 可以从非常简单变得相当复杂。如果你需要用 Java 交付一些 Restful 服务的话，我的建议是在做其他事情之前先尝试一下简单的 <code>HttpServlet</code>。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>