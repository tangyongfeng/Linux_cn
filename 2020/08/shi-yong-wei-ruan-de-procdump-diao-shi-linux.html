<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>使用微软的 ProcDump 调试 Linux</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Gaurav Kamathe 用这个微软的开源工具，获取进程信息。 微软越来越心仪 Linux 和开源，这并不是什么秘密。在过去几年中，该公司稳步地 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2020/08/shi-yong-wei-ruan-de-procdump-diao-shi-linux.html" rel="bookmark"
           title="Permalink to 使用微软的 ProcDump 调试 Linux">使用微软的 ProcDump 调试 Linux</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-08-20T09:57:30+02:00">
                Published: Thu 20 August 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Gaurav Kamathe</p>
<blockquote>
<p>用这个微软的开源工具，获取进程信息。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202008/20/095646k5wz7cd11vyc7lhr.jpg"></p>
<p>微软越来越心仪 Linux 和开源，这并不是什么秘密。在过去几年中，该公司稳步地增加了对开源的贡献，包括将其部分软件和工具移植到 Linux。2018 年底，微软<a href="https://www.zdnet.com/article/microsoft-working-on-porting-sysinternals-to-linux/">宣布</a>将其 <a href="https://docs.microsoft.com/en-us/sysinternals/">Sysinternals</a> 的部分工具以开源的方式移植到 Linux，<a href="https://github.com/Microsoft/ProcDump-for-Linux">Linux 版的 ProcDump</a>是其中的第一个。</p>
<p>如果你在 Windows 上从事过调试或故障排除工作，你可能听说过 Sysinternals，它是一个“瑞士军刀”工具集，可以帮助系统管理员、开发人员和 IT 安全专家监控和排除 Windows 环境的故障。</p>
<p>Sysinternals 最受欢迎的工具之一是 <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a>。顾名思义，它用于将正在运行的进程的内存转储到磁盘上的一个核心文件中。然后可以用调试器对这个核心文件进行分析，了解转储时进程的状态。因为之前用过 Sysinternals，所以我很想试试 ProcDump 的 Linux 移植版。</p>
<h3>开始使用 Linux 上的 ProcDump</h3>
<p>要试用 Linux 上的 ProcDump，你需要下载该工具并编译它。（我使用的是 Red Hat Enterprise Linux，尽管这些步骤在其他 Linux 发行版上应该是一样的）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/etc/redhat-release
Red<span class="w"> </span>Hat<span class="w"> </span>Enterprise<span class="w"> </span>Linux<span class="w"> </span>release<span class="w"> </span><span class="m">8</span>.2<span class="w"> </span><span class="o">(</span>Ootpa<span class="o">)</span>
$
$<span class="w"> </span>uname<span class="w"> </span>-r
<span class="m">4</span>.18.0-193.el8.x86_64
$
</code></pre></div>

<p>首先，克隆 Linux 版 ProcDump 的版本库。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/microsoft/ProcDump-for-Linux.git
Cloning<span class="w"> </span>into<span class="w"> </span><span class="s1">&#39;ProcDump-for-Linux&#39;</span>...
remote:<span class="w"> </span>Enumerating<span class="w"> </span>objects:<span class="w"> </span><span class="m">40</span>,<span class="w"> </span><span class="k">done</span>.
remote:<span class="w"> </span>Counting<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">40</span>/40<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
remote:<span class="w"> </span>Compressing<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">33</span>/33<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
remote:<span class="w"> </span>Total<span class="w"> </span><span class="m">414</span><span class="w"> </span><span class="o">(</span>delta<span class="w"> </span><span class="m">14</span><span class="o">)</span>,<span class="w"> </span>reused<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="o">(</span>delta<span class="w"> </span><span class="m">6</span><span class="o">)</span>,<span class="w"> </span>pack-reused<span class="w"> </span><span class="m">374</span>
Receiving<span class="w"> </span>objects:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">414</span>/414<span class="o">)</span>,<span class="w"> </span><span class="m">335</span>.28<span class="w"> </span>KiB<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">265</span>.00<span class="w"> </span>KiB/s,<span class="w"> </span><span class="k">done</span>.
Resolving<span class="w"> </span>deltas:<span class="w"> </span><span class="m">100</span>%<span class="w"> </span><span class="o">(</span><span class="m">232</span>/232<span class="o">)</span>,<span class="w"> </span><span class="k">done</span>.
$
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>ProcDump-for-Linux/
$
$<span class="w"> </span>ls
azure-pipelines.yml<span class="w">  </span>CONTRIBUTING.md<span class="w">  </span>docs<span class="w">     </span>INSTALL.md<span class="w">  </span>Makefile<span class="w">    </span>procdump.gif<span class="w">  </span>src
CODE_OF_CONDUCT.md<span class="w">   </span>dist<span class="w">             </span>include<span class="w">  </span>LICENSE<span class="w">     </span>procdump.1<span class="w">  </span>README.md<span class="w">     </span>tests
$
</code></pre></div>

<p>接下来，使用 <code>make</code> 构建程序。它能准确地输出编译源文件所需的 <a href="https://gcc.gnu.org/">GCC</a> 命令行参数。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>make
rm<span class="w"> </span>-rf<span class="w"> </span>obj
rm<span class="w"> </span>-rf<span class="w"> </span>bin
rm<span class="w"> </span>-rf<span class="w"> </span>/root/ProcDump-for-Linux/pkgbuild
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/Logging.o<span class="w"> </span>src/Logging.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/Events.o<span class="w"> </span>src/Events.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/ProcDumpConfiguration.o<span class="w"> </span>src/ProcDumpConfiguration.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/Handle.o<span class="w"> </span>src/Handle.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/Process.o<span class="w"> </span>src/Process.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/Procdump.o<span class="w"> </span>src/Procdump.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/TriggerThreadProcs.o<span class="w"> </span>src/TriggerThreadProcs.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/CoreDumpWriter.o<span class="w"> </span>src/CoreDumpWriter.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-o<span class="w"> </span>bin/procdump<span class="w"> </span>obj/Logging.o<span class="w"> </span>obj/Events.o<span class="w"> </span>obj/ProcDumpConfiguration.o<span class="w"> </span>obj/Handle.o<span class="w"> </span>obj/Process.o<span class="w"> </span>obj/Procdump.o<span class="w"> </span>obj/TriggerThreadProcs.o<span class="w"> </span>obj/CoreDumpWriter.o<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-c<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>obj/ProcDumpTestApplication.o<span class="w"> </span>tests/integration/ProcDumpTestApplication.c<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
gcc<span class="w"> </span>-o<span class="w"> </span>bin/ProcDumpTestApplication<span class="w"> </span>obj/ProcDumpTestApplication.o<span class="w"> </span>-Wall<span class="w"> </span>-I<span class="w"> </span>./include<span class="w"> </span>-pthread<span class="w"> </span>-std<span class="o">=</span>gnu99
$
</code></pre></div>

<p>编译过程中会创建两个新的目录。第一个是 <code>obj/</code> 目录，存放编译期间创建的对象文件。第二个（也是更重要的）目录是 <code>bin/</code>，它是存储编译出的 <code>procdump</code> 程序的地方。它还会编译另一个名为 <code>ProcDumpTestApplication</code> 的测试二进制文件：</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="n">obj</span><span class="o">/</span>
<span class="n">CoreDumpWriter</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">Handle</span><span class="p">.</span><span class="n">o</span><span class="w">   </span><span class="n">ProcDumpConfiguration</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">ProcDumpTestApplication</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">TriggerThreadProcs</span><span class="p">.</span><span class="n">o</span>
<span class="n">Events</span><span class="p">.</span><span class="n">o</span><span class="w">          </span><span class="n">Logging</span><span class="p">.</span><span class="n">o</span><span class="w">  </span><span class="n">Procdump</span><span class="p">.</span><span class="n">o</span><span class="w">               </span><span class="n">Process</span><span class="p">.</span><span class="n">o</span>
<span class="err">$</span>
<span class="err">$</span>
<span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span>
<span class="n">procdump</span><span class="w">  </span><span class="n">ProcDumpTestApplication</span>
<span class="err">$</span>
<span class="err">$</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">procdump</span>
<span class="n">bin</span><span class="o">/</span><span class="nl">procdump</span><span class="p">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">executable</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="p">,</span><span class="w"> </span><span class="n">interpreter</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">3.2.0</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="o">[</span><span class="n">sha1</span><span class="o">]=</span><span class="mf">6e8827</span><span class="n">db64835ea0d1f0941ac3ecff9ee8c06e6b</span><span class="p">,</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">debug_info</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">stripped</span>
<span class="err">$</span>
<span class="err">$</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">ProcDumpTestApplication</span>
<span class="n">bin</span><span class="o">/</span><span class="nl">ProcDumpTestApplication</span><span class="p">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">executable</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="p">,</span><span class="w"> </span><span class="n">interpreter</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">3.2.0</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="o">[</span><span class="n">sha1</span><span class="o">]=</span><span class="n">c8fd86f53c07df142e52518815b2573d1c690e4e</span><span class="p">,</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">debug_info</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">stripped</span>
<span class="err">$</span>
</code></pre></div>

<p>在此情况下，每次运行 <code>procdump</code> 实用程序时，你都必须移动到 <code>bin/</code> 文件夹中。要使它在系统中的任何地方都可以使用，运行 <code>make install</code>。这将这个二进制文件复制到通常的 <code>bin/</code> 目录中，它是你的 shell <code>$PATH</code> 的一部分：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>which<span class="w"> </span>procdump
/usr/bin/which:<span class="w"> </span>no<span class="w"> </span>procdump<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">(</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin<span class="o">)</span>
$
$<span class="w"> </span>make<span class="w"> </span>install
mkdir<span class="w"> </span>-p<span class="w"> </span>//usr/bin
cp<span class="w"> </span>bin/procdump<span class="w"> </span>//usr/bin
mkdir<span class="w"> </span>-p<span class="w"> </span>//usr/share/man/man1
cp<span class="w"> </span>procdump.1<span class="w"> </span>//usr/share/man/man1
$
$<span class="w"> </span>which<span class="w"> </span>procdump
/usr/bin/procdump
$
</code></pre></div>

<p>安装时，ProcDump 提供了一个手册页，你可以用 <code>man procdump</code> 访问：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>man<span class="w"> </span>procdump
$
</code></pre></div>

<h3>运行 ProcDump</h3>
<p>要转储一个进程的内存，你需要向 ProcDump 提供它的进程 ID（PID）。你可以使用机器上任何正在运行的程序或守护进程。在这个例子中，我将使用一个永远循环的小 C 程序。编译程序并运行它（要退出程序，按 <code>Ctrl+C</code>，如果程序在后台运行，则使用 <code>kill</code> 命令并输入 PID）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>progxyz.c
<span class="c1">#include &lt;stdio.h&gt;</span>

int<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="o">(</span><span class="p">;;</span><span class="o">)</span>
<span class="w">        </span><span class="o">{</span>
<span class="w">                </span>printf<span class="o">(</span><span class="s2">&quot;.&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="w">                </span>sleep<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="p">;</span>
<span class="w">        </span><span class="o">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="o">}</span>
$
$<span class="w"> </span>gcc<span class="w"> </span>progxyz.c<span class="w"> </span>-o<span class="w"> </span>progxyz
$
$<span class="w"> </span>./progxyz<span class="w"> </span><span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">350498</span>
$
</code></pre></div>

<p>运行该程序，你可以使用 <code>pgrep</code> 或 <code>ps</code> 找到它的 PID。记下 PID：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pgrep<span class="w"> </span>progxyz
<span class="m">350498</span>
$
$<span class="w"> </span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>progxyz
root<span class="w">      </span><span class="m">350498</span><span class="w">  </span><span class="m">345445</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">03</span>:29<span class="w"> </span>pts/1<span class="w">    </span><span class="m">00</span>:00:00<span class="w"> </span>./progxyz
root<span class="w">      </span><span class="m">350508</span><span class="w">  </span><span class="m">347350</span><span class="w">  </span><span class="m">0</span><span class="w"> </span><span class="m">03</span>:29<span class="w"> </span>pts/0<span class="w">    </span><span class="m">00</span>:00:00<span class="w"> </span>grep<span class="w"> </span>--color<span class="o">=</span>auto<span class="w"> </span>progxyz
$
</code></pre></div>

<p>当测试进程正在运行时，调用 <code>procdump</code> 并提供 PID。下面的输出表明了该进程的名称和 PID，并报告它生成了一个核心转储文件，并显示其文件名：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>procdump<span class="w"> </span>-p<span class="w"> </span><span class="m">350498</span>

ProcDump<span class="w"> </span>v1.1.1<span class="w"> </span>-<span class="w"> </span>Sysinternals<span class="w"> </span>process<span class="w"> </span>dump<span class="w"> </span>utility
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2020</span><span class="w"> </span>Microsoft<span class="w"> </span>Corporation.<span class="w"> </span>All<span class="w"> </span>rights<span class="w"> </span>reserved.<span class="w"> </span>Licensed<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>MIT<span class="w"> </span>license.
Mark<span class="w"> </span>Russinovich,<span class="w"> </span>Mario<span class="w"> </span>Hewardt,<span class="w"> </span>John<span class="w"> </span>Salem,<span class="w"> </span>Javid<span class="w"> </span>Habibi
Monitors<span class="w"> </span>a<span class="w"> </span>process<span class="w"> </span>and<span class="w"> </span>writes<span class="w"> </span>a<span class="w"> </span>dump<span class="w"> </span>file<span class="w"> </span>when<span class="w"> </span>the<span class="w"> </span>process<span class="w"> </span>exceeds<span class="w"> </span>the
specified<span class="w"> </span>criteria.

Process:<span class="w">                </span>progxyz<span class="w"> </span><span class="o">(</span><span class="m">350498</span><span class="o">)</span>
CPU<span class="w"> </span>Threshold:<span class="w">          </span>n/a
Commit<span class="w"> </span>Threshold:<span class="w">       </span>n/a
Polling<span class="w"> </span>interval<span class="w"> </span><span class="o">(</span>ms<span class="o">)</span>:<span class="w">  </span><span class="m">1000</span>
Threshold<span class="w"> </span><span class="o">(</span>s<span class="o">)</span>:<span class="w">  </span><span class="m">10</span>
Number<span class="w"> </span>of<span class="w"> </span>Dumps:<span class="w">        </span><span class="m">1</span>

Press<span class="w"> </span>Ctrl-C<span class="w"> </span>to<span class="w"> </span>end<span class="w"> </span>monitoring<span class="w"> </span>without<span class="w"> </span>terminating<span class="w"> </span>the<span class="w"> </span>process.

<span class="o">[</span><span class="m">03</span>:30:00<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Timed:
<span class="o">[</span><span class="m">03</span>:30:01<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Core<span class="w"> </span>dump<span class="w"> </span><span class="m">0</span><span class="w"> </span>generated:<span class="w"> </span>progxyz_time_2020-06-24_03:30:00.350498
$
</code></pre></div>

<p>列出当前目录的内容，你应该可以看到新的核心文件。文件名与 <code>procdump</code> 命令显示的文件名一致，日期、时间、PID 都会附加在文件名上：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>progxyz_time_2020-06-24_03<span class="se">\:</span><span class="m">30</span><span class="se">\:</span><span class="m">00</span>.350498
-rw-r--r--.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">356848</span><span class="w"> </span>Jun<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">03</span>:30<span class="w"> </span>progxyz_time_2020-06-24_03:30:00.350498
$
$<span class="w"> </span>file<span class="w"> </span>progxyz_time_2020-06-24_03<span class="se">\:</span><span class="m">30</span><span class="se">\:</span><span class="m">00</span>.350498
progxyz_time_2020-06-24_03:30:00.350498:<span class="w"> </span>ELF<span class="w"> </span><span class="m">64</span>-bit<span class="w"> </span>LSB<span class="w"> </span>core<span class="w"> </span>file,<span class="w"> </span>x86-64,<span class="w"> </span>version<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>SYSV<span class="o">)</span>,<span class="w"> </span>SVR4-style,<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;./progxyz&#39;</span>,<span class="w"> </span>real<span class="w"> </span>uid:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>effective<span class="w"> </span>uid:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>real<span class="w"> </span>gid:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>effective<span class="w"> </span>gid:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>execfn:<span class="w"> </span><span class="s1">&#39;./progxyz&#39;</span>,<span class="w"> </span>platform:<span class="w"> </span><span class="s1">&#39;x86_64&#39;</span>
$
</code></pre></div>

<h3>用 GNU 项目调试器分析核心文件。</h3>
<p>要查看是否可以读取该转储文件，调用 <a href="https://www.gnu.org/software/gdb/">GNU 项目调试器</a>（<code>gdb</code>）。记得提供测试二进制文件的路径，这样你就可以看到堆栈上所有的函数名。在这里，<code>bt</code>（回溯）表明，当转储被采集时，<code>sleep()</code> 函数正在执行：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gdb<span class="w"> </span>-q<span class="w"> </span>./progxyz<span class="w"> </span>./progxyz_time_2020-06-24_03<span class="se">\:</span><span class="m">30</span><span class="se">\:</span><span class="m">00</span>.350498
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>./progxyz...<span class="o">(</span>no<span class="w"> </span>debugging<span class="w"> </span>symbols<span class="w"> </span>found<span class="o">)</span>...done.
<span class="o">[</span>New<span class="w"> </span>LWP<span class="w"> </span><span class="m">350498</span><span class="o">]</span>
Core<span class="w"> </span>was<span class="w"> </span>generated<span class="w"> </span>by<span class="w"> </span><span class="sb">`</span>./progxyz<span class="err">&#39;</span>.
<span class="c1">#0  0x00007fb6947e9208 in nanosleep () from /lib64/libc.so.6</span>
Missing<span class="w"> </span>separate<span class="w"> </span>debuginfos,<span class="w"> </span>use:<span class="w"> </span>yum<span class="w"> </span>debuginfo-install<span class="w"> </span>glibc-2.28-101.el8.x86_64
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  0x00007fb6947e9208 in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007fb6947e913e in sleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x00000000004005f3 in main ()</span>
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></div>

<h3>gcore 怎么样？</h3>
<p>Linux 用户会很快指出，Linux 已经有一个叫 <code>gcore</code> 的命令，大多数 Linux 发行版都有这个命令，它的作用和 ProcDump 完全一样。你说的对。如果你从来没有使用过它，可以尝试用 <code>gcore</code> 来转储一个进程的核心。再次运行测试程序，然后运行 <code>gcore</code>，并提供 PID 作为参数：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./progxyz<span class="w"> </span><span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">350664</span>
$
$
$<span class="w"> </span>pgrep<span class="w"> </span>progxyz
<span class="m">350664</span>
$
$
$<span class="w"> </span>gcore<span class="w"> </span><span class="m">350664</span>
0x00007fefd3be2208<span class="w"> </span><span class="k">in</span><span class="w"> </span>nanosleep<span class="w"> </span><span class="o">()</span><span class="w"> </span>from<span class="w"> </span>/lib64/libc.so.6
Saved<span class="w"> </span>corefile<span class="w"> </span>core.350664
<span class="o">[</span>Inferior<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>process<span class="w"> </span><span class="m">350664</span><span class="o">)</span><span class="w"> </span>detached<span class="o">]</span>
$
</code></pre></div>

<p><code>gcore</code> 打印一条消息，说它已将核心文件保存到一个特定的文件中。检查当前目录，找到这个核心文件，然后再次使用 <code>gdb</code> 加载它：</p>
<div class="highlight"><pre><span></span><code><span class="p">$</span>
<span class="p">$</span><span class="w"> </span><span class="nv">ls</span><span class="w"> </span><span class="o">-</span><span class="nv">l</span><span class="w">  </span><span class="nv">core</span><span class="o">.</span><span class="mi">350664</span>
<span class="o">-</span><span class="nv">rw</span><span class="o">-</span><span class="nv">r</span><span class="o">--</span><span class="nv">r</span><span class="o">--.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">root</span><span class="w"> </span><span class="nv">root</span><span class="w"> </span><span class="mi">356848</span><span class="w"> </span><span class="nv">Jun</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">03</span><span class="o">:</span><span class="mi">34</span><span class="w"> </span><span class="nv">core</span><span class="o">.</span><span class="mi">350664</span>
<span class="p">$</span>
<span class="p">$</span>
<span class="p">$</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">core</span><span class="o">.</span><span class="mi">350664</span>
<span class="nv">core</span><span class="o">.</span><span class="mi">350664</span><span class="o">:</span><span class="w"> </span><span class="nv">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">LSB</span><span class="w"> </span><span class="nv">core</span><span class="w"> </span><span class="nv">file</span><span class="p">,</span><span class="w"> </span><span class="nv">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="nv">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nv">SYSV</span><span class="p">),</span><span class="w"> </span><span class="nv">SVR4</span><span class="o">-</span><span class="nv">style</span><span class="p">,</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">&#39;./</span><span class="nv">progxyz</span><span class="o">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">real</span><span class="w"> </span><span class="nv">uid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">effective</span><span class="w"> </span><span class="nv">uid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">real</span><span class="w"> </span><span class="nv">gid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">effective</span><span class="w"> </span><span class="nv">gid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">execfn</span><span class="o">:</span><span class="w"> </span><span class="o">&#39;./</span><span class="nv">progxyz</span><span class="o">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">platform</span><span class="o">:</span><span class="w"> </span><span class="o">&#39;</span><span class="nv">x86_64</span><span class="o">&#39;</span>
<span class="p">$</span>
<span class="p">$</span><span class="w"> </span><span class="nv">gdb</span><span class="w"> </span><span class="o">-</span><span class="nv">q</span><span class="w"> </span><span class="o">./</span><span class="nv">progxyz</span><span class="w"> </span><span class="o">./</span><span class="nv">core</span><span class="o">.</span><span class="mi">350664</span>
<span class="nv">Reading</span><span class="w"> </span><span class="nv">symbols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">./</span><span class="nv">progxyz</span><span class="o">...</span><span class="p">(</span><span class="nv">no</span><span class="w"> </span><span class="nv">debugging</span><span class="w"> </span><span class="nv">symbols</span><span class="w"> </span><span class="nv">found</span><span class="p">)</span><span class="o">...</span><span class="no">done</span><span class="o">.</span>
<span class="p">[</span><span class="nv">New</span><span class="w"> </span><span class="nv">LWP</span><span class="w"> </span><span class="mi">350664</span><span class="p">]</span>
<span class="nv">Core</span><span class="w"> </span><span class="nv">was</span><span class="w"> </span><span class="nv">generated</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span>`<span class="o">./</span><span class="nv">progxyz</span><span class="o">&#39;.</span>
<span class="o">#</span><span class="mi">0</span><span class="w">  </span><span class="mi">0</span><span class="nv">x00007fefd3be2208</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nf">nanosleep</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">/</span><span class="nv">lib64</span><span class="o">/</span><span class="nv">libc</span><span class="o">.</span><span class="nv">so</span><span class="o">.</span><span class="mi">6</span>
<span class="nv">Missing</span><span class="w"> </span><span class="nv">separate</span><span class="w"> </span><span class="nv">debuginfos</span><span class="p">,</span><span class="w"> </span><span class="nv">use</span><span class="o">:</span><span class="w"> </span><span class="nv">yum</span><span class="w"> </span><span class="nv">debuginfo</span><span class="o">-</span><span class="nv">install</span><span class="w"> </span><span class="nv">glibc</span><span class="o">-</span><span class="mf">2.28</span><span class="o">-</span><span class="mi">101</span><span class="o">.</span><span class="nv">el8</span><span class="o">.</span><span class="nf">x86_64</span>
<span class="p">(</span><span class="nv">gdb</span><span class="p">)</span><span class="w"> </span><span class="nv">bt</span>
<span class="o">#</span><span class="mi">0</span><span class="w">  </span><span class="mi">0</span><span class="nv">x00007fefd3be2208</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nf">nanosleep</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">/</span><span class="nv">lib64</span><span class="o">/</span><span class="nv">libc</span><span class="o">.</span><span class="nv">so</span><span class="o">.</span><span class="mi">6</span>
<span class="o">#</span><span class="mi">1</span><span class="w">  </span><span class="mi">0</span><span class="nv">x00007fefd3be213e</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nf">sleep</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">/</span><span class="nv">lib64</span><span class="o">/</span><span class="nv">libc</span><span class="o">.</span><span class="nv">so</span><span class="o">.</span><span class="mi">6</span>
<span class="o">#</span><span class="mi">2</span><span class="w">  </span><span class="mi">0</span><span class="nv">x00000000004005f3</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">()</span>
<span class="p">(</span><span class="nv">gdb</span><span class="p">)</span><span class="w"> </span><span class="nv">q</span>
<span class="p">$</span>
</code></pre></div>

<p>为了使 <code>gcore</code> 可以工作，你需要确保以下设置到位。首先，确保为核心文件设置了 <code>ulimit</code>，如果设置为 <code>0</code>，核心文件将不会被生成。第二，确保 <code>/proc/sys/kernel/core_pattern</code> 有正确的设置来指定核心模式：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">ulimit</span><span class="w"> </span>-c
unlimited
$
</code></pre></div>

<h3>你应该使用 ProcDump 还是 gcore？</h3>
<p>有几种情况下，你可能更喜欢使用 ProcDump 而不是 gcore，ProcDump 有一些内置的功能，在一些情况下可能很有用。</p>
<h4>等待测试二进制文件的执行</h4>
<p>无论是使用 ProcDump 还是 gcore，测试进程必须被执行并处于运行状态，这样才能提供一个 PID 来生成核心文件。但 ProcDump 有一个功能，就是等待特定的二进制文件运行，一旦发现运行的测试二进制文件与给定的名称相匹配，它就会为该测试二进制文件生成一个核心文件。它可以使用 <code>-w</code> 参数和程序名称而不是 PID 来启用。这个功能在测试程序快速退出的情况下很有用。</p>
<p>下面是它的工作原理。在这个例子中，没有名为 <code>progxyz</code> 的进程在运行：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pgrep<span class="w"> </span>progxyz
$
</code></pre></div>

<p>用 <code>-w</code> 参数调用 <code>procdump</code>，让它保持等待。在另一个终端，调用测试二进制 <code>progxyz</code>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>procdump<span class="w"> </span>-w<span class="w"> </span>progxyz

ProcDump<span class="w"> </span>v1.1.1<span class="w"> </span>-<span class="w"> </span>Sysinternals<span class="w"> </span>process<span class="w"> </span>dump<span class="w"> </span>utility
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2020</span><span class="w"> </span>Microsoft<span class="w"> </span>Corporation.<span class="w"> </span>All<span class="w"> </span>rights<span class="w"> </span>reserved.<span class="w"> </span>Licensed<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>MIT<span class="w"> </span>license.
Mark<span class="w"> </span>Russinovich,<span class="w"> </span>Mario<span class="w"> </span>Hewardt,<span class="w"> </span>John<span class="w"> </span>Salem,<span class="w"> </span>Javid<span class="w"> </span>Habibi
Monitors<span class="w"> </span>a<span class="w"> </span>process<span class="w"> </span>and<span class="w"> </span>writes<span class="w"> </span>a<span class="w"> </span>dump<span class="w"> </span>file<span class="w"> </span>when<span class="w"> </span>the<span class="w"> </span>process<span class="w"> </span>exceeds<span class="w"> </span>the
specified<span class="w"> </span>criteria.

Process:<span class="w">                </span>progxyz<span class="w"> </span><span class="o">(</span>pending<span class="o">)</span>
CPU<span class="w"> </span>Threshold:<span class="w">          </span>n/a
Commit<span class="w"> </span>Threshold:<span class="w">       </span>n/a
Polling<span class="w"> </span>interval<span class="w"> </span><span class="o">(</span>ms<span class="o">)</span>:<span class="w">  </span><span class="m">1000</span>
Threshold<span class="w"> </span><span class="o">(</span>s<span class="o">)</span>:<span class="w">  </span><span class="m">10</span>
Number<span class="w"> </span>of<span class="w"> </span>Dumps:<span class="w">        </span><span class="m">1</span>

Press<span class="w"> </span>Ctrl-C<span class="w"> </span>to<span class="w"> </span>end<span class="w"> </span>monitoring<span class="w"> </span>without<span class="w"> </span>terminating<span class="w"> </span>the<span class="w"> </span>process.

<span class="o">[</span><span class="m">03</span>:39:23<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>process<span class="w"> </span><span class="s1">&#39;progxyz&#39;</span><span class="w"> </span>to<span class="w"> </span>launch...
</code></pre></div>

<p>然后，从另一个终端调用测试二进制 <code>progxyz</code>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./progxyz<span class="w"> </span><span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">350951</span>
$
</code></pre></div>

<p>ProcDump 立即检测到该二进制正在运行，并转储这个二进制的核心文件：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="mi">03</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mi">23</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">INFO</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nv">Waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">process</span><span class="w"> </span><span class="o">&#39;</span><span class="nv">progxyz</span><span class="o">&#39;</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">launch</span><span class="o">...</span>
<span class="p">[</span><span class="mi">03</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">22</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">INFO</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nv">Found</span><span class="w"> </span><span class="nv">process</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">PID</span><span class="w"> </span><span class="mi">350951</span>
<span class="p">[</span><span class="mi">03</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">22</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">INFO</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nv">Timed</span><span class="o">:</span>
<span class="p">[</span><span class="mi">03</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">23</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">INFO</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nv">Core</span><span class="w"> </span><span class="nv">dump</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">generated</span><span class="o">:</span><span class="w"> </span><span class="nv">progxyz_time_2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span><span class="nv">_03</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">22.350951</span>
<span class="p">$</span>

<span class="p">$</span><span class="w"> </span><span class="nv">ls</span><span class="w"> </span><span class="o">-</span><span class="nv">l</span><span class="w"> </span><span class="nv">progxyz_time_2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span><span class="nv">_03</span>\<span class="o">:</span><span class="mi">43</span>\<span class="o">:</span><span class="mf">22.350951</span>
<span class="o">-</span><span class="nv">rw</span><span class="o">-</span><span class="nv">r</span><span class="o">--</span><span class="nv">r</span><span class="o">--.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">root</span><span class="w"> </span><span class="nv">root</span><span class="w"> </span><span class="mi">356848</span><span class="w"> </span><span class="nv">Jun</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">03</span><span class="o">:</span><span class="mi">43</span><span class="w"> </span><span class="nv">progxyz_time_2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span><span class="nv">_03</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">22.350951</span>
<span class="p">$</span>
<span class="p">$</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="nv">progxyz_time_2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span><span class="nv">_03</span>\<span class="o">:</span><span class="mi">43</span>\<span class="o">:</span><span class="mf">22.350951</span>
<span class="nv">progxyz_time_2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">24</span><span class="nv">_03</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">22.350951</span><span class="o">:</span><span class="w"> </span><span class="nv">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nv">bit</span><span class="w"> </span><span class="nv">LSB</span><span class="w"> </span><span class="nv">core</span><span class="w"> </span><span class="nv">file</span><span class="p">,</span><span class="w"> </span><span class="nv">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="nv">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nv">SYSV</span><span class="p">),</span><span class="w"> </span><span class="nv">SVR4</span><span class="o">-</span><span class="nv">style</span><span class="p">,</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">&#39;./</span><span class="nv">progxyz</span><span class="o">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">real</span><span class="w"> </span><span class="nv">uid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">effective</span><span class="w"> </span><span class="nv">uid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">real</span><span class="w"> </span><span class="nv">gid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">effective</span><span class="w"> </span><span class="nv">gid</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">execfn</span><span class="o">:</span><span class="w"> </span><span class="o">&#39;./</span><span class="nv">progxyz</span><span class="o">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">platform</span><span class="o">:</span><span class="w"> </span><span class="o">&#39;</span><span class="nv">x86_64</span><span class="o">&#39;</span>
<span class="p">$</span>
</code></pre></div>

<h4>多个核心转储</h4>
<p>另一个重要的 ProcDump 功能是，你可以通过使用命令行参数 <code>-n &lt;count&gt;</code> 指定要生成多少个核心文件。核心转储之间的默认时间间隔是 <code>10</code> 秒，但你可以使用 <code>-s &lt;sec&gt;</code> 参数修改。这个例子使用 ProcDump 对测试二进制文件进行了三次核心转储：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./progxyz<span class="w"> </span><span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="m">351014</span>
$
$<span class="w"> </span>procdump<span class="w"> </span>-n<span class="w"> </span><span class="m">3</span><span class="w"> </span>-p<span class="w"> </span><span class="m">351014</span>

ProcDump<span class="w"> </span>v1.1.1<span class="w"> </span>-<span class="w"> </span>Sysinternals<span class="w"> </span>process<span class="w"> </span>dump<span class="w"> </span>utility
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2020</span><span class="w"> </span>Microsoft<span class="w"> </span>Corporation.<span class="w"> </span>All<span class="w"> </span>rights<span class="w"> </span>reserved.<span class="w"> </span>Licensed<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>MIT<span class="w"> </span>license.
Mark<span class="w"> </span>Russinovich,<span class="w"> </span>Mario<span class="w"> </span>Hewardt,<span class="w"> </span>John<span class="w"> </span>Salem,<span class="w"> </span>Javid<span class="w"> </span>Habibi
Monitors<span class="w"> </span>a<span class="w"> </span>process<span class="w"> </span>and<span class="w"> </span>writes<span class="w"> </span>a<span class="w"> </span>dump<span class="w"> </span>file<span class="w"> </span>when<span class="w"> </span>the<span class="w"> </span>process<span class="w"> </span>exceeds<span class="w"> </span>the
specified<span class="w"> </span>criteria.

Process:<span class="w">                </span>progxyz<span class="w"> </span><span class="o">(</span><span class="m">351014</span><span class="o">)</span>
CPU<span class="w"> </span>Threshold:<span class="w">          </span>n/a
Commit<span class="w"> </span>Threshold:<span class="w">       </span>n/a
Polling<span class="w"> </span>interval<span class="w"> </span><span class="o">(</span>ms<span class="o">)</span>:<span class="w">  </span><span class="m">1000</span>
Threshold<span class="w"> </span><span class="o">(</span>s<span class="o">)</span>:<span class="w">  </span><span class="m">10</span>
Number<span class="w"> </span>of<span class="w"> </span>Dumps:<span class="w">        </span><span class="m">3</span>

Press<span class="w"> </span>Ctrl-C<span class="w"> </span>to<span class="w"> </span>end<span class="w"> </span>monitoring<span class="w"> </span>without<span class="w"> </span>terminating<span class="w"> </span>the<span class="w"> </span>process.

<span class="o">[</span><span class="m">03</span>:45:20<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Timed:
<span class="o">[</span><span class="m">03</span>:45:21<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Core<span class="w"> </span>dump<span class="w"> </span><span class="m">0</span><span class="w"> </span>generated:<span class="w"> </span>progxyz_time_2020-06-24_03:45:20.351014
<span class="o">[</span><span class="m">03</span>:45:31<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Timed:
<span class="o">[</span><span class="m">03</span>:45:32<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Core<span class="w"> </span>dump<span class="w"> </span><span class="m">1</span><span class="w"> </span>generated:<span class="w"> </span>progxyz_time_2020-06-24_03:45:31.351014
<span class="o">[</span><span class="m">03</span>:45:42<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Timed:
<span class="o">[</span><span class="m">03</span>:45:44<span class="w"> </span>-<span class="w"> </span>INFO<span class="o">]</span>:<span class="w"> </span>Core<span class="w"> </span>dump<span class="w"> </span><span class="m">2</span><span class="w"> </span>generated:<span class="w"> </span>progxyz_time_2020-06-24_03:45:42.351014
$
$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>progxyz_time_2020-06-24_03<span class="se">\:</span><span class="m">45</span><span class="se">\:</span>*
-rw-r--r--.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">356848</span><span class="w"> </span>Jun<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">03</span>:45<span class="w"> </span>progxyz_time_2020-06-24_03:45:20.351014
-rw-r--r--.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">356848</span><span class="w"> </span>Jun<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">03</span>:45<span class="w"> </span>progxyz_time_2020-06-24_03:45:31.351014
-rw-r--r--.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">356848</span><span class="w"> </span>Jun<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="m">03</span>:45<span class="w"> </span>progxyz_time_2020-06-24_03:45:42.351014
$
</code></pre></div>

<h4>基于 CPU 和内存使用情况的核心转储</h4>
<p>ProcDump 还可以让你在测试二进制或进程达到一定的 CPU 或内存阈值时触发核心转储。ProcDump 的手册页显示了调用 ProcDump 时使用的命令行参数：</p>
<ul>
<li><code>-C</code>：当 CPU 超过或等于指定值时，触发核心转储生成（0 到 100 * nCPU）。</li>
<li><code>-c</code>：当 CPU 小于指定值时，触发核心转储生成（0 到 100 * nCPU）。</li>
<li><code>-M</code>：当内存提交超过或等于指定值（MB）时，触发核心转储生成。</li>
<li><code>-m</code>：当内存提交小于指定值（MB）时，触发核心转储生成。</li>
<li><code>-T</code>：当线程数超过或等于指定值时触发。</li>
<li><code>-F</code>：当文件描述符数量超过或等于指定值时触发。</li>
<li><code>-I</code>：轮询频率，单位为毫秒（默认为 1000）。</li>
</ul>
<p>例如，当给定 PID 的 CPU 使用率超过 70% 时，可以要求 ProcDump 转储核心：</p>
<div class="highlight"><pre><span></span><code><span class="k">proc</span><span class="nv">dump</span><span class="w"> </span><span class="o">-</span><span class="nv">C</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="o">-</span><span class="nv">n</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="mi">351014</span>
</code></pre></div>

<h3>结论</h3>
<p>ProcDump 是一长串被移植到 Linux 的 Windows 程序中的一个有趣的补充。它不仅为 Linux 用户提供了额外的工具选择，而且可以让 Windows 用户在 Linux 上工作时更有熟悉的感觉。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>