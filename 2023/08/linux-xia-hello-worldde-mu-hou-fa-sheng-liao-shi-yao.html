<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Linux 下“Hello World”的幕后发生了什么</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Julia Evans 今天我在想 —— 当你在 Linux 上运行一个简单的 “Hello World” Python 程序时，发生了什么，就像下面这个？ print("hello world") 这就是在命令行下的情 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2023/08/linux-xia-hello-worldde-mu-hou-fa-sheng-liao-shi-yao.html" rel="bookmark"
           title="Permalink to Linux 下“Hello World”的幕后发生了什么">Linux 下“Hello World”的幕后发生了什么</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-08-29T14:36:53+02:00">
                Published: Tue 29 August 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Julia Evans</p>
<p><img alt="" src="/data/attachment/album/202308/29/143604o5o22os0h20d4lz5.jpg"></p>
<p>今天我在想 —— 当你在 Linux 上运行一个简单的 “Hello World” Python 程序时，发生了什么，就像下面这个？</p>
<div class="highlight"><pre><span></span><code>print(&quot;hello world&quot;)
</code></pre></div>

<p>这就是在命令行下的情况：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python3<span class="w"> </span>hello.py
hello<span class="w"> </span>world
</code></pre></div>

<p>但是在幕后，实际上有更多的事情在发生。我将描述一些发生的情况，并且（更重要的是）解释一些你可以用来查看幕后情况的工具。我们将用 <code>readelf</code>、<code>strace</code>、<code>ldd</code>、<code>debugfs</code>、<code>/proc</code>、<code>ltrace</code>、<code>dd</code> 和 <code>stat</code>。我不会讨论任何只针对 Python 的部分 —— 只研究一下当你运行任何动态链接的可执行文件时发生的事情。</p>
<h3>0、在执行 execve 之前</h3>
<p>要启动 Python 解释器，很多步骤都需要先行完成。那么，我们究竟在运行哪一个可执行文件呢？它在何处呢？</p>
<h3>1、解析 python3 <a href="http://hello.py">hello.py</a></h3>
<p>Shell 将 <code>python3 hello.py</code> 解析成一条命令和一组参数：<code>python3</code> 和 <code>['hello.py']</code>。</p>
<p>在此过程中，可能会进行一些如全局扩展等操作。举例来说，如果你执行 <code>python3 *.py</code> ，Shell 会将其扩展到 <code>python3 hello.py</code>。</p>
<h3>2、确认 python3 的完整路径</h3>
<p>现在，我们了解到需要执行 <code>python3</code>。但是，这个二进制文件的完整路径是什么呢？解决办法是使用一个名为 <code>PATH</code> 的特殊环境变量。</p>
<p><strong>自行验证</strong>：在你的 Shell 中执行 <code>echo $PATH</code>。对我来说，它的输出如下：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</code></pre></div>

<p>当执行一个命令时，Shell 将会依序在 <code>PATH</code> 列表中的每个目录里搜索匹配的文件。</p>
<p>对于 <code>fish</code>（我的 Shell），你可以在 <a href="https://github.com/fish-shell/fish-shell/blob/900a0487443f10caa6539634ca8c49fb6e3ce5ba/src/path.cpp#L31-L45">这里</a> 查看路径解析的逻辑。它使用 <code>stat</code> 系统调用去检验是否存在文件。</p>
<p><strong>自行验证</strong>：执行 <code>strace -e stat bash</code>，然后运行像 <code>python3</code> 这样的命令。你应该会看到如下输出：</p>
<div class="highlight"><pre><span></span><code>stat(&quot;/usr/local/sbin/python3&quot;, 0x7ffcdd871f40) = -1 ENOENT (No such file or directory)
stat(&quot;/usr/local/bin/python3&quot;, 0x7ffcdd871f40) = -1 ENOENT (No such file or directory)
stat(&quot;/usr/sbin/python3&quot;, 0x7ffcdd871f40) = -1 ENOENT (No such file or directory)
stat(&quot;/usr/bin/python3&quot;, {st_mode=S_IFREG|0755, st_size=5479736, ...}) = 0
</code></pre></div>

<p>你可以观察到，一旦在 <code>/usr/bin/python3</code> 找到了二进制文件，搜索就会立即终止：它不会继续去 <code>/sbin</code> 或 <code>/bin</code> 中查找。</p>
<h4>对 execvp 的补充说明</h4>
<p>如果你想要不用自己重新实现，而运行和 Shell 同样的 <code>PATH</code> 搜索逻辑，你可以使用 libc 函数 <code>execvp</code>（或其它一些函数名中含有 <code>p</code> 的 <code>exec*</code> 函数）。</p>
<h3>3、stat 的背后运作机制</h3>
<p>你可能在思考，Julia，<code>stat</code> 到底做了什么？当你的操作系统要打开一个文件时，主要分为两个步骤：</p>
<ol>
<li>它将 <strong>文件名</strong> 映射到一个包含该文件元数据的 <strong>inode</strong></li>
<li>它利用这个 <strong>inode</strong> 来获取文件的实际内容</li>
</ol>
<p><code>stat</code> 系统调用只是返回文件的 inode 内容 —— 它并不读取任何的文件内容。好处在于这样做速度非常快。接下来让我们一起来快速了解一下 inode。（在 Dmitry Mazin 的这篇精彩文章 《<a href="https://www.cyberdemon.org/2023/07/19/bunch-of-bits.html">磁盘就是一堆比特</a>》中有更多的详细内容）</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>stat<span class="w"> </span>/usr/bin/python3
<span class="w">  </span>File:<span class="w"> </span>/usr/bin/python3<span class="w"> </span>-&gt;<span class="w"> </span>python3.9
<span class="w">  </span>Size:<span class="w"> </span><span class="m">9</span><span class="w">           </span>Blocks:<span class="w"> </span><span class="m">0</span><span class="w">          </span>IO<span class="w"> </span>Block:<span class="w"> </span><span class="m">4096</span><span class="w">   </span>symbolic<span class="w"> </span>link
Device:<span class="w"> </span>fe01h/65025d<span class="w">    </span>Inode:<span class="w"> </span><span class="m">6206</span><span class="w">        </span>Links:<span class="w"> </span><span class="m">1</span>
Access:<span class="w"> </span><span class="o">(</span><span class="m">0777</span>/lrwxrwxrwx<span class="o">)</span><span class="w">  </span>Uid:<span class="w"> </span><span class="o">(</span><span class="w">    </span><span class="m">0</span>/<span class="w">    </span>root<span class="o">)</span><span class="w">   </span>Gid:<span class="w"> </span><span class="o">(</span><span class="w">    </span><span class="m">0</span>/<span class="w">    </span>root<span class="o">)</span>
Access:<span class="w"> </span><span class="m">2023</span>-08-03<span class="w"> </span><span class="m">14</span>:17:28.890364214<span class="w"> </span>+0000
Modify:<span class="w"> </span><span class="m">2021</span>-04-05<span class="w"> </span><span class="m">12</span>:00:48.000000000<span class="w"> </span>+0000
Change:<span class="w"> </span><span class="m">2021</span>-06-22<span class="w"> </span><span class="m">04</span>:22:50.936969560<span class="w"> </span>+0000
<span class="w"> </span>Birth:<span class="w"> </span><span class="m">2021</span>-06-22<span class="w"> </span><span class="m">04</span>:22:50.924969237<span class="w"> </span>+0000
</code></pre></div>

<p><strong>自行验证</strong>：我们来实际查看一下硬盘上 inode 的确切位置。</p>
<p>首先，我们需要找出硬盘的设备名称：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>df
...
tmpfs<span class="w">             </span><span class="m">100016</span><span class="w">      </span><span class="m">604</span><span class="w">     </span><span class="m">99412</span><span class="w">   </span><span class="m">1</span>%<span class="w"> </span>/run
/dev/vda1<span class="w">       </span><span class="m">25630792</span><span class="w"> </span><span class="m">14488736</span><span class="w">  </span><span class="m">10062712</span><span class="w">  </span><span class="m">60</span>%<span class="w"> </span>/
...
</code></pre></div>

<p>看起来它是 <code>/dev/vda1</code>。接着，让我们寻找 <code>/usr/bin/python3</code> 的 inode 在我们硬盘上的确切位置（在 debugfs 提示符下输入 <code>imap</code> 命令）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>debugfs<span class="w"> </span>/dev/vda1
debugfs<span class="w"> </span><span class="m">1</span>.46.2<span class="w"> </span><span class="o">(</span><span class="m">28</span>-Feb-2021<span class="o">)</span>
debugfs:<span class="w">  </span>imap<span class="w"> </span>/usr/bin/python3
Inode<span class="w"> </span><span class="m">6206</span><span class="w"> </span>is<span class="w"> </span>part<span class="w"> </span>of<span class="w"> </span>block<span class="w"> </span>group<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>located<span class="w"> </span>at<span class="w"> </span>block<span class="w"> </span><span class="m">658</span>,<span class="w"> </span>offset<span class="w"> </span>0x0d00
</code></pre></div>

<p>我不清楚 <code>debugfs</code> 是如何确定文件名对应的 inode 的位置，但我们暂时不需要深入研究这个。</p>
<p>现在，我们需要计算硬盘中 “块 658，偏移量 0x0d00” 处是多少个字节，这个大的字节数组就是你的硬盘。每个块有 4096 个字节，所以我们需要到 <code>4096 * 658 + 0x0d00</code> 字节。使用计算器可以得到，这个值是 <code>2698496</code>。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/vda1<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">skip</span><span class="o">=</span><span class="m">2698496</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">256</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>hexdump<span class="w"> </span>-C
<span class="m">00000000</span><span class="w">  </span>ff<span class="w"> </span>a1<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">09</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>f8<span class="w"> </span>b6<span class="w"> </span>cb<span class="w"> </span><span class="m">64</span><span class="w"> </span>9a<span class="w"> </span><span class="m">65</span><span class="w"> </span>d1<span class="w"> </span><span class="m">60</span><span class="w">  </span><span class="p">|</span>...........d.e.<span class="sb">`</span><span class="p">|</span>
<span class="m">00000010</span><span class="w">  </span>f0<span class="w"> </span>fb<span class="w"> </span>6a<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..j<span class="sb">`</span>............<span class="p">|</span>
<span class="m">00000020</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">70</span><span class="w"> </span><span class="m">79</span><span class="w"> </span><span class="m">74</span><span class="w"> </span><span class="m">68</span><span class="w"> </span>6f<span class="w"> </span>6e<span class="w"> </span><span class="m">33</span><span class="w"> </span>2e<span class="w">  </span><span class="p">|</span>........python3.<span class="p">|</span>
<span class="m">00000030</span><span class="w">  </span><span class="m">39</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span><span class="m">9</span>...............<span class="p">|</span>
<span class="m">00000040</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>................<span class="p">|</span>
*
<span class="m">00000060</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">12</span><span class="w"> </span>4a<span class="w"> </span><span class="m">95</span><span class="w"> </span>8c<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>.....J..........<span class="p">|</span>
<span class="m">00000070</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>2d<span class="w"> </span>cb<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>............-...<span class="p">|</span>
<span class="m">00000080</span><span class="w">  </span><span class="m">20</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>bd<span class="w"> </span>e7<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">64</span><span class="w"> </span>df<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>d8<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">47</span><span class="w"> </span>d4<span class="w">  </span><span class="p">|</span><span class="w"> </span>...<span class="sb">`</span>.d.......G.<span class="p">|</span>
<span class="m">00000090</span><span class="w">  </span>9a<span class="w"> </span><span class="m">65</span><span class="w"> </span>d1<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="m">54</span><span class="w"> </span>a4<span class="w"> </span><span class="m">87</span><span class="w"> </span>dc<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>.e.<span class="sb">`</span>T...........<span class="p">|</span>
000000a0<span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>................<span class="p">|</span>
</code></pre></div>

<p>好极了！我们找到了 inode！你可以在里面看到 <code>python3</code>，这是一个很好的迹象。我们并不打算深入了解所有这些，但是 <a href="https://github.com/torvalds/linux/blob/fdf0eaf11452d72945af31804e2a1048ee1b574c/fs/ext4/ext4.h#L769">Linux 内核的 ext4 inode 结构</a> 指出，前 16 位是 “模式”，即权限。所以现在我们将看一下 <code>ffa1</code> 如何对应到文件权限。</p>
<ul>
<li><code>ffa1</code> 对应的数字是 <code>0xa1ff</code>，或者 41471（因为 x86 是小端表示）</li>
<li>41471 用八进制表示就是 <code>0120777</code></li>
<li>这有些奇怪 - 那个文件的权限肯定可以是 <code>777</code>，但前三位是什么呢？我以前没见过这些！你可以在 <a href="https://man7.org/linux/man-pages/man7/inode.7.html">inode 手册页</a> 中找到 <code>012</code> 的含义（向下滚动到“文件类型和模式”）。这里有一个小的表格说 <code>012</code> 表示 “符号链接”。</li>
</ul>
<p>我们查看一下这个文件，确实是一个权限为 <code>777</code> 的符号链接：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/usr/bin/python3
lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">9</span><span class="w"> </span>Apr<span class="w">  </span><span class="m">5</span><span class="w">  </span><span class="m">2021</span><span class="w"> </span>/usr/bin/python3<span class="w"> </span>-&gt;<span class="w"> </span>python3.9
</code></pre></div>

<p>它确实是！耶，我们正确地解码了它。</p>
<h3>4、准备复刻</h3>
<p>我们尚未准备好启动 <code>python3</code>。首先，Shell 需要创建一个新的子进程来进行运行。在 Unix 上，新的进程启动的方式有些特殊 - 首先进程克隆自己，然后运行 <code>execve</code>，这会将克隆的进程替换为新的进程。</p>
<p><strong>自行验证：</strong> 运行 <code>strace -e clone bash</code>，然后运行 <code>python3</code>。你应该会看到类似下面的输出：</p>
<div class="highlight"><pre><span></span><code>clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f03788f1a10) = 3708100
</code></pre></div>

<p><code>3708100</code> 是新进程的 PID，这是 Shell 进程的子进程。</p>
<p>这里有些工具可以查看进程的相关信息：</p>
<ul>
<li><code>pstree</code> 会展示你的系统中所有进程的树状图</li>
<li><code>cat /proc/PID/stat</code> 会显示一些关于该进程的信息。你可以在 <code>man proc</code> 中找到这个文件的内容说明。例如，第四个字段是父进程的PID。</li>
</ul>
<h4>新进程的继承</h4>
<p>新的进程（即将变为 <code>python3</code> 的）从 Shell 中继承了很多内容。例如，它继承了：</p>
<ol>
<li><strong>环境变量</strong>：你可以通过 <code>cat /proc/PID/environ | tr '\0' '\n'</code> 查看</li>
<li><strong>标准输出和标准错误的文件描述符</strong>：通过 <code>ls -l /proc/PID/fd</code> 查看</li>
<li><strong>工作目录</strong>（也就是当前目录）</li>
<li><strong>命名空间和控制组</strong>（如果它在一个容器内）</li>
<li>运行它的<strong>用户</strong>以及<strong>群组</strong></li>
<li>还有可能是我此刻未能列举出来的更多东西</li>
</ol>
<h3>5、Shell 调用 execve</h3>
<p>现在我们准备好启动 Python 解释器了！</p>
<p><strong>自行验证</strong>：运行 <code>strace -f -e execve bash</code>，接着运行 <code>python3</code>。其中的 <code>-f</code> 参数非常重要，因为我们想要跟踪任何可能产生的子进程。你应该可以看到如下的输出：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">pid</span><span class="w"> </span><span class="mi">3708381</span><span class="p">]</span><span class="w"> </span><span class="n">execve</span><span class="p">(</span><span class="s2">&quot;/usr/bin/python3&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">],</span><span class="w"> </span><span class="mh">0x560397748300</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">*/</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>第一个参数是这个二进制文件，而第二个参数是命令行参数列表。这些命令行参数被放置在程序内存的特定位置，以便在运行时可以访问。</p>
<p>那么，<code>execve</code> 内部到底发生了什么呢？</p>
<h3>6、获取该二进制文件的内容</h3>
<p>我们首先需要打开 <code>python3</code> 的二进制文件并读取其内容。直到目前为止，我们只使用了 <code>stat</code> 系统调用来获取其元数据，但现在我们需要获取它的内容。</p>
<p>让我们再次查看 <code>stat</code> 的输出：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>stat<span class="w"> </span>/usr/bin/python3
<span class="w">  </span>File:<span class="w"> </span>/usr/bin/python3<span class="w"> </span>-&gt;<span class="w"> </span>python3.9
<span class="w">  </span>Size:<span class="w"> </span><span class="m">9</span><span class="w">           </span>Blocks:<span class="w"> </span><span class="m">0</span><span class="w">          </span>IO<span class="w"> </span>Block:<span class="w"> </span><span class="m">4096</span><span class="w">   </span>symbolic<span class="w"> </span>link
Device:<span class="w"> </span>fe01h/65025d<span class="w">    </span>Inode:<span class="w"> </span><span class="m">6206</span><span class="w">        </span>Links:<span class="w"> </span><span class="m">1</span>
...
</code></pre></div>

<p>该文件在磁盘上占用 0 个块的空间。这是因为符号链接（<code>python3.9</code>）的内容实际上是存储在 inode 自身中：在下面显示你可以看到（来自上述 inode 的二进制内容，以 <code>hexdump</code> 格式分为两行输出）。</p>
<div class="highlight"><pre><span></span><code><span class="mf">00000020</span><span class="w">  </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">01</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w">  </span><span class="mf">70</span><span class="w"> </span><span class="mf">79</span><span class="w"> </span><span class="mf">74</span><span class="w"> </span><span class="mf">68</span><span class="w"> </span><span class="mf">6</span><span class="n">f</span><span class="w"> </span><span class="mf">6</span><span class="n">e</span><span class="w"> </span><span class="mf">33</span><span class="w"> </span><span class="mf">2</span><span class="n">e</span><span class="w">  </span><span class="err">|</span><span class="mf">........</span><span class="n">python3</span><span class="mf">.</span><span class="err">|</span>
<span class="mf">00000030</span><span class="w">  </span><span class="mf">39</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w">  </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">00</span><span class="w">  </span><span class="err">|</span><span class="mf">9...............</span><span class="err">|</span>
</code></pre></div>

<p>因此，我们将需要打开 <code>/usr/bin/python3.9</code> 。所有这些操作都在内核内部进行，所以你并不会看到其他的系统调用。</p>
<p>每个文件都由硬盘上的一系列的 <strong>块</strong> 构成。我知道我系统中的每个块是 4096 字节，所以一个文件的最小大小是 4096 字节 —— 甚至如果文件只有 5 字节，它在磁盘上仍然占用 4KB。</p>
<p><strong>自行验证</strong>：我们可以通过 <code>debugfs</code> 找到块号，如下所示：（再次说明，我从 Dmitry Mazin 的《<a href="https://www.cyberdemon.org/2023/07/19/bunch-of-bits.html">磁盘就是一堆比特</a>》文章中得知这些步骤）。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>debugfs<span class="w"> </span>/dev/vda1
debugfs:<span class="w">  </span>blocks<span class="w"> </span>/usr/bin/python3.9
<span class="m">145408</span><span class="w"> </span><span class="m">145409</span><span class="w"> </span><span class="m">145410</span><span class="w"> </span><span class="m">145411</span><span class="w"> </span><span class="m">145412</span><span class="w"> </span><span class="m">145413</span><span class="w"> </span><span class="m">145414</span><span class="w"> </span><span class="m">145415</span><span class="w"> </span><span class="m">145416</span><span class="w"> </span><span class="m">145417</span><span class="w"> </span><span class="m">145418</span><span class="w"> </span><span class="m">145419</span><span class="w"> </span><span class="m">145420</span><span class="w"> </span><span class="m">145421</span><span class="w"> </span><span class="m">145422</span><span class="w"> </span><span class="m">145423</span><span class="w"> </span><span class="m">145424</span><span class="w"> </span><span class="m">145425</span><span class="w"> </span><span class="m">145426</span><span class="w"> </span><span class="m">145427</span><span class="w"> </span><span class="m">145428</span><span class="w"> </span><span class="m">145429</span><span class="w"> </span><span class="m">145430</span><span class="w"> </span><span class="m">145431</span><span class="w"> </span><span class="m">145432</span><span class="w"> </span><span class="m">145433</span><span class="w"> </span><span class="m">145434</span><span class="w"> </span><span class="m">145435</span><span class="w"> </span><span class="m">145436</span><span class="w"> </span><span class="m">145437</span>
</code></pre></div>

<p>接下来，我们可以使用 <code>dd</code> 来读取文件的第一个块。我们将块大小设定为 4096 字节，跳过 <code>145408</code> 个块，然后读取 1 个块。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/vda1<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">4096</span><span class="w"> </span><span class="nv">skip</span><span class="o">=</span><span class="m">145408</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>hexdump<span class="w"> </span>-C<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
<span class="m">00000000</span><span class="w">  </span>7f<span class="w"> </span><span class="m">45</span><span class="w"> </span>4c<span class="w"> </span><span class="m">46</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>.ELF............<span class="p">|</span>
<span class="m">00000010</span><span class="w">  </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>3e<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>c0<span class="w"> </span>a5<span class="w"> </span>5e<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..&gt;.......^.....<span class="p">|</span>
<span class="m">00000020</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>b8<span class="w"> </span><span class="m">95</span><span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>@.........S.....<span class="p">|</span>
<span class="m">00000030</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">38</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>0b<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>1e<span class="w"> </span><span class="m">00</span><span class="w"> </span>1d<span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>....@.8...@.....<span class="p">|</span>
<span class="m">00000040</span><span class="w">  </span><span class="m">06</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>........@.......<span class="p">|</span>
<span class="m">00000050</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>@.@.....@.@.....<span class="p">|</span>
<span class="m">00000060</span><span class="w">  </span><span class="m">68</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">68</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>h.......h.......<span class="p">|</span>
<span class="m">00000070</span><span class="w">  </span><span class="m">08</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>................<span class="p">|</span>
<span class="m">00000080</span><span class="w">  </span>a8<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>a8<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..........@.....<span class="p">|</span>
<span class="m">00000090</span><span class="w">  </span>a8<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>1c<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..@.............<span class="p">|</span>
</code></pre></div>

<p>你会发现，这样我们得到的输出结果与直接使用 <code>cat</code> 读取文件所获得的结果完全一致。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/usr/bin/python3.9<span class="w"> </span><span class="p">|</span><span class="w"> </span>hexdump<span class="w"> </span>-C<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
<span class="m">00000000</span><span class="w">  </span>7f<span class="w"> </span><span class="m">45</span><span class="w"> </span>4c<span class="w"> </span><span class="m">46</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>.ELF............<span class="p">|</span>
<span class="m">00000010</span><span class="w">  </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>3e<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>c0<span class="w"> </span>a5<span class="w"> </span>5e<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..&gt;.......^.....<span class="p">|</span>
<span class="m">00000020</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>b8<span class="w"> </span><span class="m">95</span><span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>@.........S.....<span class="p">|</span>
<span class="m">00000030</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">38</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>0b<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>1e<span class="w"> </span><span class="m">00</span><span class="w"> </span>1d<span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>....@.8...@.....<span class="p">|</span>
<span class="m">00000040</span><span class="w">  </span><span class="m">06</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>........@.......<span class="p">|</span>
<span class="m">00000050</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>@.@.....@.@.....<span class="p">|</span>
<span class="m">00000060</span><span class="w">  </span><span class="m">68</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">68</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>h.......h.......<span class="p">|</span>
<span class="m">00000070</span><span class="w">  </span><span class="m">08</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">03</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>................<span class="p">|</span>
<span class="m">00000080</span><span class="w">  </span>a8<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>a8<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..........@.....<span class="p">|</span>
<span class="m">00000090</span><span class="w">  </span>a8<span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span>1c<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>..@.............<span class="p">|</span>
</code></pre></div>

<h4>关于魔术数字的额外说明</h4>
<p>这个文件以 <code>ELF</code> 开头，这是一个被称为“<ruby> 魔术数字 <rt>  magic number </rt></ruby>”的标识符，它是一种字节序列，告诉我们这是一个 ELF 文件。在 Linux 上，ELF 是二进制文件的格式。</p>
<p>不同的文件格式有不同的魔术数字。例如，gzip 的魔数是 <code>1f8b</code>。文件开头的魔术数字就是 <code>file blah.gz</code> 如何识别出它是一个 gzip 文件的方式。</p>
<p>我认为 <code>file</code> 命令使用了各种启发式方法来确定文件的类型，而其中，魔术数字是一个重要的特征。</p>
<h3>7、寻找解释器</h3>
<p>我们来解析这个 ELF 文件，看看里面都有什么内容。</p>
<p><strong>自行验证</strong>：运行 <code>readelf -a /usr/bin/python3.9</code>。我得到的结果是这样的（但是我删减了大量的内容）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>readelf<span class="w"> </span>-a<span class="w"> </span>/usr/bin/python3.9
ELF<span class="w"> </span>Header:
<span class="w">    </span>Class:<span class="w">                             </span>ELF64
<span class="w">    </span>Machine:<span class="w">                           </span>Advanced<span class="w"> </span>Micro<span class="w"> </span>Devices<span class="w"> </span>X86-64
...
-&gt;<span class="w">  </span>Entry<span class="w"> </span>point<span class="w"> </span>address:<span class="w">               </span>0x5ea5c0
...
Program<span class="w"> </span>Headers:
<span class="w">  </span>Type<span class="w">           </span>Offset<span class="w">             </span>VirtAddr<span class="w">           </span>PhysAddr
<span class="w">  </span>INTERP<span class="w">         </span>0x00000000000002a8<span class="w"> </span>0x00000000004002a8<span class="w"> </span>0x00000000004002a8
<span class="w">                 </span>0x000000000000001c<span class="w"> </span>0x000000000000001c<span class="w">  </span>R<span class="w">      </span>0x1
-&gt;<span class="w">      </span><span class="o">[</span>Requesting<span class="w"> </span>program<span class="w"> </span>interpreter:<span class="w"> </span>/lib64/ld-linux-x86-64.so.2<span class="o">]</span>
<span class="w">        </span>...
-&gt;<span class="w">        </span><span class="m">1238</span>:<span class="w"> </span>00000000005ea5c0<span class="w">    </span><span class="m">43</span><span class="w"> </span>FUNC<span class="w">    </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">   </span><span class="m">13</span><span class="w"> </span>_start
</code></pre></div>

<p>从这段内容中，我理解到：</p>
<ol>
<li>请求内核运行 <code>/lib64/ld-linux-x86-64.so.2</code> 来启动这个程序。这就是所谓的<strong>动态链接器</strong>，我们将在随后的部分对其进行讨论。</li>
<li>该程序制定了一个入口点（位于 <code>0x5ea5c0</code>），那里是这个程序代码开始的地方。</li>
</ol>
<p>接下来，让我们一起来聊聊动态链接器。</p>
<h3>8、动态链接</h3>
<p>好的！我们已从磁盘读取了字节数据，并启动了这个“解释器”。那么，接下来会发生什么呢？如果你执行 <code>strace -o out.strace python3</code>，你会在 <code>execve</code> 系统调用之后观察到一系列的信息：</p>
<div class="highlight"><pre><span></span><code><span class="n">execve</span><span class="p">(</span><span class="s2">&quot;/usr/bin/python3&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">],</span><span class="w"> </span><span class="mh">0x560af13472f0</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">vars</span><span class="w"> </span><span class="o">*/</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">brk</span><span class="p">(</span><span class="n">NULL</span><span class="p">)</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="mh">0xfcc000</span>
<span class="n">access</span><span class="p">(</span><span class="s2">&quot;/etc/ld.so.preload&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">R_OK</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">ENOENT</span><span class="w"> </span><span class="p">(</span><span class="n">No</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">directory</span><span class="p">)</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/etc/ld.so.cache&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="n">fstat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mi">0644</span><span class="p">,</span><span class="w"> </span><span class="n">st_size</span><span class="o">=</span><span class="mi">32091</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">})</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">mmap</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">32091</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_PRIVATE</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7f718a1e3000</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">                        </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/lib/x86_64-linux-gnu/libpthread.so.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\177</span><span class="s2">ELF</span><span class="se">\2\1\1\0\0\0\0\0\0\0\0\0\3\0</span><span class="s2">&gt;</span><span class="se">\0\1\0\0\0</span><span class="s2"> l</span><span class="se">\0\0\0\0\0\0</span><span class="s2">&quot;</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="mi">832</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">832</span>
<span class="n">fstat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mi">0755</span><span class="p">,</span><span class="w"> </span><span class="n">st_size</span><span class="o">=</span><span class="mi">149520</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">})</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">mmap</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">8192</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7f718a1e1000</span>
<span class="o">...</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">                        </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/lib/x86_64-linux-gnu/libdl.so.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
</code></pre></div>

<p>这些内容初看可能让人望而生畏，但我希望你能重点关注这一部分：<code>openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libpthread.so.0" ...</code>。这里正在打开一个被称为 <code>pthread</code> 的 C 语言线程库，运行 Python 解释器时需要这个库。</p>
<p><strong>自行验证</strong>：如果你想知道一个二进制文件在运行时需要加载哪些库，你可以使用 <code>ldd</code> 命令。下面展示的是我运行后的效果：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ldd<span class="w"> </span>/usr/bin/python3.9
<span class="w">    </span>linux-vdso.so.1<span class="w"> </span><span class="o">(</span>0x00007ffc2aad7000<span class="o">)</span>
<span class="w">    </span>libpthread.so.0<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libpthread.so.0<span class="w"> </span><span class="o">(</span>0x00007f2fd6554000<span class="o">)</span>
<span class="w">    </span>libdl.so.2<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libdl.so.2<span class="w"> </span><span class="o">(</span>0x00007f2fd654e000<span class="o">)</span>
<span class="w">    </span>libutil.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libutil.so.1<span class="w"> </span><span class="o">(</span>0x00007f2fd6549000<span class="o">)</span>
<span class="w">    </span>libm.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libm.so.6<span class="w"> </span><span class="o">(</span>0x00007f2fd6405000<span class="o">)</span>
<span class="w">    </span>libexpat.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libexpat.so.1<span class="w"> </span><span class="o">(</span>0x00007f2fd63d6000<span class="o">)</span>
<span class="w">    </span>libz.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libz.so.1<span class="w"> </span><span class="o">(</span>0x00007f2fd63b9000<span class="o">)</span>
<span class="w">    </span>libc.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6<span class="w"> </span><span class="o">(</span>0x00007f2fd61e3000<span class="o">)</span>
<span class="w">    </span>/lib64/ld-linux-x86-64.so.2<span class="w"> </span><span class="o">(</span>0x00007f2fd6580000<span class="o">)</span>
</code></pre></div>

<p>你可以看到，第一个列出的库就是 <code>/lib/x86_64-linux-gnu/libpthread.so.0</code>，这就是它被第一个加载的原因。</p>
<h4>关于 LD_LIBRARY_PATH</h4>
<p>说实话，我关于动态链接的理解还有些模糊，以下是我所了解的一些内容：</p>
<ul>
<li>动态链接发生在用户空间，我的系统上的动态链接器位于 <code>/lib64/ld-linux-x86-64.so.2</code>. 如果你缺少动态链接器，可能会遇到一些奇怪的问题，比如这种 <a href="https://jvns.ca/blog/2021/11/17/debugging-a-weird--file-not-found--error/">奇怪的“文件未找到”错误</a></li>
<li>动态链接器使用 <code>LD_LIBRARY_PATH</code> 环境变量来查找库</li>
<li>动态链接器也会使用 <code>LD_PRELOAD</code> 环境变量来覆盖你想要的任何动态链接函数（你可以使用它来进行 <a href="https://jvns.ca/blog/2014/11/27/ld-preload-is-super-fun-and-easy/">有趣的魔改</a>，或者使用像 jemalloc 这样的替代品来替换默认内存分配器）</li>
<li><code>strace</code> 的输出中有一些 <code>mprotect</code>，因为安全原因将库代码标记为只读</li>
<li>在 Mac 上，不是使用 <code>LD_LIBRARY_PATH</code>（Linux），而是 <code>DYLD_LIBRARY_PATH</code></li>
</ul>
<p>你可能会有疑问，如果动态链接发生在用户空间，我们为什么没有看到大量的 <code>stat</code> 系统调用在 <code>LD_LIBRARY_PATH</code> 中搜索这些库，就像 Bash 在 <code>PATH</code> 中搜索那样？</p>
<p>这是因为 <code>ld</code> 在 <code>/etc/ld.so.cache</code> 中有一个缓存，因此所有之前已经找到的库都会被记录在这里。你可以在 <code>strace</code> 的输出中看到它正在打开缓存 - <code>openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</code>。</p>
<p>在 <a href="https://gist.github.com/jvns/4254251bea219568df9f43a2efd8d0f5">完整的 strace 输出</a> 中，我仍然对动态链接之后出现的一些系统调用感到困惑（什么是 <code>prlimit64</code>？本地环境的内容是如何介入的？<code>gconv-modules.cache</code> 是什么？<code>rt_sigaction</code> 做了什么？<code>arch_prctl</code> 是什么？以及 <code>set_tid_address</code> 和 <code>set_robust_list</code> 是什么？）。尽管如此，我觉得已经有了一个不错的开头。</p>
<h4>旁注：ldd 实际上是一个简单的 Shell 脚本！</h4>
<p>在 Mastodon 上，有人 <a href="https://octodon.social/@lkundrak/110832640058459399">指出</a>，<code>ldd</code> 实际上是一个 Shell 脚本，它设置了 <code>LD_TRACE_LOADED_OBJECTS=1</code> 环境变量，然后启动程序。因此，你也可以通过以下方式实现相同的功能：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nv">LD_TRACE_LOADED_OBJECTS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>python3
<span class="w">    </span>linux-vdso.so.1<span class="w"> </span><span class="o">(</span>0x00007ffe13b0a000<span class="o">)</span>
<span class="w">    </span>libpthread.so.0<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libpthread.so.0<span class="w"> </span><span class="o">(</span>0x00007f01a5a47000<span class="o">)</span>
<span class="w">    </span>libdl.so.2<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libdl.so.2<span class="w"> </span><span class="o">(</span>0x00007f01a5a41000<span class="o">)</span>
<span class="w">    </span>libutil.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libutil.so.1<span class="w"> </span><span class="o">(</span>0x00007f2fd6549000<span class="o">)</span>
<span class="w">    </span>libm.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libm.so.6<span class="w"> </span><span class="o">(</span>0x00007f2fd6405000<span class="o">)</span>
<span class="w">    </span>libexpat.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libexpat.so.1<span class="w"> </span><span class="o">(</span>0x00007f2fd63d6000<span class="o">)</span>
<span class="w">    </span>libz.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libz.so.1<span class="w"> </span><span class="o">(</span>0x00007f2fd63b9000<span class="o">)</span>
<span class="w">    </span>libc.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6<span class="w"> </span><span class="o">(</span>0x00007f2fd61e3000<span class="o">)</span>
<span class="w">    </span>/lib64/ld-linux-x86-64.so.2<span class="w"> </span><span class="o">(</span>0x00007f2fd6580000<span class="o">)</span>
</code></pre></div>

<p>事实上，<code>ld</code> 也是一个可以直接运行的二进制文件，所以你也可以通过 <code>/lib64/ld-linux-x86-64.so.2 --list /usr/bin/python3.9</code> 来达到相同的效果。</p>
<h4>关于 init 和 fini</h4>
<p>让我们来谈谈这行 <code>strace</code> 输出中的内容：</p>
<div class="highlight"><pre><span></span><code><span class="nx">set_tid_address</span><span class="p">(</span><span class="mh">0x7f58880dca10</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3709103</span>
</code></pre></div>

<p>这似乎与线程有关，我认为这可能是因为 <code>pthread</code> 库（以及所有其他动态加载的库）在加载时得以运行初始化代码。在库加载时运行的代码位于 <code>init</code> 区域（或者也可能是 <code>.ctors</code> 区域）。</p>
<p><strong>自行验证</strong>：让我们使用 <code>readelf</code> 来看看这个：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>readelf<span class="w"> </span>-a<span class="w"> </span>/lib/x86_64-linux-gnu/libpthread.so.0
...
<span class="w">  </span><span class="o">[</span><span class="m">10</span><span class="o">]</span><span class="w"> </span>.rela.plt<span class="w">         </span>RELA<span class="w">             </span>00000000000051f0<span class="w">  </span>000051f0
<span class="w">       </span>00000000000007f8<span class="w">  </span><span class="m">0000000000000018</span><span class="w">  </span>AI<span class="w">       </span><span class="m">4</span><span class="w">    </span><span class="m">26</span><span class="w">     </span><span class="m">8</span>
<span class="w">  </span><span class="o">[</span><span class="m">11</span><span class="o">]</span><span class="w"> </span>.init<span class="w">             </span>PROGBITS<span class="w">         </span><span class="m">0000000000006000</span><span class="w">  </span><span class="m">00006000</span>
<span class="w">       </span>000000000000000e<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>AX<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">4</span>
<span class="w">  </span><span class="o">[</span><span class="m">12</span><span class="o">]</span><span class="w"> </span>.plt<span class="w">              </span>PROGBITS<span class="w">         </span><span class="m">0000000000006010</span><span class="w">  </span><span class="m">00006010</span>
<span class="w">       </span><span class="m">0000000000000560</span><span class="w">  </span><span class="m">0000000000000010</span><span class="w">  </span>AX<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">16</span>
...
</code></pre></div>

<p>这个库没有 <code>.ctors</code> 区域，只有一个 <code>.init</code>。但是，<code>.init</code> 区域都有些什么内容呢？我们可以使用 <code>objdump</code> 来反汇编这段代码：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>objdump<span class="w"> </span>-d<span class="w"> </span>/lib/x86_64-linux-gnu/libpthread.so.0
Disassembly<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>.init:

<span class="m">0000000000006000</span><span class="w"> </span>&lt;_init&gt;:
<span class="w">    </span><span class="m">6000</span>:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">83</span><span class="w"> </span>ec<span class="w"> </span><span class="m">08</span><span class="w">             </span>sub<span class="w">    </span><span class="nv">$0</span>x8,%rsp
<span class="w">    </span><span class="m">6004</span>:<span class="w">       </span>e8<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">08</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>callq<span class="w">  </span><span class="m">6860</span><span class="w"> </span>&lt;__pthread_initialize_minimal&gt;
<span class="w">    </span><span class="m">6009</span>:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">83</span><span class="w"> </span>c4<span class="w"> </span><span class="m">08</span><span class="w">             </span>add<span class="w">    </span><span class="nv">$0</span>x8,%rsp
<span class="w">    </span>600d:<span class="w">       </span>c3
</code></pre></div>

<p>所以它在调用 <code>__pthread_initialize_minimal</code>。我在 glibc 中找到了 <a href="https://github.com/bminor/glibc/blob/a78e5979a92c7985eadad7246740f3874271303f/nptl/nptl-init.c#L100">这个函数的代码</a>，尽管我不得不找到一个较早版本的 glibc，因为在更近的版本中，libpthread <a href="https://developers.redhat.com/articles/2021/12/17/why-glibc-234-removed-libpthread">不再是一个独立的库</a>。</p>
<p>我不确定这个 <code>set_tid_address</code> 系统调用是否实际上来自 <code>__pthread_initialize_minimal</code>，但至少我们知道了库可以通过 <code>.init</code> 区域在启动时运行代码。</p>
<p>这里有一份关于 .init 区域的 elf 手册的笔记：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>man<span class="w"> </span>elf
</code></pre></div>

<p><code>.init</code> 这个区域保存着对进程初始化代码有贡献的可执行指令。当程序开始运行时，系统会安排在调用主程序入口点之前执行该区域中的代码。</p>
<p>在 ELF 文件中也有一个在结束时运行的 <code>.fini</code> 区域，以及其他可以存在的区域 <code>.ctors</code> / <code>.dtors</code>（构造器和析构器）。</p>
<p>好的，关于动态链接就说这么多。</p>
<h3>9、转到 _start</h3>
<p>在动态链接完成后，我们进入到 Python 解释器中的 <code>_start</code>。然后，它将执行所有正常的 Python 解析器会做的事情。</p>
<p>我不打算深入讨论这个，因为我在这里关心的是关于如何在 Linux 上运行二进制文件的一般性知识，而不是特别针对 Python 解释器。</p>
<h3>10、写入字符串</h3>
<p>不过，我们仍然需要打印出 “hello world”。在底层，Python 的 <code>print</code> 函数调用了 libc 中的某个函数。但是，它调用了哪一个呢？让我们来找出答案！</p>
<p><strong>自行验证</strong>：运行 <code>ltrace -o out python3 hello.py</code>：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ltrace<span class="w"> </span>-o<span class="w"> </span>out<span class="w"> </span>python3<span class="w"> </span>hello.py
$<span class="w"> </span>grep<span class="w"> </span>hello<span class="w"> </span>out
write<span class="o">(</span><span class="m">1</span>,<span class="w"> </span><span class="s2">&quot;hello world\n&quot;</span>,<span class="w"> </span><span class="m">12</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span>
</code></pre></div>

<p>看起来它确实在调用 <code>write</code> 函数。</p>
<p>我必须承认，我对 <code>ltrace</code> 总是有一些疑虑 —— 与我深信不疑的 <code>strace</code> 不同，我总是不完全确定 <code>ltrace</code> 是否准确地报告了库调用。但在这个情况下，它似乎有效。并且，如果我们查阅 <a href="https://github.com/python/cpython/blob/400835ea1626c8c6dcd967c7eabe0dad4a923182/Python/fileutils.c#L1955">cpython 的源代码</a>，它似乎在一些地方确实调用了 <code>write()</code> 函数，所以我倾向于相信这个结果。</p>
<h4>什么是 libc？</h4>
<p>我们刚刚提到，Python 调用了 libc 中的 <code>write</code> 函数。那么，libc 是什么呢？它是 C 的标准库，负责许多基本操作，例如：</p>
<ul>
<li>用 <code>malloc</code> 分配内存</li>
<li>文件 I/O（打开/关闭文件）</li>
<li>执行程序（像我们之前提到的 <code>execvp</code>）</li>
<li>使用 <code>getaddrinfo</code> 查找 DNS 记录</li>
<li>使用 <code>pthread</code> 管理线程</li>
</ul>
<p>在 Linux 上，程序不一定需要使用 libc（例如 Go 就广为人知地未使用它，而是直接调用了 Linux 系统调用），但是我常用的大多数其他编程语言（如 node、Python、Ruby、Rust）都使用了 libc。我不确定 Java 是否也使用了。</p>
<p>你能通过在你的二进制文件上执行 <code>ldd</code> 命令，检查你是否正在使用 libc：如果你看到了 <code>libc.so.6</code> 这样的信息，那么你就在使用 libc。</p>
<h4>为什么 libc 重要？</h4>
<p>你也许在思考 —— 为何重要的是 Python 调用 libc 的 <code>write</code> 函数，然后 libc 再调用 <code>write</code> 系统调用？为何我要着重提及 <code>libc</code> 是调用过程的一环？</p>
<p>我认为，在这个案例中，这并不真的很重要（根据我所知，libc 的 <code>write</code> 函数与 <code>write</code> 系统调用的映射相当直接）。</p>
<p>然而，存在不同的 libc 实现，有时它们的行为会有所不同。两个主要的实现是 glibc（GNU libc）和 musl libc。</p>
<p>例如，直到最近，<a href="https://www.openwall.com/lists/musl/2023/05/02/1">musl 的 <code>getaddrinfo</code> 并不支持 TCP DNS</a>，<a href="https://christoph.luppri.ch/fixing-dns-resolution-for-ruby-on-alpine-linux">这是一篇关于这个问题引发的错误的博客文章</a>。</p>
<h4>关于 stdout 和终端的小插曲</h4>
<p>在我们的程序中，stdout（<code>1</code> 文件描述符）是一个终端。你可以在终端上做一些有趣的事情！例如：</p>
<ol>
<li>在终端中运行 <code>ls -l /proc/self/fd/1</code>。我得到了 <code>/dev/pts/2</code> 的结果。</li>
<li>在另一个终端窗口中，运行 <code>echo hello &gt; /dev/pts/2</code>。</li>
<li>返回到原始终端窗口。你应会看到 <code>hello</code> 被打印出来了！</li>
</ol>
<h3>暂时就到这儿吧!</h3>
<p>希望通过上文，你对 <code>hello world</code> 是如何打印出来的有了更深的了解！我暂时不再添加更多的细节，因为这篇文章已经足够长了，但显然还有更多的细节可以探讨，如果大家能提供更多的细节，我可能会添加更多的内容。如果你有关于我在这里没提到的程序内部调用过程的任何工具推荐，我会特别高兴。</p>
<h3>我很期待看到一份 Mac 版的解析</h3>
<p>我对 Mac OS 的一个懊恼是，我不知道如何在这个级别上解读我的系统——当我打印 “hello world”，我无法像在 Linux 上那样，窥视背后的运作机制。我很希望看到一个深度的解析。</p>
<p>我所知道的一些在 Mac 下的对应工具：</p>
<ul>
<li><code>ldd</code> -&gt; <code>otool -L</code></li>
<li><code>readelf</code> -&gt; <code>otool</code></li>
<li>有人说你可以在 Mac 上使用 <code>dtruss</code> 或 <code>dtrace</code> 来代替 <code>strace</code>，但我尚未有足够的勇气关闭系统完整性保护来让它工作。</li>
<li><code>strace</code> -&gt; <code>sc_usage</code> 似乎能够收集关于系统调用使用情况的统计信息，<code>fs_usage</code> 则可以收集文件使用情况的信息。</li>
</ul>
<h3>延伸阅读</h3>
<p>一些附加的链接：</p>
<ul>
<li><a href="https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html">快速教程：如何在 Linux 上创建超小型 ELF 可执行文件</a></li>
<li><a href="https://people.freebsd.org/~brooks/talks/asiabsdcon2017-helloworld/helloworld.pdf">在 FreeBSD 上探索 “hello world”</a></li>
<li>[微观视角下的 Windows 中 “Hello World”][23A]</li>
<li>来自 LWN 的文章：<a href="https://lwn.net/Articles/630727/">如何运行程序</a> （<a href="https://lwn.net/Articles/631631/">以及第二部分</a>）详尽介绍了 <code>execve</code> 的内部机制</li>
<li>Lexi Mattick 的文章，<a href="https://cpu.land/how-to-run-a-program">赋予 CPU “你” 的存在</a></li>
<li><a href="https://www.youtube.com/watch?v=LnzuMJLZRdU">从零开始在 6502 上实现 “Hello, World”</a> （来自 Ben Eater 的视频）</li>
</ul>
<p><em>（题图：MJ/b87ed0a2-80d6-49cd-b2bf-1ef822485e3f）</em></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>