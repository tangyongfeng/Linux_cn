<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>利用 Vely 在 Linux 构建你自己的 SaaS</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Sergio Mijatovic Vely 可让你在网络应用程序中利用 C 语言的强大功能。 Vely 将 C 语言的高性能和低内存占用与 PHP 等语言的易用性和 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2023/12/li-yong-vely-zai-linux-gou-jian-ni-zi-ji-de-saas.html" rel="bookmark"
           title="Permalink to 利用 Vely 在 Linux 构建你自己的 SaaS">利用 Vely 在 Linux 构建你自己的 SaaS</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-12-12T11:09:46+01:00">
                Published: Tue 12 December 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Sergio Mijatovic</p>
<p><img alt="" src="/data/attachment/album/202312/12/110902myyfcm3hdmwqv3zy.jpg"></p>
<blockquote>
<p>Vely 可让你在网络应用程序中利用 C 语言的强大功能。</p>
</blockquote>
<p><a href="https://opensource.com/article/22/5/write-c-appplications-vely-linux">Vely</a> 将 C 语言的高性能和低内存占用与 PHP 等语言的易用性和安全性相结合。作为自由开源软件，它以 GPLv3 和 LGPL 3 授权，所以你甚至可以用它来构建商业软件。</p>
<h3>利用 Vely 构建 SaaS</h3>
<p>你可以使用 Vely 创建一个多租户网络应用程序，它可以作为软件即服务模式（SaaS）在互联网上运行。每个用户都有一个完全独立的数据空间。</p>
<p>在这个网络应用程序示例中，用户可以注册一个笔记本服务来创建笔记，然后查看和删除它们。它仅用了 7 个源文件，310 行代码，就展示了如何集成多项技术:</p>
<ul>
<li>MariaDB</li>
<li>网络浏览器</li>
<li>Apache</li>
<li>Unix 套接字</li>
</ul>
<h4>运作原理</h4>
<p>以下是从用户的角度来看应用程序是如何工作的。下图是代码演示。</p>
<p>该应用允许用户通过指定电子邮件地址和密码创建新的登录名。你可以用任何你喜欢的方式设置它们，例如运用 CSS：</p>
<p><img alt="创建一个用户账户" src="/data/attachment/album/202312/12/110946trmkfsf1l1m6ylr1.png"></p>
<p>验证用户的电子邮件:</p>
<p><img alt="验证用户的电子邮件地址" src="/data/attachment/album/202312/12/110946vow5z3f1qpsvxqpv.png"></p>
<p>每个用户使用自己独有的用户名和密码登录：</p>
<p><img alt="用户登录" src="/data/attachment/album/202312/12/110946qsntseszsji9xies.png"></p>
<p>一旦登录，用户就可以添加笔记：</p>
<p><img alt="用户可以添加笔记" src="/data/attachment/album/202312/12/110947be001fcv110een44.png"></p>
<p>用户可以获取笔记列表：</p>
<p><img alt="用户列举笔记" src="/data/attachment/album/202312/12/110947ffc1f6vcbefpcfp8.png"></p>
<p>删除笔记之前，应用会申请确认信息：</p>
<p><img alt="删除笔记之前，应用会申请确认信息" src="/data/attachment/album/202312/12/110947o70sv2jxqb0sk0kj.png"></p>
<p>用户确认后，笔记被删除：</p>
<p><img alt="用户确认后，笔记被删除" src="/data/attachment/album/202312/12/110948p13ha0s2281zm44u.png"></p>
<h4>设置先决条件</h4>
<p>遵照 <a href="https://vely.dev/">Vely.dev</a> 上的安装指示。这是一个使用 DNF、APT、Pacman 或者 Zypper 等标准工具包的快速流程。</p>
<p>由于它们都是这个范例的一部分，你必须安装 Apache 作为网络服务器，安装 MariaDB 作为数据库。</p>
<p>安装 Vely 后，如使用 Vim，打开里面的“语法高亮显示”：</p>
<div class="highlight"><pre><span></span><code>vv -m
</code></pre></div>

<h4>获取源代码</h4>
<p>这个演示 SaaS 应用程序的源代码是 Vely 安装的一部分。为每个应用程序创建一个单独的源代码目录不失为一个好主意（而且你可以按自己喜好命名）。在这种情况下，解包源代码会帮你完成这些工作:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>tar<span class="w"> </span>xvf<span class="w"> </span><span class="k">$(</span>vv<span class="w"> </span>-o<span class="k">)</span>/examples/multitenant_SaaS.tar.gz
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>multitenant_SaaS
</code></pre></div>

<p>默认情况下，该应用程序以 <code>multitenant_SaaS</code> 命名，但你可以将其命名为任何内容（如果这么做，其他每个地方你都需要改一下）。</p>
<h3>创建应用程序</h3>
<p>第一步是创建一个应用程序。使用 Vely 的 <code>vf</code> 工具就可以轻松完成：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>vf<span class="w"> </span>-i-u<span class="w"> </span><span class="k">$(</span>whoami<span class="k">)</span><span class="w"> </span>multitenant_SaaS
</code></pre></div>

<p>这个命令创建了一个新的应用程序主目录（<code>/var/lib/vv/multitenant_SaaS</code>），并帮你执行应用程序设置。通常，这意味着在该主目录中创建各种子目录并分配权限。在这种情况下，只有当前用户（<code>whoami</code> 的结果）拥有目录，具有 <code>0700</code> 权限，这确保了其他人没有访问文件的权限。</p>
<h3>创建数据库</h3>
<p>在你键入任何代码之前，你需要一个能够存储该应用程序所用信息的空间。首先，创建一个名为 <code>db_multitenant_SaaS</code> 的 MariaDB 数据库，由用户名为 <code>vely</code> 的用户所有，密码为 <code>your_password</code> 。你可以修改刚才提到的任何值，但得记住，在这个示例里，你需要将包含这些内容的每个地方都得修改一遍。</p>
<p>在 MySQL 中以 root 身份登录：</p>
<div class="highlight"><pre><span></span><code>create database if not exists db_multitenant_SaaS;
create user if not exists vely identified by &#39;your_password&#39;;
grant create,alter,drop,select,insert,delete,update on db_multitenant_SaaS.* to vely;
</code></pre></div>

<p>然后在数据库内创建数据库对象（表，记录等等）：</p>
<div class="highlight"><pre><span></span><code>use db_multitenant_SaaS;
source setup.sql;
exit
</code></pre></div>

<h3>将 Vely 连接至数据库</h3>
<p>为了让 Vely 知晓你数据库的位置以及如何登录进去，创建一个名为 <code>db_multitenant_SaaS</code> 的数据库配置文件。（该名称用于在源代码中的数据库声明，所以如果你改了它，确保在它存在的每个地方都改一遍。）</p>
<p>Vely 使用原生的 MariaDB 数据库连接，因此你可以指定给定的数据库所能允许的任何选项:</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s1">&#39;[client]</span>
<span class="s1">user=vely</span>
<span class="s1">password=your_password</span>
<span class="s1">database=db_multitenant_SaaS</span>
<span class="s1">protocol=TCP</span>
<span class="s1">host=127.0.0.1</span>
<span class="s1">port=3306&#39;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">db_multitenant_SaaS</span>
</code></pre></div>

<h3>构建应用程序</h3>
<p>使用 <code>vv</code> 工具构建应用程序，利用 <code>--db</code> 选项指定 MariaDB 数据库和数据库配置文件：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>vv<span class="w"> </span>-q--db<span class="o">=</span>mariadb:db_multitenant_SaaS
</code></pre></div>

<h3>启用应用服务器</h3>
<p>启动你的网络应用程序的服务器，需要使用 <code>vf</code> FastCGI 进程管理器。应用程序服务器使用 Unix 套接字与网络服务器（创建反向代理）通信：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>vf<span class="w"> </span>-w3<span class="w"> </span>multitenant_SaaS
</code></pre></div>

<p>这么做会启用三个守护进程，为接收到的请求提供服务。你也可以启动一个自适应服务器，它会增加进程的数量从而服务更多的请求，并在不需要他们时减少进程的数量：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>vf<span class="w"> </span>multitenant_SaaS
</code></pre></div>

<p>请参阅 <code>vf</code> 了解更多选项，以帮助你实现最佳性能。</p>
<p>当你需要停止你的应用程序服务器，使用 <code>-m quit</code> 选项：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>vf<span class="w"> </span>-m<span class="w"> </span>quit<span class="w"> </span>multitenant_SaaS
</code></pre></div>

<h3>创建网络服务器</h3>
<p>这是一个网络应用程序，那么应用程序就得需要一个网络服务器。该示例通过一个 Unix 套接字监听器使用 Apache。</p>
<h4>1、设置 Apache</h4>
<p>将 Apache 配置为一个反向代理，并将你的应用程序与之连接，你需要启用 FastCGI 代理支持，这通常使用 <code>proxy</code> 和 <code>proxy_fcgi</code> 模块。</p>
<p>对于 Fedora 系统（或者其它的，比如 Arch）来说，通过在 Apache 配置文件 <code>/etc/httpd/conf/httpd.conf</code> 中添加（或取消注释）适当的 <code>LoadModule</code> 指令，就可启用 <code>proxy</code> 和 <code>proxy_fcgi</code> 模块。</p>
<p>以下指令适用于 Debian，Ubuntu 以及类似的系统，启用 <code>proxy</code> 和 <code>proxy_fcgi</code> 模块：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>a2enmod<span class="w"> </span>proxy
$<span class="w"> </span>sudo<span class="w"> </span>a2enmod<span class="w"> </span>proxy_fcgi
</code></pre></div>

<p>以下指令适用于 OpenSUSE，将这几行添加在 <code>/etc/apache2/httpd.conf</code> 结尾处：</p>
<div class="highlight"><pre><span></span><code>LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
</code></pre></div>

<h4>2、配置 Apache</h4>
<p>现在你必须将代理信息添加在 Apache 的配置文件中：</p>
<div class="highlight"><pre><span></span><code><span class="n">ProxyPass</span><span class="w"> </span><span class="s2">&quot;/multitenant_SaaS&quot;</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">///</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">vv</span><span class="o">/</span><span class="n">multitenant_SaaS</span><span class="o">/</span><span class="n">sock</span><span class="o">/</span><span class="n">sock</span><span class="o">|</span><span class="n">fcgi</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="o">/</span><span class="n">multitenant_SaaS</span>
</code></pre></div>

<p>你的配置文件的位置可能会有所不同，这取决于不同的 Linux 发行版：</p>
<ul>
<li>Fedora、CentOS、Mageia 和 Arch： <code>/etc/httpd/conf/httpd.conf</code></li>
<li>Debian、Ubuntu、Mint： <code>/etc/apache2/apache2.conf</code></li>
<li>OpenSUSE：<code>/etc/apache2/httpd.conf</code></li>
</ul>
<h4>3、重新启动</h4>
<p>最后，重启 Apache。在 Fedora 和类似系统，还有 Arch Linux 是如下指令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>httpd
</code></pre></div>

<p>在 Debian 和基于 Debian 的系统，还有 OpenSUSE 是如下指令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>apache2
</code></pre></div>

<h3>设置本地邮箱</h3>
<p>这个示例中，电子邮件是其功能的一部分。如果你的服务器已经可以发送电子邮件了，你可以跳过这一条。此外，你可以使用本地邮箱（<code>myuser@localhost</code>）来测试它。要做到这一点，需安装 Sendmail。</p>
<p>在 Fedora 和类似系统中是如下指令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>installsendmail
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>sendmail
</code></pre></div>

<p>而在 Debian 和类似系统（如 Ubuntu）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>installsendmail
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>sendmail
</code></pre></div>

<p>当应用程序向本地用户发送电子邮件，比如说 <code>OS_user@localhost</code>，你就可以通过查看 <code>/var/mail/</code> 处（即所谓“邮件池”）来确认电子邮件是否被发送。</p>
<h3>从浏览器访问应用服务器</h3>
<p>假设你在本地运行该应用，可以通过使用 <code>http://127.0.0.1/multitenant_SaaS?req=notes&amp;action=begin</code> 域名从你的网络服务器访问你的应用服务器。如果你在互联网上的在线服务器运行该程序，你可能就需要调整防火墙设置以允许 HTTP 通信。</p>
<h3>源代码</h3>
<p>该应用程序示例包含 7 个源文件。你可以自行回顾代码（记住，这些文件只有 310 行代码），下面是每个文件的概述。</p>
<h4>SQL 设置（setup.sql）</h4>
<p>创建的两个表：</p>
<ul>
<li><code>users</code>：每个用户的信息。在 <code>users</code> 表中，每个用户都有自己唯一的 ID （<code>userId</code> 列），以及其他信息，如电子邮件地址和该地址是否通过了验证。还有一个哈希密码。实际的密码永远不会存储在纯文本（或其他形式）中，单向哈希用于检查密码。</li>
<li><code>notes</code>：用户输入的笔记。<code>notes</code> 表包含了所有的笔记，每个笔记都有一个 <code>userId</code> 列，表示哪个用户拥有它们。<code>userId</code> 列的值与 <code>users</code> 表中的同名列匹配。这样，每个笔记显然都属于单个用户。</li>
</ul>
<p>该文件内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="n">notes</span><span class="w"> </span><span class="p">(</span><span class="n">dateOf</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">noteId</span><span class="w"> </span><span class="n">bigint</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="n">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">note</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
<span class="n">create</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">userId</span><span class="w"> </span><span class="n">bigint</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w"> </span><span class="n">hashed_pwd</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="w"> </span><span class="n">verified</span><span class="w"> </span><span class="n">smallint</span><span class="p">,</span><span class="w"> </span><span class="n">verify_token</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="n">create</span><span class="w"> </span><span class="n">unique</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="n">users1</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="p">);</span>
</code></pre></div>

<h4>运行时数据（login.h）</h4>
<p>为了正确地显示登录、注册和注销链接，你需要一些在应用程序中任何地方都可以使用的标志。此外，应用程序使用 cookie 来维护会话，因此它需要在任何地方都可用，例如，验证会话是否有效。发送到应用程序的每个请求都以这种方式进行确认。只有带有可验证 cookie 的请求是允许的。</p>
<p>所以要做到这种效果，你需要有一个 <code>global_request_data</code> 类型的 <code>reqdata</code>（请求数据），其中包含 <code>sess_userId</code>（用户的 ID）以及 <code>sess_id</code>（用户目前的会话 ID）。此外，还有一些不言自明的标志，可以帮助渲染页面：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifndef _VV_LOGIN</span>
<span class="cp">#define _VV_LOGIN</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">s_reqdata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">displayed_logout</span><span class="p">;</span><span class="w"> </span><span class="c1">// true 则显示登出连接</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_logged_in</span><span class="p">;</span><span class="w"> </span><span class="c1">// true 则会话已验证登录</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">sess_userId</span><span class="p">;</span><span class="w"> </span><span class="c1">// 目前会话的用户 ID</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">sess_id</span><span class="p">;</span><span class="w"> </span><span class="c1">// 会话 ID</span>
<span class="p">}</span><span class="w"> </span><span class="n">reqdata</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">login_or_signup</span><span class="w"> </span><span class="p">();</span>

<span class="cp">#endif</span>
</code></pre></div>

<h4>会话检查和会话数据（_before.vely）</h4>
<p>Vely 里有一个 <ruby> 请求前处理程序 <rt>  before_request handler </rt></ruby> 的概念。你写的代码会在其它处理请求的代码之前执行的。要达到这个目的，你只需要将这样的代码写在名为 <code>_before.vely</code> 的文件中，然后剩余的部分将会自动处理。</p>
<p>SaaS 应用程序所作的任何事情，例如处理发送至应用程序的请求，必须验证其安全性。这样，应用程序就能知晓调用方是否有执行操作所需要的权限。</p>
<p>在这里，通过请求前处理程序进行权限检查。这样，无论其他代码如何处理请求，都已经掌握了会话信息。</p>
<p>为保持会话数据（比如会话 ID 和用户 ID）在你代码中的任何地方都可用，你可以使用 <code>global_request_data</code>。它只是一个指向内存的通用指针（<code>void*</code>），任何处理请求的代码都可以访问它。这非常适合处理会话，如下所示:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;vely.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;login.h&quot;</span>

<span class="c1">// _before() 是一个请求前处理程序。</span>
<span class="c1">// 它总是在处理请求的其他代码之前执行。</span>
<span class="c1">// 对于任何类型的请求范围设置或数据初始化，它都是一个很好的位置。</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">_before</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 输出 HTTP 请求头</span>
<span class="w">    </span><span class="n">out</span><span class="o">-</span><span class="n">header</span><span class="w"> </span><span class="k">default</span>
<span class="w">    </span><span class="n">reqdata</span><span class="w"> </span><span class="o">*</span><span class="n">rd</span><span class="p">;</span><span class="w"> </span><span class="c1">// 这是全局请求数据，见 login.h</span>
<span class="w">    </span><span class="c1">// 为全局请求数据分配内存，</span>
<span class="w">    </span><span class="c1">// 将在请求结束时自动释放</span>
<span class="w">    </span><span class="n">new</span><span class="o">-</span><span class="n">mem</span><span class="w"> </span><span class="n">rd</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">reqdata</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// 初始化标志</span>
<span class="w">    </span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">displayed_logout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">is_logged_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 将我们创建的数据设置为全局请求数据，</span>
<span class="w">    </span><span class="c1">// 可以从任何处理请求的代码中访问</span>
<span class="w">    </span><span class="n">set</span><span class="o">-</span><span class="n">req</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">rd</span>
<span class="w">    </span><span class="c1">// 检查会话是否存在（基于来自客户端的 cookie）</span>
<span class="w">    </span><span class="c1">// 这在任何其他请求处理代码之前执行，</span>
<span class="w">    </span><span class="c1">// 使其更容易准备好会话信息</span>
<span class="w">    </span><span class="n">_check_session</span><span class="w"> </span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h4>检查会话是否有效（_check_session.vely）</h4>
<p>多租户 SaaS 应用程序中最重要的任务之一就是通过检查用户是否登录来（尽快）检查会话是否有效。这是通过从客户端（例如网络浏览器）获取会话 ID 和用户 ID 的 cookie，并将它们与存储会话的数据库进行比较来实现的：</p>
<div class="highlight"><pre><span></span><code>#include<span class="w"> </span>&quot;vely.h&quot;
#include<span class="w"> </span>&quot;login.h&quot;


//<span class="w"> </span>检查会话是否有效
void<span class="w"> </span>_check_session<span class="w"> </span>()<span class="w"> </span>{
<span class="w">    </span>//<span class="w"> </span>获取全局请求数据
<span class="w">    </span>reqdata<span class="w"> </span>*rd;
<span class="w">    </span>get-req<span class="w"> </span>data<span class="w"> </span>to<span class="w"> </span>rd
<span class="w">    </span>//<span class="w"> </span>自用户浏览器获取<span class="w"> </span>cookies
<span class="w">    </span>get-cookie<span class="w"> </span>rd-&gt;sess_userId=&quot;sess_userId&quot;
<span class="w">    </span>get-cookie<span class="w"> </span>rd-&gt;sess_id=&quot;sess_id&quot;
<span class="w">    </span>if<span class="w"> </span>(rd-&gt;sess_id[0]<span class="w"> </span>!=<span class="w"> </span>0)<span class="w"> </span>{
<span class="w">        </span>//<span class="w"> </span>检查给定用户<span class="w"> </span>ID<span class="w"> </span>下的会话<span class="w"> </span>ID<span class="w"> </span>是否正确
<span class="w">        </span>char<span class="w"> </span>*email;
<span class="w">        </span>run-query<span class="w"> </span>@db_multitenant_SaaS<span class="w"> </span>=<span class="w"> </span>&quot;select<span class="w"> </span>email<span class="w"> </span>from<span class="w"> </span>users<span class="w"> </span>where<span class="w"> </span>userId=&#39;%s&#39;<span class="w"> </span>and<span class="w"> </span>session=&#39;%s&#39;&quot;<span class="w"> </span>output<span class="w"> </span>email<span class="w"> </span>:<span class="w"> </span>rd-&gt;sess_userId,<span class="w"> </span>rd-&gt;sess_id<span class="w"> </span>row-count<span class="w"> </span>define<span class="w"> </span>rcount
<span class="w">            </span>query-result<span class="w"> </span>email<span class="w"> </span>to<span class="w"> </span>email
<span class="w">        </span>end-query
<span class="w">        </span>if<span class="w"> </span>(rcount<span class="w"> </span>==<span class="w"> </span>1)<span class="w"> </span>{
<span class="w">            </span>//<span class="w"> </span>如果正确，设置登录标志
<span class="w">            </span>rd-&gt;is_logged_in<span class="w"> </span>=<span class="w"> </span>true;
<span class="w">            </span>//<span class="w"> </span>如果登出链接不显示，则显示它
<span class="w">            </span>if<span class="w"> </span>(rd-&gt;displayed_logout<span class="w"> </span>==<span class="w"> </span>false)<span class="w"> </span>{
<span class="w">                </span>@Hi<span class="w"> </span><span class="err">&lt;</span><span class="nt">&lt;p-out</span><span class="w"> </span><span class="err">email</span><span class="nt">&gt;</span>&gt;!<span class="w"> </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;https://opensource.com/?req=login&amp;action=logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;&lt;br/&gt;</span>
<span class="w">                </span>rd-&gt;displayed_logout<span class="w"> </span>=<span class="w"> </span>true;
<span class="w">            </span>}
<span class="w">        </span>}<span class="w"> </span>else<span class="w"> </span>rd-&gt;is_logged_in<span class="w"> </span>=<span class="w"> </span>false;
<span class="w">    </span>}
}
</code></pre></div>

<h4>注册、登录、登出（login.vely）</h4>
<p>任何多租户系统的基础便是具有用户注册\登录和登出的功能。通常情况下，注册包括验证电子邮件地址；不止于此，同一电子邮件地址会作为一个用户名。这里就是这种情况。</p>
<p>这里实现了几个执行该功能所必须的子请求：</p>
<ul>
<li>注册新用户时，显示 HTML 表单以收集信息。它的 URL 请求签名是 <code>req=login&amp;action=newuser</code>。</li>
<li>作为对注册表单的响应，创建一个新用户。URL 请求的签名是 <code>req=login&amp;action=createuser</code>。输入参数（<code>input-param</code>）信号获取 <code>email</code> 和 <code>pwd</code> 的 POST 表单字段。密码值是单向散列，电子邮件验证令牌是一个随机的 5 位数字。这些被插入到 <code>users</code> 表中，创建一个新用户。系统会发送一封验证邮件，并提示用户阅读邮件并输入代码。</li>
<li>通过输入发送到该电子邮件的验证码来验证电子邮件。URL 请求的签名是 <code>req=login&amp;action=verify</code>。</li>
<li>显示一个登录表单，让用户登录。URL 请求的签名是 <code>req=login</code>（例如，<code>action</code> 为空）。</li>
<li>通过验证电子邮件地址（用户名）和密码登录。URL 请求的签名是 <code>req=login&amp;action=login</code>。</li>
<li>应用户要求登出。URL 请求的签名是 <code>req=login&amp;action=logout</code>。</li>
<li>应用程序的登录页。URL 请求的签名是 <code>req=login&amp;action=begin</code>。</li>
<li>如果用户当前已登录，转到应用程序的登录页面。</li>
</ul>
<p>可以看看下面这些例子：</p>
<div class="highlight"><pre><span></span><code><span class="c1">#include &quot;vely.h&quot;</span>
<span class="c1">#include &quot;login.h&quot;</span>

// <span class="n">处理云端多租户应用程序的会话维护</span>、<span class="n">登录</span>、<span class="n">注销</span>、<span class="n">会话验证</span>
<span class="n">void</span> <span class="n">login</span> () {
    // <span class="n">获取</span> <span class="n">URL</span> <span class="n">的输入参数</span> `<span class="nb">action</span>`
    <span class="n">input-param</span> <span class="nb">action</span>

    // <span class="n">获取全局请求数据</span>，<span class="n">我们在其中记录会话信息</span>，<span class="n">所以它很方便</span>
    <span class="n">reqdata</span> *<span class="n">rd</span>;
    <span class="n">get-req</span> <span class="n">data</span> <span class="nb">to</span> <span class="n">rd</span>

    // <span class="n">如果会话已经建立</span>，<span class="n">我们不会</span>
    // <span class="n">继续到应用程序主页的唯一原因是我们正在登出</span>
    <span class="k">if</span> (<span class="n">rd-</span>&gt;<span class="n">is_logged_in</span>) {
        <span class="k">if</span> (<span class="n">strcmp</span>(<span class="nb">action</span>, <span class="s">&quot;logout&quot;</span>)) {
            <span class="n">_show_home</span>();
            <span class="n">exit-request</span>
        }
    }

    // <span class="n">应用程序页面启动</span>。<span class="n">显示登录或注册的链接</span>，
    // <span class="n">并显示适当的主屏幕</span>
    <span class="k">if</span> (!<span class="n">strcmp</span> (<span class="nb">action</span>, <span class="s">&quot;begin&quot;</span>)) {
        <span class="n">_show_home</span>();
        <span class="n">exit-request</span>

    // <span class="n">开始创建新用户</span>。<span class="n">询问电子邮件和密码</span>，
    // <span class="n">然后提交此表单时创建用户</span>。
    } <span class="k">else</span> <span class="k">if</span> (!<span class="n">strcmp</span> (<span class="nb">action</span>, <span class="s">&quot;newuser&quot;</span>)) {
        <span class="nv">@Create</span> <span class="n">New</span> <span class="n">User</span><span class="s">&lt;hr/&gt;</span>
        @<span class="s">&lt;form action=&quot;https://opensource.com/?req=login&quot; method=&quot;POST&quot;&gt;</span>
        @<span class="s">&lt;input name=&quot;action&quot; type=&quot;hidden&quot; value=&quot;createuser&quot;&gt;</span>
        @<span class="s">&lt;input name=&quot;email&quot; type=&quot;text&quot; value=&quot;&quot; size=&quot;50&quot; maxlength=&quot;50&quot; required autofocus placeholder=&quot;Email&quot;&gt;</span>
        @<span class="s">&lt;input name=&quot;pwd&quot; type=&quot;password&quot; value=&quot;&quot; size=&quot;50&quot; maxlength=&quot;50&quot; required placeholder=&quot;Password&quot;&gt;</span>
        @<span class="s">&lt;input type=&quot;submit&quot; value=&quot;Sign Up&quot;&gt;</span>
        @<span class="s">&lt;/form&gt;</span>

    // <span class="n">验证用户发送到电子邮件的代码</span>。<span class="n">代码必须匹配</span>，<span class="n">从而验证电子邮件地址</span>   
    } <span class="k">else</span> <span class="k">if</span> (!<span class="n">strcmp</span> (<span class="nb">action</span>, <span class="s">&quot;verify&quot;</span>)) {
        <span class="n">input-param</span> <span class="nb">code</span>
        <span class="n">input-param</span> <span class="n">email</span>
        // <span class="n">获取基于电子邮件的验证令牌</span>
        <span class="n">run-query</span> <span class="nv">@db_multitenant_SaaS</span> = <span class="s">&quot;select verify_token from users where email=&#39;%s&#39;&quot;</span> <span class="n">output</span> <span class="n">db_verify</span> : <span class="n">email</span>
            <span class="n">query-result</span> <span class="n">db_verify</span> <span class="nb">to</span> <span class="n">define</span> <span class="n">db_verify</span>
            // <span class="n">将数据库中记录的令牌与用户提供的令牌进行比较</span>
            <span class="k">if</span> (!<span class="n">strcmp</span> (<span class="nb">code</span>, <span class="n">db_verify</span>)) {
                <span class="nv">@Your</span> <span class="n">email</span> <span class="k">has</span> <span class="n">been</span> <span class="n">verifed</span>. <span class="n">Please</span> <span class="s">&lt;a href=&quot;https://opensource.com/?req=login&quot;&gt;</span><span class="n">Login</span><span class="s">&lt;/a&gt;</span>.
                // <span class="n">如果匹配</span>，<span class="n">更新用户信息以表明已验证</span>。
                <span class="n">run-query</span> <span class="nv">@db_multitenant_SaaS</span> <span class="n">no-loop</span> = <span class="s">&quot;update users set verified=1 where email=&#39;%s&#39;&quot;</span> : <span class="n">email</span>
                <span class="n">exit-request</span>
            }
        <span class="n">end-query</span>
        <span class="nv">@Could</span> <span class="nb">not</span> <span class="n">verify</span> <span class="n">the</span> <span class="nb">code</span>. <span class="n">Please</span> <span class="k">try</span> <span class="s">&lt;a href=&quot;https://opensource.com/?req=login&quot;&gt;</span><span class="n">again</span><span class="s">&lt;/a&gt;</span>.
        <span class="n">exit-request</span>

    // <span class="n">创建用户</span> —— <span class="n">当用户使用电子邮件和密码提交表单以创建用户时运行</span>    
    } <span class="k">else</span> <span class="k">if</span> (!<span class="n">strcmp</span> (<span class="nb">action</span>, <span class="s">&quot;createuser&quot;</span>)) {
        <span class="n">input-param</span> <span class="n">email</span>
        <span class="n">input-param</span> <span class="n">pwd</span>
        // <span class="n">创建散列</span>（<span class="n">单向</span>）<span class="n">密码</span>
        <span class="n">hash-string</span> <span class="n">pwd</span> <span class="nb">to</span> <span class="n">define</span> <span class="n">hashed_pwd</span>
        // <span class="n">生成随机的</span> <span class="mi">5</span> <span class="n">位数字字符串验证代码</span>
        <span class="n">random-string</span> <span class="nb">to</span> <span class="n">define</span> <span class="n">verify</span> <span class="n">length</span> <span class="mi">5</span> <span class="n">number</span>
        // <span class="n">创建用户</span>：<span class="n">插入电子邮件</span>、<span class="n">哈希密码</span>、<span class="n">验证令牌</span>。<span class="n">当前验证状态为</span> <span class="mi">0</span>，<span class="n">或未验证</span>
        <span class="n">begin-transaction</span> <span class="nv">@db_multitenant_SaaS</span>
        <span class="n">run-query</span> <span class="nv">@db_multitenant_SaaS</span> <span class="n">no-loop</span> = <span class="s">&quot;insert into users (email, hashed_pwd, verified, verify_token, session) values (&#39;%s&#39;, &#39;%s&#39;, &#39;0&#39;, &#39;%s&#39;, &#39;&#39;)&quot;</span> : <span class="n">email</span>, <span class="n">hashed_pwd</span>, <span class="n">verify</span> <span class="n">affected-rows</span> <span class="n">define</span> <span class="n">arows</span> <span class="n">error</span> <span class="n">define</span> <span class="n">err</span> <span class="n">on-error-continue</span>
        <span class="k">if</span> (<span class="n">strcmp</span> (<span class="n">err</span>, <span class="s">&quot;0&quot;</span>) || <span class="n">arows</span> != <span class="mi">1</span>) {
            // <span class="n">如果不能添加用户</span>，<span class="n">则可能该用户不存在</span>。<span class="n">不管怎样</span>，<span class="n">我们都无法继续</span>。
            <span class="n">login_or_signup</span>();
            <span class="nv">@User</span> <span class="k">with</span> <span class="n">this</span> <span class="n">email</span> <span class="n">already</span> <span class="n">exists</span>.
            <span class="n">rollback-transaction</span> <span class="nv">@db_multitenant_SaaS</span>
        } <span class="k">else</span> {
            // <span class="n">创建带有验证码的电子邮件并将其发送给用户</span>
            <span class="n">write-string</span> <span class="n">define</span> <span class="n">msg</span>
                <span class="nv">@From:</span> <span class="n">vely</span><span class="nv">@vely</span>.<span class="n">dev</span>
                <span class="nv">@To:</span> <span class="s">&lt;&lt;p-out email&gt;</span>&gt;
                <span class="nv">@Subject:</span> <span class="n">verify</span> <span class="n">your</span> <span class="n">account</span>
                @
                <span class="nv">@Your</span> <span class="n">verification</span> <span class="nb">code</span> <span class="n">is:</span> <span class="s">&lt;&lt;p-out verify&gt;</span>&gt;
            <span class="n">end-write-string</span>
            <span class="n">exec-program</span> <span class="s">&quot;/usr/sbin/sendmail&quot;</span> <span class="nb">args</span> <span class="s">&quot;-i&quot;</span>, <span class="s">&quot;-t&quot;</span> <span class="n">input</span> <span class="n">msg</span> <span class="nb">status</span> <span class="n">define</span> <span class="n">st</span>
            <span class="k">if</span> (<span class="n">st</span> != <span class="mi">0</span>) {
                <span class="nv">@Could</span> <span class="nb">not</span> <span class="nb">send</span> <span class="n">email</span> <span class="nb">to</span> <span class="s">&lt;&lt;p-out email&gt;</span>&gt;, <span class="nb">code</span> <span class="k">is</span> <span class="s">&lt;&lt;p-out verify&gt;</span>&gt;
                <span class="n">rollback-transaction</span> <span class="nv">@db_multitenant_SaaS</span>
                <span class="n">exit-request</span>
            }
            <span class="n">commit-transaction</span> <span class="nv">@db_multitenant_SaaS</span>
            // <span class="n">通知用户查看邮件并输入验证码</span>
            <span class="nv">@Please</span> <span class="n">check</span> <span class="n">your</span> <span class="n">email</span> <span class="o">and</span> <span class="n">enter</span> <span class="n">verification</span> <span class="nb">code</span> <span class="n">here:</span>
            @<span class="s">&lt;form action=&quot;https://opensource.com/?req=login&quot; method=&quot;POST&quot;&gt;</span>
            @<span class="s">&lt;input name=&quot;action&quot; type=&quot;hidden&quot; value=&quot;verify&quot; size=&quot;50&quot; maxlength=&quot;50&quot;&gt;</span>
            @<span class="s">&lt;input name=&quot;email&quot; type=&quot;hidden&quot; value=&quot;&lt;&lt;p-out email&gt;</span>&gt;<span class="s">&quot;&gt;</span>
<span class="s">            @&lt;input name=&quot;</span><span class="nb">code</span><span class="s">&quot; type=&quot;</span><span class="n">text</span><span class="s">&quot; value=&quot;&quot; size=&quot;</span><span class="mi">50</span><span class="s">&quot; maxlength=&quot;</span><span class="mi">50</span><span class="s">&quot; required autofocus placeholder=&quot;</span><span class="n">Verification</span> <span class="nb">code</span><span class="s">&quot;&gt;</span>
<span class="s">            @&lt;button type=&quot;</span><span class="n">submit</span><span class="s">&quot;&gt;Verify&lt;/button&gt;</span>
<span class="s">            @&lt;/form&gt;</span>
<span class="s">        }</span>

<span class="s">    // 这里在登录用户登出时运行    </span>
<span class="s">    } else if (!strcmp (action, &quot;</span><span class="n">logout</span><span class="s">&quot;)) {</span>
<span class="s">        // 更新用户表以清除会话，即没有该用户登录</span>
<span class="s">        if (rd-&gt;is_logged_in) {</span>
<span class="s">            run-query @db_multitenant_SaaS = &quot;</span><span class="n">update</span> <span class="n">users</span> <span class="n">set</span> <span class="n">session</span>=<span class="s">&#39;&#39;</span> <span class="n">where</span> <span class="n">userId</span>=<span class="s">&#39;%s&#39;&quot; : rd-&gt;sess_userId no-loop affected-rows define arows</span>
<span class="s">            if (arows == 1) {</span>
<span class="s">                rd-&gt;is_logged_in = false; // 提示用户未登录</span>
<span class="s">                @You have been logged out.&lt;hr/&gt;</span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">        _show_home();</span>

<span class="s">    // 登录：当用户输入用户名和密码时运行</span>
<span class="s">    } else if (!strcmp (action, &quot;</span><span class="n">login</span><span class="s">&quot;)) {</span>
<span class="s">        input-param pwd</span>
<span class="s">        input-param email</span>
<span class="s">        // 创建单向散列，目的是与用户表进行比较 —— 密码**永远不会**被记录</span>
<span class="s">        hash-string pwd to define hashed_pwd</span>
<span class="s">        // 为会话 ID 创建一个随机的 30 位长的字符串</span>
<span class="s">        random-string to rd-&gt;sess_id length 30</span>
<span class="s">        // 检查用户名和哈希密码是否匹配</span>
<span class="s">        run-query @db_multitenant_SaaS = &quot;</span><span class="n">select</span> <span class="n">userId</span> <span class="nb">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">email</span>=<span class="s">&#39;%s&#39;</span> <span class="o">and</span> <span class="n">hashed_pwd</span>=<span class="s">&#39;%s&#39;&quot; output sess_userId : email, hashed_pwd</span>
<span class="s">            query-result sess_userId to rd-&gt;sess_userId</span>
<span class="s">            // 如果匹配，使用会话 ID 更新用户表</span>
<span class="s">            run-query @db_multitenant_SaaS no-loop = &quot;</span><span class="n">update</span> <span class="n">users</span> <span class="n">set</span> <span class="n">session</span>=<span class="s">&#39;%s&#39;</span> <span class="n">where</span> <span class="n">userId</span>=<span class="s">&#39;%s&#39;&quot; : rd-&gt;sess_id, rd-&gt;sess_userId affected-rows define arows</span>
<span class="s">            if (arows != 1) {</span>
<span class="s">                @Could not create a session. Please try again. &lt;&lt;.login_or_signup();&gt;&gt; &lt;hr/&gt;</span>
<span class="s">                exit-request</span>
<span class="s">            }</span>
<span class="s">            // 设置“用户 ID”和“会话 ID”为 cookie。用户的浏览器将在每个请求中返回这些信息</span>
<span class="s">            set-cookie &quot;</span><span class="n">sess_userId</span><span class="s">&quot; = rd-&gt;sess_userId</span>
<span class="s">            set-cookie &quot;</span><span class="n">sess_id</span><span class="s">&quot; = rd-&gt;sess_id</span>
<span class="s">            // 显示主页，确保会话是正确的，并设置标志</span>
<span class="s">            _check_session();</span>
<span class="s">            _show_home();</span>
<span class="s">            exit-request</span>
<span class="s">        end-query</span>
<span class="s">        @Email or password are not correct. &lt;&lt;.login_or_signup();&gt;&gt;&lt;hr/&gt;</span>

<span class="s">    // 登录界面，要求用户输入用户名和密码  </span>
<span class="s">    } else if (!strcmp (action, &quot;&quot;)) {</span>
<span class="s">        login_or_signup();</span>
<span class="s">        @Please Login:&lt;hr/&gt;</span>
<span class="s">        @&lt;form action=&quot;</span><span class="n">https:</span>//<span class="n">opensource</span>.<span class="n">com</span>/?<span class="n">req</span>=<span class="n">login</span><span class="s">&quot; method=&quot;</span><span class="k">POST</span><span class="s">&quot;&gt;</span>
<span class="s">        @&lt;input name=&quot;</span><span class="nb">action</span><span class="s">&quot; type=&quot;</span><span class="nb">hidden</span><span class="s">&quot; value=&quot;</span><span class="n">login</span><span class="s">&quot; size=&quot;</span><span class="mi">50</span><span class="s">&quot; maxlength=&quot;</span><span class="mi">50</span><span class="s">&quot;&gt;</span>
<span class="s">        @&lt;input name=&quot;</span><span class="n">email</span><span class="s">&quot; type=&quot;</span><span class="n">text</span><span class="s">&quot; value=&quot;&quot; size=&quot;</span><span class="mi">50</span><span class="s">&quot; maxlength=&quot;</span><span class="mi">50</span><span class="s">&quot; required autofocus placeholder=&quot;</span><span class="n">Email</span><span class="s">&quot;&gt;</span>
<span class="s">        @&lt;input name=&quot;</span><span class="n">pwd</span><span class="s">&quot; type=&quot;</span><span class="n">password</span><span class="s">&quot; value=&quot;&quot; size=&quot;</span><span class="mi">50</span><span class="s">&quot; maxlength=&quot;</span><span class="mi">50</span><span class="s">&quot; required placeholder=&quot;</span><span class="n">Password</span><span class="s">&quot;&gt;</span>
<span class="s">        @&lt;button type=&quot;</span><span class="n">submit</span><span class="s">&quot;&gt;Go&lt;/button&gt;</span>
<span class="s">        @&lt;/form&gt;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">// 显示登录或注册链接</span>
<span class="s">void login_or_signup() {</span>
<span class="s">        @&lt;a href=&quot;</span><span class="n">https:</span>//<span class="n">opensource</span>.<span class="n">com</span>/?<span class="n">req</span>=<span class="n">login</span><span class="s">&quot;&gt;Login&lt;/a&gt; &amp; &amp; &lt;a href=&quot;</span><span class="n">https:</span>//<span class="n">opensource</span>.<span class="n">com</span>/?<span class="n">req</span>=<span class="n">login</span><span class="nv">&amp;action</span>=<span class="n">newuser</span>&quot;&gt;<span class="n">Sign</span> <span class="n">Up</span><span class="s">&lt;/a&gt;&lt;hr/&gt;</span>
}
</code></pre></div>

<h4>通用应用程序（_show_home.vely）</h4>
<p>借助本教程，你可以创建你想要的任何多租户 SaaS 应用程序。上面的多租户处理模块（<code>login.vely</code>）调用 <code>_show_home()</code> 函数，它可以容纳你的任何代码。这个示例代码展示了笔记应用程序，但它可以是任何内容。<code>_show_home()</code> 函数可以调用你想要的任何代码，它是一个通用的多租户应用程序插件：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;vely.h&quot;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">_show_home</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">notes</span><span class="p">();</span>
<span class="w">    </span><span class="n">exit</span><span class="o">-</span><span class="n">request</span>
<span class="p">}</span>
</code></pre></div>

<h4>笔记应用程序（notes.vely）</h4>
<p>该应用程序能够添加、列举以及删除任何给定的笔记：</p>
<div class="highlight"><pre><span></span><code>#include<span class="w"> </span>&quot;vely.h&quot;
#include<span class="w"> </span>&quot;login.h&quot;

//<span class="w"> </span>多租户云中的笔记应用程序
void<span class="w"> </span>notes<span class="w"> </span>()<span class="w"> </span>{
<span class="w">    </span>//<span class="w"> </span>获取全局请求数据
<span class="w">    </span>reqdata<span class="w"> </span>*rd;
<span class="w">    </span>get-req<span class="w"> </span>data<span class="w"> </span>to<span class="w"> </span>rd
<span class="w">    </span>//<span class="w"> </span>如果会话有效，显示登录或注册
<span class="w">    </span>if<span class="w"> </span>(!rd-&gt;is_logged_in)<span class="w"> </span>{
<span class="w">        </span>login_or_signup();
<span class="w">    </span>}
<span class="w">    </span>//<span class="w"> </span>问候用户
<span class="w">    </span>@<span class="nt">&lt;h1&gt;</span>Welcome<span class="w"> </span>to<span class="w"> </span>Notes!<span class="nt">&lt;/h1&gt;&lt;hr/&gt;</span>
<span class="w">    </span>//<span class="w"> </span>如果没有登出，退出<span class="w"> </span>——<span class="w"> </span>这里确保对用户身份的安全验证
<span class="w">    </span>if<span class="w"> </span>(!rd-&gt;is_logged_in)<span class="w"> </span>{
<span class="w">        </span>exit-request
<span class="w">    </span>}
<span class="w">    </span>//<span class="w"> </span>获取<span class="w"> </span>URL<span class="w"> </span>参数，告诉笔记要做什么
<span class="w">    </span>input-param<span class="w"> </span>subreq
<span class="w">    </span>//<span class="w"> </span>显示笔记能够做什么操作（添加或列举笔记）
<span class="w">    </span>@<span class="nt">&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;https://opensource.com/?req=notes&amp;subreq=add&quot;</span><span class="nt">&gt;</span>Add<span class="w"> </span>Note<span class="nt">&lt;/a&gt;</span><span class="w"> </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;https://opensource.com/?req=notes&amp;subreq=list&quot;</span><span class="nt">&gt;</span>List<span class="w"> </span>Notes<span class="nt">&lt;/a&gt;&lt;hr/&gt;</span>

<span class="w">    </span>//<span class="w"> </span>列举该用户的所有笔记
<span class="w">    </span>if<span class="w"> </span>(!strcmp<span class="w"> </span>(subreq,<span class="w"> </span>&quot;list&quot;))<span class="w"> </span>{
<span class="w">        </span>//<span class="w"> </span>**只**选取该用户的笔记
<span class="w">        </span>run-query<span class="w"> </span>@db_multitenant_SaaS<span class="w"> </span>=<span class="w"> </span>&quot;select<span class="w"> </span>dateOf,<span class="w"> </span>note,<span class="w"> </span>noteId<span class="w"> </span>from<span class="w"> </span>notes<span class="w"> </span>where<span class="w"> </span>userId=&#39;%s&#39;<span class="w"> </span>order<span class="w"> </span>by<span class="w"> </span>dateOf<span class="w"> </span>desc&quot;<span class="w"> </span>:<span class="w"> </span>rd-&gt;sess_userId<span class="w"> </span>output<span class="w"> </span>dateOf,<span class="w"> </span>note,<span class="w"> </span>noteId
<span class="w">            </span>query-result<span class="w"> </span>dateOf<span class="w"> </span>to<span class="w"> </span>define<span class="w"> </span>dateOf
<span class="w">            </span>query-result<span class="w"> </span>note<span class="w"> </span>to<span class="w"> </span>define<span class="w"> </span>note
<span class="w">            </span>query-result<span class="w"> </span>noteId<span class="w"> </span>to<span class="w"> </span>define<span class="w"> </span>noteId
<span class="w">            </span>//<span class="w"> </span>使用快速缓存正则表达式将新行更改为<span class="nt">&lt;br/&gt;</span>
<span class="w">            </span>match-regex<span class="w"> </span>&quot;\n&quot;<span class="w"> </span>in<span class="w"> </span>note<span class="w"> </span>replace-with<span class="w"> </span>&quot;<span class="nt">&lt;br/&gt;</span>\n&quot;<span class="w"> </span>result<span class="w"> </span>define<span class="w"> </span>with_breaks<span class="w"> </span>status<span class="w"> </span>define<span class="w"> </span>st<span class="w"> </span>cache
<span class="w">            </span>if<span class="w"> </span>(st<span class="w"> </span>==<span class="w"> </span>0)<span class="w"> </span>with_breaks<span class="w"> </span>=<span class="w"> </span>note;<span class="w"> </span>//<span class="w"> </span>什么都没有发现/替换，只用原来的
<span class="w">            </span>//<span class="w"> </span>显示笔记
<span class="w">            </span>@Date:<span class="w"> </span><span class="err">&lt;</span><span class="nt">&lt;p-out</span><span class="w"> </span><span class="err">dateOf</span><span class="nt">&gt;</span>&gt;<span class="w"> </span>(<span class="nt">&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;https://opensource.com/?req=notes&amp;subreq=delete_note_ask&amp;note_id=%3C%3Cp-out%20noteId%3E%3E&quot;</span><span class="nt">&gt;</span>delete<span class="w"> </span>note<span class="nt">&lt;/a&gt;</span>)<span class="nt">&lt;br/&gt;</span>
<span class="w">            </span>@Note:<span class="w"> </span><span class="err">&lt;</span><span class="nt">&lt;p-out</span><span class="w"> </span><span class="err">with_breaks</span><span class="nt">&gt;</span>&gt;<span class="nt">&lt;br/&gt;</span>
<span class="w">            </span>@<span class="nt">&lt;hr/&gt;</span>
<span class="w">        </span>end-query
<span class="w">    </span>}

<span class="w">    </span>//<span class="w"> </span>要求删除笔记
<span class="w">    </span>else<span class="w"> </span>if<span class="w"> </span>(!strcmp<span class="w"> </span>(subreq,<span class="w"> </span>&quot;delete_note_ask&quot;))<span class="w"> </span>{
<span class="w">        </span>input-param<span class="w"> </span>note_id
<span class="w">        </span>@Are<span class="w"> </span>you<span class="w"> </span>sure<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>delete<span class="w"> </span>a<span class="w"> </span>note?<span class="w"> </span>Use<span class="w"> </span>Back<span class="w"> </span>button<span class="w"> </span>to<span class="w"> </span>go<span class="w"> </span>back,<span class="w"> </span>or<span class="w"> </span><span class="nt">&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;https://opensource.com/?req=notes&amp;subreq=delete_note&amp;note_id=%3C%3Cp-out%20note_id%3E%3E&quot;</span><span class="nt">&gt;</span>delete<span class="w"> </span>note<span class="w"> </span>now<span class="nt">&lt;/a&gt;</span>.
<span class="w">    </span>}

<span class="w">    </span>//<span class="w"> </span>删除笔记
<span class="w">    </span>else<span class="w"> </span>if<span class="w"> </span>(!strcmp<span class="w"> </span>(subreq,<span class="w"> </span>&quot;delete_note&quot;))<span class="w"> </span>{
<span class="w">        </span>input-param<span class="w"> </span>note_id
<span class="w">        </span>//<span class="w"> </span>删除笔记
<span class="w">        </span>run-query<span class="w"> </span>@db_multitenant_SaaS<span class="w"> </span>=<span class="w"> </span>&quot;delete<span class="w"> </span>from<span class="w"> </span>notes<span class="w"> </span>where<span class="w"> </span>noteId=&#39;%s&#39;<span class="w"> </span>and<span class="w"> </span>userId=&#39;%s&#39;&quot;<span class="w"> </span>:<span class="w"> </span>note_id,<span class="w"> </span>rd-&gt;sess_userId<span class="w"> </span>affected-rows<span class="w"> </span>define<span class="w"> </span>arows<span class="w"> </span>no-loop<span class="w"> </span>error<span class="w"> </span>define<span class="w"> </span>errnote
<span class="w">        </span>//<span class="w"> </span>告知用户状态
<span class="w">        </span>if<span class="w"> </span>(arows<span class="w"> </span>==<span class="w"> </span>1)<span class="w"> </span>{
<span class="w">            </span>@Note<span class="w"> </span>deleted
<span class="w">        </span>}<span class="w"> </span>else<span class="w"> </span>{
<span class="w">            </span>@Could<span class="w"> </span>not<span class="w"> </span>delete<span class="w"> </span>note<span class="w"> </span>(<span class="err">&lt;</span><span class="nt">&lt;p-out</span><span class="w"> </span><span class="err">errnote</span><span class="nt">&gt;</span>&gt;)
<span class="w">        </span>}
<span class="w">    </span>}

<span class="w">    </span>//<span class="w"> </span>添加笔记
<span class="w">    </span>else<span class="w"> </span>if<span class="w"> </span>(!strcmp<span class="w"> </span>(subreq,<span class="w"> </span>&quot;add_note&quot;))<span class="w"> </span>{
<span class="w">        </span>//<span class="w"> </span>从<span class="w"> </span>note<span class="w"> </span>表单中获取<span class="w"> </span>URL<span class="w"> </span>POST<span class="w"> </span>数据
<span class="w">        </span>input-param<span class="w"> </span>note
<span class="w">        </span>//<span class="w"> </span>在该用户的<span class="w"> </span>ID<span class="w"> </span>下插入笔记
<span class="w">        </span>run-query<span class="w"> </span>@db_multitenant_SaaS<span class="w"> </span>=<span class="w"> </span>&quot;insert<span class="w"> </span>into<span class="w"> </span>notes<span class="w"> </span>(dateOf,<span class="w"> </span>userId,<span class="w"> </span>note)<span class="w"> </span>values<span class="w"> </span>(now(),<span class="w"> </span>&#39;%s&#39;,<span class="w"> </span>&#39;%s&#39;)&quot;<span class="w"> </span>:<span class="w"> </span>rd-&gt;sess_userId,<span class="w"> </span>note<span class="w"> </span>affected-rows<span class="w"> </span>define<span class="w"> </span>arows<span class="w"> </span>no-loop<span class="w"> </span>error<span class="w"> </span>define<span class="w"> </span>errnote
<span class="w">        </span>//<span class="w"> </span>告知用户状态
<span class="w">        </span>if<span class="w"> </span>(arows<span class="w"> </span>==<span class="w"> </span>1)<span class="w"> </span>{
<span class="w">            </span>@Note<span class="w"> </span>added
<span class="w">        </span>}<span class="w"> </span>else<span class="w"> </span>{
<span class="w">            </span>@Could<span class="w"> </span>not<span class="w"> </span>add<span class="w"> </span>note<span class="w"> </span>(<span class="err">&lt;</span><span class="nt">&lt;p-out</span><span class="w"> </span><span class="err">errnote</span><span class="nt">&gt;</span>&gt;)
<span class="w">        </span>}
<span class="w">    </span>}

<span class="w">    </span>//<span class="w"> </span>显示一个<span class="w"> </span>HTML<span class="w"> </span>表单来收集笔记，并将其发送回这里（使用<span class="w"> </span>subreq=&quot;add_note&quot;<span class="w"> </span>URL<span class="w"> </span>参数）
<span class="w">    </span>else<span class="w"> </span>if<span class="w"> </span>(!strcmp<span class="w"> </span>(subreq,<span class="w"> </span>&quot;add&quot;))<span class="w"> </span>{
<span class="w">        </span>@Add<span class="w"> </span>New<span class="w"> </span>Note
<span class="w">        </span>@<span class="nt">&lt;form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;https://opensource.com/?req=notes&quot;</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>@<span class="nt">&lt;input</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;subreq&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;add_note&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>@<span class="nt">&lt;textarea</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;note&quot;</span><span class="w"> </span><span class="na">rows=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">cols=</span><span class="s">&quot;50&quot;</span><span class="w"> </span><span class="err">required</span><span class="w"> </span><span class="err">autofocus</span><span class="w"> </span><span class="na">placeholder=</span><span class="s">&quot;Enter Note&quot;</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="w">        </span>@<span class="nt">&lt;button</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Create<span class="nt">&lt;/button&gt;</span>
<span class="w">        </span>@<span class="nt">&lt;/form&gt;</span>
<span class="w">    </span>}
}
</code></pre></div>

<h3>具有 C 性能的 SaaS</h3>
<p>Vely 语言使得 C 语言在你的网络应用程序中得到充分利用这件事成为可能。多租户 SaaS 应用程序便是从中受益的一个典型用例。</p>
<p>看一看参考代码示例，写一写代码，然后试试 Vely。</p>
<p><em>（题图：DA/126624c8-1a47-481b-b149-92273e8e0f4f）</em></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>