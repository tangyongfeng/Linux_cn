<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>如何在 Linux 中使用旧相机作为网络摄像头</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Tom Oliver 我用 gphoto2 给我的旧单反相机带来了新的生命，把它变成了 Linux 电脑的网络摄像头。 今年，在我基本上放弃了 MacBook，转而使用 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2023/03/ru-he-zai-linux-zhong-shi-yong-jiu-xiang-ji-zuo-wei-wang-luo-she-xiang-tou.html" rel="bookmark"
           title="Permalink to 如何在 Linux 中使用旧相机作为网络摄像头">如何在 Linux 中使用旧相机作为网络摄像头</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-03-21T23:36:00+01:00">
                Published: Tue 21 March 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Tom Oliver</p>
<p><img alt="" src="/data/attachment/album/202303/21/233633z1qxdoq1shrx1xmc.jpg"></p>
<blockquote>
<p>我用 gphoto2 给我的旧单反相机带来了新的生命，把它变成了 Linux 电脑的网络摄像头。</p>
</blockquote>
<p>今年，在我基本上放弃了 MacBook，转而使用 NixOS 机器之后，我开始在与人进行视频通话时被要求“打开摄像头”。这是一个问题，因为我没有网络摄像头。我考虑购买一个，但后来我意识到我有一台完好无损的 2008 年产的佳能 EOS Rebel XS 数码单反相机放在书架上。这台相机有一个 mini-USB 接口，所以我自然而然地思考：一台数码单反相机、一个 mini-USB 接口和一台台式电脑，是否意味着我能拥有一个网络摄像头？</p>
<p>只有一个问题。我的佳能 EOS Rebel XS 不能录制视频。它可以拍摄一些漂亮的照片，仅此而已。所以这结束了？</p>
<p>还是有别的办法？</p>
<p>恰好有一个叫做 <a href="http://gphoto.org/">gphoto2</a> 的神奇的开源软件。一旦安装，它允许你从计算机控制各种支持的相机，并拍摄照片和视频。</p>
<h3>支持的相机</h3>
<p>首先，了解你的设备是否得到支持：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gphoto2<span class="w"> </span>--list-cameras
</code></pre></div>

<h3>拍摄图像</h3>
<p>你可以用它拍照：</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">gphoto2</span><span class="w"> </span><span class="o">--</span><span class="n">capture</span><span class="o">-</span><span class="n">image</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">download</span>
</code></pre></div>

<p>快门触发，图像会保存到你当前的工作目录中。</p>
<h3>录制视频</h3>
<p>我意识到了这里的潜力，所以尽管我的相机没有视频功能，我还是决定尝试 <code>gphoto2 --capture-movie</code> 命令。不知怎么，尽管我的相机不支持视频功能，<code>gphoto2</code> 仍然能够生成一个 MJPEG 文件！</p>
<p>在我的相机上，我需要将其置于“实时预览”模式下，然后 <code>gphoto2</code> 才能录制视频。这包括将相机设置为纵向模式，然后按下 “<ruby> 设置 <rt>  Set </rt></ruby>” 按钮，使取景器关闭，相机屏幕显示图像。不幸的是，这还不足以将其用作网络摄像头。它仍然需要分配一个视频设备，例如 <code>/dev/video0</code>。</p>
<h3>安装 ffmpeg 和 v4l2loopback</h3>
<p>毫不奇怪，有一个开源的解决方案来解决这个问题。首先，使用你的包管理器安装 <code>gphoto2</code>、<code>ffmpeg</code> 和 <code>mpv</code>。例如，在 Fedora 、CentOS 、Mageia 和类似的 Linux 发行版上：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>gphoto2<span class="w"> </span>ffmpeg<span class="w"> </span>mpv
</code></pre></div>

<p>在 Debian、Linux Mint 及其类似发行版:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gphoto2<span class="w"> </span>ffmpeg<span class="w"> </span>mpv
</code></pre></div>

<p>我使用的是 NixOS，这是我的配置文件：</p>
<div class="highlight"><pre><span></span><code># configuration.nix
...
environment.systemPackages = with pkgs; [
  ffmpeg
  gphoto2
  mpv
...  
]
</code></pre></div>

<p>创建虚拟视频设备需要使用 <code>v4l2loopback</code> Linux 内核模块。在撰写本文时，该功能未包含在主线内核中，因此你需要自己下载和编译它：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/umlaeute/v4l2loopback
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>v4l2loopback
$<span class="w"> </span>make
$<span class="w"> </span>sudo<span class="w"> </span>make<span class="w"> </span>install
$<span class="w"> </span>sudo<span class="w"> </span>depmod<span class="w"> </span>-a
</code></pre></div>

<p>如果你像我一样使用 NixOS ，你可以在 <code>configuration.nix</code> 中添加额外的模块包：</p>
<div class="highlight"><pre><span></span><code><span class="k">[...]</span>
<span class="na">boot.extraModulePackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">with config.boot.kernelPackages</span><span class="c1">;</span>
<span class="na">[ v4l2loopback.out ];</span>
<span class="na">boot.kernelModules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[</span>
<span class="w">  </span><span class="na">&quot;v4l2loopback&quot;</span>
<span class="na">];</span>
<span class="na">boot.extraModprobeConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;&#39;</span>
<span class="w">  </span><span class="na">options v4l2loopback exclusive_caps</span><span class="o">=</span><span class="s">1 card_label=&quot;Virtual Camera&quot;</span>
<span class="na">&#39;&#39;;</span>
<span class="k">[...]</span>
</code></pre></div>

<p>在 NixOS 上, 运行 <code>sudo nixos-rebuild switch</code>，然后重启。</p>
<h3>创建一个视频设备</h3>
<p>假设你的计算机当前没有 <code>/dev/video</code> 设备，你可以借助 <code>v4l2loopback</code> 在需要时创建一个。</p>
<p>运行以下命令，将 <code>gphoto2</code> 中的数据发送到 <code>ffmpeg</code>，使用设备如 <code>/dev/video0</code> 设备：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gphoto2<span class="w"> </span>--stdout<span class="w"> </span>--capture-movie<span class="w"> </span><span class="p">|</span>
<span class="w"> </span>ffmpeg<span class="w"> </span>-i<span class="w"> </span>-<span class="w"> </span>-vcodec<span class="w"> </span>rawvideo<span class="w"> </span>-pix_fmt<span class="w"> </span>yuv420p<span class="w"> </span>-f<span class="w"> </span>v4l2<span class="w"> </span>/dev/video0
</code></pre></div>

<p>你得到的输出是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="n">ffmpeg</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">4.4.1</span><span class="w"> </span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="mi">2000</span><span class="o">-</span><span class="mi">2021</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">FFmpeg</span><span class="w"> </span><span class="n">developers</span>
<span class="w">  </span><span class="n">built</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">gcc</span><span class="w"> </span><span class="mf">11.3.0</span><span class="w"> </span><span class="p">(</span><span class="n">GCC</span><span class="p">)</span>
<span class="w">  </span><span class="n">configuration</span><span class="o">:</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">static</span><span class="w"> </span><span class="p">...</span>
<span class="w">  </span><span class="n">libavutil</span><span class="w">      </span><span class="mf">56.</span><span class="w"> </span><span class="mf">70.100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">56.</span><span class="w"> </span><span class="mf">70.100</span>
<span class="w">  </span><span class="n">libavcodec</span><span class="w">     </span><span class="mf">58.134.100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">58.134.100</span>
<span class="w">  </span><span class="n">libavformat</span><span class="w">    </span><span class="mf">58.</span><span class="w"> </span><span class="mf">76.100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">58.</span><span class="w"> </span><span class="mf">76.100</span>
<span class="w">  </span><span class="n">libavdevice</span><span class="w">    </span><span class="mf">58.</span><span class="w"> </span><span class="mf">13.100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">58.</span><span class="w"> </span><span class="mf">13.100</span>
<span class="w">  </span><span class="n">libavfilter</span><span class="w">     </span><span class="mf">7.110.100</span><span class="w"> </span><span class="o">/</span><span class="w">  </span><span class="mf">7.110.100</span>
<span class="w">  </span><span class="n">libavresample</span><span class="w">   </span><span class="mf">4.</span><span class="w">  </span><span class="mf">0.</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="o">/</span><span class="w">  </span><span class="mf">4.</span><span class="w">  </span><span class="mf">0.</span><span class="w">  </span><span class="mi">0</span>
<span class="w">  </span><span class="n">libswscale</span><span class="w">      </span><span class="mf">5.</span><span class="w">  </span><span class="mf">9.100</span><span class="w"> </span><span class="o">/</span><span class="w">  </span><span class="mf">5.</span><span class="w">  </span><span class="mf">9.100</span>
<span class="w">  </span><span class="n">libswresample</span><span class="w">   </span><span class="mf">3.</span><span class="w">  </span><span class="mf">9.100</span><span class="w"> </span><span class="o">/</span><span class="w">  </span><span class="mf">3.</span><span class="w">  </span><span class="mf">9.100</span>
<span class="w">  </span><span class="n">libpostproc</span><span class="w">    </span><span class="mf">55.</span><span class="w">  </span><span class="mf">9.100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">55.</span><span class="w">  </span><span class="mf">9.100</span>
<span class="n">Capturing</span><span class="w"> </span><span class="n">preview</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="n">movie</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s">&#39;stdout&#39;</span><span class="p">.</span><span class="w"> </span><span class="n">Press</span><span class="w"> </span><span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">abort</span><span class="p">.[</span><span class="n">mjpeg</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x1dd0380</span><span class="p">]</span><span class="w"> </span><span class="n">Format</span><span class="w"> </span><span class="n">mjpeg</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="kr">only</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="n">misdetection</span><span class="w"> </span><span class="n">possible</span><span class="o">!</span>
<span class="n">Input</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">mjpeg</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">&#39;pipe:&#39;</span><span class="o">:</span>
<span class="w">  </span><span class="n">Duration</span><span class="o">:</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">bitrate</span><span class="o">:</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">A</span>
<span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">Video</span><span class="o">:</span><span class="w"> </span><span class="n">mjpeg</span><span class="w"> </span><span class="p">(</span><span class="n">Baseline</span><span class="p">),</span><span class="w"> </span><span class="n">yuvj422p</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">bt470bg</span><span class="o">/</span><span class="n">unknown</span><span class="o">/</span><span class="n">unknown</span><span class="p">),</span><span class="w"> </span><span class="mi">768</span><span class="n">x512</span><span class="w"> </span><span class="p">...</span>
<span class="n">Stream</span><span class="w"> </span><span class="n">mapping</span><span class="o">:</span>
<span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="n">mjpeg</span><span class="w"> </span><span class="p">(</span><span class="n">native</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">rawvideo</span><span class="w"> </span><span class="p">(</span><span class="n">native</span><span class="p">))[</span><span class="n">swscaler</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x1e27340</span><span class="p">]</span><span class="w"> </span><span class="kr">deprecated</span><span class="w"> </span><span class="n">pixel</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">used</span><span class="p">,</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="nf">set</span><span class="w"> </span><span class="nf">range</span><span class="w"> </span><span class="n">correctly</span>
<span class="kr">Output</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">video4linux2</span><span class="p">,</span><span class="n">v4l2</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s">&#39;/dev/video0&#39;</span><span class="o">:</span>
<span class="w">  </span><span class="n">Metadata</span><span class="o">:</span>
<span class="w">    </span><span class="n">encoder</span><span class="w">         </span><span class="o">:</span><span class="w"> </span><span class="n">Lavf58</span><span class="mf">.76.100</span>
<span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="err">#</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">Video</span><span class="o">:</span><span class="w"> </span><span class="n">rawvideo</span><span class="w"> </span><span class="p">(</span><span class="n">I420</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">0x30323449</span><span class="p">)</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="n">Metadata</span><span class="o">:</span>
<span class="w">      </span><span class="n">encoder</span><span class="w">         </span><span class="o">:</span><span class="w"> </span><span class="n">Lavc58</span><span class="mf">.134.100</span><span class="w"> </span><span class="n">rawvideoframe</span><span class="o">=</span><span class="w">  </span><span class="mi">289</span><span class="w"> </span><span class="n">fps</span><span class="o">=</span><span class="w"> </span><span class="mi">23</span><span class="w"> </span><span class="n">q</span><span class="o">=-</span><span class="mf">0.0</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="n">A</span><span class="w"> </span><span class="n">time</span><span class="o">=</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mf">11.56</span><span class="w"> </span><span class="n">bitrate</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="n">A</span><span class="w"> </span><span class="n">speed</span><span class="o">=</span><span class="mf">0.907</span><span class="n">x</span>
</code></pre></div>

<p>要查看来自网络摄像头的视频，请使用 <code>mpv</code> 命令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mpv<span class="w"> </span>av://v4l2:/dev/video0<span class="w"> </span>--profile<span class="o">=</span>low-latency<span class="w"> </span>--untimed
</code></pre></div>

<p><img alt="Streaming a live feed from the webcam" src="/data/attachment/album/202303/21/233414pjm6que6y6zj6mlu.jpg"></p>
<h3>自动启动你的网络摄像头</h3>
<p>每次想使用网络摄像头时都需要执行一次命令有点麻烦。幸运的是，你可以在启动时自动运行此命令。我将其实现为一个 <code>systemd</code> 服务：</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span>configuration.nix
...
<span class="w">  </span>systemd.services.webcam<span class="w"> </span>=<span class="w"> </span>{
<span class="w">    </span>enable<span class="w"> </span>=<span class="w"> </span>true;
<span class="w">    </span>script<span class="w"> </span>=<span class="w"> </span>&#39;&#39;
<span class="w">      </span><span class="cp">${</span><span class="n">pkgs</span><span class="o">.</span><span class="n">gphoto2</span><span class="cp">}</span>/bin/gphoto2<span class="w"> </span>--stdout<span class="w"> </span>--capture-movie<span class="w"> </span>|
<span class="w">        </span><span class="cp">${</span><span class="n">pkgs</span><span class="o">.</span><span class="n">ffmpeg</span><span class="cp">}</span>/bin/ffmpeg<span class="w"> </span>-i<span class="w"> </span>-<span class="w"> </span>\
<span class="w">            </span>-vcodec<span class="w"> </span>rawvideo<span class="w"> </span>-pix_fmt<span class="w"> </span>yuv420p<span class="w"> </span>-f<span class="w"> </span>v4l2<span class="w">  </span>/dev/video0
<span class="w">    </span>&#39;&#39;;
wantedBy<span class="w"> </span>=<span class="w"> </span>[<span class="w"> </span>&quot;multi-user.target&quot;<span class="w"> </span>];
<span class="w">  </span>};
...
</code></pre></div>

<p>在 NixOS 上，运行 <code>sudo nixos-rebuild switch</code>，然后重新启动你的计算机。你的网络摄像头已经开启并处于活动状态。</p>
<p>要检查是否存在任何问题，可以使用 <code>systemctl status webcam</code> 命令。它会告诉你服务最后一次运行的时间，并提供其以前输出的日志。这对于调试非常有用。</p>
<h3>迭代以使其变得更好</h3>
<p>止步于此也许很诱人。但是，考虑到当前的全球危机，我们可能需要思考是否有必要一直开着网络摄像头。这让我感到不太理想，原因如下：</p>
<ul>
<li>这浪费电。</li>
<li>这类事情涉及隐私问题。</li>
</ul>
<p>我的摄像头有一个镜头盖，所以说实话，第二个原因并不真的让我感到困扰。当我不使用网络摄像头时，我总是可以把镜头盖上。然而，让一个耗电量大的单反相机整天开着（更不用说需要解码视频所需的 CPU 开销），对我的电费并没有任何好处。</p>
<p>理想情况是：</p>
<ul>
<li>我一直把相机插在电脑上，但是关闭的。</li>
<li>当我想使用网络摄像头时，我按下相机的电源按钮将其打开。</li>
<li>我的计算机会检测到相机并启动 systemd 服务。</li>
<li>使用网络摄像头完成后，我再次将其关闭。</li>
</ul>
<p>为了实现这一点，你需要使用一个自定义的 udev 规则。</p>
<p>udev 规则可以告诉你的计算机，当它发现某个设备已经可用时执行某个任务。这可以是外部硬盘甚至是非 USB 设备。在这种情况下，你需要通过其 USB 连接识别相机。</p>
<p>首先，指定 udev 规则被触发时要运行的命令。你可以用一个 shell 脚本来完成（<code>systemctl restart webcam</code> 应该可以工作）。我运行的是 NixOS，所以我只需要创建一个派生包（一个 Nix 包），它会重新启动 systemd 服务：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># start-webcam.nix</span>
<span class="k">with</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">nixpkgs</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">};</span>
<span class="n">writeShellScriptBin</span> <span class="s2">&quot;start-webcam&quot;</span> <span class="s1">&#39;&#39;</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">webcam</span>
  <span class="c1"># debugging example</span>
  <span class="c1"># echo &quot;hello&quot; &amp;&gt; /home/tom/myfile.txt</span>
  <span class="c1"># If myfile.txt gets created then we know the udev rule has triggered properly&#39;&#39;</span>
</code></pre></div>

<p>接下来，实际定义 udev 规则。查找摄像头的设备和厂商 ID。使用 <code>lsusb</code> 命令可以完成此操作。该命令可能已经安装在你的发行版上，但我不经常使用它，因此我只需要根据需要使用 <code>nix-shell</code> 安装它：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>nix-shell<span class="w"> </span>-p<span class="w"> </span>usbutils
</code></pre></div>

<p>无论你的计算机上已经安装了它，还是刚刚安装，请运行 <code>lsusb</code> ：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>lsusb
Bus<span class="w"> </span><span class="m">002</span><span class="w"> </span>Device<span class="w"> </span><span class="m">008</span>:<span class="w"> </span>ID<span class="w"> </span>04a9:317b<span class="w"> </span>Canon,<span class="w"> </span>Inc.<span class="w"> </span>Canon<span class="w"> </span>Digital<span class="w"> </span>Camera<span class="o">[</span>...<span class="o">]</span>
</code></pre></div>

<p>在此输出中，厂商 ID 为 <code>04a9</code>，设备 ID 为 <code>317b</code>。这已足以创建 udev 规则：</p>
<div class="highlight"><pre><span></span><code>ACTION==&quot;add&quot;, SUBSYSTEM==&quot;usb&quot;,
ATTR{idVendor}==&quot;04a9&quot;,
ATTR{idProduct}==&quot;317b&quot;,
RUN+=&quot;/usr/local/bin/start-webcam.sh&quot;
</code></pre></div>

<p>或者，如果你使用的是 NixOS：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># configuration.nix[...]let</span>
  <span class="n">startWebcam</span> <span class="o">=</span> <span class="kn">import</span> <span class="nn">.</span><span class="o">/</span><span class="n">start</span><span class="o">-</span><span class="n">webcam</span><span class="o">.</span><span class="n">nix</span><span class="p">;[</span><span class="o">...</span><span class="p">]</span>
<span class="n">services</span><span class="o">.</span><span class="n">udev</span><span class="o">.</span><span class="n">extraRules</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span><span class="p">,</span>  \
  <span class="n">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span><span class="p">,</span> \
  <span class="n">ATTR</span><span class="p">{</span><span class="n">idVendor</span><span class="p">}</span><span class="o">==</span><span class="s2">&quot;04a9&quot;</span><span class="p">,</span> \
  <span class="n">ATTR</span><span class="p">{</span><span class="n">idProduct</span><span class="p">}</span><span class="o">==</span><span class="s2">&quot;317b&quot;</span><span class="p">,</span>  \
  <span class="n">RUN</span><span class="o">+=</span><span class="s2">&quot;$</span><span class="si">{startWebcam}</span><span class="s2">/bin/start-webcam&quot;</span><span class="s1">&#39;&#39;</span><span class="p">;[</span><span class="o">...</span><span class="p">]</span>
</code></pre></div>

<p>最后，在你的 <code>start-webcam</code> systemd 服务中删除 <code>wantedBy = ["multi-user.target"];</code> 这一行。（如果保留它，则无论相机是否开启，该服务都会在下次重启时自动启动。）</p>
<h3>重复使用旧技术</h3>
<p>我希望这篇文章能让你在放弃一些旧技术之前三思而后行。Linux 可以为技术注入活力，无论是你的电脑还是数码相机或其他外围设备等简单的东西。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>