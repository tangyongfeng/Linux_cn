<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>像查询数据库一样查询你的 Linux 操作系统信息</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Gaurav Kamathe 使用数据库查询操作轻松获取系统信息。 Linux 提供了很多帮助用户收集主机操作系统信息的命令：列出文件或者目 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2021/07/xiang-cha-xun-shu-ju-ku-yi-yang-cha-xun-ni-de-linux-cao-zuo-xi-tong-xin-xi.html" rel="bookmark"
           title="Permalink to 像查询数据库一样查询你的 Linux 操作系统信息">像查询数据库一样查询你的 Linux 操作系统信息</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-07-14T09:58:31+02:00">
                Published: Wed 14 July 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Gaurav Kamathe</p>
<blockquote>
<p>使用数据库查询操作轻松获取系统信息。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202107/14/095820zywm2m2tzz5otfh5.jpg" title="Magnifying glass on code"></p>
<p>Linux 提供了很多帮助用户收集主机操作系统信息的命令：列出文件或者目录的属性信息；查询安装的软件包、正在执行的命令、开机时启动的服务；或者了解系统的硬件。</p>
<p>每个命令使用自己的输出格式列出系统的信息。你需要使用 <code>grep</code>、<code>sed</code>、<code>awk</code> 这样的工具过滤命令输出的结果，以便找到特定的信息。此外，很多这样的信息会频繁变动，导致系统状态的改变。</p>
<p>将所有的信息格式化为一个数据库的 SQL 查询的输出进行查看将会十分有益。想象一下，你能够像查询具有类似名称的 SQL 数据库表一样查询 <code>ps</code> 和 <code>rpm</code> 命令的输出。</p>
<p>幸运的是，有一个工具刚好实现了这个功能，而且功能更多：<a href="https://osquery.io/">Osquery</a> 是一个 <a href="https://github.com/osquery/osquery">开源的</a> “由 SQL 驱动的操作系统仪表、监控和分析框架”。</p>
<p>许多处理安全、DevOps、合规性的应用，以及仓储管理管理（仅举几例）在内部依赖 Osquery 提供的核心功能。</p>
<h3>安装 Osquery</h3>
<p>Osquery 适用于 Linux、macOS、Windows、FreeBSD。请按照 <a href="https://osquery.io/downloads/official">指南</a> 为你的操作系统安装最新版本。（我会在下面的例子中使用 4.7.0 版本。）</p>
<p>安装完成后，确保 Osquery 可以工作：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>rpm<span class="w"> </span>-qa<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>osquery
osquery-4.7.0-1.linux.x86_64
$
$<span class="w"> </span>osqueryi<span class="w"> </span>--version
osqueryi<span class="w"> </span>version<span class="w"> </span><span class="m">4</span>.7.0
$
</code></pre></div>

<h3>Osquery 组件</h3>
<p>Osquery 有两个主要组件：</p>
<ul>
<li><code>osqueri</code> 是一个交互式的 SQL 查询控制台，可以独立运行，不需要超级用户权限（除非要查询的表格需要访问权限）。</li>
<li><code>osqueryd</code> 像一个安装在主机的监控守护进程，可以定期调度查询操作执行，从底层架构收集信息。</li>
</ul>
<p>可以在不运行 <code>osqueryd</code> 的情况下执行 <code>osqueri</code>。另一个工具，<code>osqueryctl</code>，控制守护进程的启动、停止，并检查其状态。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>rpm<span class="w"> </span>-ql<span class="w"> </span>osquery-4.8.0-1.linux.x86_64<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>bin
/usr/bin/osqueryctl
/usr/bin/osqueryd
/usr/bin/osqueryi
$
</code></pre></div>

<h3>使用 osqueryi 交互式命令提示符</h3>
<p>你和 Osquery 的交互与使用 SQL 数据库十分相似。事实上，<code>osqueryi</code> 是 SQList shell 的一个修改版。执行 <code>osqueryi</code> 命令进入交互式命令提示符 ，就可以执行 Osquery 的命令，通常以 <code>.</code> 开始：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>osqueryi
Using<span class="w"> </span>a<span class="w"> </span>virtual<span class="w"> </span>database.<span class="w"> </span>Need<span class="w"> </span>help,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s1">&#39;.help&#39;</span>
osquery&gt;
</code></pre></div>

<p>要退出交互式命令提示符，执行 <code>.quit</code> 命令回到操作系统的命令提示符：</p>
<div class="highlight"><pre><span></span><code><span class="nv">osquery</span><span class="o">&gt;</span>
<span class="nv">osquery</span><span class="o">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nv">quit</span>
<span class="p">$</span>
</code></pre></div>

<h3>找出可用的表</h3>
<p>如前所述，Osquery 像 SQL 查询一样输出数据，数据库中的信息通常保存在表中。但是如何在不知道表名的情况下查询这些表呢？你可以运行 <code>.tables</code> 命令列出所有可以查询的表。如果你是一个 Linux 长期用户或者一个系统管理员 ，就会对表名十分熟悉，因为你一直在使用操作系统命令获取同样的信息：</p>
<div class="highlight"><pre><span></span><code>osquery&gt; .tables
  =&gt; acpi_tables
  =&gt; apparmor_events
  =&gt; apparmor_profiles
  =&gt; apt_sources

&lt;&lt;裁剪&gt;&gt;

  =&gt; arp_cache
  =&gt; user_ssh_keys
  =&gt; users
  =&gt; yara
  =&gt; yara_events
  =&gt; ycloud_instance_metadata
  =&gt; yum_sources
osquery&gt;
</code></pre></div>

<h3>检查各个表的模式</h3>
<p>知道表名后，可以查看每个表提供的信息。既然 <code>ps</code> 命令经常用于获取进程信息，就以 <code>processes</code> 为例。执行 <code>.schema</code> 命令加上表名查看表中保存的信息。如果要验证命令返回的结果，可以快速执行 <code>ps -ef</code> 或 <code>ps aux</code>，对比命令的输出和表中的内容：</p>
<div class="highlight"><pre><span></span><code><span class="n">osquery</span><span class="o">&gt;</span><span class="w"> </span><span class="p">.</span><span class="k">schema</span><span class="w"> </span><span class="n">processes</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">processes</span><span class="p">(</span><span class="n n-Quoted">`pid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`name`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`path`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`cmdline`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`state`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`cwd`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`root`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`uid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`gid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`euid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`egid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`suid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`sgid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`on_disk`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`wired_size`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`resident_size`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`total_size`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`user_time`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`system_time`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`disk_bytes_read`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`disk_bytes_written`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`start_time`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`parent`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`pgroup`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`threads`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`nice`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`is_elevated_token`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`elapsed_time`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`handle_count`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`percent_processor_time`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`upid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`uppid`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`cpu_type`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`cpu_subtype`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`phys_footprint`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`pid`</span><span class="p">))</span><span class="w"> </span><span class="k">WITHOUT</span><span class="w"> </span><span class="n">ROWID</span><span class="p">;</span>
<span class="n">osquery</span><span class="o">&gt;</span>
</code></pre></div>

<p>要进一步确认，可以使用下面的命令查看 RPM 包的结构信息，然后与操作系统命令 <code>rpm -qa</code> 和 <code>rpm -qi</code> 的输出比较：</p>
<div class="highlight"><pre><span></span><code><span class="n">osquery</span><span class="o">&gt;</span>
<span class="n">osquery</span><span class="o">&gt;</span><span class="w"> </span><span class="p">.</span><span class="k">schema</span><span class="w"> </span><span class="n">rpm_packages</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">rpm_packages</span><span class="p">(</span><span class="n n-Quoted">`name`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`version`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`release`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`source`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`size`</span><span class="w"> </span><span class="kt">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`sha1`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`arch`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`epoch`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`install_time`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`vendor`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`package_group`</span><span class="w"> </span><span class="kt">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`pid_with_namespace`</span><span class="w"> </span><span class="kt">INTEGER</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`mount_namespace_id`</span><span class="w"> </span><span class="kt">TEXT</span><span class="w"> </span><span class="n">HIDDEN</span><span class="p">,</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`name`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`version`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`release`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`arch`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`epoch`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`pid_with_namespace`</span><span class="p">))</span><span class="w"> </span><span class="k">WITHOUT</span><span class="w"> </span><span class="n">ROWID</span><span class="p">;</span>
<span class="n">osquery</span><span class="o">&gt;</span>
</code></pre></div>

<p>从 Osquery 的 <a href="https://osquery.io/schema/4.8.0/">表格文档</a> 获取更多信息。</p>
<h3>使用 PRAGMA 命令</h3>
<p>或许模式信息对你来说太难看懂，还有另一种途径能够以详细的表格格式打印表中的信息：<code>PRAGMA</code> 命令。例如，我想通过 <code>PRAGMA</code> 用一种易于理解的格式查看 <code>rpm_packages</code> 表的信息：</p>
<div class="highlight"><pre><span></span><code><span class="nx">osquery</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">PRAGMA</span><span class="w"> </span><span class="nx">table_info</span><span class="p">(</span><span class="nx">rpm_packages</span><span class="p">);</span>
</code></pre></div>

<p>这种表格式信息的一个好处是你可以关注想要查询的字段，查看命令提供的类型信息：</p>
<div class="highlight"><pre><span></span><code><span class="nx">osquery</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">PRAGMA</span><span class="w"> </span><span class="nx">table_info</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
<span class="o">+-----+-------------+--------+---------+------------+----+</span>
<span class="o">|</span><span class="w"> </span><span class="nx">cid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">name</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">notnull</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">dflt_value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">pk</span><span class="w"> </span><span class="o">|</span>
<span class="o">+-----+-------------+--------+---------+------------+----+</span>
<span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">uid</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">BIGINT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">gid</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="nx">BIGINT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">uid_signed</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">BIGINT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">gid_signed</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">BIGINT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">username</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">TEXT</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">5</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">description</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">TEXT</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">6</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">directory</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">TEXT</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">7</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">shell</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">TEXT</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">uuid</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nx">TEXT</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span><span class="o">|</span>
<span class="o">+-----+-------------+--------+---------+------------+----+</span>
<span class="nx">osquery</span><span class="p">&gt;</span>
</code></pre></div>

<h3>进行你的第一次查询</h3>
<p>在你从表、模式、条目中获取到所有进行查询所需要的信息后，进行你的第一次 SQL 查询查看其中的信息。下面的查询返回系统中的用户和每个用户的用户 ID、组 ID、主目录和默认的命令行解释器。Linux 用户通过查看 <code>/etc/passwd</code> 文件的内容并执行 <code>grep</code>、<code>sed</code>、<code>awk</code> 命令获取同样的信息。</p>
<div class="highlight"><pre><span></span><code><span class="n">osquery</span><span class="o">&gt;</span>
<span class="n">osquery</span><span class="o">&gt;</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="n">gid</span><span class="p">,</span><span class="n">directory</span><span class="p">,</span><span class="n">shell</span><span class="p">,</span><span class="n">uuid</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">LIMIT</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="o">+-----+-----+----------------+----------------+------+</span>
<span class="o">|</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">directory</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">shell</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="o">|</span>
<span class="o">+-----+-----+----------------+----------------+------+</span>
<span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="w">      </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">adm</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">7</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">lpd</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">5</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sync</span><span class="w">      </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="mi">6</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">shutdown</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="o">|</span>
<span class="o">+-----+-----+----------------+----------------+------+</span>
<span class="n">osquery</span><span class="o">&gt;</span>
</code></pre></div>

<h3>不进入交互模式的查询</h3>
<p>如果你想要在不进入 <code>osqueri</code> 交互模式的情况下进行查询，该怎么办？要用查询操作写命令行解释器脚本，这种方式可能十分有用。这种情况下，可以直接从 Bash 解释器 <code>echo</code> SQL 查询，通过管道输出到 <code>osqueri</code> ：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;select uid,gid,directory,shell,uuid FROM users LIMIT 7;&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>osqueryi
+-----+-----+----------------+----------------+------+
<span class="p">|</span><span class="w"> </span>uid<span class="w"> </span><span class="p">|</span><span class="w"> </span>gid<span class="w"> </span><span class="p">|</span><span class="w"> </span>directory<span class="w">      </span><span class="p">|</span><span class="w"> </span>shell<span class="w">          </span><span class="p">|</span><span class="w"> </span>uuid<span class="w"> </span><span class="p">|</span>
+-----+-----+----------------+----------------+------+
<span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/root<span class="w">          </span><span class="p">|</span><span class="w"> </span>/bin/bash<span class="w">      </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/bin<span class="w">           </span><span class="p">|</span><span class="w"> </span>/sbin/nologin<span class="w">  </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/sbin<span class="w">          </span><span class="p">|</span><span class="w"> </span>/sbin/nologin<span class="w">  </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/var/adm<span class="w">       </span><span class="p">|</span><span class="w"> </span>/sbin/nologin<span class="w">  </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">7</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/var/spool/lpd<span class="w"> </span><span class="p">|</span><span class="w"> </span>/sbin/nologin<span class="w">  </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">5</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/sbin<span class="w">          </span><span class="p">|</span><span class="w"> </span>/bin/sync<span class="w">      </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">6</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>/sbin<span class="w">          </span><span class="p">|</span><span class="w"> </span>/sbin/shutdown<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="p">|</span>
+-----+-----+----------------+----------------+------+
$
</code></pre></div>

<h3>获悉系统启动时开始的服务</h3>
<p>Osquery 还可以列出系统启动时开始的所有服务。例如，可以查询 <code>startup_items</code> 表获取启动时开始的前五项服务的名称、状态和路径：</p>
<div class="highlight"><pre><span></span><code><span class="nx">osquery</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">SELECT</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="k">type</span><span class="p">,</span><span class="nx">status</span><span class="p">,</span><span class="nx">path</span><span class="w"> </span><span class="nx">FROM</span><span class="w"> </span><span class="nx">startup_items</span><span class="w"> </span><span class="nx">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">README</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Startup</span><span class="w"> </span><span class="nx">Item</span>
<span class="nx">status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enabled</span>
<span class="w">  </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">rc</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">init</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">README</span>

<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">anamon</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Startup</span><span class="w"> </span><span class="nx">Item</span>
<span class="nx">status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enabled</span>
<span class="w">  </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">rc</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">init</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">anamon</span>

<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">functions</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Startup</span><span class="w"> </span><span class="nx">Item</span>
<span class="nx">status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enabled</span>
<span class="w">  </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">rc</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">init</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">functions</span>

<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">osqueryd</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Startup</span><span class="w"> </span><span class="nx">Item</span>
<span class="nx">status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enabled</span>
<span class="w">  </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">rc</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">init</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">osqueryd</span>

<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">AT</span><span class="o">-</span><span class="nx">SPI</span><span class="w"> </span><span class="nx">D</span><span class="o">-</span><span class="nx">Bus</span><span class="w"> </span><span class="nx">Bus</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Startup</span><span class="w"> </span><span class="nx">Item</span>
<span class="nx">status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enabled</span>
<span class="w">  </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">libexec</span><span class="o">/</span><span class="nx">at</span><span class="o">-</span><span class="nx">spi</span><span class="o">-</span><span class="nx">bus</span><span class="o">-</span><span class="nx">launcher</span><span class="w"> </span><span class="o">--</span><span class="nx">launch</span><span class="o">-</span><span class="nx">immediately</span>
<span class="nx">osquery</span><span class="p">&gt;</span>
</code></pre></div>

<h3>查阅二进制文件的 ELF 信息</h3>
<p>假如你想要弄清 <code>ls</code> 二进制文件的更多细节，通常会通过 <code>readelf -h</code> 命令，加上 <code>ls</code> 命令的路径。查询 Osquery 的 <code>elf_info</code> 表你可以得到同样的信息：</p>
<div class="highlight"><pre><span></span><code><span class="nx">osquery</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">FROM</span><span class="w"> </span><span class="nx">elf_info</span><span class="w"> </span><span class="nx">WHERE</span><span class="w"> </span><span class="nx">path</span><span class="p">=</span><span class="s">&quot;/bin/ls&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">class</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">64</span>
<span class="w">        </span><span class="nx">abi</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sysv</span>
<span class="nx">abi_version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">       </span><span class="k">type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">dyn</span>
<span class="w">    </span><span class="nx">machine</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">62</span>
<span class="w">    </span><span class="nx">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="nx">entry</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">24064</span>
<span class="w">      </span><span class="nx">flags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">       </span><span class="nx">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">ls</span>
<span class="nx">osquery</span><span class="p">&gt;</span>
</code></pre></div>

<p>现在你应该初步了解如何使用 <code>osqueri</code> 查询自己想要的信息。然而，这些信息保存在数量巨大的表中；我查询过的一个系统中，有 156 个不同的表，这个数字可能是十分惊人的：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;.tables&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>osqueryi<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
<span class="m">156</span>
$
</code></pre></div>

<p>要让事情变得更容易，可以从这些表开始获取你的 Linux 系统的信息：</p>
<p><strong>系统信息表：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from system_info;
</code></pre></div>

<p><strong>系统限制信息：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from ulimit_info;
</code></pre></div>

<p><strong>由各种进程打开的文件：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from process_open_files;
</code></pre></div>

<p><strong>系统上开放的端口：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from listening_ports;
</code></pre></div>

<p><strong>运行中的进程信息：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from processes;
</code></pre></div>

<p><strong>已安装的包信息：</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">osquery</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">rpm_packages</span><span class="p">;</span>
</code></pre></div>

<p><strong>用户登录信息：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from last;
</code></pre></div>

<p><strong>系统日志信息：</strong></p>
<div class="highlight"><pre><span></span><code>osquery&gt; select * from syslog_events;
</code></pre></div>

<h3>了解更多</h3>
<p>Osquery 是一个强大的工具，提供了许多可以用于解决各种使用案例的主机信息。你可以阅读 <a href="https://osquery.readthedocs.io/en/latest/">文档</a> 了解更多 Osquery 的信息。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>