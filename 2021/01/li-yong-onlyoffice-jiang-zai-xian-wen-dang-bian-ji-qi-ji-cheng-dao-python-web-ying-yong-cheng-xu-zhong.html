<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>利用 ONLYOFFICE 将在线文档编辑器集成到 Python Web 应用程序中</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Aashima Sharma ONLYOFFICE 是根据 GNU AGPL v.3 许可证条款分发的开源协作办公套件。它包含三个用于文本文档、电子表格和演示文稿的编辑 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2021/01/li-yong-onlyoffice-jiang-zai-xian-wen-dang-bian-ji-qi-ji-cheng-dao-python-web-ying-yong-cheng-xu-zhong.html" rel="bookmark"
           title="Permalink to 利用 ONLYOFFICE 将在线文档编辑器集成到 Python Web 应用程序中">利用 ONLYOFFICE 将在线文档编辑器集成到 Python Web 应用程序中</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-01-21T10:49:27+01:00">
                Published: Thu 21 January 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Aashima Sharma</p>
<p><img alt="" src="/data/attachment/album/202101/21/104928pv6l5gcjo8gmzb5l.jpg" title="Typist composing text in laptop"></p>
<p><a href="https://www.onlyoffice.com/en/">ONLYOFFICE</a> 是根据 GNU AGPL v.3 许可证条款分发的开源协作办公套件。它包含三个用于文本文档、电子表格和演示文稿的编辑器，并具有以下功能:</p>
<ul>
<li>查看，编辑和协同编辑 <code>.docx</code>、<code>.xlsx</code>、<code>.pptx</code> 文件。OOXML 作为一种核心格式，可确保与 Microsoft Word、Excel 和 PowerPoint 文件的高度兼容性。</li>
<li>通过内部转换为 OOXML，编辑其他流行格式（<code>.odt</code>、<code>.rtf</code>、<code>.txt</code>、<code>.html</code>、<code>.ods</code>、<code>.csv</code>、<code>.odp</code>）。</li>
<li>熟悉的选项卡式界面。</li>
<li>协作工具：两种协同编辑模式（快速和严谨），跟踪更改，评论和集成聊天。</li>
<li>灵活的访问权限管理：完全访问权限、只读、审阅、表单填写和评论。</li>
<li>使用 API 构建附加组件。</li>
<li>250 种可用语言和象形字母表。</li>
</ul>
<p>通过 API，开发人员可以将 ONLYOFFICE 编辑器集成到网站和利用程序设计语言编写的应用程序中，并能配置和管理编辑器。</p>
<p>要集成 ONLYOFFICE 编辑器，我们需要一个集成应用程序来连接编辑器（ONLYOFFICE 文档服务器）和服务。 要在你的界面中使用编辑器，因该授予 ONLYOFFICE 以下权限：</p>
<ul>
<li>添加并执行自定义代码。</li>
<li>用于下载和保存文件的匿名访问权限。这意味着编辑器仅与服务器端的服务通信，而不包括客户端的任何用户授权数据（浏览器 cookies）。</li>
<li>在用户界面添加新按钮（例如，“在 ONLYOFFICE 中打开”、“在 ONLYOFFICE 中编辑”）。</li>
<li>开启一个新页面，ONLYOFFICE 可以在其中执行脚本以添加编辑器。</li>
<li>能够指定文档服务器连接设置。</li>
</ul>
<p>流行的协作解决方案的成功集成案例有很多，如 Nextcloud、ownCloud、Alfresco、Confluence 和 SharePoint，都是通过 ONLYOFFICE 提供的官方即用型连接器实现的。</p>
<p>实际的集成案例之一是 ONLYOFFICE 编辑器与以 C＃ 编写的开源协作平台的集成。该平台具有文档和项目管理、CRM、电子邮件聚合器、日历、用户数据库、博客、论坛、调查、Wiki 和即时通讯程序的功能。</p>
<p>将在线编辑器与 CRM 和项目模块集成，你可以：</p>
<ul>
<li>文档关联到 CRM 时机和容器、项目任务和讨论，甚至创建一个单独的文件夹，其中包含与项目相关的文档、电子表格和演示文稿。</li>
<li>直接在 CRM 或项目模块中创建新的文档、工作表和演示文稿。</li>
<li>打开和编辑关联的文档，或者下载和删除。</li>
<li>将联系人从 CSV 文件批量导入到 CRM 中，并将客户数据库导出为 CSV 文件。</li>
</ul>
<p>在“邮件”模块中，你可以关联存储在“文档模块”中的文件，或者将指向所需文档的链接插入到邮件正文中。 当 ONLYOFFICE 用户收到带有附件的文档的消息时，他们可以：下载附件、在浏览器中查看文件、打开文件进行编辑或将其保存到“文档模块”。 如上所述，如果格式不同于 OOXML ，则文件将自动转换为 <code>.docx</code>、<code>.xlsx</code>、<code>.pptx</code>，并且其副本也将以原始格式保存。</p>
<p>在本文中，你将看到 ONLYOFFICE 与最流行的编程语言之一的 Python 编写的文档管理系统的集成过程。 以下步骤将向你展示如何创建所有必要的部分，以使在 DMS（<ruby> 文档管理系统 <rt>  Document Management System </rt></ruby>）界面内的文档中可以进行协同工作成为可能：查看、编辑、协同编辑、保存文件和用户访问管理，并可以作为服务的示例集成到 Python 应用程序中。</p>
<h3>1、前置需求</h3>
<p>首先，创建集成过程的关键组件：<a href="https://www.onlyoffice.com/en/developer-edition.aspx">ONLYOFFICE 文档服务器</a> 和用 Python 编写的文件管理系统。</p>
<h4>1.1、ONLYOFFICE 文档服务器</h4>
<p>要安装 ONLYOFFICE 文档服务器，你可以从多个安装选项中进行选择：编译 GitHub 上可用的源代码，使用 <code>.deb</code> 或 <code>.rpm</code> 软件包亦或 Docker 镜像。</p>
<p>我们推荐使用下面这条命令利用 Docker 映像安装文档服务器和所有必需的依赖。请注意，选择此方法，你需要安装最新的 Docker 版本。</p>
<div class="highlight"><pre><span></span><code>docker run -itd -p 80:80 onlyoffice/documentserver-de
</code></pre></div>

<h4>1.2、利用 Python 开发 DMS</h4>
<p>如果已经拥有一个，请检查它是否满足以下条件：</p>
<ul>
<li>包含需要打开以查看/编辑的保留文件</li>
<li>允许下载文件</li>
</ul>
<p>对于该应用程序，我们将使用 Bottle 框架。我们将使用以下命令将其安装在工作目录中：</p>
<div class="highlight"><pre><span></span><code>pip install bottle
</code></pre></div>

<p>然后我们创建应用程序代码 <code>main.py</code> 和模板 <code>index.tpl</code>。</p>
<p>我们将以下代码添加到 <code>main.py</code> 文件中：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">static_file</span> <span class="c1"># connecting the framework and the necessary components</span>
<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="c1"># setting up routing for requests for /</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;index.tpl&#39;</span><span class="p">)</span> <span class="c1"># showing template in response to request</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span> <span class="c1"># running the application on port 8080</span>
</code></pre></div>

<p>一旦我们运行该应用程序，点击 <a href="http://localhost:8080">http://localhost:8080</a> 就会在浏览器上呈现一个空白页面 。 为了使文档服务器能够创建新文档，添加默认文件并在模板中生成其名称列表，我们应该创建一个文件夹 <code>files</code> 并将3种类型文件（<code>.docx</code>、<code>.xlsx</code> 和 <code>.pptx</code>）放入其中。</p>
<p>要读取这些文件的名称，我们使用 <code>listdir</code> 组件（模块）：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
</code></pre></div>

<p>现在让我们为文件夹中的所有文件名创建一个变量：</p>
<div class="highlight"><pre><span></span><code>sample_files = [f for f in listdir(&#39;files&#39;)]
</code></pre></div>

<p>要在模板中使用此变量，我们需要通过 <code>template</code> 方法传递它：</p>
<div class="highlight"><pre><span></span><code>def index():
    return template(&#39;index.tpl&#39;, sample_files=sample_files)
</code></pre></div>

<p>这是模板中的这个变量：</p>
<div class="highlight"><pre><span></span><code>%<span class="w"> </span>for<span class="w"> </span>file<span class="w"> </span>in<span class="w"> </span>sample_files:
<span class="w">  </span><span class="nt">&lt;div&gt;</span>
<span class="w">    </span><span class="nt">&lt;span&gt;</span><span class="cp">{{</span><span class="nv">file</span><span class="cp">}}</span><span class="nt">&lt;/span&gt;</span>
<span class="w">  </span><span class="nt">&lt;/div&gt;</span>
%<span class="w"> </span>end
</code></pre></div>

<p>我们重新启动应用程序以查看页面上的文件名列表。</p>
<p>使这些文件可用于所有应用程序用户的方法如下：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@get</span><span class="p">(</span><span class="ss">&quot;/files/&lt;filepath:re:.*\.*&gt;&quot;</span><span class="p">)</span>
<span class="n">def</span><span class="w"> </span><span class="n">show_sample_files</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">static_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="o">=</span><span class="ss">&quot;files&quot;</span><span class="p">)</span>
</code></pre></div>

<h3>2、查看文档</h3>
<p>所有组件准备就绪后，让我们添加函数以使编辑者可以利用应用接口操作。</p>
<p>第一个选项使用户可以打开和查看文档。连接模板中的文档编辑器 API ：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;script</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="w"> </span><span class="na">src=</span><span class="s">&quot;editor_url/web-apps/apps/api/documents/api.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div>

<p><code>editor_url</code> 是文档编辑器的链接接口。</p>
<p>打开每个文件以供查看的按钮：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;button</span><span class="w"> </span><span class="na">onclick=</span><span class="s">&quot;view(&#39;files/</span><span class="cp">{{</span><span class="nv">file</span><span class="cp">}}</span><span class="s">&#39;)&quot;</span><span class="nt">&gt;</span>view<span class="nt">&lt;/button&gt;</span>
</code></pre></div>

<p>现在我们需要添加带有 <code>id</code> 的 <code>div</code> 标签，打开文档编辑器：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;div</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;editor&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</code></pre></div>

<p>要打开编辑器，必须调用调用一个函数：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;script&gt;</span>
function<span class="w"> </span>view(filename)<span class="w"> </span>{
<span class="w">    </span>if<span class="w"> </span>(/docx$/.exec(filename))<span class="w"> </span>{
<span class="w">        </span>filetype<span class="w"> </span>=<span class="w"> </span>&quot;text&quot;
<span class="w">    </span>}
<span class="w">    </span>if<span class="w"> </span>(/xlsx$/.exec(filename))<span class="w"> </span>{
<span class="w">        </span>filetype<span class="w"> </span>=<span class="w"> </span>&quot;spreadsheet&quot;
<span class="w">    </span>}
<span class="w">    </span>if<span class="w"> </span>(/pptx$/.exec(filename))<span class="w"> </span>{
<span class="w">        </span>filetype<span class="w"> </span>=<span class="w"> </span>&quot;presentation&quot;,
<span class="w">        </span>title:<span class="w"> </span>filename
<span class="w">    </span>}
​
<span class="w">    </span>new<span class="w"> </span>DocsAPI.DocEditor(&quot;editor&quot;,
<span class="w">        </span>{
<span class="w">            </span>documentType:<span class="w"> </span>filetype,
<span class="w">            </span>document:<span class="w"> </span>{
<span class="w">                </span>url:<span class="w"> </span>&quot;host_url&quot;<span class="w"> </span>+<span class="w"> </span>&#39;/&#39;<span class="w"> </span>+<span class="w"> </span>filename,
<span class="w">                </span>title:<span class="w"> </span>filename
<span class="w">            </span>},
<span class="w">            </span>editorConfig:<span class="w"> </span>{mode:<span class="w"> </span>&#39;view&#39;}
<span class="w">        </span>});
<span class="w">  </span>}
<span class="nt">&lt;/script&gt;</span>
</code></pre></div>

<p>DocEditor 函数有两个参数：将在其中打开编辑器的元素 <code>id</code> 和带有编辑器设置的 <code>JSON</code>。 在此示例中，使用了以下必需参数：</p>
<ul>
<li><code>documentType</code> 由其格式标识（<code>.docx</code>、<code>.xlsx</code>、<code>.pptx</code> 用于相应的文本、电子表格和演示文稿）</li>
<li><code>document.url</code> 是你要打开的文件链接。</li>
<li><code>editorConfig.mode</code>。</li>
</ul>
<p>我们还可以添加将在编辑器中显示的 <code>title</code>。</p>
<p>接下来，我们可以在 Python 应用程序中查看文档。</p>
<h3>3、编辑文档</h3>
<p>首先，添加 “Edit”（编辑）按钮：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;button</span><span class="w"> </span><span class="na">onclick=</span><span class="s">&quot;edit(&#39;files/</span><span class="cp">{{</span><span class="nv">file</span><span class="cp">}}</span><span class="s">&#39;)&quot;</span><span class="nt">&gt;</span>edit<span class="nt">&lt;/button&gt;</span>
</code></pre></div>

<p>然后创建一个新功能，打开文件进行编辑。类似于查看功能。</p>
<p>现在创建 3 个函数：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">editor</span><span class="p">;</span>
<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">view</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">editor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">editor</span><span class="o">.</span><span class="n">destroyEditor</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">editor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">DocsAPI</span><span class="o">.</span><span class="n">DocEditor</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">documentType</span><span class="p">:</span><span class="w"> </span><span class="n">get_file_type</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
<span class="w">                </span><span class="n">document</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host_url&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span>
<span class="w">                    </span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">filename</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="n">editorConfig</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;view&#39;</span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">edit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">editor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">editor</span><span class="o">.</span><span class="n">destroyEditor</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">editor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">DocsAPI</span><span class="o">.</span><span class="n">DocEditor</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">documentType</span><span class="p">:</span><span class="w"> </span><span class="n">get_file_type</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
<span class="w">                </span><span class="n">document</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host_url&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span>
<span class="w">                    </span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">filename</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">function</span><span class="w"> </span><span class="n">get_file_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">docx</span><span class="o">$/.</span><span class="n">exec</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;text&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">xlsx</span><span class="o">$/.</span><span class="n">exec</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;spreadsheet&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">pptx</span><span class="o">$/.</span><span class="n">exec</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;presentation&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</code></pre></div>

<p><code>destroyEditor</code> 被调用以关闭一个打开的编辑器。</p>
<p>你可能会注意到，<code>edit()</code> 函数中缺少 <code>editorConfig</code> 参数，因为默认情况下它的值是：<code>{"mode":"edit"}</code>。</p>
<p>现在，我们拥有了打开文档以在 Python 应用程序中进行协同编辑的所有功能。</p>
<h3>4、如何在 Python 应用中利用 ONLYOFFICE 协同编辑文档</h3>
<p>通过在编辑器中设置对同一文档使用相同的 <code>document.key</code> 来实现协同编辑。 如果没有此键值，则每次打开文件时，编辑器都会创建编辑会话。</p>
<p>为每个文档设置唯一键，以使用户连接到同一编辑会话时进行协同编辑。 密钥格式应为以下格式：<code>filename +"_key"</code>。下一步是将其添加到当前文档的所有配置中。</p>
<div class="highlight"><pre><span></span><code>document: {
    url: &quot;host_url&quot; + &#39;/&#39; + filepath,
    title: filename,
    key: filename + &#39;_key&#39;
},
</code></pre></div>

<h3>5、如何在 Python 应用中利用 ONLYOFFICE 保存文档</h3>
<p>每次我们更改并保存文件时，ONLYOFFICE 都会存储其所有版本。 让我们仔细看看它是如何工作的。 关闭编辑器后，文档服务器将构建要保存的文件版本并将请求发送到 <code>callbackUrl</code> 地址。 该请求包含 <code>document.key</code>和指向刚刚构建的文件的链接。</p>
<p><code>document.key</code> 用于查找文件的旧版本并将其替换为新版本。 由于这里没有任何数据库，因此仅使用 <code>callbackUrl</code> 发送文件名。</p>
<p>在 <code>editorConfig.callbackUrl</code> 的设置中指定 <code>callbackUrl</code> 参数并将其添加到 <code>edit()</code> 方法中：</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">edit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;files/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">editor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">editor</span><span class="o">.</span><span class="n">destroyEditor</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">editor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">DocsAPI</span><span class="o">.</span><span class="n">DocEditor</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">documentType</span><span class="p">:</span><span class="w"> </span><span class="n">get_file_type</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
<span class="w">                </span><span class="n">document</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host_url&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filepath</span><span class="p">,</span>
<span class="w">                    </span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_key&#39;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="p">,</span>
<span class="w">                </span><span class="n">editorConfig</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;edit&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">callbackUrl</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host_url&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/callback&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&amp;amp;filename=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">parameter</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>编写一种方法，在获取到 POST 请求发送到 <code>/callback</code> 地址后将保存文件：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@post</span><span class="p">(</span><span class="ss">&quot;/callback&quot;</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">processing</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">/</span><span class="n">callback</span>
<span class="n">def</span><span class="w"> </span><span class="n">callback</span><span class="p">()</span><span class="err">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="o">[</span><span class="n">&#39;status&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span>
<span class="w">        </span><span class="k">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requests</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="o">[</span><span class="n">&#39;url&#39;</span><span class="o">]</span><span class="p">).</span><span class="n">content</span>
<span class="w">        </span><span class="k">with</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="s1">&#39;files/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">query</span><span class="o">[</span><span class="n">&#39;filename&#39;</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">f</span><span class="p">:</span>
<span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="k">file</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ss">&quot;{\&quot;</span><span class="n">error</span><span class="err">\</span><span class="ss">&quot;:0}&quot;</span>
<span class="err">​</span>
</code></pre></div>

<p><code># status 2</code> 是已生成的文件，当我们关闭编辑器时，新版本的文件将保存到存储器中。</p>
<h3>6、管理用户</h3>
<p>如果应用中有用户，并且你需要查看谁在编辑文档，请在编辑器的配置中输入其标识符（<code>id</code>和<code>name</code>）。</p>
<p>在界面中添加选择用户的功能：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;user_selector&quot;</span><span class="w"> </span><span class="na">onchange=</span><span class="s">&quot;pick_user()&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;option</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">selected=</span><span class="s">&quot;selected&quot;</span><span class="nt">&gt;</span>JD<span class="nt">&lt;/option&gt;</span>
<span class="w">    </span><span class="nt">&lt;option</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>Turk<span class="nt">&lt;/option&gt;</span>
<span class="w">    </span><span class="nt">&lt;option</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>Elliot<span class="nt">&lt;/option&gt;</span>
<span class="w">    </span><span class="nt">&lt;option</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;4&quot;</span><span class="nt">&gt;</span>Carla<span class="nt">&lt;/option&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</code></pre></div>

<p>如果在标记 <code>&lt;script&gt;</code> 的开头添加对函数 <code>pick_user()</code> 的调用，负责初始化函数自身 <code>id</code> 和 <code>name</code> 变量。</p>
<div class="highlight"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">pick_user</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">user_selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">&quot;user_selector&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">this</span><span class="o">.</span><span class="n">current_user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_selector</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">user_selector</span><span class="o">.</span><span class="n">selectedIndex</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">;</span>
<span class="w">    </span><span class="n">this</span><span class="o">.</span><span class="n">current_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_selector</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">user_selector</span><span class="o">.</span><span class="n">selectedIndex</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>使用 <code>editorConfig.user.id</code> 和 <code>editorConfig.user.name</code> 来配置用户设置。将这些参数添加到文件编辑函数中的编辑器配置中。</p>
<div class="highlight"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">edit</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">filepath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;files/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">editor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">editor</span><span class="o">.</span><span class="n">destroyEditor</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">editor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">DocsAPI</span><span class="o">.</span><span class="n">DocEditor</span><span class="p">(</span><span class="s2">&quot;editor&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">documentType</span><span class="p">:</span><span class="w"> </span><span class="n">get_file_type</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
<span class="w">            </span><span class="n">document</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host_url&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filepath</span><span class="p">,</span>
<span class="w">                </span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">filename</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">editorConfig</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;edit&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="n">callbackUrl</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;host_url&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/callback&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;?filename=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span>
<span class="w">                </span><span class="n">user</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">current_user_id</span><span class="p">,</span>
<span class="w">                    </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">this</span><span class="o">.</span><span class="n">current_user_name</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>使用这种方法，你可以将 ONLYOFFICE 编辑器集成到用 Python 编写的应用程序中，并获得用于在文档上进行协同工作的所有必要工具。有关更多集成示例（Java、Node.js、PHP、Ruby），请参考官方的 <a href="https://api.onlyoffice.com/editors/basic">API 文档</a>。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>