<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>使用 trace-cmd 追踪内核</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Gaurav Kamathe trace-cmd 是一个易于使用，且特性众多、可用来追踪内核函数的命令。 在 之前的文章 里，我介绍了如何利用 ftrace 来追踪内核函 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2021/10/shi-yong-trace-cmd-zhui-zong-nei-he.html" rel="bookmark"
           title="Permalink to 使用 trace-cmd 追踪内核">使用 trace-cmd 追踪内核</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-10-05T14:58:24+02:00">
                Published: Tue 05 October 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Gaurav Kamathe</p>
<blockquote>
<p>trace-cmd 是一个易于使用，且特性众多、可用来追踪内核函数的命令。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202110/05/145818d2i9tgjetzj8itqg.jpg" title="Puzzle pieces coming together to form a computer screen"></p>
<p>在 <a href="/article-13752-1.html">之前的文章</a> 里，我介绍了如何利用 <code>ftrace</code> 来追踪内核函数。通过写入和读出文件来使用 <code>ftrace</code> 会变得很枯燥，所以我对它做了一个封装来运行带有选项的命令，以启用和禁用追踪、设置过滤器、查看输出、清除输出等等。</p>
<p><a href="https://lwn.net/Articles/410200/">trace-cmd</a> 命令是一个可以帮助你做到这一点的工具。在这篇文章中，我使用 <code>trace-cmd</code> 来执行我在 <code>ftrace</code> 文章中所做的相同任务。由于会经常参考那篇文章，建议在阅读这篇文章之前先阅读它。</p>
<h3>安装 trace-cmd</h3>
<p>本文中所有的命令都运行在 root 用户下。</p>
<p>因为 <code>ftrace</code> 机制被内置于内核中，因此你可以使用下面的命令进行验证它是否启用：</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">mount</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">grep</span><span class="w"> </span><span class="nx">tracefs</span>
<span class="nx">none</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="o">/</span><span class="nx">sys</span><span class="o">/</span><span class="nx">kernel</span><span class="o">/</span><span class="nx">tracing</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nx">tracefs</span><span class="w"> </span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span><span class="nx">relatime</span><span class="p">,</span><span class="nx">seclabel</span><span class="p">)</span>
</code></pre></div>

<p>不过，你需要手动尝试安装 <code>trace-cmd</code> 命令：</p>
<div class="highlight"><pre><span></span><code># dnf install trace-cmd -y
</code></pre></div>

<h3>列出可用的追踪器</h3>
<p>当使用 <code>ftrace</code> 时，你必须查看文件的内容以了解有哪些追踪器可用。但使用 <code>trace-cmd</code>，你可以通过以下方式获得这些信息:</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd list -t
hwlat blk mmiotrace function_graph wakeup_dl wakeup_rt wakeup function nop
</code></pre></div>

<h3>启用函数追踪器</h3>
<p>在我 <a href="/article-13752-1.html">之前的文章</a> 中，我使用了两个追踪器，在这里我也会这么做。用 <code>function</code> 启用你的第一个追踪器:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>trace-cmd<span class="w"> </span>start<span class="w"> </span>-p<span class="w"> </span><span class="k">function</span>
<span class="w">  </span>plugin<span class="w"> </span><span class="s1">&#39;function&#39;</span>
</code></pre></div>

<h3>查看追踪输出</h3>
<p>一旦追踪器被启用，你可以通过使用 <code>show</code> 参数来查看输出。这只显示了前 20 行以保持例子的简短（见我之前的文章对输出的解释）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># trace-cmd show | head -20</span>
<span class="c1">## tracer: function</span>
<span class="c1">#</span>
<span class="c1"># entries-in-buffer/entries-written: 410142/3380032   #P:8</span>
<span class="c1">#</span>
<span class="c1">#                                _-----=&gt; irqs-off</span>
<span class="c1">#                               / _----=&gt; need-resched</span>
<span class="c1">#                              | / _---=&gt; hardirq/softirq</span>
<span class="c1">#                              || / _--=&gt; preempt-depth</span>
<span class="c1">#                              ||| /     delay</span>
<span class="c1">#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION</span>
<span class="c1">#              | |         |   ||||      |         |</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538759</span><span class="p">:</span><span class="w"> </span><span class="n">__msecs_to_jiffies</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">rebalance_domains</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538760</span><span class="p">:</span><span class="w"> </span><span class="n">load_balance</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">rebalance_domains</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538761</span><span class="p">:</span><span class="w"> </span><span class="n">idle_cpu</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">load_balance</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538762</span><span class="p">:</span><span class="w"> </span><span class="n">group_balance_cpu</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">load_balance</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538762</span><span class="p">:</span><span class="w"> </span><span class="n">find_busiest_group</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">load_balance</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538763</span><span class="p">:</span><span class="w"> </span><span class="n">update_group_capacity</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">update_sd_lb_stats</span><span class="o">.</span><span class="n">constprop</span><span class="o">.</span><span class="mi">0</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538763</span><span class="p">:</span><span class="w"> </span><span class="n">__msecs_to_jiffies</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">update_group_capacity</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538765</span><span class="p">:</span><span class="w"> </span><span class="n">idle_cpu</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">update_sd_lb_stats</span><span class="o">.</span><span class="n">constprop</span><span class="o">.</span><span class="mi">0</span>
<span class="w">           </span><span class="n">gdbus</span><span class="o">-</span><span class="mi">2606</span><span class="w">    </span><span class="p">[</span><span class="mi">004</span><span class="p">]</span><span class="w"> </span><span class="o">..</span><span class="n">s</span><span class="o">.</span><span class="w"> </span><span class="mf">10520.538766</span><span class="p">:</span><span class="w"> </span><span class="n">__msecs_to_jiffies</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">rebalance_domains</span>
</code></pre></div>

<h3>停止追踪并清除缓冲区</h3>
<p>追踪将会在后台继续运行，你可以继续用 <code>show</code> 查看输出。</p>
<p>要停止追踪，请运行带有 <code>stop</code> 参数的 <code>trace-cmd</code> 命令：</p>
<div class="highlight"><pre><span></span><code># trace-cmd stop
</code></pre></div>

<p>要清除缓冲区，用 <code>clear</code> 参数运行它：</p>
<div class="highlight"><pre><span></span><code># trace-cmd clear
</code></pre></div>

<h3>启用函数调用图追踪器</h3>
<p>运行第二个追踪器，通过 <code>function_graph</code> 参数来启用它。</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd start -p function_graph
  Plugin &#39;function_graph&#39;
</code></pre></div>

<p>再次使用 <code>show</code> 参数查看输出。正如预期的那样，输出与第一次追踪输出略有不同。这一次，它包括一个<strong>函数调用</strong>链：</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nt">trace-cmd</span><span class="w"> </span><span class="nt">show</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nt">head</span><span class="w"> </span><span class="nt">-20</span>
<span class="err">##</span><span class="w"> </span><span class="nt">tracer</span><span class="o">:</span><span class="w"> </span><span class="nt">function_graph</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nt">CPU</span><span class="w">  </span><span class="nt">DURATION</span><span class="w">                  </span><span class="nt">FUNCTION</span><span class="w"> </span><span class="nt">CALLS</span>
<span class="err">#</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="o">|</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">079</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">        </span><span class="err">}</span><span class="w"> </span><span class="c">/* rcu_all_qs */</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">327</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="err">}</span><span class="w"> </span><span class="c">/* __cond_resched */</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">081</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">rcu_read_unlock_strict</span><span class="o">();</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">__cond_resched</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="err">4)</span><span class="w">   </span><span class="err">0.078</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">        </span><span class="err">rcu_all_qs()</span><span class="p">;</span>
<span class="w"> </span><span class="err">4)</span><span class="w">   </span><span class="err">0.243</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">      </span><span class="p">}</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">080</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">rcu_read_unlock_strict</span><span class="o">();</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">__cond_resched</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="err">4)</span><span class="w">   </span><span class="err">0.078</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">        </span><span class="err">rcu_all_qs()</span><span class="p">;</span>
<span class="w"> </span><span class="err">4)</span><span class="w">   </span><span class="err">0.241</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">      </span><span class="p">}</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">080</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">rcu_read_unlock_strict</span><span class="o">();</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">__cond_resched</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="err">4)</span><span class="w">   </span><span class="err">0.079</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">        </span><span class="err">rcu_all_qs()</span><span class="p">;</span>
<span class="w"> </span><span class="err">4)</span><span class="w">   </span><span class="err">0.235</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">      </span><span class="p">}</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">095</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">rcu_read_unlock_strict</span><span class="o">();</span>
<span class="w"> </span><span class="nt">4</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">__cond_resched</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>

<p>使用 <code>stop</code> 和 <code>clear</code> 命令来停止追踪和清除缓存区：</p>
<div class="highlight"><pre><span></span><code># trace-cmd stop
# trace-cmd clear
</code></pre></div>

<h3>调整追踪以增加深度</h3>
<p>如果你想在函数调用中看到更多的深度，你可以对追踪器进行调整：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd start -p function_graph --max-graph-depth 5
  plugin &#39;function_graph&#39;
</code></pre></div>

<p>现在，当你将这个输出与你之前看到的进行比较时，你应该看到更多的嵌套函数调用：</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nt">trace-cmd</span><span class="w"> </span><span class="nt">show</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nt">head</span><span class="w"> </span><span class="nt">-20</span>
<span class="err">##</span><span class="w"> </span><span class="nt">tracer</span><span class="o">:</span><span class="w"> </span><span class="nt">function_graph</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="nt">CPU</span><span class="w">  </span><span class="nt">DURATION</span><span class="w">                  </span><span class="nt">FUNCTION</span><span class="w"> </span><span class="nt">CALLS</span>
<span class="err">#</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">                     </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="o">|</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">        </span><span class="nt">__fget_light</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="err">6)</span><span class="w">   </span><span class="err">0.804</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">          </span><span class="err">__fget_files()</span><span class="p">;</span>
<span class="w"> </span><span class="err">6)</span><span class="w">   </span><span class="err">2.708</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">        </span><span class="p">}</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">   </span><span class="nt">3</span><span class="p">.</span><span class="nc">650</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="err">}</span><span class="w"> </span><span class="c">/* __fdget */</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">547</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">eventfd_poll</span><span class="o">();</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">535</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">fput</span><span class="o">();</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">__fdget</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="err">6)</span><span class="w">               </span><span class="err">|</span><span class="w">        </span><span class="err">__fget_light()</span><span class="w"> </span><span class="err">{</span>
<span class="w"> </span><span class="err">6)</span><span class="w">   </span><span class="err">0.946</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">          </span><span class="err">__fget_files()</span><span class="p">;</span>
<span class="w"> </span><span class="err">6)</span><span class="w">   </span><span class="err">1.895</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">        </span><span class="p">}</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">   </span><span class="nt">2</span><span class="p">.</span><span class="nc">849</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="err">}</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">sock_poll</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="err">6)</span><span class="w">   </span><span class="err">0.651</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">        </span><span class="err">unix_poll()</span><span class="p">;</span>
<span class="w"> </span><span class="err">6)</span><span class="w">   </span><span class="err">1.905</span><span class="w"> </span><span class="err">us</span><span class="w">    </span><span class="err">|</span><span class="w">      </span><span class="p">}</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">   </span><span class="nt">0</span><span class="p">.</span><span class="nc">475</span><span class="w"> </span><span class="nt">us</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="nt">fput</span><span class="o">();</span>
<span class="w"> </span><span class="nt">6</span><span class="o">)</span><span class="w">               </span><span class="o">|</span><span class="w">      </span><span class="nt">__fdget</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>

<h3>了解可被追踪的函数</h3>
<p>如果你想只追踪某些函数而忽略其他的，你需要知道确切的函数名称。你可以用 <code>list -f</code> 参数来得到它们。例如搜索常见的内核函数 <code>kmalloc</code>，它被用来在内核中分配内存：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd list -f | grep kmalloc
bpf_map_kmalloc_node
mempool_kmalloc
__traceiter_kmalloc
__traceiter_kmalloc_node
kmalloc_slab
kmalloc_order
kmalloc_order_trace
kmalloc_large_node
__kmalloc
__kmalloc_track_caller
__kmalloc_node
__kmalloc_node_track_caller
[...]
</code></pre></div>

<p>下面是我的测试系统中可被追踪的函数总数：</p>
<div class="highlight"><pre><span></span><code># trace-cmd list -f | wc -l
63165
</code></pre></div>

<h3>追踪内核模块相关的函数</h3>
<p>你也可以追踪与特定内核模块相关的函数。假设你想追踪 <code>kvm</code> 内核模块相关的功能，你可以通过以下方式来实现。请确保该模块已经加载：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> lsmod | grep kvm_intel
kvm_intel 335872 0
kvm 987136 1 kvm_intel
</code></pre></div>

<p>再次运行 <code>trace-cmd</code>，使用 <code>list</code> 参数，并从输出结果中，<code>grep</code> 查找以 <code>]</code> 结尾的行。这将过滤掉内核模块。然后 <code>grep</code> 内核模块 <code>kvm_intel</code> ，你应该看到所有与该内核模块有关的函数。</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">trace</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="err">]$</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">kvm_intel</span>
<span class="n">vmx_can_emulate_instruction</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">vmx_update_emulated_instruction</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">vmx_setup_uret_msr</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">vmx_set_identity_map_addr</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">handle_machine_check</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">handle_triple_fault</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">vmx_patch_hypercall</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>

<span class="o">[</span><span class="n">...</span><span class="o">]</span>

<span class="n">vmx_dump_dtsel</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
<span class="n">vmx_dump_sel</span><span class="w"> </span><span class="o">[</span><span class="n">kvm_intel</span><span class="o">]</span>
</code></pre></div>

<h3>追踪特定函数</h3>
<p>现在你知道了如何找到感兴趣的函数，请用一个例子把这些内容用于时间。就像前面的文章一样，试着追踪与文件系统相关的函数。我的测试系统上的文件系统是 <code>ext4</code>。</p>
<p>这个过程略有不同；你在运行命令时，不使用 <code>start</code> 参数，而是在 <code>record</code> 参数后面加上你想追踪的函数的“模式”。你还需要指定你想要的追踪器；在这种情况下，就是 <code>function_graph</code>。该命令会继续记录追踪，直到你用 <code>Ctrl+C</code> 停止它。所以几秒钟后，按 <code>Ctrl+C</code> 停止追踪：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd list -f | grep ^ext4_

<span class="gh">#</span> trace-cmd record -l ext4_* -p function_graph
  plugin &#39;function_graph&#39;
Hit Ctrl^C to stop recording
^C
CPU0 data recorded at offset=0x856000
    8192 bytes in size
[...]
</code></pre></div>

<h3>查看追踪记录</h3>
<p>要查看你之前的追踪记录，运行带有 <code>report</code> 参数的命令。从输出结果来看，很明显过滤器起作用了，你只看到 <code>ext4</code> 相关的函数追踪：</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nt">trace-cmd</span><span class="w"> </span><span class="nt">report</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nt">head</span><span class="w"> </span><span class="nt">-20</span>
<span class="cp">[</span><span class="nx">...</span><span class="cp">]</span>
<span class="nt">cpus</span><span class="o">=</span><span class="nt">8</span>
<span class="w">       </span><span class="nt">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="nt">11303</span><span class="p">.</span><span class="nc">928103</span><span class="o">:</span><span class="w"> </span><span class="nt">funcgraph_entry</span><span class="o">:</span><span class="w">                   </span><span class="o">|</span><span class="w">  </span><span class="nt">ext4_show_options</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="err">11303.928104:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">0.187</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="nf">ext4_get_dummy_policy</span><span class="p">();</span>
<span class="w">       </span><span class="err">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="err">11303.928105:</span><span class="w"> </span><span class="n">funcgraph_exit</span><span class="p">:</span><span class="w">         </span><span class="mf">1.583</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="p">}</span>
<span class="w">       </span><span class="nt">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="nt">11303</span><span class="p">.</span><span class="nc">928122</span><span class="o">:</span><span class="w"> </span><span class="nt">funcgraph_entry</span><span class="o">:</span><span class="w">                   </span><span class="o">|</span><span class="w">  </span><span class="nt">ext4_create</span><span class="o">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="err">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="err">11303.928122:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">    </span><span class="nf">ext4_alloc_inode</span><span class="p">()</span><span class="w"> </span><span class="err">{</span>
<span class="w">       </span><span class="n">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="mf">11303.928123</span><span class="o">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="o">:</span><span class="w">        </span><span class="mf">0.101</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="nf">ext4_es_init_tree</span><span class="p">();</span>
<span class="w">       </span><span class="err">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="err">11303.928123:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">0.083</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="nf">ext4_init_pending_tree</span><span class="p">();</span>
<span class="w">       </span><span class="err">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="err">11303.928123:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">0.141</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="nf">ext4_fc_init_inode</span><span class="p">();</span>
<span class="w">       </span><span class="err">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="err">11303.928123:</span><span class="w"> </span><span class="n">funcgraph_exit</span><span class="p">:</span><span class="w">         </span><span class="mf">0.931</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="p">}</span>
<span class="w">       </span><span class="nt">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="nt">11303</span><span class="p">.</span><span class="nc">928124</span><span class="o">:</span><span class="w"> </span><span class="nt">funcgraph_entry</span><span class="o">:</span><span class="w">        </span><span class="nt">0</span><span class="p">.</span><span class="nc">081</span><span class="w"> </span><span class="nt">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="nt">ext4_get_dummy_policy</span><span class="o">();</span>
<span class="w">       </span><span class="nt">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="nt">11303</span><span class="p">.</span><span class="nc">928124</span><span class="o">:</span><span class="w"> </span><span class="nt">funcgraph_entry</span><span class="o">:</span><span class="w">        </span><span class="nt">0</span><span class="p">.</span><span class="nc">133</span><span class="w"> </span><span class="nt">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="nt">ext4_get_group_desc</span><span class="o">();</span>
<span class="w">       </span><span class="nt">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="nt">11303</span><span class="p">.</span><span class="nc">928124</span><span class="o">:</span><span class="w"> </span><span class="nt">funcgraph_entry</span><span class="o">:</span><span class="w">        </span><span class="nt">0</span><span class="p">.</span><span class="nc">115</span><span class="w"> </span><span class="nt">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="nt">ext4_free_inodes_count</span><span class="o">();</span>
<span class="w">       </span><span class="nt">trace-cmd-12697</span><span class="w"> </span><span class="cp">[</span><span class="mi">000</span><span class="cp">]</span><span class="w"> </span><span class="nt">11303</span><span class="p">.</span><span class="nc">928124</span><span class="o">:</span><span class="w"> </span><span class="nt">funcgraph_entry</span><span class="o">:</span><span class="w">        </span><span class="nt">0</span><span class="p">.</span><span class="nc">114</span><span class="w"> </span><span class="nt">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="nt">ext4_get_group_desc</span><span class="o">();</span>
</code></pre></div>

<h3>追踪一个特定的 PID</h3>
<p>假设你想追踪与一个进程（PID）有关的函数。打开另一个终端，注意运行中的 shell 的PID：</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="nv">echo</span><span class="w"> </span><span class="p">$$</span>
<span class="mi">10885</span>
</code></pre></div>

<p>再次运行 <code>record</code> 命令，用 <code>-P</code> 选项传递PID。这一次，让终端运行（也就是说，先不要按 <code>Ctrl+C</code> ）：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd record -P 10885 -p function_graph
  Plugin &#39;function_graph&#39;
Hit Ctrl^C to stop recording
</code></pre></div>

<h3>在 shell 上运行一些命令</h3>
<p>移动到另一个终端，在那里你有一个以特定 PID 运行的 shell，并运行任何命令，例如，<code>ls</code> 命令用来列出文件：</p>
<div class="highlight"><pre><span></span><code># ls
Temp-9b61f280-fdc1-4512-9211-5c60f764d702
tracker-extract-3-files.1000
v8-compile-cache-1000
[...]
</code></pre></div>

<p>移动到你启用追踪的终端，按 <code>Ctrl+C</code> 停止追踪：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> trace-cmd record -P 10885 -p function_graph
  plugin &#39;function_graph&#39;
Hit Ctrl^C to stop recording
^C
CPU1 data recorded at offset=0x856000
    618496 bytes in size
[...]
</code></pre></div>

<p>在追踪的输出中，你可以看到左边是 PID 和 Bash shell，右边是与之相关的函数调用。这对于缩小你的追踪范围是非常方便的：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># trace-cmd report  | head -20</span>

<span class="n">cpus</span><span class="o">=</span><span class="mi">8</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;-</span><span class="mi">0</span><span class="w">     </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380581</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">  </span><span class="n">switch_mm_irqs_off</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;-</span><span class="mi">0</span><span class="w">     </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380583</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">1.703</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="n">load_new_mm_cr3</span><span class="p">();</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;-</span><span class="mi">0</span><span class="w">     </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380586</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">0.493</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="n">switch_ldt</span><span class="p">();</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">idle</span><span class="o">&gt;-</span><span class="mi">0</span><span class="w">     </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380587</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_exit</span><span class="p">:</span><span class="w">         </span><span class="mf">7.235</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="p">}</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380589</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">1.046</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="n">finish_task_switch</span><span class="o">.</span><span class="n">isra</span><span class="o">.</span><span class="mi">0</span><span class="p">();</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380591</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">  </span><span class="n">__fdget</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380592</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">        </span><span class="mf">2.036</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="n">__fget_light</span><span class="p">();</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380594</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_exit</span><span class="p">:</span><span class="w">         </span><span class="mf">3.256</span><span class="w"> </span><span class="n">us</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="p">}</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380595</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">  </span><span class="n">tty_poll</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380597</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">    </span><span class="n">tty_ldisc_ref_wait</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380598</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">      </span><span class="n">ldsem_down_read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bash</span><span class="o">-</span><span class="mi">10885</span><span class="w"> </span><span class="p">[</span><span class="mi">001</span><span class="p">]</span><span class="w"> </span><span class="mf">11555.380598</span><span class="p">:</span><span class="w"> </span><span class="n">funcgraph_entry</span><span class="p">:</span><span class="w">                   </span><span class="o">|</span><span class="w">        </span><span class="n">__cond_resched</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>

<h3>试一试</h3>
<p>这些简短的例子显示了使用 <code>trace-cmd</code> 命令而不是底层的 <code>ftrace</code> 机制，是如何实现既容易使用又拥有丰富的功能，许多内容本文并没有涉及。要想了解更多信息并更好地使用它，请查阅它的手册，并尝试使用其他有用的命令。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>