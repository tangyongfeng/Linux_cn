<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>C 语言编程中的 5 个常见错误及对应解决方案</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Jim Hall 增强 C 语言程序的弹性和可靠性的五种方法。 即使是最好的程序员也无法完全避免错误。这些错误可能会引入安 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2021/10/c-yu-yan-bian-cheng-zhong-de-5-ge-chang-jian-cuo-wu-ji-dui-ying-jie-jue-fang-an.html" rel="bookmark"
           title="Permalink to C 语言编程中的 5 个常见错误及对应解决方案">C 语言编程中的 5 个常见错误及对应解决方案</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-10-18T17:41:00+02:00">
                Published: Mon 18 October 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Jim Hall</p>
<blockquote>
<p>增强 C 语言程序的弹性和可靠性的五种方法。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202110/18/174123p4cz99skp9zz4nf4.jpg" title="Bug tracking magnifying glass on computer screen"></p>
<p>即使是最好的程序员也无法完全避免错误。这些错误可能会引入安全漏洞、导致程序崩溃或产生意外操作，具体影响要取决于程序的运行逻辑。</p>
<p>C 语言有时名声不太好，因为它不像近期的编程语言（比如 Rust）那样具有内存安全性。但是通过额外的代码，一些最常见和严重的 C 语言错误是可以避免的。下文讲解了可能影响应用程序的五个错误以及避免它们的方法：</p>
<h3>1、未初始化的变量</h3>
<p>程序启动时，系统会为其分配一块内存以供存储数据。这意味着程序启动时，变量将获得内存中的一个随机值。</p>
<p>有些编程环境会在程序启动时特意将内存“清零”，因此每个变量都得以有初始的零值。程序中的变量都以零值作为初始值，听上去是很不错的。但是在 C 编程规范中，系统并不会初始化变量。</p>
<p>看一下这个使用了若干变量和两个数组的示例程序：</p>
<div class="highlight"><pre><span></span><code><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nc">int</span>
<span class="n">main</span><span class="p">()</span>
<span class="err">{</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="n">numbers</span><span class="o">[</span><span class="n">5</span><span class="o">]</span><span class="p">;</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="o">*</span><span class="k">array</span><span class="p">;</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;These variables are not initialized:&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  i = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  j = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  k = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;This array is not initialized:&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  numbers[%d] = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;malloc an array ...&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;This malloc&#39;ed array is not initialized:&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  array[%d] = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="k">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">free</span><span class="p">(</span><span class="k">array</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="cm">/* done */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;Ok&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>这个程序不会初始化变量，所以变量以系统内存中的随机值作为初始值。在我的 Linux 系统上编译和运行这个程序，会看到一些变量恰巧有“零”值，但其他变量并没有：</p>
<div class="highlight"><pre><span></span><code><span class="n">These</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">initialized</span><span class="p">:</span>
<span class="w">  </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32766</span>
<span class="n">This</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">initialized</span><span class="p">:</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4199024</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">malloc</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">...</span>
<span class="n">This</span><span class="w"> </span><span class="n">malloc</span><span class="s1">&#39;ed array is not initialized:</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">Ok</span>
</code></pre></div>

<p>很幸运，<code>i</code> 和 <code>j</code> 变量是从零值开始的，但 <code>k</code> 的起始值为 32766。在 <code>numbers</code> 数组中，大多数元素也恰好从零值开始，只有第三个元素的初始值为 4199024。</p>
<p>在不同的系统上编译相同的程序，可以进一步显示未初始化变量的危险性。不要误以为“全世界都在运行 Linux”，你的程序很可能某天在其他平台上运行。例如，下面是在 FreeDOS 上运行相同程序的结果：</p>
<div class="highlight"><pre><span></span><code><span class="n">These</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">initialized</span><span class="p">:</span>
<span class="w">  </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1074</span>
<span class="w">  </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3120</span>
<span class="n">This</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">initialized</span><span class="p">:</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3106</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1224</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">784</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2926</span>
<span class="w">  </span><span class="n">numbers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1224</span>
<span class="n">malloc</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="o">...</span>
<span class="n">This</span><span class="w"> </span><span class="n">malloc</span><span class="s1">&#39;ed array is not initialized:</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3136</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3136</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14499</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">5886</span>
<span class="w">  </span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">219</span>
<span class="n">Ok</span>
</code></pre></div>

<p>永远都要记得初始化程序的变量。如果你想让变量将以零值作为初始值，请额外添加代码将零分配给该变量。预先编好这些额外的代码，这会有助于减少日后让人头疼的调试过程。</p>
<h3>2、数组越界</h3>
<p>C 语言中，数组索引从零开始。这意味着对于长度为 10 的数组，索引是从 0 到 9；长度为 1000 的数组，索引则是从 0 到 999。</p>
<p>程序员有时会忘记这一点，他们从索引 1 开始引用数组，产生了<ruby> “大小差一” <rt>  off by one </rt></ruby>错误。在长度为 5 的数组中，程序员在索引“5”处使用的值，实际上并不是数组的第 5 个元素。相反，它是内存中的一些其他值，根本与此数组无关。</p>
<p>这是一个数组越界的示例程序。该程序使用了一个只含有 5 个元素的数组，但却引用了该范围之外的数组元素：</p>
<div class="highlight"><pre><span></span><code><span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">#include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nc">int</span>
<span class="n">main</span><span class="p">()</span>
<span class="err">{</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="n">numbers</span><span class="o">[</span><span class="n">5</span><span class="o">]</span><span class="p">;</span>
<span class="w">  </span><span class="nc">int</span><span class="w"> </span><span class="o">*</span><span class="k">array</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* test 1 */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;This array has five elements (0 to 4)&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* initalize the array */</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="cm">/* oops, this goes beyond the array bounds: */</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  numbers[%d] = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="cm">/* test 2 */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;malloc an array ...&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">array</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;This malloc&#39;ed array also has five elements (0 to 4)&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* initalize the array */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="k">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="cm">/* oops, this goes beyond the array bounds: */</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="ss">&quot;  array[%d] = %d\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="k">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="k">free</span><span class="p">(</span><span class="k">array</span><span class="p">);</span>
<span class="w">  </span><span class="err">}</span>

<span class="w">  </span><span class="cm">/* done */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="ss">&quot;Ok&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>可以看到，程序初始化了数组的所有值（从索引 0 到 4），然后从索引 0 开始读取，结尾是索引 9 而不是索引 4。前五个值是正确的，再后面的值会让你不知所以：</p>
<div class="highlight"><pre><span></span><code>This array has five elements (0 to 4)
  numbers[0] = 0
  numbers[1] = 1
  numbers[2] = 2
  numbers[3] = 3
  numbers[4] = 4
  numbers[5] = 0
  numbers[6] = 4198512
  numbers[7] = 0
  numbers[8] = 1326609712
  numbers[9] = 32764
malloc an array ...
This malloc&#39;ed array also has five elements (0 to 4)
  array[0] = 0
  array[1] = 1
  array[2] = 2
  array[3] = 3
  array[4] = 4
  array[5] = 0
  array[6] = 133441
  array[7] = 0
  array[8] = 0
  array[9] = 0
Ok
</code></pre></div>

<p>引用数组时，始终要记得追踪数组大小。将数组大小存储在变量中；不要对数组大小进行<ruby> 硬编码 <rt>  hard-code </rt></ruby>。否则，如果后期该标识符指向另一个不同大小的数组，却忘记更改硬编码的数组长度时，程序就可能会发生数组越界。</p>
<h3>3、字符串溢出</h3>
<p>字符串只是特定类型的数组。在 C 语言中，字符串是一个由 <code>char</code> 类型值组成的数组，其中用一个零字符表示字符串的结尾。</p>
<p>因此，与数组一样，要注意避免超出字符串的范围。有时也称之为 <em>字符串溢出</em>。</p>
<p>使用 <code>gets</code> 函数读取数据是一种很容易发生字符串溢出的行为方式。<code>gets</code> 函数非常危险，因为它不知道在一个字符串中可以存储多少数据，只会机械地从用户那里读取数据。如果用户输入像 <code>foo</code> 这样的短字符串，不会发生意外；但是当用户输入的值超过字符串长度时，后果可能是灾难性的。</p>
<p>下面是一个使用 <code>gets</code> 函数读取城市名称的示例程序。在这个程序中，我还添加了一些未使用的变量，来展示字符串溢出对其他数据的影响：</p>
<div class="highlight"><pre><span></span><code><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;string.h&gt;</span>

<span class="nb nb-Type">int</span>
<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="nb">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="w">                       </span><span class="o">/*</span><span class="w"> </span><span class="n">Such</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s2">&quot;Chicago&quot;</span><span class="w"> </span><span class="o">*/</span>
<span class="w">  </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">*/</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;var1 = </span><span class="si">%d</span><span class="s2">; var2 = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="p">);</span>

<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t use gets */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Where do you live?&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">gets</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">ending</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">*/</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt; is length </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;var1 = </span><span class="si">%d</span><span class="s2">; var2 = </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="p">);</span>

<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">*/</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Ok&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>当你测试类似的短城市名称时，该程序运行良好，例如伊利诺伊州的 <code>Chicago</code> 或北卡罗来纳州的<code>Raleigh</code>：</p>
<div class="highlight"><pre><span></span><code><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">Where</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">live</span><span class="err">?</span>
<span class="n">Raleigh</span>
<span class="o">&lt;</span><span class="n">Raleigh</span><span class="o">&gt;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">7</span>
<span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">Ok</span>
</code></pre></div>

<p>威尔士的小镇 <code>Llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch</code> 有着世界上最长的名字之一。这个字符串有 58 个字符，远远超出了 <code>name</code> 变量中保留的 10 个字符。结果，程序将值存储在内存的其他区域，覆盖了 <code>var1</code> 和 <code>var2</code> 的值：</p>
<div class="highlight"><pre><span></span><code><span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">Where</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">live</span><span class="err">?</span>
<span class="n">Llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch</span>
<span class="o">&lt;</span><span class="n">Llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch</span><span class="o">&gt;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="mi">58</span>
<span class="n">var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2036821625</span><span class="p">;</span><span class="w"> </span><span class="n">var2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2003266668</span>
<span class="n">Ok</span>
<span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span><span class="p">)</span>
</code></pre></div>

<p>在运行结束之前，程序会用长字符串覆盖内存的其他部分区域。注意，<code>var1</code> 和 <code>var2</code> 的值不再是起始的 <code>1</code> 和 <code>2</code>。</p>
<p>避免使用 <code>gets</code> 函数，改用更安全的方法来读取用户数据。例如，<code>getline</code> 函数会分配足够的内存来存储用户输入，因此不会因输入长值而发生意外的字符串溢出。</p>
<h3>4、重复释放内存</h3>
<p>“分配的内存要手动释放”是良好的 C 语言编程原则之一。程序可以使用 <code>malloc</code> 函数为数组和字符串分配内存，该函数会开辟一块内存，并返回一个指向内存中起始地址的指针。之后，程序可以使用 <code>free</code> 函数释放内存，该函数会使用指针将内存标记为未使用。</p>
<p>但是，你应该只使用一次 <code>free</code> 函数。第二次调用 <code>free</code> 会导致意外的后果，可能会毁掉你的程序。下面是一个针对此点的简短示例程序。程序分配了内存，然后立即释放了它。但为了模仿一个健忘但有条理的程序员，我在程序结束时又一次释放了内存，导致两次释放了相同的内存：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="p">;</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;malloc an array ...&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;malloc succeeded&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Free the array...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Free the array...&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Ok&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>运行这个程序会导致第二次使用 <code>free</code> 函数时出现戏剧性的失败：</p>
<div class="highlight"><pre><span></span><code>malloc an array ...
malloc succeeded
Free the array...
Free the array...
free(): double free detected in tcache 2
Aborted (core dumped)
</code></pre></div>

<p>要记得避免在数组或字符串上多次调用 <code>free</code>。将 <code>malloc</code> 和 <code>free</code> 函数定位在同一个函数中，这是避免重复释放内存的一种方法。</p>
<p>例如，一个纸牌游戏程序可能会在主函数中为一副牌分配内存，然后在其他函数中使用这副牌来玩游戏。记得在主函数，而不是其他函数中释放内存。将 <code>malloc</code> 和 <code>free</code> 语句放在一起有助于避免多次释放内存。</p>
<h3>5、使用无效的文件指针</h3>
<p>文件是一种便捷的数据存储方式。例如，你可以将程序的配置数据存储在 <code>config.dat</code> 文件中。Bash shell 会从用户家目录中的 <code>.bash_profile</code> 读取初始化脚本。GNU Emacs 编辑器会寻找文件 <code>.emacs</code> 以从中确定起始值。而 Zoom 会议客户端使用 <code>zoomus.conf</code> 文件读取其程序配置。</p>
<p>所以，从文件中读取数据的能力几乎对所有程序都很重要。但是假如要读取的文件不存在，会发生什么呢？</p>
<p>在 C 语言中读取文件，首先要用 <code>fopen</code> 函数打开文件，该函数会返回指向文件的流指针。你可以结合其他函数，使用这个指针来读取数据，例如 <code>fgetc</code> 会逐个字符地读取文件。</p>
<p>如果要读取的文件不存在或程序没有读取权限，<code>fopen</code> 函数会返回 <code>NULL</code> 作为文件指针，这表示文件指针无效。但是这里有一个示例程序，它机械地直接去读取文件，不检查 <code>fopen</code> 是否返回了 <code>NULL</code>：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">pfile</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Open the FILE.TXT file ...&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">pfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">&quot;FILE.TXT&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* you should check if the file pointer is valid, but we skipped that */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Now display the contents of FILE.TXT ...&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fgetc</span><span class="p">(</span><span class="n">pfile</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EOF</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;%c&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">fclose</span><span class="p">(</span><span class="n">pfile</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* done */</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Ok&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>当你运行这个程序时，第一次调用 <code>fgetc</code> 会失败，程序会立即中止：</p>
<div class="highlight"><pre><span></span><code>Open the FILE.TXT file ...
Now display the contents of FILE.TXT ...
Segmentation fault (core dumped)
</code></pre></div>

<p>始终检查文件指针以确保其有效。例如，在调用 <code>fopen</code> 打开一个文件后，用类似 <code>if (pfile != NULL)</code> 的语句检查指针，以确保指针是可以使用的。</p>
<p>人都会犯错，最优秀的程序员也会产生编程错误。但是，遵循上面这些准则，添加一些额外的代码来检查这五种类型的错误，就可以避免最严重的 C 语言编程错误。提前编写几行代码来捕获这些错误，可能会帮你节省数小时的调试时间。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>