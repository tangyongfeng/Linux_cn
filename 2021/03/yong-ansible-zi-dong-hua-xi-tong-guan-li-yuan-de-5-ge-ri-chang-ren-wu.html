<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>用 Ansible 自动化系统管理员的 5 个日常任务</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Mike Calizo 通过使用 Ansible 自动执行可重复的日常任务，提高工作效率并避免错误。 如果你讨厌执行重复性的任务，那么我有一个 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2021/03/yong-ansible-zi-dong-hua-xi-tong-guan-li-yuan-de-5-ge-ri-chang-ren-wu.html" rel="bookmark"
           title="Permalink to 用 Ansible 自动化系统管理员的 5 个日常任务">用 Ansible 自动化系统管理员的 5 个日常任务</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-03-31T23:39:12+02:00">
                Published: Wed 31 March 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Mike Calizo</p>
<blockquote>
<p>通过使用 Ansible 自动执行可重复的日常任务，提高工作效率并避免错误。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/202103/31/233904oo7q68eo2njfmf8o.jpg" title="Tips and gears turning"></p>
<p>如果你讨厌执行重复性的任务，那么我有一个提议给你，去学习 <a href="https://www.ansible.com/">Ansible</a>!</p>
<p>Ansible 是一个工具，它可以帮助你更轻松、更快速地完成日常任务，这样你就可以更有效地利用时间，比如学习重要的新技术。对于系统管理员来说，它是一个很好的工具，因为它可以帮助你实现标准化，并在日常活动中进行协作，包括：</p>
<ol>
<li>安装、配置和调配服务器和应用程序；</li>
<li>定期更新和升级系统；</li>
<li>监测、减轻和排除问题。</li>
</ol>
<p>通常，许多这些基本的日常任务都需要手动步骤，而根据个人的技能的不同，可能会造成不一致并导致配置发生漂移。这在小规模的实施中可能是可以接受的，因为你管理一台服务器，并且知道自己在做什么。但当你管理数百或数千台服务器时会发生什么？</p>
<p>如果不小心，这些手动的、可重复的任务可能会因为人为的错误而造成延误和问题，而这些错误可能会影响你及你的组织的声誉。</p>
<p>这就是自动化的价值所在。而 <a href="https://opensource.com/tags/ansible">Ansible</a> 是自动化这些可重复的日常任务的完美工具。</p>
<p>自动化的一些原因是：</p>
<ol>
<li>你想要一个一致和稳定的环境。</li>
<li>你想要促进标准化。</li>
<li>你希望减少停机时间，减少严重事故案例，以便可以享受生活。</li>
<li>你想喝杯啤酒，而不是排除故障问题!</li>
</ol>
<p>本文提供了一些系统管理员可以使用 Ansible 自动化的日常任务的例子。我把本文中的剧本和角色放到了 GitHub 上的 <a href="https://github.com/mikecali/6_sysadmin_tasks">系统管理员任务仓库</a> 中，以方便你使用它们。</p>
<p>这些剧本的结构是这样的（我的注释前面有 <code>==&gt;</code>）。</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">homebase</span><span class="w"> </span><span class="mi">6</span><span class="n">_sysadmin_tasks</span><span class="p">]</span><span class="c1"># tree -L 2</span>
<span class="o">.</span>
<span class="err">├──</span><span class="w"> </span><span class="n">ansible</span><span class="o">.</span><span class="n">cfg</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="err">负责控制</span><span class="w"> </span><span class="n">Ansible</span><span class="w"> </span><span class="err">行为的配置文件</span>
<span class="err">├──</span><span class="w"> </span><span class="n">ansible</span><span class="o">.</span><span class="n">log</span>
<span class="err">├──</span><span class="w"> </span><span class="n">inventory</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">group_vars</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">hosts</span><span class="w">  </span><span class="o">==&gt;</span><span class="w"> </span><span class="err">包含我的目标服务器列表的清单文件</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">host_vars</span>
<span class="err">├──</span><span class="w"> </span><span class="n">LICENSE</span>
<span class="err">├──</span><span class="w"> </span><span class="n">playbooks</span><span class="w">  </span><span class="o">==&gt;</span><span class="w"> </span><span class="err">包含我们将在本文中使用的剧本的目录</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">c_logs</span><span class="o">.</span><span class="n">yml</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">c_stats</span><span class="o">.</span><span class="n">yml</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">c_uptime</span><span class="o">.</span><span class="n">yml</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">inventory</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">r_cron</span><span class="o">.</span><span class="n">yml</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">r_install</span><span class="o">.</span><span class="n">yml</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">r_script</span><span class="o">.</span><span class="n">yml</span>
<span class="err">├──</span><span class="w"> </span><span class="n">README</span><span class="o">.</span><span class="n">md</span>
<span class="err">├──</span><span class="w"> </span><span class="n">roles</span><span class="w">    </span><span class="o">==&gt;</span><span class="w"> </span><span class="err">包含我们将在本文中使用的角色的目录</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">check_logs</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">check_stats</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">check_uptime</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">install_cron</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">install_tool</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">run_scr</span>
<span class="err">└──</span><span class="w"> </span><span class="n">templates</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="err">包含</span><span class="w"> </span><span class="n">jinja</span><span class="w"> </span><span class="err">模板的目录</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">cron_output</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">j2</span>
<span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="n">sar</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">j2</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="n">scr_output</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">j2</span>
</code></pre></div>

<p>清单类似这样的：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@homebase 6_sysadmin_tasks</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span>
<span class="o">[</span><span class="n">rhel8</span><span class="o">]</span>
<span class="n">master</span><span class="w"> </span><span class="n">ansible_ssh_host</span><span class="o">=</span><span class="mf">192.168.1.12</span>
<span class="n">workernode1</span><span class="w"> </span><span class="n">ansible_ssh_host</span><span class="o">=</span><span class="mf">192.168.1.15</span>

<span class="o">[</span><span class="n">rhel8:vars</span><span class="o">]</span>
<span class="n">ansible_user</span><span class="o">=</span><span class="n">ansible</span><span class="w"> </span><span class="o">==&gt;</span><span class="w"> </span><span class="n">请用你的</span><span class="w"> </span><span class="n">ansible</span><span class="w"> </span><span class="n">用户名更新它</span>
</code></pre></div>

<p>这里有五个你可以用 Ansible 自动完成的日常系统管理任务。</p>
<h3>1、检查服务器的正常运行时间</h3>
<p>你需要确保你的服务器一直处于正常运行状态。机构会拥有企业监控工具来监控服务器和应用程序的正常运行时间，但自动监控工具时常会出现故障，你需要登录进去验证一台服务器的状态。手动验证每台服务器的正常运行时间需要花费大量的时间。你的服务器越多，你需要花费的时间就越长。但如果有了自动化，这种验证可以在几分钟内完成。</p>
<p>使用 <a href="https://github.com/mikecali/6_sysadmin_tasks/tree/main/roles/check_uptime">check_uptime</a> 角色和 <code>c_uptime.yml</code> 剧本：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">homebase</span><span class="w"> </span><span class="mi">6</span><span class="n">_sysadmin_tasks</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span><span class="w">  </span><span class="n">playbooks</span><span class="o">/</span><span class="n">c_uptime</span><span class="p">.</span><span class="n">yml</span><span class="w"> </span><span class="o">-</span><span class="n">k</span>
<span class="n">SSH</span><span class="w"> </span><span class="n">password</span><span class="o">:</span>
<span class="n">PLAY</span><span class="w"> </span><span class="p">[</span><span class="n">Check</span><span class="w"> </span><span class="n">Uptime</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Servers</span><span class="p">]</span><span class="w"> </span><span class="o">****************************************************************************************************************************************</span>
<span class="n">TASK</span><span class="w"> </span><span class="p">[</span><span class="n">check_uptime</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Capture</span><span class="w"> </span><span class="n">timestamp</span><span class="p">]</span><span class="w"> </span><span class="o">*************************************************************************************************</span>
<span class="p">.</span>
<span class="n">截断</span><span class="p">...</span>
<span class="p">.</span>
<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">*************************************************************************************************************************************************************</span>
<span class="nl">master</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">6</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">4</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="nl">workernode1</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">6</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">4</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">homebase</span><span class="w"> </span><span class="mi">6</span><span class="n">_sysadmin_tasks</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<p>剧本的输出是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="k">[</span><span class="c">root@homebase 6_sysadmin_tasks</span><span class="k">]</span><span class="c"># cat /var/tmp/uptime</span><span class="nb">-</span><span class="c">master</span><span class="nb">-</span><span class="c">20210221004417</span><span class="nt">.</span><span class="c">txt</span>
<span class="nb">-----------------------------------------------------</span>
<span class="c"> Uptime for  master</span>
<span class="nb">-----------------------------------------------------</span>
<span class="c"> 00:44:17 up 44 min</span><span class="nt">,</span><span class="c">  2 users</span><span class="nt">,</span><span class="c">  load average: 0</span><span class="nt">.</span><span class="c">01</span><span class="nt">,</span><span class="c"> 0</span><span class="nt">.</span><span class="c">09</span><span class="nt">,</span><span class="c"> 0</span><span class="nt">.</span><span class="c">09</span>
<span class="nb">-----------------------------------------------------</span>
<span class="k">[</span><span class="c">root@homebase 6_sysadmin_tasks</span><span class="k">]</span><span class="c"># cat /var/tmp/uptime</span><span class="nb">-</span><span class="c">workernode1</span><span class="nb">-</span><span class="c">20210221184525</span><span class="nt">.</span><span class="c">txt</span>
<span class="nb">-----------------------------------------------------</span>
<span class="c"> Uptime for  workernode1</span>
<span class="nb">-----------------------------------------------------</span>
<span class="c"> 18:45:26 up 44 min</span><span class="nt">,</span><span class="c">  2 users</span><span class="nt">,</span><span class="c">  load average: 0</span><span class="nt">.</span><span class="c">01</span><span class="nt">,</span><span class="c"> 0</span><span class="nt">.</span><span class="c">01</span><span class="nt">,</span><span class="c"> 0</span><span class="nt">.</span><span class="c">00</span>
<span class="nb">-----------------------------------------------------</span>
</code></pre></div>

<p>使用 Ansible，你可以用较少的努力以人类可读的格式获得多个服务器的状态，<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html">Jinja 模板</a> 允许你根据自己的需要调整输出。通过更多的自动化，你可以按计划运行，并通过电子邮件发送输出，以达到报告的目的。</p>
<h3>2、配置额外的 cron 作业</h3>
<p>你需要根据基础设施和应用需求定期更新服务器的计划作业。这似乎是一项微不足道的工作，但必须正确且持续地完成。想象一下，如果你对数百台生产服务器进行手动操作，这需要花费多少时间。如果做错了，就会影响生产应用程序，如果计划的作业重叠，就会导致应用程序停机或影响服务器性能。</p>
<p>使用 <a href="https://github.com/mikecali/6_sysadmin_tasks/tree/main/roles/install_cron">install_cron</a> 角色和 <code>r_cron.yml</code> 剧本：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@homebase 6_sysadmin_tasks</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span><span class="w"> </span><span class="n">playbooks</span><span class="o">/</span><span class="n">r_cron</span><span class="p">.</span><span class="n">yml</span><span class="w"> </span><span class="o">-</span><span class="n">k</span>
<span class="n">SSH</span><span class="w"> </span><span class="nl">password</span><span class="p">:</span>
<span class="n">PLAY</span><span class="w"> </span><span class="o">[</span><span class="n">Install additional cron jobs for root</span><span class="o">]</span><span class="w"> </span><span class="o">***************************************************************************************************************************</span>
<span class="p">.</span>
<span class="n">截断</span><span class="p">...</span>
<span class="p">.</span>
<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">*************************************************************************************************************************************************************</span>
<span class="n">master</span><span class="w">                     </span><span class="err">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">10</span><span class="w">   </span><span class="n">changed</span><span class="o">=</span><span class="mi">7</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="n">workernode1</span><span class="w">                </span><span class="err">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">10</span><span class="w">   </span><span class="n">changed</span><span class="o">=</span><span class="mi">7</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span>
</code></pre></div>

<p>验证剧本的结果：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">homebase</span><span class="w"> </span><span class="mi">6</span><span class="n">_sysadmin_tasks</span><span class="p">]</span><span class="c1"># ansible -i inventory/hosts all -m shell -a &quot;crontab -l&quot; -k</span>
<span class="n">SSH</span><span class="w"> </span><span class="n">password</span><span class="p">:</span>
<span class="k">master</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CHANGED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;&gt;</span>
<span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ls</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span>
<span class="c1">#Ansible: Iotop Monitoring</span>
<span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iotop</span><span class="w"> </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iotop</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iotop</span><span class="o">.</span><span class="n">err</span>
<span class="n">workernode1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CHANGED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;&gt;</span>
<span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ls</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span>
<span class="c1">#Ansible: Iotop Monitoring</span>
<span class="mi">0</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iotop</span><span class="w"> </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iotop</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iotop</span><span class="o">.</span><span class="n">err</span>
</code></pre></div>

<p>使用 Ansible，你可以以快速和一致的方式更新所有服务器上的 crontab 条目。你还可以使用一个简单的点对点 Ansible 命令来报告更新后的 crontab 的状态，以验证最近应用的变化。</p>
<h3>3、收集服务器统计和 sars</h3>
<p>在常规的故障排除过程中，为了诊断服务器性能或应用程序问题，你需要收集<ruby> 系统活动报告 <rt>  system activity reports </rt></ruby>（sars）和服务器统计。在大多数情况下，服务器日志包含非常重要的信息，开发人员或运维团队需要这些信息来帮助解决影响整个环境的具体问题。</p>
<p>安全团队在进行调查时非常特别，大多数时候，他们希望查看多个服务器的日志。你需要找到一种简单的方法来收集这些文档。如果你能把收集任务委托给他们就更好了。</p>
<p>通过 <a href="https://github.com/mikecali/6_sysadmin_tasks/tree/main/roles/check_stats">check_stats</a> 角色和 <code>c_stats.yml</code> 剧本来完成这个任务：</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span><span class="w">  </span><span class="n">playbooks</span><span class="o">/</span><span class="n">c_stats</span><span class="p">.</span><span class="n">yml</span>

<span class="n">PLAY</span><span class="w"> </span><span class="p">[</span><span class="n">Check</span><span class="w"> </span><span class="n">Stats</span><span class="o">/</span><span class="n">sar</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Servers</span><span class="p">]</span><span class="w"> </span><span class="o">***********************************************************************************************************************************</span>

<span class="n">TASK</span><span class="w"> </span><span class="p">[</span><span class="n">check_stats</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="n">time</span><span class="p">]</span><span class="w"> </span><span class="o">***************************************************************************************************************************</span>
<span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">master</span><span class="p">]</span>
<span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">workernode1</span><span class="p">]</span>
<span class="p">.</span>
<span class="n">截断</span><span class="p">...</span>
<span class="p">.</span>
<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">***********************************************************************************************************************************************************</span>
<span class="nl">master</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">5</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">4</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="nl">workernode1</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">5</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">4</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span>
</code></pre></div>

<p>输出看起来像这样：</p>
<div class="highlight"><pre><span></span><code><span class="c">$ cat /tmp/sar</span><span class="nb">-</span><span class="c">workernode1</span><span class="nb">-</span><span class="c">20210221214056</span><span class="nt">.</span><span class="c">txt</span>
<span class="nb">-----------------------------------------------------</span>
<span class="c"> sar output for workernode1</span>
<span class="nb">-----------------------------------------------------</span>
<span class="c">Linux 4</span><span class="nt">.</span><span class="c">18</span><span class="nt">.</span><span class="c">0</span><span class="nb">-</span><span class="c">193</span><span class="nt">.</span><span class="c">el8</span><span class="nt">.</span><span class="c">x86_64 (node1)     21/02/21        _x86_64_        (2 CPU)</span>
<span class="c">21:39:30     LINUX RESTART      (2 CPU)</span>
<span class="nb">-----------------------------------------------------</span>
</code></pre></div>

<h3>4、收集服务器日志</h3>
<p>除了收集服务器统计和 sars 信息，你还需要不时地收集日志，尤其是当你需要帮助调查问题时。</p>
<p>通过 <a href="https://github.com/mikecali/6_sysadmin_tasks/tree/main/roles/check_logs">check_logs</a> 角色和 <code>r_cron.yml</code> 剧本来实现：</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span><span class="w">  </span><span class="n">playbooks</span><span class="o">/</span><span class="n">c_logs</span><span class="p">.</span><span class="n">yml</span><span class="w"> </span><span class="o">-</span><span class="n">k</span>
<span class="n">SSH</span><span class="w"> </span><span class="n">password</span><span class="o">:</span>

<span class="n">PLAY</span><span class="w"> </span><span class="p">[</span><span class="n">Check</span><span class="w"> </span><span class="n">Logs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Servers</span><span class="p">]</span><span class="w"> </span><span class="o">****************************************************************************************************************************************</span>
<span class="p">.</span>
<span class="n">截断</span><span class="p">...</span>
<span class="p">.</span>
<span class="n">TASK</span><span class="w"> </span><span class="p">[</span><span class="n">check_logs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Capture</span><span class="w"> </span><span class="n">Timestamp</span><span class="p">]</span><span class="w"> </span><span class="o">********************************************************************************************************************************</span>
<span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">master</span><span class="p">]</span>
<span class="nl">changed</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">workernode1</span><span class="p">]</span>
<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">***********************************************************************************************************************************************************</span>
<span class="nl">master</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">6</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">4</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="nl">workernode1</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">6</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">4</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span>
</code></pre></div>

<p>为了确认输出，打开转储位置生成的文件。日志应该是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="gh">$ cat /tmp/logs-workernode1-20210221214758.txt | more</span>
<span class="gh">-----------------------------------------------------</span>
 Logs gathered: /var/log/messages for workernode1
-----------------------------------------------------

Feb 21 18:00:27 node1 kernel: Command line: BOOT_IMAGE=(hd0,gpt2)/vmlinuz-4.18.0-193.el8.x86_64 root=/dev/mapper/rhel-root ro crashkernel=auto resume=/dev/mapper/rhel
-swap rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet
Feb 21 18:00:27 node1 kernel: Disabled fast string operations
Feb 21 18:00:27 node1 kernel: x86/fpu: Supporting XSAVE feature 0x001: &#39;x87 floating point registers&#39;
Feb 21 18:00:27 node1 kernel: x86/fpu: Supporting XSAVE feature 0x002: &#39;SSE registers&#39;
Feb 21 18:00:27 node1 kernel: x86/fpu: Supporting XSAVE feature 0x004: &#39;AVX registers&#39;
Feb 21 18:00:27 node1 kernel: x86/fpu: xstate_offset[2]:  576, xstate_sizes[2]:  256
Feb 21 18:00:27 node1 kernel: x86/fpu: Enabled xstate features 0x7, context size is 832 bytes, using &#39;compacted&#39; format.
</code></pre></div>

<h3>5、安装或删除软件包和软件</h3>
<p>你需要能够持续快速地在系统上安装和更新软件和软件包。缩短安装或更新软件包和软件所需的时间，可以避免服务器和应用程序不必要的停机时间。</p>
<p>通过 <a href="https://github.com/mikecali/6_sysadmin_tasks/tree/main/roles/install_tool">install_tool</a> 角色和 <code>r_install.yml</code> 剧本来实现这一点：</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span><span class="w"> </span><span class="n">playbooks</span><span class="o">/</span><span class="n">r_install</span><span class="p">.</span><span class="n">yml</span><span class="w"> </span><span class="o">-</span><span class="n">k</span>
<span class="n">SSH</span><span class="w"> </span><span class="n">password</span><span class="o">:</span>
<span class="n">PLAY</span><span class="w"> </span><span class="p">[</span><span class="n">Install</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="n">tools</span><span class="o">/</span><span class="n">packages</span><span class="p">]</span><span class="w"> </span><span class="o">***********************************************************************************</span>

<span class="n">TASK</span><span class="w"> </span><span class="p">[</span><span class="n">install_tool</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">tools</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="n">vars</span><span class="p">]</span><span class="w"> </span><span class="o">*************************************************************</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">master</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">iotop</span><span class="p">)</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">workernode1</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">iotop</span><span class="p">)</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">workernode1</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">traceroute</span><span class="p">)</span>
<span class="nl">ok</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">master</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">traceroute</span><span class="p">)</span>

<span class="n">PLAY</span><span class="w"> </span><span class="n">RECAP</span><span class="w"> </span><span class="o">*****************************************************************************************************************</span>
<span class="nl">master</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="nl">workernode1</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="w">    </span><span class="n">changed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">failed</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">skipped</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">rescued</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="n">ignored</span><span class="o">=</span><span class="mi">0</span>
</code></pre></div>

<p>这个例子安装了在 vars 文件中定义的两个特定包和版本。使用 Ansible 自动化，你可以比手动安装更快地安装多个软件包或软件。你也可以使用 vars 文件来定义你要安装的软件包的版本。</p>
<p>```
$ cat roles/install_tool/vars/main.yml</p>
<p>via: <a href="https://opensource.com/article/21/3/ansible-sysadmin">https://opensource.com/article/21/3/ansible-sysadmin</a></p>
<p>作者：<a href="https://opensource.com/users/mcalizo">Mike Calizo</a> 选题：<a href="https://github.com/lujun9972">lujun9972</a> 译者：<a href="https://github.com/wxy">wxy</a> 校对：<a href="https://github.com/wxy">wxy</a></p>
<p>本文由 <a href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a href="https://linux.cn/">Linux中国</a> 荣誉推出</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>