<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>如何写好 C main 函数</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Erik O'shaughnessy 学习如何构造一个 C 文件并编写一个 C main 函数来成功地处理命令行参数。 我知道，现在孩子们用 Python 和 JavaScript 编写他们 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2019/06/ru-he-xie-hao-c-main-han-shu.html" rel="bookmark"
           title="Permalink to 如何写好 C main 函数">如何写好 C main 函数</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-06-08T21:15:00+02:00">
                Published: Sat 08 June 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Erik O'shaughnessy</p>
<blockquote>
<p>学习如何构造一个 C 文件并编写一个 C main 函数来成功地处理命令行参数。</p>
</blockquote>
<p><img alt="" src="/data/attachment/album/201906/08/211422umrzznnvmapcwuc3.jpg"></p>
<p>我知道，现在孩子们用 Python 和 JavaScript 编写他们的疯狂“应用程序”。但是不要这么快就否定 C 语言 —— 它能够提供很多东西，并且简洁。如果你需要速度，用 C 语言编写可能就是你的答案。如果你正在寻找稳定的职业或者想学习如何捕获<a href="https://www.owasp.org/index.php/Null_Dereference">空指针解引用</a>，C 语言也可能是你的答案！在本文中，我将解释如何构造一个 C 文件并编写一个 C main 函数来成功地处理命令行参数。</p>
<p>我：一个顽固的 Unix 系统程序员。</p>
<p>你：一个有编辑器、C 编译器，并有时间打发的人。</p>
<p>让我们开工吧。</p>
<h3>一个无聊但正确的 C 程序</h3>
<p><img alt="Parody O'Reilly book cover, &quot;Hating Other People's Code&quot;" src="/data/attachment/album/201906/08/211510o46awqki5uwc8rd9.png" title="Parody O'Reilly book cover, \&quot;Hating Other People's Code\&quot;"></p>
<p>C 程序以 <code>main()</code> 函数开头，通常保存在名为 <code>main.c</code> 的文件中。</p>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="nb">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>

<span class="p">}</span>
</code></pre></div>

<p>这个程序可以<em>编译</em>但不<em>干</em>任何事。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>main.c
$<span class="w"> </span>./a.out<span class="w"> </span>-o<span class="w"> </span>foo<span class="w"> </span>-vv
$
</code></pre></div>

<p>正确但无聊。</p>
<h3>main 函数是唯一的。</h3>
<p><code>main()</code> 函数是开始执行时所执行的程序的第一个函数，但不是第一个执行的函数。<em>第一个</em>函数是 <code>_start()</code>，它通常由 C 运行库提供，在编译程序时自动链入。此细节高度依赖于操作系统和编译器工具链，所以我假装没有提到它。</p>
<p><code>main()</code> 函数有两个参数，通常称为 <code>argc</code> 和 <code>argv</code>，并返回一个有符号整数。大多数 Unix 环境都希望程序在成功时返回 <code>0</code>（零），失败时返回 <code>-1</code>（负一）。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>argc</code></td>
<td>参数个数</td>
<td>参数向量的个数</td>
</tr>
<tr>
<td><code>argv</code></td>
<td>参数向量</td>
<td>字符指针数组</td>
</tr>
</tbody>
</table>
<p>参数向量 <code>argv</code> 是调用你的程序的命令行的标记化表示形式。在上面的例子中，<code>argv</code> 将是以下字符串的列表：</p>
<div class="highlight"><pre><span></span><code>argv = [ &quot;/path/to/a.out&quot;, &quot;-o&quot;, &quot;foo&quot;, &quot;-vv&quot; ];
</code></pre></div>

<p>参数向量在其第一个索引 <code>argv[0]</code> 中确保至少会有一个字符串，这是执行程序的完整路径。</p>
<h3>main.c 文件的剖析</h3>
<p>当我从头开始编写 <code>main.c</code> 时，它的结构通常如下：</p>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>版权<span class="o">/</span>许可证<span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>包含<span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span>定义<span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span>外部声明<span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span>类型定义<span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span>全局变量声明<span class="w"> </span><span class="o">*/</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span>函数原型<span class="w"> </span><span class="o">*/</span>

<span class="nb">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="o">/*</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span>命令行解析<span class="w"> </span><span class="o">*/</span>
<span class="p">}</span>

<span class="o">/*</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span>函数声明<span class="w"> </span><span class="o">*/</span>
</code></pre></div>

<p>下面我将讨论这些编号的各个部分，除了编号为 0 的那部分。如果你必须把版权或许可文本放在源代码中，那就放在那里。</p>
<p>另一件我不想讨论的事情是注释。</p>
<div class="highlight"><pre><span></span><code>“评论谎言。”
- 一个愤世嫉俗但聪明又好看的程序员。
</code></pre></div>

<p>与其使用注释，不如使用有意义的函数名和变量名。</p>
<p>鉴于程序员固有的惰性，一旦添加了注释，维护负担就会增加一倍。如果更改或重构代码，则需要更新或扩充注释。随着时间的推移，代码会变得面目全非，与注释所描述的内容完全不同。</p>
<p>如果你必须写注释，不要写关于代码正在做<em>什么</em>，相反，写下代码<em>为什么</em>要这样写。写一些你将要在五年后读到的注释，那时你已经将这段代码忘得一干二净。世界的命运取决于你。<em>不要有压力。</em></p>
<h4>1、包含</h4>
<p>我添加到 <code>main.c</code> 文件的第一个东西是包含文件，它们为程序提供大量标准 C 标准库函数和变量。C 标准库做了很多事情。浏览 <code>/usr/include</code> 中的头文件，你可以了解到它们可以做些什么。</p>
<p><code>#include</code> 字符串是 <a href="https://en.wikipedia.org/wiki/C_preprocessor">C 预处理程序</a>（cpp）指令，它会将引用的文件完整地包含在当前文件中。C 中的头文件通常以 <code>.h</code> 扩展名命名，且不应包含任何可执行代码。它只有宏、定义、类型定义、外部变量和函数原型。字符串 <code>&lt;header.h&gt;</code> 告诉 cpp 在系统定义的头文件路径中查找名为 <code>header.h</code> 的文件，它通常在 <code>/usr/include</code> 目录中。</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* main.c */</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libgen.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;getopt.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/types.h&gt;</span>
</code></pre></div>

<p>这是我默认会全局包含的最小包含集合，它将引入：</p>
<table>
<thead>
<tr>
<th>#include 文件</th>
<th>提供的东西</th>
</tr>
</thead>
<tbody>
<tr>
<td>stdio</td>
<td>提供 <code>FILE</code>、<code>stdin</code>、<code>stdout</code>、<code>stderr</code> 和 <code>fprint()</code> 函数系列</td>
</tr>
<tr>
<td>stdlib</td>
<td>提供 <code>malloc()</code>、<code>calloc()</code> 和 <code>realloc()</code></td>
</tr>
<tr>
<td>unistd</td>
<td>提供 <code>EXIT_FAILURE</code>、<code>EXIT_SUCCESS</code></td>
</tr>
<tr>
<td>libgen</td>
<td>提供 <code>basename()</code> 函数</td>
</tr>
<tr>
<td>errno</td>
<td>定义外部 <code>errno</code> 变量及其可以接受的所有值</td>
</tr>
<tr>
<td>string</td>
<td>提供 <code>memcpy()</code>、<code>memset()</code> 和 <code>strlen()</code> 函数系列</td>
</tr>
<tr>
<td>getopt</td>
<td>提供外部 <code>optarg</code>、<code>opterr</code>、<code>optind</code> 和 <code>getopt()</code> 函数</td>
</tr>
<tr>
<td>sys/types</td>
<td>类型定义快捷方式，如 <code>uint32_t</code> 和 <code>uint64_t</code></td>
</tr>
</tbody>
</table>
<h4>2、定义</h4>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

#<span class="n">define</span><span class="w"> </span><span class="n">OPTSTR</span><span class="w"> </span><span class="s">&quot;vi:o:f:h&quot;</span>
#<span class="n">define</span><span class="w"> </span><span class="n">USAGE_FMT</span><span class="w">  </span><span class="s">&quot;%s [-v] [-f hexflag] [-i inputfile] [-o outputfile] [-h]&quot;</span>
#<span class="n">define</span><span class="w"> </span><span class="n">ERR_FOPEN_INPUT</span><span class="w">  </span><span class="s">&quot;fopen(input, r)&quot;</span>
#<span class="n">define</span><span class="w"> </span><span class="n">ERR_FOPEN_OUTPUT</span><span class="w"> </span><span class="s">&quot;fopen(output, w)&quot;</span>
#<span class="n">define</span><span class="w"> </span><span class="n">ERR_DO_THE_NEEDFUL</span><span class="w"> </span><span class="s">&quot;do_the_needful blew up&quot;</span>
#<span class="n">define</span><span class="w"> </span><span class="n">DEFAULT_PROGNAME</span><span class="w"> </span><span class="s">&quot;george&quot;</span>
</code></pre></div>

<p>这在现在没有多大意义，但 <code>OPTSTR</code> 定义我这里会说明一下，它是程序推荐的命令行开关。参考 <a href="https://linux.die.net/man/3/getopt">getopt(3)</a> man 页面，了解 <code>OPTSTR</code> 将如何影响 <code>getopt()</code> 的行为。</p>
<p><code>USAGE_FMT</code> 定义了一个 <code>printf()</code> 风格的格式字符串，它用在 <code>usage()</code> 函数中。</p>
<p>我还喜欢将字符串常量放在文件的 <code>#define</code> 这一部分。如果需要，把它们收集在一起可以更容易地修正拼写、重用消息和国际化消息。</p>
<p>最后，在命名 <code>#define</code> 时全部使用大写字母，以区别变量和函数名。如果需要，可以将单词放连在一起或使用下划线分隔，只要确保它们都是大写的就行。</p>
<h4>3、外部声明</h4>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="n">extern</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">errno</span><span class="p">;</span>
<span class="n">extern</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">optarg</span><span class="p">;</span>
<span class="n">extern</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">opterr</span><span class="p">,</span><span class="w"> </span><span class="n">optind</span><span class="p">;</span>
</code></pre></div>

<p><code>extern</code> 声明将该名称带入当前编译单元的命名空间（即 “文件”），并允许程序访问该变量。这里我们引入了三个整数变量和一个字符指针的定义。<code>opt</code> 前缀的几个变量是由 <code>getopt()</code> 函数使用的，C 标准库使用 <code>errno</code> 作为带外通信通道来传达函数可能的失败原因。</p>
<h4>4、类型定义</h4>
<div class="highlight"><pre><span></span><code><span class="cm">/* main.c */</span>
<span class="p">&lt;</span><span class="o">...</span><span class="p">&gt;</span>

<span class="nx">typedef</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">int</span><span class="w">           </span><span class="nx">verbose</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint32_t</span><span class="w">      </span><span class="nx">flags</span><span class="p">;</span>
<span class="w">  </span><span class="nx">FILE</span><span class="w">         </span><span class="o">*</span><span class="nx">input</span><span class="p">;</span>
<span class="w">  </span><span class="nx">FILE</span><span class="w">         </span><span class="o">*</span><span class="nx">output</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="nx">options_t</span><span class="p">;</span>
</code></pre></div>

<p>在外部声明之后，我喜欢为结构、联合和枚举声明 <code>typedef</code>。命名一个 <code>typedef</code> 是一种传统习惯。我非常喜欢使用 <code>_t</code> 后缀来表示该名称是一种类型。在这个例子中，我将 <code>options_t</code> 声明为一个包含 4 个成员的 <code>struct</code>。C 是一种空格无关的编程语言，因此我使用空格将字段名排列在同一列中。我只是喜欢它看起来的样子。对于指针声明，我在名称前面加上星号，以明确它是一个指针。</p>
<h4>5、全局变量声明</h4>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">&lt;...&gt;</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">dumb_global_variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">11</span><span class="p">;</span>
</code></pre></div>

<p>全局变量是一个坏主意，你永远不应该使用它们。但如果你必须使用全局变量，请在这里声明，并确保给它们一个默认值。说真的，<em>不要使用全局变量</em>。</p>
<h4>6、函数原型</h4>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="n">void</span><span class="w"> </span><span class="n">usage</span><span class="p">(</span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">progname</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="nb">int</span><span class="w"> </span><span class="n">do_the_needful</span><span class="p">(</span><span class="n">options_t</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">);</span>
</code></pre></div>

<p>在编写函数时，将它们添加到 <code>main()</code> 函数之后而不是之前，在这里放函数原型。早期的 C 编译器使用单遍策略，这意味着你在程序中使用的每个符号（变量或函数名称）必须在使用之前声明。现代编译器几乎都是多遍编译器，它们在生成代码之前构建一个完整的符号表，因此并不严格要求使用函数原型。但是，有时你无法选择代码要使用的编译器，所以请编写函数原型并继续这样做下去。</p>
<p>当然，我总是包含一个 <code>usage()</code> 函数，当 <code>main()</code> 函数不理解你从命令行传入的内容时，它会调用这个函数。</p>
<h4>7、命令行解析</h4>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="nb">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">int</span><span class="w"> </span><span class="n">opt</span><span class="p">;</span>
<span class="w">    </span><span class="n">options_t</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="n">opterr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">opt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">OPTSTR</span><span class="p">))</span><span class="w"> </span>!<span class="p">=</span><span class="w"> </span><span class="n">EOF</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="k">switch</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;i&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="nb">input</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">){</span>
<span class="w">                 </span><span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_INPUT</span><span class="p">);</span>
<span class="w">                 </span><span class="nb">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">                 </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;o&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">output</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">){</span>
<span class="w">                 </span><span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_OUTPUT</span><span class="p">);</span>
<span class="w">                 </span><span class="nb">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">                 </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">              </span><span class="p">}</span><span class="w">    </span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;f&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="n">options</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32_t</span><span class="w"> </span><span class="p">)</span><span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;v&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="n">options</span><span class="p">.</span><span class="n">verbose</span><span class="w"> </span><span class="o">+</span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;h&#39;</span><span class="p">:</span>
<span class="w">           </span><span class="n">default</span><span class="p">:</span>
<span class="w">              </span><span class="n">usage</span><span class="p">(</span><span class="nb">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="w">              </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">do_the_needful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span>!<span class="p">=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">perror</span><span class="p">(</span><span class="n">ERR_DO_THE_NEEDFUL</span><span class="p">);</span>
<span class="w">       </span><span class="nb">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">       </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>好吧，代码有点多。这个 <code>main()</code> 函数的目的是收集用户提供的参数，执行最基本的输入验证，然后将收集到的参数传递给使用它们的函数。这个示例声明一个使用默认值初始化的 <code>options</code> 变量，并解析命令行，根据需要更新 <code>options</code>。</p>
<p><code>main()</code> 函数的核心是一个 <code>while</code> 循环，它使用 <code>getopt()</code> 来遍历 <code>argv</code>，寻找命令行选项及其参数（如果有的话）。文件前面定义的 <code>OPTSTR</code> 是驱动 <code>getopt()</code> 行为的模板。<code>opt</code> 变量接受 <code>getopt()</code> 找到的任何命令行选项的字符值，程序对检测命令行选项的响应发生在 <code>switch</code> 语句中。</p>
<p>如果你注意到了可能会问，为什么 <code>opt</code> 被声明为 32 位 <code>int</code>，但是预期是 8 位 <code>char</code>？事实上 <code>getopt()</code> 返回一个 <code>int</code>，当它到达 <code>argv</code> 末尾时取负值，我会使用 <code>EOF</code>（<em>文件末尾</em>标记）匹配。<code>char</code> 是有符号的，但我喜欢将变量匹配到它们的函数返回值。</p>
<p>当检测到一个已知的命令行选项时，会发生特定的行为。在 <code>OPTSTR</code> 中指定一个以冒号结尾的参数，这些选项可以有一个参数。当一个选项有一个参数时，<code>argv</code> 中的下一个字符串可以通过外部定义的变量 <code>optarg</code> 提供给程序。我使用 <code>optarg</code> 来打开文件进行读写，或者将命令行参数从字符串转换为整数值。</p>
<p>这里有几个关于代码风格的要点：</p>
<ul>
<li>将 <code>opterr</code> 初始化为 <code>0</code>，禁止 <code>getopt</code> 触发 <code>?</code>。</li>
<li>在 <code>main()</code> 的中间使用 <code>exit(EXIT_FAILURE);</code> 或 <code>exit(EXIT_SUCCESS);</code>。</li>
<li><code>/* NOTREACHED */</code> 是我喜欢的一个 lint 指令。</li>
<li>在返回 int 类型的函数末尾使用 <code>return EXIT_SUCCESS;</code>。</li>
<li>显示强制转换隐式类型。</li>
</ul>
<p>这个程序的命令行格式，经过编译如下所示：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>./a.out<span class="w"> </span>-h
a.out<span class="w"> </span><span class="o">[</span>-v<span class="o">]</span><span class="w"> </span><span class="o">[</span>-f<span class="w"> </span>hexflag<span class="o">]</span><span class="w"> </span><span class="o">[</span>-i<span class="w"> </span>inputfile<span class="o">]</span><span class="w"> </span><span class="o">[</span>-o<span class="w"> </span>outputfile<span class="o">]</span><span class="w"> </span><span class="o">[</span>-h<span class="o">]</span>
</code></pre></div>

<p>事实上，在编译后 <code>usage()</code> 就会向 <code>stderr</code> 发出这样的内容。</p>
<h4>8、函数声明</h4>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">*/</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="n">void</span><span class="w"> </span><span class="n">usage</span><span class="p">(</span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">progname</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">opt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="n">USAGE_FMT</span><span class="p">,</span><span class="w"> </span><span class="n">progname</span>?<span class="n">progname</span><span class="p">:</span><span class="n">DEFAULT_PROGNAME</span><span class="p">);</span>
<span class="w">   </span><span class="nb">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">   </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="p">}</span>

<span class="nb">int</span><span class="w"> </span><span class="n">do_the_needful</span><span class="p">(</span><span class="n">options_t</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">errno</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span>!<span class="n">options</span><span class="o">-&gt;</span><span class="nb">input</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>!<span class="n">options</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">errno</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ENOENT</span><span class="p">;</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">/*</span><span class="w"> </span><span class="n">XXX</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">needful</span><span class="w"> </span><span class="n">stuff</span><span class="w"> </span><span class="o">*/</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>我最后编写的函数不是个样板函数。在本例中，函数 <code>do_the_needful()</code> 接受一个指向 <code>options_t</code> 结构的指针。我验证 <code>options</code> 指针不为 <code>NULL</code>，然后继续验证 <code>input</code> 和 <code>output</code> 结构成员。如果其中一个测试失败，返回 <code>EXIT_FAILURE</code>，并且通过将外部全局变量 <code>errno</code> 设置为常规错误代码，我可以告知调用者常规的错误原因。调用者可以使用便捷函数 <code>perror()</code> 来根据 <code>errno</code> 的值发出便于阅读的错误消息。</p>
<p>函数几乎总是以某种方式验证它们的输入。如果完全验证代价很大，那么尝试执行一次并将验证后的数据视为不可变。<code>usage()</code> 函数使用 <code>fprintf()</code> 调用中的条件赋值验证 <code>progname</code> 参数。接下来 <code>usage()</code> 函数就退出了，所以我不会费心设置 <code>errno</code>，也不用操心是否使用正确的程序名。</p>
<p>在这里，我要避免的最大错误是解引用 <code>NULL</code> 指针。这将导致操作系统向我的进程发送一个名为 <code>SYSSEGV</code> 的特殊信号，导致不可避免的死亡。用户最不希望看到的是由 <code>SYSSEGV</code> 而导致的崩溃。最好是捕获 <code>NULL</code> 指针以发出更合适的错误消息并优雅地关闭程序。</p>
<p>有些人抱怨在函数体中有多个 <code>return</code> 语句，他们喋喋不休地说些“控制流的连续性”之类的东西。老实说，如果函数中间出现错误，那就应该返回这个错误条件。写一大堆嵌套的 <code>if</code> 语句只有一个 <code>return</code> 绝不是一个“好主意”™。</p>
<p>最后，如果你编写的函数接受四个以上的参数，请考虑将它们绑定到一个结构中，并传递一个指向该结构的指针。这使得函数签名更简单，更容易记住，并且在以后调用时不会出错。它还可以使调用函数速度稍微快一些，因为需要复制到函数堆栈中的东西更少。在实践中，只有在函数被调用数百万或数十亿次时，才会考虑这个问题。如果认为这没有意义，那也无所谓。</p>
<h3>等等，你不是说没有注释吗！？！！</h3>
<p>在 <code>do_the_needful()</code> 函数中，我写了一种特殊类型的注释，它被是作为占位符设计的，而不是为了说明代码：</p>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">XXX</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">needful</span><span class="w"> </span><span class="n">stuff</span><span class="w"> </span><span class="o">*/</span>
</code></pre></div>

<p>当你写到这里时，有时你不想停下来编写一些特别复杂的代码，你会之后再写，而不是现在。那就是我留给自己再次回来的地方。我插入一个带有 <code>XXX</code> 前缀的注释和一个描述需要做什么的简短注释。之后，当我有更多时间的时候，我会在源代码中寻找 <code>XXX</code>。使用什么前缀并不重要，只要确保它不太可能在另一个上下文环境（如函数名或变量）中出现在你代码库里。</p>
<h3>把它们组合在一起</h3>
<p>好吧，当你编译这个程序后，它<em>仍然</em>几乎没有任何作用。但是现在你有了一个坚实的骨架来构建你自己的命令行解析 C 程序。</p>
<div class="highlight"><pre><span></span><code><span class="o">/*</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="n">listing</span><span class="w"> </span><span class="o">*/</span>

<span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="c1">#include &lt;unistd.h&gt;</span>
<span class="c1">#include &lt;libgen.h&gt;</span>
<span class="c1">#include &lt;errno.h&gt;</span>
<span class="c1">#include &lt;string.h&gt;</span>
<span class="c1">#include &lt;getopt.h&gt;</span>

<span class="c1">#define OPTSTR &quot;vi:o:f:h&quot;</span>
<span class="c1">#define USAGE_FMT  &quot;%s [-v] [-f hexflag] [-i inputfile] [-o outputfile] [-h]&quot;</span>
<span class="c1">#define ERR_FOPEN_INPUT  &quot;fopen(input, r)&quot;</span>
<span class="c1">#define ERR_FOPEN_OUTPUT &quot;fopen(output, w)&quot;</span>
<span class="c1">#define ERR_DO_THE_NEEDFUL &quot;do_the_needful blew up&quot;</span>
<span class="c1">#define DEFAULT_PROGNAME &quot;george&quot;</span>

<span class="n">extern</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">errno</span><span class="p">;</span>
<span class="n">extern</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">optarg</span><span class="p">;</span>
<span class="n">extern</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">opterr</span><span class="p">,</span><span class="w"> </span><span class="n">optind</span><span class="p">;</span>

<span class="n">typedef</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb nb-Type">int</span><span class="w">           </span><span class="n">verbose</span><span class="p">;</span>
<span class="w">  </span><span class="n">uint32_t</span><span class="w">      </span><span class="n">flags</span><span class="p">;</span>
<span class="w">  </span><span class="n">FILE</span><span class="w">         </span><span class="o">*</span><span class="n">input</span><span class="p">;</span>
<span class="w">  </span><span class="n">FILE</span><span class="w">         </span><span class="o">*</span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">options_t</span><span class="p">;</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">dumb_global_variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">11</span><span class="p">;</span>

<span class="nb nb-Type">void</span><span class="w"> </span><span class="n">usage</span><span class="p">(</span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">progname</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="nb nb-Type">int</span><span class="w">  </span><span class="n">do_the_needful</span><span class="p">(</span><span class="n">options_t</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">);</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">opt</span><span class="p">;</span>
<span class="w">    </span><span class="n">options_t</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="n">opterr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">OPTSTR</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EOF</span><span class="p">)</span><span class="w"> </span>
<span class="w">       </span><span class="n">switch</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">           </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;i&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;r&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">){</span>
<span class="w">                 </span><span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_INPUT</span><span class="p">);</span>
<span class="w">                 </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">                 </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;o&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;w&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">){</span>
<span class="w">                 </span><span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_OUTPUT</span><span class="p">);</span>
<span class="w">                 </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">                 </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">              </span><span class="p">}</span><span class="w">    </span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;f&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="n">options</span><span class="o">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint32_t</span><span class="w"> </span><span class="p">)</span><span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;v&#39;</span><span class="p">:</span>
<span class="w">              </span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>

<span class="w">           </span><span class="n">case</span><span class="w"> </span><span class="s1">&#39;h&#39;</span><span class="p">:</span>
<span class="w">           </span><span class="n">default</span><span class="p">:</span>
<span class="w">              </span><span class="n">usage</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="w"> </span><span class="n">opt</span><span class="p">);</span>
<span class="w">              </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">              </span><span class="k">break</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">do_the_needful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">perror</span><span class="p">(</span><span class="n">ERR_DO_THE_NEEDFUL</span><span class="p">);</span>
<span class="w">       </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">       </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb nb-Type">void</span><span class="w"> </span><span class="n">usage</span><span class="p">(</span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="n">progname</span><span class="p">,</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="w"> </span><span class="n">opt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="n">USAGE_FMT</span><span class="p">,</span><span class="w"> </span><span class="n">progname</span><span class="err">?</span><span class="n">progname</span><span class="p">:</span><span class="n">DEFAULT_PROGNAME</span><span class="p">);</span>
<span class="w">   </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="w">   </span><span class="o">/*</span><span class="w"> </span><span class="n">NOTREACHED</span><span class="w"> </span><span class="o">*/</span>
<span class="p">}</span>

<span class="nb nb-Type">int</span><span class="w"> </span><span class="n">do_the_needful</span><span class="p">(</span><span class="n">options_t</span><span class="w"> </span><span class="o">*</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EINVAL</span><span class="p">;</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">input</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ENOENT</span><span class="p">;</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="o">/*</span><span class="w"> </span><span class="n">XXX</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">needful</span><span class="w"> </span><span class="n">stuff</span><span class="w"> </span><span class="o">*/</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>现在，你已经准备好编写更易于维护的 C 语言。如果你有任何问题或反馈，请在评论中分享。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>