<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Go 语言在极小硬件上的运用（一）</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Michał Derkacz Go 语言，能在多低下的配置上运行并发挥作用呢？ 我最近购买了一个特别便宜的开发板： 我购买它的理由有三个。首 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2019/09/go-yu-yan-zai-ji-xiao-ying-jian-shang-de-yun-yong-yi.html" rel="bookmark"
           title="Permalink to Go 语言在极小硬件上的运用（一）">Go 语言在极小硬件上的运用（一）</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-09-24T21:03:09+02:00">
                Published: Tue 24 September 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Michał Derkacz</p>
<p><img alt="" src="/data/attachment/album/201909/24/210256yihkuy8kcigugr2h.png"></p>
<p>Go 语言，能在多低下的配置上运行并发挥作用呢？</p>
<p>我最近购买了一个特别便宜的开发板：</p>
<p><img alt="STM32F030F4P6" src="/data/attachment/album/201909/24/210325sk2snn6u6hs82tu7.jpg"></p>
<p>我购买它的理由有三个。首先，我（作为程序员）从未接触过 STM320 系列的开发板。其次，STM32F10x 系列使用也有点少了。STM320 系列的 MCU 很便宜，有更新一些的外设，对系列产品进行了改进，问题修复也做得更好了。最后，为了这篇文章，我选用了这一系列中最低配置的开发板，整件事情就变得有趣起来了。</p>
<h3>硬件部分</h3>
<p><a href="http://www.st.com/content/st_com/en/products/microcontrollers/stm32-32-bit-arm-cortex-mcus/stm32-mainstream-mcus/stm32f0-series/stm32f0x0-value-line/stm32f030f4.html">STM32F030F4P6</a> 给人留下了很深的印象：</p>
<ul>
<li>CPU: <a href="https://en.wikipedia.org/wiki/ARM_Cortex-M#Cortex-M0">Cortex M0</a> 48 MHz（最低配置，只有 12000 个逻辑门电路）</li>
<li>RAM: 4 KB，</li>
<li>Flash: 16 KB，</li>
<li>ADC、SPI、I2C、USART 和几个定时器</li>
</ul>
<p>以上这些采用了 TSSOP20 封装。正如你所见，这是一个很小的 32 位系统。</p>
<h3>软件部分</h3>
<p>如果你想知道如何在这块开发板上使用 <a href="https://golang.org/">Go</a> 编程，你需要反复阅读硬件规范手册。你必须面对这样的真实情况：在 Go 编译器中给 Cortex-M0 提供支持的可能性很小。而且，这还仅仅只是第一个要解决的问题。</p>
<p>我会使用 <a href="https://github.com/ziutek/emgo">Emgo</a>，但别担心，之后你会看到，它如何让 Go 在如此小的系统上尽可能发挥作用。</p>
<p>在我拿到这块开发板之前，对 <a href="https://github.com/ziutek/emgo/tree/master/egpath/src/stm32/hal">stm32/hal</a> 系列下的 F0 MCU 没有任何支持。在简单研究<a href="http://www.st.com/resource/en/reference_manual/dm00091010.pdf">参考手册</a>后，我发现 STM32F0 系列是 STM32F3 削减版，这让在新端口上开发的工作变得容易了一些。</p>
<p>如果你想接着本文的步骤做下去，需要先安装 Emgo</p>
<div class="highlight"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="err">$</span><span class="n">HOME</span>
<span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">ziutek</span><span class="o">/</span><span class="n">emgo</span><span class="o">/</span>
<span class="n">cd</span><span class="w"> </span><span class="n">emgo</span><span class="o">/</span><span class="n">egc</span>
<span class="k">go</span><span class="w"> </span><span class="n">install</span>
</code></pre></div>

<p>然后设置一下环境变量</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">EGCC</span><span class="o">=</span><span class="n">path_to_arm_gcc</span><span class="w">      </span><span class="c1"># eg. /usr/local/arm/bin/arm-none-eabi-gcc</span>
<span class="k">export</span><span class="w"> </span><span class="n">EGLD</span><span class="o">=</span><span class="n">path_to_arm_linker</span><span class="w">   </span><span class="c1"># eg. /usr/local/arm/bin/arm-none-eabi-ld</span>
<span class="k">export</span><span class="w"> </span><span class="n">EGAR</span><span class="o">=</span><span class="n">path_to_arm_archiver</span><span class="w"> </span><span class="c1"># eg. /usr/local/arm/bin/arm-none-eabi-ar</span>

<span class="k">export</span><span class="w"> </span><span class="n">EGROOT</span><span class="o">=$</span><span class="n">HOME</span><span class="o">/</span><span class="n">emgo</span><span class="o">/</span><span class="n">egroot</span>
<span class="k">export</span><span class="w"> </span><span class="n">EGPATH</span><span class="o">=$</span><span class="n">HOME</span><span class="o">/</span><span class="n">emgo</span><span class="o">/</span><span class="n">egpath</span>

<span class="k">export</span><span class="w"> </span><span class="n">EGARCH</span><span class="o">=</span><span class="n">cortexm0</span>
<span class="k">export</span><span class="w"> </span><span class="n">EGOS</span><span class="o">=</span><span class="n">noos</span>
<span class="k">export</span><span class="w"> </span><span class="n">EGTARGET</span><span class="o">=</span><span class="n">f030x6</span>
</code></pre></div>

<p>更详细的说明可以在 <a href="https://github.com/ziutek/emgo">Emgo</a> 官网上找到。</p>
<p>要确保 <code>egc</code> 在你的 <code>PATH</code> 中。 你可以使用 <code>go build</code> 来代替 <code>go install</code>，然后把 <code>egc</code> 复制到你的 <code>$HOME/bin</code> 或 <code>/usr/local/bin</code> 中。</p>
<p>现在，为你的第一个 Emgo 程序创建一个新文件夹，随后把示例中链接器脚本复制过来：</p>
<div class="highlight"><pre><span></span><code>mkdir $HOME/firstemgo
cd $HOME/firstemgo
cp $EGPATH/src/stm32/examples/f030-demo-board/blinky/script.ld .
</code></pre></div>

<h3>最基本程序</h3>
<p>在 <code>main.go</code> 文件中创建一个最基本的程序：</p>
<div class="highlight"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">main</span>

<span class="k">func</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>
</code></pre></div>

<p>文件编译没有出现任何问题：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>egc
$<span class="w"> </span>arm-none-eabi-size<span class="w"> </span>cortexm0.elf
<span class="w">   </span>text<span class="w">    </span>data<span class="w">     </span>bss<span class="w">     </span>dec<span class="w">     </span>hex<span class="w"> </span>filename
<span class="w">   </span><span class="m">7452</span><span class="w">     </span><span class="m">172</span><span class="w">     </span><span class="m">104</span><span class="w">    </span><span class="m">7728</span><span class="w">    </span>1e30<span class="w"> </span>cortexm0.elf
</code></pre></div>

<p>第一次编译可能会花点时间。编译后产生的二进制占用了 7624 个字节的 Flash 空间（文本 + 数据）。对于一个什么都没做的程序来说，占用的空间有些大。还剩下 8760 字节，可以用来做些有用的事。</p>
<p>不妨试试传统的 “Hello, World!” 程序：</p>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="s2">&quot;fmt&quot;</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>不幸的是，这次结果有些糟糕：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>egc
/usr/local/arm/bin/arm-none-eabi-ld:<span class="w"> </span>/home/michal/P/go/src/github.com/ziutek/emgo/egpath/src/stm32/examples/f030-demo-board/blog/cortexm0.elf<span class="w"> </span>section<span class="w"> </span><span class="sb">`</span>.text<span class="s1">&#39; will not fit in region `Flash&#39;</span>
/usr/local/arm/bin/arm-none-eabi-ld:<span class="w"> </span>region<span class="w"> </span><span class="sb">`</span>Flash<span class="err">&#39;</span><span class="w"> </span>overflowed<span class="w"> </span>by<span class="w"> </span><span class="m">10880</span><span class="w"> </span>bytes
<span class="nb">exit</span><span class="w"> </span>status<span class="w"> </span><span class="m">1</span>
</code></pre></div>

<p>“Hello, World!” 需要 STM32F030x6 上至少 32KB 的 Flash 空间。</p>
<p><code>fmt</code> 包强制包含整个 <code>strconv</code> 和 <code>reflect</code> 包。这三个包，即使在精简版本中的 Emgo 中，占用空间也很大。我们不能使用这个例子了。有很多的应用不需要好看的文本输出。通常，一个或多个 LED，或者七段数码管显示就足够了。不过，在第二部分，我会尝试使用 <code>strconv</code> 包来格式化，并在 UART 上显示一些数字和文本。</p>
<h3>闪烁</h3>
<p>我们的开发板上有一个与 PA4 引脚和 VCC 相连的 LED。这次我们的代码稍稍长了一些：</p>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;delay&quot;</span>

    <span class="s2">&quot;stm32/hal/gpio&quot;</span>
    <span class="s2">&quot;stm32/hal/system&quot;</span>
    <span class="s2">&quot;stm32/hal/system/timer/systick&quot;</span>
<span class="p">)</span>

<span class="n">var</span> <span class="n">led</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Pin</span>

<span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">system</span><span class="o">.</span><span class="n">SetupPLL</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">48</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">systick</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="mf">2e6</span><span class="p">)</span>

    <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">EnableClock</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
    <span class="n">led</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="n">Mode</span><span class="p">:</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Out</span><span class="p">,</span> <span class="n">Driver</span><span class="p">:</span> <span class="n">gpio</span><span class="o">.</span><span class="n">OpenDrain</span><span class="p">}</span>
    <span class="n">led</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">Millisec</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">Millisec</span><span class="p">(</span><span class="mi">900</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>按照惯例，<code>init</code> 函数用来初始化和配置外设。</p>
<p><code>system.SetupPLL(8, 1, 48/8)</code> 用来配置 RCC，将外部的 8 MHz 振荡器的 PLL 作为系统时钟源。PLL 分频器设置为 1，倍频数设置为 48/8 =6，这样系统时钟频率为 48MHz。</p>
<p><code>systick.Setup(2e6)</code> 将 Cortex-M SYSTICK 时钟作为系统时钟，每隔 2e6 次纳秒运行一次（每秒钟 500 次）。</p>
<p><code>gpio.A.EnableClock(false)</code> 开启了 GPIO A 口的时钟。<code>False</code> 意味着这一时钟在低功耗模式下会被禁用，但在 STM32F0 系列中并未实现这一功能。</p>
<p><code>led.Setup(cfg)</code> 设置 PA4 引脚为开漏输出。</p>
<p><code>led.Clear()</code> 将 PA4 引脚设为低，在开漏设置中，打开 LED。</p>
<p><code>led.Set()</code> 将 PA4 设为高电平状态，关掉LED。</p>
<p>编译这个代码：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>egc
$<span class="w"> </span>arm-none-eabi-size<span class="w"> </span>cortexm0.elf
<span class="w">   </span>text<span class="w">    </span>data<span class="w">     </span>bss<span class="w">     </span>dec<span class="w">     </span>hex<span class="w"> </span>filename
<span class="w">   </span><span class="m">9772</span><span class="w">     </span><span class="m">172</span><span class="w">     </span><span class="m">168</span><span class="w">   </span><span class="m">10112</span><span class="w">    </span><span class="m">2780</span><span class="w"> </span>cortexm0.elf
</code></pre></div>

<p>正如你所看到的，这个闪烁程序占用了 2320 字节，比最基本程序占用空间要大。还有 6440 字节的剩余空间。</p>
<p>看看代码是否能运行：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>openocd<span class="w"> </span>-d0<span class="w"> </span>-f<span class="w"> </span>interface/stlink.cfg<span class="w"> </span>-f<span class="w"> </span>target/stm32f0x.cfg<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;init; program cortexm0.elf; reset run; exit&#39;</span>
Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.10.0+dev-00319-g8f1f912a<span class="w"> </span><span class="o">(</span><span class="m">2018</span>-03-07-19:20<span class="o">)</span>
Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
<span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
debug_level:<span class="w"> </span><span class="m">0</span>
adapter<span class="w"> </span>speed:<span class="w"> </span><span class="m">1000</span><span class="w"> </span>kHz
adapter_nsrst_delay:<span class="w"> </span><span class="m">100</span>
none<span class="w"> </span>separate
adapter<span class="w"> </span>speed:<span class="w"> </span><span class="m">950</span><span class="w"> </span>kHz
target<span class="w"> </span>halted<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>debug-request,<span class="w"> </span>current<span class="w"> </span>mode:<span class="w"> </span>Thread<span class="w"> </span>
xPSR:<span class="w"> </span>0xc1000000<span class="w"> </span>pc:<span class="w"> </span>0x0800119c<span class="w"> </span>msp:<span class="w"> </span>0x20000da0
adapter<span class="w"> </span>speed:<span class="w"> </span><span class="m">4000</span><span class="w"> </span>kHz
**<span class="w"> </span>Programming<span class="w"> </span>Started<span class="w"> </span>**
auto<span class="w"> </span>erase<span class="w"> </span>enabled
target<span class="w"> </span>halted<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>breakpoint,<span class="w"> </span>current<span class="w"> </span>mode:<span class="w"> </span>Thread<span class="w"> </span>
xPSR:<span class="w"> </span>0x61000000<span class="w"> </span>pc:<span class="w"> </span>0x2000003a<span class="w"> </span>msp:<span class="w"> </span>0x20000da0
wrote<span class="w"> </span><span class="m">10240</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span>file<span class="w"> </span>cortexm0.elf<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.817425s<span class="w"> </span><span class="o">(</span><span class="m">12</span>.234<span class="w"> </span>KiB/s<span class="o">)</span>
**<span class="w"> </span>Programming<span class="w"> </span>Finished<span class="w"> </span>**
adapter<span class="w"> </span>speed:<span class="w"> </span><span class="m">950</span><span class="w"> </span>kHz
</code></pre></div>

<p>在这篇文章中，这是我第一次，将一个短视频转换成<a href="https://en.wikipedia.org/wiki/APNG">动画 PNG</a>。我对此印象很深，再见了 YouTube。 对于 IE 用户，我很抱歉，更多信息请看 <a href="http://apngasm.sourceforge.net/">apngasm</a>。我本应该学习 HTML5，但现在，APNG 是我最喜欢的，用来播放循环短视频的方法了。</p>
<p><img alt="STM32F030F4P6" src="/data/attachment/album/201909/24/210408vdq9h6qh6cwxtu0z.png"></p>
<h3>更多的 Go 语言编程</h3>
<p>如果你不是一个 Go 程序员，但你已经听说过一些关于 Go 语言的事情，你可能会说：“Go 语法很好，但跟 C 比起来，并没有明显的提升。让我看看 Go 语言的通道和协程！”</p>
<p>接下来我会一一展示:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;delay&quot;</span>

    <span class="s2">&quot;stm32/hal/gpio&quot;</span>
    <span class="s2">&quot;stm32/hal/system&quot;</span>
    <span class="s2">&quot;stm32/hal/system/timer/systick&quot;</span>
<span class="p">)</span>

<span class="n">var</span> <span class="n">led1</span><span class="p">,</span> <span class="n">led2</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Pin</span>

<span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">system</span><span class="o">.</span><span class="n">SetupPLL</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">48</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">systick</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="mf">2e6</span><span class="p">)</span>

    <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">EnableClock</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
    <span class="n">led1</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">led2</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="n">Mode</span><span class="p">:</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Out</span><span class="p">,</span> <span class="n">Driver</span><span class="p">:</span> <span class="n">gpio</span><span class="o">.</span><span class="n">OpenDrain</span><span class="p">}</span>
    <span class="n">led1</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">led2</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">blinky</span><span class="p">(</span><span class="n">led</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Pin</span><span class="p">,</span> <span class="n">period</span> <span class="nb">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">Millisec</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">Millisec</span><span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">go</span> <span class="n">blinky</span><span class="p">(</span><span class="n">led1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">blinky</span><span class="p">(</span><span class="n">led2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>代码改动很小: 添加了第二个 LED，上一个例子中的 <code>main</code> 函数被重命名为 <code>blinky</code> 并且需要提供两个参数。 <code>main</code> 在新的协程中先调用 <code>blinky</code>，所以两个 LED 灯在并行使用。值得一提的是，<code>gpio.Pin</code> 可以同时访问同一 GPIO 口的不同引脚。</p>
<p>Emgo 还有很多不足。其中之一就是你需要提前规定 <code>goroutines(tasks)</code> 的最大执行数量。是时候修改 <code>script.ld</code> 了:</p>
<div class="highlight"><pre><span></span><code><span class="n">ISRStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="n">MainStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="n">TaskStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="n">MaxTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="n">INCLUDE</span><span class="w"> </span><span class="n">stm32</span><span class="o">/</span><span class="n">f030x4</span>
<span class="n">INCLUDE</span><span class="w"> </span><span class="n">stm32</span><span class="o">/</span><span class="n">loadflash</span>
<span class="n">INCLUDE</span><span class="w"> </span><span class="n">noos</span><span class="o">-</span><span class="n">cortexm</span>
</code></pre></div>

<p>栈的大小需要靠猜，现在还不用关心这一点。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>egc
$<span class="w"> </span>arm-none-eabi-size<span class="w"> </span>cortexm0.elf
<span class="w">   </span>text<span class="w">    </span>data<span class="w">     </span>bss<span class="w">     </span>dec<span class="w">     </span>hex<span class="w"> </span>filename
<span class="w">  </span><span class="m">10020</span><span class="w">     </span><span class="m">172</span><span class="w">     </span><span class="m">172</span><span class="w">   </span><span class="m">10364</span><span class="w">    </span>287c<span class="w"> </span>cortexm0.elf
</code></pre></div>

<p>另一个 LED 和协程一共占用了 248 字节的 Flash 空间。</p>
<p><img alt="STM32F030F4P6" src="/data/attachment/album/201909/24/210519jkopyikil0z2al7r.png"></p>
<h3>通道</h3>
<p>通道是 Go 语言中协程之间相互通信的一种<a href="https://blog.golang.org/share-memory-by-communicating">推荐方式</a>。Emgo 甚至能允许通过<em>中断处理</em>来使用缓冲通道。下一个例子就展示了这种情况。</p>
<div class="highlight"><pre><span></span><code><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;delay&quot;</span>
    <span class="s2">&quot;rtos&quot;</span>

    <span class="s2">&quot;stm32/hal/gpio&quot;</span>
    <span class="s2">&quot;stm32/hal/irq&quot;</span>
    <span class="s2">&quot;stm32/hal/system&quot;</span>
    <span class="s2">&quot;stm32/hal/system/timer/systick&quot;</span>
    <span class="s2">&quot;stm32/hal/tim&quot;</span>
<span class="p">)</span>

<span class="n">var</span> <span class="p">(</span>
    <span class="n">leds</span>  <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="n">gpio</span><span class="o">.</span><span class="n">Pin</span>
    <span class="n">timer</span> <span class="o">*</span><span class="n">tim</span><span class="o">.</span><span class="n">Periph</span>
    <span class="n">ch</span>    <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">system</span><span class="o">.</span><span class="n">SetupPLL</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">48</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">systick</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="mf">2e6</span><span class="p">)</span>

    <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">EnableClock</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
    <span class="n">leds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">leds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">leds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

    <span class="n">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="n">Mode</span><span class="p">:</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Out</span><span class="p">,</span> <span class="n">Driver</span><span class="p">:</span> <span class="n">gpio</span><span class="o">.</span><span class="n">OpenDrain</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">led</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">leds</span> <span class="p">{</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">timer</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">TIM3</span>
    <span class="n">pclk</span> <span class="o">:=</span> <span class="n">timer</span><span class="o">.</span><span class="n">Bus</span><span class="p">()</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pclk</span> <span class="o">&lt;</span> <span class="n">system</span><span class="o">.</span><span class="n">AHB</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">pclk</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="n">freq</span> <span class="o">:=</span> <span class="n">uint</span><span class="p">(</span><span class="mf">1e3</span><span class="p">)</span> <span class="o">//</span> <span class="n">Hz</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">EnableClock</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">PSC</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">PSC</span><span class="p">(</span><span class="n">pclk</span><span class="o">/</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">ARR</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="mi">700</span><span class="p">)</span> <span class="o">//</span> <span class="n">ms</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">DIER</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">UIE</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">CR1</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">CEN</span><span class="p">)</span>

    <span class="n">rtos</span><span class="o">.</span><span class="n">IRQ</span><span class="p">(</span><span class="n">irq</span><span class="o">.</span><span class="n">TIM3</span><span class="p">)</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">blinky</span><span class="p">(</span><span class="n">led</span> <span class="n">gpio</span><span class="o">.</span><span class="n">Pin</span><span class="p">,</span> <span class="n">period</span> <span class="nb">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nb">range</span> <span class="n">ch</span> <span class="p">{</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">Millisec</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">led</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
        <span class="n">delay</span><span class="o">.</span><span class="n">Millisec</span><span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">go</span> <span class="n">blinky</span><span class="p">(</span><span class="n">leds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">blinky</span><span class="p">(</span><span class="n">leds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">500</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">timerISR</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">SR</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">leds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
    <span class="n">select</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ch</span> <span class="o">&lt;-</span> <span class="mi">0</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Success</span>
    <span class="n">default</span><span class="p">:</span>
        <span class="n">leds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span><span class="n">c</span><span class="p">:</span><span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s2">&quot;.ISRs&quot;</span><span class="p">)))</span>
<span class="n">var</span> <span class="n">ISRs</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="n">func</span><span class="p">(){</span>
    <span class="n">irq</span><span class="o">.</span><span class="n">TIM3</span><span class="p">:</span> <span class="n">timerISR</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>与之前例子相比较下的不同:</p>
<ol>
<li>添加了第三个 LED，并连接到 PA9 引脚（UART 头的 TXD 引脚）。</li>
<li>时钟（<code>TIM3</code>）作为中断源。</li>
<li>新函数 <code>timerISR</code> 用来处理 <code>irq.TIM3</code> 的中断。</li>
<li>新增容量为 1 的缓冲通道是为了 <code>timerISR</code> 和 <code>blinky</code> 协程之间的通信。</li>
<li><code>ISRs</code> 数组作为<em>中断向量表</em>，是更大的<em>异常向量表</em>的一部分。</li>
<li><code>blinky</code> 中的 <code>for</code> 语句被替换成 <code>range</code> 语句。</li>
</ol>
<p>为了方便起见，所有的 LED，或者说它们的引脚，都被放在 <code>leds</code> 这个数组里。另外，所有引脚在被配置为输出之前，都设置为一种已知的初始状态（高电平状态）。</p>
<p>在这个例子里，我们想让时钟以 1 kHz 的频率运行。为了配置 TIM3 预分频器，我们需要知道它的输入时钟频率。通过参考手册我们知道，输入时钟频率在 <code>APBCLK = AHBCLK</code> 时，与 <code>APBCLK</code> 相同，反之等于 2 倍的 <code>APBCLK</code>。</p>
<p>如果 CNT 寄存器增加 1 kHz，那么 ARR 寄存器的值等于<em>更新事件</em>（重载事件）在毫秒中的计数周期。 为了让更新事件产生中断，必须要设置 DIER 寄存器中的 UIE 位。CEN 位能启动时钟。</p>
<p>时钟外设在低功耗模式下必须启用，为了自身能在 CPU 处于休眠时保持运行: <code>timer.EnableClock(true)</code>。这在 STM32F0 中无关紧要，但对代码可移植性却十分重要。</p>
<p><code>timerISR</code> 函数处理 <code>irq.TIM3</code> 的中断请求。<code>timer.SR.Store(0)</code> 会清除 SR 寄存器里的所有事件标志，无效化向 <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0432c/Cihbecee.html">NVIC</a> 发出的所有中断请求。凭借经验，由于中断请求无效的延时性，需要在程序一开始马上清除所有的中断标志。这避免了无意间再次调用处理。为了确保万无一失，需要先清除标志，再读取，但是在我们的例子中，清除标志就已经足够了。</p>
<p>下面的这几行代码：</p>
<div class="highlight"><pre><span></span><code><span class="n">select</span><span class="w"> </span><span class="p">{</span>
<span class="n">case</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="o">:</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">Success</span>
<span class="n">default</span><span class="o">:</span>
<span class="w">    </span><span class="n">leds</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="nf">.Clear</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>是 Go 语言中，如何在通道上非阻塞地发送消息的方法。中断处理程序无法一直等待通道中的空余空间。如果通道已满，则执行 <code>default</code>，开发板上的LED就会开启，直到下一次中断。</p>
<p><code>ISRs</code> 数组包含了中断向量表。<code>//c:__attribute__((section(".ISRs")))</code> 会导致链接器将数组插入到 <code>.ISRs</code> 节中。</p>
<p><code>blinky</code> 的 <code>for</code> 循环的新写法：</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="nv">range</span><span class="w"> </span><span class="nv">ch</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">led</span>.<span class="nv">Clear</span><span class="ss">()</span>
<span class="w">    </span><span class="nv">delay</span>.<span class="nv">Millisec</span><span class="ss">(</span><span class="mi">100</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">led</span>.<span class="nv">Set</span><span class="ss">()</span>
<span class="w">    </span><span class="nv">delay</span>.<span class="nv">Millisec</span><span class="ss">(</span><span class="nv">period</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">100</span><span class="ss">)</span>
}
</code></pre></div>

<p>等价于：</p>
<div class="highlight"><pre><span></span><code><span class="n">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>_<span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">ch</span>
<span class="w">    </span><span class="n">if</span><span class="w"> </span><span class="o">!</span><span class="n">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">break</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Channel</span><span class="w"> </span><span class="n">closed.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">led.Clear</span><span class="p">()</span>
<span class="w">    </span><span class="nf">delay.Millisec</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
<span class="w">    </span><span class="nf">led.Set</span><span class="p">()</span>
<span class="w">    </span><span class="nf">delay.Millisec</span><span class="p">(</span><span class="n">period</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">100</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>注意，在这个例子中，我们不在意通道中收到的值，我们只对其接受到的消息感兴趣。我们可以在声明时，将通道元素类型中的 <code>int</code> 用空结构体 <code>struct{}</code> 来代替，发送消息时，用 <code>struct{}{}</code> 结构体的值代替 0，但这部分对新手来说可能会有些陌生。</p>
<p>让我们来编译一下代码:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>egc
$<span class="w"> </span>arm-none-eabi-size<span class="w"> </span>cortexm0.elf
<span class="w">   </span>text<span class="w">    </span>data<span class="w">     </span>bss<span class="w">     </span>dec<span class="w">     </span>hex<span class="w"> </span>filename
<span class="w">  </span><span class="m">11096</span><span class="w">     </span><span class="m">228</span><span class="w">     </span><span class="m">188</span><span class="w">   </span><span class="m">11512</span><span class="w">    </span>2cf8<span class="w"> </span>cortexm0.elf
</code></pre></div>

<p>新的例子占用了 11324 字节的 Flash 空间，比上一个例子多占用了 1132 字节。</p>
<p>采用现在的时序，两个闪烁协程从通道中获取数据的速度，比 <code>timerISR</code> 发送数据的速度要快。所以它们在同时等待新数据，你还能观察到 <code>select</code> 的随机性，这也是 <a href="https://golang.org/ref/spec#Select_statements">Go 规范</a>所要求的。</p>
<p><img alt="STM32F030F4P6" src="/data/attachment/album/201909/24/210528f1226mspt6m61642.png"></p>
<p>开发板上的 LED 一直没有亮起，说明通道从未出现过溢出。</p>
<p>我们可以加快消息发送的速度，将 <code>timer.ARR.Store(700)</code> 改为 <code>timer.ARR.Store(200)</code>。 现在 <code>timerISR</code> 每秒钟发送 5 条消息，但是两个接收者加起来，每秒也只能接受 4 条消息。</p>
<p><img alt="STM32F030F4P6" src="/data/attachment/album/201909/24/210533bwf6oxaokxwtiwk6.png"></p>
<p>正如你所看到的，<code>timerISR</code> 开启黄色 LED 灯，意味着通道上已经没有剩余空间了。</p>
<p>第一部分到这里就结束了。你应该知道，这一部分并未展示 Go 中最重要的部分，接口。</p>
<p>协程和通道只是一些方便好用的语法。你可以用自己的代码来替换它们，这并不容易，但也可以实现。接口是Go 语言的基础。这是文章中 <a href="https://ziutek.github.io/2018/04/14/go_on_very_small_hardware2.html">第二部分</a>所要提到的.</p>
<p>在 Flash 上我们还有些剩余空间。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>