<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>如何在 RHEL8 /CentOS8 上建立多节点 Elastic stack 集群</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Pradeep Kumar Elastic stack 俗称 ELK stack，是一组包括 Elasticsearch、Logstash 和 Kibana 在内的开源产品。Elastic Stack 由 Elastic 公司开发和维护。使用 Elastic..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2019/09/ru-he-zai-rhel8-centos8-shang-jian-li-duo-jie-dian-elastic-stack-ji-qun.html" rel="bookmark"
           title="Permalink to 如何在 RHEL8 /CentOS8 上建立多节点 Elastic stack 集群">如何在 RHEL8 /CentOS8 上建立多节点 Elastic stack 集群</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-09-26T21:24:00+02:00">
                Published: Thu 26 September 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Pradeep Kumar</p>
<p>Elastic stack 俗称 ELK stack，是一组包括 Elasticsearch、Logstash 和 Kibana 在内的开源产品。Elastic Stack 由 Elastic 公司开发和维护。使用 Elastic stack，可以将系统日志发送到 Logstash，它是一个数据收集引擎，接受来自可能任何来源的日志或数据，并对日志进行归一化，然后将日志转发到 Elasticsearch，用于分析、索引、搜索和存储，最后使用 Kibana 表示为可视化数据，使用 Kibana，我们还可以基于用户的查询创建交互式图表。</p>
<p><img alt="" src="/data/attachment/album/201909/26/212420byaf0zyrv9z8ak8r.jpg"></p>
<p>在本文中，我们将演示如何在 RHEL 8 / CentOS 8 服务器上设置多节点 elastic stack 集群。以下是我的 Elastic Stack 集群的详细信息:</p>
<p><strong>Elasticsearch：</strong></p>
<ul>
<li>三台服务器，最小化安装 RHEL 8 / CentOS 8</li>
<li>IP &amp; 主机名 – 192.168.56.40（<code>elasticsearch1.linuxtechi.local</code>）、192.168.56.50 （<code>elasticsearch2.linuxtechi.local</code>）、192.168.56.60（elasticsearch3.linuxtechi.local`）</li>
</ul>
<p>Logstash：**</p>
<ul>
<li>两台服务器，最小化安装 RHEL 8 / CentOS 8</li>
<li>IP &amp; 主机 – 192.168.56.20（<code>logstash1.linuxtechi.local</code>）、192.168.56.30（<code>logstash2.linuxtechi.local</code>）</li>
</ul>
<p><strong>Kibana：</strong></p>
<ul>
<li>一台服务器，最小化安装 RHEL 8 / CentOS 8</li>
<li>IP &amp; 主机名 – 192.168.56.10（<code>kibana.linuxtechi.local</code>）</li>
</ul>
<p><strong>Filebeat：</strong></p>
<ul>
<li>一台服务器，最小化安装 CentOS 7</li>
<li>IP &amp; 主机名 – 192.168.56.70（<code>web-server</code>）</li>
</ul>
<p>让我们从设置 Elasticsearch 集群开始，</p>
<h3>设置3个节点 Elasticsearch 集群</h3>
<p>正如我已经说过的，设置 Elasticsearch 集群的节点，登录到每个节点，设置主机名并配置 yum/dnf 库。</p>
<p>使用命令 <code>hostnamectl</code> 设置各个节点上的主机名：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">hostnamectl</span><span class="w"> </span><span class="k">set</span><span class="o">-</span><span class="n">hostname</span><span class="w"> </span><span class="ss">&quot;elasticsearch1.linuxtechi. local&quot;</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">hostnamectl</span><span class="w"> </span><span class="k">set</span><span class="o">-</span><span class="n">hostname</span><span class="w"> </span><span class="ss">&quot;elasticsearch2.linuxtechi. local&quot;</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">hostnamectl</span><span class="w"> </span><span class="k">set</span><span class="o">-</span><span class="n">hostname</span><span class="w"> </span><span class="ss">&quot;elasticsearch3.linuxtechi. local&quot;</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<p>对于 CentOS 8 系统，我们不需要配置任何操作系统包库，对于 RHEL 8 服务器，如果你有有效订阅，那么用红帽订阅以获得包存储库就可以了。如果你想为操作系统包配置本地 yum/dnf 存储库，请参考以下网址：</p>
<ul>
<li><a href="https://www.linuxtechi.com/setup-local-yum-dnf-repository-rhel-8/">如何使用 DVD 或 ISO 文件在 RHEL 8 服务器上设置本地 Yum / DNF 存储库</a></li>
</ul>
<p>在所有节点上配置 Elasticsearch 包存储库，在 <code>/etc/yum.repo.d/</code> 文件夹下创建一个包含以下内容的 <code>elastic.repo</code> 文件：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">vi</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">yum</span><span class="p">.</span><span class="nx">repos</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">elastic</span><span class="p">.</span><span class="nx">repo</span>

<span class="p">[</span><span class="nx">elasticsearch</span><span class="o">-</span><span class="mi">7</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span>
<span class="nx">name</span><span class="p">=</span><span class="nx">Elasticsearch</span><span class="w"> </span><span class="nx">repository</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">7</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="nx">packages</span>
<span class="nx">baseurl</span><span class="p">=</span><span class="nx">https</span><span class="p">:</span><span class="c1">//artifacts.elastic.co/packages/7.x/yum</span>
<span class="nx">gpgcheck</span><span class="p">=</span><span class="mi">1</span>
<span class="nx">gpgkey</span><span class="p">=</span><span class="nx">https</span><span class="p">:</span><span class="c1">//artifacts.elastic.co/GPG-KEY-elasticsearch</span>
<span class="nx">enabled</span><span class="p">=</span><span class="mi">1</span>
<span class="nx">autorefresh</span><span class="p">=</span><span class="mi">1</span>
<span class="k">type</span><span class="p">=</span><span class="nx">rpm</span><span class="o">-</span><span class="nx">md</span>
</code></pre></div>

<p>保存文件并退出。</p>
<p>在所有三个节点上使用 <code>rpm</code> 命令导入 Elastic 公共签名密钥。</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="p">]</span><span class="c1"># rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>
</code></pre></div>

<p>在所有三个节点的 <code>/etc/hosts</code> 文件中添加以下行:</p>
<div class="highlight"><pre><span></span><code><span class="mf">192.168.56.40</span><span class="w">             </span><span class="n">elasticsearch1</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
<span class="mf">192.168.56.50</span><span class="w">             </span><span class="n">elasticsearch2</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
<span class="mf">192.168.56.60</span><span class="w">             </span><span class="n">elasticsearch3</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
</code></pre></div>

<p>使用 <code>yum</code>/<code>dnf</code> 命令在所有三个节点上安装 Java：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">java</span><span class="o">-</span><span class="n">openjdk</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">java</span><span class="o">-</span><span class="n">openjdk</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">java</span><span class="o">-</span><span class="n">openjdk</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<p>使用 <code>yum</code>/<code>dnf</code> 命令在所有三个节点上安装 Elasticsearch：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">elasticsearch</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">elasticsearch</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">elasticsearch</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<p><strong>注意：</strong> 如果操作系统防火墙已启用并在每个 Elasticsearch 节点中运行，则使用 <code>firewall-cmd</code> 命令允许以下端口开放：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="p">]</span><span class="c1"># firewall-cmd --permanent --add-port=9300/tcp</span>
<span class="o">~</span><span class="p">]</span><span class="c1"># firewall-cmd --permanent --add-port=9200/tcp</span>
<span class="o">~</span><span class="p">]</span><span class="c1"># firewall-cmd --reload</span>
</code></pre></div>

<p>配置 Elasticsearch, 在所有节点上编辑文件 <code>/etc/elasticsearch/elasticsearch.yml</code> 并加入以下内容：</p>
<div class="highlight"><pre><span></span><code>~]# vim /etc/elasticsearch/elasticsearch.yml

cluster.name: opn-cluster
node.name: elasticsearch1.linuxtechi.local
network.host: 192.168.56.40
http.port: 9200
discovery.seed_hosts: [&quot;elasticsearch1.linuxtechi.local&quot;, &quot;elasticsearch2.linuxtechi.local&quot;, &quot;elasticsearch3.linuxtechi.local&quot;]
cluster.initial_master_nodes: [&quot;elasticsearch1.linuxtechi.local&quot;, &quot;elasticsearch2.linuxtechi.local&quot;, &quot;elasticsearch3.linuxtechi.local&quot;]
</code></pre></div>

<p><strong>注意：</strong> 在每个节点上，在 <code>node.name</code> 中填写正确的主机名，在 <code>network.host</code> 中填写正确的 IP 地址，其他参数保持不变。</p>
<p>现在使用 <code>systemctl</code> 命令在所有三个节点上启动并启用 Elasticsearch 服务：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="p">]</span><span class="c1"># systemctl daemon-reload</span>
<span class="o">~</span><span class="p">]</span><span class="c1"># systemctl enable elasticsearch.service</span>
<span class="o">~</span><span class="p">]</span><span class="c1"># systemctl start elasticsearch.service</span>
</code></pre></div>

<p>使用下面 <code>ss</code> 命令验证 elasticsearch 节点是否开始监听 9200 端口：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">-</span><span class="n">tunlp</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="mi">9200</span>
<span class="n">tcp</span><span class="w">   </span><span class="n">LISTEN</span><span class="w">  </span><span class="mi">0</span><span class="w">       </span><span class="mi">128</span><span class="w">       </span><span class="o">[</span><span class="n">::ffff:192.168.56.40</span><span class="o">]</span><span class="err">:</span><span class="mi">9200</span><span class="w">              </span><span class="o">*</span><span class="err">:</span><span class="o">*</span><span class="w">     </span><span class="nl">users</span><span class="p">:((</span><span class="ss">&quot;java&quot;</span><span class="p">,</span><span class="n">pid</span><span class="o">=</span><span class="mi">2734</span><span class="p">,</span><span class="n">fd</span><span class="o">=</span><span class="mi">256</span><span class="p">))</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<p>使用以下 <code>curl</code> 命令验证 Elasticsearch 群集状态：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">curl</span><span class="w">  </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">elasticsearch1</span><span class="p">.</span><span class="n">linuxtechi</span><span class="p">.</span><span class="k">local</span><span class="err">:</span><span class="mi">9200</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="k">GET</span><span class="w">  </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">elasticsearch2</span><span class="p">.</span><span class="n">linuxtechi</span><span class="p">.</span><span class="k">local</span><span class="err">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">health</span><span class="vm">?</span><span class="n">pretty</span>
</code></pre></div>

<p>命令的输出如下所示：</p>
<p><img alt="Elasticsearch-cluster-status-rhel8" src="/data/attachment/album/201909/26/212753bchmv9icciva11wz.jpg"></p>
<p>以上输出表明我们已经成功创建了 3 节点的 Elasticsearch 集群，集群的状态也是绿色的。</p>
<p><strong>注意：</strong> 如果你想修改 JVM 堆大小，那么你可以编辑了文件 <code>/etc/elasticsearch/jvm.options</code>，并根据你的环境更改以下参数：</p>
<ul>
<li><code>-Xms1g</code></li>
<li><code>-Xmx1g</code></li>
</ul>
<p>现在让我们转到 Logstash 节点。</p>
<h3>安装和配置 Logstash</h3>
<p>在两个 Logstash 节点上执行以下步骤。</p>
<p>登录到两个节点使用 <code>hostnamectl</code> 命令设置主机名：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">hostnamectl</span><span class="w"> </span><span class="k">set</span><span class="o">-</span><span class="n">hostname</span><span class="w"> </span><span class="ss">&quot;logstash1.linuxtechi.local&quot;</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">hostnamectl</span><span class="w"> </span><span class="k">set</span><span class="o">-</span><span class="n">hostname</span><span class="w"> </span><span class="ss">&quot;logstash2.linuxtechi.local&quot;</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<p>在两个 logstash 节点的 <code>/etc/hosts</code> 文件中添加以下条目：</p>
<div class="highlight"><pre><span></span><code>~]# vi /etc/hosts
192.168.56.40             elasticsearch1.linuxtechi.local
192.168.56.50             elasticsearch2.linuxtechi.local
192.168.56.60             elasticsearch3.linuxtechi.local
</code></pre></div>

<p>保存文件并退出。</p>
<p>在两个节点上配置 Logstash 存储库，在文件夹 <code>/ete/yum.repo.d/</code> 下创建一个包含以下内容的文件 <code>logstash.repo</code>：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">vi</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">yum</span><span class="p">.</span><span class="nx">repos</span><span class="p">.</span><span class="nx">d</span><span class="o">/</span><span class="nx">logstash</span><span class="p">.</span><span class="nx">repo</span>

<span class="p">[</span><span class="nx">elasticsearch</span><span class="o">-</span><span class="mi">7</span><span class="p">.</span><span class="nx">x</span><span class="p">]</span>
<span class="nx">name</span><span class="p">=</span><span class="nx">Elasticsearch</span><span class="w"> </span><span class="nx">repository</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">7</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="nx">packages</span>
<span class="nx">baseurl</span><span class="p">=</span><span class="nx">https</span><span class="p">:</span><span class="c1">//artifacts.elastic.co/packages/7.x/yum</span>
<span class="nx">gpgcheck</span><span class="p">=</span><span class="mi">1</span>
<span class="nx">gpgkey</span><span class="p">=</span><span class="nx">https</span><span class="p">:</span><span class="c1">//artifacts.elastic.co/GPG-KEY-elasticsearch</span>
<span class="nx">enabled</span><span class="p">=</span><span class="mi">1</span>
<span class="nx">autorefresh</span><span class="p">=</span><span class="mi">1</span>
<span class="k">type</span><span class="p">=</span><span class="nx">rpm</span><span class="o">-</span><span class="nx">md</span>
</code></pre></div>

<p>保存并退出文件，运行 <code>rpm</code> 命令导入签名密钥：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="p">]</span><span class="c1"># rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>
</code></pre></div>

<p>使用 <code>yum</code>/<code>dnf</code> 命令在两个节点上安装 Java OpenJDK：</p>
<div class="highlight"><pre><span></span><code>~]# dnf install java-openjdk -y
</code></pre></div>

<p>从两个节点运行 <code>yum</code>/<code>dnf</code> 命令来安装 logstash：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">logstash</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">logstash</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<p>现在配置 logstash，在两个 logstash 节点上执行以下步骤，创建一个 logstash 配置文件，首先我们在 <code>/etc/logstash/conf.d/</code> 下复制 logstash 示例文件：</p>
<div class="highlight"><pre><span></span><code># cd /etc/logstash/
# cp logstash-sample.conf conf.d/logstash.conf
</code></pre></div>

<p>编辑配置文件并更新以下内容：</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">vi</span><span class="w"> </span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">logstash</span><span class="p">.</span><span class="n">conf</span>

<span class="k">input</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">beats</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">5044</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>

<span class="k">output</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="n">elasticsearch</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">hosts</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;http://elasticsearch1.linuxtechi.local:9200&quot;, &quot;http://elasticsearch2.linuxtechi.local:9200&quot;, &quot;http://elasticsearch3.linuxtechi.local:9200&quot;</span><span class="o">]</span>
<span class="w">    </span><span class="k">index</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}&quot;</span>
<span class="w">    </span><span class="n">#user</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;elastic&quot;</span>
<span class="w">    </span><span class="n">#password</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;changeme&quot;</span>
<span class="w">  </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>

<p>在 <code>output</code> 部分之下，在 <code>hosts</code> 参数中指定所有三个 Elasticsearch 节点的 FQDN，其他参数保持不变。</p>
<p>使用 <code>firewall-cmd</code> 命令在操作系统防火墙中允许 logstash 端口 “5044”：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="w"> </span><span class="c1"># firewall-cmd --permanent --add-port=5044/tcp</span>
<span class="o">~</span><span class="w"> </span><span class="c1"># firewall-cmd –reload</span>
</code></pre></div>

<p>现在，在每个节点上运行以下 <code>systemctl</code> 命令，启动并启用 Logstash 服务：</p>
<div class="highlight"><pre><span></span><code>~]# systemctl start logstash
~]# systemctl eanble logstash
</code></pre></div>

<p>使用 <code>ss</code> 命令验证 logstash 服务是否开始监听 5044 端口：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">-</span><span class="n">tunlp</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="mi">5044</span>
<span class="n">tcp</span><span class="w">   </span><span class="n">LISTEN</span><span class="w">  </span><span class="mi">0</span><span class="w">       </span><span class="mi">128</span><span class="w">                         </span><span class="o">*</span><span class="err">:</span><span class="mi">5044</span><span class="w">                </span><span class="o">*</span><span class="err">:</span><span class="o">*</span><span class="w">      </span><span class="nl">users</span><span class="p">:((</span><span class="ss">&quot;java&quot;</span><span class="p">,</span><span class="n">pid</span><span class="o">=</span><span class="mi">2416</span><span class="p">,</span><span class="n">fd</span><span class="o">=</span><span class="mi">96</span><span class="p">))</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<p>以上输出表明 logstash 已成功安装和配置。让我们转到 Kibana 安装。</p>
<h3>安装和配置 Kibana</h3>
<p>登录 Kibana 节点，使用 <code>hostnamectl</code> 命令设置主机名：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">hostnamectl</span><span class="w"> </span><span class="k">set</span><span class="o">-</span><span class="n">hostname</span><span class="w"> </span><span class="ss">&quot;kibana.linuxtechi.local&quot;</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exec</span><span class="w"> </span><span class="n">bash</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<p>编辑 <code>/etc/hosts</code> 文件并添加以下行：</p>
<div class="highlight"><pre><span></span><code><span class="mf">192.168.56.40</span><span class="w">             </span><span class="n">elasticsearch1</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
<span class="mf">192.168.56.50</span><span class="w">             </span><span class="n">elasticsearch2</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
<span class="mf">192.168.56.60</span><span class="w">             </span><span class="n">elasticsearch3</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
</code></pre></div>

<p>使用以下命令设置 Kibana 存储库：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="nd">@linuxtechi</span> <span class="o">~</span><span class="p">]</span><span class="c1"># vi /etc/yum.repos.d/kibana.repo</span>
<span class="p">[</span><span class="n">elasticsearch</span><span class="o">-</span><span class="mf">7.</span><span class="n">x</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">Elasticsearch</span> <span class="n">repository</span> <span class="k">for</span> <span class="mf">7.</span><span class="n">x</span> <span class="n">packages</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">artifacts</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="mf">7.</span><span class="n">x</span><span class="o">/</span><span class="n">yum</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgkey</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">artifacts</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">GPG</span><span class="o">-</span><span class="n">KEY</span><span class="o">-</span><span class="n">elasticsearch</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="n">autorefresh</span><span class="o">=</span><span class="mi">1</span>
<span class="nb">type</span><span class="o">=</span><span class="n">rpm</span><span class="o">-</span><span class="n">md</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@linuxtechi</span> <span class="o">~</span><span class="p">]</span><span class="c1"># rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch</span>
</code></pre></div>

<p>执行 <code>yum</code>/<code>dnf</code> 命令安装 kibana：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">kibana</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<p>通过编辑 <code>/etc/kibana/kibana.yml</code> 文件，配置 Kibana：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">kibana</span><span class="p">.</span><span class="n">yml</span>
<span class="err">…………</span>
<span class="n">server</span><span class="p">.</span><span class="k">host</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;kibana.linuxtechi.local&quot;</span>
<span class="n">server</span><span class="p">.</span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;kibana.linuxtechi.local&quot;</span>
<span class="n">elasticsearch</span><span class="p">.</span><span class="nl">hosts</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;http://elasticsearch1.linuxtechi.local:9200&quot;, &quot;http://elasticsearch2.linuxtechi.local:9200&quot;, &quot;http://elasticsearch3.linuxtechi.local:9200&quot;</span><span class="o">]</span>
<span class="err">…………</span>
</code></pre></div>

<p>启用并启动 kibana 服务：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">kibana</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">kibana</span>
</code></pre></div>

<p>在系统防火墙上允许 Kibana 端口 “5601”：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># firewall-cmd --permanent --add-port=5601/tcp</span>
<span class="n">success</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># firewall-cmd --reload</span>
<span class="n">success</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<p>使用以下 URL 访问 Kibana 界面：<a href="http://kibana.linuxtechi.local:5601">http://kibana.linuxtechi.local:5601</a></p>
<p><img alt="Kibana-Dashboard-rhel8" src="/data/attachment/album/201909/26/212453uht51r0cd0wcupbh.jpg"></p>
<p>从面板上，我们可以检查 Elastic Stack 集群的状态。</p>
<p><img alt="Stack-Monitoring-Overview-RHEL8" src="/data/attachment/album/201909/26/212508s0f88fd788nwk868.jpg"></p>
<p>这证明我们已经在 RHEL 8 /CentOS 8 上成功地安装并设置了多节点 Elastic Stack 集群。</p>
<p>现在让我们通过 <code>filebeat</code> 从其他 Linux 服务器发送一些日志到 logstash 节点中，在我的例子中，我有一个 CentOS 7服务器，我将通过 <code>filebeat</code> 将该服务器的所有重要日志推送到 logstash。</p>
<p>登录到 CentOS 7 服务器使用 yum/rpm 命令安装 filebeat 包：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># rpm -ivh https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.1-x86_64.rpm</span>
<span class="n">Retrieving</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">artifacts</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span><span class="o">/</span><span class="n">downloads</span><span class="o">/</span><span class="n">beats</span><span class="o">/</span><span class="n">filebeat</span><span class="o">/</span><span class="n">filebeat</span><span class="o">-</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">Preparing</span><span class="o">...</span><span class="w">                          </span><span class="c1">################################# [100%]</span>
<span class="n">Updating</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">installing</span><span class="o">...</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="n">filebeat</span><span class="o">-</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="w">                 </span><span class="c1">################################# [100%]</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<p>编辑 <code>/etc/hosts</code> 文件并添加以下内容：</p>
<div class="highlight"><pre><span></span><code><span class="mf">192.168.56.20</span><span class="w">             </span><span class="nb">log</span><span class="n">stash1</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
<span class="mf">192.168.56.30</span><span class="w">             </span><span class="nb">log</span><span class="n">stash2</span><span class="mf">.</span><span class="n">linuxtechi</span><span class="mf">.</span><span class="n">local</span>
</code></pre></div>

<p>现在配置 <code>filebeat</code>，以便它可以使用负载平衡技术向 logstash 节点发送日志，编辑文件 <code>/etc/filebeat/filebeat.yml</code>，并添加以下参数：</p>
<p>在 <code>filebeat.inputs:</code> 部分将 <code>enabled: false</code> 更改为 <code>enabled: true</code>，并在 <code>paths</code> 参数下指定我们可以发送到 logstash 的日志文件的位置；注释掉 <code>output.elasticsearch</code> 和 <code>host</code> 参数；删除 <code>output.logstash:</code> 和 <code>hosts:</code> 的注释，并在 <code>hosts</code> 参数添加两个 logstash 节点，以及设置 <code>loadbalance: true</code>。</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># vi /etc/filebeat/filebeat.yml</span>

<span class="n">filebeat</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="nb">log</span>
<span class="w">  </span><span class="n">enabled</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">  </span><span class="n">paths</span><span class="p">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">messages</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">dmesg</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">maillog</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">boot</span><span class="o">.</span><span class="n">log</span>
<span class="c1">#output.elasticsearch:</span>
<span class="w">  </span><span class="c1">#  hosts: [&quot;localhost:9200&quot;]</span>

<span class="n">output</span><span class="o">.</span><span class="n">logstash</span><span class="p">:</span>
<span class="w">    </span><span class="n">hosts</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;logstash1.linuxtechi.local:5044&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;logstash2.linuxtechi.local:5044&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">loadbalance</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
</code></pre></div>

<p>使用下面的 2 个 <code>systemctl</code> 命令 启动并启用 <code>filebeat</code> 服务：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">filebeat</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">filebeat</span>
</code></pre></div>

<p>现在转到 Kibana 用户界面，验证新索引是否可见。</p>
<p>从左侧栏中选择管理选项，然后单击 Elasticsearch 下的索引管理：</p>
<p><img alt="Elasticsearch-index-management-Kibana" src="/data/attachment/album/201909/26/212514m1lziump2ly2zz81.jpg"></p>
<p>正如我们上面看到的，索引现在是可见的，让我们现在创建索引模型。</p>
<p>点击 Kibana 部分的 “Index Patterns”，它将提示我们创建一个新模型，点击 “Create Index Pattern” ，并将模式名称指定为 “filebeat”：</p>
<p><img alt="Define-Index-Pattern-Kibana-RHEL8" src="/data/attachment/album/201909/26/212519soeqwn1emyomum2m.jpg"></p>
<p>点击下一步。</p>
<p>选择 “Timestamp” 作为索引模型的时间过滤器，然后单击 “Create index pattern”：</p>
<p><img alt="Time-Filter-Index-Pattern-Kibana-RHEL8" src="/data/attachment/album/201909/26/212526cvb1vr31lj3lojkn.jpg"></p>
<p><img alt="filebeat-index-pattern-overview-Kibana" src="/data/attachment/album/201909/26/212532wlz4albbl2mgccap.jpg"></p>
<p>现在单击查看实时 filebeat 索引模型：</p>
<p><img alt="Discover-Kibana-REHL8" src="/data/attachment/album/201909/26/212548zqw4482qv44q12v7.jpg"></p>
<p>这表明 Filebeat 代理已配置成功，我们能够在 Kibana 仪表盘上看到实时日志。</p>
<p>以上就是本文的全部内容，对这些帮助你在 RHEL 8 / CentOS 8 系统上设置 Elastic Stack 集群的步骤，请不要犹豫分享你的反馈和意见。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>