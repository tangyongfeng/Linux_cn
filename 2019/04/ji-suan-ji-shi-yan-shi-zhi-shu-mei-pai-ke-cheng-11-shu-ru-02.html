<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>计算机实验室之树莓派：课程 11 输入02</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Alex Chadwick 课程输入 02 是以课程输入 01 为基础讲解的，通过一个简单的命令行实现用户的命令输入和计算机的处理和显示 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li class="active"><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2019/04/ji-suan-ji-shi-yan-shi-zhi-shu-mei-pai-ke-cheng-11-shu-ru-02.html" rel="bookmark"
           title="Permalink to 计算机实验室之树莓派：课程 11 输入02">计算机实验室之树莓派：课程 11 输入02</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-04-09T21:22:50+02:00">
                Published: Tue 09 April 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/shu-mei-pai">树莓派</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Alex Chadwick</p>
<p><img alt="" src="/data/attachment/album/201904/09/212155awcoxjbzwxaikjrd.jpg"></p>
<p>课程输入 02 是以课程输入 01 为基础讲解的，通过一个简单的命令行实现用户的命令输入和计算机的处理和显示。本文假设你已经具备 <a href="/article-10676-1.html">课程11：输入01</a> 的操作系统代码基础。</p>
<h3>1、终端</h3>
<p>几乎所有的操作系统都是以字符终端显示启动的。经典的黑底白字，通过键盘输入计算机要执行的命令，然后会提示你拼写错误，或者恰好得到你想要的执行结果。这种方法有两个主要优点：键盘和显示器可以提供简易、健壮的计算机交互机制，几乎所有的计算机系统都采用这个机制，这个也广泛被系统管理员应用。</p>
<blockquote>
<p>早期的计算一般是在一栋楼里的一个巨型计算机系统，它有很多可以输命令的'终端'。计算机依次执行不同来源的命令。</p>
</blockquote>
<p>让我们分析下真正想要哪些信息：</p>
<ol>
<li>计算机打开后，显示欢迎信息</li>
<li>计算机启动后可以接受输入标志</li>
<li>用户从键盘输入带参数的命令</li>
<li>用户输入回车键或提交按钮</li>
<li>计算机解析命令后执行可用的命令</li>
<li>计算机显示命令的执行结果，过程信息</li>
<li>循环跳转到步骤 2</li>
</ol>
<p>这样的终端被定义为标准的输入输出设备。用于（显示）输入的屏幕和打印输出内容的屏幕是同一个（LCTT 译注：最早期的输出打印真是“打印”到打印机/电传机的，而用于输入的终端只是键盘，除非做了回显，否则输出终端是不会显示输入的字符的）。也就是说终端是对字符显示的一个抽象。字符显示中，单个字符是最小的单元，而不是像素。屏幕被划分成固定数量不同颜色的字符。我们可以在现有的屏幕代码基础上，先存储字符和对应的颜色，然后再用方法 <code>DrawCharacter</code> 把其推送到屏幕上。一旦我们需要字符显示，就只需要在屏幕上画出一行字符串。</p>
<p>新建文件名为 <code>terminal.s</code>，如下：</p>
<div class="highlight"><pre><span></span><code><span class="na">.section</span><span class="w"> </span><span class="no">.data</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">4</span>
<span class="nl">terminalStart:</span>
<span class="na">.int</span><span class="w"> </span><span class="no">terminalBuffer</span>
<span class="nl">terminalStop:</span>
<span class="na">.int</span><span class="w"> </span><span class="no">terminalBuffer</span>
<span class="nl">terminalView:</span>
<span class="na">.int</span><span class="w"> </span><span class="no">terminalBuffer</span>
<span class="nl">terminalColour:</span>
<span class="na">.byte</span><span class="w"> </span><span class="mi">0xf</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">8</span>
<span class="nl">terminalBuffer:</span>
<span class="na">.rept</span><span class="w"> </span><span class="mi">128</span><span class="p">*</span><span class="mi">128</span>
<span class="na">.byte</span><span class="w"> </span><span class="mi">0x7f</span>
<span class="na">.byte</span><span class="w"> </span><span class="mi">0x0</span>
<span class="na">.endr</span>
<span class="nl">terminalScreen:</span>
<span class="na">.rept</span><span class="w"> </span><span class="mi">1024</span><span class="err">/</span><span class="mi">8</span><span class="w"> </span><span class="no">core.md</span><span class="w"> </span><span class="no">Dict.md</span><span class="w"> </span><span class="no">lctt2014.md</span><span class="w"> </span><span class="no">lctt2016.md</span><span class="w"> </span><span class="no">lctt2018.md</span><span class="w"> </span><span class="no">LICENSE</span><span class="w"> </span><span class="no">published</span><span class="w"> </span><span class="no">README.md</span><span class="w"> </span><span class="no">scripts</span><span class="w"> </span><span class="no">sources</span><span class="w"> </span><span class="no">translated</span><span class="w"> </span><span class="mi">768</span><span class="err">/</span><span class="mi">16</span>
<span class="na">.byte</span><span class="w"> </span><span class="mi">0x7f</span>
<span class="na">.byte</span><span class="w"> </span><span class="mi">0x0</span>
<span class="na">.endr</span>
</code></pre></div>

<p>这是文件终端的配置数据文件。我们有两个主要的存储变量：<code>terminalBuffer</code> 和 <code>terminalScreen</code>。<code>terminalBuffer</code> 保存所有显示过的字符。它保存 128 行字符文本（1 行包含 128 个字符）。每个字符有一个 ASCII 字符和颜色单元组成，初始值为 0x7f（ASCII 的删除字符）和 0（前景色和背景色为黑）。<code>terminalScreen</code> 保存当前屏幕显示的字符。它保存 128x48 个字符，与 <code>terminalBuffer</code> 初始化值一样。你可能会觉得我仅需要 <code>terminalScreen</code> 就够了，为什么还要<code>terminalBuffer</code>，其实有两个好处：</p>
<ol>
<li>我们可以很容易看到字符串的变化，只需画出有变化的字符。</li>
<li>我们可以回滚终端显示的历史字符，也就是缓冲的字符（有限制）</li>
</ol>
<p>这种独特的技巧在低功耗系统里很常见。画屏是很耗时的操作，因此我们仅在不得已的时候才去执行这个操作。在这个系统里，我们可以任意改变 <code>terminalBuffer</code>，然后调用一个仅拷贝屏幕上字节变化的方法。也就是说我们不需要持续画出每个字符，这样可以节省一大段跨行文本的操作时间。</p>
<blockquote>
<p>你总是需要尝试去设计一个高效的系统，如果在很少变化的情况下这个系统会运行的更快。</p>
</blockquote>
<p>其他在 <code>.data</code> 段的值得含义如下：</p>
<ul>
<li><code>terminalStart</code> 写入到 <code>terminalBuffer</code> 的第一个字符</li>
<li><code>terminalStop</code> 写入到 <code>terminalBuffer</code> 的最后一个字符</li>
<li><code>terminalView</code> 表示当前屏幕的第一个字符，这样我们可以控制滚动屏幕</li>
<li><code>temrinalColour</code> 即将被描画的字符颜色</li>
</ul>
<p><code>terminalStart</code> 需要保存起来的原因是 <code>termainlBuffer</code> 是一个环状缓冲区。意思是当缓冲区变满时，末尾地方会回滚覆盖开始位置，这样最后一个字符变成了第一个字符。因此我们需要将 <code>terminalStart</code> 往前推进，这样我们知道我们已经占满它了。如何实现缓冲区检测：如果索引越界到缓冲区的末尾，就将索引指向缓冲区的开始位置。环状缓冲区是一个比较常见的存储大量数据的高明方法，往往这些数据的最近部分比较重要。它允许无限制的写入，只保证最近一些特定数据有效。这个常常用于信号处理和数据压缩算法。这样的情况，可以允许我们存储 128 行终端记录，超过128行也不会有问题。如果不是这样，当超过第 128 行时，我们需要把 127 行分别向前拷贝一次，这样很浪费时间。</p>
<p><img alt="显示 Hellow world 插入到大小为5的循环缓冲区的示意图。" src="/data/attachment/album/201904/09/212254t6i563mrmxwlrnm5.png"></p>
<blockquote>
<p>环状缓冲区是<strong>数据结构</strong>一个例子。这是一个组织数据的思路，有时我们通过软件实现这种思路。</p>
</blockquote>
<p>之前已经提到过 <code>terminalColour</code> 几次了。你可以根据你的想法实现终端颜色，但这个文本终端有 16 个前景色和 16 个背景色（这里相当于有 16<sup> 2</sup> = 256 种组合）。<a href="https://en.wikipedia.org/wiki/Color_Graphics_Adapter">CGA</a>终端的颜色定义如下：</p>
<p>表格 1.1 - CGA 颜色编码</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>颜色 (R, G, B)</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>黑 (0, 0, 0)</td>
</tr>
<tr>
<td>1</td>
<td>蓝 (0, 0, ⅔)</td>
</tr>
<tr>
<td>2</td>
<td>绿 (0, ⅔, 0)</td>
</tr>
<tr>
<td>3</td>
<td>青色 (0, ⅔, ⅔)</td>
</tr>
<tr>
<td>4</td>
<td>红色 (⅔, 0, 0)</td>
</tr>
<tr>
<td>5</td>
<td>品红 (⅔, 0, ⅔)</td>
</tr>
<tr>
<td>6</td>
<td>棕色 (⅔, ⅓, 0)</td>
</tr>
<tr>
<td>7</td>
<td>浅灰色 (⅔, ⅔, ⅔)</td>
</tr>
<tr>
<td>8</td>
<td>灰色 (⅓, ⅓, ⅓)</td>
</tr>
<tr>
<td>9</td>
<td>淡蓝色 (⅓, ⅓, 1)</td>
</tr>
<tr>
<td>10</td>
<td>淡绿色 (⅓, 1, ⅓)</td>
</tr>
<tr>
<td>11</td>
<td>淡青色 (⅓, 1, 1)</td>
</tr>
<tr>
<td>12</td>
<td>淡红色 (1, ⅓, ⅓)</td>
</tr>
<tr>
<td>13</td>
<td>浅品红 (1, ⅓, 1)</td>
</tr>
<tr>
<td>14</td>
<td>黄色 (1, 1, ⅓)</td>
</tr>
<tr>
<td>15</td>
<td>白色 (1, 1, 1)</td>
</tr>
</tbody>
</table>
<p>我们将前景色保存到颜色的低字节，背景色保存到颜色高字节。除了棕色，其他这些颜色遵循一种模式如二进制的高位比特代表增加 ⅓ 到每个组件，其他比特代表增加 ⅔ 到各自组件。这样很容易进行 RGB 颜色转换。</p>
<blockquote>
<p>棕色作为替代色（黑黄色）既不吸引人也没有什么用处。</p>
</blockquote>
<p>我们需要一个方法从 <code>TerminalColour</code> 读取颜色编码的四个比特，然后用 16 比特等效参数调用 <code>SetForeColour</code>。尝试你自己实现。如果你感觉麻烦或者还没有完成屏幕系列课程，我们的实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="na">.section</span><span class="w"> </span><span class="no">.text</span>
<span class="nl">TerminalColour:</span>
<span class="nf">teq</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#6</span>
<span class="nf">ldreq</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="err">=</span><span class="mi">0x02B5</span>
<span class="nf">beq</span><span class="w"> </span><span class="no">SetForeColour</span>

<span class="nf">tst</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span><span class="no">b1000</span>
<span class="nf">ldrne</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="err">=</span><span class="mi">0x52AA</span>
<span class="nf">moveq</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span>
<span class="nf">tst</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span><span class="no">b0100</span>
<span class="nf">addne</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span><span class="no">x15</span>
<span class="nf">tst</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span><span class="no">b0010</span>
<span class="nf">addne</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span><span class="no">x540</span>
<span class="nf">tst</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span><span class="no">b0001</span>
<span class="nf">addne</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span><span class="no">xA800</span>
<span class="nf">mov</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="no">r1</span>
<span class="nf">b</span><span class="w"> </span><span class="no">SetForeColour</span>
</code></pre></div>

<h3>2、文本显示</h3>
<p>我们的终端第一个真正需要的方法是 <code>TerminalDisplay</code>，它用来把当前的数据从 <code>terminalBuffer</code>拷贝到 <code>terminalScreen</code> 和实际的屏幕。如上所述，这个方法必须是最小开销的操作，因为我们需要频繁调用它。它主要比较 <code>terminalBuffer</code> 与 <code>terminalDisplay</code> 的文本，然后只拷贝有差异的字节。请记住 <code>terminalBuffer</code> 是以环状缓冲区运行的，这种情况，就是从 <code>terminalView</code> 到 <code>terminalStop</code>，或者 128*48 个字符，要看哪个来的最快。如果我们遇到 <code>terminalStop</code>，我们将会假定在这之后的所有字符是 7f<sub> 16</sub> (ASCII 删除字符)，颜色为 0（黑色前景色和背景色）。</p>
<p>让我们看看必须要做的事情：</p>
<ol>
<li>加载 <code>terminalView</code>、<code>terminalStop</code> 和 <code>terminalDisplay</code> 的地址。</li>
<li>对于每一行：<ol>
<li>对于每一列：<ol>
<li>如果 <code>terminalView</code> 不等于 <code>terminalStop</code>，根据 <code>terminalView</code> 加载当前字符和颜色</li>
<li>否则加载 0x7f 和颜色 0</li>
<li>从 <code>terminalDisplay</code> 加载当前的字符</li>
<li>如果字符和颜色相同，直接跳转到第 10 步</li>
<li>存储字符和颜色到 <code>terminalDisplay</code></li>
<li>用 <code>r0</code> 作为背景色参数调用 <code>TerminalColour</code></li>
<li>用 <code>r0 = 0x7f</code>（ASCII 删除字符，一个块）、 <code>r1 = x</code>、<code>r2 = y</code> 调用 <code>DrawCharacter</code></li>
<li>用 <code>r0</code> 作为前景色参数调用 <code>TerminalColour</code></li>
<li>用 <code>r0 = 字符</code>、<code>r1 = x</code>、<code>r2 = y</code> 调用 <code>DrawCharacter</code></li>
<li>对位置参数 <code>terminalDisplay</code> 累加 2</li>
<li>如果 <code>terminalView</code> 不等于 <code>terminalStop</code>，<code>terminalView</code> 位置参数累加 2</li>
<li>如果 <code>terminalView</code> 位置已经是文件缓冲器的末尾，将它设置为缓冲区的开始位置</li>
<li>x 坐标增加 8</li>
</ol>
</li>
<li>y 坐标增加 16</li>
</ol>
</li>
</ol>
<p>尝试去自己实现吧。如果你遇到问题，我们的方案下面给出来了：</p>
<p>1、我这里的变量有点乱。为了方便起见，我用 <code>taddr</code> 存储 <code>textBuffer</code> 的末尾位置。</p>
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="nx">globl</span><span class="w"> </span><span class="nx">TerminalDisplay</span>
<span class="nx">TerminalDisplay</span><span class="p">:</span>
<span class="nx">push</span><span class="w"> </span><span class="p">{</span><span class="nx">r4</span><span class="p">,</span><span class="nx">r5</span><span class="p">,</span><span class="nx">r6</span><span class="p">,</span><span class="nx">r7</span><span class="p">,</span><span class="nx">r8</span><span class="p">,</span><span class="nx">r9</span><span class="p">,</span><span class="nx">r10</span><span class="p">,</span><span class="nx">r11</span><span class="p">,</span><span class="nx">lr</span><span class="p">}</span>
<span class="nx">x</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r4</span>
<span class="nx">y</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r5</span>
<span class="nx">char</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r6</span>
<span class="nx">col</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r7</span>
<span class="nx">screen</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r8</span>
<span class="nx">taddr</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r9</span>
<span class="nx">view</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r10</span>
<span class="nx">stop</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r11</span>

<span class="nx">ldr</span><span class="w"> </span><span class="nx">taddr</span><span class="p">,=</span><span class="nx">terminalStart</span>
<span class="nx">ldr</span><span class="w"> </span><span class="nx">view</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalView</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">ldr</span><span class="w"> </span><span class="nx">stop</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalStop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">add</span><span class="w"> </span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalBuffer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">terminalStart</span>
<span class="nx">add</span><span class="w"> </span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="mi">128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
<span class="nx">mov</span><span class="w"> </span><span class="nx">screen</span><span class="p">,</span><span class="nx">taddr</span>
</code></pre></div>

<p>2、从 <code>yLoop</code> 开始运行。</p>
<div class="highlight"><pre><span></span><code>mov y,#0
yLoop$:
</code></pre></div>

<p>2.1、</p>
<div class="highlight"><pre><span></span><code>mov x,#0
xLoop$:
</code></pre></div>

<p>从 <code>xLoop</code> 开始运行。</p>
<p>2.1.1、为了方便起见，我把字符和颜色同时加载到 <code>char</code> 变量了</p>
<div class="highlight"><pre><span></span><code><span class="n">teq</span><span class="w"> </span><span class="k">view</span><span class="p">,</span><span class="n">stop</span>
<span class="n">ldrneh</span><span class="w"> </span><span class="nc">char</span><span class="p">,</span><span class="o">[</span><span class="n">view</span><span class="o">]</span>
</code></pre></div>

<p>2.1.2、这行是对上面一行的补充说明：读取黑色的删除字符</p>
<div class="highlight"><pre><span></span><code>moveq char,#0x7f
</code></pre></div>

<p>2.1.3、为了简便我把字符和颜色同时加载到 <code>col</code> 里。</p>
<div class="highlight"><pre><span></span><code><span class="n">ldrh</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="o">[</span><span class="n">screen</span><span class="o">]</span>
</code></pre></div>

<p>2.1.4、 现在我用 <code>teq</code> 指令检查是否有数据变化</p>
<div class="highlight"><pre><span></span><code><span class="nv">teq</span><span class="w"> </span><span class="nv">col</span><span class="p">,</span><span class="nv">char</span>
<span class="nv">beq</span><span class="w"> </span><span class="nv">xLoopContinue</span><span class="p">$</span>
</code></pre></div>

<p>2.1.5、我可以容易的保存当前值</p>
<div class="highlight"><pre><span></span><code><span class="n">strh</span><span class="w"> </span><span class="nc">char</span><span class="p">,</span><span class="o">[</span><span class="n">screen</span><span class="o">]</span>
</code></pre></div>

<p>2.1.6、我用比特偏移指令 <code>lsr</code> 和 <code>and</code> 指令从切分 <code>char</code> 变量，将颜色放到 <code>col</code> 变量，字符放到 <code>char</code> 变量，然后再用比特偏移指令 <code>lsr</code> 获取背景色后调用 <code>TerminalColour</code> 。</p>
<div class="highlight"><pre><span></span><code>lsr col,char,#8
and char,#0x7f
lsr r0,col,#4
bl TerminalColour
</code></pre></div>

<p>2.1.7、写入一个彩色的删除字符</p>
<div class="highlight"><pre><span></span><code>mov r0,#0x7f
mov r1,x
mov r2,y
bl DrawCharacter
</code></pre></div>

<p>2.1.8、用 <code>and</code> 指令获取 <code>col</code> 变量的低半字节，然后调用 <code>TerminalColour</code></p>
<div class="highlight"><pre><span></span><code>and r0,col,#0xf
bl TerminalColour
</code></pre></div>

<p>2.1.9、写入我们需要的字符</p>
<div class="highlight"><pre><span></span><code>mov r0,char
mov r1,x
mov r2,y
bl DrawCharacter
</code></pre></div>

<p>2.1.10、自增屏幕指针</p>
<div class="highlight"><pre><span></span><code>xLoopContinue$:
add screen,#2
</code></pre></div>

<p>2.1.11、如果可能自增 <code>view</code> 指针</p>
<div class="highlight"><pre><span></span><code>teq view,stop
addne view,#2
</code></pre></div>

<p>2.1.12、很容易检测 <code>view</code> 指针是否越界到缓冲区的末尾，因为缓冲区的地址保存在 <code>taddr</code> 变量里</p>
<div class="highlight"><pre><span></span><code><span class="nx">teq</span><span class="w"> </span><span class="nx">view</span><span class="p">,</span><span class="nx">taddr</span>
<span class="nx">subeq</span><span class="w"> </span><span class="nx">view</span><span class="p">,</span><span class="err">#</span><span class="mi">128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
</code></pre></div>

<p>2.1.13、 如果还有字符需要显示，我们就需要自增 <code>x</code> 变量然后到 <code>xLoop</code> 循环执行</p>
<div class="highlight"><pre><span></span><code><span class="nv">add</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="o">#</span><span class="mi">8</span>
<span class="nv">teq</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="o">#</span><span class="mi">1024</span>
<span class="nv">bne</span><span class="w"> </span><span class="nv">xLoop</span><span class="p">$</span>
</code></pre></div>

<p>2.2、 如果还有更多的字符显示我们就需要自增 <code>y</code> 变量，然后到 <code>yLoop</code> 循环执行</p>
<div class="highlight"><pre><span></span><code><span class="nv">add</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span><span class="o">#</span><span class="mi">16</span>
<span class="nv">teq</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span><span class="o">#</span><span class="mi">768</span>
<span class="nv">bne</span><span class="w"> </span><span class="nv">yLoop</span><span class="p">$</span>
</code></pre></div>

<p>3、不要忘记最后清除变量</p>
<div class="highlight"><pre><span></span><code><span class="nx">pop</span><span class="w"> </span><span class="p">{</span><span class="nx">r4</span><span class="p">,</span><span class="nx">r5</span><span class="p">,</span><span class="nx">r6</span><span class="p">,</span><span class="nx">r7</span><span class="p">,</span><span class="nx">r8</span><span class="p">,</span><span class="nx">r9</span><span class="p">,</span><span class="nx">r10</span><span class="p">,</span><span class="nx">r11</span><span class="p">,</span><span class="nx">pc</span><span class="p">}</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">x</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">y</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">char</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">col</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">screen</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">taddr</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">view</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">stop</span>
</code></pre></div>

<h3>3、行打印</h3>
<p>现在我有了自己 <code>TerminalDisplay</code> 方法，它可以自动显示 <code>terminalBuffer</code> 内容到 <code>terminalScreen</code>，因此理论上我们可以画出文本。但是实际上我们没有任何基于字符显示的例程。 首先快速容易上手的方法便是 <code>TerminalClear</code>， 它可以彻底清除终端。这个方法不用循环也很容易实现。可以尝试分析下面的方法应该不难：</p>
<div class="highlight"><pre><span></span><code><span class="p">.</span><span class="n">globl</span><span class="w"> </span><span class="n">TerminalClear</span>
<span class="nl">TerminalClear</span><span class="p">:</span>
<span class="n">ldr</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="o">=</span><span class="n">terminalStart</span>
<span class="k">add</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">#terminalBuffer</span><span class="o">-</span><span class="n">terminalStart</span>
<span class="nf">str</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="o">[</span><span class="n">r0</span><span class="o">]</span>
<span class="nf">str</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="o">[</span><span class="n">r0,#terminalStop-terminalStart</span><span class="o">]</span>
<span class="nf">str</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="o">[</span><span class="n">r0,#terminalView-terminalStart</span><span class="o">]</span>
<span class="n">mov</span><span class="w"> </span><span class="n">pc</span><span class="p">,</span><span class="n">lr</span>
</code></pre></div>

<p>现在我们需要构造一个字符显示的基础方法：<code>Print</code> 函数。它将保存在 <code>r0</code> 的字符串和保存在 <code>r1</code> 的字符串长度简单的写到屏幕上。有一些特定字符需要特别的注意，这些特定的操作是确保 <code>terminalView</code> 是最新的。我们来分析一下需要做什么：</p>
<ol>
<li>检查字符串的长度是否为 0，如果是就直接返回</li>
<li>加载 <code>terminalStop</code> 和 <code>terminalView</code></li>
<li>计算出 <code>terminalStop</code> 的 x 坐标</li>
<li>对每一个字符的操作：<ol>
<li>检查字符是否为新起一行</li>
<li>如果是的话，自增 <code>bufferStop</code> 到行末，同时写入黑色删除字符</li>
<li>否则拷贝当前 <code>terminalColour</code> 的字符</li>
<li>检查是否在行末</li>
<li>如果是，检查从 <code>terminalView</code> 到 <code>terminalStop</code> 之间的字符数是否大于一屏</li>
<li>如果是，<code>terminalView</code> 自增一行</li>
<li>检查 <code>terminalView</code> 是否为缓冲区的末尾，如果是的话将其替换为缓冲区的起始位置</li>
<li>检查 <code>terminalStop</code> 是否为缓冲区的末尾，如果是的话将其替换为缓冲区的起始位置</li>
<li>检查 <code>terminalStop</code> 是否等于 <code>terminalStart</code>， 如果是的话 <code>terminalStart</code> 自增一行。</li>
<li>检查 <code>terminalStart</code> 是否为缓冲区的末尾，如果是的话将其替换为缓冲区的起始位置</li>
</ol>
</li>
<li>存取 <code>terminalStop</code> 和 <code>terminalView</code></li>
</ol>
<p>试一下自己去实现。我们的方案提供如下：</p>
<p>1、这个是 <code>Print</code> 函数开始快速检查字符串为0的代码</p>
<div class="highlight"><pre><span></span><code><span class="na">.globl</span><span class="w"> </span><span class="no">Print</span>
<span class="nl">Print:</span>
<span class="nf">teq</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span>
<span class="nf">moveq</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">lr</span>
</code></pre></div>

<p>2、这里我做了很多配置。 <code>bufferStart</code> 代表 <code>terminalStart</code>， <code>bufferStop</code> 代表<code>terminalStop</code>， <code>view</code> 代表 <code>terminalView</code>，<code>taddr</code> 代表 <code>terminalBuffer</code> 的末尾地址。</p>
<div class="highlight"><pre><span></span><code><span class="n">push</span><span class="w"> </span><span class="err">{</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">,</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">,</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">,</span><span class="n">r10</span><span class="p">,</span><span class="n">r11</span><span class="p">,</span><span class="n">lr</span><span class="err">}</span>
<span class="n">bufferStart</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r4</span>
<span class="n">taddr</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r5</span>
<span class="n">x</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r6</span>
<span class="n">string</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r7</span>
<span class="n">length</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r8</span>
<span class="nc">char</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r9</span>
<span class="n">bufferStop</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r10</span>
<span class="k">view</span><span class="w"> </span><span class="p">.</span><span class="n">req</span><span class="w"> </span><span class="n">r11</span>

<span class="n">mov</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="n">r0</span>
<span class="n">mov</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="n">r1</span>

<span class="n">ldr</span><span class="w"> </span><span class="n">taddr</span><span class="p">,</span><span class="o">=</span><span class="n">terminalStart</span>
<span class="n">ldr</span><span class="w"> </span><span class="n">bufferStop</span><span class="p">,</span><span class="o">[</span><span class="n">taddr,#terminalStop-terminalStart</span><span class="o">]</span>
<span class="n">ldr</span><span class="w"> </span><span class="k">view</span><span class="p">,</span><span class="o">[</span><span class="n">taddr,#terminalView-terminalStart</span><span class="o">]</span>
<span class="n">ldr</span><span class="w"> </span><span class="n">bufferStart</span><span class="p">,</span><span class="o">[</span><span class="n">taddr</span><span class="o">]</span>
<span class="k">add</span><span class="w"> </span><span class="n">taddr</span><span class="p">,</span><span class="n">#terminalBuffer</span><span class="o">-</span><span class="n">terminalStart</span>
<span class="k">add</span><span class="w"> </span><span class="n">taddr</span><span class="p">,</span><span class="n">#128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
</code></pre></div>

<p>3、和通常一样，巧妙的对齐技巧让许多事情更容易。由于需要对齐 <code>terminalBuffer</code>，每个字符的 x 坐标需要 8 位要除以 2。</p>
<div class="highlight"><pre><span></span><code>and x,bufferStop,#0xfe
lsr x,#1
</code></pre></div>

<p>4.1、我们需要检查新行</p>
<div class="highlight"><pre><span></span><code><span class="n">charLoop</span><span class="err">$:</span>
<span class="n">ldrb</span><span class="w"> </span><span class="nc">char</span><span class="p">,</span><span class="o">[</span><span class="n">string</span><span class="o">]</span>
<span class="ow">and</span><span class="w"> </span><span class="nc">char</span><span class="p">,</span><span class="n">#0x7f</span>
<span class="n">teq</span><span class="w"> </span><span class="nc">char</span><span class="p">,</span><span class="err">#</span><span class="s1">&#39;\n&#39;</span>
<span class="n">bne</span><span class="w"> </span><span class="n">charNormal</span><span class="err">$</span>
</code></pre></div>

<p>4.2、循环执行值到行末写入 0x7f；黑色删除字符</p>
<div class="highlight"><pre><span></span><code><span class="n">mov</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="n">#0x7f</span>
<span class="n">clearLine</span><span class="err">$:</span>
<span class="n">strh</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="o">[</span><span class="n">bufferStop</span><span class="o">]</span>
<span class="k">add</span><span class="w"> </span><span class="n">bufferStop</span><span class="p">,</span><span class="n">#2</span>
<span class="k">add</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">#1</span>
<span class="n">teq</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">#128</span><span class="w"> </span><span class="n">blt</span><span class="w"> </span><span class="n">clearLine</span><span class="err">$</span>

<span class="n">b</span><span class="w"> </span><span class="n">charLoopContinue</span><span class="err">$</span>
</code></pre></div>

<p>4.3、存储字符串的当前字符和 <code>terminalBuffer</code> 末尾的 <code>terminalColour</code> 然后将它和 x 变量自增</p>
<div class="highlight"><pre><span></span><code><span class="n">charNormal</span><span class="err">$:</span>
<span class="n">strb</span><span class="w"> </span><span class="nc">char</span><span class="p">,</span><span class="o">[</span><span class="n">bufferStop</span><span class="o">]</span>
<span class="n">ldr</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="o">=</span><span class="n">terminalColour</span>
<span class="n">ldrb</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="o">[</span><span class="n">r0</span><span class="o">]</span>
<span class="n">strb</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="o">[</span><span class="n">bufferStop,#1</span><span class="o">]</span>
<span class="k">add</span><span class="w"> </span><span class="n">bufferStop</span><span class="p">,</span><span class="n">#2</span>
<span class="k">add</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">#1</span>
</code></pre></div>

<p>4.4、检查 x 是否为行末；128</p>
<div class="highlight"><pre><span></span><code><span class="nv">charLoopContinue</span><span class="p">$</span><span class="o">:</span>
<span class="nv">cmp</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span><span class="o">#</span><span class="mi">128</span>
<span class="nv">blt</span><span class="w"> </span><span class="nv">noScroll</span><span class="p">$</span>
</code></pre></div>

<p>4.5、设置 x 为 0 然后检查我们是否已经显示超过 1 屏。请记住，我们是用的循环缓冲区，因此如果 <code>bufferStop</code> 和 <code>view</code> 之前的差是负值，我们实际上是环绕了缓冲区。</p>
<div class="highlight"><pre><span></span><code>mov x,#0
subs r0,bufferStop,view
addlt r0,#128*128*2
cmp r0,#128*(768/16)*2
</code></pre></div>

<p>4.6、增加一行字节到 <code>view</code> 的地址</p>
<div class="highlight"><pre><span></span><code>addge view,#128*2
</code></pre></div>

<p>4.7、 如果 <code>view</code> 地址是缓冲区的末尾，我们就从它上面减去缓冲区的长度，让其指向开始位置。我会在开始的时候设置 <code>taddr</code> 为缓冲区的末尾地址。</p>
<div class="highlight"><pre><span></span><code><span class="nx">teq</span><span class="w"> </span><span class="nx">view</span><span class="p">,</span><span class="nx">taddr</span>
<span class="nx">subeq</span><span class="w"> </span><span class="nx">view</span><span class="p">,</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="mi">128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
</code></pre></div>

<p>4.8、如果 <code>stop</code> 的地址在缓冲区末尾，我们就从它上面减去缓冲区的长度，让其指向开始位置。我会在开始的时候设置 <code>taddr</code> 为缓冲区的末尾地址。</p>
<div class="highlight"><pre><span></span><code><span class="nx">noScroll</span><span class="err">$</span><span class="p">:</span>
<span class="nx">teq</span><span class="w"> </span><span class="nx">bufferStop</span><span class="p">,</span><span class="nx">taddr</span>
<span class="nx">subeq</span><span class="w"> </span><span class="nx">bufferStop</span><span class="p">,</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="mi">128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
</code></pre></div>

<p>4.9、检查 <code>bufferStop</code> 是否等于 <code>bufferStart</code>。 如果等于增加一行到 <code>bufferStart</code>。</p>
<div class="highlight"><pre><span></span><code>teq bufferStop,bufferStart
addeq bufferStart,#128*2
</code></pre></div>

<p>4.10、如果 <code>start</code> 的地址在缓冲区的末尾，我们就从它上面减去缓冲区的长度，让其指向开始位置。我会在开始的时候设置 <code>taddr</code> 为缓冲区的末尾地址。</p>
<div class="highlight"><pre><span></span><code><span class="nx">teq</span><span class="w"> </span><span class="nx">bufferStart</span><span class="p">,</span><span class="nx">taddr</span>
<span class="nx">subeq</span><span class="w"> </span><span class="nx">bufferStart</span><span class="p">,</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="mi">128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
</code></pre></div>

<p>循环执行知道字符串结束</p>
<div class="highlight"><pre><span></span><code><span class="nv">subs</span><span class="w"> </span><span class="nv">length</span><span class="p">,</span><span class="o">#</span><span class="mi">1</span>
<span class="nv">add</span><span class="w"> </span><span class="nv">string</span><span class="p">,</span><span class="o">#</span><span class="mi">1</span>
<span class="nv">bgt</span><span class="w"> </span><span class="nv">charLoop</span><span class="p">$</span>
</code></pre></div>

<p>5、保存变量然后返回</p>
<div class="highlight"><pre><span></span><code><span class="n">charLoopBreak</span><span class="err">$:</span>
<span class="n">sub</span><span class="w"> </span><span class="n">taddr</span><span class="p">,</span><span class="n">#128</span><span class="o">*</span><span class="mi">128</span><span class="o">*</span><span class="mi">2</span>
<span class="n">sub</span><span class="w"> </span><span class="n">taddr</span><span class="p">,</span><span class="n">#terminalBuffer</span><span class="o">-</span><span class="n">terminalStart</span>
<span class="nf">str</span><span class="w"> </span><span class="n">bufferStop</span><span class="p">,</span><span class="o">[</span><span class="n">taddr,#terminalStop-terminalStart</span><span class="o">]</span>
<span class="nf">str</span><span class="w"> </span><span class="k">view</span><span class="p">,</span><span class="o">[</span><span class="n">taddr,#terminalView-terminalStart</span><span class="o">]</span>
<span class="nf">str</span><span class="w"> </span><span class="n">bufferStart</span><span class="p">,</span><span class="o">[</span><span class="n">taddr</span><span class="o">]</span>

<span class="n">pop</span><span class="w"> </span><span class="err">{</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">,</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">,</span><span class="n">r8</span><span class="p">,</span><span class="n">r9</span><span class="p">,</span><span class="n">r10</span><span class="p">,</span><span class="n">r11</span><span class="p">,</span><span class="n">pc</span><span class="err">}</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="n">bufferStart</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="n">taddr</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="n">x</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="n">string</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="n">length</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="nc">char</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="n">bufferStop</span>
<span class="p">.</span><span class="n">unreq</span><span class="w"> </span><span class="k">view</span>
</code></pre></div>

<p>这个方法允许我们打印任意字符到屏幕。然而我们用了颜色变量，但实际上没有设置它。一般终端用特性的组合字符去行修改颜色。如 ASCII 转义（1b<sub> 16</sub>）后面跟着一个 0 - f 的 16 进制的数，就可以设置前景色为 CGA 颜色号。如果你自己想尝试实现；在下载页面有一个我的详细的例子。</p>
<h3>4、标志输入</h3>
<p>现在我们有一个可以打印和显示文本的输出终端。这仅仅是说对了一半，我们需要输入。我们想实现一个方法：<code>ReadLine</code>，可以保存文件的一行文本，文本位置由 <code>r0</code> 给出，最大的长度由 <code>r1</code> 给出，返回 <code>r0</code> 里面的字符串长度。棘手的是用户输出字符的时候要回显功能，同时想要退格键的删除功能和命令回车执行功能。它们还需要一个闪烁的下划线代表计算机需要输入。这些完全合理的要求让构造这个方法更具有挑战性。有一个方法完成这些需求就是存储用户输入的文本和文件大小到内存的某个地方。然后当调用 <code>ReadLine</code> 的时候，移动 <code>terminalStop</code> 的地址到它开始的地方然后调用 <code>Print</code>。也就是说我们只需要确保在内存维护一个字符串，然后构造一个我们自己的打印函数。</p>
<blockquote>
<p>按照惯例，许多编程语言中，任意程序可以访问 stdin 和 stdin，它们可以连接到终端的输入和输出流。在图形程序其实也可以进行同样操作，但实际几乎不用。</p>
</blockquote>
<p>让我们看看 <code>ReadLine</code> 做了哪些事情：</p>
<ol>
<li>如果字符串可保存的最大长度为 0，直接返回</li>
<li>检索 <code>terminalStop</code> 和 <code>terminalStop</code> 的当前值</li>
<li>如果字符串的最大长度大约缓冲区的一半，就设置大小为缓冲区的一半</li>
<li>从最大长度里面减去 1 来确保输入的闪烁字符或结束符</li>
<li>向字符串写入一个下划线</li>
<li>写入一个 <code>terminalView</code> 和 <code>terminalStop</code> 的地址到内存</li>
<li>调用 <code>Print</code> 打印当前字符串</li>
<li>调用 <code>TerminalDisplay</code></li>
<li>调用 <code>KeyboardUpdate</code></li>
<li>调用 <code>KeyboardGetChar</code></li>
<li>如果是一个新行直接跳转到第 16 步</li>
<li>如果是一个退格键，将字符串长度减 1（如果其大于 0）</li>
<li>如果是一个普通字符，将它写入字符串（字符串大小确保小于最大值）</li>
<li>如果字符串是以下划线结束，写入一个空格，否则写入下划线</li>
<li>跳转到第 6 步</li>
<li>字符串的末尾写入一个新行字符</li>
<li>调用 <code>Print</code> 和 <code>TerminalDisplay</code></li>
<li>用结束符替换新行</li>
<li>返回字符串的长度</li>
</ol>
<p>为了方便读者理解，然后然后自己去实现，我们的实现提供如下：</p>
<ol>
<li>快速处理长度为 0 的情况</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="na">.globl</span><span class="w"> </span><span class="no">ReadLine</span>
<span class="nl">ReadLine:</span>
<span class="nf">teq</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span>
<span class="nf">moveq</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span>
<span class="nf">moveq</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">lr</span>
</code></pre></div>

<p>2、考虑到常见的场景，我们初期做了很多初始化动作。<code>input</code> 代表 <code>terminalStop</code> 的值，<code>view</code> 代表 <code>terminalView</code>。<code>Length</code> 默认为 <code>0</code>。</p>
<div class="highlight"><pre><span></span><code><span class="kt">string</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r4</span>
<span class="nx">maxLength</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r5</span>
<span class="nx">input</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r6</span>
<span class="nx">taddr</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r7</span>
<span class="nx">length</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r8</span>
<span class="nx">view</span><span class="w"> </span><span class="p">.</span><span class="nx">req</span><span class="w"> </span><span class="nx">r9</span>

<span class="nx">push</span><span class="w"> </span><span class="p">{</span><span class="nx">r4</span><span class="p">,</span><span class="nx">r5</span><span class="p">,</span><span class="nx">r6</span><span class="p">,</span><span class="nx">r7</span><span class="p">,</span><span class="nx">r8</span><span class="p">,</span><span class="nx">r9</span><span class="p">,</span><span class="nx">lr</span><span class="p">}</span>

<span class="nx">mov</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="nx">r0</span>
<span class="nx">mov</span><span class="w"> </span><span class="nx">maxLength</span><span class="p">,</span><span class="nx">r1</span>
<span class="nx">ldr</span><span class="w"> </span><span class="nx">taddr</span><span class="p">,=</span><span class="nx">terminalStart</span>
<span class="nx">ldr</span><span class="w"> </span><span class="nx">input</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalStop</span><span class="o">-</span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">ldr</span><span class="w"> </span><span class="nx">view</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalView</span><span class="o">-</span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">mov</span><span class="w"> </span><span class="nx">length</span><span class="p">,</span><span class="err">#</span><span class="mi">0</span>
</code></pre></div>

<p>3、我们必须检查异常大的读操作，我们不能处理超过 <code>terminalBuffer</code> 大小的输入（理论上可行，但是 <code>terminalStart</code> 移动越过存储的 terminalStop`，会有很多问题）。</p>
<div class="highlight"><pre><span></span><code>cmp maxLength,#128*64
movhi maxLength,#128*64
</code></pre></div>

<p>4、由于用户需要一个闪烁的光标，我们需要一个备用字符在理想状况在这个字符串后面放一个结束符。</p>
<div class="highlight"><pre><span></span><code>sub maxLength,#1
</code></pre></div>

<p>5、写入一个下划线让用户知道我们可以输入了。</p>
<div class="highlight"><pre><span></span><code>mov r0,#&#39;_&#39;
strb r0,[string,length]
</code></pre></div>

<p>6、保存 <code>terminalStop</code> 和 <code>terminalView</code>。这个对重置一个终端很重要，它会修改这些变量。严格讲也可以修改 <code>terminalStart</code>，但是不可逆。</p>
<div class="highlight"><pre><span></span><code><span class="nx">readLoop</span><span class="err">$</span><span class="p">:</span>
<span class="nx">str</span><span class="w"> </span><span class="nx">input</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalStop</span><span class="o">-</span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">str</span><span class="w"> </span><span class="nx">view</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalView</span><span class="o">-</span><span class="nx">terminalStart</span><span class="p">]</span>
</code></pre></div>

<p>7、写入当前的输入。由于下划线因此字符串长度加 1</p>
<div class="highlight"><pre><span></span><code>mov r0,string
mov r1,length
add r1,#1
bl Print
</code></pre></div>

<p>8、拷贝下一个文本到屏幕</p>
<div class="highlight"><pre><span></span><code>bl TerminalDisplay
</code></pre></div>

<p>9、获取最近一次键盘输入</p>
<div class="highlight"><pre><span></span><code>bl KeyboardUpdate
</code></pre></div>

<p>10、检索键盘输入键值</p>
<div class="highlight"><pre><span></span><code>bl KeyboardGetChar
</code></pre></div>

<p>11、如果我们有一个回车键，循环中断。如果有结束符和一个退格键也会同样跳出循环。</p>
<div class="highlight"><pre><span></span><code><span class="nv">teq</span><span class="w"> </span><span class="nv">r0</span><span class="p">,</span><span class="o">#&#39;</span>\<span class="nv">n</span><span class="o">&#39;</span>
<span class="nv">beq</span><span class="w"> </span><span class="nv">readLoopBreak</span><span class="p">$</span>
<span class="nv">teq</span><span class="w"> </span><span class="nv">r0</span><span class="p">,</span><span class="o">#</span><span class="mi">0</span>
<span class="nv">beq</span><span class="w"> </span><span class="nv">cursor</span><span class="p">$</span>
<span class="nv">teq</span><span class="w"> </span><span class="nv">r0</span><span class="p">,</span><span class="o">#&#39;</span>\<span class="nv">b</span><span class="o">&#39;</span>
<span class="nv">bne</span><span class="w"> </span><span class="nv">standard</span><span class="p">$</span>
</code></pre></div>

<p>12、从 <code>length</code> 里面删除一个字符</p>
<div class="highlight"><pre><span></span><code><span class="nv">delete</span><span class="p">$</span><span class="o">:</span>
<span class="nv">cmp</span><span class="w"> </span><span class="nv">length</span><span class="p">,</span><span class="o">#</span><span class="mi">0</span>
<span class="nv">subgt</span><span class="w"> </span><span class="nv">length</span><span class="p">,</span><span class="o">#</span><span class="mi">1</span>
<span class="nv">b</span><span class="w"> </span><span class="nv">cursor</span><span class="p">$</span>
</code></pre></div>

<p>13、写回一个普通字符</p>
<div class="highlight"><pre><span></span><code><span class="nv">standard</span><span class="p">$</span><span class="o">:</span>
<span class="nv">cmp</span><span class="w"> </span><span class="nv">length</span><span class="p">,</span><span class="nv">maxLength</span>
<span class="nv">bge</span><span class="w"> </span><span class="nv">cursor</span><span class="p">$</span>
<span class="nv">strb</span><span class="w"> </span><span class="nv">r0</span><span class="p">,[</span><span class="nv">string</span><span class="p">,</span><span class="nv">length</span><span class="p">]</span>
<span class="nv">add</span><span class="w"> </span><span class="nv">length</span><span class="p">,</span><span class="o">#</span><span class="mi">1</span>
</code></pre></div>

<p>14、加载最近的一个字符，如果不是下划线则修改为下换线，如果是则修改为空格</p>
<div class="highlight"><pre><span></span><code>cursor$:
ldrb r0,[string,length]
teq r0,#&#39;_&#39;
moveq r0,#&#39; &#39;
movne r0,#&#39;_&#39;
strb r0,[string,length]
</code></pre></div>

<p>15、循环执行值到用户输入按下</p>
<div class="highlight"><pre><span></span><code><span class="nv">b</span><span class="w"> </span><span class="nv">readLoop</span><span class="p">$</span>
<span class="nv">readLoopBreak</span><span class="p">$</span><span class="o">:</span>
</code></pre></div>

<p>16、在字符串的结尾处存入一个新行字符</p>
<div class="highlight"><pre><span></span><code>mov r0,#&#39;\n&#39;
strb r0,[string,length]
</code></pre></div>

<p>17、重置 <code>terminalView</code> 和 <code>terminalStop</code> 然后调用 <code>Print</code> 和 <code>TerminalDisplay</code> 显示最终的输入</p>
<div class="highlight"><pre><span></span><code><span class="nx">str</span><span class="w"> </span><span class="nx">input</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalStop</span><span class="o">-</span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">str</span><span class="w"> </span><span class="nx">view</span><span class="p">,[</span><span class="nx">taddr</span><span class="p">,</span><span class="err">#</span><span class="nx">terminalView</span><span class="o">-</span><span class="nx">terminalStart</span><span class="p">]</span>
<span class="nx">mov</span><span class="w"> </span><span class="nx">r0</span><span class="p">,</span><span class="kt">string</span>
<span class="nx">mov</span><span class="w"> </span><span class="nx">r1</span><span class="p">,</span><span class="nx">length</span>
<span class="nx">add</span><span class="w"> </span><span class="nx">r1</span><span class="p">,</span><span class="err">#</span><span class="mi">1</span>
<span class="nx">bl</span><span class="w"> </span><span class="nx">Print</span>
<span class="nx">bl</span><span class="w"> </span><span class="nx">TerminalDisplay</span>
</code></pre></div>

<p>18、写入一个结束符</p>
<div class="highlight"><pre><span></span><code>mov r0,#0
strb r0,[string,length]
</code></pre></div>

<p>19、返回长度</p>
<div class="highlight"><pre><span></span><code><span class="nx">mov</span><span class="w"> </span><span class="nx">r0</span><span class="p">,</span><span class="nx">length</span>
<span class="nx">pop</span><span class="w"> </span><span class="p">{</span><span class="nx">r4</span><span class="p">,</span><span class="nx">r5</span><span class="p">,</span><span class="nx">r6</span><span class="p">,</span><span class="nx">r7</span><span class="p">,</span><span class="nx">r8</span><span class="p">,</span><span class="nx">r9</span><span class="p">,</span><span class="nx">pc</span><span class="p">}</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="kt">string</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">maxLength</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">input</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">taddr</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">length</span>
<span class="p">.</span><span class="nx">unreq</span><span class="w"> </span><span class="nx">view</span>
</code></pre></div>

<h3>5、终端：机器进化</h3>
<p>现在我们理论用终端和用户可以交互了。最显而易见的事情就是拿去测试了！删除 <code>main.s</code> 里 <code>bl UsbInitialise</code> 后面的代码后如下：</p>
<div class="highlight"><pre><span></span><code><span class="nl">reset$:</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="mi">#0</span><span class="no">x8000</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">TerminalClear</span>

<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="err">=</span><span class="no">welcome</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="c1">#welcomeEnd-welcome</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">Print</span>

<span class="nl">loop$:</span>
<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="err">=</span><span class="no">prompt</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="c1">#promptEnd-prompt</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">Print</span>

<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="err">=</span><span class="no">command</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="c1">#commandEnd-command</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">ReadLine</span>

<span class="w">  </span><span class="nf">teq</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span>
<span class="w">  </span><span class="nf">beq</span><span class="w"> </span><span class="no">loopContinue$</span>

<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">r4</span><span class="p">,</span><span class="no">r0</span>

<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r5</span><span class="p">,</span><span class="err">=</span><span class="no">command</span>
<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r6</span><span class="p">,</span><span class="err">=</span><span class="no">commandTable</span>

<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r7</span><span class="p">,[</span><span class="no">r6</span><span class="p">,</span><span class="mi">#0</span><span class="p">]</span>
<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r9</span><span class="p">,[</span><span class="no">r6</span><span class="p">,</span><span class="mi">#4</span><span class="p">]</span>
<span class="w">  </span><span class="nl">commandLoop$:</span>
<span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r8</span><span class="p">,[</span><span class="no">r6</span><span class="p">,</span><span class="mi">#8</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="no">r8</span><span class="p">,</span><span class="no">r7</span>

<span class="w">    </span><span class="nf">cmp</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="no">r4</span>
<span class="w">    </span><span class="nf">bgt</span><span class="w"> </span><span class="no">commandLoopContinue$</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#0</span>
<span class="w">    </span><span class="nl">commandName$:</span>
<span class="w">      </span><span class="nf">ldrb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r5</span><span class="p">,</span><span class="no">r0</span><span class="p">]</span>
<span class="w">      </span><span class="nf">ldrb</span><span class="w"> </span><span class="no">r3</span><span class="p">,[</span><span class="no">r7</span><span class="p">,</span><span class="no">r0</span><span class="p">]</span>
<span class="w">      </span><span class="nf">teq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="no">r3</span>
<span class="w">      </span><span class="nf">bne</span><span class="w"> </span><span class="no">commandLoopContinue$</span>
<span class="w">      </span><span class="nf">add</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#1</span>
<span class="w">      </span><span class="nf">teq</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="no">r1</span>
<span class="w">      </span><span class="nf">bne</span><span class="w"> </span><span class="no">commandName$</span>

<span class="w">    </span><span class="nf">ldrb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r5</span><span class="p">,</span><span class="no">r0</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="mi">#0</span>
<span class="w">    </span><span class="nf">teqne</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="c1">#&#39; &#39;</span>
<span class="w">    </span><span class="nf">bne</span><span class="w"> </span><span class="no">commandLoopContinue$</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="no">r5</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="no">r4</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">lr</span><span class="p">,</span><span class="no">pc</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">r9</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">loopContinue$</span>

<span class="w">  </span><span class="nl">commandLoopContinue$:</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">r6</span><span class="p">,</span><span class="mi">#8</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r7</span><span class="p">,</span><span class="no">r8</span>
<span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r9</span><span class="p">,[</span><span class="no">r6</span><span class="p">,</span><span class="mi">#4</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teq</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="mi">#0</span>
<span class="w">    </span><span class="nf">bne</span><span class="w"> </span><span class="no">commandLoop$</span>

<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="err">=</span><span class="no">commandUnknown</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="c1">#commandUnknownEnd-commandUnknown</span>
<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="err">=</span><span class="no">formatBuffer</span>
<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r3</span><span class="p">,</span><span class="err">=</span><span class="no">command</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">FormatString</span>

<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="no">r0</span>
<span class="w">  </span><span class="nf">ldr</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="err">=</span><span class="no">formatBuffer</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">Print</span>

<span class="nl">loopContinue$:</span>
<span class="w">  </span><span class="nf">bl</span><span class="w"> </span><span class="no">TerminalDisplay</span>
<span class="w">  </span><span class="nf">b</span><span class="w"> </span><span class="no">loop$</span>

<span class="nl">echo:</span>
<span class="w">  </span><span class="nf">cmp</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#5</span>
<span class="w">  </span><span class="nf">movle</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">lr</span>

<span class="w">  </span><span class="nf">add</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#5</span>
<span class="w">  </span><span class="nf">sub</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#5</span>
<span class="w">  </span><span class="nf">b</span><span class="w"> </span><span class="no">Print</span>

<span class="nl">ok:</span>
<span class="w">  </span><span class="nf">teq</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#5</span>
<span class="w">  </span><span class="nf">beq</span><span class="w"> </span><span class="no">okOn$</span>
<span class="w">  </span><span class="nf">teq</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#6</span>
<span class="w">  </span><span class="nf">beq</span><span class="w"> </span><span class="no">okOff$</span>
<span class="w">  </span><span class="nf">mov</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">lr</span>

<span class="w">  </span><span class="nl">okOn$:</span>
<span class="w">    </span><span class="nf">ldrb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r0</span><span class="p">,</span><span class="mi">#3</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="c1">#&#39;o&#39;</span>
<span class="w">    </span><span class="nf">ldreqb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r0</span><span class="p">,</span><span class="mi">#4</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teqeq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="c1">#&#39;n&#39;</span>
<span class="w">    </span><span class="nf">movne</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">lr</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#0</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">okAct$</span>

<span class="w">  </span><span class="nl">okOff$:</span>
<span class="w">    </span><span class="nf">ldrb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r0</span><span class="p">,</span><span class="mi">#3</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="c1">#&#39;o&#39;</span>
<span class="w">    </span><span class="nf">ldreqb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r0</span><span class="p">,</span><span class="mi">#4</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teqeq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="c1">#&#39;f&#39;</span>
<span class="w">    </span><span class="nf">ldreqb</span><span class="w"> </span><span class="no">r2</span><span class="p">,[</span><span class="no">r0</span><span class="p">,</span><span class="mi">#5</span><span class="p">]</span>
<span class="w">    </span><span class="nf">teqeq</span><span class="w"> </span><span class="no">r2</span><span class="p">,</span><span class="c1">#&#39;f&#39;</span>
<span class="w">    </span><span class="nf">movne</span><span class="w"> </span><span class="no">pc</span><span class="p">,</span><span class="no">lr</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r1</span><span class="p">,</span><span class="mi">#1</span>

<span class="w">  </span><span class="nl">okAct$:</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r0</span><span class="p">,</span><span class="mi">#16</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">SetGpio</span>

<span class="na">.section</span><span class="w"> </span><span class="no">.data</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">welcome:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;Welcome to Alex&#39;s OS - Everyone&#39;s favourite OS&quot;</span>
<span class="nl">welcomeEnd:</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">prompt:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;\n&gt; &quot;</span>
<span class="nl">promptEnd:</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">command:</span>
<span class="w">  </span><span class="na">.rept</span><span class="w"> </span><span class="mi">128</span>
<span class="w">    </span><span class="na">.byte</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="na">.endr</span>
<span class="nl">commandEnd:</span>
<span class="na">.byte</span><span class="w"> </span><span class="mi">0</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">commandUnknown:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;Command `%s&#39; was not recognised.\n&quot;</span>
<span class="nl">commandUnknownEnd:</span>
<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">formatBuffer:</span>
<span class="w">  </span><span class="na">.rept</span><span class="w"> </span><span class="mi">256</span>
<span class="w">    </span><span class="na">.byte</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="na">.endr</span>
<span class="nl">formatEnd:</span>

<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">commandStringEcho:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;echo&quot;</span>
<span class="nl">commandStringReset:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;reset&quot;</span>
<span class="nl">commandStringOk:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;ok&quot;</span>
<span class="nl">commandStringCls:</span><span class="w"> </span><span class="na">.ascii</span><span class="w"> </span><span class="s">&quot;cls&quot;</span>
<span class="nl">commandStringEnd:</span>

<span class="na">.align</span><span class="w"> </span><span class="mi">2</span>
<span class="nl">commandTable:</span>
<span class="na">.int</span><span class="w"> </span><span class="no">commandStringEcho</span><span class="p">,</span><span class="w"> </span><span class="no">echo</span>
<span class="na">.int</span><span class="w"> </span><span class="no">commandStringReset</span><span class="p">,</span><span class="w"> </span><span class="no">reset$</span>
<span class="na">.int</span><span class="w"> </span><span class="no">commandStringOk</span><span class="p">,</span><span class="w"> </span><span class="no">ok</span>
<span class="na">.int</span><span class="w"> </span><span class="no">commandStringCls</span><span class="p">,</span><span class="w"> </span><span class="no">TerminalClear</span>
<span class="na">.int</span><span class="w"> </span><span class="no">commandStringEnd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>这块代码集成了一个简易的命令行操作系统。支持命令：<code>echo</code>、<code>reset</code>、<code>ok</code> 和 <code>cls</code>。<code>echo</code> 拷贝任意文本到终端，<code>reset</code> 命令会在系统出现问题的是复位操作系统，<code>ok</code> 有两个功能：设置 OK 灯亮灭，最后 <code>cls</code> 调用 TerminalClear 清空终端。</p>
<p>试试树莓派的代码吧。如果遇到问题，请参照问题集锦页面吧。</p>
<p>如果运行正常，祝贺你完成了一个操作系统基本终端和输入系列的课程。很遗憾这个教程先讲到这里，但是我希望将来能制作更多教程。有问题请反馈至 <a href="mailto:awc32@cam.ac.uk">awc32@cam.ac.uk</a>。</p>
<p>你已经在建立了一个简易的终端操作系统。我们的代码在 commandTable 构造了一个可用的命令表格。每个表格的入口是一个整型数字，用来表示字符串的地址，和一个整型数字表格代码的执行入口。 最后一个入口是 为 0 的 <code>commandStringEnd</code>。尝试实现你自己的命令，可以参照已有的函数，建立一个新的。函数的参数 <code>r0</code> 是用户输入的命令地址，<code>r1</code> 是其长度。你可以用这个传递你输入值到你的命令。也许你有一个计算器程序，或许是一个绘图程序或国际象棋。不管你的什么点子，让它跑起来！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>