<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>在 Linux 上记录和重放终端会话活动</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Pradeep Kumar 通常，Linux 管理员们都使用 history 命令来跟踪在先前的会话中执行过哪些命令，但是 history 命令的局限性在于它不存储命令 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2019/10/zai-linux-shang-ji-lu-he-zhong-fang-zhong-duan-hui-hua-huo-dong.html" rel="bookmark"
           title="Permalink to 在 Linux 上记录和重放终端会话活动">在 Linux 上记录和重放终端会话活动</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-10-06T12:27:00+02:00">
                Published: Sun 06 October 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Pradeep Kumar</p>
<p>通常，Linux 管理员们都使用 <code>history</code> 命令来跟踪在先前的会话中执行过哪些命令，但是 <code>history</code> 命令的局限性在于它不存储命令的输出。在某些情况下，我们要检查上一个会话的命令输出，并希望将其与当前会话进行比较。除此之外，在某些情况下，我们正在对 Linux 生产环境中的问题进行故障排除，并希望保存所有终端会话活动以供将来参考，因此在这种情况下，<code>script</code> 命令就变得很方便。</p>
<p><img alt="" src="/data/attachment/album/201910/06/122659mmi64z8ryr4z2n8a.jpg"></p>
<p><code>script</code> 是一个命令行工具，用于捕获/记录你的 Linux 服务器终端会话活动，以后可以使用 <code>scriptreplay</code> 命令重放记录的会话。在本文中，我们将演示如何安装 <code>script</code> 命令行工具以及如何记录 Linux 服务器终端会话活动，然后，我们将看到如何使用 <code>scriptreplay</code> 命令来重放记录的会话。</p>
<h3>安装 script 工具</h3>
<h4>在 RHEL 7/ CentOS 7 上安装 script 工具</h4>
<p><code>script</code> 命令由 RPM 包 <code>util-linux</code> 提供，如果你没有在你的 CentOS 7 / RHEL 7 系统上安装它，运行下面的 <code>yum</code> 安装它：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">util</span><span class="o">-</span><span class="n">linux</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<h4>在 RHEL 8 / CentOS 8 上安装 script 工具</h4>
<p>运行下面的 <code>dnf</code> 命令来在 RHEL 8 / CentOS 8 上安装 <code>script</code> 工具：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">dnf</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">util</span><span class="o">-</span><span class="n">linux</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<h4>在基于 Debian 的系统（Ubuntu / Linux Mint）上安装 script 工具</h4>
<p>运行下面的 <code>apt-get</code> 命令来安装 <code>script</code> 工具：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="err">]#</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="k">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">util</span><span class="o">-</span><span class="n">linux</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div>

<h3>如何使用 script 工具</h3>
<p>直接使用 <code>script</code> 命令，在终端上键入 <code>script</code> 命令，然后按回车，它将开始在名为 <code>typescript</code> 的文件中捕获当前的终端会话活动。</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">script</span>
<span class="nx">Script</span><span class="w"> </span><span class="nx">started</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">typescript</span>
<span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<p>要停止记录会话活动，请键入 <code>exit</code> 命令，然后按回车：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">exit</span>
<span class="nx">exit</span>
<span class="nx">Script</span><span class="w"> </span><span class="nx">done</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">typescript</span>
<span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<p><code>script</code> 命令的语法格式：</p>
<div class="highlight"><pre><span></span><code>~] # script {options}  {file_name}
</code></pre></div>

<p>能在 <code>script</code> 命令中使用的不同选项：</p>
<p><img alt="options-script-command" src="/data/attachment/album/201910/06/122713o4vvjz6xmxljc4vd.png"></p>
<p>让我们开始通过执行 <code>script</code> 命令来记录 Linux 终端会话，然后执行诸如 <code>w</code>，<code>route -n</code>，<code>df -h</code> 和 <code>free -h</code>，示例如下所示：</p>
<p><img alt="script-examples-linux-server" src="/data/attachment/album/201910/06/122715ud9bxq9ovq2b0dqa.jpg"></p>
<p>正如我们在上面看到的，终端会话日志保存在文件 <code>typescript</code> 中：</p>
<p>现在使用 <code>cat</code> / <code>vi</code> 命令查看 <code>typescript</code> 文件的内容，</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">ls</span><span class="w"> </span><span class="o">-</span><span class="nx">l</span><span class="w"> </span><span class="nx">typescript</span>
<span class="o">-</span><span class="nx">rw</span><span class="o">-</span><span class="nx">r</span><span class="o">--</span><span class="nx">r</span><span class="o">--</span><span class="p">.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="mi">1861</span><span class="w"> </span><span class="nx">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">50</span><span class="w"> </span><span class="nx">typescript</span>
<span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<p><img alt="typescript-file-content-linux" src="/data/attachment/album/201910/06/122716y7f166757hfl56fs.jpg"></p>
<p>以上内容确认了我们在终端上执行的所有命令都已保存在 <code>typescript</code> 文件中。</p>
<h3>在 script 命令中使用定制文件名</h3>
<p>假设我们要使用自定义文件名来执行 <code>script</code> 命令，可以在 <code>script</code> 命令后指定文件名。在下面的示例中，我们使用的文件名为 <code>session-log-(当前日期时间).txt</code>。</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">sessions</span><span class="o">-</span><span class="nf">log</span><span class="o">-</span><span class="err">$</span><span class="p">(</span><span class="nc">date</span><span class="w"> </span><span class="o">+%</span><span class="n">d</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">Y</span><span class="o">-%</span><span class="n">T</span><span class="p">).</span><span class="n">txt</span>
<span class="n">Script</span><span class="w"> </span><span class="n">started</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">sessions</span><span class="o">-</span><span class="nf">log</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">01</span><span class="err">:</span><span class="mi">37</span><span class="err">:</span><span class="mf">39.</span><span class="n">txt</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<p>现在运行该命令并输入 <code>exit</code>：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">exit</span>
<span class="k">exit</span>
<span class="n">Script</span><span class="w"> </span><span class="n">done</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">sessions</span><span class="o">-</span><span class="nf">log</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">01</span><span class="err">:</span><span class="mi">37</span><span class="err">:</span><span class="mf">39.</span><span class="n">txt</span>
<span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span>
</code></pre></div>

<h3>附加命令输出到 script 记录文件</h3>
<p>假设 <code>script</code> 命令已经将命令输出记录到名为 <code>session-log.txt</code> 的文件中，现在我们想将新会话命令的输出附加到该文件中，那么可以在 <code>script</code> 命令中使用 <code>-a</code> 选项。</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">script</span><span class="w"> </span><span class="o">-</span><span class="nx">a</span><span class="w"> </span><span class="nx">sessions</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">txt</span>
<span class="nx">Script</span><span class="w"> </span><span class="nx">started</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">sessions</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">txt</span>
<span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">xfs_info</span><span class="w"> </span><span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">mapper</span><span class="o">/</span><span class="nx">centos</span><span class="o">-</span><span class="nx">root</span>
<span class="nx">meta</span><span class="o">-</span><span class="nx">data</span><span class="p">=</span><span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">mapper</span><span class="o">/</span><span class="nx">centos</span><span class="o">-</span><span class="nx">root</span><span class="w"> </span><span class="nx">isize</span><span class="p">=</span><span class="mi">512</span><span class="w">    </span><span class="nx">agcount</span><span class="p">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nx">agsize</span><span class="p">=</span><span class="mi">2746624</span><span class="w"> </span><span class="nx">blks</span>
<span class="w">         </span><span class="p">=</span><span class="w">                       </span><span class="nx">sectsz</span><span class="p">=</span><span class="mi">512</span><span class="w">   </span><span class="nx">attr</span><span class="p">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">projid32bit</span><span class="p">=</span><span class="mi">1</span>
<span class="w">         </span><span class="p">=</span><span class="w">                       </span><span class="nx">crc</span><span class="p">=</span><span class="mi">1</span><span class="w">        </span><span class="nx">finobt</span><span class="p">=</span><span class="mi">0</span><span class="w"> </span><span class="nx">spinodes</span><span class="p">=</span><span class="mi">0</span>
<span class="nx">data</span><span class="w">     </span><span class="p">=</span><span class="w">                       </span><span class="nx">bsize</span><span class="p">=</span><span class="mi">4096</span><span class="w">   </span><span class="nx">blocks</span><span class="p">=</span><span class="mi">10986496</span><span class="p">,</span><span class="w"> </span><span class="nx">imaxpct</span><span class="p">=</span><span class="mi">25</span>
<span class="w">         </span><span class="p">=</span><span class="w">                       </span><span class="nx">sunit</span><span class="p">=</span><span class="mi">0</span><span class="w">      </span><span class="nx">swidth</span><span class="p">=</span><span class="mi">0</span><span class="w"> </span><span class="nx">blks</span>
<span class="nx">naming</span><span class="w">   </span><span class="p">=</span><span class="nx">version</span><span class="w"> </span><span class="mi">2</span><span class="w">              </span><span class="nx">bsize</span><span class="p">=</span><span class="mi">4096</span><span class="w">   </span><span class="nx">ascii</span><span class="o">-</span><span class="nx">ci</span><span class="p">=</span><span class="mi">0</span><span class="w"> </span><span class="nx">ftype</span><span class="p">=</span><span class="mi">1</span>
<span class="nx">log</span><span class="w">      </span><span class="p">=</span><span class="nx">internal</span><span class="w">               </span><span class="nx">bsize</span><span class="p">=</span><span class="mi">4096</span><span class="w">   </span><span class="nx">blocks</span><span class="p">=</span><span class="mi">5364</span><span class="p">,</span><span class="w"> </span><span class="nx">version</span><span class="p">=</span><span class="mi">2</span>
<span class="w">         </span><span class="p">=</span><span class="w">                       </span><span class="nx">sectsz</span><span class="p">=</span><span class="mi">512</span><span class="w">   </span><span class="nx">sunit</span><span class="p">=</span><span class="mi">0</span><span class="w"> </span><span class="nx">blks</span><span class="p">,</span><span class="w"> </span><span class="nx">lazy</span><span class="o">-</span><span class="nx">count</span><span class="p">=</span><span class="mi">1</span>
<span class="nx">realtime</span><span class="w"> </span><span class="p">=</span><span class="nx">none</span><span class="w">                   </span><span class="nx">extsz</span><span class="p">=</span><span class="mi">4096</span><span class="w">   </span><span class="nx">blocks</span><span class="p">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">rtextents</span><span class="p">=</span><span class="mi">0</span>
<span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">exit</span>
<span class="nx">exit</span>
<span class="nx">Script</span><span class="w"> </span><span class="nx">done</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">sessions</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">txt</span>
<span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="err">#</span>
</code></pre></div>

<p>要查看更新的会话记录，使用 <code>cat session-log.txt</code> 命令。</p>
<h3>无需 shell 交互而捕获命令输出到 script 记录文件</h3>
<p>假设我们要捕获命令的输出到会话记录文件，那么使用 <code>-c</code> 选项，示例如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># script -c &quot;uptime &amp;&amp; hostname &amp;&amp; date&quot; root-session.txt</span>
<span class="n">Script</span><span class="w"> </span><span class="n">started</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">root</span><span class="o">-</span><span class="n">session</span><span class="o">.</span><span class="n">txt</span>
<span class="w"> </span><span class="mi">01</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">40</span><span class="w"> </span><span class="n">up</span><span class="w">  </span><span class="mi">2</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w">  </span><span class="nb">load</span><span class="w"> </span><span class="n">average</span><span class="p">:</span><span class="w"> </span><span class="mf">0.00</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span>
<span class="n">linuxtechi</span>
<span class="n">Fri</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">01</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">40</span><span class="w"> </span><span class="n">EDT</span><span class="w"> </span><span class="mi">2019</span>
<span class="n">Script</span><span class="w"> </span><span class="n">done</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">root</span><span class="o">-</span><span class="n">session</span><span class="o">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<h3>以静默模式运行 script 命令</h3>
<p>要以静默模式运行 <code>script</code> 命令，请使用 <code>-q</code> 选项，该选项将禁止 <code>script</code> 的启动和完成消息，示例如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># script -c &quot;uptime &amp;&amp; date&quot; -q root-session.txt</span>
<span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">10</span><span class="w"> </span><span class="n">up</span><span class="w">  </span><span class="mi">2</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w">  </span><span class="nb">load</span><span class="w"> </span><span class="n">average</span><span class="p">:</span><span class="w"> </span><span class="mf">0.00</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span>
<span class="n">Fri</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">10</span><span class="w"> </span><span class="n">EDT</span><span class="w"> </span><span class="mi">2019</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<p>要将时序信息记录到文件中并捕获命令输出到单独的文件中，这可以通过在 <code>script</code> 命令中传递时序文件（<code>-timing</code>）实现，示例如下所示：</p>
<p>语法格式：</p>
<div class="highlight"><pre><span></span><code>~ ]# script -t &lt;timing-file-name&gt;  {file_name}
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># script --timing=timing.txt session.log</span>
<span class="n">Script</span><span class="w"> </span><span class="n">started</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">session</span><span class="o">.</span><span class="n">log</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># uptime</span>
<span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">59</span><span class="w"> </span><span class="n">up</span><span class="w">  </span><span class="mi">3</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w">  </span><span class="nb">load</span><span class="w"> </span><span class="n">average</span><span class="p">:</span><span class="w"> </span><span class="mf">0.00</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># date</span>
<span class="n">Fri</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">02</span><span class="w"> </span><span class="n">EDT</span><span class="w"> </span><span class="mi">2019</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># free -h</span>
<span class="w">              </span><span class="n">total</span><span class="w">        </span><span class="n">used</span><span class="w">        </span><span class="n">free</span><span class="w">      </span><span class="n">shared</span><span class="w">  </span><span class="n">buff</span><span class="o">/</span><span class="n">cache</span><span class="w">   </span><span class="n">available</span>
<span class="n">Mem</span><span class="p">:</span><span class="w">           </span><span class="mf">3.9</span><span class="n">G</span><span class="w">        </span><span class="mi">171</span><span class="n">M</span><span class="w">        </span><span class="mf">2.0</span><span class="n">G</span><span class="w">        </span><span class="mf">8.6</span><span class="n">M</span><span class="w">        </span><span class="mf">1.7</span><span class="n">G</span><span class="w">        </span><span class="mf">3.3</span><span class="n">G</span>
<span class="n">Swap</span><span class="p">:</span><span class="w">          </span><span class="mf">3.9</span><span class="n">G</span><span class="w">          </span><span class="mi">0</span><span class="n">B</span><span class="w">        </span><span class="mf">3.9</span><span class="n">G</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># whoami</span>
<span class="n">root</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># exit</span>
<span class="n">exit</span>
<span class="n">Script</span><span class="w"> </span><span class="n">done</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">session</span><span class="o">.</span><span class="n">log</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># ls -l session.log timing.txt</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">673</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">28</span><span class="w"> </span><span class="n">session</span><span class="o">.</span><span class="n">log</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">414</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">02</span><span class="p">:</span><span class="mi">28</span><span class="w"> </span><span class="n">timing</span><span class="o">.</span><span class="n">txt</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<h3>重放记录的 Linux 终端会话活动</h3>
<p>现在，使用 <code>scriptreplay</code> 命令重放录制的终端会话活动。</p>
<p>注意：<code>scriptreplay</code> 也由 RPM 包 <code>util-linux</code> 提供。<code>scriptreplay</code> 命令需要时序文件才能工作。</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">scriptreplay</span><span class="w"> </span><span class="c1">--timing=timing.txt session.log</span>
</code></pre></div>

<p>上面命令的输出将如下所示，</p>
<p><img alt="" src="/data/attachment/album/201910/06/122718q7riaibd8a7rr8r7.gif"></p>
<h3>记录所有用户的 Linux 终端会话活动</h3>
<p>在某些关键业务的 Linux 服务器上，我们希望跟踪所有用户的活动，这可以使用 <code>script</code> 命令来完成，将以下内容放在 <code>/etc/profile</code> 文件中，</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># vi /etc/profile</span>
<span class="err">……………………………………………………</span>
<span class="k">if</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;x$SESSION_RECORD&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="n">then</span>
<span class="n">timestamp</span><span class="o">=$</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">+%</span><span class="n">d</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">Y</span><span class="o">-%</span><span class="n">T</span><span class="p">)</span>
<span class="n">session_log</span><span class="o">=/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">session</span><span class="o">/</span><span class="n">session</span><span class="o">.$</span><span class="n">USER</span><span class="o">.$$.$</span><span class="n">timestamp</span>
<span class="n">SESSION_RECORD</span><span class="o">=</span><span class="n">started</span>
<span class="k">export</span><span class="w"> </span><span class="n">SESSION_RECORD</span>
<span class="n">script</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;$</span><span class="p">{</span><span class="n">session_log</span><span class="p">}</span><span class="o">.</span><span class="n">timing</span><span class="w"> </span><span class="o">$</span><span class="n">session_log</span>
<span class="n">exit</span>
<span class="n">fi</span>
<span class="err">……………………………………………………</span>
</code></pre></div>

<p>保存文件并退出。</p>
<p>在 <code>/var/log</code> 文件夹下创建 <code>session</code> 目录：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># mkdir /var/log/session</span>
</code></pre></div>

<p>给该文件夹指定权限：</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># chmod 777 /var/log/session/</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<p>现在，验证以上代码是否有效。在我正在使用 <code>pkumar</code> 用户的情况下，登录普通用户到 Linux 服务器：</p>
<div class="highlight"><pre><span></span><code><span class="o">~</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="c1"># ssh root@linuxtechi</span>
<span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="s1">&#39;s password:</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">uptime</span>
<span class="w"> </span><span class="mi">04</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">09</span><span class="w"> </span><span class="n">up</span><span class="w">  </span><span class="mi">5</span><span class="p">:</span><span class="mi">06</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w">  </span><span class="nb">load</span><span class="w"> </span><span class="n">average</span><span class="p">:</span><span class="w"> </span><span class="mf">0.00</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">date</span>
<span class="n">Fri</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">04</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="n">EDT</span><span class="w"> </span><span class="mi">2019</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="o">-</span><span class="n">h</span>
<span class="w">              </span><span class="n">total</span><span class="w">        </span><span class="n">used</span><span class="w">        </span><span class="n">free</span><span class="w">      </span><span class="n">shared</span><span class="w">  </span><span class="n">buff</span><span class="o">/</span><span class="n">cache</span><span class="w">   </span><span class="n">available</span>
<span class="n">Mem</span><span class="p">:</span><span class="w">           </span><span class="mf">3.9</span><span class="n">G</span><span class="w">        </span><span class="mi">172</span><span class="n">M</span><span class="w">        </span><span class="mf">2.0</span><span class="n">G</span><span class="w">        </span><span class="mf">8.6</span><span class="n">M</span><span class="w">        </span><span class="mf">1.7</span><span class="n">G</span><span class="w">        </span><span class="mf">3.3</span><span class="n">G</span>
<span class="n">Swap</span><span class="p">:</span><span class="w">          </span><span class="mf">3.9</span><span class="n">G</span><span class="w">          </span><span class="mi">0</span><span class="n">B</span><span class="w">        </span><span class="mf">3.9</span><span class="n">G</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1001</span><span class="p">(</span><span class="n">pkumar</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">pkumar</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">pkumar</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="o">=</span><span class="n">unconfined_u</span><span class="p">:</span><span class="n">unconfined_r</span><span class="p">:</span><span class="n">unconfined_t</span><span class="p">:</span><span class="n">s0</span><span class="o">-</span><span class="n">s0</span><span class="p">:</span><span class="n">c0</span><span class="o">.</span><span class="n">c1023</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">whoami</span>
<span class="n">pkumar</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">exit</span>

<span class="n">Login</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="n">user</span><span class="err">’</span><span class="n">s</span><span class="w"> </span><span class="n">linux</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">activity</span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="o">~</span><span class="p">]</span><span class="c1"># cd /var/log/session/</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="n">session</span><span class="p">]</span><span class="c1"># ls -l | grep pkumar</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">pkumar</span><span class="w"> </span><span class="n">pkumar</span><span class="w"> </span><span class="mi">870</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">04</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="n">session</span><span class="o">.</span><span class="n">pkumar</span><span class="o">.</span><span class="mf">19785.21</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">05</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">pkumar</span><span class="w"> </span><span class="n">pkumar</span><span class="w"> </span><span class="mi">494</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="mi">04</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="n">session</span><span class="o">.</span><span class="n">pkumar</span><span class="o">.</span><span class="mf">19785.21</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">05.</span><span class="n">timing</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">linuxtechi</span><span class="w"> </span><span class="n">session</span><span class="p">]</span><span class="c1">#</span>
</code></pre></div>

<p><img alt="Session-output-file-linux" src="/data/attachment/album/201910/06/122719dexuklun2x9kx2lf.jpg"></p>
<p>我们还可以使用 <code>scriptreplay</code> 命令来重放用户的终端会话活动：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@linuxtechi session</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">scriptreplay</span><span class="w"> </span><span class="c1">--timing session.pkumar.19785.21-06-2019-04\:34\:05.timing session.pkumar.19785.21-06-2019-04\:34\:05</span>
</code></pre></div>

<p>以上就是本教程的全部内容，请在下面的评论部分中分享你的反馈和评论。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>