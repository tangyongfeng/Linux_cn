<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>增强 nginx 的 SSL 安全性</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Remy van Elst 本文向你介绍如何在 nginx 服务器上设置健壮的 SSL 安全机制。我们通过禁用 SSL 压缩来降低 CRIME 攻击威胁；禁用协议上 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2015/05/zeng-qiang-nginx-de-ssl-an-quan-xing.html" rel="bookmark"
           title="Permalink to 增强 nginx 的 SSL 安全性">增强 nginx 的 SSL 安全性</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-05-04T09:00:00+02:00">
                Published: Mon 04 May 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Remy van Elst</p>
<p><a href="https://www.ssllabs.com/ssltest/analyze.html?d=raymii.org"><img alt="" src="/data/attachment/album/201505/03/180656c9rra95g25gghdg5.png"></a></p>
<p>本文向你介绍如何在 nginx 服务器上设置健壮的 SSL 安全机制。我们通过禁用 SSL 压缩来降低 CRIME 攻击威胁；禁用协议上存在安全缺陷的 SSLv3 及更低版本，并设置更健壮的<ruby> 加密套件 <rp>  （ </rp> <rt>  cipher suite </rt> <rp>  ） </rp></ruby>来尽可能启用<ruby> 前向安全性 <rp>  （ </rp> <rt>  Forward Secrecy </rt> <rp>  ） </rp></ruby>；此外，我们还启用了 HSTS 和 HPKP。这样我们就拥有了一个健壮而可经受考验的 SSL 配置，并可以在 Qually Labs 的 SSL 测试中得到 A 级评分。</p>
<p>如果不求甚解的话，可以从 <a href="https://cipherli.st/">https://cipherli.st</a> 上找到 nginx 、Apache 和 Lighttpd 的安全设置，复制粘帖即可。</p>
<p>本教程在 Digital Ocean 的 VPS 上测试通过。如果你喜欢这篇教程，想要支持作者的站点的话，购买 Digital Ocean 的 VPS 时请使用如下链接：<a href="https://www.digitalocean.com/?refcode=7435ae6b8212">https://www.digitalocean.com/?refcode=7435ae6b8212</a> 。</p>
<p>本教程可以通过<a href="http://blog.ivanristic.com/2014/01/ssl-labs-stricter-security-requirements-for-2014.html">发布于 2014/1/21 的</a> SSL 实验室测试的严格要求（我之前就通过了测试，如果你按照本文操作就可以得到一个 A+ 评分）。</p>
<ul>
<li><a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_Apache2.html">本教程也可用于 Apache</a></li>
<li><a href="https://raymii.org/s/tutorials/Pass_the_SSL_Labs_Test_on_Lighttpd_%28Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS%29.html">本教程也可用于 Lighttpd</a></li>
<li><a href="http://www.bsdnow.tv/episodes/2014_08_20-engineering_nginx">本教程也可用于 FreeBSD, NetBSD 和 OpenBSD 上的 nginx ，放在 BSD Now 播客上</a>: <a href="http://www.bsdnow.tv/tutorials/nginx">http://www.bsdnow.tv/tutorials/nginx</a></li>
</ul>
<p>你可以从下列链接中找到这方面的进一步内容：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#BEAST_attack">野兽攻击（BEAST）</a></li>
<li><a href="https://en.wikipedia.org/wiki/CRIME_%28security_exploit%29">罪恶攻击（CRIME）</a></li>
<li><a href="http://blog.cryptographyengineering.com/2015/03/attack-of-week-freak-or-factoring-nsa.html">怪物攻击（FREAK ）</a></li>
<li><a href="http://heartbleed.com/">心血漏洞（Heartbleed）</a></li>
<li><a href="https://en.wikipedia.org/wiki/Perfect_forward_secrecy">完备的前向安全性（Perfect Forward Secrecy）</a></li>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Dealing_with_RC4_and_BEAST">RC4 和 BEAST 的处理</a></li>
</ul>
<p>我们需要编辑 nginx 的配置，在 Ubuntu/Debian 上是 <code>/etc/nginx/sited-enabled/yoursite.com</code>，在 RHEL/CentOS 上是 <code>/etc/nginx/conf.d/nginx.conf</code>。</p>
<p>本文中，我们需要编辑443端口（SSL）的 <code>server</code> 配置中的部分。在文末你可以看到完整的配置例子。</p>
<p><em>在编辑之前切记备份一下配置文件！</em></p>
<h3>野兽攻击（BEAST）和 RC4</h3>
<p>简单的说，<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>就是通过篡改一个加密算法的 <ruby> 密码块链 <rp>  （ </rp> <rt>  CBC，cipher block chaining </rt> <rp>  ） </rp></ruby>的模式，从而可以对部分编码流量悄悄解码。更多信息参照上面的链接。</p>
<p>针对<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>，较新的浏览器已经启用了客户端缓解方案。推荐方案是禁用 TLS 1.0 的所有加密算法，仅允许 RC4 算法。然而，<a href="http://www.isg.rhul.ac.uk/tls/">针对 RC4 算法的攻击也越来越多</a> ，很多已经从理论上逐步发展为实际可行的攻击方式。此外，有理由相信 NSA 已经实现了他们所谓的“大突破”——攻破 RC4 。</p>
<p>禁用 RC4 会有几个后果。其一，当用户使用老旧的浏览器时，比如 Windows XP 上的 IE 会用 3DES 来替代 RC4。3DES 要比 RC4 更安全，但是它的计算成本更高，你的服务器就需要为这些用户付出更多的处理成本。其二，RC4 算法能减轻<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>的危害，如果禁用 RC4 会导致 TLS 1.0 用户会换到更容易受攻击的 AES-CBC 算法上（通常服务器端的对<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>的“修复方法”是让 RC4 优先于其它算法）。我认为 RC4 的风险要高于<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>的风险。事实上，有了客户端缓解方案（Chrome 和 Firefox 提供了缓解方案），<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>就不是什么大问题了。而 RC4 的风险却在增长：随着时间推移，对加密算法的破解会越来越多。</p>
<h3>怪物攻击（FREAK）</h3>
<p><ruby> 怪物攻击 <rp>  （ </rp> <rt>  FREAK </rt> <rp>  ） </rp></ruby>是一种中间人攻击，它是由来自 <a href="https://www.smacktls.com/">INRIA、微软研究院和 IMDEA</a> 的密码学家们所发现的。<ruby> 怪物攻击 <rp>  （ </rp> <rt>  FREAK </rt> <rp>  ） </rp></ruby>的缩写来自“<ruby> RSA 出口密钥因子分解 <rp>  （ </rp> <rt>  Factoring RSA-EXPORT Keys </rt> <rp>  ） </rp></ruby>”</p>
<p>这个漏洞可上溯到上世纪九十年代，当时美国政府禁止出口加密软件，除非其使用编码密钥长度不超过512位的出口加密套件。</p>
<p>这造成了一些现在的 TLS 客户端存在一个缺陷，这些客户端包括： 苹果的 SecureTransport 、OpenSSL。这个缺陷会导致它们会接受出口降级 RSA 密钥，即便客户端并没有要求使用出口降级 RSA 密钥。这个缺陷带来的影响很讨厌：在客户端存在缺陷，且服务器支持出口降级 RSA 密钥时，会发生中间人攻击，从而导致连接的强度降低。</p>
<p>攻击分为两个组成部分：首先是服务器必须接受“<ruby> 出口降级 RSA 密钥 <rp>  （ </rp> <rt>  export grade RSA </rt> <rp>  ） </rp></ruby>”。</p>
<p>中间人攻击可以按如下流程：</p>
<ul>
<li>在客户端的 Hello 消息中，要求标准的 RSA 加密套件。</li>
<li>中间人攻击者修改该消息为<ruby> ‘输出级 RSA 密钥’ <rp>  （ </rp> <rt>  export RSA </rt> <rp>  ） </rp></ruby>。</li>
<li>服务器回应一个512位的输出级 RSA 密钥，并以其长期密钥签名。</li>
<li>由于 OpenSSL/SecureTransport 的缺陷，客户端会接受这个弱密钥。</li>
<li>攻击者根据 RSA 模数分解因子来恢复相应的 RSA 解密密钥。</li>
<li>当客户端编码<ruby> ‘预主密码’ <rp>  （ </rp> <rt>  pre-master secret </rt> <rp>  ） </rp></ruby>给服务器时，攻击者现在就可以解码它并恢复 TLS 的<ruby> ‘主密码’ <rp>  （ </rp> <rt>  master secret </rt> <rp>  ） </rp></ruby>。</li>
<li>从这里开始，攻击者就能看到了传输的明文并注入任何东西了。</li>
</ul>
<p>本文所提供的加密套件不启用输出降级加密，请确认你的 OpenSSL 是最新的，也强烈建议你将客户端也升级到新的版本。</p>
<h3>心血漏洞（Heartbleed）</h3>
<p><ruby> 心血漏洞 <rp>  （ </rp> <rt>  Heartbleed </rt> <rp>  ） </rp></ruby> 是一个于2014年4月公布的 OpenSSL 加密库的漏洞，它是一个被广泛使用的传输层安全（TLS）协议的实现。无论是服务器端还是客户端在 TLS 中使用了有缺陷的 OpenSSL，都可以被利用该缺陷。由于它是因 DTLS 心跳扩展（RFC 6520）中的输入验证不正确（缺少了边界检查）而导致的，所以该漏洞根据“心跳”而命名。这个漏洞是一种缓存区超读漏洞，它可以读取到本不应该读取的数据。</p>
<p>哪个版本的 OpenSSL 受到<ruby> 心血漏洞 <rp>  （ </rp> <rt>  Heartbleed </rt> <rp>  ） </rp></ruby>的影响？</p>
<p>各版本情况如下：</p>
<ul>
<li>OpenSSL 1.0.1 直到 1.0.1f （包括）<strong>存在</strong>该缺陷</li>
<li>OpenSSL 1.0.1g <strong>没有</strong>该缺陷</li>
<li>OpenSSL 1.0.0 分支<strong>没有</strong>该缺陷</li>
<li>OpenSSL 0.9.8 分支<strong>没有</strong>该缺陷</li>
</ul>
<p>这个缺陷是2011年12月引入到 OpenSSL 中的，并随着 2012年3月14日 OpenSSL 发布的 1.0.1 而泛滥。2014年4月7日发布的 OpenSSL 1.0.1g 修复了该漏洞。</p>
<p>升级你的 OpenSSL 就可以避免该缺陷。</p>
<h3>SSL 压缩（罪恶攻击 CRIME）</h3>
<p><ruby> 罪恶攻击 <rp>  （ </rp> <rt>  CRIME </rt> <rp>  ） </rp></ruby>使用 SSL 压缩来完成它的魔法，SSL 压缩在下述版本是默认关闭的： nginx 1.1.6及更高/1.0.9及更高（如果使用了 OpenSSL 1.0.0及更高）， nginx 1.3.2及更高/1.2.2及更高（如果使用较旧版本的 OpenSSL）。</p>
<p>如果你使用一个早期版本的 nginx 或 OpenSSL，而且你的发行版没有向后移植该选项，那么你需要重新编译没有一个 ZLIB 支持的 OpenSSL。这会禁止 OpenSSL 使用 DEFLATE 压缩方式。如果你禁用了这个，你仍然可以使用常规的 HTML DEFLATE 压缩。</p>
<h3>SSLv2 和 SSLv3</h3>
<p>SSLv2 是不安全的，所以我们需要禁用它。我们也禁用 SSLv3，因为 TLS 1.0 在遭受到降级攻击时，会允许攻击者强制连接使用 SSLv3，从而禁用了<ruby> 前向安全性 <rp>  （ </rp> <rt>  forward secrecy </rt> <rp>  ） </rp></ruby>。</p>
<p>如下编辑配置文件：</p>
<div class="highlight"><pre><span></span><code>ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
</code></pre></div>

<h3>卷毛狗攻击（POODLE）和 TLS-FALLBACK-SCSV</h3>
<p>SSLv3 会受到<a href="https://raymii.org/s/articles/Check_servers_for_the_Poodle_bug.html">卷毛狗漏洞（POODLE）</a>的攻击。这是禁用 SSLv3 的主要原因之一。</p>
<p>Google 提出了一个名为 <a href="https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00">TLS_FALLBACK_SCSV</a> 的SSL/TLS 扩展，它用于防止强制 SSL 降级。如果你升级 到下述的 OpenSSL 版本会自动启用它。</p>
<ul>
<li>OpenSSL 1.0.1 带有 TLS_FALLBACK_SCSV 1.0.1j 及更高。</li>
<li>OpenSSL 1.0.0 带有 TLS_FALLBACK_SCSV 1.0.0o 及更高。</li>
<li>OpenSSL 0.9.8 带有 TLS_FALLBACK_SCSV 0.9.8zc 及更高。</li>
</ul>
<p><a href="http://wiki.nginx.org/HttpSslModule#ssl_protocols">更多信息请参照 NGINX 文档</a>。</p>
<h3>加密套件（cipher suite）</h3>
<p><ruby> 前向安全性 <rp>  （ </rp> <rt>  Forward Secrecy </rt> <rp>  ） </rp></ruby>用于在长期密钥被破解时确保会话密钥的完整性。<ruby> 完备的前向安全性 <rp>  （ </rp> <rt>  PFS，Perfect Forward Secrecy </rt> <rp>  ） </rp></ruby>是指强制在每个/每次会话中推导新的密钥。</p>
<p>这就是说，泄露的私钥并不能用来解密（之前）记录下来的 SSL 通讯。</p>
<p>提供<ruby> 完备的前向安全性 <rp>  （ </rp> <rt>  PFS，Perfect Forward Secrecy </rt> <rp>  ） </rp></ruby>功能的是那些使用了一种 Diffie-Hellman 密钥交换的短暂形式的加密套件。它们的缺点是系统开销较大，不过可以使用椭圆曲线的变体来改进。</p>
<p>以下两个加密套件是我推荐的，之后<a href="https://wiki.mozilla.org/Security/Server_Side_TLS">Mozilla 基金会</a>也推荐了。</p>
<p>推荐的加密套件：</p>
<div class="highlight"><pre><span></span><code><span class="nt">ssl_ciphers</span><span class="w"> </span><span class="s1">&#39;AES128+EECDH:AES128+EDH&#39;</span><span class="o">;</span>
</code></pre></div>

<p>向后兼容的推荐的加密套件（IE6/WinXP）：</p>
<div class="highlight"><pre><span></span><code><span class="nt">ssl_ciphers</span><span class="w"> </span><span class="s2">&quot;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&quot;</span><span class="o">;</span>
</code></pre></div>

<p>如果你的 OpenSSL 版本比较旧，不可用的加密算法会自动丢弃。应该一直使用上述的完整套件，让 OpenSSL 选择一个它所支持的。</p>
<p>加密套件的顺序是非常重要的，因为其决定了优先选择哪个算法。上述优先推荐的算法中提供了PFS（完备的前向安全性）。</p>
<p>较旧版本的 OpenSSL 也许不能支持这个算法的完整列表，AES-GCM 和一些 ECDHE 算法是相当新的，在 Ubuntu 和 RHEL 中所带的绝大多数 OpenSSL 版本中不支持。</p>
<h4>优先顺序的逻辑</h4>
<ul>
<li>ECDHE+AESGCM 加密是首选的。它们是 TLS 1.2 加密算法，现在还没有广泛支持。当前还没有对它们的已知攻击。</li>
<li>PFS 加密套件好一些，首选 ECDHE，然后是 DHE。</li>
<li>AES 128 要好于 AES 256。有一个关于 AES256 带来的安全提升程度是否值回成本的<a href="http://www.mail-archive.com/dev-tech-crypto@lists.mozilla.org/msg11247.html">讨论</a>，结果是显而易见的。目前，AES128 要更值一些，因为它提供了不错的安全水准，确实很快，而且看起来对时序攻击更有抵抗力。</li>
<li>在向后兼容的加密套件里面，AES 要优于 3DES。在 TLS 1.1及其以上，减轻了针对 AES 的<ruby> 野兽攻击 <rp>  （ </rp> <rt>  BEAST </rt> <rp>  ） </rp></ruby>的威胁，而在 TLS 1.0上则难以实现该攻击。在非向后兼容的加密套件里面，不支持 3DES。</li>
<li>RC4 整个不支持了。3DES 用于向后兼容。参看 <a href="https://wiki.mozilla.org/Security/Server_Side_TLS#RC4_weaknesses">#RC4_weaknesses</a> 中的讨论。</li>
</ul>
<h4>强制丢弃的算法</h4>
<ul>
<li>aNULL 包含了非验证的 Diffie-Hellman 密钥交换，这会受到<ruby> 中间人 <rp>  （ </rp> <rt>  MITM </rt> <rp>  ） </rp></ruby>攻击</li>
<li>eNULL 包含了无加密的算法（明文）</li>
<li>EXPORT 是老旧的弱加密算法，是被美国法律标示为可出口的</li>
<li>RC4 包含的加密算法使用了已弃用的 ARCFOUR 算法</li>
<li>DES 包含的加密算法使用了弃用的数据加密标准（DES）</li>
<li>SSLv2 包含了定义在旧版本 SSL 标准中的所有算法，现已弃用</li>
<li>MD5 包含了使用已弃用的 MD5 作为哈希算法的所有算法</li>
</ul>
<h3>更多设置</h3>
<p>确保你也添加了如下行：</p>
<div class="highlight"><pre><span></span><code><span class="nt">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="nt">on</span><span class="o">;</span>
<span class="nt">ssl_session_cache</span><span class="w"> </span><span class="nt">shared</span><span class="p">:</span><span class="nd">SSL</span><span class="p">:</span><span class="nd">10m</span><span class="o">;</span>
</code></pre></div>

<p>在一个 SSLv3 或 TLSv1 握手过程中选择一个加密算法时，一般使用客户端的首选算法。如果设置了上述配置，则会替代地使用服务器端的首选算法。</p>
<ul>
<li><a href="http://wiki.nginx.org/HttpSslModule#ssl_prefer_server_ciphers">关于 ssl_prefer_server_ciphers 的更多信息</a></li>
<li><a href="http://wiki.nginx.org/HttpSslModule#ssl_ciphers">关于 ssl_ciphers 的更多信息</a></li>
</ul>
<h3>前向安全性和 Diffie Hellman Ephemeral （DHE）参数</h3>
<p><ruby> 前向安全性 <rp>  （ </rp> <rt>  Forward Secrecy </rt> <rp>  ） </rp></ruby>的概念很简单：客户端和服务器协商一个永不重用的密钥，并在会话结束时销毁它。服务器上的 RSA 私钥用于客户端和服务器之间的 Diffie-Hellman 密钥交换签名。从 Diffie-Hellman 握手中获取的预主密钥会用于之后的编码。因为预主密钥是特定于客户端和服务器之间建立的某个连接，并且只用在一个限定的时间内，所以称作<ruby> 短暂模式 <rp>  （ </rp> <rt>  Ephemeral </rt> <rp>  ） </rp></ruby>。</p>
<p>使用了前向安全性，如果一个攻击者取得了一个服务器的私钥，他是不能解码之前的通讯信息的。这个私钥仅用于 Diffie Hellman 握手签名，并不会泄露预主密钥。Diffie Hellman 算法会确保预主密钥绝不会离开客户端和服务器，而且不能被中间人攻击所拦截。</p>
<p>所有版本的 nginx（如1.4.4）都依赖于 OpenSSL 给 Diffie-Hellman （DH）的输入参数。不幸的是，这意味着 Diffie-Hellman Ephemeral（DHE）将使用 OpenSSL 的默认设置，包括一个用于密钥交换的1024位密钥。因为我们正在使用2048位证书，DHE 客户端就会使用一个要比非 DHE 客户端更弱的密钥交换。</p>
<p>我们需要生成一个更强壮的 DHE 参数：</p>
<div class="highlight"><pre><span></span><code>cd /etc/ssl/certs
openssl dhparam -out dhparam.pem 4096
</code></pre></div>

<p>然后告诉 nginx 将其用作 DHE 密钥交换：</p>
<div class="highlight"><pre><span></span><code>ssl_dhparam /etc/ssl/certs/dhparam.pem;
</code></pre></div>

<h3>OCSP 装订（Stapling）</h3>
<p>当连接到一个服务器时，客户端应该使用<ruby> 证书吊销列表 <rp>  （ </rp> <rt>  CRL，Certificate Revocation List </rt> <rp>  ） </rp></ruby>或<ruby> 在线证书状态协议 <rp>  （ </rp> <rt>  OCSP，Online Certificate Status Protocol </rt> <rp>  ） </rp></ruby>记录来校验服务器证书的有效性。CRL 的问题是它已经增长的太大了，永远也下载不完了。</p>
<p>OCSP 更轻量级一些，因为我们每次只请求一条记录。但是副作用是当连接到一个服务器时必须对第三方 OCSP 响应器发起 OCSP 请求，这就增加了延迟和带来了潜在隐患。事实上，CA 所运营的 OCSP 响应器非常不可靠，浏览器如果不能及时收到答复，就会静默失败。攻击者通过 DoS 攻击一个 OCSP 响应器可以禁用其校验功能，这样就降低了安全性。</p>
<p>解决方法是允许服务器在 TLS 握手中发送缓存的 OCSP 记录，以绕开 OCSP 响应器。这个机制节省了客户端和 OCSP 响应器之间的通讯，称作 OCSP 装订。</p>
<p>客户端会在它的 CLIENT HELLO 中告知其支持 status_request TLS 扩展，服务器仅在客户端请求它的时候才发送缓存的 OCSP 响应。</p>
<p>大多数服务器最多会缓存 OCSP 响应48小时。服务器会按照常规的间隔连接到 CA 的 OCSP 响应器来获取刷新的 OCSP 记录。OCSP 响应器的位置可以从签名的证书中的<ruby> 授权信息访问 <rp>  （ </rp> <rt>  Authority Information Access </rt> <rp>  ） </rp></ruby>字段中获得。</p>
<ul>
<li><a href="https://raymii.org/s/tutorials/OCSP_Stapling_on_nginx.html">阅读我的教程：在 NGINX 中启用 OCSP 装订</a></li>
</ul>
<h3>HTTP 严格传输安全（HSTS）</h3>
<p>如有可能，你应该启用 <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security">HTTP 严格传输安全（HSTS）</a>，它会引导浏览器和你的站点之间的通讯仅通过 HTTPS。</p>
<ul>
<li><a href="/article-5266-1.html">阅读我关于 HSTS 的文章，了解如何配置它</a></li>
</ul>
<h3>HTTP 公钥固定扩展（HPKP）</h3>
<p>你也应该启用 <a href="https://wiki.mozilla.org/SecurityEngineering/Public_Key_Pinning">HTTP 公钥固定扩展（HPKP）</a>。</p>
<p>公钥固定的意思是一个证书链必须包括一个白名单中的公钥。它确保仅有白名单中的 CA 才能够为某个域名签署证书，而不是你的浏览器中存储的任何 CA。</p>
<p>我已经写了一篇<a href="/article-5282-1.html">关于 HPKP 的背景理论及在 Apache、Lighttpd 和 NGINX 中配置例子的文章</a>。</p>
<h3>配置范例</h3>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="n">listen</span><span class="w"> </span><span class="p">[::]:</span><span class="mi">443</span><span class="w"> </span><span class="n">default_server</span><span class="p">;</span>

<span class="w">  </span><span class="n">ssl</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">  </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">cert</span><span class="o">/</span><span class="n">raymii_org</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
<span class="w">  </span><span class="n">ssl_certificate</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">cert</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">bundle</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>

<span class="w">  </span><span class="n">ssl_ciphers</span><span class="w"> </span><span class="s1">&#39;AES128+EECDH:AES128+EDH:!aNULL&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="n">ssl_protocols</span><span class="w"> </span><span class="n">TLSv1</span><span class="w"> </span><span class="n">TLSv1</span><span class="o">.</span><span class="mi">1</span><span class="w"> </span><span class="n">TLSv1</span><span class="o">.</span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="n">ssl_session_cache</span><span class="w"> </span><span class="n">shared</span><span class="p">:</span><span class="n">SSL</span><span class="p">:</span><span class="mi">10</span><span class="n">m</span><span class="p">;</span>

<span class="w">  </span><span class="n">ssl_stapling</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">  </span><span class="n">ssl_stapling_verify</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">  </span><span class="n">resolver</span><span class="w"> </span><span class="mf">8.8</span><span class="o">.</span><span class="mf">4.4</span><span class="w"> </span><span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span><span class="w"> </span><span class="n">valid</span><span class="o">=</span><span class="mi">300</span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="n">resolver_timeout</span><span class="w"> </span><span class="mi">10</span><span class="n">s</span><span class="p">;</span>

<span class="w">  </span><span class="n">ssl_prefer_server_ciphers</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">  </span><span class="n">ssl_dhparam</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">dhparam</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>

<span class="w">  </span><span class="n">add_header</span><span class="w"> </span><span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span><span class="w"> </span><span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">63072000</span><span class="p">;</span>
<span class="w">  </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">DENY</span><span class="p">;</span>
<span class="w">  </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">nosniff</span><span class="p">;</span>

<span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="p">;</span>
<span class="w">  </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">htm</span><span class="p">;</span>
<span class="w">  </span><span class="n">server_name</span><span class="w"> </span><span class="n">raymii</span><span class="o">.</span><span class="n">org</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>

<h3>结尾</h3>
<p>如果你使用了上述配置，你需要重启 nginx：</p>
<div class="highlight"><pre><span></span><code># 首先检查配置文件是否正确
/etc/init.d/nginx configtest
# 然后重启
/etc/init.d/nginx restart
</code></pre></div>

<p>现在使用 <a href="https://www.ssllabs.com/ssltest/">SSL Labs 测试</a>来看看你是否能得到一个漂亮的“A”。当然了，你也得到了一个安全的、强壮的、经得起考验的 SSL 配置！</p>
<ul>
<li><a href="https://wiki.mozilla.org/Security/Server_Side_TLS">参考 Mozilla 关于这方面的内容</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>