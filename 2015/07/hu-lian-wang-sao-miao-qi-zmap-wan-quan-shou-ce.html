<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>互联网扫描器 ZMap 完全手册</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: '' 初识 ZMap ZMap被设计用来针对整个IPv4地址空间或其中的大部分实施综合扫描的工具。ZMap是研究者手中的利器，但在运行ZMap时，请注意，您很有可能正在以每秒140万个包的速度扫描整个IPv4地址空间 。我们建议用户即使在实施小范围扫描之前，也联系一下本地 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2015/07/hu-lian-wang-sao-miao-qi-zmap-wan-quan-shou-ce.html" rel="bookmark"
           title="Permalink to 互联网扫描器 ZMap 完全手册">互联网扫描器 ZMap 完全手册</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-07-21T07:30:00+02:00">
                Published: Tue 21 July 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: ''</p>
<h3>初识 ZMap</h3>
<p><img alt="" src="/data/attachment/album/201507/21/003713ar4fq4gq4g7zqb4q.png"></p>
<p>ZMap被设计用来针对整个IPv4地址空间或其中的大部分实施综合扫描的工具。ZMap是研究者手中的利器，但在运行ZMap时，请注意，您很有可能正在以每秒140万个包的速度扫描整个IPv4地址空间 。我们建议用户即使在实施小范围扫描之前，也联系一下本地网络的管理员并参考我们列举的<a href="/article-5860-1.html#bestpractices">最佳扫描体验</a>。</p>
<p>默认情况下，ZMap会对于指定端口实施尽可能大速率的TCP SYN扫描。较为保守的情况下，对10,000个随机的地址的80端口以10Mbps的速度扫描，如下所示：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>--bandwidth<span class="o">=</span>10M<span class="w"> </span>--target-port<span class="o">=</span><span class="m">80</span><span class="w"> </span>--max-targets<span class="o">=</span><span class="m">10000</span><span class="w"> </span>--output-file<span class="o">=</span>results.csv<span class="w"> </span>
</code></pre></div>

<p>或者更加简洁地写成：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-B<span class="w"> </span>10M<span class="w"> </span>-p<span class="w"> </span><span class="m">80</span><span class="w"> </span>-n<span class="w"> </span><span class="m">10000</span><span class="w"> </span>-o<span class="w"> </span>results.csv
</code></pre></div>

<p>ZMap也可用于扫描特定子网或CIDR地址块。例如，仅扫描10.0.0.0/8和192.168.0.0/16的80端口，运行指令如下：</p>
<div class="highlight"><pre><span></span><code>zmap -p 80 -o results.csv 10.0.0.0/8 192.168.0.0/16
</code></pre></div>

<p>如果扫描进行的顺利，ZMap会每秒输出类似以下内容的状态更新：</p>
<div class="highlight"><pre><span></span><code><span class="mf">0</span><span class="err">%</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="n">h51m</span><span class="w"> </span><span class="n">left</span><span class="p">);</span><span class="w"> </span><span class="n">send</span><span class="p">:</span><span class="w"> </span><span class="mf">28777</span><span class="w"> </span><span class="mf">562</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">560</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">recv</span><span class="p">:</span><span class="w"> </span><span class="mf">1192</span><span class="w"> </span><span class="mf">248</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">231</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">hits</span><span class="p">:</span><span class="w"> </span><span class="mf">0.04</span><span class="err">%</span>
<span class="mf">0</span><span class="err">%</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="n">h51m</span><span class="w"> </span><span class="n">left</span><span class="p">);</span><span class="w"> </span><span class="n">send</span><span class="p">:</span><span class="w"> </span><span class="mf">34320</span><span class="w"> </span><span class="mf">554</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">559</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">recv</span><span class="p">:</span><span class="w"> </span><span class="mf">1442</span><span class="w"> </span><span class="mf">249</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">234</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">hits</span><span class="p">:</span><span class="w"> </span><span class="mf">0.04</span><span class="err">%</span>
<span class="mf">0</span><span class="err">%</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="n">h50m</span><span class="w"> </span><span class="n">left</span><span class="p">);</span><span class="w"> </span><span class="n">send</span><span class="p">:</span><span class="w"> </span><span class="mf">39676</span><span class="w"> </span><span class="mf">535</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">555</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">recv</span><span class="p">:</span><span class="w"> </span><span class="mf">1663</span><span class="w"> </span><span class="mf">220</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">232</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">hits</span><span class="p">:</span><span class="w"> </span><span class="mf">0.04</span><span class="err">%</span>
<span class="mf">0</span><span class="err">%</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="n">h50m</span><span class="w"> </span><span class="n">left</span><span class="p">);</span><span class="w"> </span><span class="n">send</span><span class="p">:</span><span class="w"> </span><span class="mf">45372</span><span class="w"> </span><span class="mf">570</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">557</span><span class="w"> </span><span class="n">Kp</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">recv</span><span class="p">:</span><span class="w"> </span><span class="mf">1890</span><span class="w"> </span><span class="mf">226</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="mf">232</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="n">avg</span><span class="p">);</span><span class="w"> </span><span class="n">hits</span><span class="p">:</span><span class="w"> </span><span class="mf">0.04</span><span class="err">%</span>
</code></pre></div>

<p>这些更新信息提供了扫描的即时状态并表示成：</p>
<div class="highlight"><pre><span></span><code><span class="nt">完成进度</span><span class="o">%</span><span class="w"> </span><span class="o">(</span><span class="nt">剩余时间</span><span class="o">);</span><span class="w"> </span><span class="nt">send</span><span class="o">:</span><span class="w"> </span><span class="nt">发出包的数量</span><span class="w"> </span><span class="nt">即时速率</span><span class="w"> </span><span class="o">(</span><span class="nt">平均发送速率</span><span class="o">);</span><span class="w"> </span><span class="nt">recv</span><span class="o">:</span><span class="w"> </span><span class="nt">接收包的数量</span><span class="w"> </span><span class="nt">接收率</span><span class="w"> </span><span class="o">(</span><span class="nt">平均接收率</span><span class="o">);</span><span class="w"> </span><span class="nt">hits</span><span class="o">:</span><span class="w"> </span><span class="nt">命中率</span>
</code></pre></div>

<p>如果您不知道您所在网络能支持的扫描速率，您可能要尝试不同的扫描速率和带宽限制直到扫描效果开始下降，借此找出当前网络能够支持的最快速度。</p>
<p>默认情况下，ZMap会输出不同IP地址的列表（例如，根据SYN ACK数据包的情况），像下面这样。其<a href="/article-5860-1.html#output">输出结果</a>还有几种附加的格式（如，JSON和Redis），可以用作生成<a href="/article-5860-1.html#verbosity">程序可解析的扫描统计</a>。 同样，可以指定附加的<a href="/article-5860-1.html#outputfields">输出字段</a>并使用<a href="/article-5860-1.html#outputfilter">输出过滤</a>来过滤输出的结果。</p>
<div class="highlight"><pre><span></span><code><span class="mf">115.237.116.119</span>
<span class="mf">23.9.117.80</span>
<span class="mf">207.118.204.141</span>
<span class="mf">217.120.143.111</span>
<span class="mf">50.195.22.82</span>
</code></pre></div>

<p>我们强烈建议您使用<a href="/article-5860-1.html#blacklisting">黑名单文件</a>，以排除预留的/未分配的IP地址空间（如，RFC1918 规定的私有地址、组播地址），以及网络中需要排除在您扫描之外的地址。默认情况下，ZMap将采用位于 <code>/etc/zmap/blacklist.conf</code>的这个简单的<a href="/article-5860-1.html#blacklisting">黑名单文件</a>中所包含的预留和未分配地址。如果您需要某些特定设置，比如每次运行ZMap时的最大带宽或<a href="/article-5860-1.html#blacklisting">黑名单文件</a>，您可以在文件<code>/etc/zmap/zmap.conf</code>中指定或使用自定义<a href="/article-5860-1.html#config">配置文件</a>。</p>
<p>如果您正试图解决扫描的相关问题，有几个选项可以帮助您调试。首先，您可以通过添加<code>--dryrun</code>实施<a href="/article-5860-1.html#dryrun">预扫</a>，以此来分析包可能会发送到网络的何处。此外，还可以通过设置'--verbosity=n`来更改<a href="/article-5860-1.html#verbosity">日志详细程度</a>。</p>
<h3>最佳扫描体验</h3>
<p>我们为针对互联网进行扫描的研究者提供了一些建议，以此来引导养成良好的互联网合作氛围。</p>
<ul>
<li>密切协同本地的网络管理员，以减少风险和调查</li>
<li>确认扫描不会使本地网络或上游供应商瘫痪</li>
<li>在发起扫描的源地址的网页和DNS条目中申明你的扫描是善意的</li>
<li>明确解释你的扫描中所有连接的目的和范围</li>
<li>提供一个简单的退出扫描的方法并及时响应请求</li>
<li>实施扫描时，不使用比研究对象需求更大的扫描范围或更快的扫描频率</li>
<li>如果可以，将扫描流量分布到不同的时间或源地址上</li>
</ul>
<p>即使不声明，使用扫描的研究者也应该避免利用漏洞或访问受保护的资源，并遵守其辖区内任何特殊的法律规定。</p>
<h3>命令行参数</h3>
<h4>通用选项</h4>
<p>这些选项是实施简单扫描时最常用的选项。我们注意到某些选项取决于所使用的<a href="/article-5860-1.html#probemodule">探测模块</a>或<a href="/article-5860-1.html#outputmodule">输出模块</a>（如，在实施ICMP Echo扫描时是不需要使用目的端口的）。</p>
<p><strong>-p, --target-port=port</strong></p>
<p>要扫描的目标TCP端口号（例如，443）</p>
<p><strong>-o, --output-file=name</strong></p>
<p>将结果写入该文件，使用<code>-</code>代表输出到标准输出。</p>
<p><strong>-b, --blacklist-file=path</strong></p>
<p>文件中被排除的子网使用CIDR表示法（如192.168.0.0/16），一个一行。建议您使用此方法排除RFC 1918地址、组播地址、IANA预留空间等IANA专用地址。在conf/blacklist.example中提供了一个以此为目的示例黑名单文件。</p>
<h4>扫描选项</h4>
<p><strong>-n, --max-targets=n</strong></p>
<p>限制探测目标的数量。后面跟的可以是一个数字（例如'-n 1000<code>），或可扫描地址空间的百分比（例如，</code>-n 0.1％`，不包括黑名单）</p>
<p><strong>-N, --max-results=n</strong></p>
<p>收到多少结果后退出</p>
<p><strong>-t, --max-runtime=secs</strong></p>
<p>限制发送报文的时间</p>
<p><strong>-r, --rate=pps</strong></p>
<p>设置发包速率，以包/秒为单位</p>
<p><strong>-B, --bandwidth=bps</strong></p>
<p>以比特/秒设置传输速率（支持使用后缀G，M或K（如<code>-B 10M</code>就是速度10 mbps）的。设置会覆盖<code>--rate</code>。</p>
<p><strong>-c, --cooldown-time=secs</strong></p>
<p>发送完成后等待多久继续接收回包（默认值= 8）</p>
<p><strong>-e, --seed=n</strong></p>
<p>地址排序种子。如果要用多个ZMap以相同的顺序扫描地址，那么就可以使用这个参数。</p>
<p><strong>--shards=n</strong></p>
<p>将扫描分片/区，使其可多个ZMap中执行（默认值= 1）。启用分片时，<code>--seed</code>参数是必需的。</p>
<p><strong>--shard=n</strong></p>
<p>选择扫描的分片（默认值= 0）。n的范围在[0，N)，其中N为碎片的总数。启用分片时，<code>--seed</code>参数是必需的。</p>
<p><strong>-T, --sender-threads=n</strong></p>
<p>用于发送数据包的线程数（默认值= 1）</p>
<p><strong>-P, --probes=n</strong></p>
<p>发送到每个IP的探测数（默认值= 1）</p>
<p><strong>-d, --dryrun</strong></p>
<p>用标准输出打印出每个包，而不是将其发送（用于调试）</p>
<h4>网络选项</h4>
<p><strong>-s, --source-port=port|range</strong></p>
<p>发送数据包的源端口</p>
<p><strong>-S, --source-ip=ip|range</strong></p>
<p>发送数据包的源地址。可以仅仅是一个IP，也可以是一个范围（如，10.0.0.1-10.0.0.9）</p>
<p><strong>-G, --gateway-mac=addr</strong></p>
<p>数据包发送到的网关MAC地址（用以防止自动检测不工作的情况）</p>
<p><strong>-i, --interface=name</strong></p>
<p>使用的网络接口</p>
<h4>探测选项</h4>
<p>ZMap允许用户指定并添加自己所需要的<a href="/article-5860-1.html#probemodule">探测模块</a>。 探测模块的职责就是生成要发送的探测包，并处理主机回复的响应包。</p>
<p><strong>--list-probe-modules</strong></p>
<p>列出可用探测模块（如tcp_synscan）</p>
<p><strong>-M, --probe-module=name</strong></p>
<p>选择<a href="/article-5860-1.html#probemodule">探测模块</a>（默认值= tcp_synscan）</p>
<p><strong>--probe-args=args</strong></p>
<p>向模块传递参数</p>
<p><strong>--list-output-fields</strong></p>
<p>列出可用的输出模块</p>
<h4>输出选项</h4>
<p>ZMap允许用户指定和编写他们自己的<a href="/article-5860-1.html#outputmodule">输出模块</a>。输出模块负责处理由探测模块返回的字段，并将它们输出给用户。用户可以指定输出的字段，并过滤相应字段。</p>
<p><strong>--list-output-modules</strong></p>
<p>列出可用输出模块（如tcp_synscan）</p>
<p><strong>-O, --output-module=name</strong></p>
<p>选择<a href="/article-5860-1.html#outputmodule">输出模块</a>（默认值为csv）</p>
<p><strong>--output-args=args</strong></p>
<p>传递给输出模块的参数</p>
<p><strong>-f, --output-fields=fields</strong></p>
<p>输出的字段列表，以逗号分割</p>
<p><strong>--output-filter</strong></p>
<p>指定输出<a href="/article-5860-1.html#outputfilter">过滤器</a>对<a href="/article-5860-1.html#probemodule">探测模块</a>定义字段进行过滤</p>
<h4>附加选项</h4>
<p><strong>-C, --config=filename</strong></p>
<p>加载<a href="/article-5860-1.html#config">配置文件</a>，可以指定其他路径。</p>
<p><strong>-q, --quiet</strong></p>
<p>不必每秒刷新输出</p>
<p><strong>-g, --summary</strong></p>
<p>在扫描结束后打印配置和结果汇总信息</p>
<p><strong>-v, --verbosity=n</strong></p>
<p>日志详细程度（0-5，默认值= 3）</p>
<p><strong>-h, --help</strong></p>
<p>打印帮助并退出</p>
<p><strong>-V, --version</strong></p>
<p>打印版本并退出</p>
<h3>附加信息</h3>
<h4>TCP SYN 扫描</h4>
<p>在执行TCP SYN扫描时，ZMap需要指定一个目标端口，也支持指定发起扫描的源端口范围。</p>
<p><strong>-p, --target-port=port</strong></p>
<p>扫描的TCP端口（例如 443）</p>
<p><strong>-s, --source-port=port|range</strong></p>
<p>发送扫描数据包的源端口（例如 40000-50000）</p>
<p><strong>警示！</strong> ZMap基于Linux内核使用RST包来应答SYN/ACK包响应，以关闭扫描器打开的连接。ZMap是在Ethernet层完成包的发送的，这样做是为了减少跟踪打开的TCP连接和路由寻路带来的内核开销。因此，如果您有跟踪连接建立的防火墙规则，如类似于<code>-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</code>的netfilter规则，将阻止SYN/ACK包到达内核。这不会妨碍到ZMap记录应答，但它会阻止RST包被送回，最终被扫描主机的连接会一直打开，直到超时后断开。我们强烈建议您在执行ZMap时，选择一组主机上未使用且防火墙允许访问的端口，加在<code>-s</code>后（如 <code>-s '50000-60000'</code> ）。</p>
<h4>ICMP Echo 请求扫描</h4>
<p>虽然在默认情况下ZMap执行的是TCP SYN扫描，但它也支持使用ICMP echo请求扫描。在这种扫描方式下ICMP echo请求包被发送到每个主机，并以收到ICMP应答包作为答复。实施ICMP扫描可以通过选择icmp_echoscan扫描模块来执行，如下：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>--probe-module<span class="o">=</span>icmp_echoscan
</code></pre></div>

<h4>UDP 数据报扫描</h4>
<p>ZMap还额外支持UDP探测，它会发出任意UDP数据报给每个主机，并接收UDP或ICMP不可达的应答。ZMap可以通过使用--probe-args命令行选项来设置四种不同的UDP载荷。这些是：可在命令行设置可打印的ASCII 码的‘text’载荷和十六进制载荷的‘hex’，外部文件中包含载荷的‘file’，和通过动态字段生成的载荷的‘template’。为了得到UDP响应，请使用-f参数确保您指定的“data”字段处于输出范围。</p>
<p>下面的例子将发送两个字节'ST'，即PCAnwywhere的'status'请求，到UDP端口5632。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-M<span class="w"> </span>udp<span class="w"> </span>-p<span class="w"> </span><span class="m">5632</span><span class="w"> </span>--probe-args<span class="o">=</span>text:ST<span class="w"> </span>-N<span class="w"> </span><span class="m">100</span><span class="w"> </span>-f<span class="w"> </span>saddr,data<span class="w"> </span>-o<span class="w"> </span>-
</code></pre></div>

<p>下面的例子将发送字节“0X02”，即SQL Server的'client broadcast'请求，到UDP端口1434。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-M<span class="w"> </span>udp<span class="w"> </span>-p<span class="w"> </span><span class="m">1434</span><span class="w"> </span>--probe-args<span class="o">=</span>hex:02<span class="w"> </span>-N<span class="w"> </span><span class="m">100</span><span class="w"> </span>-f<span class="w"> </span>saddr,data<span class="w"> </span>-o<span class="w"> </span>-
</code></pre></div>

<p>下面的例子将发送一个NetBIOS状态请求到UDP端口137。使用一个ZMap自带的载荷文件。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-M<span class="w"> </span>udp<span class="w"> </span>-p<span class="w"> </span><span class="m">1434</span><span class="w"> </span>--probe-args<span class="o">=</span>file:netbios_137.pkt<span class="w"> </span>-N<span class="w"> </span><span class="m">100</span><span class="w"> </span>-f<span class="w"> </span>saddr,data<span class="w"> </span>-o<span class="w"> </span>-
</code></pre></div>

<p>下面的例子将发送SIP的'OPTIONS'请求到UDP端口5060。使用附ZMap自带的模板文件。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-M<span class="w"> </span>udp<span class="w"> </span>-p<span class="w"> </span><span class="m">1434</span><span class="w"> </span>--probe-args<span class="o">=</span>file:sip_options.tpl<span class="w"> </span>-N<span class="w"> </span><span class="m">100</span><span class="w"> </span>-f<span class="w"> </span>saddr,data<span class="w"> </span>-o<span class="w"> </span>-
</code></pre></div>

<p>UDP载荷模板仍处于实验阶段。当您在更多的使用一个以上的发送线程（-T）时可能会遇到崩溃和一个明显的相比静态载荷性能降低的表现。模板仅仅是一个由一个或多个使用${}将字段说明封装成序列构成的载荷文件。某些协议，特别是SIP，需要载荷来反射包中的源和目的包。其他协议，如portmapper和DNS，每个请求包含的字段应该是随机的，或降低被Zamp扫描的多宿主系统的风险。</p>
<p>以下的载荷模板将发送SIP OPTIONS请求到每一个目的地：</p>
<div class="highlight"><pre><span></span><code>OPTIONS<span class="w"> </span>sip:<span class="cp">${</span><span class="n">RAND_ALPHA</span><span class="o">=</span><span class="mi">8</span><span class="cp">}</span>@<span class="cp">${</span><span class="n">DADDR</span><span class="cp">}</span><span class="w"> </span>SIP/2.0
Via:<span class="w"> </span>SIP/2.0/UDP<span class="w"> </span><span class="cp">${</span><span class="n">SADDR</span><span class="cp">}</span>:<span class="cp">${</span><span class="n">SPORT</span><span class="cp">}</span>;branch=<span class="cp">${</span><span class="n">RAND_ALPHA</span><span class="o">=</span><span class="mi">6</span><span class="cp">}</span>.<span class="cp">${</span><span class="n">RAND_DIGIT</span><span class="o">=</span><span class="mi">10</span><span class="cp">}</span>;rport;alias
From:<span class="w"> </span>sip:<span class="cp">${</span><span class="n">RAND_ALPHA</span><span class="o">=</span><span class="mi">8</span><span class="cp">}</span>@<span class="cp">${</span><span class="n">SADDR</span><span class="cp">}</span>:<span class="cp">${</span><span class="n">SPORT</span><span class="cp">}</span>;tag=<span class="cp">${</span><span class="n">RAND_DIGIT</span><span class="o">=</span><span class="mi">8</span><span class="cp">}</span>
To:<span class="w"> </span>sip:<span class="cp">${</span><span class="n">RAND_ALPHA</span><span class="o">=</span><span class="mi">8</span><span class="cp">}</span>@<span class="cp">${</span><span class="n">DADDR</span><span class="cp">}</span>
Call-ID:<span class="w"> </span><span class="cp">${</span><span class="n">RAND_DIGIT</span><span class="o">=</span><span class="mi">10</span><span class="cp">}</span>@<span class="cp">${</span><span class="n">SADDR</span><span class="cp">}</span>
CSeq:<span class="w"> </span>1<span class="w"> </span>OPTIONS
Contact:<span class="w"> </span>sip:<span class="cp">${</span><span class="n">RAND_ALPHA</span><span class="o">=</span><span class="mi">8</span><span class="cp">}</span>@<span class="cp">${</span><span class="n">SADDR</span><span class="cp">}</span>:<span class="cp">${</span><span class="n">SPORT</span><span class="cp">}</span>
Content-Length:<span class="w"> </span>0
Max-Forwards:<span class="w"> </span>20
User-Agent:<span class="w"> </span><span class="cp">${</span><span class="n">RAND_ALPHA</span><span class="o">=</span><span class="mi">8</span><span class="cp">}</span>
Accept:<span class="w"> </span>text/plain
</code></pre></div>

<p>就像在上面的例子中展示的那样，注意每行行末以\r\n结尾，请求以\r\n\r\n结尾，大多数SIP实现都可以正确处理它。一个可以工作的例子放在ZMap的examples/udp-payloads目录下 (sip_options.tpl).</p>
<p>当前实现了下面的模板字段：</p>
<ul>
<li><strong>SADDR</strong>: 源IP地址的点分十进制格式</li>
<li><strong>SADDR_N</strong>: 源IP地址的网络字节序格式</li>
<li><strong>DADDR</strong>: 目的IP地址的点分十进制格式</li>
<li><strong>DADDR_N</strong>: 目的IP地址的网络字节序格式</li>
<li><strong>SPORT</strong>: 源端口的ascii格式</li>
<li><strong>SPORT_N</strong>: 源端口的网络字节序格式</li>
<li><strong>DPORT</strong>: 目的端口的ascii格式</li>
<li><strong>DPORT_N</strong>: 目的端口的网络字节序格式</li>
<li><strong>RAND_BYTE</strong>: 随机字节(0-255)，长度由=(length) 参数决定</li>
<li><strong>RAND_DIGIT</strong>: 随机数字0-9，长度由=(length) 参数决定</li>
<li><strong>RAND_ALPHA</strong>: 随机大写字母A-Z，长度由=(length) 参数决定</li>
<li><strong>RAND_ALPHANUM</strong>: 随机大写字母A-Z和随机数字0-9，长度由=(length) 参数决定</li>
</ul>
<h3>配置文件</h3>
<p>ZMap支持使用配置文件来代替在命令行上指定所有要求的选项。配置中可以通过每行指定一个长名称的选项和对应的值来创建：</p>
<div class="highlight"><pre><span></span><code>interface &quot;eth1&quot;
source-ip 1.1.1.4-1.1.1.8
gateway-mac b4:23:f9:28:fa:2d # upstream gateway
cooldown-time 300 # seconds
blacklist-file /etc/zmap/blacklist.conf
output-file ~/zmap-output
quiet
summary
</code></pre></div>

<p>然后ZMap就可以按照配置文件并指定一些必要的附加参数运行了：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>--config<span class="o">=</span>~/.zmap.conf<span class="w"> </span>--target-port<span class="o">=</span><span class="m">443</span>
</code></pre></div>

<h3>详细</h3>
<p>ZMap可以在屏幕上生成多种类型的输出。默认情况下，Zmap将每隔1秒打印出相似的基本进度信息。可以通过设置<code>--quiet</code>来禁用。</p>
<div class="highlight"><pre><span></span><code><span class="mi">0</span><span class="o">:</span><span class="mi">01</span><span class="w"> </span><span class="mi">12</span><span class="o">%;</span><span class="w"> </span><span class="n">send</span><span class="o">:</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">(</span><span class="mf">15.1</span><span class="w"> </span><span class="n">Kp</span><span class="sr">/s avg); recv: 144 143 p/s (141 p/s</span><span class="w"> </span><span class="n">avg</span><span class="o">);</span><span class="w"> </span><span class="n">hits</span><span class="o">:</span><span class="w"> </span><span class="mf">1.44</span><span class="o">%</span>
</code></pre></div>

<p>ZMap同样也可以根据扫描配置打印如下消息，可以通过'--verbosity`参数加以控制。</p>
<div class="highlight"><pre><span></span><code><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mf">12.813</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">zmap</span><span class="p">:</span><span class="w"> </span><span class="n">started</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mf">12.817</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">zmap</span><span class="p">:</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">provided</span><span class="p">.</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">eth0</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">17</span><span class="err">:</span><span class="mf">03.971</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">cyclic</span><span class="p">:</span><span class="w"> </span><span class="n">primitive</span><span class="w"> </span><span class="nl">root</span><span class="p">:</span><span class="w"> </span><span class="mi">3489180582</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">17</span><span class="err">:</span><span class="mf">03.971</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">cyclic</span><span class="p">:</span><span class="w"> </span><span class="n">starting</span><span class="w"> </span><span class="nl">point</span><span class="p">:</span><span class="w"> </span><span class="mi">46588</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">17</span><span class="err">:</span><span class="mf">03.975</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">blacklist</span><span class="p">:</span><span class="w"> </span><span class="mi">3717595507</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="n">allowed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">scanned</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">17</span><span class="err">:</span><span class="mf">03.975</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="mi">28233</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">ports</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">17</span><span class="err">:</span><span class="mf">03.975</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">send</span><span class="p">:</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">bandwidth</span><span class="w"> </span><span class="mi">10000000</span><span class="w"> </span><span class="n">bits</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">14880</span><span class="w"> </span><span class="n">pkt</span><span class="o">/</span><span class="n">s</span>
<span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">17</span><span class="err">:</span><span class="mf">03.985</span><span class="w"> </span><span class="o">[</span><span class="n">DEBUG</span><span class="o">]</span><span class="w"> </span><span class="nl">recv</span><span class="p">:</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="n">started</span>
</code></pre></div>

<p>ZMap还支持在扫描之后打印出一个的可grep的汇总信息，类似于下面这样，可以通过调用<code>--summary</code>来实现。</p>
<div class="highlight"><pre><span></span><code><span class="nx">cnf</span><span class="w"> </span><span class="nx">target</span><span class="o">-</span><span class="nx">port</span><span class="w">             </span><span class="mi">443</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">source</span><span class="o">-</span><span class="nx">port</span><span class="o">-</span><span class="nx">range</span><span class="o">-</span><span class="nx">begin</span><span class="w">         </span><span class="mi">32768</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">source</span><span class="o">-</span><span class="nx">port</span><span class="o">-</span><span class="nx">range</span><span class="o">-</span><span class="nx">end</span><span class="w">           </span><span class="mi">61000</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">source</span><span class="o">-</span><span class="kd">addr</span><span class="o">-</span><span class="nx">range</span><span class="o">-</span><span class="nx">begin</span><span class="w">         </span><span class="m m-Double">1.1.1.4</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">source</span><span class="o">-</span><span class="kd">addr</span><span class="o">-</span><span class="nx">range</span><span class="o">-</span><span class="nx">end</span><span class="w">           </span><span class="m m-Double">1.1.1.8</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">maximum</span><span class="o">-</span><span class="nx">packets</span><span class="w">             </span><span class="mi">4294967295</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">maximum</span><span class="o">-</span><span class="nx">runtime</span><span class="w">             </span><span class="mi">0</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">permutation</span><span class="o">-</span><span class="nx">seed</span><span class="w">            </span><span class="mi">0</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">cooldown</span><span class="o">-</span><span class="nx">period</span><span class="w">             </span><span class="mi">300</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">send</span><span class="o">-</span><span class="kd">interface</span><span class="w">              </span><span class="nx">eth1</span>
<span class="nx">cnf</span><span class="w"> </span><span class="nx">rate</span><span class="w">                    </span><span class="mi">45000</span>
<span class="nx">env</span><span class="w"> </span><span class="nx">nprocessors</span><span class="w">             </span><span class="mi">16</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">send</span><span class="o">-</span><span class="nx">start</span><span class="o">-</span><span class="nx">time</span><span class="w">             </span><span class="nx">Fri</span><span class="w"> </span><span class="nx">Jan</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">01</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">35</span><span class="w"> </span><span class="mi">2013</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">send</span><span class="o">-</span><span class="nx">end</span><span class="o">-</span><span class="nx">time</span><span class="w">               </span><span class="nx">Sat</span><span class="w"> </span><span class="nx">Jan</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">07</span><span class="w"> </span><span class="mi">2013</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">recv</span><span class="o">-</span><span class="nx">start</span><span class="o">-</span><span class="nx">time</span><span class="w">             </span><span class="nx">Fri</span><span class="w"> </span><span class="nx">Jan</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">01</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">35</span><span class="w"> </span><span class="mi">2013</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">recv</span><span class="o">-</span><span class="nx">end</span><span class="o">-</span><span class="nx">time</span><span class="w">               </span><span class="nx">Sat</span><span class="w"> </span><span class="nx">Jan</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">07</span><span class="w"> </span><span class="mi">2013</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">sent</span><span class="w">                    </span><span class="mi">3722335150</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">blacklisted</span><span class="w">             </span><span class="mi">572632145</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">first</span><span class="o">-</span><span class="nx">scanned</span><span class="w">               </span><span class="mi">1318129262</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">hit</span><span class="o">-</span><span class="nx">rate</span><span class="w">                </span><span class="m m-Double">0.874102</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">synack</span><span class="o">-</span><span class="nx">received</span><span class="o">-</span><span class="nx">unique</span><span class="w">          </span><span class="mi">32537000</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">synack</span><span class="o">-</span><span class="nx">received</span><span class="o">-</span><span class="nx">total</span><span class="w">           </span><span class="mi">36689941</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">synack</span><span class="o">-</span><span class="nx">cooldown</span><span class="o">-</span><span class="nx">received</span><span class="o">-</span><span class="nx">unique</span><span class="w">     </span><span class="mi">193</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">synack</span><span class="o">-</span><span class="nx">cooldown</span><span class="o">-</span><span class="nx">received</span><span class="o">-</span><span class="nx">total</span><span class="w">      </span><span class="mi">1543</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">rst</span><span class="o">-</span><span class="nx">received</span><span class="o">-</span><span class="nx">unique</span><span class="w">         </span><span class="mi">141901021</span>
<span class="nx">exc</span><span class="w"> </span><span class="nx">rst</span><span class="o">-</span><span class="nx">received</span><span class="o">-</span><span class="nx">total</span><span class="w">          </span><span class="mi">166779002</span>
<span class="nx">adv</span><span class="w"> </span><span class="nx">source</span><span class="o">-</span><span class="nx">port</span><span class="o">-</span><span class="nx">secret</span><span class="w">          </span><span class="mi">37952</span>
<span class="nx">adv</span><span class="w"> </span><span class="nx">permutation</span><span class="o">-</span><span class="nx">gen</span><span class="w">             </span><span class="mi">4215763218</span>
</code></pre></div>

<h3>结果输出</h3>
<p>ZMap可以通过<strong>输出模块</strong>生成不同格式的结果。默认情况下，ZMap只支持<strong>csv</strong>的输出，但是可以通过编译支持<strong>redis</strong>和<strong>json</strong> 。可以使用<strong>输出过滤</strong>来过滤这些发送到输出模块上的结果。输出模块输出的字段由用户指定。默认情况如果没有指定输出文件，ZMap将以csv格式返回结果，而不会生成特定结果。也可以编写自己的输出模块;请参阅<a href="/article-5860-1.html#exteding">编写输出模块</a>。</p>
<p><strong>-o, --output-file=p</strong></p>
<p>输出写入文件地址</p>
<p><strong>-O, --output-module=p</strong></p>
<p>调用自定义输出模块</p>
<p><strong>-f, --output-fields=p</strong></p>
<p>以逗号分隔的输出的字段列表</p>
<p><strong>--output-filter=filter</strong></p>
<p>对给定的探测指定字段输出过滤</p>
<p><strong>--list-output-modules</strong></p>
<p>列出可用输出模块</p>
<p><strong>--list-output-fields</strong></p>
<p>列出给定的探测的可用输出字段</p>
<h4>输出字段</h4>
<p>除了IP地址之外，ZMap有很多字段。这些字段可以通过在给定探测模块上运行<code>--list-output-fields</code>来查看。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>--probe-module<span class="o">=</span><span class="s2">&quot;tcp_synscan&quot;</span><span class="w"> </span>--list-output-fields
saddr<span class="w">           </span>string:<span class="w"> </span>应答包中的源IP地址
saddr-raw<span class="w">          </span>int:<span class="w"> </span>网络字节格式的源IP地址
daddr<span class="w">           </span>string:<span class="w"> </span>应答包中的目的IP地址
daddr-raw<span class="w">          </span>int:<span class="w"> </span>网络字节格式的目的IP地址
ipid<span class="w">               </span>int:<span class="w"> </span>应答包中的IP识别号
ttl<span class="w">                </span>int:<span class="w"> </span>应答包中的ttl（存活时间）值
sport<span class="w">              </span>int:<span class="w"> </span>TCP<span class="w"> </span>源端口
dport<span class="w">              </span>int:<span class="w"> </span>TCP<span class="w"> </span>目的端口
seqnum<span class="w">             </span>int:<span class="w"> </span>TCP<span class="w"> </span>序列号
acknum<span class="w">             </span>int:<span class="w"> </span>TCP<span class="w"> </span>Ack号
window<span class="w">             </span>int:<span class="w"> </span>TCP<span class="w"> </span>窗口
classification<span class="w">  </span>string:<span class="w"> </span>包类型
success<span class="w">            </span>int:<span class="w"> </span>是应答包成功
repeat<span class="w">             </span>int:<span class="w"> </span>是否是来自主机的重复响应
cooldown<span class="w">           </span>int:<span class="w"> </span>是否是在冷却时间内收到的响应
timestamp-str<span class="w">   </span>string:<span class="w"> </span>响应抵达时的时间戳使用ISO8601格式
timestamp-ts<span class="w">       </span>int:<span class="w"> </span>响应抵达时的时间戳使用UNIX纪元开始的秒数
timestamp-us<span class="w">       </span>int:<span class="w"> </span>时间戳的微秒部分<span class="o">(</span>例如<span class="w"> </span>从<span class="s1">&#39;timestamp-ts&#39;</span>的几微秒<span class="o">)</span>
</code></pre></div>

<p>可以通过使用<code>--output-fields=fields</code>或<code>-f</code>来选择选择输出字段，任意组合的输出字段可以被指定为逗号分隔的列表。例如：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-p<span class="w"> </span><span class="m">80</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;response,saddr,daddr,sport,seq,ack,in_cooldown,is_repeat,timestamp&quot;</span><span class="w"> </span>-o<span class="w"> </span>output.csv
</code></pre></div>

<h4>过滤输出</h4>
<p>在传到输出模块之前，探测模块生成的结果可以先过滤。过滤是针对探测模块的输出字段的。过滤使用类似于SQL的简单过滤语法写成，通过ZMap的<strong>--output-filter</strong>选项来指定。输出过滤通常用于过滤掉重复的结果，或仅传输成功的响应到输出模块。</p>
<p>过滤表达式的形式为<code>&lt;字段名&gt; &lt;操作符&gt; &lt;值&gt;</code>。<code>&lt;值&gt;</code>的类型必须是一个字符串或一串无符号整数并且匹配<code>&lt;字段名&gt;</code>类型。对于整数比较有效的操作符是<code>= !=, &lt;, &gt;, &lt;=, &gt;=</code>。字符串比较的操作是=，!=。<code>--list-output-fields</code>可以打印那些可供探测模块选择的字段和类型，然后退出。</p>
<p>复合型的过滤操作，可以通过使用<code>&amp;&amp;</code>（逻辑与）和<code>||</code>（逻辑或）这样的运算符来组合出特殊的过滤操作。</p>
<p><strong>示例</strong></p>
<p>书写一则过滤仅显示成功的、不重复的应答</p>
<div class="highlight"><pre><span></span><code>--output-filter=&quot;success = 1 &amp;&amp; repeat = 0&quot;
</code></pre></div>

<p>过滤出RST分类并且TTL大于10的包，或者SYNACK分类的包</p>
<div class="highlight"><pre><span></span><code>--output-filter=&quot;(classification = rst &amp;&amp; ttl &gt; 10) || classification = synack&quot;
</code></pre></div>

<h4>CSV</h4>
<p>csv模块将会生成以逗号分隔各个要求输出的字段的文件。例如，以下的指令将生成名为<code>output.csv</code>的CSV文件。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zmap<span class="w"> </span>-p<span class="w"> </span><span class="m">80</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;response,saddr,daddr,sport,seq,ack,in_cooldown,is_repeat,timestamp&quot;</span><span class="w"> </span>-o<span class="w"> </span>output.csv
</code></pre></div>

<h3>编写探测和输出模块</h3>
<p>ZMap可以通过<strong>探测模块</strong>来扩展支持不同类型的扫描，通过<strong>输出模块</strong>增加不同类型的输出结果。注册过的探测和输出模块可以在命令行中列出：</p>
<p><strong>--list-probe-modules</strong></p>
<p>列出安装过的探测模块</p>
<p><strong>--list-output-modules</strong></p>
<p>列出安装过的输出模块</p>
<h4>输出模块</h4>
<p>ZMap的输出和输出后处理可以通过实现和注册扫描器的<strong>输出模块</strong>来扩展。输出模块在接收每一个应答包时都会收到一个回调。然而默认提供的模块仅提供简单的输出，这些模块同样支持更多的输出后处理（例如：重复跟踪或输出AS号码来代替IP地址）。</p>
<p>通过定义一个新的output_module结构来创建输出模块，并在<a href="https://github.com/zmap/zmap/blob/v1.0.0/src/output_modules/output_modules.c">output_modules.c</a>中注册：</p>
<div class="highlight"><pre><span></span><code><span class="n">typedef</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">output_module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w">          </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">           </span><span class="o">//</span><span class="w"> </span><span class="err">在命令行如何引用输出模块</span>
<span class="w">    </span><span class="n">unsigned</span><span class="w">            </span><span class="n">update_interval</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">以秒为单位的更新间隔</span>

<span class="w">    </span><span class="n">output_init_cb</span><span class="w">      </span><span class="n">init</span><span class="p">;</span><span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="err">在扫描器初始化的时候调用</span>
<span class="w">    </span><span class="n">output_update_cb</span><span class="w">    </span><span class="n">start</span><span class="p">;</span><span class="w">           </span><span class="o">//</span><span class="w"> </span><span class="err">在扫描器开始的时候调用</span>
<span class="w">    </span><span class="n">output_update_cb</span><span class="w">    </span><span class="n">update</span><span class="p">;</span><span class="w">          </span><span class="o">//</span><span class="w"> </span><span class="err">每次更新间隔调用，秒为单位</span>
<span class="w">    </span><span class="n">output_update_cb</span><span class="w">    </span><span class="n">close</span><span class="p">;</span><span class="w">           </span><span class="o">//</span><span class="w"> </span><span class="err">扫描终止后调用</span>

<span class="w">    </span><span class="n">output_packet_cb</span><span class="w">    </span><span class="n">process_ip</span><span class="p">;</span><span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="err">接收到应答时调用</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w">          </span><span class="o">*</span><span class="n">helptext</span><span class="p">;</span><span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="err">会在</span><span class="o">--</span><span class="n">list</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="n">modules时打印在屏幕上</span>

<span class="p">}</span><span class="w"> </span><span class="n">output_module_t</span><span class="p">;</span>
</code></pre></div>

<p>输出模块必须有名称，通过名称可以在命令行调用，并且通常会实现<code>success_ip</code>和常见的<code>other_ip</code>回调。process_ip的回调由每个收到并经由<strong>probe module</strong>过滤的应答包调用。应答是否被认定为成功并不确定（比如，它可以是一个TCP的RST）。这些回调必须定义匹配<code>output_packet_cb</code>定义的函数:</p>
<div class="highlight"><pre><span></span><code><span class="nx">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">output_packet_cb</span><span class="p">)</span><span class="w"> </span><span class="p">(</span>

<span class="w">    </span><span class="nx">ipaddr_n_t</span><span class="w">    </span><span class="nx">saddr</span><span class="p">,</span><span class="w">         </span><span class="c1">// 网络字节格式的发起扫描主机IP地址</span>
<span class="w">    </span><span class="nx">ipaddr_n_t</span><span class="w">    </span><span class="nx">daddr</span><span class="p">,</span><span class="w">         </span><span class="c1">// 网络字节格式的目的IP地址</span>

<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">char</span><span class="o">*</span><span class="w">   </span><span class="nx">response_type</span><span class="p">,</span><span class="w"> </span><span class="c1">// 发送模块的数据包分类</span>

<span class="w">    </span><span class="nx">int</span><span class="w">           </span><span class="nx">is_repeat</span><span class="p">,</span><span class="w">     </span><span class="c1">// {0: 主机的第一个应答, 1: 后续的应答}</span>
<span class="w">    </span><span class="nx">int</span><span class="w">           </span><span class="nx">in_cooldown</span><span class="p">,</span><span class="w">   </span><span class="c1">// {0: 非冷却状态, 1: 扫描器处于冷却中}</span>

<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">u_char</span><span class="o">*</span><span class="w"> </span><span class="nx">packet</span><span class="p">,</span><span class="w">        </span><span class="c1">// 指向IP包的iphdr结构体的指针</span>
<span class="w">    </span><span class="nx">size_t</span><span class="w">        </span><span class="nx">packet_len</span><span class="w">     </span><span class="c1">// 包的长度，以字节为单位</span>
<span class="p">);</span>
</code></pre></div>

<p>输出模块还可以通过注册回调，执行在扫描初始化的时候（诸如打开输出文件的任务）、在扫描开始阶段（诸如记录黑名单的任务）、在扫描的常规间隔（诸如状态更新的任务）、在关闭的时候（诸如关掉所有打开的文件描述符）。提供的这些回调可以完整的访问扫描配置和当前状态：</p>
<div class="highlight"><pre><span></span><code>int (*output_update_cb)(struct state_conf*, struct state_send*, struct state_recv*);
</code></pre></div>

<p>这些定义在<a href="https://github.com/zmap/zmap/blob/master/src/output_modules/output_modules.h">output_modules.h</a>中。在<a href="https://github.com/zmap/zmap/blob/master/src/output_modules/module_csv.c">src/output<em>modules/module</em>csv.c</a>中有可用示例。</p>
<h4>探测模块</h4>
<p>数据包由<strong>探测模块</strong>构造，它可以创建各种包和不同类型的响应。ZMap默认拥有两个扫描模块：<code>tcp_synscan</code>和<code>icmp_echoscan</code>。默认情况下，ZMap使用<code>tcp_synscan</code>来发送TCP SYN包并对每个主机的响应分类，如打开时（收到SYN+ACK）或关闭时（收到RST）。ZMap允许开发者编写自己的ZMap探测模块，使用如下的API：</p>
<p>任何类型的扫描都必须通过开发和注册<code>send_module_t</code>结构中的回调来实现：</p>
<div class="highlight"><pre><span></span><code><span class="n">typedef</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">probe_module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w">               </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">             </span><span class="o">//</span><span class="w"> </span><span class="err">如何在命令行调用扫描</span>
<span class="w">    </span><span class="n">size_t</span><span class="w">                   </span><span class="n">packet_length</span><span class="p">;</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="err">探测包有多长</span><span class="p">(</span><span class="err">必须是静态的</span><span class="p">)</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w">               </span><span class="o">*</span><span class="n">pcap_filter</span><span class="p">;</span><span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="err">对收到的响应实施</span><span class="n">PCAP过滤</span>
<span class="w">    </span><span class="n">size_t</span><span class="w">                   </span><span class="n">pcap_snaplen</span><span class="p">;</span><span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="n">libpcap</span><span class="w"> </span><span class="err">捕获的最大字节数</span><span class="w"> </span>
<span class="w">    </span><span class="n">uint8_t</span><span class="w">                  </span><span class="n">port_args</span><span class="p">;</span><span class="w">         </span><span class="o">//</span><span class="w"> </span><span class="err">设为</span><span class="mi">1</span><span class="err">，如果</span><span class="n">ZMap需要用户指定</span><span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">port</span>

<span class="w">    </span><span class="n">probe_global_init_cb</span><span class="w">     </span><span class="n">global_initialize</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">在扫描初始化会时被调用一次</span>
<span class="w">    </span><span class="n">probe_thread_init_cb</span><span class="w">     </span><span class="n">thread_initialize</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">每个包缓存区的线程中被调用一次</span>
<span class="w">    </span><span class="n">probe_make_packet_cb</span><span class="w">     </span><span class="n">make_packet</span><span class="p">;</span><span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="err">每个主机更新包的时候被调用一次</span>
<span class="w">    </span><span class="n">probe_validate_packet_cb</span><span class="w"> </span><span class="n">validate_packet</span><span class="p">;</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="err">每收到一个包被调用一次，</span>
<span class="w">                                                </span><span class="o">//</span><span class="w"> </span><span class="err">如果包无效返回</span><span class="mi">0</span><span class="err">，</span>
<span class="w">                                                </span><span class="o">//</span><span class="w"> </span><span class="err">非零则有效。</span>

<span class="w">    </span><span class="n">probe_print_packet_cb</span><span class="w">    </span><span class="n">print_packet</span><span class="p">;</span><span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="err">如果在预扫模式下被每个包都调用</span>
<span class="w">    </span><span class="n">probe_classify_packet_cb</span><span class="w"> </span><span class="n">process_packet</span><span class="p">;</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">由区分响应的接收器调用</span>
<span class="w">    </span><span class="n">probe_close_cb</span><span class="w">           </span><span class="n">close</span><span class="p">;</span><span class="w">             </span><span class="o">//</span><span class="w"> </span><span class="err">扫描终止后被调用</span>

<span class="w">    </span><span class="n">fielddef_t</span><span class="w">               </span><span class="o">*</span><span class="n">fields</span><span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="err">该模块指定的字段的定义</span>
<span class="w">    </span><span class="nb nb-Type">int</span><span class="w">                      </span><span class="n">numfields</span><span class="w">          </span><span class="o">//</span><span class="w"> </span><span class="err">字段的数量</span>

<span class="p">}</span><span class="w"> </span><span class="n">probe_module_t</span><span class="p">;</span>
</code></pre></div>

<p>在扫描操作初始化时会调用一次<code>global_initialize</code>，可以用来实施一些必要的全局配置和初始化操作。然而，<code>global_initialize</code>并不能访问包缓冲区，那里是线程特定的。代替的，<code>thread_initialize</code>在每个发送线程初始化的时候被调用，提供对于缓冲区的访问，可以用来构建探测包和全局的源和目的值。此回调应用于构建主机不可知的包结构，甚至只有特定值（如：目的主机和校验和），需要随着每个主机更新。例如，以太网头部信息在交换时不会变更（减去校验和是由NIC硬件计算的）因此可以事先定义以减少扫描时间开销。</p>
<p>调用回调参数<code>make\_packet</code>是为了让被扫描的主机允许<strong>探测模块</strong>更新主机指定的值，同时提供IP地址、一个非透明的验证字符串和探测数目（如下所示）。探测模块负责在探测中放置尽可能多的验证字符串，即便当服务器返回的应答为空时，探测模块也能验证它的当前状态。例如，针对TCP SYN扫描，tcp_synscan探测模块会使用TCP源端口和序列号的格式存储验证字符串。响应包（SYN+ACK）将包含目的端口和确认号的预期值。</p>
<div class="highlight"><pre><span></span><code><span class="nx">int</span><span class="w"> </span><span class="nx">make_packet</span><span class="p">(</span>
<span class="w">    </span><span class="nx">void</span><span class="w">        </span><span class="o">*</span><span class="nx">packetbuf</span><span class="p">,</span><span class="w">  </span><span class="c1">// 包的缓冲区</span>
<span class="w">    </span><span class="nx">ipaddr_n_t</span><span class="w">  </span><span class="nx">src_ip</span><span class="p">,</span><span class="w">      </span><span class="c1">// 网络字节格式源IP</span>
<span class="w">    </span><span class="nx">ipaddr_n_t</span><span class="w">  </span><span class="nx">dst_ip</span><span class="p">,</span><span class="w">      </span><span class="c1">// 网络字节格式目的IP</span>
<span class="w">    </span><span class="nx">uint32_t</span><span class="w">    </span><span class="o">*</span><span class="nx">validation</span><span class="p">,</span><span class="w"> </span><span class="c1">// 探测中的有效字符串</span>
<span class="w">    </span><span class="nx">int</span><span class="w">         </span><span class="nx">probe_num</span><span class="w">    </span><span class="c1">// 如果向每个主机发送多重探测，</span>
<span class="w">                             </span><span class="c1">// 该值为我们对于该主机</span>
<span class="w">                             </span><span class="c1">// 正在发送的探测数目</span>
<span class="p">);</span>
</code></pre></div>

<p>扫描模块也应该定义<code>pcap_filter</code>、<code>validate_packet</code>和<code>process_packet</code>。只有符合PCAP过滤器的包才会被扫描。举个例子，在一个TCP SYN扫描的情况下，我们只想要调查TCP SYN / ACK或RST TCP数据包，并利用类似<code>tcp &amp;&amp; tcp[13] &amp; 4 != 0 || tcp[13] == 18</code>的过滤方法。<code>validate_packet</code>函数将会被每个满足PCAP过滤条件的包调用。如果验证返回的值非零，将会调用<code>process_packet</code>函数，并使用<code>fields</code>定义的字段和包中的数据填充字段集。举个例子，如下代码为TCP synscan探测模块处理了一个数据包。</p>
<div class="highlight"><pre><span></span><code><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">synscan_process_packet</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">fieldset_t</span><span class="w"> </span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">iphdr</span><span class="w"> </span><span class="o">*</span><span class="n">ip_hdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">iphdr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">[</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">ethhdr</span><span class="p">)];</span>
<span class="w">    </span><span class="n">struct</span><span class="w"> </span><span class="n">tcphdr</span><span class="w"> </span><span class="o">*</span><span class="n">tcp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">tcphdr</span><span class="o">*</span><span class="p">)((</span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ip_hdr</span><span class="w"> </span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span><span class="w"> </span><span class="n">iphdr</span><span class="p">)));</span>

<span class="w">    </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sport&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="w"> </span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">));</span><span class="w"> </span>
<span class="w">    </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dport&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="w"> </span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">));</span>
<span class="w">    </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;seqnum&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="w"> </span><span class="n">ntohl</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">));</span>
<span class="w">    </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;acknum&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="w"> </span><span class="n">ntohl</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">));</span>
<span class="w">    </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;window&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span><span class="w"> </span><span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">RST</span><span class="w"> </span><span class="n">packet</span>
<span class="w">        </span><span class="n">fs_add_string</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;classification&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nb">char</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;rst&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">SYNACK</span><span class="w"> </span><span class="n">packet</span>
<span class="w">        </span><span class="n">fs_add_string</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;classification&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nb">char</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;synack&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">fs_add_uint64</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>