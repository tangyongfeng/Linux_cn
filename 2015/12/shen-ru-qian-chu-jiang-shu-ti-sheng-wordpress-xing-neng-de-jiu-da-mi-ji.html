<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>深入浅出讲述提升 WordPress 性能的九大秘笈</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Floyd Smith 在建站和 web 应用程序交付方面，WordPress 是全球最大的一个平台。全球大约四分之一 的站点现在正在使用开源 WordPress 软件，包 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2015/12/shen-ru-qian-chu-jiang-shu-ti-sheng-wordpress-xing-neng-de-jiu-da-mi-ji.html" rel="bookmark"
           title="Permalink to 深入浅出讲述提升 WordPress 性能的九大秘笈">深入浅出讲述提升 WordPress 性能的九大秘笈</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-12-21T18:57:00+01:00">
                Published: Mon 21 December 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Floyd Smith</p>
<p>在建站和 web 应用程序交付方面，WordPress 是全球最大的一个平台。全球大约<a href="http://w3techs.com/technologies/overview/content_management/all">四分之一</a> 的站点现在正在使用开源 WordPress 软件，包括 eBay、 Mozilla、 RackSpace、 TechCrunch、 CNN、 MTV、纽约时报、华尔街日报 等等。</p>
<p>最流行的个人博客平台 WordPress.com，其也运行在 WordPress 开源软件上。<a href="https://www.nginx.com/press/choosing-nginx-growth-wordpresscom/">而 NGINX 则为 WordPress.com 提供了动力</a>。在 WordPress.com 的用户当中，许多站点起步于 WordPress.com，然后换成了自己运行 WordPress 开源软件；它们中越来越多的站点也使用了 NGINX 软件。</p>
<p>WordPress 的吸引力源于其简单性，无论是对于最终用户还是安装架设。然而，当使用量不断增长时，WordPress 站点的体系结构也存在一定的问题 - 这里有几个方法，包括使用缓存，以及将 WordPress 和 NGINX 组合起来，可以解决这些问题。</p>
<p>在这篇博客中，我们提供了九个提速技巧来帮助你解决 WordPress 中一些常见的性能问题：</p>
<ul>
<li>缓存静态资源</li>
<li>缓存动态文件</li>
<li>迁移到 NGINX</li>
<li>添加 NGINX 静态链接支持</li>
<li>为 NGINX 配置 FastCGI</li>
<li>为 NGINX 配置 W3<em>Total</em>Cache</li>
<li>为 NGINX 配置 WP-Super-Cache</li>
<li>为 NGINX 配置安全防范措施</li>
<li>配置 NGINX 支持 WordPress 多站点</li>
</ul>
<p><img alt="深入浅出讲述提升 WordPress 性能的九大秘笈" src="/data/attachment/album/201512/21/185659seueice60zn5n5c6.jpg"></p>
<h3>在 LAMP 架构下 WordPress 的性能</h3>
<p>大多数 WordPress 站点都运行在传统的 LAMP 架构下：Linux 操作系统，Apache Web 服务器软件，MySQL 数据库软件（通常是一个单独的数据库服务器）和 PHP 编程语言。这些都是非常著名的，广泛应用的开源工具。在 WordPress 世界里，很多人都用的是 LAMP，所以很容易寻求帮助和支持。</p>
<p>当用户访问 WordPress 站点时，浏览器为每个用户创建六到八个连接来连接到 Linux/Apache 上。当用户请求连接时，PHP 即时生成每个页面，从 MySQL 数据库获取资源来响应请求。</p>
<p>LAMP 或许对于数百个并发用户依然能照常工作。然而，流量突然增加是常见的，并且通常这应该算是一件好事。</p>
<p>但是，当 LAMP 站点变得繁忙时，当同时在线的用户达到数千个时，它的瓶颈就会被暴露出来。瓶颈存在主要是两个原因：</p>
<ol>
<li>Apache Web 服务器 - Apache 的每个/每次连接需要消耗大量资源。如果 Apache 接受了太多的并发连接，内存可能会耗尽，从而导致性能急剧降低，因为数据必须交换到磁盘了。如果以限制连接数来提高响应时间，新的连接必须等待，这也导致了用户体验变得很差。</li>
<li>PHP/MySQL 的交互 - 一个运行 PHP 和 MySQL 数据库服务器的应用服务器上每秒的请求量有一个最大限制。当请求的数量超过这个最大限制时，用户必须等待。超过这个最大限制时也会增加所有用户的响应时间。超过其两倍以上时会出现明显的性能问题。</li>
</ol>
<p>LAMP 架构的网站出现性能瓶颈是常见的情况，这时就需要升级硬件了 - 增加 CPU，扩大磁盘空间等等。当 Apache 和 PHP/MySQL 的架构超载后，在硬件上不断的提升却跟不上系统资源指数增长的需求。</p>
<p>首选替代 LAMP 架构的是 LEMP 架构 – Linux, NGINX, MySQL, 和 PHP。 (这是 LEMP 的缩写，E 代表着 “engine-x.” 的发音。) 我们在 技巧 3 中会描述 LEMP 架构。</p>
<h3>技巧 1. 缓存静态资源</h3>
<p>静态资源是指不变的文件，像 CSS，JavaScript 和图片。这些文件往往在网页的数据中占半数以上。页面的其余部分是动态生成的，像在论坛中评论，性能仪表盘，或个性化的内容（可以看看 Amazon.com 产品）。</p>
<p>缓存静态资源有两大好处：</p>
<ul>
<li>更快的交付给用户 - 用户可以从它们浏览器的缓存或者从互联网上离它们最近的缓存服务器获取静态文件。有时候文件较大，因此减少等待时间对它们来说帮助很大。</li>
<li>减少应用服务器的负载 - 从缓存中检索到的每个文件会让 web 服务器少处理一个请求。你的缓存越多，用户等待的时间越短。</li>
</ul>
<p>要让浏览器缓存文件，需要在静态文件中设置正确的 HTTP 首部。看看 HTTP Cache-Control 首部，特别是设置了 max-age 参数，Expires 首部，以及 Entity 标记。<a href="http://www.mobify.com/blog/beginners-guide-to-http-cache-headers/">这里</a> 有详细的介绍。</p>
<p>当启用本地缓存，然后用户请求以前访问过的文件时，浏览器首先检查该文件是否在缓存中。如果在，它会询问 Web 服务器该文件是否改变过。如果该文件没有改变，Web 服务器将立即响应一个304状态码（未改变），这意味着该文件没有改变，而不是返回状态码200 OK 并检索和发送已改变的文件。</p>
<p>要在浏览器之外支持缓存，可以考虑下面讲到的技巧，以及考虑使用内容分发网络（CDN）。CDN 是一​​种流行且​​强大的缓存工具，但我们在这里不详细描述它。在你实现了这里讲到的其它技术之后可以考虑 CDN。此外，当你的站点从 HTTP/1.x 过渡到 HTTP/2 协议时，CDN 的用处可能不太大；根据需要调查和测试，找到你网站需要的正确方法。</p>
<p>如果你转向 NGINX Plus 或将开源的 NGINX 软件作为架构的一部分，建议你考虑 技巧 3，然后配置 NGINX 缓存静态资源。使用下面的配置，用你 Web 服务器的 URL 替换 www.example.com。</p>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">### 将 www.example.com 替换为你的 URL</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">htdocs</span><span class="p">;</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>

<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="o">$</span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span>\<span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">        </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span>
<span class="w">        </span><span class="c1">### 使用你 WordPress 服务器的套接字，地址和端口来替换</span>
<span class="w">        </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
<span class="w">        </span><span class="c1">#fastcgi_pass 127.0.0.1:9000;</span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="o">.</span><span class="p">(</span><span class="n">ogg</span><span class="o">|</span><span class="n">ogv</span><span class="o">|</span><span class="n">svg</span><span class="o">|</span><span class="n">svgz</span><span class="o">|</span><span class="n">eot</span><span class="o">|</span><span class="n">otf</span><span class="o">|</span><span class="n">woff</span><span class="o">|</span><span class="n">mp4</span><span class="o">|</span><span class="n">ttf</span><span class="o">|</span><span class="n">css</span><span class="o">|</span><span class="n">rss</span><span class="o">|</span><span class="n">atom</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="o">|</span><span class="n">gif</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">ico</span><span class="o">|</span><span class="n">zip</span><span class="o">|</span><span class="n">tgz</span><span class="o">|</span><span class="n">gz</span><span class="o">|</span><span class="n">rar</span><span class="o">|</span><span class="n">bz2</span><span class="o">|</span><span class="n">doc</span><span class="o">|</span><span class="n">xls</span><span class="o">|</span><span class="n">exe</span><span class="o">|</span><span class="n">ppt</span><span class="o">|</span><span class="n">tar</span><span class="o">|</span><span class="n">mid</span><span class="o">|</span><span class="n">midi</span><span class="o">|</span><span class="n">wav</span><span class="o">|</span><span class="n">bmp</span><span class="o">|</span><span class="n">rtf</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">expires</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>技巧 2. 缓存动态文件</h3>
<p>WordPress 动态地生成网页，这意味着每次请求时它都要生成一个给定的网页（即使和前一次的结果相同）。这意味着用户随时获得的是最新内容。</p>
<p>想一下，当用户访问一个帖子时，并在文章底部有用户的评论时。你希望用户能够看到所有的评论 - 即使评论刚刚发布。动态内容就是处理这种情况的。</p>
<p>但现在，当帖子每秒出现十几二十几个请求时。应用服务器可能每秒需要频繁生成页面导致其压力过大，造成延误。为了给用户提供最新的内容，每个访问理论上都是新的请求，因此它们不得不在原始出处等待很长时间。</p>
<p>为了防止页面由于不断提升的负载而变得缓慢，需要缓存动态文件。这需要减少文件的动态内容来提高整个系统的响应速度。</p>
<p>要在 WordPress 中启用缓存中，需要使用一些流行的插件 - 如下所述。WordPress 的缓存插件会请求最新的页面，然后将其缓存短暂时间 - 也许只有几秒钟。因此，如果该网站每秒中会有几个请求，那大多数用户获得的页面都是缓存的副本。这也有助于提高所有用户的检索时间：</p>
<ul>
<li>大多数用户获得页面的缓存副本。应用服务器没有做任何工作。</li>
<li>用户会得到一个之前的崭新副本。应用服务器只需每隔一段时间生成一个崭新页面。当服务器产生一个崭新页面（对于缓存过期后的第一个用户访问），它这样做要快得多，因为它的请求并没有超载。</li>
</ul>
<p>你可以缓存运行在 LAMP 架构或者 LEMP 架构 上 WordPress 的动态文件（在 技巧 3 中说明了）。有几个缓存插件，你可以在 WordPress 中使用。运用到了最流行的缓存插件和缓存技术，从最简单到最强大的：</p>
<ul>
<li><a href="https://wordpress.org/plugins/hyper-cache/">Hyper-Cache</a> 和 <a href="https://wordpress.org/plugins/quick-cache/">Quick-Cache</a> – 这两个插件为每个 WordPress 页面创建单个 PHP 文件。它支持绕过多个 WordPress 与数据库的连接核心处理的一些动态功能，创建一个更快的用户体验。它们不会绕过所有的 PHP 处理，所以并不会如下面那些取得同样的性能提升。它们也不需要修改 NGINX 的配置。</li>
<li><a href="https://wordpress.org/plugins/wp-super-cache/">WP Super Cache</a> – 最流行的 WordPress 缓存插件。在它易用的界面易用上提供了许多功能，如下所示。我们在 技巧 7 中展示了一个简单的 NGINX 配置实例。</li>
<li><a href="https://wordpress.org/plugins/w3-total-cache/">W3 Total Cache</a> – 这是第二流行的 WordPress 缓存插件。它比 WP Super Cache 的功能更强大，但它有些配置选项比较复杂。样例 NGINX 配置，请看 技巧 6。</li>
<li><a href="http://www.fastcgi.com/">FastCGI</a> – CGI 的意思是<ruby> 通用网关接口 <rp>  （ </rp> <rt>  Common Gateway Interface </rt> <rp>  ） </rp></ruby>，在因特网上发送请求和接收文件的一种通用方式。它不是一个插件，而是一种与缓存交互缓存的方法。FastCGI 可以被用在 Apache 和 Nginx 上，它也是最流行的动态缓存方法；我们在 技巧 5 中描述了如何配置 NGINX 来使用它。</li>
</ul>
<p>这些插件和技术的文档解释了如何在典型的 LAMP 架构中配置它们。配置方式包括数据库和对象缓存；最小化 HTML、CSS 和 JavaScript；集成流行的 CDN 集成环境。对于 NGINX 的配置，请看列表中的提示技巧。</p>
<p><strong>注意</strong>：缓存不会用于已经登录的 WordPress 用户，因为他们的 WordPress 页面都是不同的。（对于大多数网站来说，只有一小部分用户可能会登录）此外，大多数缓存不会对刚刚评论过的用户显示缓存页面，因为当用户刷新页面时希望看到他们的评论。若要缓存页面的非个性化内容，如果它对整体性能来说很重要，可以使用一种称为 <a href="https://css-tricks.com/wordpress-fragment-caching-revisited/">碎片缓存（fragment caching）</a> 的技术。</p>
<h3>技巧 3. 使用 NGINX</h3>
<p>如上所述，当并发用户数超过某一数量时 Apache 会导致性能问题 – 可能是数百个用户同时使用。Apache 对于每一个连接会消耗大量的资源，因而容易耗尽内存。Apache 可以配置连接数的值来避免耗尽内存，但是这意味着，超过限制时，新的连接请求必须等待。</p>
<p>此外，Apache 为每个连接加载一个 mod_php 模块副本到内存中，即使只有服务于静态文件（图片，CSS，JavaScript 等）。这使得每个连接消耗更多的资源，从而限制了服务器的性能。</p>
<p>要解决这些问题，从 LAMP 架构迁到 LEMP 架构 – 使用 NGINX 取代 Apache 。NGINX 在一定的内存之下就能处理成千上万的并发连接数，所以你不必经历颠簸，也不必限制并发连接数到很小的数量。</p>
<p>NGINX 处理静态文件的性能也较好，它有内置的，容易调整的 <a href="https://www.nginx.com/resources/admin-guide/content-caching/">缓存</a> 控制策略。减少应用服务器的负载，你的网站的访问速度会更快，用户体验更好。</p>
<p>你可以在部署环境的所有 Web 服务器上使用 NGINX，或者你可以把一个 NGINX 服务器作为 Apache 的“前端”来进行反向代理 - NGINX 服务器接收客户端请求，将请求的静态文件直接返回，将 PHP 请求转发到 Apache 上进行处理。</p>
<p>对于动态页面的生成，这是 WordPress 核心体验，可以选择一个缓存工具，如 技巧 2 中描述的。在下面的技巧中，你可以看到 FastCGI，W3_Total_Cache 和 WP-Super-Cache 在 NGINX 上的配置示例。 （Hyper-Cache 和 Quick-Cache 不需要改变 NGINX 的配置。）</p>
<p><strong>技巧</strong> 缓存通常会被保存到磁盘上，但你可以用 <a href="https://www.kernel.org/doc/Documentation/filesystems/tmpfs.txt">tmpfs</a> 将缓存放在内存中来提高性能。</p>
<p>为 WordPress 配置 NGINX 很容易。仅需四步，其详细的描述在指定的技巧中：</p>
<ol>
<li>添加永久链接的支持 - 让 NGINX 支持永久链接。此步消除了对 <strong>.htaccess</strong> 配置文件的依赖，这是 Apache 特有的。参见 技巧 4。</li>
<li>配置缓存 - 选择一个缓存工具并安装好它。可选择的有 FastCGI cache，W3 Total Cache, WP Super Cache, Hyper Cache, 和 Quick Cache。请看技巧 5、 6 和 7。</li>
<li>落实安全防范措施 - 在 NGINX 上采用对 WordPress 最佳安全的做法。参见 技巧 8。</li>
<li>配置 WordPress 多站点 - 如果你使用 WordPress 多站点，在 NGINX 下配置子目录，子域，或多域名架构。见 技巧9。</li>
</ol>
<h3>技巧 4. 让 NGINX 支持永久链接</h3>
<p>许多 WordPress 网站依赖于 <strong>.htaccess</strong> 文件，此文件为 WordPress 的多个功能所需要，包括永久链接支持、插件和文件缓存。NGINX 不支持 <strong>.htaccess</strong> 文件。幸运的是，你可以使用 NGINX 的简单而全面的配置文件来实现大部分相同的功能。</p>
<p>你可以在你的主 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server">server</a> 块下添加下面的 location 块中为使用 NGINX 的 WordPress 启用 <a href="http://codex.wordpress.org/Using_Permalinks">永久链接</a>。（此 location 块在其它代码示例中也会被包括）。</p>
<p><strong>try_files</strong> 指令告诉 NGINX 检查请求的 URL 在文档根目录（<strong>/var/www/example.com/htdocs</strong>）下是作为文件(<strong>$uri</strong>)还是目录(<strong>$uri/</strong>) 存在的。如果都不是，NGINX 将重定向到 <strong>/index.php</strong>，并传递查询字符串参数作为参数。</p>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">htdocs</span><span class="p">;</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>

<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_log</span><span class="w">  </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="o">$</span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>技巧 5. 在 NGINX 中配置 FastCGI</h3>
<p>NGINX 可以缓存来自 FastCGI 应用程序的响应，如 PHP 响应。此方法可提供最佳的性能。</p>
<p>对于开源的 NGINX，编译入第三方模块 <a href="https://github.com/FRiCKLE/ngx_cache_purge">ngx_cache_purge</a> 可以提供缓存清除能力，配置代码如下所示。NGINX Plus 已经包含了它自己实现此代码。</p>
<p>当使用 FastCGI 时，我们建议你安装 <a href="https://wordpress.org/plugins/nginx-helper/">NGINX 辅助插件</a> 并使用下面的配置文件，尤其是要注意 <strong>fastcgi_cache_key</strong> 的使用和包括 <strong>fastcgi_cache_purge</strong> 的 location 块。当页面发布或有改变时，有新评论被发布时，该插件会自动清除你的缓存，你也可以从 WordPress 管理控制台手动清除。</p>
<p>NGINX 的辅助插件还可以在你网页的底部添加一个简短的 HTML 代码，以确认缓存是否正常并显示一些统计数据。（你也可以使用 <a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#variables">$upstream<em>cache</em>status</a> 确认缓存功能是否正常。）</p>
<div class="highlight"><pre><span></span><code><span class="n">fastcgi_cache_path</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">cache</span><span class="w"> </span><span class="n">levels</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="w">       </span>
<span class="w">               </span><span class="n">keys_zone</span><span class="o">=</span><span class="n">WORDPRESS</span><span class="p">:</span><span class="mi">100</span><span class="n">m</span><span class="w"> </span><span class="n">inactive</span><span class="o">=</span><span class="mi">60</span><span class="n">m</span><span class="p">;</span>
<span class="n">fastcgi_cache_key</span><span class="w"> </span><span class="s2">&quot;$scheme$request_method$host$request_uri&quot;</span><span class="p">;</span>

<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">htdocs</span><span class="p">;</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>

<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_log</span><span class="w">  </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

<span class="w">    </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">### POST 请求和带有查询参数的网址应该交给 PHP</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">request_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">query_string</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>

<span class="w">    </span><span class="c1">### 以下 uris 中包含的部分不缓存</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="s2">&quot;/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php</span>
<span class="w">                         </span><span class="o">|</span><span class="n">sitemap</span><span class="p">(</span><span class="n">_index</span><span class="p">)</span><span class="err">?</span><span class="o">.</span><span class="n">xml</span><span class="s2">&quot;) {</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>

<span class="w">    </span><span class="c1">### 不要为登录用户或最近的评论者进行缓存</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_cookie</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="s2">&quot;comment_author|wordpress_[a-f0-9]+|wp-postpass</span>
<span class="w">        </span><span class="o">|</span><span class="n">wordpress_no_cache</span><span class="o">|</span><span class="n">wordpress_logged_in</span><span class="s2">&quot;) {</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="o">$</span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span>\<span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>
<span class="w">        </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_cache_bypass</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_no_cache</span><span class="w"> </span><span class="o">$</span><span class="n">skip_cache</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_cache</span><span class="w"> </span><span class="n">WORDPRESS</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_cache_valid</span><span class="w">  </span><span class="mi">60</span><span class="n">m</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">/</span><span class="n">purge</span><span class="p">(</span><span class="o">/.*</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fastcgi_cache_purge</span><span class="w"> </span><span class="n">WORDPRESS</span><span class="w"> </span><span class="s2">&quot;$scheme$request_method$host$1&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="o">^.+</span>\<span class="o">.</span><span class="p">(</span><span class="n">ogg</span><span class="o">|</span><span class="n">ogv</span><span class="o">|</span><span class="n">svg</span><span class="o">|</span><span class="n">svgz</span><span class="o">|</span><span class="n">eot</span><span class="o">|</span><span class="n">otf</span><span class="o">|</span><span class="n">woff</span><span class="o">|</span><span class="n">mp4</span><span class="o">|</span><span class="n">ttf</span><span class="o">|</span><span class="n">css</span><span class="o">|</span><span class="n">rss</span><span class="o">|</span><span class="n">atom</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="o">|</span><span class="n">gif</span><span class="o">|</span><span class="n">png</span>
<span class="w">                      </span><span class="o">|</span><span class="n">ico</span><span class="o">|</span><span class="n">zip</span><span class="o">|</span><span class="n">tgz</span><span class="o">|</span><span class="n">gz</span><span class="o">|</span><span class="n">rar</span><span class="o">|</span><span class="n">bz2</span><span class="o">|</span><span class="n">doc</span><span class="o">|</span><span class="n">xls</span><span class="o">|</span><span class="n">exe</span><span class="o">|</span><span class="n">ppt</span><span class="o">|</span><span class="n">tar</span><span class="o">|</span><span class="n">mid</span><span class="o">|</span><span class="n">midi</span><span class="o">|</span><span class="n">wav</span><span class="o">|</span><span class="n">bmp</span><span class="o">|</span><span class="n">rtf</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">        </span><span class="n">expires</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">robots</span><span class="o">.</span><span class="n">txt</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">/</span>\<span class="o">.</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">deny</span><span class="w">  </span><span class="n">all</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>技巧 6. 为 NGINX 配置 W3_Total_Cache</h3>
<p><a href="https://wordpress.org/plugins/w3-total-cache/">W3 Total Cache</a>, 是 <a href="http://www.w3-edge.com/">W3-Edge</a> 的 Frederick Townes 出品的， 是一个支持 NGINX 的 WordPress 缓存框架。其有众多选项配置，可以替代 FastCGI 缓存。</p>
<p>这个缓存插件提供了各种缓存配置，还包括数据库和对象的缓存，最小化 HTML、CSS 和 JavaScript，并可选与流行的 CDN 整合。</p>
<p>这个插件会通过写入一个位于你的域的根目录的 NGINX 配置文件来控制 NGINX。</p>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>

<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">htdocs</span><span class="p">;</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>
<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_log</span><span class="w">  </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

<span class="w">    </span><span class="n">include</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wordpress</span><span class="o">/</span><span class="n">installation</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="o">$</span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span>\<span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">        </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>技巧 7. 为 NGINX 配置 WP Super Cache</h3>
<p><a href="https://wordpress.org/plugins/wp-super-cache/">WP Super Cache</a> 是由 Donncha O Caoimh 开发的, 他是 <a href="http://automattic.com/">Automattic</a> 的一个 WordPress 开发者, 这是一个 WordPress 缓存引擎，它可以将 WordPress 的动态页面转变成静态 HTML 文件，以使 NGINX 可以很快的提供服务。它是第一个 WordPress 缓存插件，和其它的相比，它更专注于某一特定的领域。</p>
<p>配置 NGINX 使用 WP Super Cache 可以根据你的喜好而进行不同的配置。以下是一个示例配置。</p>
<p>在下面的配置中，带有名为 supercache 的 location 块是 WP Super Cache 特有的部分。 WordPress 规则的其余代码用于不缓存已登录用户的信息，不缓存 POST 请求，并对静态资源设置过期首部，再加上标准的 PHP 处理；这部分可以根据你的需求进行定制。</p>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">htdocs</span><span class="p">;</span>
<span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>

<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_log</span><span class="w">  </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="n">debug</span><span class="p">;</span>

<span class="w">    </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">cache_uri</span><span class="w"> </span><span class="o">$</span><span class="n">request_uri</span><span class="p">;</span>

<span class="w">    </span><span class="c1">### POST 请求和带有查询字符串的网址应该交给 PHP</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">request_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">cache_uri</span><span class="w"> </span><span class="s1">&#39;null cache&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">query_string</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">cache_uri</span><span class="w"> </span><span class="s1">&#39;null cache&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>

<span class="w">    </span><span class="c1">### 以下 uris 中包含的部分不缓存</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">request_uri</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="s2">&quot;(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php</span>
<span class="w">                          </span><span class="o">|</span><span class="n">wp</span><span class="o">-.*.</span><span class="n">php</span><span class="o">|/</span><span class="n">feed</span><span class="o">/|</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="o">|</span><span class="n">wp</span><span class="o">-</span><span class="n">comments</span><span class="o">-</span><span class="n">popup</span><span class="o">.</span><span class="n">php</span>
<span class="w">                          </span><span class="o">|</span><span class="n">wp</span><span class="o">-</span><span class="n">links</span><span class="o">-</span><span class="n">opml</span><span class="o">.</span><span class="n">php</span><span class="o">|</span><span class="n">wp</span><span class="o">-</span><span class="n">locations</span><span class="o">.</span><span class="n">php</span><span class="w"> </span><span class="o">|</span><span class="n">sitemap</span><span class="p">(</span><span class="n">_index</span><span class="p">)</span><span class="err">?</span><span class="o">.</span><span class="n">xml</span>
<span class="w">                          </span><span class="o">|</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">z0</span><span class="o">-</span><span class="mi">9</span><span class="n">_</span><span class="o">-</span><span class="p">]</span><span class="o">+-</span><span class="n">sitemap</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">)</span><span class="err">?</span><span class="o">.</span><span class="n">xml</span><span class="p">)</span><span class="s2">&quot;) {</span>

<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">cache_uri</span><span class="w"> </span><span class="s1">&#39;null cache&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="c1">### 不对已登录用户和最近的评论者使用缓存</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">http_cookie</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="s2">&quot;comment_author|wordpress_[a-f0-9]+</span>
<span class="w">                         </span><span class="o">|</span><span class="n">wp</span><span class="o">-</span><span class="n">postpass</span><span class="o">|</span><span class="n">wordpress_logged_in</span><span class="s2">&quot;) {</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="o">$</span><span class="n">cache_uri</span><span class="w"> </span><span class="s1">&#39;null cache&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">### 当请求的文件存在时使用缓存，否则将请求转发给 WordPress</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">/</span><span class="n">wp</span><span class="o">-</span><span class="n">content</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">supercache</span><span class="o">/$</span><span class="n">http_host</span><span class="o">/$</span><span class="n">cache_uri</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="w"> </span>
<span class="w">                  </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">robots</span><span class="o">.</span><span class="n">txt</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>
<span class="w">        </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
<span class="w">        </span><span class="c1">#fastcgi_pass 127.0.0.1:9000;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">### 尽可能的缓存静态文件</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~*.</span><span class="p">(</span><span class="n">ogg</span><span class="o">|</span><span class="n">ogv</span><span class="o">|</span><span class="n">svg</span><span class="o">|</span><span class="n">svgz</span><span class="o">|</span><span class="n">eot</span><span class="o">|</span><span class="n">otf</span><span class="o">|</span><span class="n">woff</span><span class="o">|</span><span class="n">mp4</span><span class="o">|</span><span class="n">ttf</span><span class="o">|</span><span class="n">css</span>
<span class="w">           </span><span class="o">|</span><span class="n">rss</span><span class="o">|</span><span class="n">atom</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="o">|</span><span class="n">gif</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">ico</span><span class="o">|</span><span class="n">zip</span><span class="o">|</span><span class="n">tgz</span><span class="o">|</span><span class="n">gz</span><span class="o">|</span><span class="n">rar</span><span class="o">|</span><span class="n">bz2</span>
<span class="w">           </span><span class="o">|</span><span class="n">doc</span><span class="o">|</span><span class="n">xls</span><span class="o">|</span><span class="n">exe</span><span class="o">|</span><span class="n">ppt</span><span class="o">|</span><span class="n">tar</span><span class="o">|</span><span class="n">mid</span><span class="o">|</span><span class="n">midi</span><span class="o">|</span><span class="n">wav</span><span class="o">|</span><span class="n">bmp</span><span class="o">|</span><span class="n">rtf</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">expires</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>技巧 8. 为 NGINX 配置安全防范措施</h3>
<p>为了防止攻击，可以控制对关键资源的访问并限制机器人对登录功能的过量攻击。</p>
<p>只允许特定的 IP 地址访问 WordPress 的仪表盘。</p>
<div class="highlight"><pre><span></span><code>### 对访问 WordPress 的仪表盘进行限制
location /wp-admin {
    deny  192.192.9.9;
    allow 192.192.1.0/24;
    allow 10.1.1.0/16;
    deny  all;
}
</code></pre></div>

<p>只允许上传特定类型的文件，以防止恶意代码被上传和运行。</p>
<div class="highlight"><pre><span></span><code><span class="c1">### 当上传的不是图像，视频，音乐等时，拒绝访问。</span>
<span class="n">location</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span><span class="o">^/</span><span class="n">wp</span><span class="o">-</span><span class="n">content</span><span class="o">/</span><span class="n">uploads</span><span class="o">/.*.</span><span class="p">(</span><span class="n">html</span><span class="o">|</span><span class="n">htm</span><span class="o">|</span><span class="n">shtml</span><span class="o">|</span><span class="n">php</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">swf</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">deny</span><span class="w"> </span><span class="n">all</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>拒绝其它人访问 WordPress 的配置文件 <strong>wp-config.php</strong>。拒绝其它人访问的另一种方法是将该文件的一个目录移到域的根目录之上的目录。</p>
<div class="highlight"><pre><span></span><code><span class="gu">##</span># 拒绝其它人访问 wp-config.php
location ~* wp-config.php {
    deny all;
}
</code></pre></div>

<p>对 <strong>wp-login.php</strong> 进行限速来防止暴力破解。</p>
<div class="highlight"><pre><span></span><code><span class="c1">### 拒绝访问 wp-login.php</span>
<span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">wp</span><span class="o">-</span><span class="n">login</span><span class="o">.</span><span class="n">php</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">limit_req</span><span class="w"> </span><span class="n">zone</span><span class="o">=</span><span class="n">one</span><span class="w"> </span><span class="n">burst</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">nodelay</span><span class="p">;</span>
<span class="w">    </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
<span class="w">    </span><span class="c1">#fastcgi_pass 127.0.0.1:9000;</span>
<span class="p">}</span>
</code></pre></div>

<h3>技巧 9. 配置 NGINX 支持 WordPress 多站点</h3>
<p><ruby> WordPress 多站点 <rp>  （ </rp> <rt>  WordPress Multisite </rt> <rp>  ） </rp></ruby>，顾名思义，这个版本 WordPress 可以让你以单个实例管理两个或多个网站。<a href="https://wordpress.com/">WordPress.com</a> 运行的就是 WordPress 多站点，其主机为成千上万的用户提供博客服务。</p>
<p>你可以从单个域的任何子目录或从不同的子域来运行独立的网站。</p>
<p>使用此代码块添加对子目录的支持。</p>
<div class="highlight"><pre><span></span><code><span class="err">###</span><span class="w"> </span><span class="nt">在</span><span class="w"> </span><span class="nt">WordPress</span><span class="w"> </span><span class="nt">多站点中添加对子目录结构的支持</span>
<span class="nt">if</span><span class="w"> </span><span class="o">(!</span><span class="nt">-e</span><span class="w"> </span><span class="o">$</span><span class="nt">request_filename</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">/wp-admin$</span><span class="w"> </span><span class="err">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">host</span><span class="err">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="n">permanent</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(/</span><span class="cp">[</span><span class="p">^</span><span class="o">/</span><span class="cp">]</span><span class="err">+)?(/wp-.*)</span><span class="w"> </span><span class="err">$2</span><span class="w"> </span><span class="err">last</span><span class="p">;</span><span class="w">                     </span>
<span class="w">    </span><span class="err">rewrite</span><span class="w"> </span><span class="err">^(/</span><span class="cp">[</span><span class="p">^</span><span class="o">/</span><span class="cp">]</span><span class="err">+)?(/.*\.php)</span><span class="w"> </span><span class="err">$2</span><span class="w"> </span><span class="err">last</span><span class="p">;</span><span class="w">                   </span>
<span class="p">}</span>
</code></pre></div>

<p>使用此代码块来替换上面的代码块以添加对子目录结构的支持，替换为你自己的子目录名。</p>
<div class="highlight"><pre><span></span><code><span class="gu">##</span># 添加支持子域名
server_name example.com *.example.com;
</code></pre></div>

<p>旧版本（3.4以前）的 WordPress 多站点使用 readfile() 来提供静态内容。然而，readfile() 是 PHP 代码，它会导致在执行时性能会显著降低。我们可以用 NGINX 来绕过这个非必要的 PHP 处理。该代码片段在下面被（==============）线分割出来了。</p>
<div class="highlight"><pre><span></span><code><span class="c1">### 避免对子目录中 /blogs.dir/ 结构执行  PHP readfile() </span>
<span class="n">location</span><span class="w"> </span><span class="o">^~</span><span class="w"> </span><span class="o">/</span><span class="n">blogs</span><span class="o">.</span><span class="n">dir</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">internal</span><span class="p">;</span>
<span class="w">    </span><span class="n">alias</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">htdocs</span><span class="o">/</span><span class="n">wp</span><span class="o">-</span><span class="n">content</span><span class="o">/</span><span class="n">blogs</span><span class="o">.</span><span class="n">dir</span><span class="p">;</span>
<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="n">expires</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">============================================================</span>

<span class="c1">### 避免对子目录中 /files/ 结构执行  PHP readfile() </span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">/</span><span class="p">[</span><span class="o">^/</span><span class="p">]</span><span class="o">+/</span><span class="p">)</span><span class="err">?</span><span class="n">files</span><span class="o">/</span><span class="p">(</span><span class="err">?</span><span class="o">.+</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">try_files</span><span class="w"> </span><span class="o">/</span><span class="n">wp</span><span class="o">-</span><span class="n">content</span><span class="o">/</span><span class="n">blogs</span><span class="o">.</span><span class="n">dir</span><span class="o">/$</span><span class="n">blogid</span><span class="o">/</span><span class="n">files</span><span class="o">/$</span><span class="n">rt_file</span><span class="w"> </span><span class="o">/</span><span class="n">wp</span><span class="o">-</span><span class="n">includes</span><span class="o">/</span><span class="n">ms</span><span class="o">-</span><span class="n">files</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="n">file</span><span class="o">=$</span><span class="n">rt_file</span><span class="p">;</span>
<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="n">expires</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">============================================================</span>

<span class="c1">### 子域路径的WPMU 文件结构</span>
<span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="n">files</span><span class="o">/</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">try_files</span><span class="w"> </span><span class="o">/</span><span class="n">wp</span><span class="o">-</span><span class="n">includes</span><span class="o">/</span><span class="n">ms</span><span class="o">-</span><span class="n">files</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="n">file</span><span class="o">=$</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="n">expires</span><span class="w"> </span><span class="nb">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">============================================================</span>

<span class="c1">### 映射博客 ID 到特定的目录</span>
<span class="n">map</span><span class="w"> </span><span class="o">$</span><span class="n">http_host</span><span class="w"> </span><span class="o">$</span><span class="n">blogid</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">default</span><span class="w">           </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w">       </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">site1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">site1</span><span class="o">.</span><span class="n">com</span><span class="w">         </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3>结论</h3>
<p>可扩展性对许多要让他们的 WordPress 站点取得成功的开发者来说是一项挑战。（对于那些想要跨越 WordPress 性能门槛的新站点而言。）为 WordPress 添加缓存，并将 WordPress 和 NGINX 结合，是不错的答案。</p>
<p>NGINX 不仅用于 WordPress 网站。世界上排名前 1000、10000 和 100000 网站中 NGINX 也是 <a href="http://w3techs.com/technologies/cross/web_server/ranking">遥遥领先的 web 服务器</a>。</p>
<p>欲了解更多有关 NGINX 的性能，请看我们最近的博客，<a href="https://www.nginx.com/blog/10-tips-for-10x-application-performance/">让应用性能提升 10 倍的 10 个技巧</a>。</p>
<p>NGINX 软件有两个版本：</p>
<ul>
<li>NGINX 开源软件 - 像 WordPress 一样，此软件你可以自行下载，配置和编译。</li>
<li>NGINX Plus - NGINX Plus 包括一个预构建的参考版本的软件，以及服务和技术支持。</li>
</ul>
<p>想要开始，先到 <a href="http://www.nginx.org/en">nginx.org</a> 下载开源软件并了解下 <a href="https://www.nginx.com/products/">NGINX Plus</a>。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>