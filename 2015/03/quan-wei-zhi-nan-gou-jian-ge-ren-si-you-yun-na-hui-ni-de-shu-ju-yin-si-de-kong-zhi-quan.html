<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>权威指南：构建个人私有云，拿回你的数据隐私的控制权！</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Roudy Jhausse 这篇鸿篇巨制（多达上万字）不但剖析了在你被那些“免费”的服务供养的背后所损失的隐私。事实上，Google、百度、360们比你更了解你自己；而且提 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li class="active"><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2015/03/quan-wei-zhi-nan-gou-jian-ge-ren-si-you-yun-na-hui-ni-de-shu-ju-yin-si-de-kong-zhi-quan.html" rel="bookmark"
           title="Permalink to 权威指南：构建个人私有云，拿回你的数据隐私的控制权！">权威指南：构建个人私有云，拿回你的数据隐私的控制权！</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-03-25T21:48:00+01:00">
                Published: Wed 25 March 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ji-zhu">技术</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Roudy Jhausse</p>
<blockquote>
<p>这篇鸿篇巨制（多达上万字）不但剖析了在你被那些“免费”的服务供养的背后所损失的隐私。事实上，Google、百度、360们比你更了解你自己；而且提出了具体的解决方案，对于稍有技术基础的人来，完整地指导了如何搭建私有云，提供全功能、商业级的邮件服务和云服务。</p>
<p>此外，文章中的邮件系统部分相当完善，而且，文章的思路清晰，简明扼要。其中包括基础的 SMTP/IMAP 服务自不必提，反垃圾邮件服务、灰名单、SPF、DKIM、Webmail，应有尽有，可以作为搭建产品环境中的邮件系统参考。</p>
</blockquote>
<p>8年里40000多次搜索！这是我的Google搜索历史。你的呢？（可以在<a href="https://history.google.com/history/">这里</a>自己找一下）有经过这么长时间积累下来的这么多数据点，Google已经能非常精确的推测你对什么感兴趣、曾经的想法、担忧过的事情，以及从你第一次获得Google帐号后这些年里所有这些的变化！</p>
<h2>很多非常私人的信息不受自己控制地存储在世界范围内的服务器上</h2>
<p>比如说你也像我一样从2006年到2013年都是Gmail用户，意味着你收到了30000封以上的电子邮件，以及在这7年里写了差不多5000封电子邮件。这些发送或收到的电子邮件里有很多是非常私人的，私人到你甚至不希望自己的家人或好友可以系统地查看。也许你还写过一些草稿邮件，因为最后一分钟改变主意而从没发出去。但是尽管你从未发出去，这些邮件仍然保存在服务器上的某个地方。结论是，说Google服务器比你最亲密的朋友或家人都更了解你的个人生活一点也不过分。</p>
<p>从统计数据来看，我可以很保险地打赌你拥有一部智能手机。如果不使用联系人应用的话手机将基本没法用，而它默认会将你的联系人信息保存到Google服务器上的Google联系人里。所以，现在Google不仅知道了你的电子邮件，还有了你的离线联系人：你喜欢打给谁、谁来过电话、你发过短信给谁，以及发了些什么。你也不需要听我的片面之词，可以自己检查一下，看看你开放给类似Google Play服务的一些应用的权限，用来读取来电信息以及收到的短信。你是否还会用到手机里自带的日历应用？除非你在设置日程的时候明确地去掉同步，那么Google将精确地知道你将要做什么，一天里的每个时段、每一天、每一年。用iPhone代替Android手机也是一样的，只是Apple会代替Google来掌握你的往来邮件、联系人和日程计划。</p>
<p>你是否还会非常小心地同步自己的联系人信息，在你朋友，同事或家人换工作或换服务商的时候更新他们的电子邮件地址和手机号？这给Google提供了一副你的社交网络的非常精确的、最新的描绘。还有你非常喜欢手机的GPS功能，经常配合Google地图使用。这意味着Google不仅能从日程里知道你在干什么，还知道你在哪儿、住在哪儿、在哪儿工作。然后再关联用户之间的GPS位置信息，Google还能知道你现在可能正在和哪些人来往。</p>
<h2>这种泄漏自己私人信息的日常爱好会以一种甚至没人能够预测的方式影响你的生活</h2>
<p>总结一下，如果你是一个普通的因特网用户，Google拥有过去差不多10年里你最新的、深度的信息，关于你的兴趣、忧虑、热情、疑问。它还收集了一些你很私人的信息（电子邮件、短信），精确到小时的你的日常活动和位置，一副你社交网络的高精度的描绘。关于你的如此私密的数据，很可能已经超越了你最亲密的朋友，家人或爱人对你的了解。</p>
<p>不敢想象把这些深度的个人信息交给完全陌生的人，就好像把这些信息拷到一个U盘里，然后随便放到某个咖啡厅的桌上，留张纸条说“Olivier Martin的个人数据，请随便”。谁知道什么人会拿到它以及用来干嘛？然而，我们毫不犹豫地把自己的主要信息交给那些对我们的数据很感兴趣的IT公司的陌生人（这是他们制造面包的材料）以及<a href="http://research.google.com/workatgoogle.html">世界级的数据分析专家</a>手里，也许只是因为我们在点击那个绿色的'接受'按钮时根本没有想这么多。</p>
<p>有这么多的高质量信息，这么多年里，Google可能会比你希望自我了解的更了解你自己：尼玛，回想我过去的数字生活，5年前发出的邮件里有一半我已经不记得了。我很高兴能重新发现早在2005年对xxx主义的兴趣以及第二年加入了<a href="http://www.attac.org/">ATTAC</a>（一个致力于通过征收金融交易税来限制投机和改善社会公平的组织）。天知道为什么我竟然在2007年这么喜欢跳舞。这些都是无关紧要的信息（你不指望我能爆出什么猛料，是吧？;-）。但是，连接起这些高质量数据点，关于你生活的方方面面（做什么、什么时候、和谁一起、在哪里，...），并跨越这么长时间间隔，应该能推测出你的未来状态。比如说，根据一个17岁女孩的购物习惯，超市甚至可以在他父亲听说之前断定这个女孩怀孕了（这是一个<a href="http://www.nytimes.com/2012/02/19/magazine/shopping-habits.html?pagewanted=all">真实的故事</a>）。谁知道通过像Google所掌握的这些远远超出购物习惯的高质量数据能做些什么？连接起这些点，也许有人能预测你未来几年里口味或观点的变化。如今，<a href="http://vimeo.com/ondemand/termsandconditions">你从未听过的公司声称拥有你500项数据点</a>，包括宗教信仰、性取向和政治观点。提到政治，如果说你决定今后10年内进入政坛会怎么样？你的生活会改变，你的观点也一样，甚至你有时候会有所遗忘，但是Google不会。那你会不会担心你的对手会接触一些可以从Google访问你数据的人并会从你过去这些年里积累的个人数据深渊里挖出一些猛料呢？<a href="http://www.techtimes.com/articles/21670/20141208/sony-pictures-hack-nightmare-week-celebs-data-leak-and-threatening-emails-to-employees.htm">就像最近Sony被黑</a>一样，多久以后会轮到Google或Facebook，以致让你的个人信息最终永远暴露？</p>
<p>我们大多数人把自己的个人数据托付给这些公司的一个原因就是它们提供免费服务。但是真的免费吗？一般的Google帐号的价值根据评估方式不同会有些差别：你花在写邮件上的时间占到<a href="http://blog.backupify.com/2012/07/25/what-is-my-gmail-account-really-worth/">1000美元/年</a>，你的帐号对于广告产业的价值差不多在<a href="http://adage.com/article/digital/worth-facebook-google/293042/">220美元/年</a>到<a href="http://vimeo.com/ondemand/termsandconditions">500美元/年</a>之间。所以这些服务并不是真的免费：会通过广告和我们的数据在未来的一些未知使用来间接付费。</p>
<p>我写的最多的是Google，这是因为这是我托付个人数字信息的，以及目前我所知道做的最好的公司。但是我也提到过Apple或Facebook。这些公司通过它们在设计、工程和我们（曾经）喜欢每天使用的服务方面的神奇进步实实在在地改变了世界。但是这并不是说我们应该把所有我们最私人的个人数据堆积到它们的服务器上并把我们的数字生活托付给它们：潜在的危害实在太大了。</p>
<h2>只要5小时，拿回自己以及关心的人的隐私权</h2>
<p><img alt="" src="/data/attachment/album/201503/25/214851hul4ul4e95uzwlmu.jpg"></p>
<p>（题图来自 ttgtmedia.com）</p>
<p>但是事实并不是一定必须这样的。你可以生活在21世纪，拿着智能手机，每天都用电子邮件和GPS，却仍然可以保留自己的隐私。你所需要的就是拿回自己个人数据的控制权：邮件、日程、联系人、文件，等等。<a href="https://prism-break.org/en/">Prism-Break.org</a>网站上列出了一些能帮你掌握个人数据命运的软件。除此以外，控制自己个人数据的最安全和最有效的方式是架设自己的服务器并搭建自己的云。不过你也许只是没有时间或精力去研究具体该怎么做以及如何让它能流畅工作。</p>
<p>这也是这篇文章的意义所在。仅仅5个小时内，我们将配置出一台服务器来支撑你的邮件、联系人、日程表和各种文件，为你、你的朋友和你的家人。这个服务器将设计成一个个人数据中心或云，所以你能时刻保留它的完整控制。数据将自动在你的台式机/笔记本、手机和平板之间同步。从根本上来说，<strong>我们将建立一个系统来代替Gmail、Google文件/Dropbox、Google联系人、Google日历和Picasa</strong>。</p>
<p>为自己做这件事情已经是迈出很大一步了。但是，你个人信息的很大一部分将仍然泄漏出去并保存到硅谷的一些主机上，只是因为和你日常来往的太多人在用Gmail和使用智能手机，所以最好是带上你一些比较亲近的人加入这次探险。</p>
<p>我们将构建的系统能够：</p>
<ul>
<li><strong>支持任意数目的域名和用户</strong>。这样就能轻易地和你的家人朋友共享这台服务器，所以他们也能掌控自己的个人数据，并且还能和你一起分摊服务费用。和你一起共享服务器的人可以使用他们自己的域名或者共享你的。</li>
<li><strong>允许你从任意网络发送和接收电子邮件</strong>，需要成功登录服务器之后。这样，你可以通过任意的邮件地址、任意设备（台式机、手机、平板）、任意网络（家里、公司、公共网络、...）来发送电子邮件。</li>
<li><strong>在发送和接收邮件的时候加密网络数据</strong>，这样，你不信任的人不能钓出你的密码，也不能看到你的私人邮件。</li>
<li><strong>提供最先进的反垃圾邮件技术</strong>，结合了已知垃圾邮件黑名单、自动灰名单、和自适应垃圾邮件过滤。如果邮件被误判了只需要简单地把它拖入或拖出垃圾目录就可以重新调校垃圾邮件过滤器。而且，服务器还会为基于社区的反垃圾邮件努力做出贡献。</li>
<li><strong>一段时间里只需要几分钟的维护</strong>，基本上只是安装安全更新和简单地检查一下服务器日志。添加一个新的邮件地址只需要在数据库中插入一条记录。除此之外，你可以忘记它的存在过自己的生活。我在14个月之前搭建了本文描述的这个系统，从那以后就一直顺利运行。所以我完全把它给忘了，直到我最近觉得随便按下手机上的‘检查邮件’会导致电子信号一路跑到冰岛（我放置服务器的地方）再回来的想法有点好笑才想起来。</li>
</ul>
<p>要完成这篇文章里的工作，你需要一点基本的技术能力。如果你知道SMTP和IMAP的区别，什么是DNS，以及对TCP/IP有基本了解的话，就够了。你还将需要一点基本的Unix知识（在命令行下和文件一起工作，基本的系统管理）。然后你需要花总共5小时时间来搭建。</p>
<p>下面是我们将要做的事情的概述。</p>
<ul>
<li>申请一个虚拟私人服务器，一个域名，并把它们配置好</li>
<li>设置postfix和dovecot来收发电子邮件</li>
<li>阻止垃圾邮件进入你的收件箱</li>
<li>确保你发出的邮件能通过垃圾邮件过滤器</li>
<li>使用Owncloud提供日历，联系人，文件服务并配置webmail</li>
<li>在云上同步你的设备</li>
</ul>
<h2>这篇文章是受之前工作的启发并以之为基础</h2>
<p>本文很大程度参考了两篇文章，由<a href="http://linuxfr.org/news/heberger-son-courriel">Xavier Claude</a>和<a href="http://sealedabstract.com/code/nsa-proof-your-e-mail-in-2-hours/">Drew Crawford</a>写的关于架设私有邮件服务器的介绍。</p>
<p>本文覆盖了Xavier和Drew的文章里所描述的所有功能，除了3个地方Drew有而我没有：邮件推送支持（我喜欢由我主动检查邮件，而其他时候都不会被打扰），邮件全文检索（我一直都没用过），以及使用加密方式存储邮件（我的邮件和数据还没那么重要到要把它们加密后再存到本地服务器上）。如果你需要这些功能，只需要按照Drew的文章里相应部分的说明做就好了，和本文的内容兼容。</p>
<p>和Xavier和Drew的成果比起来，本文有下面几个主要改进：</p>
<ul>
<li>根据我自己按Drew文章操作的经验以及原文的大量回复，修改了一些问题和文字错误。我也把本文所介绍的内容仔细检查了几遍，从头开始设定了几次服务器做重复验证以确保能正常工作。</li>
<li>低维护：和Xavier的方式比起来，本文增加了在服务器上支持多个邮件域名。这样做是为了尽可能地减少服务器维护工作：基本上，要添加一个域名或用户，只需要往mysql数据库表里增加一行就好了（不需要增加过滤脚本，等等）。</li>
<li>我增加了webmail。</li>
<li>我增加了设定云服务器的部分，不仅能收发邮件还能管理文件，地址本/联系人（邮件地址，电话号码，生日，等等等），日程表和图片，供所有设备访问使用。</li>
</ul>
<h2>申请一个虚拟私人服务器，一个域名，并把它们配置好</h2>
<p>让我们从设置基础设施开始：我们的虚拟私人主机和我们的域名。</p>
<p>我用过<a href="http://www.1984.is/">1984.is</a>和<a href="http://www.linode.com/">Linode</a>提供的虚拟私人主机（VPS），体验非常好。在本文中，我们将使用<strong>Debian Wheezy</strong>，这个在1984和Linode都提供了已经做好的映像文件可以直接布置到你的VPS上。我喜欢1984是因为它的服务器在冰岛，也是唯一使用可再生能源（地热和水力发电）的地方，目前还没有影响过气候变化，不像<a href="http://www.greenpeace.org/international/Global/international/publications/climate/2012/iCoal/HowCleanisYourCloud.pdf">大多数美国数据中心目前大多数依赖于烧煤的火力发电站</a>。而且，他们注重<a href="http://www.1984.is/about/">民权，透明，自由</a>以及<a href="http://www.fsf.org/">免费软件</a>。</p>
<p>最好是在服务器上创建一个文件用来保存后面要用到的各种密码（用户账号、邮件账号、云帐号、数据库帐号）。当然最好是加密一下（可以用<a href="https://www.gnupg.org/">GnuPG</a>），这样就算用来设定服务器的电脑被偷了或被入侵了，你的服务器就不会那么容易被攻击。</p>
<p>关于注册域名，我已经使用<a href="http://www.gandi.net/">grandi</a>的服务超过10年了，也很满意。在本文中，我们将开辟一个叫<strong>jhausse.net</strong>的域名。然后在上面增加一个叫<strong>cloud.jhausse.net</strong>的二级域名，并绑定MX纪录。在完成之后，设置比较短的纪录生存时间（TTL）比如300秒，这样你在设置服务器的时候，可以修改你的域并很快测试到结果。</p>
<p>最后，设置PTR纪录（反向DNS），这样IP地址可以反向映射回它的域名。如果你不理解前面这句话，看下<a href="http://www.codinghorror.com/blog/2010/04/so-youd-like-to-send-some-email-through-code.html">这篇文章</a>来获得相关背景知识。如果你使用Linode的服务，你可以在远程访问这一栏的控制面板里设置PTR纪录。如果是1984，联系一下技术支持来帮你搞定。</p>
<p>在服务器上，我们从添加一个普通用户开始，这样我们不用从头到尾一直用root账号。另外，用root登陆也需要额外多一层安全措施。</p>
<div class="highlight"><pre><span></span><code>adduser roudy
</code></pre></div>

<p>然后，在文件<strong>/etc/ssh/sshd_config</strong>中设置：</p>
<div class="highlight"><pre><span></span><code>PermitRootLogin no
</code></pre></div>

<p>然后重启ssh服务：</p>
<div class="highlight"><pre><span></span><code><span class="n">service</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="n">reload</span>
</code></pre></div>

<p>然后，我们要修改服务器的主机名。编辑文件<strong>/etc/hostname</strong>，只有一行就是自己的主机名，我们这个例子中是：</p>
<div class="highlight"><pre><span></span><code>cloud
</code></pre></div>

<p>然后，编辑ssh服务的公钥文件<strong>/etc/ssh/ssh_host_rsa_key.pub, /etc/ssh/ssh_host_dsa_key.pub, /etc/ssh/ssh_host_ecdsa_key.pub</strong>，这样文件末尾可以反映你的主机名，比如<strong>root@cloud</strong>。然后重启系统保证主机名在系统的每个需要它的角落都生效了。</p>
<div class="highlight"><pre><span></span><code>reboot
</code></pre></div>

<p>我们将更新系统并移除不必要的服务以降低远程攻击的风险。</p>
<div class="highlight"><pre><span></span><code>apt-get update
apt-get dist-upgrade
service exim4 stop
apt-get remove exim4 rpcbind
apt-get autoremove
apt-get install vim
</code></pre></div>

<p>我喜欢使用vim远程编辑配置文件。打开vim 的自动语法高亮会很有帮助。添加下面这一行到<strong>~/.vimrc</strong>文件中。</p>
<div class="highlight"><pre><span></span><code>syn on
</code></pre></div>

<h2>设置postfix和dovecot来收发电子邮件</h2>
<h3>postfix</h3>
<div class="highlight"><pre><span></span><code>apt-get install postfix postfix-mysql dovecot-core dovecot-imapd dovecot-mysql mysql-server dovecot-lmtpd postgrey
</code></pre></div>

<p>在<a href="http://www.postfix.org/">Postfix</a>的配置菜单里，选择<code>Internet Site</code>，设置这个系统的邮件名称为<strong>jhausse.net</strong>。</p>
<p>现在开始添加一个数据库用于保存主机上管理的域名列表，和每个域名下的用户列表（同时也包括他们各自的密码），以及邮件别名列表（用于从一个地址往另一个地址转发邮件）。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysqladmin</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">mailserver</span>
<span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">mailserver</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">mailserver</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;mailuser&#39;</span><span class="nv">@&#39;localhost&#39;</span><span class="w"> </span><span class="k">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;mailuserpass&#39;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`virtual_domains`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`id`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">auto_increment</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`name`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`id`</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`virtual_users`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`id`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">auto_increment</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`domain_id`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`password`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">106</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`email`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`id`</span><span class="p">),</span>
<span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n n-Quoted">`email`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`email`</span><span class="p">),</span>
<span class="w">  </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">virtual_domains</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`virtual_aliases`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`id`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">auto_increment</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`domain_id`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`source`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`destination`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`id`</span><span class="p">),</span>
<span class="w">  </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">virtual_domains</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div>

<p>这里我们为<strong>jhausse.net</strong>域名提供邮件服务。如果还需要加入其他域名，也没问题。我们也会为每个域名设置一个邮件管理地址（postmaster），转寄给<strong><a href="mailto:roudy@jhausse.net">roudy@jhausse.net</a></strong>。</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">virtual_domains</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`name`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;jhausse.net&#39;</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">virtual_domains</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`name`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;otherdomain.net&#39;</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">virtual_aliases</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`domain_id`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`source`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`destination`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;postmaster&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;roudy@jhausse.net&#39;</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">virtual_aliases</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`domain_id`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`source`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`destination`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;postmaster&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;roudy@jhausse.net&#39;</span><span class="p">);</span>
</code></pre></div>

<p>现在已经添加了一个本地邮件账号<strong><a href="mailto:roudy@jhausse.net">roudy@jhausse.net</a></strong>。首先，为它生成一个密码的哈希串：</p>
<div class="highlight"><pre><span></span><code>doveadm pw -s SHA512-CRYPT
</code></pre></div>

<p>然后把哈希值加入到数据库中：</p>
<div class="highlight"><pre><span></span><code><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`mailserver`</span><span class="p">.</span><span class="n n-Quoted">`virtual_users`</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`domain_id`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`password`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`email`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$6$YOURPASSWORDHASH&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;roudy@jhausse.net&#39;</span><span class="p">);</span>
</code></pre></div>

<p>现在我们的域名、别名和用户列表都设置好了，然后开始设置postfix（这是一个SMTP服务器，用来发送邮件）。把文件<strong>/etc/postfix/main.cf</strong>替换为下面的内容：</p>
<div class="highlight"><pre><span></span><code>myhostname<span class="w"> </span>=<span class="w"> </span>cloud.jhausse.net
myorigin<span class="w"> </span>=<span class="w"> </span>/etc/mailname
mydestination<span class="w"> </span>=<span class="w"> </span>localhost.localdomain,<span class="w"> </span>localhost
mynetworks_style<span class="w"> </span>=<span class="w"> </span>host

#<span class="w"> </span>We<span class="w"> </span>disable<span class="w"> </span>relaying<span class="w"> </span>in<span class="w"> </span>the<span class="w"> </span>general<span class="w"> </span>case
smtpd_recipient_restrictions<span class="w"> </span>=<span class="w"> </span>permit_mynetworks,<span class="w"> </span>reject_unauth_destination
#<span class="w"> </span>Requirements<span class="w"> </span>on<span class="w"> </span>servers<span class="w"> </span>that<span class="w"> </span>contact<span class="w"> </span>us:<span class="w"> </span>we<span class="w"> </span>verify<span class="w"> </span>the<span class="w"> </span>client<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>a
#<span class="w"> </span>known<span class="w"> </span>spammer<span class="w"> </span>(reject_rbl_client)<span class="w"> </span>and<span class="w"> </span>use<span class="w"> </span>a<span class="w"> </span>graylist<span class="w"> </span>mechanism
#<span class="w"> </span>(postgrey)<span class="w"> </span>to<span class="w"> </span>help<span class="w"> </span>reducing<span class="w"> </span>spam<span class="w"> </span>(check_policy_service)
smtpd_client_restrictions<span class="w"> </span>=<span class="w"> </span>permit_mynetworks,<span class="w"> </span>reject_rbl_client<span class="w"> </span>zen.spamhaus.org,<span class="w"> </span>check_policy_service<span class="w"> </span>inet:127.0.0.1:10023
disable_vrfy_command<span class="w"> </span>=<span class="w"> </span>yes
inet_interfaces<span class="w"> </span>=<span class="w"> </span>all
smtpd_banner<span class="w"> </span>=<span class="w"> </span><span class="nv">$myhostname</span><span class="w"> </span>ESMTP<span class="w"> </span><span class="nv">$mail_name</span><span class="w"> </span>(Debian/GNU)
biff<span class="w"> </span>=<span class="w"> </span>no
append_dot_mydomain<span class="w"> </span>=<span class="w"> </span>no
readme_directory<span class="w"> </span>=<span class="w"> </span>no

#<span class="w"> </span>TLS<span class="w"> </span>parameters
smtpd_tls_cert_file=/etc/ssl/certs/cloud.crt
smtpd_tls_key_file=/etc/ssl/private/cloud.key
smtpd_use_tls=yes
smtpd_tls_auth_only<span class="w"> </span>=<span class="w"> </span>yes
smtp_tls_security_level=may
smtp_tls_loglevel<span class="w"> </span>=<span class="w"> </span>1
smtpd_tls_loglevel<span class="w"> </span>=<span class="w"> </span>1
smtpd_tls_received_header<span class="w"> </span>=<span class="w"> </span>yes
smtpd_tls_session_cache_database<span class="w"> </span>=<span class="w"> </span>btree:<span class="cp">${</span><span class="n">data_directory</span><span class="cp">}</span>/smtpd_scache
smtp_tls_session_cache_database<span class="w"> </span>=<span class="w"> </span>btree:<span class="cp">${</span><span class="n">data_directory</span><span class="cp">}</span>/smtp_scache

#<span class="w"> </span>Delivery
alias_maps<span class="w"> </span>=<span class="w"> </span>hash:/etc/aliases
alias_database<span class="w"> </span>=<span class="w"> </span>hash:/etc/aliases
message_size_limit<span class="w"> </span>=<span class="w"> </span>50000000
recipient_delimiter<span class="w"> </span>=<span class="w"> </span>+

#<span class="w"> </span>The<span class="w"> </span>next<span class="w"> </span>lines<span class="w"> </span>are<span class="w"> </span>useful<span class="w"> </span>to<span class="w"> </span>set<span class="w"> </span>up<span class="w"> </span>a<span class="w"> </span>backup<span class="w"> </span>MX<span class="w"> </span>for<span class="w"> </span>myfriendsdomain.org
#<span class="w"> </span>relay_domains<span class="w"> </span>=<span class="w"> </span>myfriendsdomain.org
#<span class="w"> </span>relay_recipient_maps<span class="w"> </span>=

#<span class="w"> </span>Virtual<span class="w"> </span>domains
virtual_transport<span class="w"> </span>=<span class="w"> </span>lmtp:unix:private/dovecot-lmtp
virtual_mailbox_domains<span class="w"> </span>=<span class="w"> </span>mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
virtual_mailbox_maps<span class="w"> </span>=<span class="w"> </span>mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
virtual_alias_maps<span class="w"> </span>=<span class="w"> </span>mysql:/etc/postfix/mysql-virtual-alias-maps.cf
local_recipient_maps<span class="w"> </span>=<span class="w"> </span><span class="nv">$virtual_mailbox_maps</span>
</code></pre></div>

<p>现在我们要让postfix知道如何从我们设定的数据库里找出需要接收邮件的域名。建立一个新文件<strong>/etc/postfix/mysql-virtual-mailbox-domains.cf</strong>并添加以下内容：</p>
<div class="highlight"><pre><span></span><code>user = mailuser
password = mailuserpass
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_domains WHERE name=&#39;%s&#39;
</code></pre></div>

<p>我们可以让postfix判断给定的电子邮件账号是否存在，创建文件<strong>/etc/postfix/mysql-virtual-mailbox-maps.cf</strong>并写入以下内容：</p>
<div class="highlight"><pre><span></span><code>user = mailuser
password = mailuserpass
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_users WHERE email=&#39;%s&#39;
</code></pre></div>

<p>最后，postfix会根据文件<strong>/etc/postfix/mysql-virtual-alias-maps.cf</strong>的内容来查找邮件别名</p>
<div class="highlight"><pre><span></span><code>user = mailuser
password = mailuserpass
hosts = 127.0.0.1
dbname = mailserver
query = SELECT virtual_aliases.destination as destination FROM virtual_aliases, virtual_domains WHERE virtual_aliases.source=&#39;%u&#39; AND virtual_aliases.domain_id = virtual_domains.id AND virtual_domains.name=&#39;%d&#39;
</code></pre></div>

<p>在配置好这些后，现在要测试一下postfix是否能正常查询数据库。我们可以用<strong>postmap</strong>命令测试：</p>
<div class="highlight"><pre><span></span><code><span class="n">postmap</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="nl">mysql</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">postfix</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="n">mailbox</span><span class="o">-</span><span class="n">domains</span><span class="p">.</span><span class="n">cf</span>
<span class="n">postmap</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="nl">mysql</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">postfix</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="n">mailbox</span><span class="o">-</span><span class="n">maps</span><span class="p">.</span><span class="n">cf</span>
<span class="n">postmap</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">postmaster</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="nl">mysql</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">postfix</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="k">alias</span><span class="o">-</span><span class="n">maps</span><span class="p">.</span><span class="n">cf</span>
<span class="n">postmap</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">bob</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="nl">mysql</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">postfix</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="k">alias</span><span class="o">-</span><span class="n">maps</span><span class="p">.</span><span class="n">cf</span>
</code></pre></div>

<p>如果一切都正常配置了的话，头两个查询应该输出1，第3个查询应该输出<strong><a href="mailto:roudy@jhausse.net">roudy@jhausse.net</a></strong>，而最后一个应该什么都不输出。</p>
<h3>dovecot</h3>
<p>现在，让我们设置一下dovecot（一个IMAP服务程序，用来在我们的设备上从服务器获取收到的邮件）。编辑文件<strong>/etc/dovecot/dovecot.conf</strong>设置以下参数：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> Enable installed protocol
<span class="gh">#</span> !include_try /usr/share/dovecot/protocols.d/*.protocol 
protocols = imap lmtp
</code></pre></div>

<p>这样将只打开imap（让我们可以获取邮件）和lmtp（postfix用来将收件箱里的邮件转给dovecot）。编辑<strong>/etc/dovecot/conf.d/10-mail.conf</strong>并设置以下参数：</p>
<div class="highlight"><pre><span></span><code><span class="n">mail_location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maildir</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">mail</span><span class="o">/%</span><span class="n">d</span><span class="o">/%</span><span class="n">n</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">mail_privileged_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mail</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">first_valid_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>这样邮件将被保存到目录 /var/mail/domainname/username 下。注意下这几个选项散布在配置文件的不同位置，有时已经在那里写好了：我们只需要取消注释即可。文件里的其他设定选项，可以维持原样。在本文后面还有很多文件需要用同样的方式更新设置。在文件<strong>/etc/dovecot/conf.d/10-auth.conf</strong>里，设置以下参数：</p>
<div class="highlight"><pre><span></span><code><span class="n">disable_plaintext_auth</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">yes</span>
<span class="n">auth_mechanisms</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">plain</span>
#!<span class="n">include</span><span class="w"> </span><span class="n">auth</span><span class="o">-</span><span class="nb">system</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">ext</span>
<span class="sx">!include auth-sql.conf.ext</span>
</code></pre></div>

<p>在文件<strong>/etc/dovecot/conf.d/auth-sql.conf.ext</strong>里，设置以下参数：</p>
<div class="highlight"><pre><span></span><code><span class="n">passdb</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sql</span>
<span class="w">  </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">dovecot</span><span class="o">/</span><span class="n">dovecot</span><span class="o">-</span><span class="n">sql</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">ext</span>
<span class="p">}</span>
<span class="n">userdb</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static</span>
<span class="w">  </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uid</span><span class="o">=</span><span class="n">mail</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="n">mail</span><span class="w"> </span><span class="n">home</span><span class="o">=/</span><span class="k">var</span><span class="o">/</span><span class="n">mail</span><span class="o">/%</span><span class="n">d</span><span class="o">/%</span><span class="n">n</span>
<span class="p">}</span>
</code></pre></div>

<p>这是告诉dovecot用户的邮件保存在目录/var/mail/domainname/username下，以及如何从我们刚建立的数据库里查找密码。现在我们还需要告诉dovecot具体如何使用数据库。这样需要把下面的内容加入<strong>/etc/dovecot/dovecot-sql.conf.ext</strong>文件：</p>
<div class="highlight"><pre><span></span><code>driver = mysql
connect = host=localhost dbname=mailserver user=mailuser password=mailuserpass
default_pass_scheme = SHA512-CRYPT
password_query = SELECT email as user, password FROM virtual_users WHERE email=&#39;%u&#39;;
</code></pre></div>

<p>我们现在修改一下配置文件的权限</p>
<div class="highlight"><pre><span></span><code>chown -R mail:dovecot /etc/dovecot
chmod -R o-rwx /etc/dovecot
</code></pre></div>

<p>基本差不多了！只是还需要再多编辑几个文件。在文件<strong>/etc/dovecot/conf.d/10-master.conf</strong>里，设置以下参数：</p>
<div class="highlight"><pre><span></span><code><span class="n">service</span><span class="w"> </span><span class="n">imap</span><span class="o">-</span><span class="n">login</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">inet_listener</span><span class="w"> </span><span class="n">imap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">#port = 143</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">inet_listener</span><span class="w"> </span><span class="n">imaps</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">993</span>
<span class="w">    </span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">service</span><span class="w"> </span><span class="n">pop3</span><span class="o">-</span><span class="n">login</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="n">inet_listener</span><span class="w"> </span><span class="n">pop3</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">#port = 110</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">inet_listener</span><span class="w"> </span><span class="n">pop3s</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">#port = 995</span>
<span class="w">    </span><span class="c1">#ssl = yes</span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">service</span><span class="w"> </span><span class="n">lmtp</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">unix_listener</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">dovecot</span><span class="o">-</span><span class="n">lmtp</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0666</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mail</span>
<span class="p">}</span>

<span class="n">service</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">unix_listener</span><span class="w"> </span><span class="n">auth</span><span class="o">-</span><span class="n">userdb</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0600</span>
<span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mail</span>
<span class="w">    </span><span class="c1">#group = </span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1"># Postfix smtp-auth</span>
<span class="w">  </span><span class="n">unix_listener</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">auth</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0666</span>
<span class="w">    </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postfix</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1"># Auth process is run as this user.</span>
<span class="w">  </span><span class="c1">#user = $default_internal_user</span>
<span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dovecot</span>
<span class="p">}</span>

<span class="n">service</span><span class="w"> </span><span class="n">auth</span><span class="o">-</span><span class="n">worker</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mail</span>
<span class="p">}</span>
</code></pre></div>

<p>注意下我们把除了imaps之外所有服务的端口都设置成了0，这样可以有效地禁止这些服务。然后，在文件<strong>/etc/dovecot/conf.d/15-lda.conf</strong>里，指定一个邮箱管理地址：</p>
<div class="highlight"><pre><span></span><code><span class="nx">postmaster_address</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">postmaster</span><span class="err">@</span><span class="nx">jhausse</span><span class="p">.</span><span class="nx">net</span>
</code></pre></div>

<p>最后但很重要的一点，我们为服务器需要生成一对公钥和私钥，可以同时用于dovecot和postfix：</p>
<div class="highlight"><pre><span></span><code>openssl req -new -newkey rsa:4096 -x509 -days 365 -nodes -out &quot;/etc/ssl/certs/cloud.crt&quot; -keyout &quot;/etc/ssl/private/cloud.key&quot;
</code></pre></div>

<p>请确保你指定了服务器的完全限定域名（FQDN），在本文的例子里：</p>
<div class="highlight"><pre><span></span><code>Common Name (e.g. server FQDN or YOUR name) []:cloud.jhausse.net
</code></pre></div>

<p>如果没有的话，我们的客户端会抱怨在SSL证书里的服务器名字和所连接的服务器名字不一致。我们将通过修改配置文件<strong>/etc/dovecot/conf.d/10-ssl.conf</strong>里的如下选项来告诉dovecot使用刚生成的密钥：</p>
<div class="highlight"><pre><span></span><code>ssl = required
ssl_cert = &lt;/etc/ssl/certs/cloud.crt
ssl_key = &lt;/etc/ssl/private/cloud.key
</code></pre></div>

<h3>测试</h3>
<p>就这些了！现在开始测试postfix和dovecot服务！</p>
<div class="highlight"><pre><span></span><code>service dovecot restart
service postfix restart
</code></pre></div>

<p>在服务器上，尝试发送邮件给本地用户：</p>
<div class="highlight"><pre><span></span><code><span class="n">telnet</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="mi">25</span>

<span class="n">EHLO</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">youremail</span><span class="nv">@domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">RCPT</span><span class="w"> </span><span class="k">TO</span><span class="err">:</span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="k">data</span>
<span class="nl">Subject</span><span class="p">:</span><span class="w"> </span><span class="n">Hallo</span><span class="err">!</span>

<span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">MX</span><span class="err">!</span>

<span class="n">Cheers</span><span class="p">,</span><span class="w"> </span><span class="n">Roudy</span>
<span class="p">.</span>
<span class="n">QUIT</span>
</code></pre></div>

<p>服务器应该接受我们的邮件并返回类似消息：</p>
<div class="highlight"><pre><span></span><code><span class="mf">250</span><span class="w"> </span><span class="mf">2.0.0</span><span class="w"> </span><span class="n">Ok</span><span class="p">:</span><span class="w"> </span><span class="n">queued</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="mf">58</span><span class="n">D54101DB</span>
</code></pre></div>

<p>如果一切正常的话，检查一下<strong>/var/log/mail.log</strong>里的日志。应该有类似下面的一行：</p>
<div class="highlight"><pre><span></span><code><span class="n">Nov</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="mi">07</span><span class="err">:</span><span class="mi">57</span><span class="err">:</span><span class="mi">06</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="nl">dovecot</span><span class="p">:</span><span class="w"> </span><span class="n">lmtp</span><span class="p">(</span><span class="mi">4375</span><span class="p">,</span><span class="w"> </span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="n">mail</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">INBOX</span>
</code></pre></div>

<p>到这里一切都正常吗？不错。现在，让我尝试从不同的机器发邮件，比如说我们用来设定服务器的电脑。这次我们使用加密方式（TLS）和服务器对话：</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">25</span><span class="w"> </span><span class="o">-</span><span class="n">starttls</span><span class="w"> </span><span class="n">smtp</span>
<span class="n">EHLO</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">rcpt</span><span class="w"> </span><span class="k">to</span><span class="err">:</span><span class="n">bob</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>服务器应该有这样的响应：</p>
<div class="highlight"><pre><span></span><code><span class="mf">554</span><span class="w"> </span><span class="mf">5.7.1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">bob</span><span class="err">@</span><span class="n">gmail</span><span class="mf">.</span><span class="n">com</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">Relay</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">denied</span>
</code></pre></div>

<p>这个没问题：如果服务器能接受这封邮件而不是返回如上的拒绝消息，那意味着我们架设的postfix是一个对全世界所有垃圾邮件都开放的中继，这将完全没法使用。除了'Relay access denied'消息，你也可能会收到这样的响应：</p>
<div class="highlight"><pre><span></span><code><span class="mf">554</span><span class="w"> </span><span class="mf">5.7.1</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">unavailable</span><span class="p">;</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="err">[</span><span class="mf">87.68.61.119</span><span class="err">]</span><span class="w"> </span><span class="n">blocked</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">zen</span><span class="mf">.</span><span class="n">spamhaus</span><span class="mf">.</span><span class="ow">or</span><span class="n">g</span><span class="p">;</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="mf">.</span><span class="n">spamhaus</span><span class="mf">.</span><span class="ow">or</span><span class="n">g</span><span class="o">/</span><span class="n">query</span><span class="o">/</span><span class="n">bl</span><span class="err">?</span><span class="n">ip</span><span class="o">=</span><span class="mf">87.68.61.119</span>
</code></pre></div>

<p>意思是你正尝试从一个被标记成垃圾邮件发送者的IP地址连接服务器。我在通过普通的因特网服务提供商（ISP）连接服务器时曾收到过这样的消息。要解决这个问题，可以试着从另一个主机发起连接，比如另外一个你可以SSH登录的主机。另外一种方式是，你可以修改postfix的<strong>main.cf</strong>配置文件，不要使用Spamhous的RBL，重启postfix服务，然后再检查上面的测试是否正常。不管用哪种方式，最重要的是你要确定一个能工作的，因为我们后面马上要测试其他功能。如果你选择了重新配置postfix不使用RBL，别忘了在完成本文后重新开启RBL并重启postfix，以避免收到一些不必要的垃圾邮件。（LCTT 译者注：在国内可以使用 CASA 的 RBL：cblplus.anti-spam.org.cn，参见：<a href="http://www.anti-spam.org.cn/">http://www.anti-spam.org.cn/</a> 。）</p>
<p>现在，我们试一下往SMTP端口25发送一封有效的邮件，这是一般正常的邮件服务器用来彼此对话的方式：</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">25</span><span class="w"> </span><span class="o">-</span><span class="n">starttls</span><span class="w"> </span><span class="n">smtp</span>
<span class="n">EHLO</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">youremail</span><span class="nv">@domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">RCPT</span><span class="w"> </span><span class="k">TO</span><span class="err">:</span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span>
</code></pre></div>

<p>服务器应该有这样的响应：</p>
<div class="highlight"><pre><span></span><code>Client host rejected: Greylisted, see http://postgrey.schweikert.ch/help/jhausse.net.html
</code></pre></div>

<p>这意味着<a href="http://postgrey.schweikert.ch/">postgrey</a>工作正常。postgrey做的是用临时错误拒绝未知发送者的邮件。邮件的技术规则是要求邮件服务器尝试重新发送邮件。在5分钟后，postgrey就会接收这封邮件。一般世界范围内遵守规则的邮件服务器都会尝试为我们重复投递邮件，但大多数垃圾邮件发送者不会这样做。所以，等上5分钟，再次通过上面的命令发送一次，然后检查postfix应该正常接收了邮件。</p>
<p>之后，我们检查一下我们可以通过IMAP和dovecot对话获取刚才发送的两封邮件。</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="n">crlf</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">993</span>
<span class="mi">1</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="ss">&quot;mypassword&quot;</span>
<span class="mi">2</span><span class="w"> </span><span class="n">LIST</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="ss">&quot;*&quot;</span>
<span class="mi">3</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">INBOX</span>
<span class="mi">4</span><span class="w"> </span><span class="n">UID</span><span class="w"> </span><span class="k">fetch</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">UID</span><span class="w"> </span><span class="n">RFC822</span><span class="p">.</span><span class="k">SIZE</span><span class="w"> </span><span class="n">FLAGS</span><span class="w"> </span><span class="n">BODY</span><span class="p">.</span><span class="n">PEEK</span><span class="err">[]</span><span class="p">)</span>
<span class="mi">5</span><span class="w"> </span><span class="n">LOGOUT</span>
</code></pre></div>

<p>这里，你应该把<em>mypassword</em>替换为你自己为这个邮件账号设定的密码。如果能正常工作，基本上我们已经拥有一个能接收邮件的邮件服务器了，通过它我们可以在各种设备（PC/笔记本、平板、手机...）上收取邮件了。</p>
<h3>外发（中继）邮件</h3>
<p>但是我们不能把邮件给它发送出去，除非我们自己从服务器发送。现在我们将让postfix为我们转发邮件，但是这个只有成功登录才可以，这是为了保证邮件是由服务器上的某个有效帐号发出来的。要做到这个，我们要打开一个特殊的，全程SSL连接的，SASL鉴权的邮件提交服务。在文件<strong>/etc/postfix/master.cf</strong>里设置下面的参数：</p>
<div class="highlight"><pre><span></span><code><span class="nx">submission</span><span class="w"> </span><span class="nx">inet</span><span class="w"> </span><span class="nx">n</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="o">-</span><span class="w">       </span><span class="nx">smtpd</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">syslog_name</span><span class="p">=</span><span class="nx">postfix</span><span class="o">/</span><span class="nx">submission</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_tls_security_level</span><span class="p">=</span><span class="nx">encrypt</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_auth_enable</span><span class="p">=</span><span class="nx">yes</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_client_restrictions</span><span class="p">=</span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="nx">reject</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_type</span><span class="p">=</span><span class="nx">dovecot</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_path</span><span class="p">=</span><span class="k">private</span><span class="o">/</span><span class="nx">auth</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_sasl_security_options</span><span class="p">=</span><span class="nx">noanonymous</span>
<span class="w">  </span><span class="o">-</span><span class="nx">o</span><span class="w"> </span><span class="nx">smtpd_recipient_restrictions</span><span class="p">=</span><span class="nx">permit_sasl_authenticated</span><span class="p">,</span><span class="nx">reject_non_fqdn_recipient</span><span class="p">,</span><span class="nx">reject_unauth_destination</span>
</code></pre></div>

<p>然后重启postfix服务：</p>
<div class="highlight"><pre><span></span><code><span class="n">service</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="n">reload</span>
</code></pre></div>

<p>现在，让我们试试从一台不同的机器连接这个服务，确定一下postfix现在能够正常中继我们自己的而不是其他任何人的邮件：</p>
<div class="highlight"><pre><span></span><code>openssl s_client -connect cloud.jhausse.net:587 -starttls smtp
EHLO cloud.jhausse.net
</code></pre></div>

<p>注意一下服务器建议的'250-AUTH PLAIN'功能，在从端口25连接的时候不会出现。</p>
<div class="highlight"><pre><span></span><code><span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">asdf</span><span class="nv">@jkl</span><span class="p">.</span><span class="n">net</span>
<span class="n">rcpt</span><span class="w"> </span><span class="k">to</span><span class="err">:</span><span class="n">bob</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span>
<span class="mi">554</span><span class="w"> </span><span class="mf">5.7.1</span><span class="w"> </span><span class="o">&lt;</span><span class="n">bob</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span><span class="err">:</span><span class="w"> </span><span class="n">Relay</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">denied</span>
<span class="n">QUIT</span>
</code></pre></div>

<p>这个没问题，postfix在不认识我们的时候是不会中继邮件的。所以，首先让我们先鉴定一下自己的身份。要这样做，我们首先需要生成一个鉴权字符串：</p>
<div class="highlight"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="o">-</span><span class="n">ne</span><span class="w"> </span><span class="s1">&#39;\000roudy@jhausse.net\000mypassword&#39;</span><span class="o">|</span><span class="n">base64</span>
</code></pre></div>

<p>然后让我们尝试再次通过服务器发送邮件：</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">587</span><span class="w"> </span><span class="o">-</span><span class="n">starttls</span><span class="w"> </span><span class="n">smtp</span>
<span class="n">EHLO</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">AUTH</span><span class="w"> </span><span class="n">PLAIN</span><span class="w"> </span><span class="n">DGplYW5AMTk4NGNsb3VQLm5ldAA4bmFmNGNvNG5jOA</span><span class="o">==</span>
<span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">asdf</span><span class="nv">@jkl</span><span class="p">.</span><span class="n">net</span>
<span class="n">rcpt</span><span class="w"> </span><span class="k">to</span><span class="err">:</span><span class="n">bob</span><span class="nv">@gmail</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>现在postfix应该能正常接收。最后完成这个测试，来检查一下我们的虚拟别名能正常工作，给<a href="mailto:postmaster@jhausse.net">postmaster@jhausse.net</a>发送一封邮件然后确认一下它会被送到<a href="mailto:roudy@jhausse.net">roudy@jhausse.net</a>：</p>
<div class="highlight"><pre><span></span><code><span class="n">telnet</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="mi">25</span>
<span class="n">EHLO</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">youremail</span><span class="nv">@domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">rcpt</span><span class="w"> </span><span class="k">to</span><span class="err">:</span><span class="n">postmaster</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="k">data</span>
<span class="nl">Subject</span><span class="p">:</span><span class="w"> </span><span class="n">Virtual</span><span class="w"> </span><span class="k">alias</span><span class="w"> </span><span class="n">test</span>

<span class="n">Dear</span><span class="w"> </span><span class="n">postmaster</span><span class="p">,</span>
<span class="n">Long</span><span class="w"> </span><span class="nc">time</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">hear</span><span class="err">!</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">hope</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">MX</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="n">smoothly</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">securely</span><span class="p">.</span>
<span class="n">Yours</span><span class="w"> </span><span class="n">sincerely</span><span class="p">,</span><span class="w"> </span><span class="n">Roudy</span>
<span class="p">.</span>
<span class="n">QUIT</span>
</code></pre></div>

<p>让我们检查一下邮件是否被正常送到正确的收件箱了：</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="n">crlf</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">993</span>
<span class="mi">1</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="ss">&quot;mypassword&quot;</span>
<span class="mi">2</span><span class="w"> </span><span class="n">LIST</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="ss">&quot;*&quot;</span>
<span class="mi">3</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">INBOX</span>
<span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ow">EXISTS</span>
<span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">RECENT</span>
<span class="mi">4</span><span class="w"> </span><span class="n">LOGOUT</span>
</code></pre></div>

<p>到这里，我们已经拥有一个能正常工作的邮箱服务器了，能收发邮件。我们可以配置自己的设备来使用它。</p>
<p>PS：不要忘记再次<a href="http://linux.cn/article-5125-5.html#3_29259">试试通过端口25往自己架设的服务器上的帐号发送邮件</a>，来验证你已经没有被postgrey阻挡了。</p>
<h2>阻止垃圾邮件进入你的收件箱</h2>
<p>为了过滤垃圾邮件，我们已经使用了实时黑名单（RBL）和灰名单（postgrey）。现在我们将增加自适应垃圾邮件过滤来让我们的垃圾邮件过滤能力提高一个等级。这意味着我们将为我们的邮件服务器增加人工智能，这样它就能从经验中学习哪些邮件是垃圾哪些不是。我们将使用来实现这个功能。</p>
<div class="highlight"><pre><span></span><code>apt-get install dspam dovecot-antispam postfix-pcre dovecot-sieve
</code></pre></div>

<p>dovecot-antispam是一个安装包，可以在我们发现有邮件被dspam误分类了之后让dovecot重新更新垃圾邮件过滤器。基本上，我们所需要做的就只是把邮件放进或拿出垃圾箱。dovecot-antispam将负责调用dspam来更新过滤器。至于postfix-pcre和dovecot-sieve，我们将分别用它们来把接收的邮件传递给垃圾邮件过滤器以及自动把垃圾邮件放入用户的垃圾箱。</p>
<p>在配置文件<strong>/etc/dspam/dspam.conf</strong>里，为以下参数设置相应的值：</p>
<div class="highlight"><pre><span></span><code><span class="n">TrustedDeliveryAgent</span><span class="w"> </span><span class="s2">&quot;/usr/sbin/sendmail&quot;</span>
<span class="n">UntrustedDeliveryAgent</span><span class="w"> </span><span class="s2">&quot;/usr/lib/dovecot/deliver -d </span><span class="si">%u</span><span class="s2">&quot;</span>
<span class="n">Tokenizer</span><span class="w"> </span><span class="n">osb</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Spam</span><span class="o">-</span><span class="n">Status</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Spam</span><span class="o">-</span><span class="n">Scanned</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Virus</span><span class="o">-</span><span class="n">Scanner</span><span class="o">-</span><span class="n">Result</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Virus</span><span class="o">-</span><span class="n">Scanned</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">DKIM</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">DKIM</span><span class="o">-</span><span class="n">Signature</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">DomainKey</span><span class="o">-</span><span class="n">Signature</span>
<span class="n">IgnoreHeader</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Google</span><span class="o">-</span><span class="n">Dkim</span><span class="o">-</span><span class="n">Signature</span>
<span class="n">ParseToHeaders</span><span class="w"> </span><span class="n">on</span>
<span class="n">ChangeModeOnParse</span><span class="w"> </span><span class="n">off</span>
<span class="n">ChangeUserOnParse</span><span class="w"> </span><span class="n">full</span>
<span class="n">ServerPID</span><span class="w">               </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">dspam</span><span class="o">/</span><span class="n">dspam</span><span class="o">.</span><span class="n">pid</span>
<span class="n">ServerDomainSocketPath</span><span class="w">  </span><span class="s2">&quot;/var/run/dspam/dspam.sock&quot;</span>
<span class="n">ClientHost</span><span class="w">      </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">dspam</span><span class="o">/</span><span class="n">dspam</span><span class="o">.</span><span class="n">sock</span>
</code></pre></div>

<p>然后，在配置文件<strong>/etc/dspam/default.prefs</strong>里，把以下参数改为：</p>
<div class="highlight"><pre><span></span><code><span class="n">spamAction</span><span class="o">=</span><span class="n">deliver</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">quarantine</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">deliver</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">default</span><span class="o">:</span><span class="n">quarantine</span>
<span class="n">signatureLocation</span><span class="o">=</span><span class="n">headers</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">default</span><span class="o">:</span><span class="n">message</span>
<span class="n">showFactors</span><span class="o">=</span><span class="n">on</span>
</code></pre></div>

<p>现在我们需要把dspam连接到postfix和dovecot上，在配置文件<strong>/etc/postfix/master.cf</strong>最后添加这样两行：</p>
<div class="highlight"><pre><span></span><code>dspam<span class="w">     </span>unix<span class="w">  </span>-<span class="w">       </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>10<span class="w">      </span>pipe
<span class="w">  </span>flags=Ru<span class="w"> </span>user=dspam<span class="w"> </span>argv=/usr/bin/dspam<span class="w"> </span>--deliver=innocent,spam<span class="w"> </span>--user<span class="w"> </span><span class="nv">$recipient</span><span class="w"> </span>-i<span class="w"> </span>-f<span class="w"> </span><span class="nv">$sender</span><span class="w"> </span>--<span class="w"> </span><span class="nv">$recipient</span>
dovecot<span class="w">   </span>unix<span class="w">  </span>-<span class="w">       </span>n<span class="w">       </span>n<span class="w">       </span>-<span class="w">       </span>-<span class="w">       </span>pipe
<span class="w">  </span>flags=DRhu<span class="w"> </span>user=mail:mail<span class="w"> </span>argv=/usr/lib/dovecot/deliver<span class="w"> </span>-f<span class="w"> </span><span class="cp">${</span><span class="n">sender</span><span class="cp">}</span><span class="w"> </span>-d<span class="w"> </span><span class="cp">${</span><span class="n">recipient</span><span class="cp">}</span>
</code></pre></div>

<p>现在我们将告诉postfix通过dspam来过滤所有提交给服务器端口25（一般的SMTP通信）的新邮件，除非该邮件是从服务器本身发出（permit_mynetworks）。注意下我们通过SASL鉴权提交给postfix的邮件不会通过dspam过滤，因为我们在前面部分里为这种方式设定了独立的提交服务。编辑文件<strong>/etc/postfix/main.cf</strong>将选项<em>**</em>smtpd<em>_</em>client_restrictions**改为如下内容：</p>
<div class="highlight"><pre><span></span><code>smtpd_client_restrictions = permit_mynetworks, reject_rbl_client zen.spamhaus.org, check_policy_service inet:127.0.0.1:10023, check_client_access pcre:/etc/postfix/dspam_filter_access
</code></pre></div>

<p>在文件末尾，还需要增加：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> For DSPAM, only scan one mail at a time
dspam_destination_recipient_limit = 1
</code></pre></div>

<p>现在我们需要指定我们定义的过滤器。基本上，我们将告诉postfix把所有邮件（如下用 /./ 代表）通过unix套接字发给dspam。创建一个新文件<strong>/etc/postfix/dspam_filter_access</strong>并把下面一行写进去：</p>
<div class="highlight"><pre><span></span><code>/./   FILTER dspam:unix:/run/dspam/dspam.sock
</code></pre></div>

<p>这是postfix部分的配置。现在让我们为dovecot设置垃圾过滤。在文件<strong>/etc/dovecot/conf.d/20-imap.conf</strong>里，修改<strong>imap mail_plugin</strong>插件参数为下面的方式：</p>
<div class="highlight"><pre><span></span><code>mail_plugins = $mail_plugins antispam
</code></pre></div>

<p>并为lmtp增加一个部分：</p>
<div class="highlight"><pre><span></span><code><span class="n">protocol</span><span class="w"> </span><span class="n">lmtp</span><span class="w"> </span><span class="p">{</span>
<span class="c1"># Space separated list of plugins to load (default is global mail_plugins).</span>
<span class="w">  </span><span class="n">mail_plugins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">mail_plugins</span><span class="w"> </span><span class="n">sieve</span>
<span class="p">}</span>
</code></pre></div>

<p>我们现在设置dovecot-antispam插件。编辑文件<strong>/etc/dovecot/conf.d/90-plugin.conf</strong>并把以下内容添加到插件部分：</p>
<div class="highlight"><pre><span></span><code>plugin {
  ...
  # Antispam (DSPAM)
  antispam_backend = dspam
  antispam_allow_append_to_spam = YES
  antispam_spam = Junk;Spam
  antispam_trash = Trash;trash
  antispam_signature = X-DSPAM-Signature
  antispam_signature_missing = error
  antispam_dspam_binary = /usr/bin/dspam
  antispam_dspam_args = --user;%u;--deliver=;--source=error
  antispam_dspam_spam = --class=spam
  antispam_dspam_notspam = --class=innocent
  antispam_dspam_result_header = X-DSPAM-Result
}
</code></pre></div>

<p>然后在文件<strong>/etc/dovecot/conf.d/90-sieve.conf</strong>里指定默认的sieve脚本，这个将对服务器上所有用户有效：</p>
<div class="highlight"><pre><span></span><code>sieve_default = /etc/dovecot/default.sieve
</code></pre></div>

<p>什么是sieve以及为什么我们需要为所有用户设置一个默认脚本？sieve可以在IMAP服务器上为我们自动处理任务。在我们的例子里，我们想让所有被确定为垃圾的邮件移到垃圾箱而不是收件箱里。我们希望这是服务器上所有用户的默认行为；这是为什么我们把这个脚本设为默认脚本。现在让我们来创建这个脚本，建立一个新文件<strong>/etc/dovecot/default.sieve</strong>并写入以下内容：</p>
<div class="highlight"><pre><span></span><code><span class="n">require</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;regex&quot;, &quot;fileinto&quot;, &quot;imap4flags&quot;</span><span class="o">]</span><span class="p">;</span>
<span class="err">#</span><span class="w"> </span><span class="k">Catch</span><span class="w"> </span><span class="n">mail</span><span class="w"> </span><span class="n">tagged</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Spam</span><span class="p">,</span><span class="w"> </span><span class="ow">except</span><span class="w"> </span><span class="n">Spam</span><span class="w"> </span><span class="n">retrained</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">delivered</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">mailbox</span>
<span class="k">if</span><span class="w"> </span><span class="n">allof</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="err">:</span><span class="n">regex</span><span class="w"> </span><span class="ss">&quot;X-DSPAM-Result&quot;</span><span class="w"> </span><span class="ss">&quot;^(Spam|Virus|Bl[ao]cklisted)$&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="ow">not</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="err">:</span><span class="k">contains</span><span class="w"> </span><span class="ss">&quot;X-DSPAM-Reclassified&quot;</span><span class="w"> </span><span class="ss">&quot;Innocent&quot;</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Mark</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">read</span>
<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">setflag</span><span class="w"> </span><span class="ss">&quot;\\Seen&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Move</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Junk</span><span class="w"> </span><span class="n">folder</span>
<span class="w">  </span><span class="n">fileinto</span><span class="w"> </span><span class="ss">&quot;Junk&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Stop</span><span class="w"> </span><span class="n">processing</span><span class="w"> </span><span class="n">here</span>
<span class="w">  </span><span class="n">stop</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>

<p>现在我们需要编译这个脚本好让dovecot能运行它。我们也需要给它合适的权限。</p>
<div class="highlight"><pre><span></span><code>cd /etc/dovecot
sievec .
chown mail.dovecot default.siev*
chmod 0640 default.sieve
chmod 0750 default.svbin
</code></pre></div>

<p>最后，我们需要修改dspam需要读取的两个postfix配置文件的权限：</p>
<div class="highlight"><pre><span></span><code>chmod 0644 /etc/postfix/dynamicmaps.cf /etc/postfix/main.cf
</code></pre></div>

<p>就这些！让我们重启dovecot和postfix服务：</p>
<div class="highlight"><pre><span></span><code>service dovecot restart
service postfix restart
</code></pre></div>

<h3>测试</h3>
<p>然后通过从远程主机（比如我们用来设定服务器的电脑）连接服务器来测试一下反垃圾邮件：</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">25</span><span class="w"> </span><span class="o">-</span><span class="n">starttls</span><span class="w"> </span><span class="n">smtp</span>
<span class="n">EHLO</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="n">MAIL</span><span class="w"> </span><span class="k">FROM</span><span class="err">:</span><span class="n">youremail</span><span class="nv">@domain</span><span class="p">.</span><span class="n">com</span>
<span class="n">rcpt</span><span class="w"> </span><span class="k">to</span><span class="err">:</span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span>
<span class="k">DATA</span>
<span class="nl">Subject</span><span class="p">:</span><span class="w"> </span><span class="n">DSPAM</span><span class="w"> </span><span class="n">test</span>

<span class="n">Hi</span><span class="w"> </span><span class="n">Roudy</span><span class="p">,</span><span class="w"> </span><span class="n">how</span><span class="err">&#39;</span><span class="n">d</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="ow">like</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">eat</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">ham</span><span class="w"> </span><span class="n">tonight</span><span class="vm">?</span><span class="w"> </span><span class="n">Yours</span><span class="p">,</span><span class="w"> </span><span class="n">J</span>
<span class="p">.</span>
<span class="n">QUIT</span>
</code></pre></div>

<p>让我们检查一下邮件是否已经送到：</p>
<div class="highlight"><pre><span></span><code><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="n">crlf</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">jhausse</span><span class="p">.</span><span class="nl">net</span><span class="p">:</span><span class="mi">993</span>
<span class="mi">1</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">roudy</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="ss">&quot;mypassword&quot;</span>
<span class="mi">2</span><span class="w"> </span><span class="n">LIST</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="ss">&quot;*&quot;</span>
<span class="mi">3</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">INBOX</span>
<span class="mi">4</span><span class="w"> </span><span class="n">UID</span><span class="w"> </span><span class="k">fetch</span><span class="w"> </span><span class="mi">3</span><span class="err">:</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">UID</span><span class="w"> </span><span class="n">RFC822</span><span class="p">.</span><span class="k">SIZE</span><span class="w"> </span><span class="n">FLAGS</span><span class="w"> </span><span class="n">BODY</span><span class="p">.</span><span class="n">PEEK</span><span class="err">[]</span><span class="p">)</span>
</code></pre></div>

<p>这个应该返回SPAM为邮件增加了一组标记的数据，看上去像这样：</p>
<div class="highlight"><pre><span></span><code>X-DSPAM-Result: Innocent
X-DSPAM-Processed: Sun Oct  5 16:25:48 2014
X-DSPAM-Confidence: 1.0000
X-DSPAM-Probability: 0.0023
X-DSPAM-Signature: 5431710c178911166011737
X-DSPAM-Factors: 27,
    Received*Postfix+with, 0.40000,
    Received*with+#+id, 0.40000,
    like+#+#+#+ham, 0.40000,
    some+#+tonight, 0.40000,
    Received*certificate+requested, 0.40000,
    Received*client+certificate, 0.40000,
    Received*for+roudy, 0.40000,
    Received*Sun+#+#+#+16, 0.40000,
    Received*Sun+#+Oct, 0.40000,
    Received*roudy+#+#+#+Oct, 0.40000,
    eat+some, 0.40000,
    Received*5+#+#+16, 0.40000,
    Received*cloud.jhausse.net+#+#+#+id, 0.40000,
    Roudy+#+#+#+to, 0.40000,
    Received*Oct+#+16, 0.40000,
    to+#+#+ham, 0.40000,
    Received*No+#+#+requested, 0.40000,
    Received*jhausse.net+#+#+Oct, 0.40000,
    Received*256+256, 0.40000,
    like+#+#+some, 0.40000,
    Received*ESMTPS+id, 0.40000,
    how&#39;d+#+#+to, 0.40000,
    tonight+Yours, 0.40000,
    Received*with+cipher, 0.40000
5 LOGOUT
</code></pre></div>

<p>很好！你现在已经为你服务器上的用户配置好自适应垃圾邮件过滤。当然，每个用户将需要在开始的几周里培训过滤器。要标记一则信息为垃圾，只需要在你的任意设备（电脑，平板，手机）上将它移动到叫“垃圾箱”或“废纸篓”的目录里。否则它将被标记为有用。</p>
<h2>确保你发出的邮件能通过垃圾邮件过滤器</h2>
<p>这个部分我们的目标是让我们的邮件服务器能尽量干净地出现在世界上，并让垃圾邮件发送者们更难以我们的名义发邮件。作为附加效果，这也有助于让我们的邮件能通过其他邮件服务器的垃圾邮件过滤器。</p>
<h3>发送者策略框架（SPF）</h3>
<p>发送者策略框架（SPF）是你添加到自己服务器区域里的一份记录，声明了整个因特网上哪些邮件服务器能以你的域名发邮件。设置非常简单，使用<a href="http://www.microsoft.com/mscorp/safety/content/technologies/senderid/wizard/">microsoft.com</a>上的SPF向导来生成你的SPF记录，然后作为一个TXT记录添加到自己的服务器区域里。看上去像这样：</p>
<div class="highlight"><pre><span></span><code>jhausse.net.    300 IN  TXT v=spf1 mx mx:cloud.jhausse.net -all
</code></pre></div>

<h3>反向PTR</h3>
<p>我们<a href="http://linux.cn/article-5125-8.html#3_48021">之前</a>在本文里讨论过这个问题，建议你为自己的服务器正确地设置反向DNS，这样对服务器IP地址的反向查询能返回你服务器的实际名字。</p>
<h3>OpenDKIM</h3>
<p>当我们激活<a href="http://opendkim.org/opendkim-README">OpenDKIM</a>后，postfix会用密钥为每封发出去的邮件签名。然后我们将把这个密钥存储在DNS域中。这样的话，世界上任意一个邮件服务器都能够检验邮件是否真的是我们发出的，或是由垃圾邮件发送者伪造的。让我们先安装opendkim：</p>
<div class="highlight"><pre><span></span><code><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">opendkim</span><span class="w"> </span><span class="n">opendkim</span><span class="o">-</span><span class="n">tools</span>
</code></pre></div>

<p>然后按如下方式编辑<strong>/etc/opendkim.conf</strong>文件的配置：</p>
<div class="highlight"><pre><span></span><code><span class="c1">##</span>
<span class="c1">## opendkim.conf -- configuration file for OpenDKIM filter</span>
<span class="c1">##</span>
<span class="n">Canonicalization</span><span class="w">        </span><span class="n">relaxed</span><span class="o">/</span><span class="n">relaxed</span>
<span class="n">ExternalIgnoreList</span><span class="w">      </span><span class="n">refile</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">TrustedHosts</span>
<span class="n">InternalHosts</span><span class="w">           </span><span class="n">refile</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">TrustedHosts</span>
<span class="n">KeyTable</span><span class="w">                </span><span class="n">refile</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">KeyTable</span>
<span class="n">LogWhy</span><span class="w">                  </span><span class="n">Yes</span>
<span class="n">MinimumKeyBits</span><span class="w">          </span><span class="mi">1024</span>
<span class="n">Mode</span><span class="w">                    </span><span class="n">sv</span>
<span class="n">PidFile</span><span class="w">                 </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">opendkim</span><span class="o">.</span><span class="n">pid</span>
<span class="n">SigningTable</span><span class="w">            </span><span class="n">refile</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">opendkim</span><span class="o">/</span><span class="n">SigningTable</span>
<span class="n">Socket</span><span class="w">                  </span><span class="n">inet</span><span class="p">:</span><span class="mi">8891</span><span class="err">@</span><span class="n">localhost</span>
<span class="n">Syslog</span><span class="w">                  </span><span class="n">Yes</span>
<span class="n">SyslogSuccess</span><span class="w">           </span><span class="n">Yes</span>
<span class="n">TemporaryDirectory</span><span class="w">      </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">UMask</span><span class="w">                   </span><span class="mi">022</span>
<span class="n">UserID</span><span class="w">                  </span><span class="n">opendkim</span><span class="p">:</span><span class="n">opendkim</span>
</code></pre></div>

<p>我们还需要几个额外的文件，需保存在目录<strong>/etc/opendkim</strong>里：</p>
<div class="highlight"><pre><span></span><code>mkdir -pv /etc/opendkim/
cd /etc/opendkim/
</code></pre></div>

<p>让我们建立新文件<strong>/etc/opendkim/TrustedHosts</strong>并写入以下内容：</p>
<div class="highlight"><pre><span></span><code><span class="mf">127.0.0.1</span>
</code></pre></div>

<p>建立新文件<strong>/etc/opendkim/KeyTable</strong>并写入以下内容：</p>
<div class="highlight"><pre><span></span><code>cloudkey jhausse.net:mail:/etc/opendkim/mail.private
</code></pre></div>

<p>这会告诉OpenDKIM我们希望使用一个名叫'cloudkey'的加密密钥，它的内容在文件/etc/opendkim/mail.private里。我们建立另一个名叫<strong>/etc/opendkim/SigningTable</strong>的文件然后写入下面这一行：</p>
<div class="highlight"><pre><span></span><code><span class="o">*</span><span class="nv">@jhausse</span><span class="p">.</span><span class="n">net</span><span class="w"> </span><span class="n">cloudkey</span>
</code></pre></div>

<p>这会告诉OpenDKIM每封从jhausse.net域发出的邮件都应该用'cloudkey'密钥签名。如果我们还有其他域希望也能签名，我们也可以在这里添加。</p>
<p>下一步是生成密钥并修改OpenDKIM配置文件的权限。</p>
<div class="highlight"><pre><span></span><code>opendkim-genkey -r -s mail [-t]
chown -Rv opendkim:opendkim /etc/opendkim
chmod 0600 /etc/opendkim/*
chmod 0700 /etc/opendkim
</code></pre></div>

<p>一开始，最好使用-t开关，这样会通知其他邮件服务器你只是在测试模式下，这样他们就不会丢弃基于你的OpenDKIM签名的邮件（目前来说）。你可以从mail.txt文件里看到OpenDKIM密钥：</p>
<div class="highlight"><pre><span></span><code>cat mail.txt
</code></pre></div>

<p>然后把它作为一个TXT记录添加到区域文件里，应该是类似这样的：</p>
<div class="highlight"><pre><span></span><code>mail._domainkey.cloud1984.net.  300 IN TXT  v=DKIM1; k=rsa; p=MIGfMA0GCSqG...
</code></pre></div>

<p>最后，我们需要告诉postfix来为发出的邮件签名。在文件/etc/postfix/main.cf末尾，添加：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> Now for OpenDKIM: we&#39;ll sign all outgoing emails
smtpd_milters = inet:127.0.0.1:8891
non_smtpd_milters = $smtpd_milters
milter_default_action = accept
</code></pre></div>

<p>然后重启相关服务：</p>
<div class="highlight"><pre><span></span><code><span class="n">service</span><span class="w"> </span><span class="n">postfix</span><span class="w"> </span><span class="n">reload</span>
<span class="n">service</span><span class="w"> </span><span class="n">opendkim</span><span class="w"> </span><span class="n">restart</span>
</code></pre></div>

<h3>测试</h3>
<p>现在让我们测试一下是否能找到我们的OpenDKIM公钥并和私钥匹配：</p>
<div class="highlight"><pre><span></span><code>opendkim-testkey -d jhausse.net -s mail -k mail.private -vvv
</code></pre></div>

<p>这个应该返回：</p>
<div class="highlight"><pre><span></span><code>opendkim-testkey: key OK
</code></pre></div>

<p>这个你可能需要等一会直到域名服务器重新加载该区域（对于Linode，每15分钟会更新一次）。你可以用<strong>dig</strong>来检查区域是否已经重新加载。</p>
<p>如果这个没问题，让我们测试一下其他服务器能验证我们的OpenDKIM签名和SPF记录。要做这个，我们可以用<a href="http://www.brandonchecketts.com/emailtest.php">Brandon Checkett的邮件测试系统</a>。发送一封邮件到<a href="http://www.brandonchecketts.com/emailtest.php">Brandon的网页</a>上提供的测试地址，我们可以在服务器上运行下面的命令</p>
<div class="highlight"><pre><span></span><code><span class="n">mail</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">CloudCheck</span><span class="w"> </span><span class="n">ihAdmTBmUH</span><span class="nv">@www</span><span class="p">.</span><span class="n">brandonchecketts</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>

<p>在Brandon的网页上，我们应该可以在'DKIM Signature'部分里看到<strong>result = pass</strong>的文字，以及在'SPF Information'部分看到<strong>Result: pass</strong>的文字。如果我们的邮件通过这个测试，只要不加-t开关重新生成OpenDKIM密钥，上传新的密钥到区域文件里，然后重新测试检查是否仍然可以通过这些测试。如果可以的话，恭喜！你已经在你的服务器上成功配置好OpenDKIM和SPF了！</p>
<h2>使用Owncloud提供日历，联系人，文件服务并通过Roundcube配置网页邮件</h2>
<p>既然我们已经拥有了一流的邮件服务器，让我们再为它增加在云上保存通讯录，日程表和文件的能力。这些是<a href="http://owncloud.org/">Owncloud</a>所提供的非常赞的服务。在这个弄好后，我们还会设置一个网页邮件，这样就算你没带任何电子设备出去旅行时，或者说在你的手机或笔记本没电的情况下，也可以通过网吧来检查邮件。</p>
<p>安装Owncloud非常直观，而且在<a href="http://owncloud.org/install/">这里</a>有非常好的介绍。在Debian系统里，归根结底就是把owncloud的仓库添加到apt源里，下载Owncloud的发行密钥并安装到apt钥匙链中，然后通过apt-get安装Owncloud：</p>
<div class="highlight"><pre><span></span><code><span class="n">echo</span><span class="w"> </span><span class="s1">&#39;deb http://download.opensuse.org/repositories/isv:/ownCloud:/community/Debian_7.0/ /&#39;</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">owncloud</span><span class="o">.</span><span class="n">list</span>
<span class="n">wget</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">opensuse</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">isv</span><span class="p">:</span><span class="n">ownCloud</span><span class="p">:</span><span class="n">community</span><span class="o">/</span><span class="n">Debian_6</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">Release</span><span class="o">.</span><span class="n">key</span>
<span class="n">apt</span><span class="o">-</span><span class="n">key</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Release</span><span class="o">.</span><span class="n">key</span><span class="w"> </span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">apache2</span><span class="w"> </span><span class="n">owncloud</span><span class="w"> </span><span class="n">roundcube</span>
</code></pre></div>

<p>在有提示的时候，选择<strong>dbconfig</strong>并设置<strong>roundcube</strong>使用<strong>mysql</strong>。然后，提供一下mysql的root密码并为roundcube的mysql用户设置一个漂亮的密码。然后，按如下方式编辑roundcube的配置文件<strong>/etc/roundcube/main.inc.php</strong>，这样登录roundcube默认会使用你的IMAP服务器：</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="nt">rcmail_config</span><span class="cp">[</span><span class="s1">&#39;default_host&#39;</span><span class="cp">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ssl://localhost&#39;</span><span class="o">;</span>
<span class="o">$</span><span class="nt">rcmail_config</span><span class="cp">[</span><span class="s1">&#39;default_port&#39;</span><span class="cp">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">993</span><span class="o">;</span>
</code></pre></div>

<p>现在我们来配置一下apache2网页服务器增加SSL支持，这样我们可以和Owncloud和Roundcube对话时使用加密的方式传输我们的密码和数据。让我们打开Apache的SSL模块：</p>
<div class="highlight"><pre><span></span><code>a2enmod ssl
</code></pre></div>

<p>然后编辑文件<strong>/etc/apache2/ports.conf</strong>并设定以下参数：</p>
<div class="highlight"><pre><span></span><code>NameVirtualHost<span class="w"> </span>*:80<span class="w">   </span>
Listen<span class="w"> </span>80<span class="w">   </span>
ServerName<span class="w"> </span>[www.jhausse.net](http://www.jhausse.net)<span class="w">  </span>
<span class="nt">&lt;IfModule</span><span class="w"> </span><span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
<span class="w">    </span>#<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>add<span class="w"> </span>NameVirtualHost<span class="w"> </span>*:443<span class="w"> </span>here,<span class="w"> </span>you<span class="w"> </span>will<span class="w"> </span>also<span class="w"> </span>have<span class="w"> </span>to<span class="w"> </span>change
<span class="w">    </span>#<span class="w"> </span>the<span class="w"> </span>VirtualHost<span class="w"> </span>statement<span class="w"> </span>in<span class="w"> </span>/etc/apache2/sites-available/default-ssl
<span class="w">    </span>#<span class="w"> </span>to<span class="w"> </span><span class="nt">&lt;VirtualHost</span><span class="w"> </span><span class="err">*:443</span><span class="nt">&gt;</span>
<span class="w">    </span>#<span class="w"> </span>Server<span class="w"> </span>Name<span class="w"> </span>Indication<span class="w"> </span>for<span class="w"> </span>SSL<span class="w"> </span>named<span class="w"> </span>virtual<span class="w"> </span>hosts<span class="w"> </span>is<span class="w"> </span>currently<span class="w"> </span>not
<span class="w">    </span>#<span class="w"> </span>supported<span class="w"> </span>by<span class="w"> </span>MSIE<span class="w"> </span>on<span class="w"> </span>Windows<span class="w"> </span>XP.
<span class="w">    </span>NameVirtualHost<span class="w"> </span>*:443
<span class="w">    </span>Listen<span class="w"> </span>443
<span class="nt">&lt;/IfModule&gt;</span>

<span class="nt">&lt;IfModule</span><span class="w"> </span><span class="err">mod_gnutls.c</span><span class="nt">&gt;</span>
<span class="w">    </span>Listen<span class="w"> </span>443
<span class="nt">&lt;/IfModule&gt;</span>
</code></pre></div>

<p>我们将在目录<strong>/var/www</strong>下为服务器加密连接<strong><a href="https://www.jhausse.net">https://www.jhausse.net</a></strong>设定一个默认网站。编辑文件<strong>/etc/apache2/sites-available/default-ssl</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;VirtualHost</span><span class="w"> </span><span class="err">_default_:443</span><span class="nt">&gt;</span>
<span class="w">        </span>ServerAdmin<span class="w"> </span>webmaster@localhost

<span class="w">        </span>DocumentRoot<span class="w"> </span>/var/www
<span class="w">        </span>ServerName<span class="w"> </span>www.jhausse.net
<span class="w">        </span>[...]
<span class="w">        </span><span class="nt">&lt;Directory</span><span class="w"> </span><span class="err">/var/www/owncloud</span><span class="nt">&gt;</span>
<span class="w">          </span>Deny<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>
<span class="w">        </span>[...]
<span class="w">        </span>SSLCertificateFile<span class="w">    </span>/etc/ssl/certs/cloud.crt
<span class="w">        </span>SSLCertificateKeyFile<span class="w"> </span>/etc/ssl/private/cloud.key
<span class="w">        </span>[...]
<span class="nt">&lt;/VirtualHost&gt;</span>
</code></pre></div>

<p>然后让我们同时也在目录<strong>/var/www</strong>下设定一个非加密连接<strong><a href="http://www.jhausse.net">http://www.jhausse.net</a></strong>的默认网站。编辑文件<strong>/etc/apache2/sites-available/default</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;VirtualHost</span><span class="w"> </span><span class="err">_default_:443</span><span class="nt">&gt;</span>
<span class="w">        </span>DocumentRoot<span class="w"> </span>/var/www
<span class="w">        </span>ServerName<span class="w"> </span>www.jhausse.net
<span class="w">        </span>[...]
<span class="w">        </span><span class="nt">&lt;Directory</span><span class="w"> </span><span class="err">/var/www/owncloud</span><span class="nt">&gt;</span>
<span class="w">          </span>Deny<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</code></pre></div>

<p>这样的话，我们通过把文件放到/var/www目录下让www.jhausse.net使用它们提供网站服务。名叫'Deny from all'的指令可以阻止通过www.jhausse.net访问Owncloud：我们将设定通过<strong><a href="https://cloud.jhausse.net">https://cloud.jhausse.net</a></strong>来正常访问。</p>
<p>现在我们将设定网页邮件（roundcube），让它可以通过网址<strong><a href="https://webmail.jhausse.net">https://webmail.jhausse.net</a></strong>来访问。编辑文件<strong>/etc/apache2/sites-available/roundcube</strong>并写入以下内容：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;IfModule</span> <span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
<span class="nt">&lt;VirtualHost</span> <span class="err">*:443</span><span class="nt">&gt;</span>
<span class="w">        </span>ServerAdmin<span class="w"> </span>webmaster@localhost

<span class="w">        </span>DocumentRoot<span class="w"> </span>/var/lib/roundcube
<span class="w">    </span>#<span class="w"> </span>The<span class="w"> </span>host<span class="w"> </span>name<span class="w"> </span>under<span class="w"> </span>which<span class="w"> </span>you&#39;d<span class="w"> </span>like<span class="w"> </span>to<span class="w"> </span>access<span class="w"> </span>the<span class="w"> </span>webmail
<span class="w">        </span>ServerName<span class="w"> </span>webmail.jhausse.net
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="nt">/&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>FollowSymLinks
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span>ErrorLog<span class="w"> </span><span class="cp">${</span><span class="n">APACHE_LOG_DIR</span><span class="cp">}</span>/error.log

<span class="w">        </span>#<span class="w"> </span>Possible<span class="w"> </span>values<span class="w"> </span>include:<span class="w"> </span>debug,<span class="w"> </span>info,<span class="w"> </span>notice,<span class="w"> </span>warn,<span class="w"> </span>error,<span class="w"> </span>crit,
<span class="w">        </span>#<span class="w"> </span>alert,<span class="w"> </span>emerg.
<span class="w">        </span>LogLevel<span class="w"> </span>warn

<span class="w">        </span>CustomLog<span class="w"> </span><span class="cp">${</span><span class="n">APACHE_LOG_DIR</span><span class="cp">}</span>/ssl_access.log<span class="w"> </span>combined

<span class="w">        </span>#<span class="w">   </span>SSL<span class="w"> </span>Engine<span class="w"> </span>Switch:
<span class="w">        </span>#<span class="w">   </span>Enable/Disable<span class="w"> </span>SSL<span class="w"> </span>for<span class="w"> </span>this<span class="w"> </span>virtual<span class="w"> </span>host.
<span class="w">        </span>SSLEngine<span class="w"> </span>on

<span class="w">        </span>#<span class="w"> </span>do<span class="w"> </span>not<span class="w"> </span>allow<span class="w"> </span>unsecured<span class="w"> </span>connections
<span class="w">        </span>#<span class="w"> </span>SSLRequireSSL
<span class="w">        </span>SSLCipherSuite<span class="w"> </span>HIGH:MEDIUM

<span class="w">        </span>#<span class="w">   </span>A<span class="w"> </span>self-signed<span class="w"> </span>(snakeoil)<span class="w"> </span>certificate<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>created<span class="w"> </span>by<span class="w"> </span>installing
<span class="w">        </span>#<span class="w">   </span>the<span class="w"> </span>ssl-cert<span class="w"> </span>package.<span class="w"> </span>See
<span class="w">        </span>#<span class="w">   </span>/usr/share/doc/apache2.2-common/README.Debian.gz<span class="w"> </span>for<span class="w"> </span>more<span class="w"> </span>info.
<span class="w">        </span>#<span class="w">   </span>If<span class="w"> </span>both<span class="w"> </span>key<span class="w"> </span>and<span class="w"> </span>certificate<span class="w"> </span>are<span class="w"> </span>stored<span class="w"> </span>in<span class="w"> </span>the<span class="w"> </span>same<span class="w"> </span>file,<span class="w"> </span>only<span class="w"> </span>the
<span class="w">        </span>#<span class="w">   </span>SSLCertificateFile<span class="w"> </span>directive<span class="w"> </span>is<span class="w"> </span>needed.
<span class="w">        </span>SSLCertificateFile<span class="w">    </span>/etc/ssl/certs/cloud.crt
<span class="w">        </span>SSLCertificateKeyFile<span class="w"> </span>/etc/ssl/private/cloud.key

<span class="w">        </span>#<span class="w"> </span>Those<span class="w"> </span>aliases<span class="w"> </span>do<span class="w"> </span>not<span class="w"> </span>work<span class="w"> </span>properly<span class="w"> </span>with<span class="w"> </span>several<span class="w"> </span>hosts<span class="w"> </span>on<span class="w"> </span>your<span class="w"> </span>apache<span class="w"> </span>server
<span class="w">        </span>#<span class="w"> </span>Uncomment<span class="w"> </span>them<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>it<span class="w"> </span>or<span class="w"> </span>adapt<span class="w"> </span>them<span class="w"> </span>to<span class="w"> </span>your<span class="w"> </span>configuration
<span class="w">        </span>Alias<span class="w"> </span>/program/js/tiny_mce/<span class="w"> </span>/usr/share/tinymce/www/

<span class="w">        </span>#<span class="w"> </span>Access<span class="w"> </span>to<span class="w"> </span>tinymce<span class="w"> </span>files
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">&quot;/usr/share/tinymce/www/&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>Indexes<span class="w"> </span>MultiViews<span class="w"> </span>FollowSymLinks
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">                </span>Order<span class="w"> </span>allow,deny
<span class="w">                </span>allow<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/var/lib/roundcube</span><span class="nt">/&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>+FollowSymLinks
<span class="w">                </span>#<span class="w"> </span>This<span class="w"> </span>is<span class="w"> </span>needed<span class="w"> </span>to<span class="w"> </span>parse<span class="w"> </span>/var/lib/roundcube/.htaccess.<span class="w"> </span>See<span class="w"> </span>its
<span class="w">                </span>#<span class="w"> </span>content<span class="w"> </span>before<span class="w"> </span>setting<span class="w"> </span>AllowOverride<span class="w"> </span>to<span class="w"> </span>None.
<span class="w">                </span>AllowOverride<span class="w"> </span>All
<span class="w">                </span>order<span class="w"> </span>allow,deny
<span class="w">                </span>allow<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span>#<span class="w"> </span>Protecting<span class="w"> </span>basic<span class="w"> </span>directories:
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/var/lib/roundcube/config</span><span class="nt">&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>-FollowSymLinks
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/var/lib/roundcube/temp</span><span class="nt">&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>-FollowSymLinks
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">                </span>Order<span class="w"> </span>allow,deny
<span class="w">                </span>Deny<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/var/lib/roundcube/logs</span><span class="nt">&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>-FollowSymLinks
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">                </span>Order<span class="w"> </span>allow,deny
<span class="w">                </span>Deny<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span><span class="nt">&lt;FilesMatch</span> <span class="err">&quot;\.(cgi|shtml|phtml|php)$&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span>SSLOptions<span class="w"> </span>+StdEnvVars
<span class="w">        </span><span class="nt">&lt;/FilesMatch&gt;</span>
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/usr/lib/cgi-bin</span><span class="nt">&gt;</span>
<span class="w">                </span>SSLOptions<span class="w"> </span>+StdEnvVars
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>
<span class="w">        </span>#<span class="w">   </span>SSL<span class="w"> </span>Protocol<span class="w"> </span>Adjustments:
<span class="w">        </span>#<span class="w">   </span>The<span class="w"> </span>safe<span class="w"> </span>and<span class="w"> </span>default<span class="w"> </span>but<span class="w"> </span>still<span class="w"> </span>SSL/TLS<span class="w"> </span>standard<span class="w"> </span>compliant<span class="w"> </span>shutdown
<span class="w">        </span>#<span class="w">   </span>approach<span class="w"> </span>is<span class="w"> </span>that<span class="w"> </span>mod_ssl<span class="w"> </span>sends<span class="w"> </span>the<span class="w"> </span>close<span class="w"> </span>notify<span class="w"> </span>alert<span class="w"> </span>but<span class="w"> </span>doesn&#39;t<span class="w"> </span>wait<span class="w"> </span>for
<span class="w">        </span>#<span class="w">   </span>the<span class="w"> </span>close<span class="w"> </span>notify<span class="w"> </span>alert<span class="w"> </span>from<span class="w"> </span>client.<span class="w"> </span>When<span class="w"> </span>you<span class="w"> </span>need<span class="w"> </span>a<span class="w"> </span>different<span class="w"> </span>shutdown
<span class="w">        </span>#<span class="w">   </span>approach<span class="w"> </span>you<span class="w"> </span>can<span class="w"> </span>use<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>variables:
<span class="w">        </span>#<span class="w">   </span>o<span class="w"> </span>ssl-unclean-shutdown:
<span class="w">        </span>#<span class="w">     </span>This<span class="w"> </span>forces<span class="w"> </span>an<span class="w"> </span>unclean<span class="w"> </span>shutdown<span class="w"> </span>when<span class="w"> </span>the<span class="w"> </span>connection<span class="w"> </span>is<span class="w"> </span>closed,<span class="w"> </span>i.e.<span class="w"> </span>no
<span class="w">        </span>#<span class="w">     </span>SSL<span class="w"> </span>close<span class="w"> </span>notify<span class="w"> </span>alert<span class="w"> </span>is<span class="w"> </span>send<span class="w"> </span>or<span class="w"> </span>allowed<span class="w"> </span>to<span class="w"> </span>received.<span class="w">  </span>This<span class="w"> </span>violates
<span class="w">        </span>#<span class="w">     </span>the<span class="w"> </span>SSL/TLS<span class="w"> </span>standard<span class="w"> </span>but<span class="w"> </span>is<span class="w"> </span>needed<span class="w"> </span>for<span class="w"> </span>some<span class="w"> </span>brain-dead<span class="w"> </span>browsers.<span class="w"> </span>Use
<span class="w">        </span>#<span class="w">     </span>this<span class="w"> </span>when<span class="w"> </span>you<span class="w"> </span>receive<span class="w"> </span>I/O<span class="w"> </span>errors<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>standard<span class="w"> </span>approach<span class="w"> </span>where
<span class="w">        </span>#<span class="w">     </span>mod_ssl<span class="w"> </span>sends<span class="w"> </span>the<span class="w"> </span>close<span class="w"> </span>notify<span class="w"> </span>alert.
<span class="w">        </span>#<span class="w">   </span>o<span class="w"> </span>ssl-accurate-shutdown:
<span class="w">        </span>#<span class="w">     </span>This<span class="w"> </span>forces<span class="w"> </span>an<span class="w"> </span>accurate<span class="w"> </span>shutdown<span class="w"> </span>when<span class="w"> </span>the<span class="w"> </span>connection<span class="w"> </span>is<span class="w"> </span>closed,<span class="w"> </span>i.e.<span class="w"> </span>a
<span class="w">        </span>#<span class="w">     </span>SSL<span class="w"> </span>close<span class="w"> </span>notify<span class="w"> </span>alert<span class="w"> </span>is<span class="w"> </span>send<span class="w"> </span>and<span class="w"> </span>mod_ssl<span class="w"> </span>waits<span class="w"> </span>for<span class="w"> </span>the<span class="w"> </span>close<span class="w"> </span>notify
<span class="w">        </span>#<span class="w">     </span>alert<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>client.<span class="w"> </span>This<span class="w"> </span>is<span class="w"> </span>100%<span class="w"> </span>SSL/TLS<span class="w"> </span>standard<span class="w"> </span>compliant,<span class="w"> </span>but<span class="w"> </span>in
<span class="w">        </span>#<span class="w">     </span>practice<span class="w"> </span>often<span class="w"> </span>causes<span class="w"> </span>hanging<span class="w"> </span>connections<span class="w"> </span>with<span class="w"> </span>brain-dead<span class="w"> </span>browsers.<span class="w"> </span>Use
<span class="w">        </span>#<span class="w">     </span>this<span class="w"> </span>only<span class="w"> </span>for<span class="w"> </span>browsers<span class="w"> </span>where<span class="w"> </span>you<span class="w"> </span>know<span class="w"> </span>that<span class="w"> </span>their<span class="w"> </span>SSL<span class="w"> </span>implementation
<span class="w">        </span>#<span class="w">     </span>works<span class="w"> </span>correctly.
<span class="w">        </span>#<span class="w">   </span>Notice:<span class="w"> </span>Most<span class="w"> </span>problems<span class="w"> </span>of<span class="w"> </span>broken<span class="w"> </span>clients<span class="w"> </span>are<span class="w"> </span>also<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>HTTP
<span class="w">        </span>#<span class="w">   </span>keep-alive<span class="w"> </span>facility,<span class="w"> </span>so<span class="w"> </span>you<span class="w"> </span>usually<span class="w"> </span>additionally<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>disable
<span class="w">        </span>#<span class="w">   </span>keep-alive<span class="w"> </span>for<span class="w"> </span>those<span class="w"> </span>clients,<span class="w"> </span>too.<span class="w"> </span>Use<span class="w"> </span>variable<span class="w"> </span>&quot;nokeepalive&quot;<span class="w"> </span>for<span class="w"> </span>this.
<span class="w">        </span>#<span class="w">   </span>Similarly,<span class="w"> </span>one<span class="w"> </span>has<span class="w"> </span>to<span class="w"> </span>force<span class="w"> </span>some<span class="w"> </span>clients<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>HTTP/1.0<span class="w"> </span>to<span class="w"> </span>workaround
<span class="w">        </span>#<span class="w">   </span>their<span class="w"> </span>broken<span class="w"> </span>HTTP/1.1<span class="w"> </span>implementation.<span class="w"> </span>Use<span class="w"> </span>variables<span class="w"> </span>&quot;downgrade-1.0&quot;<span class="w"> </span>and
<span class="w">        </span>#<span class="w">   </span>&quot;force-response-1.0&quot;<span class="w"> </span>for<span class="w"> </span>this.
<span class="w">        </span>BrowserMatch<span class="w"> </span>&quot;MSIE<span class="w"> </span>[2-6]&quot;<span class="w"> </span>\
<span class="w">                </span>nokeepalive<span class="w"> </span>ssl-unclean-shutdown<span class="w"> </span>\
<span class="w">                </span>downgrade-1.0<span class="w"> </span>force-response-1.0
<span class="w">        </span>#<span class="w"> </span>MSIE<span class="w"> </span>7<span class="w"> </span>and<span class="w"> </span>newer<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span>able<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>keepalive
<span class="w">        </span>BrowserMatch<span class="w"> </span>&quot;MSIE<span class="w"> </span>[17-9]&quot;<span class="w"> </span>ssl-unclean-shutdown
<span class="nt">&lt;/VirtualHost&gt;</span>
<span class="nt">&lt;/IfModule&gt;</span>
</code></pre></div>

<p>然后在你的DNS服务商那里声明一下服务器，例如：</p>
<div class="highlight"><pre><span></span><code>webmail.jhausse.net.    300 IN  CNAME   cloud.jhausse.net.
</code></pre></div>

<p>现在让我激活这三个网站：</p>
<div class="highlight"><pre><span></span><code>a2ensite default default-ssl roundcube
service apache2 restart
</code></pre></div>

<p>关于网页邮件，可以通过网址<strong><a href="https://webmail.jhausse.net">https://webmail.jhausse.net</a></strong>来访问，基本上能工作。之后使用邮箱全名（例如<a href="mailto:roudy@jhausse.net">roudy@jhausse.net</a>）和在本文一开始在邮件服务器数据库里设定的密码登录。第一次连接成功，浏览器会警告说证书没有可靠机构的签名。这个没什么关系，只要添加一个例外即可。</p>
<p>最后但很重要的是，我们将通过把以下内容写入到<strong>/etc/apache2/sites-available/owncloud</strong>来为Owncloud创建一个虚拟主机。</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;IfModule</span> <span class="err">mod_ssl.c</span><span class="nt">&gt;</span>
<span class="nt">&lt;VirtualHost</span> <span class="err">*:443</span><span class="nt">&gt;</span>
<span class="w">        </span>ServerAdmin<span class="w"> </span>webmaster@localhost

<span class="w">        </span>DocumentRoot<span class="w"> </span>/var/www/owncloud
<span class="w">        </span>ServerName<span class="w"> </span>cloud.jhausse.net
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="nt">/&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>FollowSymLinks
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/var/www/owncloud</span><span class="nt">&gt;</span>
<span class="w">                </span>Options<span class="w"> </span>Indexes<span class="w"> </span>FollowSymLinks<span class="w"> </span>MultiViews
<span class="w">                </span>AllowOverride<span class="w"> </span>All
<span class="w">                </span>Order<span class="w"> </span>allow,deny
<span class="w">                </span>allow<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span>ScriptAlias<span class="w"> </span>/cgi-bin/<span class="w"> </span>/usr/lib/cgi-bin/
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">&quot;/usr/lib/cgi-bin&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span>AllowOverride<span class="w"> </span>None
<span class="w">                </span>Options<span class="w"> </span>+ExecCGI<span class="w"> </span>-MultiViews<span class="w"> </span>+SymLinksIfOwnerMatch
<span class="w">                </span>Order<span class="w"> </span>allow,deny
<span class="w">                </span>Allow<span class="w"> </span>from<span class="w"> </span>all
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span>ErrorLog<span class="w"> </span><span class="cp">${</span><span class="n">APACHE_LOG_DIR</span><span class="cp">}</span>/error.log

<span class="w">        </span>#<span class="w"> </span>Possible<span class="w"> </span>values<span class="w"> </span>include:<span class="w"> </span>debug,<span class="w"> </span>info,<span class="w"> </span>notice,<span class="w"> </span>warn,<span class="w"> </span>error,<span class="w"> </span>crit,
<span class="w">        </span>#<span class="w"> </span>alert,<span class="w"> </span>emerg.
<span class="w">        </span>LogLevel<span class="w"> </span>warn

<span class="w">        </span>CustomLog<span class="w"> </span><span class="cp">${</span><span class="n">APACHE_LOG_DIR</span><span class="cp">}</span>/ssl_access.log<span class="w"> </span>combined

<span class="w">        </span>#<span class="w">   </span>SSL<span class="w"> </span>Engine<span class="w"> </span>Switch:
<span class="w">        </span>#<span class="w">   </span>Enable/Disable<span class="w"> </span>SSL<span class="w"> </span>for<span class="w"> </span>this<span class="w"> </span>virtual<span class="w"> </span>host.
<span class="w">        </span>SSLEngine<span class="w"> </span>on

<span class="w">        </span>#<span class="w"> </span>do<span class="w"> </span>not<span class="w"> </span>allow<span class="w"> </span>unsecured<span class="w"> </span>connections
<span class="w">        </span>#<span class="w"> </span>SSLRequireSSL
<span class="w">        </span>SSLCipherSuite<span class="w"> </span>HIGH:MEDIUM
<span class="w">        </span>SSLCertificateFile<span class="w">    </span>/etc/ssl/certs/cloud.crt
<span class="w">        </span>SSLCertificateKeyFile<span class="w"> </span>/etc/ssl/private/cloud.key

<span class="w">        </span><span class="nt">&lt;FilesMatch</span> <span class="err">&quot;\.(cgi|shtml|phtml|php)$&quot;</span><span class="nt">&gt;</span>
<span class="w">                </span>SSLOptions<span class="w"> </span>+StdEnvVars
<span class="w">        </span><span class="nt">&lt;/FilesMatch&gt;</span>
<span class="w">        </span><span class="nt">&lt;Directory</span> <span class="err">/usr/lib/cgi-bin</span><span class="nt">&gt;</span>
<span class="w">                </span>SSLOptions<span class="w"> </span>+StdEnvVars
<span class="w">        </span><span class="nt">&lt;/Directory&gt;</span>

<span class="w">        </span>BrowserMatch<span class="w"> </span>&quot;MSIE<span class="w"> </span>[2-6]&quot;<span class="w"> </span>\
<span class="w">                </span>nokeepalive<span class="w"> </span>ssl-unclean-shutdown<span class="w"> </span>\
<span class="w">                </span>downgrade-1.0<span class="w"> </span>force-response-1.0
<span class="w">        </span>#<span class="w"> </span>MSIE<span class="w"> </span>7<span class="w"> </span>and<span class="w"> </span>newer<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span>able<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>keepalive
<span class="w">        </span>BrowserMatch<span class="w"> </span>&quot;MSIE<span class="w"> </span>[17-9]&quot;<span class="w"> </span>ssl-unclean-shutdown
<span class="nt">&lt;/VirtualHost&gt;</span>
<span class="nt">&lt;/IfModule&gt;</span>
</code></pre></div>

<p>然后通过执行以下命令激活Owncloud：</p>
<div class="highlight"><pre><span></span><code><span class="n">a2ensite</span><span class="w"> </span><span class="n">owncloud</span>
<span class="n">service</span><span class="w"> </span><span class="n">apache2</span><span class="w"> </span><span class="n">reload</span>
</code></pre></div>

<p>之后通过在浏览器里打开链接<strong><a href="https://cloud.jhausse.net/">https://cloud.jhausse.net/</a></strong>配置一下Owncloud。</p>
<p>就这些了！现在你已经拥有自己的Google Drive，日程表，联系人，Dropbox，以及Gmail！好好享受下新鲜恢复保护的隐私吧！:-)</p>
<h2>在云上同步你的设备</h2>
<p>要同步你的邮件，你只需用你喜欢的邮件客户端即可：Android或iOS自带的默认邮件应用，<a href="https://code.google.com/p/k9mail/">k9mail</a>，或者电脑上的Thunderbird。或者你也可以使用我们设置好的网页邮件。</p>
<p>在Owncloud的文档里描述了如何与云端同步你的日程表和联系人。在Android系统中，我用的是CalDAV-Sync，CardDAV-Sync应用桥接了手机上Android自带日历以及联系人应用和Owncloud服务器。</p>
<p>对于文件，有一个叫Owncloud的Android应用可以访问你手机上的文件，然后自动把你拍的图片和视频上传到云中。在你的Mac/PC上访问云端文件也很容易，在<a href="http://doc.owncloud.org/server/7.0/user_manual/files/files.html">Owncloud文档里有很好的描述</a>。</p>
<h2>最后一点提示</h2>
<p>在上线后的前几个星期里，最好每天检查一下日志<strong>/var/log/syslog</strong>和<strong>/var/log/mail.log</strong>以保证一切都在顺利运行。在你邀请其他人（朋友，家人，等等）加入你的服务器之前这很重要。他们信任你能很好地架设个人服务器维护他们的数据，但是如果服务器突然崩溃会让他们很失望。</p>
<p>要添加另一个邮件用户，只要在数据库<strong>mailserver</strong>的<strong>virtual_users</strong>表中增加一行。</p>
<p>要添加一个域名，只要在<strong>virtual_domains</strong>表中增加一行。然后更新<strong>/etc/opendkim/SigningTable</strong>为发出的邮件签名，上传OpenDKIM密钥到服务器区域，然后重启OpenDKIM服务。</p>
<p>Owncloud有自己的用户数据库，在用管理员帐号登录后可以修改。</p>
<p>最后，万一在服务器临时崩溃的时候想办法找解决方案很重要。比如说，在服务器恢复之前你的邮件应该送往哪儿？一种方式是找个能帮你做备份MX的朋友，同时你也可以当他的备份MX（看下postfix的配置文件<strong>main.cf</strong>里<strong>relay_domains</strong>和<strong>relay_recipient_maps</strong>里的设定）。与此类似，如果你的服务器被破解然后一个坏蛋把你所有文件删了怎么办？对于这个，考虑增加一个常规备份系统就很重要了。Linode提供了备份选项。在1984.is里，我用crontabs和scp做了一个基本但管用的自动备份系统。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>