<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>如何使用 backupninja 来备份 Debian 系统</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Gabriel Cánepa 小心谨慎或灾难体验会让每一个系统管理都认识到频繁的系统备份的重要性。你可以通过编写管用的旧式 shell 脚 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2015/03/ru-he-shi-yong-backupninja-lai-bei-fen-debian-xi-tong.html" rel="bookmark"
           title="Permalink to 如何使用 backupninja 来备份 Debian 系统">如何使用 backupninja 来备份 Debian 系统</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-03-21T10:03:00+01:00">
                Published: Sat 21 March 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Gabriel Cánepa</p>
<p>小心谨慎或灾难体验会让每一个系统管理都认识到频繁的系统备份的重要性。你可以通过编写管用的旧式 shell 脚本，或使用一个（或几个）适合这项工作的备份工具来完成备份任务。因此，当你要实施一个备份解决方案时，你了解的备份工具越多，你做出的决策就会越明智。</p>
<p>在这篇文章中，我们将为你介绍 <a href="https://labs.riseup.net/code/projects/backupninja">backupninja</a> ，这是一个轻量且易于配置的系统备份工具。在诸如 <strong>rdiff-backup</strong>, <strong>duplicity</strong>, <strong>mysqlhotcopy</strong> 和 <strong>mysqldump</strong> 等程序的帮助下， Backupninja 可以提供常用的备份功能，如执行远程的、安全的和增量式的文件系统备份，加密备份以及 MySQL/MariaDB 数据库备份。你可以选择性地开启使用 Email 状态报告功能，也可以对一般的硬件和系统的信息进行备份。 backupninja 的一个关键功能是它拥有一个内建的基于控制台的向导程序（被称为 <strong>ninjahelper</strong>），而后者允许你为不同的备份情景轻松地创建配置文件。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230658xqfzb2lx2k290xxb.jpg"></p>
<p>（题图来自：blogspot.com）</p>
<p>如果非要说的话，backupninja 的缺点是：为了充分使用其所有的功能，它要求安装一些其他“助手”程序。尽管 backupninja 有针对基于 Red Hat（红帽）的发行版本的 RPM 安装包，但 backupninja 针对 Debian 及其衍生发行版本的依赖进行了优化。所以不建议在基于 Red Hat 的系统上尝试 backupninja 。</p>
<p>在这篇教程中，我们将介绍如何在基于 Debian 的发行版本上安装 backupninja 。</p>
<h3>安装 Backupninja</h3>
<p>以 root 账户来运行下面的命令：</p>
<div class="highlight"><pre><span></span><code># aptitude install backupninja 
</code></pre></div>

<p>在安装的过程中，有几个文件和目录将被创建：</p>
<ul>
<li><strong>/usr/sbin/backupninja</strong> 是个 bash shell 的主脚本；</li>
<li><strong>/etc/cron.d/backupninja</strong>， 默认情况下，设置 cron 任务来每隔一个小时运行上面的主脚本；</li>
<li><strong>/etc/logrotate.d/backupninja</strong> 截断由 backupninja 程序产生的日志；</li>
<li><strong>/etc/backup.d/</strong> 是备份操作的配置文件驻留的目录；</li>
<li><strong>/etc/backupninja.conf</strong> 是包含一般选项的主配置文件。这个文件带有良好的注释且详细解释了每个选项的含义；</li>
<li><strong>/usr/share/backupninja</strong> 是那些 backupninja 所使用的脚本所处的目录。这些脚本文件负责执行实际的工作。在这个目录中，你还可以找到 <code>.helper</code> 文件，它们可以被用来配置和设定 ninjahelper 的菜单；</li>
<li><strong>/usr/share/doc/backupninja/examples</strong> 含有操作配置文件（即通过 ninjahelper 产生的文件）的模板。</li>
</ul>
<h3>首次运行 Ninjahelper</h3>
<p>当我们尝试启动 ninjahelper 时，我们可以看到可能需要一个内部依赖程序。假如系统进行了提示，请输入 “yes” 并敲下回车键来安装 dialog（一个用于从 shell 脚本中显示友好对话框的工具）。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230751omw0yr1j18t9a1y4.jpg"></p>
<p>当你在键入 yes 后再敲回车键时，backupninja 将会安装 dialog，一旦安装完成，将呈现出下面的截屏：</p>
<p><img alt="" src="/data/attachment/album/201503/20/230757hfyefp4ee5s44e4b.jpg"></p>
<h4>案例 1: 备份硬件和系统信息</h4>
<p>在启动了 ninjahelper 之后，我们将创建一个新的备份操作：</p>
<p><img alt="" src="/data/attachment/album/201503/20/230804jtfqoq33lmtqt3mu.jpg"></p>
<p>如果必要的助手程序没有被安装，下面的截屏将会呈现在我们眼前。假如这些软件包已经在你的系统上安装了，请跳过这一步。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230808jz541iix51w8ewd5.jpg"></p>
<p>接下来的一步需要你选取相关条目来作为此次备份任务的一部分。前四个条目已经默认被选上了，但你可以通过在条目上按空格键来撤消选择。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230813do1yjakekfe3e93e.jpg"></p>
<p>一旦你完成了上面的步骤，按 OK 选项来继续。接着你将能够选择是愿意使用默认的配置文件(/etc/backup.d/10.sys)来完成这次备份操作，还是创建一个新的配置文件。若为后者，一个含有与默认配置文件内容相同的文件将会在相同的目录下被创建，但它被命名为 11.sys，后续的备份操作将会创建类似的文件（注：只不过命名的序号不同）。需要说明的是一旦这个新的配置文件被创建，你便可以使用你喜爱的文本编辑器来编辑该文件。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230814raukkmqtg2qpcham.png"></p>
<h4>案例 2: 一个远程目录的增量式 Rsync 拉取备份</h4>
<p>正如你最有可能知道的那样， rsync 被广泛地用于通过网络同步文件或文件夹。在接下来的例子中，我们将讨论一个使用硬链接来为一个远程目录做增量式拉取备份的方法，它被用来保存历史数据以及在我们本地的文件服务器中恢复这些历史数据。这个方法将帮助我们节省空间并增强位于服务器端的安全性。</p>
<p><strong>步骤 1</strong>：编写一个带有如下内容的自定义脚本，放在 <code>/etc/backup.d</code>，并将它的权限设置为 600 。需要说明的是，除了一般的配置文件，这个目录可能还包含当 backupninja 执行时你想运行的一些脚本文件，它们可以发挥出位于主配置文件中的变量的优势。</p>
<div class="highlight"><pre><span></span><code># REMOTE USER
user=root
# REMOTE HOST
host=dev1
# REMOTE DIRECTORY
remotedir=/home/gacanepa/
# LOCAL DIRECTORY
localdir=/home/gacanepa/backup.0
# LOCAL DIRECTORY WHERE PREVIOUS BACKUP WAS STORED
localdirold=/home/gacanepa/backup.1
mv $localdir $localdirold
# RSYNC
rsync -av --delete --recursive --link-dest=$localdirold $user@$host:$remotedir $localdir
</code></pre></div>

<p>在上面的配置中， rsync 的 ‘--link-dest’ 选项的作用是为位于 $localdir-old 目录中那些没有改变的文件(包含所有属性) 硬链接到目标目录（$localdir）。</p>
<p><strong>步骤 2</strong>：在 backupninja 第一次运行之前，上层目录（这个例子中指的是 /home/gacanepa） 是空的。第一次我们执行下面的命令：</p>
<div class="highlight"><pre><span></span><code># backupninja -n 
</code></pre></div>

<p>backup.0 目录就被创建了，并在接下来的过程中，它的名称将会被更改为 backup.1。</p>
<p>当我们第二次运行 backupninja 时， backup.0 将会被重新创建，而 backup.1 保持不动。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230820w02yhv62pihlhhf7.jpg"></p>
<p><strong>步骤 3</strong>： 确保 backup.1 里面的文件硬链接到 backup.0 里的文件，我们可以通过比较文件的 inode（i 节点）数和目录的大小来达到此目的。</p>
<p><img alt="" src="/data/attachment/album/201503/20/230820sytt0ep1btbweei5.jpg"></p>
<h3>总结</h3>
<p>Backupninja 不仅是一个经典的备份工具，它也是一个易于配置的实用程序。你可以通过编写你自己的控制脚本，用放在 <code>/etc.backup.d</code> 中的不同的配置文件来运行 backupninja 。甚至你还可以为 ninjahelper 编写助手程序，并将其包括在 ninjahelper 的主界面上。</p>
<p>例如，假如你在 <code>/usr/share/backupninja</code>目录中创建了一个名为 xmodulo 的控制脚本，它将自动运行那些位于 <code>/etc/backup.d</code> 目录中以 .xmodulo 为后缀的每个文件。如果你决定添加你的 xmodulo 控制脚本到 ninjahelper 中， 你可以编写相应的助手程序，即 xmodulo.helper 。另外，假如你想 让 backupninja 运行其它的脚本，只需把它添加到 <code>/etc/backup.d</code> 目录中就可以了。</p>
<p>欢迎使用下面的评论框来留下你的评论、问题或建议。听到你的回应将会使我们很高兴。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>