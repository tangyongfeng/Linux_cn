<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Samba 系列（一）：在 Ubuntu 系统上使用 Samba4 来创建活动目录架构</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Matei Cezar Samba 是一个自由的开源软件套件，用于实现 Windows 操作系统与 Linux/Unix 系统之间的无缝连接及共享资源。 Samba 不仅可以通过 SMB …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2016/12/samba-xi-lie-yi-zai-ubuntu-xi-tong-shang-shi-yong-samba4-lai-chuang-jian-huo-dong-mu-lu-jia-gou.html" rel="bookmark"
           title="Permalink to Samba 系列（一）：在 Ubuntu 系统上使用 Samba4 来创建活动目录架构">Samba 系列（一）：在 Ubuntu 系统上使用 Samba4 来创建活动目录架构</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-12-26T17:46:00+01:00">
                Published: Mon 26 December 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Matei Cezar</p>
<p>Samba 是一个自由的开源软件套件，用于实现 Windows 操作系统与 Linux/Unix 系统之间的无缝连接及共享资源。</p>
<p>Samba 不仅可以通过 SMB/CIFS 协议组件来为 Windows 与 Linux 系统之间提供独立的文件及打印机共享服务，它还能实现<ruby> 活动目录 <rp>  （ </rp> <rt>  Active Directory </rt> <rp>  ） </rp></ruby><ruby> 域控制器 <rp>  （ </rp> <rt>  Domain Controller </rt> <rp>  ） </rp></ruby>的功能，或者让 Linux 主机加入到域环境中作为域成员服务器。当前的 Samba4 版本实现的 AD DC 域及林功能级别可以取代 Windows 2008 R2 系统的域相关功能。</p>
<p><img alt="" src="/data/attachment/album/201612/26/174604fkcolbrtc5frlrpf.jpg"></p>
<p>本系列的文章的主要内容是使用 Samba4 软件来配置活动目录域控制器，涉及到 Ubuntu、CentOS 和 Windows 系统相关的以下主题：</p>
<ul>
<li>第 1 节：在 Ubuntu 系统上使用 Samba4 来创建活动目录架构</li>
<li>第 2 节：在 Linux 命令行下管理 Samba4 AD 架构</li>
<li>第 3 节：在 Windows 10 操作系统上安装 RSAT 工具来管理 Samba4 AD</li>
<li>第 4 节：从 Windows 中管理 Samba4 AD 域控制器 DNS 和组策略</li>
<li>第 5 节：使用 Sysvol Replication 复制功能把 Samba 4 DC 加入到已有的 AD</li>
<li>第 6 节：从 Linux DC 服务器通过 GOP 来添加一个共享磁盘并映射到 AD</li>
<li>第 7 节：把 Ubuntu 16.04 系统主机作为域成员服务器添加到 AD</li>
<li>第 8 节：把 CenterOS 7 系统主机作为域成员服务器添加到 AD</li>
<li>第 9 节：在 AD Intranet 区域创建使用 kerberos 认证的 Apache Website</li>
</ul>
<p>这篇指南将阐明在 Ubuntu 16.04 和 Ubuntu 14.04 操作系统上安装配置 Samba4 作为域控服务器组件的过程中，你需要注意的每一个步骤。</p>
<p>以下安装配置文档将会说明在 Windows 和 Linux 的混合系统环境中，关于用户、机器、共享卷、权限及其它资源信息的主要配置点。</p>
<h4>环境要求：</h4>
<ol>
<li><a href="http://www.tecmint.com/installation-of-ubuntu-16-04-server-edition/">Ubuntu 16.04 服务器安装</a></li>
<li><a href="http://www.tecmint.com/ubuntu-14-04-server-installation-guide-and-lamp-setup/">Ubuntu 14.04 服务器安装</a></li>
<li>为你的 AD DC 服务器<a href="http://www.tecmint.com/set-add-static-ip-address-in-linux/">设置静态IP地址</a></li>
</ol>
<h3>第一步：初始化 Samba4 安装环境</h3>
<p>1、 在开始安装 Samba4 AD DC 之前，让我们先做一些准备工作。首先运行以下命令来确保系统已更新了最新的安全特性，内核及其它补丁：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span>
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>upgrade
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>dist-upgrade
</code></pre></div>

<p>2、 其次，打开服务器上的 <code>/etc/fstab</code> 文件，确保文件系统分区的 ACL 已经启用 ，如下图所示。</p>
<p>通常情况下，当前常见的 Linux 文件系统，比如 ext3、ext4、xfs 或 btrfs 都默认支持并已经启用了 ACL 。如果未设置，则打开并编辑 <code>/etc/fstab</code> 文件，在第三列添加 <code>acl</code>，然后重启系统以使用修改的配置生效。</p>
<p><img alt="Enable ACL's on Linux Filesystem" src="/data/attachment/album/201612/26/174621ehlf2q8zzhq9yfjc.png"></p>
<p><em>启动 Linux 文件系统的 ACL 功能</em></p>
<p>3、 最后使用一个具有描述性的名称来<a href="http://www.tecmint.com/set-hostname-permanently-in-linux/">设置主机名</a> ，比如这往篇文章所使用的 <code>adc1</code>。通过编辑 <code>/etc/hostname</code> 文件或使用使用下图所示的命令来设置主机名。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>hostnamectl<span class="w"> </span>set-hostname<span class="w"> </span>adc1
</code></pre></div>

<p>为了使修改的主机名生效必须重启服务器。</p>
<h3>第二步： 为 Samba4 AD DC 服务器安装必需的软件包</h3>
<p>4、 为了让你的服务器转变为域控制器，你需要在服务器上使用具有 root 权限的账号执行以下命令来安装 Samba 套件及所有必需的软件包。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>samba<span class="w"> </span>krb5-user<span class="w"> </span>krb5-config<span class="w"> </span>winbind<span class="w"> </span>libpam-winbind<span class="w"> </span>libnss-winbind
</code></pre></div>

<p><img alt="Install Samba on Ubuntu" src="/data/attachment/album/201612/26/174622j7ee5rzhg6fgu676.png"></p>
<p><em>在 Ubuntu 系统上安装 Samba 套件</em></p>
<p>5、 安装包在执行的过程中将会询问你一系列的问题以便完成域控制器的配置。</p>
<p>在第一屏中你需要以大写为 Kerberos 默认 REALM 输入一个名字。以<strong>大写</strong>为你的域环境输入名字，然后单击回车继续。</p>
<p><img alt="Configuring Kerberos Authentication" src="/data/attachment/album/201612/26/174622da1nt1t1jzhi00bj.png"></p>
<p><em>配置 Kerosene 认证服务</em></p>
<p>6、 下一步，输入你的域中 Kerberos 服务器的主机名。使用和上面相同的名字，这一次使用<strong>小写</strong>，然后单击回车继续。</p>
<p><img alt="Set Hostname Kerberos Server" src="/data/attachment/album/201612/26/174623sfp261fy1666oy4t.png"></p>
<p><em>设置 Kerberos 服务器的主机名</em></p>
<p>7、 最后，指定 Kerberos realm 管理服务器的主机名。使用更上面相同的名字，单击回车安装完成。</p>
<p><img alt="Set Hostname Administrative Server" src="/data/attachment/album/201612/26/174623ngmtgbg0gnpd1um5.png"></p>
<p><em>设置管理服务器的主机名</em></p>
<h3>第三步：为你的域环境开启 Samba AD DC 服务</h3>
<p>8、 在为域服务器配置 Samba 服务之前，先运行如下命令来停止并禁用所有 Samba 进程。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>samba-ad-dc.service<span class="w"> </span>smbd.service<span class="w"> </span>nmbd.service<span class="w"> </span>winbind.service
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>samba-ad-dc.service<span class="w"> </span>smbd.service<span class="w"> </span>nmbd.service<span class="w"> </span>winbind.service
</code></pre></div>

<p>9、 下一步，重命名或删除 Samba 原始配置文件。在开启 Samba 服务之前，必须执行这一步操作，因为在开启服务的过程中 Samba 将会创建一个新的配置文件，如果检测到原有的 <code>smb.conf</code> 配置文件则会报错。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mv<span class="w"> </span>/etc/samba/smb.conf<span class="w"> </span>/etc/samba/smb.conf.initial
</code></pre></div>

<p>10、 现在，使用 root 权限的账号并接受 Samba 提示的默认选项，以交互方式启动<ruby> 域供给 <rp>  （ </rp> <rt>  domain provision </rt> <rp>  ） </rp></ruby>。</p>
<p>还有，输入正确的 DNS 服务器地址并且为 Administrator 账号设置强密码。如果使用的是弱密码，则域供给过程会失败。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>samba-tool<span class="w"> </span>domain<span class="w"> </span>provision<span class="w"> </span>--use-rfc2307<span class="w"> </span>–interactive
</code></pre></div>

<p><img alt="Samba Domain Provisioning" src="/data/attachment/album/201612/26/174624cvativsroh3etzks.png"></p>
<p><em>Samba 域供给</em></p>
<p>11、 最后，使用以下命令重命名或删除 Kerberos 认证在 <code>/etc</code> 目录下的主配置文件，并且把 Samba 新生成的 Kerberos 配置文件创建一个软链接指向 <code>/etc</code> 目录。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mv<span class="w"> </span>/etc/krb6.conf<span class="w"> </span>/etc/krb5.conf.initial
$<span class="w"> </span>sudo<span class="w"> </span>ln<span class="w"> </span>–s<span class="w"> </span>/var/lib/samba/private/krb5.conf<span class="w"> </span>/etc/
</code></pre></div>

<p><img alt="Create Kerberos Configuration" src="/data/attachment/album/201612/26/174624nzk97dukuh961haf.png"></p>
<p><em>创建 Kerberos 配置文件</em></p>
<p>12、 启动并开启 Samba 活动目录域控制器后台进程</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>samba-ad-dc.service
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>samba-ad-dc.service
$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>samba-ad-dc.service
</code></pre></div>

<p><img alt="Enable Samba Active Directory Domain Controller" src="/data/attachment/album/201612/26/174625kna87hnh6l6bbnb2.png"></p>
<p><em>开启 Samba 活动目录域控制器服务</em></p>
<p>13、 下一步，<a href="http://www.tecmint.com/20-netstat-commands-for-linux-network-management/">使用 netstat 命令</a> 来验证活动目录启动的服务是否正常。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>netstat<span class="w"> </span>–tulpn<span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span>‘smbd<span class="p">|</span>samba’
</code></pre></div>

<p><img alt="Verify Samba Active Directory" src="/data/attachment/album/201612/26/174625kq7ynsmo7cpc0pst.png"></p>
<p><em>验证 Samba 活动目录</em></p>
<h3>第四步： Samba 最后的配置</h3>
<p>14、 此刻，Samba 应该跟你想像的一样，完全运行正常。Samba 现在实现的域功能级别可以完全跟 Windows AD DC 2008 R2 相媲美。</p>
<p>可以使用 <code>samba-tool</code> 工具来验证 Samba 服务是否正常：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>samba-tool<span class="w"> </span>domain<span class="w"> </span>level<span class="w"> </span>show
</code></pre></div>

<p><img alt="Verify Samba Domain Level" src="/data/attachment/album/201612/26/174626l8b506acbnlj9nnb.png"></p>
<p><em>验证 Samba 域服务级别</em></p>
<p>15、 为了满足 DNS 本地解析的需求，你可以编辑网卡配置文件，修改 <code>dns-nameservers</code> 参数的值为域控制器地址（使用 127.0.0.1 作为本地 DNS 解析地址），并且设置 <code>dns-search</code> 参数为你的 realm 值。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>cat<span class="w"> </span>/etc/network/interfaces
$<span class="w"> </span>sudo<span class="w"> </span>cat<span class="w"> </span>/etc/resolv.conf
</code></pre></div>

<p><img alt="Configure DNS for Samba AD" src="/data/attachment/album/201612/26/174627kawvsz299mckw1zd.png"></p>
<p><em>为 Samba 配置 DNS 服务器地址</em></p>
<p>设置完成后，重启服务器并检查解析文件是否指向正确的 DNS 服务器地址。</p>
<p>16、 最后，通过 <code>ping</code> 命令查询结果来检查某些重要的 AD DC 记录是否正常，使用类似下面的命令，替换对应的域名。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ping<span class="w"> </span>–c3<span class="w"> </span>tecmint.lan<span class="w">       </span><span class="c1"># 域名</span>
$<span class="w"> </span>ping<span class="w"> </span>–c3<span class="w"> </span>adc1.tecmint.lan<span class="w">  </span><span class="c1"># FQDN</span>
$<span class="w"> </span>ping<span class="w"> </span>–c3<span class="w"> </span>adc1<span class="w">              </span><span class="c1"># 主机</span>
</code></pre></div>

<p><img alt="Check Samba AD DNS Records" src="/data/attachment/album/201612/26/174627kaximyu6ya2yy2vu.png"></p>
<p><em>检查 Samba AD DNS 记录</em></p>
<p>执行下面的一些查询命令来检查 Samba 活动目录域控制器是否正常。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>host<span class="w"> </span>–t<span class="w"> </span>A<span class="w"> </span>tecmint.lan
$<span class="w"> </span>host<span class="w"> </span>–t<span class="w"> </span>A<span class="w"> </span>adc1.tecmint.lan
$<span class="w"> </span>host<span class="w"> </span>–t<span class="w"> </span>SRV<span class="w"> </span>_kerberos._udp.tecmint.lan<span class="w">  </span><span class="c1"># UDP Kerberos SRV record</span>
$<span class="w"> </span>host<span class="w"> </span>-t<span class="w"> </span>SRV<span class="w"> </span>_ldap._tcp.tecmint.lan<span class="w"> </span><span class="c1"># TCP LDAP SRV record</span>
</code></pre></div>

<p>17、 并且，通过请求一个域管理员账号的身份来列出缓存的票据信息以验证 Kerberos 认证是否正常。注意域名部分使用大写。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kinit<span class="w"> </span>administrator@TECMINT.LAN
$<span class="w"> </span>klist
</code></pre></div>

<p><img alt="Check Kerberos Authentication on Domain" src="/data/attachment/album/201612/26/174628dbfeq1gzf2q15077.png"></p>
<p><em>检查域环境中的 Kerberos 认证是否正确</em></p>
<p>至此！ 你当前的网络环境中已经完全运行着一个 AD 域控制器，你现在可以把 Windows 或 Linux 系统的主机集成到 Samba AD 中了。</p>
<p>在下一期的文章中将会包括其它 Samba AD 域的主题，比如，在 Samba 命令行下如何管理你的域控制器，如何把 Windows 10 系统主机添加到同一个域环境中，如何使用 RSAT 工具远程管理 Samba AD 域，以及其它重要的主题。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>