<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>用 Python 实现 Python 解释器</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Allison Kaptur Allison 是 Dropbox 的工程师，在那里她维护着这个世界上最大的 Python 客户端网络之一。在去 Dropbox 之前，她是 Recurse Center 的协调人, 是这个位 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2016/09/yong-python-shi-xian-python-jie-shi-qi.html" rel="bookmark"
           title="Permalink to 用 Python 实现 Python 解释器">用 Python 实现 Python 解释器</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-09-08T14:16:18+02:00">
                Published: Thu 08 September 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Allison Kaptur</p>
<p><em>Allison 是 Dropbox 的工程师，在那里她维护着这个世界上最大的 Python 客户端网络之一。在去 Dropbox 之前，她是 Recurse Center 的协调人, 是这个位于纽约的程序员深造机构的作者。她在北美的 PyCon 做过关于 Python 内部机制的演讲，并且她喜欢研究奇怪的 bug。她的博客地址是 <a href="http://akaptur.com">akaptur.com</a>。</em></p>
<p><em><img alt="" src="/data/attachment/album/201609/08/141608t7xxxasobisyzxm0.jpg"></em></p>
<h3>介绍</h3>
<p>Byterun 是一个用 Python 实现的 Python 解释器。随着我对 Byterun 的开发，我惊喜地的发现，这个 Python 解释器的基础结构用 500 行代码就能实现。在这一章我们会搞清楚这个解释器的结构，给你足够探索下去的背景知识。我们的目标不是向你展示解释器的每个细节---像编程和计算机科学其他有趣的领域一样，你可能会投入几年的时间去深入了解这个主题。</p>
<p>Byterun 是 Ned Batchelder 和我完成的，建立在 Paul Swartz 的工作之上。它的结构和主要的 Python 实现（CPython）差不多，所以理解 Byterun 会帮助你理解大多数解释器，特别是 CPython 解释器。（如果你不知道你用的是什么 Python，那么很可能它就是 CPython）。尽管 Byterun 很小，但它能执行大多数简单的 Python 程序（这一章是基于 Python 3.5 及其之前版本生成的字节码的，在 Python 3.6 中生成的字节码有一些改变）。</p>
<h4>Python 解释器</h4>
<p>在开始之前，让我们限定一下“Pyhton 解释器”的意思。在讨论 Python 的时候，“解释器”这个词可以用在很多不同的地方。有的时候解释器指的是 Python REPL，即当你在命令行下敲下 <code>python</code> 时所得到的交互式环境。有时候人们会或多或少的互换使用 “Python 解释器”和“Python”来说明从头到尾执行 Python 代码的这一过程。在本章中，“解释器”有一个更精确的意思：Python 程序的执行过程中的最后一步。</p>
<p>在解释器接手之前，Python 会执行其他 3 个步骤：词法分析，语法解析和编译。这三步合起来把源代码转换成<ruby> 代码对象 <rp>  （ </rp> <rt>  code object </rt> <rp>  ） </rp></ruby>，它包含着解释器可以理解的指令。而解释器的工作就是解释代码对象中的指令。</p>
<p>你可能很奇怪执行 Python 代码会有编译这一步。Python 通常被称为解释型语言，就像 Ruby，Perl 一样，它们和像 C，Rust 这样的编译型语言相对。然而，这个术语并不是它看起来的那样精确。大多数解释型语言包括 Python 在内，确实会有编译这一步。而 Python 被称为解释型的原因是相对于编译型语言，它在编译这一步的工作相对较少（解释器做相对多的工作）。在这章后面你会看到，Python 的编译器比 C 语言编译器需要更少的关于程序行为的信息。</p>
<h4>Python 的 Python 解释器</h4>
<p>Byterun 是一个用 Python 写的 Python 解释器，这点可能让你感到奇怪，但没有比用 C 语言写 C 语言编译器更奇怪的了。（事实上，广泛使用的 gcc 编译器就是用 C 语言本身写的）你可以用几乎任何语言写一个 Python 解释器。</p>
<p>用 Python 写 Python 既有优点又有缺点。最大的缺点就是速度：用 Byterun 执行代码要比用 CPython 执行慢的多，CPython 解释器是用 C 语言实现的，并做了认真优化。然而 Byterun 是为了学习而设计的，所以速度对我们不重要。使用 Python 最大优势是我们可以<em>仅仅</em>实现解释器，而不用担心 Python 运行时部分，特别是对象系统。比如当 Byterun 需要创建一个类时，它就会回退到“真正”的 Python。另外一个优势是 Byterun 很容易理解，部分原因是它是用人们很容易理解的高级语言写的（Python ！）（另外我们不会对解释器做优化 —— 再一次，清晰和简单比速度更重要）</p>
<h3>构建一个解释器</h3>
<p>在我们考察 Byterun 代码之前，我们需要从高层次对解释器结构有一些了解。Python 解释器是如何工作的？</p>
<p>Python 解释器是一个<ruby> 虚拟机 <rp>  （ </rp> <rt>  virtual machine </rt> <rp>  ） </rp></ruby>，是一个模拟真实计算机的软件。我们这个虚拟机是<ruby> 栈机器 <rp>  （ </rp> <rt>  stack machine </rt> <rp>  ） </rp></ruby>，它用几个栈来完成操作（与之相对的是<ruby> 寄存器机器 <rp>  （ </rp> <rt>  register machine </rt> <rp>  ） </rp></ruby>，它从特定的内存地址读写数据）。</p>
<p>Python 解释器是一个<ruby> 字节码解释器 <rp>  （ </rp> <rt>  bytecode interpreter </rt> <rp>  ） </rp></ruby>：它的输入是一些称作<ruby> 字节码 <rp>  （ </rp> <rt>  bytecode </rt> <rp>  ） </rp></ruby>的指令集。当你写 Python 代码时，词法分析器、语法解析器和编译器会生成<ruby> 代码对象 <rp>  （ </rp> <rt>  code object </rt> <rp>  ） </rp></ruby>让解释器去操作。每个代码对象都包含一个要被执行的指令集 —— 它就是字节码 —— 以及还有一些解释器需要的信息。字节码是 Python 代码的一个<ruby> 中间层表示 <rp>  （ </rp> <rt>  intermediate representation </rt> <rp>  ） </rp></ruby>：它以一种解释器可以理解的方式来表示源代码。这和汇编语言作为 C 语言和机器语言的中间表示很类似。</p>
<h4>微型解释器</h4>
<p>为了让说明更具体，让我们从一个非常小的解释器开始。它只能计算两个数的和，只能理解三个指令。它执行的所有代码只是这三个指令的不同组合。下面就是这三个指令：</p>
<ul>
<li><code>LOAD_VALUE</code></li>
<li><code>ADD_TWO_VALUES</code></li>
<li><code>PRINT_ANSWER</code></li>
</ul>
<p>我们不关心词法、语法和编译，所以我们也不在乎这些指令集是如何产生的。你可以想象，当你写下 <code>7 + 5</code>，然后一个编译器为你生成那三个指令的组合。如果你有一个合适的编译器，你甚至可以用 Lisp 的语法来写，只要它能生成相同的指令。</p>
<p>假设</p>
<div class="highlight"><pre><span></span><code><span class="mf">7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">5</span>
</code></pre></div>

<p>生成这样的指令集：</p>
<div class="highlight"><pre><span></span><code>what_to_execute = {
    &quot;instructions&quot;: [(&quot;LOAD_VALUE&quot;, 0),  # the first number
                     (&quot;LOAD_VALUE&quot;, 1),  # the second number
                     (&quot;ADD_TWO_VALUES&quot;, None),
                     (&quot;PRINT_ANSWER&quot;, None)],
    &quot;numbers&quot;: [7, 5] }
</code></pre></div>

<p>Python 解释器是一个<ruby> 栈机器 <rp>  （ </rp> <rt>  stack machine </rt> <rp>  ） </rp></ruby>，所以它必须通过操作栈来完成这个加法（见下图）。解释器先执行第一条指令，<code>LOAD_VALUE</code>，把第一个数压到栈中。接着它把第二个数也压到栈中。然后，第三条指令，<code>ADD_TWO_VALUES</code>，先把两个数从栈中弹出，加起来，再把结果压入栈中。最后一步，把结果弹出并输出。</p>
<p><img alt="栈机器" src="/data/attachment/album/201609/08/141623rjyb9yjk8o8tyesc.png"></p>
<p><code>LOAD_VALUE</code>这条指令告诉解释器把一个数压入栈中，但指令本身并没有指明这个数是多少。指令需要一个额外的信息告诉解释器去哪里找到这个数。所以我们的指令集有两个部分：指令本身和一个常量列表。（在 Python 中，字节码就是我们所称的“指令”，而解释器“执行”的是代码对象。）</p>
<p>为什么不把数字直接嵌入指令之中？想象一下，如果我们加的不是数字，而是字符串。我们可不想把字符串这样的东西加到指令中，因为它可以有任意的长度。另外，我们这种设计也意味着我们只需要对象的一份拷贝，比如这个加法 <code>7 + 7</code>, 现在常量表 <code>"numbers"</code>只需包含一个<code>[7]</code>。</p>
<p>你可能会想为什么会需要除了<code>ADD_TWO_VALUES</code>之外的指令。的确，对于我们两个数加法，这个例子是有点人为制作的意思。然而，这个指令却是建造更复杂程序的轮子。比如，就我们目前定义的三个指令，只要给出正确的指令组合，我们可以做三个数的加法，或者任意个数的加法。同时，栈提供了一个清晰的方法去跟踪解释器的状态，这为我们增长的复杂性提供了支持。</p>
<p>现在让我们来完成我们的解释器。解释器对象需要一个栈，它可以用一个列表来表示。它还需要一个方法来描述怎样执行每条指令。比如，<code>LOAD_VALUE</code>会把一个值压入栈中。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="n">Interpreter:</span>
    <span class="n">def</span> <span class="n">__init__</span>(<span class="nb">self</span>):
        <span class="nb">self</span>.<span class="n">stack</span> = []

    <span class="n">def</span> <span class="n">LOAD_VALUE</span>(<span class="nb">self</span>, <span class="n">number</span>):
        <span class="nb">self</span>.<span class="n">stack</span>.<span class="nb">append</span>(<span class="n">number</span>)

    <span class="n">def</span> <span class="n">PRINT_ANSWER</span>(<span class="nb">self</span>):
        <span class="n">answer</span> = <span class="nb">self</span>.<span class="n">stack</span>.<span class="nb">pop</span>()
        <span class="nb">print</span>(<span class="n">answer</span>)

    <span class="n">def</span> <span class="n">ADD_TWO_VALUES</span>(<span class="nb">self</span>):
        <span class="n">first_num</span> = <span class="nb">self</span>.<span class="n">stack</span>.<span class="nb">pop</span>()
        <span class="n">second_num</span> = <span class="nb">self</span>.<span class="n">stack</span>.<span class="nb">pop</span>()
        <span class="nb">total</span> = <span class="n">first_num</span> + <span class="n">second_num</span>
        <span class="nb">self</span>.<span class="n">stack</span>.<span class="nb">append</span>(<span class="nb">total</span>)
</code></pre></div>

<p>这三个方法完成了解释器所理解的三条指令。但解释器还需要一样东西：一个能把所有东西结合在一起并执行的方法。这个方法就叫做 <code>run_code</code>，它把我们前面定义的字典结构 <code>what-to-execute</code> 作为参数，循环执行里面的每条指令，如果指令有参数就处理参数，然后调用解释器对象中相应的方法。</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">run_code</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">what_to_execute</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what_to_execute</span><span class="o">[</span><span class="n">&quot;instructions&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what_to_execute</span><span class="o">[</span><span class="n">&quot;numbers&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">each_step</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">instructions</span><span class="p">:</span>
<span class="w">            </span><span class="n">instruction</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">each_step</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;LOAD_VALUE&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numbers</span><span class="o">[</span><span class="n">argument</span><span class="o">]</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">LOAD_VALUE</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;ADD_TWO_VALUES&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">ADD_TWO_VALUES</span><span class="p">()</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;PRINT_ANSWER&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">PRINT_ANSWER</span><span class="p">()</span>
</code></pre></div>

<p>为了测试，我们创建一个解释器对象，然后用前面定义的 7 + 5 的指令集来调用 <code>run_code</code>。</p>
<div class="highlight"><pre><span></span><code>    interpreter = Interpreter()
    interpreter.run_code(what_to_execute)
</code></pre></div>

<p>显然，它会输出 12。</p>
<p>尽管我们的解释器功能十分受限，但这个过程几乎和真正的 Python 解释器处理加法是一样的。这里，我们还有几点要注意。</p>
<p>首先，一些指令需要参数。在真正的 Python 字节码当中，大概有一半的指令有参数。像我们的例子一样，参数和指令打包在一起。注意指令的参数和传递给对应方法的参数是不同的。</p>
<p>第二，指令<code>ADD_TWO_VALUES</code>不需要任何参数，它从解释器栈中弹出所需的值。这正是以基于栈的解释器的特点。</p>
<p>记得我们说过只要给出合适的指令集，不需要对解释器做任何改变，我们就能做多个数的加法。考虑下面的指令集，你觉得会发生什么？如果你有一个合适的编译器，什么代码才能编译出下面的指令集？</p>
<div class="highlight"><pre><span></span><code>    what_to_execute = {
        &quot;instructions&quot;: [(&quot;LOAD_VALUE&quot;, 0),
                         (&quot;LOAD_VALUE&quot;, 1),
                         (&quot;ADD_TWO_VALUES&quot;, None),
                         (&quot;LOAD_VALUE&quot;, 2),
                         (&quot;ADD_TWO_VALUES&quot;, None),
                         (&quot;PRINT_ANSWER&quot;, None)],
        &quot;numbers&quot;: [7, 5, 8] }
</code></pre></div>

<p>从这点出发，我们开始看到这种结构的可扩展性：我们可以通过向解释器对象增加方法来描述更多的操作（只要有一个编译器能为我们生成组织良好的指令集就行）。</p>
<h5>变量</h5>
<p>接下来给我们的解释器增加变量的支持。我们需要一个保存变量值的指令 <code>STORE_NAME</code>；一个取变量值的指令<code>LOAD_NAME</code>；和一个变量到值的映射关系。目前，我们会忽略命名空间和作用域，所以我们可以把变量和值的映射直接存储在解释器对象中。最后，我们要保证<code>what_to_execute</code>除了一个常量列表，还要有个变量名字的列表。</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">s</span><span class="p">()</span><span class="o">:</span>
<span class="p">...</span><span class="w">     </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="p">...</span><span class="w">     </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="p">...</span><span class="w">     </span><span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="c1"># a friendly compiler transforms `s` into:</span>
<span class="w">    </span><span class="n">what_to_execute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="s2">&quot;instructions&quot;</span><span class="o">:</span><span class="w"> </span><span class="err">[</span><span class="p">(</span><span class="s2">&quot;LOAD_VALUE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;STORE_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;LOAD_VALUE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;STORE_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;LOAD_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;LOAD_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;ADD_TWO_VALUES&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">None</span><span class="p">),</span>
<span class="w">                         </span><span class="p">(</span><span class="s2">&quot;PRINT_ANSWER&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">None</span><span class="p">)</span><span class="err">]</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;numbers&quot;</span><span class="o">:</span><span class="w"> </span><span class="err">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="err">]</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;names&quot;</span><span class="o">:</span><span class="w">   </span><span class="err">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;b&quot;</span><span class="err">]</span><span class="w"> </span><span class="err">}</span>
</code></pre></div>

<p>我们的新的实现在下面。为了跟踪哪个名字绑定到哪个值，我们在<code>__init__</code>方法中增加一个<code>environment</code>字典。我们也增加了<code>STORE_NAME</code>和<code>LOAD_NAME</code>方法，它们获得变量名，然后从<code>environment</code>字典中设置或取出这个变量值。</p>
<p>现在指令的参数就有两个不同的意思，它可能是<code>numbers</code>列表的索引，也可能是<code>names</code>列表的索引。解释器通过检查所执行的指令就能知道是那种参数。而我们打破这种逻辑 ，把指令和它所用何种参数的映射关系放在另一个单独的方法中。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">Interpreter</span><span class="p">:</span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">STORE_NAME</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">environment</span><span class="o">[</span><span class="n">name</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">LOAD_NAME</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">environment</span><span class="o">[</span><span class="n">name</span><span class="o">]</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">parse_argument</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">instruction</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="p">,</span><span class="w"> </span><span class="n">what_to_execute</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="ss">&quot;&quot;&quot; Understand what the argument to each instruction means.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;LOAD_VALUE&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="k">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;LOAD_NAME&quot;, &quot;STORE_NAME&quot;</span><span class="o">]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">numbers</span><span class="p">:</span>
<span class="w">            </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what_to_execute</span><span class="o">[</span><span class="n">&quot;numbers&quot;</span><span class="o">][</span><span class="n">argument</span><span class="o">]</span>
<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">names</span><span class="err">:</span>
<span class="w">            </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what_to_execute</span><span class="o">[</span><span class="n">&quot;names&quot;</span><span class="o">][</span><span class="n">argument</span><span class="o">]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">argument</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">run_code</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">what_to_execute</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">what_to_execute</span><span class="o">[</span><span class="n">&quot;instructions&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">each_step</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">instructions</span><span class="p">:</span>
<span class="w">            </span><span class="n">instruction</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">each_step</span>
<span class="w">            </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">parse_argument</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="p">,</span><span class="w"> </span><span class="n">what_to_execute</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;LOAD_VALUE&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">LOAD_VALUE</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;ADD_TWO_VALUES&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">ADD_TWO_VALUES</span><span class="p">()</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;PRINT_ANSWER&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">PRINT_ANSWER</span><span class="p">()</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;STORE_NAME&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">STORE_NAME</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;LOAD_NAME&quot;</span><span class="err">:</span>
<span class="w">                </span><span class="n">self</span><span class="p">.</span><span class="n">LOAD_NAME</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
</code></pre></div>

<p>仅仅五个指令，<code>run_code</code>这个方法已经开始变得冗长了。如果保持这种结构，那么每条指令都需要一个<code>if</code>分支。这里，我们要利用 Python 的动态方法查找。我们总会给一个称为<code>FOO</code>的指令定义一个名为<code>FOO</code>的方法，这样我们就可用 Python 的<code>getattr</code>函数在运行时动态查找方法，而不用这个大大的分支结构。<code>run_code</code>方法现在是这样：</p>
<div class="highlight"><pre><span></span><code>    def execute(self, what_to_execute):
        instructions = what_to_execute[&quot;instructions&quot;]
        for each_step in instructions:
            instruction, argument = each_step
            argument = self.parse_argument(instruction, argument, what_to_execute)
            bytecode_method = getattr(self, instruction)
            if argument is None:
                bytecode_method()
            else:
                bytecode_method(argument)
</code></pre></div>

<h3>真实的 Python 字节码</h3>
<p>现在，放弃我们的小指令集，去看看真正的 Python 字节码。字节码的结构和我们的小解释器的指令集差不多，除了字节码用一个字节而不是一个名字来代表这条指令。为了理解它的结构，我们将考察一个函数的字节码。考虑下面这个例子：</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">def</span><span class="w"> </span><span class="nv">cond</span><span class="ss">()</span>:
...<span class="w">     </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
...<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span>:
...<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;yes&#39;</span>
...<span class="w">     </span><span class="k">else</span>:
...<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;no&#39;</span>
...
</code></pre></div>

<p>Python 在运行时会暴露一大批内部信息，并且我们可以通过 REPL 直接访问这些信息。对于函数对象<code>cond</code>，<code>cond.__code__</code>是与其关联的代码对象，而<code>cond.__code__.co_code</code>就是它的字节码。当你写 Python 代码时，你永远也不会想直接使用这些属性，但是这可以让我们做出各种恶作剧，同时也可以看看内部机制。</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; cond.__code__.co_code  # the bytecode as raw bytes
b&#39;d\x01\x00}\x00\x00|\x00\x00d\x02\x00k\x00\x00r\x16\x00d\x03\x00Sd\x04\x00Sd\x00
   \x00S&#39;
&gt;&gt;&gt; list(cond.__code__.co_code)  # the bytecode as numbers
[100, 1, 0, 125, 0, 0, 124, 0, 0, 100, 2, 0, 107, 0, 0, 114, 22, 0, 100, 3, 0, 83, 
 100, 4, 0, 83, 100, 0, 0, 83]
</code></pre></div>

<p>当我们直接输出这个字节码，它看起来完全无法理解 —— 唯一我们了解的是它是一串字节。很幸运，我们有一个很强大的工具可以用：Python 标准库中的<code>dis</code>模块。</p>
<p><code>dis</code>是一个字节码反汇编器。反汇编器以为机器而写的底层代码作为输入，比如汇编代码和字节码，然后以人类可读的方式输出。当我们运行<code>dis.dis</code>，它输出每个字节码的解释。</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; dis.dis(cond)
  2           0 LOAD_CONST               1 (3)
              3 STORE_FAST               0 (x)

  3           6 LOAD_FAST                0 (x)
              9 LOAD_CONST               2 (5)
             12 COMPARE_OP               0 (&lt;)
             15 POP_JUMP_IF_FALSE       22

  4          18 LOAD_CONST               3 (&#39;yes&#39;)
             21 RETURN_VALUE

  6     &gt;&gt;   22 LOAD_CONST               4 (&#39;no&#39;)
             25 RETURN_VALUE
             26 LOAD_CONST               0 (None)
             29 RETURN_VALUE
</code></pre></div>

<p>这些都是什么意思？让我们以第一条指令<code>LOAD_CONST</code>为例子。第一列的数字（<code>2</code>）表示对应源代码的行数。第二列的数字是字节码的索引，告诉我们指令<code>LOAD_CONST</code>在位置 0 。第三列是指令本身对应的人类可读的名字。如果第四列存在，它表示指令的参数。如果第五列存在，它是一个关于参数是什么的提示。</p>
<p>考虑这个字节码的前几个字节：[100, 1, 0, 125, 0, 0]。这 6 个字节表示两条带参数的指令。我们可以使用<code>dis.opname</code>，一个字节到可读字符串的映射，来找到指令 100 和指令 125 代表的是什么：</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; dis.opname[100]
&#39;LOAD_CONST&#39;
&gt;&gt;&gt; dis.opname[125]
&#39;STORE_FAST&#39;
</code></pre></div>

<p>第二和第三个字节 —— 1 、0 ——是<code>LOAD_CONST</code>的参数，第五和第六个字节 —— 0、0 —— 是<code>STORE_FAST</code>的参数。就像我们前面的小例子，<code>LOAD_CONST</code>需要知道的到哪去找常量，<code>STORE_FAST</code>需要知道要存储的名字。（Python 的<code>LOAD_CONST</code>和我们小例子中的<code>LOAD_VALUE</code>一样，<code>LOAD_FAST</code>和<code>LOAD_NAME</code>一样）。所以这六个字节代表第一行源代码<code>x = 3</code> （为什么用两个字节表示指令的参数？如果 Python 使用一个字节，每个代码对象你只能有 256 个常量/名字，而用两个字节，就增加到了 256 的平方，65536个）。</p>
<h4>条件语句与循环语句</h4>
<p>到目前为止，我们的解释器只能一条接着一条的执行指令。这有个问题，我们经常会想多次执行某个指令，或者在特定的条件下跳过它们。为了可以写循环和分支结构，解释器必须能够在指令中跳转。在某种程度上，Python 在字节码中使用<code>GOTO</code>语句来处理循环和分支！让我们再看一个<code>cond</code>函数的反汇编结果：</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; dis.dis(cond)
  2           0 LOAD_CONST               1 (3)
              3 STORE_FAST               0 (x)

  3           6 LOAD_FAST                0 (x)
              9 LOAD_CONST               2 (5)
             12 COMPARE_OP               0 (&lt;)
             15 POP_JUMP_IF_FALSE       22

  4          18 LOAD_CONST               3 (&#39;yes&#39;)
             21 RETURN_VALUE

  6     &gt;&gt;   22 LOAD_CONST               4 (&#39;no&#39;)
             25 RETURN_VALUE
             26 LOAD_CONST               0 (None)
             29 RETURN_VALUE
</code></pre></div>

<p>第三行的条件表达式<code>if x &lt; 5</code>被编译成四条指令：<code>LOAD_FAST</code>、 <code>LOAD_CONST</code>、 <code>COMPARE_OP</code>和 <code>POP_JUMP_IF_FALSE</code>。<code>x &lt; 5</code>对应加载<code>x</code>、加载 5、比较这两个值。指令<code>POP_JUMP_IF_FALSE</code>完成这个<code>if</code>语句。这条指令把栈顶的值弹出，如果值为真，什么都不发生。如果值为假，解释器会跳转到另一条指令。</p>
<p>这条将被加载的指令称为跳转目标，它作为指令<code>POP_JUMP</code>的参数。这里，跳转目标是 22，索引为 22 的指令是<code>LOAD_CONST</code>，对应源码的第 6 行。（<code>dis</code>用<code>&gt;&gt;</code>标记跳转目标。）如果<code>X &lt; 5</code>为假，解释器会忽略第四行（<code>return yes</code>），直接跳转到第6行（<code>return "no"</code>）。因此解释器通过跳转指令选择性的执行指令。</p>
<p>Python 的循环也依赖于跳转。在下面的字节码中，<code>while x &lt; 5</code>这一行产生了和<code>if x &lt; 10</code>几乎一样的字节码。在这两种情况下，解释器都是先执行比较，然后执行<code>POP_JUMP_IF_FALSE</code>来控制下一条执行哪个指令。第四行的最后一条字节码<code>JUMP_ABSOLUT</code>(循环体结束的地方），让解释器返回到循环开始的第 9 条指令处。当 <code>x &lt; 10</code>变为假，<code>POP_JUMP_IF_FALSE</code>会让解释器跳到循环的终止处，第 34 条指令。</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; def loop():
<span class="k">...</span>      x = 1
<span class="k">...</span>      while x &lt; 5:
<span class="k">...</span>          x = x + 1
<span class="k">...</span>      return x
...
&gt;&gt;&gt; dis.dis(loop)
  2           0 LOAD_CONST               1 (1)
              3 STORE_FAST               0 (x)

  3           6 SETUP_LOOP              26 (to 35)
        &gt;&gt;    9 LOAD_FAST                0 (x)
             12 LOAD_CONST               2 (5)
             15 COMPARE_OP               0 (&lt;)
             18 POP_JUMP_IF_FALSE       34

  4          21 LOAD_FAST                0 (x)
             24 LOAD_CONST               1 (1)
             27 BINARY_ADD
             28 STORE_FAST               0 (x)
             31 JUMP_ABSOLUTE            9
        &gt;&gt;   34 POP_BLOCK

  5     &gt;&gt;   35 LOAD_FAST                0 (x)
             38 RETURN_VALUE
</code></pre></div>

<h4>探索字节码</h4>
<p>我希望你用<code>dis.dis</code>来试试你自己写的函数。一些有趣的问题值得探索：</p>
<ul>
<li>对解释器而言 for 循环和 while 循环有什么不同？</li>
<li>能不能写出两个不同函数，却能产生相同的字节码?</li>
<li><code>elif</code>是怎么工作的？列表推导呢？</li>
</ul>
<h3>帧</h3>
<p>到目前为止，我们已经知道了 Python 虚拟机是一个栈机器。它能顺序执行指令，在指令间跳转，压入或弹出栈值。但是这和我们期望的解释器还有一定距离。在前面的那个例子中，最后一条指令是<code>RETURN_VALUE</code>，它和<code>return</code>语句相对应。但是它返回到哪里去呢？</p>
<p>为了回答这个问题，我们必须再增加一层复杂性：<ruby> 帧 <rp>  （ </rp> <rt>  frame </rt> <rp>  ） </rp></ruby>。一个帧是一些信息的集合和代码的执行上下文。帧在 Python 代码执行时动态地创建和销毁。每个帧对应函数的一次调用 —— 所以每个帧只有一个代码对象与之关联，而一个代码对象可以有多个帧。比如你有一个函数递归的调用自己 10 次，这会产生 11 个帧，每次调用对应一个，再加上启动模块对应的一个帧。总的来说，Python 程序的每个作用域都有一个帧，比如，模块、函数、类定义。</p>
<p>帧存在于<ruby> 调用栈 <rp>  （ </rp> <rt>  call stack </rt> <rp>  ） </rp></ruby>中，一个和我们之前讨论的完全不同的栈。（你最熟悉的栈就是调用栈，就是你经常看到的异常回溯，每个以"File 'program.py'"开始的回溯对应一个帧。）解释器在执行字节码时操作的栈，我们叫它<ruby> 数据栈 <rp>  （ </rp> <rt>  data stack </rt> <rp>  ） </rp></ruby>。其实还有第三个栈，叫做<ruby> 块栈 <rp>  （ </rp> <rt>  block stack </rt> <rp>  ） </rp></ruby>，用于特定的控制流块，比如循环和异常处理。调用栈中的每个帧都有它自己的数据栈和块栈。</p>
<p>让我们用一个具体的例子来说明一下。假设 Python 解释器执行到下面标记为 3 的地方。解释器正处于<code>foo</code>函数的调用中，它接着调用<code>bar</code>。下面是帧调用栈、块栈和数据栈的示意图。我们感兴趣的是解释器先从最底下的<code>foo()</code>开始，接着执行<code>foo</code>的函数体，然后到达<code>bar</code>。</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">def</span><span class="w"> </span><span class="nv">bar</span><span class="ss">(</span><span class="nv">y</span><span class="ss">)</span>:
...<span class="w">     </span><span class="nv">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w">     </span>#<span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="ss">(</span><span class="mi">3</span><span class="ss">)</span><span class="w"> </span>...<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">interpreter</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">here</span>.
...<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="nv">z</span>
...
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">def</span><span class="w"> </span><span class="nv">foo</span><span class="ss">()</span>:
...<span class="w">     </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
...<span class="w">     </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
...<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">bar</span><span class="ss">(</span><span class="nv">b</span><span class="ss">)</span><span class="w"> </span>#<span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="ss">(</span><span class="mi">2</span><span class="ss">)</span><span class="w"> </span>...<span class="w"> </span><span class="nv">which</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">returning</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="nl">to</span><span class="w"> </span><span class="nv">bar</span><span class="w"> </span>...
...
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="nv">foo</span><span class="ss">()</span><span class="w">             </span>#<span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span><span class="w"> </span><span class="nv">We</span><span class="err">&#39;re in the middle of a call to foo ...</span>
<span class="err">3</span>
</code></pre></div>

<p><img alt="调用栈" src="/data/attachment/album/201609/08/141633dwztqktnwthtttto.png"></p>
<p>现在，解释器处于<code>bar</code>函数的调用中。调用栈中有 3 个帧：一个对应于模块层，一个对应函数<code>foo</code>，另一个对应函数<code>bar</code>。（见上图）一旦<code>bar</code>返回，与它对应的帧就会从调用栈中弹出并丢弃。</p>
<p>字节码指令<code>RETURN_VALUE</code>告诉解释器在帧之间传递一个值。首先，它把位于调用栈栈顶的帧中的数据栈的栈顶值弹出。然后把整个帧弹出丢弃。最后把这个值压到下一个帧的数据栈中。</p>
<p>当 Ned Batchelder 和我在写 Byterun 时，很长一段时间我们的实现中一直有个重大的错误。我们整个虚拟机中只有一个数据栈，而不是每个帧都有一个。我们写了很多测试代码，同时在 Byterun 和真正的 Python 上运行，希望得到一致结果。我们几乎通过了所有测试，只有一样东西不能通过，那就是<ruby> 生成器 <rp>  （ </rp> <rt>  generators </rt> <rp>  ） </rp></ruby>。最后，通过仔细的阅读 CPython 的源码，我们发现了错误所在（感谢 Michael Arntzenius 对这个 bug 的洞悉）。把数据栈移到每个帧就解决了这个问题。</p>
<p>回头在看看这个 bug，我惊讶的发现 Python 真的很少依赖于每个帧有一个数据栈这个特性。在 Python 中几乎所有的操作都会清空数据栈，所以所有的帧公用一个数据栈是没问题的。在上面的例子中，当<code>bar</code>执行完后，它的数据栈为空。即使<code>foo</code>公用这一个栈，它的值也不会受影响。然而，对应生成器，它的一个关键的特点是它能暂停一个帧的执行，返回到其他的帧，一段时间后它能返回到原来的帧，并以它离开时的相同状态继续执行。</p>
<h3>Byterun</h3>
<p>现在我们有足够的 Python 解释器的知识背景去考察 Byterun。</p>
<p>Byterun 中有四种对象。</p>
<ul>
<li><code>VirtualMachine</code>类，它管理高层结构，尤其是帧调用栈，并包含了指令到操作的映射。这是一个比前面<code>Inteprter</code>对象更复杂的版本。</li>
<li><code>Frame</code>类，每个<code>Frame</code>类都有一个代码对象，并且管理着其他一些必要的状态位，尤其是全局和局部命名空间、指向调用它的整的指针和最后执行的字节码指令。</li>
<li><code>Function</code>类，它被用来代替真正的 Python 函数。回想一下，调用函数时会创建一个新的帧。我们自己实现了<code>Function</code>，以便我们控制新的<code>Frame</code>的创建。</li>
<li><code>Block</code>类，它只是包装了块的 3 个属性。（块的细节不是解释器的核心，我们不会花时间在它身上，把它列在这里，是因为 Byterun 需要它。）</li>
</ul>
<h4><code>VirtualMachine</code> 类</h4>
<p>每次程序运行时只会创建一个<code>VirtualMachine</code>实例，因为我们只有一个 Python 解释器。<code>VirtualMachine</code> 保存调用栈、异常状态、在帧之间传递的返回值。它的入口点是<code>run_code</code>方法，它以编译后的代码对象为参数，以创建一个帧为开始，然后运行这个帧。这个帧可能再创建出新的帧；调用栈随着程序的运行而增长和缩短。当第一个帧返回时，执行结束。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="n">VirtualMachineError</span>(<span class="nb">Exception</span>):
    <span class="nb">pass</span>

<span class="k">class</span> <span class="n">VirtualMachine</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__init__</span>(<span class="nb">self</span>):
        <span class="nb">self</span>.<span class="n">frames</span> = []   <span class="c1"># The call stack of frames.</span>
        <span class="nb">self</span>.<span class="n">frame</span> = <span class="n">None</span>  <span class="c1"># The current frame.</span>
        <span class="nb">self</span>.<span class="n">return_value</span> = <span class="n">None</span>
        <span class="nb">self</span>.<span class="n">last_exception</span> = <span class="n">None</span>

    <span class="n">def</span> <span class="n">run_code</span>(<span class="nb">self</span>, <span class="nb">code</span>, <span class="n">global_names</span>=<span class="n">None</span>, <span class="n">local_names</span>=<span class="n">None</span>):
        <span class="s">&quot;&quot;&quot; An entry point to execute code using the virtual machine.&quot;&quot;&quot;</span>
        <span class="n">frame</span> = <span class="nb">self</span>.<span class="n">make_frame</span>(<span class="nb">code</span>, <span class="n">global_names</span>=<span class="n">global_names</span>, 
                                <span class="n">local_names</span>=<span class="n">local_names</span>)
        <span class="nb">self</span>.<span class="n">run_frame</span>(<span class="n">frame</span>)
</code></pre></div>

<h4><code>Frame</code> 类</h4>
<p>接下来，我们来写<code>Frame</code>对象。帧是一个属性的集合，它没有任何方法。前面提到过，这些属性包括由编译器生成的代码对象；局部、全局和内置命名空间；前一个帧的引用；一个数据栈；一个块栈；最后执行的指令指针。（对于内置命名空间我们需要多做一点工作，Python 在不同模块中对这个命名空间有不同的处理；但这个细节对我们的虚拟机不重要。）</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="n">Frame</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__init__</span>(<span class="nb">self</span>, <span class="n">code_obj</span>, <span class="n">global_names</span>, <span class="n">local_names</span>, <span class="n">prev_frame</span>):
        <span class="nb">self</span>.<span class="n">code_obj</span> = <span class="n">code_obj</span>
        <span class="nb">self</span>.<span class="n">global_names</span> = <span class="n">global_names</span>
        <span class="nb">self</span>.<span class="n">local_names</span> = <span class="n">local_names</span>
        <span class="nb">self</span>.<span class="n">prev_frame</span> = <span class="n">prev_frame</span>
        <span class="nb">self</span>.<span class="n">stack</span> = []
        <span class="k">if</span> <span class="n">prev_frame:</span>
            <span class="nb">self</span>.<span class="n">builtin_names</span> = <span class="n">prev_frame</span>.<span class="n">builtin_names</span>
        <span class="n">else:</span>
            <span class="nb">self</span>.<span class="n">builtin_names</span> = <span class="n">local_names</span>[<span class="s">&#39;__builtins__&#39;</span>]
            <span class="k">if</span> <span class="n">hasattr</span>(<span class="nb">self</span>.<span class="n">builtin_names</span>, <span class="s">&#39;__dict__&#39;</span>):
                <span class="nb">self</span>.<span class="n">builtin_names</span> = <span class="nb">self</span>.<span class="n">builtin_names</span>.<span class="n">__dict__</span>

        <span class="nb">self</span>.<span class="n">last_instruction</span> = <span class="mi">0</span>
        <span class="nb">self</span>.<span class="n">block_stack</span> = []
</code></pre></div>

<p>接着，我们在虚拟机中增加对帧的操作。这有 3 个帮助函数：一个创建新的帧的方法（它负责为新的帧找到名字空间），和压栈和出栈的方法。第四个函数，<code>run_frame</code>，完成执行帧的主要工作，待会我们再讨论这个方法。</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachine</span><span class="p">(</span><span class="nx">object</span><span class="p">):</span>
<span class="w">    </span><span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="nx">删节</span><span class="w"> </span><span class="o">...</span><span class="p">]</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">Frame</span><span class="w"> </span><span class="nx">manipulation</span>
<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">make_frame</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">callargs</span><span class="p">={},</span><span class="w"> </span><span class="nx">global_names</span><span class="p">=</span><span class="nx">None</span><span class="p">,</span><span class="w"> </span><span class="nx">local_names</span><span class="p">=</span><span class="nx">None</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">global_names</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">None</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">local_names</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">None</span><span class="p">:</span>
<span class="w">            </span><span class="nx">local_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">global_names</span>
<span class="w">        </span><span class="nx">elif</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frames</span><span class="p">:</span>
<span class="w">            </span><span class="nx">global_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">global_names</span>
<span class="w">            </span><span class="nx">local_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="nx">global_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">local_names</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="err">&#39;</span><span class="nx">__builtins__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">__builtins__</span><span class="p">,</span>
<span class="w">                </span><span class="err">&#39;</span><span class="nx">__name__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__main__</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="err">&#39;</span><span class="nx">__doc__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">,</span>
<span class="w">                </span><span class="err">&#39;</span><span class="nx">__package__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="nx">local_names</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">callargs</span><span class="p">)</span>
<span class="w">        </span><span class="nx">frame</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Frame</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">global_names</span><span class="p">,</span><span class="w"> </span><span class="nx">local_names</span><span class="p">,</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">frame</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">push_frame</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">frame</span><span class="p">):</span>
<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">frames</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span>
<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">frame</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">pop_frame</span><span class="p">(</span><span class="kp">self</span><span class="p">):</span>
<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">frames</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frames</span><span class="p">:</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">None</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">run_frame</span><span class="p">(</span><span class="kp">self</span><span class="p">):</span>
<span class="w">        </span><span class="nx">pass</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nx">we</span><span class="err">&#39;</span><span class="nx">ll</span><span class="w"> </span><span class="nx">come</span><span class="w"> </span><span class="nx">back</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">shortly</span>
</code></pre></div>

<h4><code>Function</code> 类</h4>
<p><code>Function</code>的实现有点曲折，但是大部分的细节对理解解释器不重要。重要的是当调用函数时 —— 即调用 <code>__call__</code>方法 —— 它创建一个新的<code>Frame</code>并运行它。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">Function</span><span class="p">(</span><span class="n">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a realistic function object, defining the things the interpreter expects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">__slots__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;func_code&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;func_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;func_defaults&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;func_globals&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;func_locals&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;func_dict&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;func_closure&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__doc__&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;_vm&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_func&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">]</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">globs</span><span class="p">,</span><span class="w"> </span><span class="n">defaults</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">,</span><span class="w"> </span><span class="n">vm</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;You don&#39;t need to follow this closely to understand the interpreter.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">func_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__name__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">func_defaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tuple</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">func_globals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">globs</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">func_locals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_vm</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">func_closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">closure</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">code</span><span class="o">.</span><span class="n">co_consts</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">None</span>

<span class="w">        </span><span class="c1"># Sometimes, we need a real Python function.  This is for that.</span>
<span class="w">        </span><span class="n">kw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;argdefs&#39;</span><span class="p">:</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">func_defaults</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">closure</span><span class="p">:</span>
<span class="w">            </span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;closure&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tuple</span><span class="p">(</span><span class="n">make_cell</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">globs</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;When calling a Function, make a new frame and run it.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">callargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inspect</span><span class="o">.</span><span class="n">getcallargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="w">        </span><span class="c1"># Use callargs to provide a mapping of arguments: values to pass into the new </span>
<span class="w">        </span><span class="c1"># frame.</span>
<span class="w">        </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_vm</span><span class="o">.</span><span class="n">make_frame</span><span class="p">(</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">func_code</span><span class="p">,</span><span class="w"> </span><span class="n">callargs</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">func_globals</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_vm</span><span class="o">.</span><span class="n">run_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

<span class="n">def</span><span class="w"> </span><span class="n">make_cell</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a real Python closure and grab a cell.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="c1"># Thanks to Alex Gaynor for help with this bit of twistiness.</span>
<span class="w">    </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">lambda</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fn</span><span class="o">.</span><span class="n">__closure__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<p>接着，回到<code>VirtualMachine</code>对象，我们对数据栈的操作也增加一些帮助方法。字节码操作的栈总是在当前帧的数据栈。这些帮助函数让我们的<code>POP_TOP</code>、<code>LOAD_FAST</code>以及其他操作栈的指令的实现可读性更高。</p>
<div class="highlight"><pre><span></span><code><span class="n">class</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="err">[</span><span class="p">...</span><span class="w"> </span><span class="n">删节</span><span class="w"> </span><span class="p">...</span><span class="err">]</span>

<span class="w">    </span><span class="c1"># Data stack manipulation</span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">top</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stack</span><span class="err">[</span><span class="o">-</span><span class="mi">1</span><span class="err">]</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">pop</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">push</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">vals</span><span class="p">)</span><span class="o">:</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">popn</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="o">:</span>
<span class="w">        </span><span class="s2">&quot;</span><span class="se">&quot;&quot;</span><span class="s2">Pop a number of values from the value stack.</span>
<span class="s2">        A list of `n` values is returned, the deepest value first.</span>
<span class="s2">        </span><span class="se">&quot;&quot;</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="o">:</span>
<span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stack</span><span class="err">[</span><span class="o">-</span><span class="n">n</span><span class="o">:</span><span class="err">]</span>
<span class="w">            </span><span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">stack</span><span class="err">[</span><span class="o">-</span><span class="n">n</span><span class="o">:</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span>
<span class="w">        </span><span class="k">else</span><span class="o">:</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="err">[]</span>
</code></pre></div>

<p>在我们运行帧之前，我们还需两个方法。</p>
<p>第一个方法，<code>parse_byte_and_args</code> 以一个字节码为输入，先检查它是否有参数，如果有，就解析它的参数。这个方法同时也更新帧的<code>last_instruction</code>属性，它指向最后执行的指令。一条没有参数的指令只有一个字节长度，而有参数的字节有3个字节长。参数的意义依赖于指令是什么。比如，前面说过，指令<code>POP_JUMP_IF_FALSE</code>，它的参数指的是跳转目标。<code>BUILD_LIST</code>，它的参数是列表的个数。<code>LOAD_CONST</code>，它的参数是常量的索引。</p>
<p>一些指令用简单的数字作为参数。对于另一些，虚拟机需要一点努力去发现它含意。标准库中的<code>dis</code>模块中有一个备忘单，它解释什么参数有什么意思，这让我们的代码更加简洁。比如，列表<code>dis.hasname</code>告诉我们<code>LOAD_NAME</code>、 <code>IMPORT_NAME</code>、<code>LOAD_GLOBAL</code>，以及另外的 9 个指令的参数都有同样的意义：对于这些指令，它们的参数代表了代码对象中的名字列表的索引。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">(</span><span class="k">object</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="o">[</span><span class="n">... 删节 ...</span><span class="o">]</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">parse_byte_and_args</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">frame</span>
<span class="w">        </span><span class="n">opoffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">last_instruction</span>
<span class="w">        </span><span class="n">byteCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">code_obj</span><span class="p">.</span><span class="n">co_code</span><span class="o">[</span><span class="n">opoffset</span><span class="o">]</span>
<span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="n">last_instruction</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">byte_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dis</span><span class="p">.</span><span class="n">opname</span><span class="o">[</span><span class="n">byteCode</span><span class="o">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">byteCode</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dis</span><span class="p">.</span><span class="nl">HAVE_ARGUMENT</span><span class="p">:</span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">bytecode</span>
<span class="w">            </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">code_obj</span><span class="p">.</span><span class="n">co_code</span><span class="o">[</span><span class="n">f.last_instruction:f.last_instruction+2</span><span class="o">]</span><span class="w">  </span>
<span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="n">last_instruction</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">advance</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">instruction</span><span class="w"> </span><span class="n">pointer</span>
<span class="w">            </span><span class="n">arg_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">byteCode</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dis</span><span class="p">.</span><span class="nl">hasconst</span><span class="p">:</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="n">Look</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">constant</span>
<span class="w">                </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">code_obj</span><span class="p">.</span><span class="n">co_consts</span><span class="o">[</span><span class="n">arg_val</span><span class="o">]</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">byteCode</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dis</span><span class="p">.</span><span class="nl">hasname</span><span class="p">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Look</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">name</span>
<span class="w">                </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">code_obj</span><span class="p">.</span><span class="n">co_names</span><span class="o">[</span><span class="n">arg_val</span><span class="o">]</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">byteCode</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dis</span><span class="p">.</span><span class="nl">haslocal</span><span class="p">:</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Look</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">name</span>
<span class="w">                </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">code_obj</span><span class="p">.</span><span class="n">co_varnames</span><span class="o">[</span><span class="n">arg_val</span><span class="o">]</span>
<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">byteCode</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">dis</span><span class="p">.</span><span class="nl">hasjrel</span><span class="p">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">relative</span><span class="w"> </span><span class="n">jump</span>
<span class="w">                </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">last_instruction</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">arg_val</span>
<span class="w">            </span><span class="k">else</span><span class="err">:</span>
<span class="w">                </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_val</span>
<span class="w">            </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">arg</span><span class="o">]</span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span>
<span class="w">            </span><span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">byte_name</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span>
</code></pre></div>

<p>下一个方法是<code>dispatch</code>，它查找给定的指令并执行相应的操作。在 CPython 中，这个分派函数用一个巨大的 switch 语句实现，有超过 1500 行的代码。幸运的是，我们用的是 Python，我们的代码会简洁的多。我们会为每一个字节码名字定义一个方法，然后用<code>getattr</code>来查找。就像我们前面的小解释器一样，如果一条指令叫做<code>FOO_BAR</code>，那么它对应的方法就是<code>byte_FOO_BAR</code>。现在，我们先把这些方法当做一个黑盒子。每个指令方法都会返回<code>None</code>或者一个字符串<code>why</code>,有些情况下虚拟机需要这个额外<code>why</code>信息。这些指令方法的返回值，仅作为解释器状态的内部指示，千万不要和执行帧的返回值相混淆。</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachine</span><span class="p">(</span><span class="nx">object</span><span class="p">):</span>
<span class="w">    </span><span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="nx">删节</span><span class="w"> </span><span class="o">...</span><span class="p">]</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">dispatch</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">byte_name</span><span class="p">,</span><span class="w"> </span><span class="nx">argument</span><span class="p">):</span>
<span class="w">        </span><span class="s">&quot;&quot;&quot; Dispatch by bytename to the corresponding methods.</span>
<span class="s">        Exceptions are caught and set on the virtual machine.&quot;&quot;&quot;</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nx">When</span><span class="w"> </span><span class="nx">later</span><span class="w"> </span><span class="nx">unwinding</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">block</span><span class="w"> </span><span class="nx">stack</span><span class="p">,</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">keep</span><span class="w"> </span><span class="nx">track</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">doing</span><span class="w"> </span><span class="nx">it</span><span class="p">.</span>
<span class="w">        </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">None</span>
<span class="w">        </span><span class="nx">try</span><span class="p">:</span>
<span class="w">            </span><span class="nx">bytecode_fn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getattr</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">byte_</span><span class="o">%</span><span class="nx">s</span><span class="err">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">byte_name</span><span class="p">,</span><span class="w"> </span><span class="nx">None</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">bytecode_fn</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">None</span><span class="p">:</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">byte_name</span><span class="p">.</span><span class="nx">startswith</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">UNARY_</span><span class="err">&#39;</span><span class="p">):</span>
<span class="w">                    </span><span class="kp">self</span><span class="p">.</span><span class="nx">unaryOperator</span><span class="p">(</span><span class="nx">byte_name</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
<span class="w">                </span><span class="nx">elif</span><span class="w"> </span><span class="nx">byte_name</span><span class="p">.</span><span class="nx">startswith</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">BINARY_</span><span class="err">&#39;</span><span class="p">):</span>
<span class="w">                    </span><span class="kp">self</span><span class="p">.</span><span class="nx">binaryOperator</span><span class="p">(</span><span class="nx">byte_name</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="nx">raise</span><span class="w"> </span><span class="nx">VirtualMachineError</span><span class="p">(</span>
<span class="w">                        </span><span class="s">&quot;unsupported bytecode type: %s&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">byte_name</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">bytecode_fn</span><span class="p">(</span><span class="o">*</span><span class="nx">argument</span><span class="p">)</span>
<span class="w">        </span><span class="nx">except</span><span class="p">:</span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">deal</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">exceptions</span><span class="w"> </span><span class="nx">encountered</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nx">executing</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">last_exception</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sys</span><span class="p">.</span><span class="nx">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">None</span><span class="p">,)</span>
<span class="w">            </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">exception</span><span class="err">&#39;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">why</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">run_frame</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">frame</span><span class="p">):</span>
<span class="w">        </span><span class="s">&quot;&quot;&quot;Run a frame until it returns (somehow).</span>
<span class="s">        Exceptions are raised, the return value is returned.</span>
<span class="s">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">push_frame</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="nx">True</span><span class="p">:</span>
<span class="w">            </span><span class="nx">byte_name</span><span class="p">,</span><span class="w"> </span><span class="nx">arguments</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">parse_byte_and_args</span><span class="p">()</span>

<span class="w">            </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">byte_name</span><span class="p">,</span><span class="w"> </span><span class="nx">arguments</span><span class="p">)</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Deal</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">block</span><span class="w"> </span><span class="nx">management</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">do</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">frame</span><span class="p">.</span><span class="nx">block_stack</span><span class="p">:</span>
<span class="w">                </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">manage_block_stack</span><span class="p">(</span><span class="nx">why</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">why</span><span class="p">:</span>
<span class="w">                </span><span class="k">break</span>

<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">pop_frame</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">exception</span><span class="err">&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">exc</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">,</span><span class="w"> </span><span class="nx">tb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">last_exception</span>
<span class="w">            </span><span class="nx">e</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">exc</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
<span class="w">            </span><span class="nx">e</span><span class="p">.</span><span class="nx">__traceback__</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">tb</span>
<span class="w">            </span><span class="nx">raise</span><span class="w"> </span><span class="nx">e</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">return_value</span>
</code></pre></div>

<h4><code>Block</code> 类</h4>
<p>在我们完成每个字节码方法前，我们简单的讨论一下块。一个块被用于某种控制流，特别是异常处理和循环。它负责保证当操作完成后数据栈处于正确的状态。比如，在一个循环中，一个特殊的迭代器会存在栈中，当循环完成时它从栈中弹出。解释器需要检查循环仍在继续还是已经停止。</p>
<p>为了跟踪这些额外的信息，解释器设置了一个标志来指示它的状态。我们用一个变量<code>why</code>实现这个标志，它可以是<code>None</code>或者是下面几个字符串之一：<code>"continue"</code>、<code>"break"</code>、<code>"excption"</code>、<code>return</code>。它们指示对块栈和数据栈进行什么操作。回到我们迭代器的例子，如果块栈的栈顶是一个<code>loop</code>块，<code>why</code>的代码是<code>continue</code>，迭代器就应该保存在数据栈上，而如果<code>why</code>是<code>break</code>，迭代器就会被弹出。</p>
<p>块操作的细节比这个还要繁琐，我们不会花时间在这上面，但是有兴趣的读者值得仔细的看看。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Block</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">collections</span><span class="p">.</span><span class="nx">namedtuple</span><span class="p">(</span><span class="s">&quot;Block&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;type, handler, stack_height&quot;</span><span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">VirtualMachine</span><span class="p">(</span><span class="nx">object</span><span class="p">):</span>
<span class="w">    </span><span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="nx">删节</span><span class="w"> </span><span class="o">...</span><span class="p">]</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="nx">stack</span><span class="w"> </span><span class="nx">manipulation</span>
<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">push_block</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">b_type</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">=</span><span class="nx">None</span><span class="p">):</span>
<span class="w">        </span><span class="nx">level</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">len</span><span class="p">(</span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span>
<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">block_stack</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">Block</span><span class="p">(</span><span class="nx">b_type</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">,</span><span class="w"> </span><span class="nx">stack_height</span><span class="p">))</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">pop_block</span><span class="p">(</span><span class="kp">self</span><span class="p">):</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">block_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">unwind_block</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">block</span><span class="p">):</span>
<span class="w">        </span><span class="s">&quot;&quot;&quot;Unwind the values on the data stack corresponding to a given block.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">except</span><span class="o">-</span><span class="nx">handler</span><span class="err">&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">exception</span><span class="w"> </span><span class="nx">itself</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">stack</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">traceback</span><span class="p">.</span>
<span class="w">            </span><span class="nx">offset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="w">  </span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="nx">offset</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="nx">len</span><span class="p">(</span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="nx">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">offset</span><span class="p">:</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">except</span><span class="o">-</span><span class="nx">handler</span><span class="err">&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">traceback</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">exctype</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">popn</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">last_exception</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">exctype</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">traceback</span>

<span class="w">    </span><span class="nx">def</span><span class="w"> </span><span class="nx">manage_block_stack</span><span class="p">(</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">why</span><span class="p">):</span>
<span class="w">        </span><span class="s">&quot;&quot;&quot; &quot;&quot;&quot;</span>
<span class="w">        </span><span class="nx">frame</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">frame</span>
<span class="w">        </span><span class="nx">block</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">frame</span><span class="p">.</span><span class="nx">block_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">loop</span><span class="err">&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="k">continue</span><span class="err">&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">jump</span><span class="p">(</span><span class="kp">self</span><span class="p">.</span><span class="nx">return_value</span><span class="p">)</span>
<span class="w">            </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">None</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">why</span>

<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">pop_block</span><span class="p">()</span>
<span class="w">        </span><span class="kp">self</span><span class="p">.</span><span class="nx">unwind_block</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">loop</span><span class="err">&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="k">break</span><span class="err">&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">None</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">jump</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">why</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;</span><span class="nx">setup</span><span class="o">-</span><span class="nx">except</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finally</span><span class="err">&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">exception</span><span class="err">&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">push_block</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">except</span><span class="o">-</span><span class="nx">handler</span><span class="err">&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="nx">exctype</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">tb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">last_exception</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tb</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">exctype</span><span class="p">)</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tb</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">exctype</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">yes</span><span class="p">,</span><span class="w"> </span><span class="nx">twice</span>
<span class="w">            </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">None</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">jump</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">why</span>

<span class="w">        </span><span class="nx">elif</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finally</span><span class="err">&#39;</span><span class="p">:</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">why</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="err">&#39;</span><span class="k">return</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">continue</span><span class="err">&#39;</span><span class="p">):</span>
<span class="w">                </span><span class="kp">self</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kp">self</span><span class="p">.</span><span class="nx">return_value</span><span class="p">)</span>

<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">why</span><span class="p">)</span>

<span class="w">            </span><span class="nx">why</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">None</span>
<span class="w">            </span><span class="kp">self</span><span class="p">.</span><span class="nx">jump</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">why</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">why</span>
</code></pre></div>

<h3>指令</h3>
<p>剩下了的就是完成那些指令方法了：<code>byte_LOAD_FAST</code>、<code>byte_BINARY_MODULO</code>等等。而这些指令的实现并不是很有趣，这里我们只展示了一小部分，完整的实现<a href="https://github.com/nedbat/byterun">在 GitHub 上</a>。（这里包括的指令足够执行我们前面所述的所有代码了。）</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">VirtualMachine</span><span class="p">(</span><span class="n">object</span><span class="p">):</span>
<span class="w">    </span><span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="err">删节</span><span class="w"> </span><span class="o">...</span><span class="p">]</span>

<span class="w">    </span><span class="c1">## Stack manipulation</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_LOAD_CONST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="k">const</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_POP_TOP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="w">    </span><span class="c1">## Names</span>
<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_LOAD_NAME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">:</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">f_builtins</span><span class="p">:</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">.</span><span class="n">f_builtins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">NameError</span><span class="p">(</span><span class="s2">&quot;name &#39;</span><span class="si">%s</span><span class="s2">&#39; is not defined&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_STORE_NAME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_LOAD_FAST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">UnboundLocalError</span><span class="p">(</span>
<span class="w">                </span><span class="s2">&quot;local variable &#39;</span><span class="si">%s</span><span class="s2">&#39; referenced before assignment&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">name</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_STORE_FAST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_LOAD_GLOBAL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">f</span><span class="o">.</span><span class="n">f_globals</span><span class="p">:</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">f</span><span class="o">.</span><span class="n">f_builtins</span><span class="p">:</span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="o">.</span><span class="n">f_builtins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">NameError</span><span class="p">(</span><span class="s2">&quot;global name &#39;</span><span class="si">%s</span><span class="s2">&#39; is not defined&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="c1">## Operators</span>

<span class="w">    </span><span class="n">BINARY_OPERATORS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;POWER&#39;</span><span class="p">:</span><span class="w">    </span><span class="nb">pow</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;MULTIPLY&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;FLOOR_DIVIDE&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">operator</span><span class="o">.</span><span class="n">floordiv</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;TRUE_DIVIDE&#39;</span><span class="p">:</span><span class="w">  </span><span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;MODULO&#39;</span><span class="p">:</span><span class="w">   </span><span class="n">operator</span><span class="o">.</span><span class="n">mod</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;ADD&#39;</span><span class="p">:</span><span class="w">      </span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;SUBTRACT&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;SUBSCR&#39;</span><span class="p">:</span><span class="w">   </span><span class="n">operator</span><span class="o">.</span><span class="n">getitem</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;LSHIFT&#39;</span><span class="p">:</span><span class="w">   </span><span class="n">operator</span><span class="o">.</span><span class="n">lshift</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;RSHIFT&#39;</span><span class="p">:</span><span class="w">   </span><span class="n">operator</span><span class="o">.</span><span class="n">rshift</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;AND&#39;</span><span class="p">:</span><span class="w">      </span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;XOR&#39;</span><span class="p">:</span><span class="w">      </span><span class="n">operator</span><span class="o">.</span><span class="n">xor</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;OR&#39;</span><span class="p">:</span><span class="w">       </span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">binaryOperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">):</span>
<span class="w">        </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BINARY_OPERATORS</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>

<span class="w">    </span><span class="n">COMPARE_OPERATORS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
<span class="w">        </span><span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
<span class="w">        </span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
<span class="w">        </span><span class="n">operator</span><span class="o">.</span><span class="n">ne</span><span class="p">,</span>
<span class="w">        </span><span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
<span class="w">        </span><span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
<span class="w">        </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">        </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">        </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">        </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">        </span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">issubclass</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">issubclass</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span>
<span class="w">    </span><span class="p">]</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_COMPARE_OP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">opnum</span><span class="p">):</span>
<span class="w">        </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COMPARE_OPERATORS</span><span class="p">[</span><span class="n">opnum</span><span class="p">](</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span>

<span class="w">    </span><span class="c1">## Attributes and indexing</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_LOAD_ATTR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">attr</span><span class="p">):</span>
<span class="w">        </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">attr</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_STORE_ATTR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="c1">## Building</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_BUILD_LIST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">):</span>
<span class="w">        </span><span class="n">elts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">elts</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_BUILD_MAP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">({})</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_STORE_MAP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="n">the_map</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">        </span><span class="n">the_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">the_map</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_LIST_APPEND</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">):</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="n">the_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="n">count</span><span class="p">]</span><span class="w"> </span><span class="c1"># peek</span>
<span class="w">        </span><span class="n">the_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="w">    </span><span class="c1">## Jumps</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_JUMP_FORWARD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">(</span><span class="n">jump</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_JUMP_ABSOLUTE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">(</span><span class="n">jump</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_POP_JUMP_IF_TRUE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">):</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">val</span><span class="p">:</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">(</span><span class="n">jump</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_POP_JUMP_IF_FALSE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">):</span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">val</span><span class="p">:</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">(</span><span class="n">jump</span><span class="p">)</span>

<span class="w">    </span><span class="c1">## Blocks</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_SETUP_LOOP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push_block</span><span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_GET_ITER</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_FOR_ITER</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">jump</span><span class="p">):</span>
<span class="w">        </span><span class="n">iterobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
<span class="w">        </span><span class="n">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">iterobj</span><span class="p">)</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="w">        </span><span class="n">except</span><span class="w"> </span><span class="n">StopIteration</span><span class="p">:</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">(</span><span class="n">jump</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_BREAK_LOOP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;break&#39;</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_POP_BLOCK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">pop_block</span><span class="p">()</span>

<span class="w">    </span><span class="c1">## Functions</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_MAKE_FUNCTION</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">):</span>
<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="n">defaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="n">argc</span><span class="p">)</span>
<span class="w">        </span><span class="n">globs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span>
<span class="w">        </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">globs</span><span class="p">,</span><span class="w"> </span><span class="n">defaults</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_CALL_FUNCTION</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="n">lenKw</span><span class="p">,</span><span class="w"> </span><span class="n">lenPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">divmod</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="c1"># KWargs not supported here</span>
<span class="w">        </span><span class="n">posargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">popn</span><span class="p">(</span><span class="n">lenPos</span><span class="p">)</span>

<span class="w">        </span><span class="k">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span>
<span class="w">        </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">posargs</span><span class="p">)</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">byte_RETURN_VALUE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s2">&quot;return&quot;</span>
</code></pre></div>

<h3>动态类型：编译器不知道它是什么</h3>
<p>你可能听过 Python 是一种动态语言 —— 它是动态类型的。在我们建造解释器的过程中，已经透露出这样的信息。</p>
<p>动态的一个意思是很多工作是在运行时完成的。前面我们看到 Python 的编译器没有很多关于代码真正做什么的信息。举个例子，考虑下面这个简单的函数<code>mod</code>。它取两个参数，返回它们的模运算值。从它的字节码中，我们看到变量<code>a</code>和<code>b</code>首先被加载，然后字节码<code>BINAY_MODULO</code>完成这个模运算。</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; def mod(a, b):
<span class="k">...</span>    return a % b
&gt;&gt;&gt; dis.dis(mod)
  2           0 LOAD_FAST                0 (a)
              3 LOAD_FAST                1 (b)
              6 BINARY_MODULO
              7 RETURN_VALUE
&gt;&gt;&gt; mod(19, 5)
4
</code></pre></div>

<p>计算 19 % 5 得4，—— 一点也不奇怪。如果我们用不同类的参数呢？</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; mod(&quot;by%sde&quot;, &quot;teco&quot;)
&#39;bytecode&#39;
</code></pre></div>

<p>刚才发生了什么？你可能在其它地方见过这样的语法，格式化字符串。</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; print(&quot;by%sde&quot; % &quot;teco&quot;)
bytecode
</code></pre></div>

<p>用符号<code>%</code>去格式化字符串会调用字节码<code>BUNARY_MODULO</code>。它取栈顶的两个值求模，不管这两个值是字符串、数字或是你自己定义的类的实例。字节码在函数编译时生成（或者说，函数定义时）相同的字节码会用于不同类的参数。</p>
<p>Python 的编译器关于字节码的功能知道的很少，而取决于解释器来决定<code>BINAYR_MODULO</code>应用于什么类型的对象并完成正确的操作。这就是为什么 Python 被描述为<ruby> 动态类型 <rp>  （ </rp> <rt>  dynamically typed </rt> <rp>  ） </rp></ruby>：直到运行前你不必知道这个函数参数的类型。相反，在一个静态类型语言中，程序员需要告诉编译器参数的类型是什么（或者编译器自己推断出参数的类型。）</p>
<p>编译器的无知是优化 Python 的一个挑战 —— 只看字节码，而不真正运行它，你就不知道每条字节码在干什么！你可以定义一个类，实现<code>__mod__</code>方法，当你对这个类的实例使用<code>%</code>时，Python 就会自动调用这个方法。所以，<code>BINARY_MODULO</code>其实可以运行任何代码。</p>
<p>看看下面的代码，第一个<code>a % b</code>看起来没有用。</p>
<div class="highlight"><pre><span></span><code><span class="nv">def</span><span class="w"> </span><span class="nv">mod</span><span class="ss">(</span><span class="nv">a</span>,<span class="nv">b</span><span class="ss">)</span>:
<span class="w">    </span><span class="nv">a</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nv">b</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">%</span><span class="nv">b</span>
</code></pre></div>

<p>不幸的是，对这段代码进行静态分析 —— 不运行它 —— 不能确定第一个<code>a % b</code>没有做任何事。用 <code>%</code>调用<code>__mod__</code>可能会写一个文件，或是和程序的其他部分交互，或者其他任何可以在 Python 中完成的事。很难优化一个你不知道它会做什么的函数。在 Russell Power 和 Alex Rubinsteyn 的优秀论文中写道，“我们可以用多快的速度解释 Python？”，他们说，“在普遍缺乏类型信息下，每条指令必须被看作一个<code>INVOKE_ARBITRARY_METHOD</code>。”</p>
<h3>总结</h3>
<p>Byterun 是一个比 CPython 容易理解的简洁的 Python 解释器。Byterun 复制了 CPython 的主要结构：一个基于栈的解释器对称之为字节码的指令集进行操作，它们顺序执行或在指令间跳转，向栈中压入和从中弹出数据。解释器随着函数和生成器的调用和返回，动态的创建、销毁帧，并在帧之间跳转。Byterun 也有着和真正解释器一样的限制：因为 Python 使用动态类型，解释器必须在运行时决定指令的正确行为。</p>
<p>我鼓励你去反汇编你的程序，然后用 Byterun 来运行。你很快会发现这个缩短版的 Byterun 所没有实现的指令。完整的实现在 <a href="https://github.com/nedbat/byterun">https://github.com/nedbat/byterun</a>，或者你可以仔细阅读真正的 CPython 解释器<code>ceval.c</code>，你也可以实现自己的解释器！</p>
<h3>致谢</h3>
<p>感谢 Ned Batchelder 发起这个项目并引导我的贡献，感谢 Michael Arntzenius 帮助调试代码和这篇文章的修订，感谢 Leta Montopoli 的修订，以及感谢整个 Recurse Center 社区的支持和鼓励。所有的不足全是我自己没搞好。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>