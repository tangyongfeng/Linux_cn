<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>旅行时通过树莓派和 iPad Pro 备份图片</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Lenin 旅行中备份图片 - 组件 介绍 我在很长的时间内一直在寻找一个旅行中备份图片的理想方法，把 SD 卡放进你的相机包 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li class="active"><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2016/09/lu-xing-shi-tong-guo-shu-mei-pai-he-ipad-pro-bei-fen-tu-pian.html" rel="bookmark"
           title="Permalink to 旅行时通过树莓派和 iPad Pro 备份图片">旅行时通过树莓派和 iPad Pro 备份图片</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-09-18T15:26:00+02:00">
                Published: Sun 18 September 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/shu-mei-pai">树莓派</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Lenin</p>
<p><img alt="" src="/data/attachment/album/201609/18/152757u15q711z5v5sd5w3.jpg"></p>
<p><em>旅行中备份图片 - 组件</em></p>
<h3>介绍</h3>
<p>我在很长的时间内一直在寻找一个旅行中备份图片的理想方法，把 SD 卡放进你的相机包会让你暴露在太多的风险之中：SD 卡可能丢失或者被盗，数据可能损坏或者在传输过程中失败。比较好的一个选择是复制到另外一个介质中，即使它也是个 SD 卡，并且将它放到一个比较安全的地方去，备份到远端也是一个可行的办法，但是如果去了一个没有网络的地方就不太可行了。</p>
<p>我理想的备份步骤需要下面的工具:</p>
<ol>
<li>用一台 iPad pro 而不是一台笔记本。我喜欢轻装旅行，我的大部分旅程都是商务相关的（而不是拍摄休闲的），我痛恨带着个人笔记本的时候还得带着商务本。而我的 iPad 却一直带着，这就是我为什么选择它的原因。</li>
<li>用尽可能少的硬件设备。</li>
<li>设备之间的连接需要很安全。我需要在旅馆和机场使用这套设备，所以设备之间的连接需要是封闭而加密的。</li>
<li>整个过程应该是可靠稳定的，我还用过其他的路由器/组合设备，但是<a href="http://bit.ly/1MVVtZi">效果不太理想</a>。</li>
</ol>
<h3>设备</h3>
<p>我配置了一套满足上面条件并且在未来可以扩充的设备，它包含下面这些部件的使用:</p>
<ol>
<li><a href="http://www.amazon.com/dp/B01D3NZIMA/?tag=movinelect0e-20">9.7 英寸的 iPad Pro</a>，这是本文写作时最强大、轻薄的 iOS 设备，苹果笔不是必需的，但是作为零件之一，当我在路上可以做一些编辑工作，所有的重活由树莓派做 ，其他设备只能通过 SSH 连接就行。</li>
<li>安装了 Raspbian 操作系统<a href="http://www.amazon.com/dp/B01CD5VC92/?tag=movinelect0e-20">树莓派 3</a>（LCTT 译注：Raspbian 是基于 Debian 的树莓派操作系统）。</li>
<li>树莓派的 <a href="http://www.amazon.com/dp/B010Q57T02/?tag=movinelect0e-20">Mini SD卡</a> 和 <a href="http://www.amazon.com/dp/B01F1PSFY6/?tag=movinelect0e-20">盒子/外壳</a>。</li>
<li><a href="http://amzn.to/293kPqX">128G 的优盘</a>，对于我是够用了，你可以买个更大的。你也可以买个像<a href="http://amzn.to/290syFY">这样</a>的移动硬盘，但是树莓派没法通过 USB 给移动硬盘提供足够的电量，这意味你需要额外准备一个<a href="http://amzn.to/290syFY">供电的 USB hub</a> 以及电缆，这就破坏了我们让设备轻薄的初衷。</li>
<li><a href="http://amzn.to/290syFY">SD 读卡器</a></li>
<li><a href="http://amzn.to/290syFY">另外的 SD 卡</a>，我会使用几个 SD 卡，在用满之前就会立即换一个，这样就会让我在一次旅途当中的照片散布在不同的 SD 卡上。</li>
</ol>
<p>下图展示了这些设备之间如何相互连接。</p>
<p><img alt="" src="/data/attachment/album/201609/18/152637hhmiflhfwy262hmf.jpg"></p>
<p><em>旅行时照片的备份-流程图</em></p>
<p>树莓派会作为一个安全的热点。它会创建一个自己的 WPA2 加密的 WIFI 网络，iPad Pro 会连入其中。虽然有很多在线教程教你如何创建 Ad Hoc 网络（计算机到计算机的单对单网络），还更简单一些，但是它的连接是不加密的，而且附件的设备很容易就能连接进去。因此我选择创建 WIFI 网络。</p>
<p>相机的 SD 卡通过 SD 读卡器插到树莓派 USB 端口之一，128G 的大容量优盘一直插在树莓派的另外一个 USB 端口上，我选择了一款<a href="http://amzn.to/293kPqX">闪迪的</a>，因为体积比较小。主要的思路就是通过 Python 脚本把 SD 卡的照片备份到优盘上，备份过程是增量备份，每次脚本运行时都只有变化的（比如新拍摄的照片）部分会添加到备份文件夹中，所以这个过程特别快。如果你有很多的照片或者拍摄了很多 RAW 格式的照片，在就是个巨大的优势。iPad 将用来运行 Python 脚本，而且用来浏览 SD 卡和优盘的文件。</p>
<p>作为额外的好处，如果给树莓派连上一根能上网的网线（比如通过以太网口），那么它就可以共享互联网连接给那些通过 WIFI 连入的设备。</p>
<h3>1. 树莓派的设置</h3>
<p>这部分需要你卷起袖子亲自动手了，我们要用到 Raspbian 的命令行模式，我会尽可能详细的介绍，方便大家进行下去。</p>
<h4>安装和配置 Raspbian</h4>
<p>给树莓派连接鼠标、键盘和 LCD 显示器，将 SD 卡插到树莓派上，按照<a href="https://www.raspberrypi.org/downloads/noobs/">树莓派官网</a>的步骤安装 Raspbian。</p>
<p>安装完后，打开 Raspbian 的终端，执行下面的命令:</p>
<div class="highlight"><pre><span></span><code>sudo apt-get update
sudo apt-get upgrade
</code></pre></div>

<p>这将升级机器上所有的软件到最新，我将树莓派连接到本地网络，而且为了安全更改了默认的密码。</p>
<p>Raspbian 默认开启了 SSH，这样所有的设置可以在一个远程的设备上完成。我也设置了 RSA 验证，但这是可选的功能，可以在<a href="https://www.raspberrypi.org/documentation/remote-access/ssh/passwordless.md">这里</a>查看更多信息。</p>
<p>这是一个在 Mac 上在 <a href="https://www.iterm2.com/">iTerm</a> 里建立 SSH 连接到树莓派上的截图<a href="https://www.iterm2.com/">14</a>。（LCTT 译注：原文图丢失。）</p>
<h4>建立 WPA2 加密的 WIFI AP</h4>
<p>安装过程基于<a href="https://frillip.com/using-your-raspberry-pi-3-as-a-wifi-access-point-with-hostapd/">这篇文章</a>，根据我的情况进行了调整。</p>
<p><strong>1. 安装软件包</strong></p>
<p>我们需要安装下面的软件包：</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install hostapd
sudo apt-get install dnsmasq
</code></pre></div>

<p>hostapd 用来使用内置的 WiFi 来创建 AP，dnsmasp 是一个组合的 DHCP 和 DNS 服务其，很容易设置。</p>
<p><strong>2. 编辑 dhcpcd.conf</strong></p>
<p>通过以太网连接树莓派，树莓派上的网络接口配置由 <code>dhcpd</code> 控制，因此我们首先忽略这一点，将 <code>wlan0</code> 设置为一个静态的 IP。</p>
<p>用 <code>sudo nano /etc/dhcpcd.conf</code> 命令打开 dhcpcd 的配置文件，在最后一行添加上如下内容：</p>
<div class="highlight"><pre><span></span><code>denyinterfaces wlan0
</code></pre></div>

<p>注意：它必须放在如果已经有的其它接口行<strong>之上</strong>。</p>
<p><strong>3. 编辑接口</strong></p>
<p>现在设置静态 IP，使用 <code>sudo nano /etc/network/interfaces</code> 打开接口配置文件，按照如下信息编辑<code>wlan0</code>部分：</p>
<div class="highlight"><pre><span></span><code><span class="nx">allow</span><span class="o">-</span><span class="nx">hotplug</span><span class="w"> </span><span class="nx">wlan0</span>
<span class="nx">iface</span><span class="w"> </span><span class="nx">wlan0</span><span class="w"> </span><span class="nx">inet</span><span class="w"> </span><span class="nx">static</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="m m-Double">192.168.1.1</span>
<span class="w">    </span><span class="nx">netmask</span><span class="w"> </span><span class="m m-Double">255.255.255.0</span>
<span class="w">    </span><span class="nx">network</span><span class="w"> </span><span class="m m-Double">192.168.1.0</span>
<span class="w">    </span><span class="nx">broadcast</span><span class="w"> </span><span class="m m-Double">192.168.1.255</span>
<span class="err">#</span><span class="w">    </span><span class="nx">wpa</span><span class="o">-</span><span class="nx">conf</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">wpa_supplicant</span><span class="o">/</span><span class="nx">wpa_supplicant</span><span class="p">.</span><span class="nx">conf</span>
</code></pre></div>

<p>同样，然后 <code>wlan1</code> 编辑如下：</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span>allow-hotplug wlan1
<span class="gh">#</span>iface wlan1 inet manual
<span class="gh">#</span>    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
</code></pre></div>

<p>重要： 使用 <code>sudo service dhcpcd restart</code> 命令重启 <code>dhcpd</code>服务，然后用 <code>sudo ifdown eth0; sudo ifup wlan0</code> 命令来重载<code>wlan0</code>的配置。</p>
<p><strong>4. 配置 Hostapd</strong></p>
<p>接下来，我们需要配置 hostapd，使用 <code>sudo nano /etc/hostapd/hostapd.conf</code> 命令创建一个新的配置文件，内容如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">interface</span><span class="o">=</span><span class="n">wlan0</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">nl80211</span><span class="w"> </span><span class="n">driver</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">brcmfmac</span><span class="w"> </span><span class="n">driver</span>
<span class="n">driver</span><span class="o">=</span><span class="n">nl80211</span>

<span class="err">#</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">network</span>
<span class="n">ssid</span><span class="o">=</span><span class="n">YOUR_NETWORK_NAME_HERE</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mf">2.4</span><span class="n">GHz</span><span class="w"> </span><span class="n">band</span>
<span class="n">hw_mode</span><span class="o">=</span><span class="n">g</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="mi">6</span>
<span class="n">channel</span><span class="o">=</span><span class="mi">6</span>

<span class="err">#</span><span class="w"> </span><span class="n">Enable</span><span class="w"> </span><span class="mf">802.11</span><span class="n">n</span>
<span class="n">ieee80211n</span><span class="o">=</span><span class="mi">1</span>

<span class="err">#</span><span class="w"> </span><span class="n">Enable</span><span class="w"> </span><span class="n">QoS</span><span class="w"> </span><span class="n">Support</span>
<span class="n">wmm_enabled</span><span class="o">=</span><span class="mi">1</span>

<span class="err">#</span><span class="w"> </span><span class="n">Enable</span><span class="w"> </span><span class="mi">40</span><span class="n">MHz</span><span class="w"> </span><span class="n">channels</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="mi">20</span><span class="n">ns</span><span class="w"> </span><span class="n">guard</span><span class="w"> </span><span class="k">interval</span>
<span class="n">ht_capab</span><span class="o">=[</span><span class="n">HT40</span><span class="o">][</span><span class="n">SHORT-GI-20</span><span class="o">][</span><span class="n">DSSS_CCK-40</span><span class="o">]</span>

<span class="err">#</span><span class="w"> </span><span class="n">Accept</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">MAC</span><span class="w"> </span><span class="n">addresses</span>
<span class="n">macaddr_acl</span><span class="o">=</span><span class="mi">0</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">WPA</span><span class="w"> </span><span class="n">authentication</span>
<span class="n">auth_algs</span><span class="o">=</span><span class="mi">1</span>

<span class="err">#</span><span class="w"> </span><span class="n">Require</span><span class="w"> </span><span class="n">clients</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">name</span>
<span class="n">ignore_broadcast_ssid</span><span class="o">=</span><span class="mi">0</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">WPA2</span>
<span class="n">wpa</span><span class="o">=</span><span class="mi">2</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">shared</span><span class="w"> </span><span class="k">key</span>
<span class="n">wpa_key_mgmt</span><span class="o">=</span><span class="n">WPA</span><span class="o">-</span><span class="n">PSK</span>

<span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">passphrase</span>
<span class="n">wpa_passphrase</span><span class="o">=</span><span class="n">YOUR_NEW_WIFI_PASSWORD_HERE</span>

<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">AES</span><span class="p">,</span><span class="w"> </span><span class="n">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">TKIP</span>
<span class="n">rsn_pairwise</span><span class="o">=</span><span class="n">CCMP</span>
</code></pre></div>

<p>配置完成后，我们需要告诉<code>dhcpcd</code> 在系统启动运行时到哪里寻找配置文件。 使用 <code>sudo nano /etc/default/hostapd</code> 命令打开默认配置文件，然后找到<code>#DAEMON_CONF=""</code> 替换成<code>DAEMON_CONF="/etc/hostapd/hostapd.conf"</code>。</p>
<p><strong>5. 配置 Dnsmasq</strong></p>
<p>自带的 dnsmasp 配置文件包含很多信息方便你使用它，但是我们不需要那么多选项，我建议把它移动到别的地方（而不要删除它），然后自己创建一个新文件：</p>
<div class="highlight"><pre><span></span><code>sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig  
sudo nano /etc/dnsmasq.conf  
</code></pre></div>

<p>粘贴下面的信息到新文件中：</p>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="p">=</span><span class="nx">wlan0</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">wlan0</span>
<span class="nx">listen</span><span class="o">-</span><span class="nx">address</span><span class="p">=</span><span class="m m-Double">192.168.1.1</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Explicitly</span><span class="w"> </span><span class="nx">specify</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">listen</span><span class="w"> </span><span class="nx">on</span>
<span class="nx">bind</span><span class="o">-</span><span class="nx">interfaces</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="nx">Bind</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">make</span><span class="w"> </span><span class="nx">sure</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">aren</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">sending</span><span class="w"> </span><span class="nx">things</span><span class="w"> </span><span class="nx">elsewhere</span>
<span class="nx">server</span><span class="p">=</span><span class="m m-Double">8.8.8.8</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="nx">Forward</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="nx">requests</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Google</span><span class="w"> </span><span class="nx">DNS</span>
<span class="nx">domain</span><span class="o">-</span><span class="nx">needed</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nx">Don</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">forward</span><span class="w"> </span><span class="nx">short</span><span class="w"> </span><span class="nx">names</span>
<span class="nx">bogus</span><span class="o">-</span><span class="nx">priv</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">Never</span><span class="w"> </span><span class="nx">forward</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">non</span><span class="o">-</span><span class="nx">routed</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">spaces</span><span class="p">.</span>
<span class="nx">dhcp</span><span class="o">-</span><span class="nx">range</span><span class="p">=</span><span class="m m-Double">192.168.1.50</span><span class="p">,</span><span class="m m-Double">192.168.1.100</span><span class="p">,</span><span class="mi">12</span><span class="nx">h</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Assign</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">range</span><span class="w">  </span><span class="nx">with</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="nx">hour</span><span class="w"> </span><span class="nx">lease</span><span class="w"> </span><span class="nx">time</span>
</code></pre></div>

<p><strong>6. 设置 IPv4 转发</strong></p>
<p>最后我们需要做的事就是配置包转发，用 <code>sudo nano /etc/sysctl.conf</code> 命令打开 <code>sysctl.conf</code> 文件，将包含 <code>net.ipv4.ip_forward=1</code>的那一行之前的#号删除，它将在下次重启时生效。</p>
<p>我们还需要给连接到树莓派的设备通过 WIFI 分享互联网连接，做一个 <code>wlan0</code>和 <code>eth0</code> 之间的 NAT。我们可以参照下面的脚本来实现。</p>
<div class="highlight"><pre><span></span><code>sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE  
sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT  
</code></pre></div>

<p>我命名这个脚本名为 <code>hotspot-boot.sh</code>，然后让它可以执行：</p>
<div class="highlight"><pre><span></span><code>sudo chmod 755 hotspot-boot.sh
</code></pre></div>

<p>该脚本应该在树莓派启动的时候运行。有很多方法实现，下面是我实现的方式：</p>
<ol>
<li>把文件放到<code>/home/pi/scripts</code>目录下。</li>
<li>输入<code>sudo nano /etc/rc.local</code>命令编辑 <code>rc.local</code> 文件，将运行该脚本的命令放到 <code>exit 0</code>之前。（更多信息参照<a href="https://www.raspberrypi.org/documentation/linux/usage/rc-local.md">这里</a>）。</li>
</ol>
<p>编辑后<code>rc.local</code>看起来像这样：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh -e</span>
<span class="c1">#</span>
<span class="c1"># rc.local</span>
<span class="c1">#</span>
<span class="c1"># This script is executed at the end of each multiuser runlevel.</span>
<span class="c1"># Make sure that the script will &quot;exit 0&quot; on success or any other</span>
<span class="c1"># value on error.</span>
<span class="c1">#</span>
<span class="c1"># In order to enable or disable this script just change the execution</span>
<span class="c1"># bits.</span>
<span class="c1">#</span>
<span class="c1"># By default this script does nothing.</span>

<span class="c1"># Print the IP address</span>
<span class="nv">_IP</span><span class="o">=</span><span class="k">$(</span>hostname<span class="w"> </span>-I<span class="k">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$_IP</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;My IP address is %s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$_IP</span><span class="s2">&quot;</span>
<span class="k">fi</span>

sudo<span class="w"> </span>/home/pi/scripts/hotspot-boot.sh<span class="w"> </span><span class="p">&amp;</span>

<span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</code></pre></div>

<h4>安装 Samba 服务和 NTFS 兼容驱动</h4>
<p>我们要安装下面几个软件来启用 samba 协议，使<a href="https://itunes.apple.com/us/app/filebrowser-access-files-on/id364738545?mt=8&amp;uo=4&amp;at=11lqkH">文件浏览器</a>能够访问树莓派分享的文件夹，<code>ntfs-3g</code> 可以使我们能够访问移动硬盘中 ntfs 文件系统的文件。</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install ntfs-3g
sudo apt-get install samba samba-common-bin
</code></pre></div>

<p>你可以参照<a href="http://www.howtogeek.com/139433/how-to-turn-a-raspberry-pi-into-a-low-power-network-storage-device/">这些文档</a>来配置 Samba。</p>
<p>重要提示：参考的文档介绍的是挂载外置硬盘到树莓派上，我们不这样做，是因为在这篇文章写作的时候，树莓派在启动时的 auto-mounts 功能同时将 SD 卡和优盘挂载到<code>/media/pi/</code>上，该文章有一些多余的功能我们也不会采用。</p>
<h3>2. Python 脚本</h3>
<p>树莓派配置好后，我们需要开发脚本来实际拷贝和备份照片。注意，这个脚本只是提供了特定的自动化备份进程，如果你有基本的 Linux/树莓派命令行操作的技能，你可以 ssh 进树莓派，然后创建需要的文件夹，使用<code>cp</code>或<code>rsync</code>命令拷贝你自己的照片从一个设备到另外一个设备上。在脚本里我们用<code>rsync</code>命令，这个命令比较可靠而且支持增量备份。</p>
<p>这个过程依赖两个文件，脚本文件自身和<code>backup_photos.conf</code>这个配置文件，后者只有几行包含被挂载的目的驱动器（优盘）和应该挂载到哪个目录，它看起来是这样的：</p>
<div class="highlight"><pre><span></span><code>mount folder=/media/pi/
destination folder=PDRIVE128GB
</code></pre></div>

<p>重要提示：在这个符号<code>=</code>前后不要添加多余的空格，否则脚本会失效。</p>
<p>下面是这个 Python 脚本，我把它命名为<code>backup_photos.py</code>，把它放到了<code>/home/pi/scripts/</code>目录下，我在每行都做了注释可以方便的查看各行的功能。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">rsync</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">脚本将挂载到 /media/pi 的 SD 卡上的内容复制到目的磁盘的同名目录下，目的磁盘的名字在 .conf文件里定义好了。</span>


<span class="sd">Argument:  label/name of the mounted SD Card.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">CONFIG_FILE</span> <span class="o">=</span> <span class="s1">&#39;/home/pi/scripts/backup_photos.conf&#39;</span>
<span class="n">ORIGIN_DEV</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">create_folder</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;attempting to create destination folder: &#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Folder created.&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Folder could not be created. Stopping.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Folder already in path. Using that instead.&#39;</span><span class="p">)</span>



<span class="n">confFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONFIG_FILE</span><span class="p">,</span><span class="s1">&#39;rU&#39;</span><span class="p">)</span> 
<span class="c1">#重要：: rU 选项将以统一换行模式打开文件，</span>
<span class="c1">#所以 \n 和/或 \r 都被识别为一个新行。</span>

<span class="n">confList</span> <span class="o">=</span> <span class="n">confFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">confFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">confList</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span> <span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mount folder&#39;</span><span class="p">:</span>
            <span class="n">mountFolder</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;destination folder&#39;</span><span class="p">:</span>
            <span class="n">destDevice</span> <span class="o">=</span> <span class="n">value</span>


    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Incorrect line format. Passing.&#39;</span><span class="p">)</span>
        <span class="k">pass</span>


<span class="n">destFolder</span> <span class="o">=</span> <span class="n">mountFolder</span><span class="o">+</span><span class="n">destDevice</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ORIGIN_DEV</span>
<span class="n">create_folder</span><span class="p">(</span><span class="n">destFolder</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Copying files...&#39;</span><span class="p">)</span>

<span class="c1"># 取消这行备注将删除不在源处的文件</span>
<span class="c1"># rsync(&quot;-av&quot;, &quot;--delete&quot;, mountFolder+ORIGIN_DEV, destFolder)</span>
<span class="n">rsync</span><span class="p">(</span><span class="s2">&quot;-av&quot;</span><span class="p">,</span> <span class="n">mountFolder</span><span class="o">+</span><span class="n">ORIGIN_DEV</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">destFolder</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
</code></pre></div>

<h3>3. iPad Pro 的配置</h3>
<p>因为重活都由树莓派干了，文件不通过 iPad Pro 传输，这比我<a href="http://bit.ly/1MVVtZi">之前尝试的一种方案</a>有巨大的优势。我们在 iPad 上只需要安装上 <a href="https://itunes.apple.com/us/app/prompt-2/id917437289?mt=8&amp;uo=4&amp;at=11lqkH">Prompt2</a> 来通过 SSH 连接树莓派就行了，这样你既可以运行 Python 脚本也可以手动复制文件了。</p>
<p><img alt="" src="/data/attachment/album/201609/18/152830zhhhhr6jxje8rh38.jpg"></p>
<p><em>iPad 用 Prompt2 通过 SSH 连接树莓派</em></p>
<p>因为我们安装了 Samba，我们可以以更图形化的方式访问连接到树莓派的 USB 设备，你可以看视频，在不同的设备之间复制和移动文件，<a href="https://itunes.apple.com/us/app/filebrowser-access-files-on/id364738545?mt=8&amp;uo=4&amp;at=11lqkH">文件浏览器</a>对于这种用途非常完美。（LCTT 译注：原文视频丢失。）</p>
<h3>4. 将它们结合在一起</h3>
<p>我们假设<code>SD32GB-03</code>是连接到树莓派 USB 端口之一的 SD 卡的卷标，<code>PDRIVE128GB</code>是那个优盘的卷标，也连接到设备上，并在上面指出的配置文件中定义好。如果我们想要备份 SD 卡上的图片，我们需要这么做：</p>
<ol>
<li>给树莓派加电打开，将驱动器自动挂载好。</li>
<li>连接树莓派配置好的 WIFI 网络。</li>
<li>用 <a href="https://itunes.apple.com/us/app/prompt-2/id917437289?mt=8&amp;uo=4&amp;at=11lqkH">Prompt2</a> 这个 app 通过 SSH 连接到树莓派。</li>
<li>连接好后输入下面的命令：<code>python3 backup_photos.py SD32GB-03</code></li>
</ol>
<p>首次备份需要一些时间，这依赖于你的 SD 卡使用了多少容量。这意味着你需要一直保持树莓派和 iPad 设备连接不断，你可以在脚本运行之前通过 <code>nohup</code> 命令解决：</p>
<div class="highlight"><pre><span></span><code>nohup python3 backup_photos.py SD32GB-03 &amp;
</code></pre></div>

<p><img alt="" src="/data/attachment/album/201609/18/152845q29bz0nll0ouhlut.png"></p>
<p><em>运行完成的脚本如图所示</em></p>
<h3>未来的定制</h3>
<p>我在树莓派上安装了 vnc 服务，这样我可以通过其它计算机或在 iPad 上用 <a href="https://itunes.apple.com/us/app/remoter-pro-vnc-ssh-rdp/id519768191?mt=8&amp;uo=4&amp;at=11lqkH">Remoter App</a>连接树莓派的图形界面，我安装了 <a href="https://getsync.com/">BitTorrent Sync</a> 用来远端备份我的图片，当然需要先设置好。当我有了可以运行的解决方案之后，我会补充我的文章。</p>
<p>你可以在下面发表你的评论和问题，我会在此页下面回复。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>