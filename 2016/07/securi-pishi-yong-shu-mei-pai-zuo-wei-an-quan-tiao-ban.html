<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Securi-Pi：使用树莓派作为安全跳板</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Bill Childers 像很多 LinuxJournal 的读者一样，我也过上了当今非常普遍的“科技游牧”生活，在网络之间，从一个接入点到另一个接入点，我们 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li class="active"><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2016/07/securi-pishi-yong-shu-mei-pai-zuo-wei-an-quan-tiao-ban.html" rel="bookmark"
           title="Permalink to Securi-Pi：使用树莓派作为安全跳板">Securi-Pi：使用树莓派作为安全跳板</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-07-09T11:21:10+02:00">
                Published: Sat 09 July 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/shu-mei-pai">树莓派</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Bill Childers</p>
<p>像很多 LinuxJournal 的读者一样，我也过上了当今非常普遍的“科技游牧”生活，在网络之间，从一个接入点到另一个接入点，我们身处现实世界的不同地方却始终保持连接到互联网和日常使用的其它网络上。近来我发现越来越多的网络环境开始屏蔽对外的常用端口比如 SMTP（端口 25），SSH（端口 22）之类的。当你走进一家咖啡馆然后想 SSH 到你的一台服务器上做点事情的时候发现端口 22 被屏蔽了是一件很烦的事情。</p>
<p>不过，我到目前为止还没发现有什么网络环境会把 HTTPS 给墙了（端口 443）。在稍微配置了一下家中的树莓派 2 之后，我成功地让自己通过接入树莓派的 443 端口充当跳板，从而让我在各种网络环境下都能连上想要的目标端口。简而言之，我把家中的树莓派设置成了一个 OpenVPN 的端点和 SSH 端点，同时也是一个 Apache 服务器，所有这些服务都监听在 443 端口上，以便可以限制我不想暴露的网络服务。</p>
<p><img alt="" src="/data/attachment/album/201607/09/112059psnn7gnm7iims3zu.jpg"></p>
<h3>备注</h3>
<p>此解决方案能搞定大多数有限制的网络环境，但有些防火墙会对外部流量调用<ruby> 深度包检查 <rp>  （ </rp> <rt>  Deep packet inspection </rt> <rp>  ） </rp></ruby>，它们时常能屏蔽掉用本篇文章里的方式传输的信息。不过我到目前为止还没在这样的防火墙后测试过。同时，尽管我使用了很多基于密码学的工具（OpenVPN，HTTPS，SSH），我并没有非常严格地审计过这套配置方案（LCTT 译注：作者的意思是指这套方案能帮你绕过端口限制，但不代表你的活动就是完全安全的）。有时候甚至 DNS 服务都会泄露你的信息，很可能在我没有考虑周到的角落里会有遗漏。我强烈不推荐把此跳板配置方案当作是万无一失的隐藏网络流量的办法，此配置只是希望能绕过一些端口限制连上网络，而不是做一些危险的事情。</p>
<h3>起步</h3>
<p>让我们先从你需要什么说起，我用的是树莓派 2，装载了最新版本的 Raspbian，不过这个配置也应该能在树莓派 Model B 上运行；512MB 的内存对我们来说绰绰有余了，虽然性能可能没有树莓派 2这么好，毕竟相比于四核心的树莓派 2， Model B 只有一颗单核心 CPU。我的树莓派放置在家里的防火墙和路由器的后面，所以我还能用这个树莓派作为跳板访问家里的其他电子设备。同时这也意味着我的流量在互联网上看起来仿佛来自我家的 ip 地址，所以这也算某种意义上保护了我的匿名性。如果你没有树莓派，或者不想从家里运行这个服务，那你完全可以把这个配置放在一台小型云服务器上（LCTT 译注：比如 IPS ）。你只要确保服务器运行着基于 Debian 的 Linux 发行版即可，这份指南依然可用。</p>
<p><img alt="" src="/data/attachment/album/201607/09/112113urwto25rrgg25z7p.jpg"></p>
<p><em>图 1 树莓派，即将成为我们的加密网络端点</em></p>
<h3>安装并配置 BIND</h3>
<p>无论你是用树莓派还是一台服务器，当你成功启动之后你就可以安装 BIND 了，这是一个驱动了互联网相当一部分的域名服务软件。你将会把 BIND 仅仅作为缓存域名服务使用，而不用把它配置为用来处理来自互联网的域名请求。安装 BIND 会让你拥有一个可以被 OpenVPN 使用的 DNS 服务器。安装 BIND 十分简单，<code>apt-get</code> 就可以直接搞定:</p>
<div class="highlight"><pre><span></span><code><span class="nx">root</span><span class="err">@</span><span class="nx">test</span><span class="p">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="nx">apt</span><span class="o">-</span><span class="nx">get</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">bind9</span>
<span class="nx">Reading</span><span class="w"> </span><span class="kn">package</span><span class="w"> </span><span class="nx">lists</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span>
<span class="nx">Building</span><span class="w"> </span><span class="nx">dependency</span><span class="w"> </span><span class="nx">tree</span>
<span class="nx">Reading</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">information</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span>
<span class="nx">The</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">extra</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">installed</span><span class="p">:</span>
<span class="w">  </span><span class="nx">bind9utils</span>
<span class="nx">Suggested</span><span class="w"> </span><span class="nx">packages</span><span class="p">:</span>
<span class="w">  </span><span class="nx">bind9</span><span class="o">-</span><span class="nx">doc</span><span class="w"> </span><span class="nx">resolvconf</span><span class="w"> </span><span class="nx">ufw</span>
<span class="nx">The</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">NEW</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">installed</span><span class="p">:</span>
<span class="w">  </span><span class="nx">bind9</span><span class="w"> </span><span class="nx">bind9utils</span>
<span class="mi">0</span><span class="w"> </span><span class="nx">upgraded</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nx">newly</span><span class="w"> </span><span class="nx">installed</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">remove</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">upgraded</span><span class="p">.</span>
<span class="nx">Need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="mi">490</span><span class="w"> </span><span class="nx">kB</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">archives</span><span class="p">.</span>
<span class="nx">After</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">operation</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">128</span><span class="w"> </span><span class="nx">kB</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">additional</span><span class="w"> </span><span class="nx">disk</span><span class="w"> </span><span class="nx">space</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">used</span><span class="p">.</span>
<span class="nx">Do</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">want</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">[</span><span class="nx">Y</span><span class="o">/</span><span class="nx">n</span><span class="p">]?</span><span class="w"> </span><span class="nx">y</span>
</code></pre></div>

<p>在我们把 BIND 作为缓存域名服务器之前，还有一些小细节需要配置。两个修改都在<code>/etc/bind/named.conf.options</code>里完成。首先你要取消注释掉 forwarders 这一节内容，同时你还要增加一个可以转发域名请求的目标服务器。作为例子我会用 Google 的 DNS 服务器（8.8.8.8）（LCTT 译注：国内的话需要找一个替代品）；文件的 forwarders 节看上去大致是这样的：</p>
<div class="highlight"><pre><span></span><code>forwarders {
    8.8.8.8;
};
</code></pre></div>

<p>第二点你需要做的更改是允许来自内网和本机的查询请求，直接把这一行加入配置文件的后面，记得放在最后一个<code>};</code>之前就可以了：</p>
<div class="highlight"><pre><span></span><code>allow-query { 192.168.1.0/24; 127.0.0.0/16; };
</code></pre></div>

<p>上面那行配置会允许此 DNS 服务器接收来自其所在的网络（在本例中，我的网络就在我的防火墙之后）和本机的请求。下一步，你需要重启一下 BIND 的服务：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">bind9</span><span class="w"> </span><span class="n">restart</span>
<span class="o">[</span><span class="n">....</span><span class="o">]</span><span class="w"> </span><span class="n">Stopping</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">service</span><span class="p">...</span><span class="err">:</span><span class="w"> </span><span class="n">bind9</span><span class="w">  </span>
<span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="mi">13209</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">die</span>
<span class="p">.</span><span class="w"> </span><span class="n">ok</span>
<span class="o">[</span><span class="n"> ok </span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">service</span><span class="p">...</span><span class="err">:</span><span class="w"> </span><span class="n">bind9</span><span class="p">.</span>
</code></pre></div>

<p>现在你可以测试一下 <code>nslookup</code> 来确保你的服务正常运行了：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">nslookup</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">localhost</span>
<span class="k">Default</span><span class="w"> </span><span class="nl">server</span><span class="p">:</span><span class="w"> </span><span class="n">localhost</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="n">#53</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">www</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Server</span><span class="p">:</span><span class="w">     </span><span class="n">localhost</span>
<span class="nl">Address</span><span class="p">:</span><span class="w">    </span><span class="mf">127.0.0.1</span><span class="n">#53</span>

<span class="n">Non</span><span class="o">-</span><span class="n">authoritative</span><span class="w"> </span><span class="nl">answer</span><span class="p">:</span>
<span class="nl">Name</span><span class="p">:</span><span class="w">   </span><span class="n">www</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">173.194.33.176</span>
<span class="nl">Name</span><span class="p">:</span><span class="w">   </span><span class="n">www</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">173.194.33.177</span>
<span class="nl">Name</span><span class="p">:</span><span class="w">   </span><span class="n">www</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">173.194.33.178</span>
<span class="nl">Name</span><span class="p">:</span><span class="w">   </span><span class="n">www</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">173.194.33.179</span>
<span class="nl">Name</span><span class="p">:</span><span class="w">   </span><span class="n">www</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Address</span><span class="p">:</span><span class="w"> </span><span class="mf">173.194.33.180</span>
</code></pre></div>

<p>完美！现在你的系统里已经有一个正常的域名服务在工作了，下一步我们来配置一下OpenVPN。</p>
<h3>安装并配置 OpenVPN</h3>
<p>OpenVPN 是一个运用 SSL/TLS 作为密钥交换的开源 VPN 解决方案。同时它也非常便于在 Linux 环境下部署。配置 OpenVPN 可能有一点点难，不过其实你也不需要在默认的配置文件里做太多修改。首先你需要运行一下 <code>apt-get</code> 来安装 OpenVPN：</p>
<div class="highlight"><pre><span></span><code><span class="nx">root</span><span class="err">@</span><span class="nx">test</span><span class="p">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="nx">apt</span><span class="o">-</span><span class="nx">get</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">openvpn</span>
<span class="nx">Reading</span><span class="w"> </span><span class="kn">package</span><span class="w"> </span><span class="nx">lists</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span>
<span class="nx">Building</span><span class="w"> </span><span class="nx">dependency</span><span class="w"> </span><span class="nx">tree</span>
<span class="nx">Reading</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">information</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span>
<span class="nx">The</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">extra</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">installed</span><span class="p">:</span>
<span class="w">  </span><span class="nx">liblzo2</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="nx">libpkcs11</span><span class="o">-</span><span class="nx">helper1</span>
<span class="nx">Suggested</span><span class="w"> </span><span class="nx">packages</span><span class="p">:</span>
<span class="w">  </span><span class="nx">resolvconf</span>
<span class="nx">The</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">NEW</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">installed</span><span class="p">:</span>
<span class="w">  </span><span class="nx">liblzo2</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="nx">libpkcs11</span><span class="o">-</span><span class="nx">helper1</span><span class="w"> </span><span class="nx">openvpn</span>
<span class="mi">0</span><span class="w"> </span><span class="nx">upgraded</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nx">newly</span><span class="w"> </span><span class="nx">installed</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">remove</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">upgraded</span><span class="p">.</span>
<span class="nx">Need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="mi">621</span><span class="w"> </span><span class="nx">kB</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">archives</span><span class="p">.</span>
<span class="nx">After</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">operation</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">489</span><span class="w"> </span><span class="nx">kB</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">additional</span><span class="w"> </span><span class="nx">disk</span><span class="w"> </span><span class="nx">space</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">used</span><span class="p">.</span>
<span class="nx">Do</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">want</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">[</span><span class="nx">Y</span><span class="o">/</span><span class="nx">n</span><span class="p">]?</span><span class="w"> </span><span class="nx">y</span>
</code></pre></div>

<p>现在 OpenVPN 已经安装好了，你需要去配置它了。OpenVPN 是基于 SSL 的，并且它同时依赖于服务端和客户端两方的证书来工作。为了生成这些证书，你需要在机器上配置一个证书签发（CA）。幸运地，OpenVPN 在安装中自带了一些用于生成证书的脚本比如 “easy-rsa” 来帮助你加快这个过程。你将要创建一个文件目录用于放置 easy-rsa 脚本，从模板目录复制过来：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span>
<span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">-</span><span class="n">rpv</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="mf">2.0</span><span class="cm">/* /etc/openvpn/easy-rsa/</span>
</code></pre></div>

<p>下一步，把 vars 文件复制一个备份：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">test</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="c1"># cp vars vars.bak</span>
</code></pre></div>

<p>接下来，编辑一下 vars 以让其中的信息符合你的状态。我将以我需要编辑的信息作为例子：</p>
<div class="highlight"><pre><span></span><code><span class="n">KEY_SIZE</span><span class="o">=</span><span class="mi">4096</span>
<span class="n">KEY_COUNTRY</span><span class="o">=</span><span class="ss">&quot;US&quot;</span>
<span class="n">KEY_PROVINCE</span><span class="o">=</span><span class="ss">&quot;CA&quot;</span>
<span class="n">KEY_CITY</span><span class="o">=</span><span class="ss">&quot;Silicon Valley&quot;</span>
<span class="n">KEY_ORG</span><span class="o">=</span><span class="ss">&quot;Linux Journal&quot;</span>
<span class="n">KEY_EMAIL</span><span class="o">=</span><span class="ss">&quot;bill.childers@linuxjournal.com&quot;</span>
</code></pre></div>

<p>下一步是导入（source）一下 vars 中的环境变量，这样系统就能把其中的信息当作环境变量处理了：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="err">@</span><span class="n">test</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="c1"># source ./vars</span>
<span class="n">NOTE</span><span class="p">:</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">./</span><span class="n">clean</span><span class="o">-</span><span class="n">all</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">doing</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span>
</code></pre></div>

<h3>搭建 CA（证书签发）</h3>
<p>接下来你要运行一下 <code>clean-all</code> 来确保有一个清理干净的系统工作环境，紧接着你就要做证书签发了。注意一下我修改了一些 changeme 的所提示修改的内容以符合我需要的安装情况：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="p">@</span><span class="n">test</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">clean</span><span class="o">-</span><span class="n">all</span>
<span class="n">root</span><span class="p">@</span><span class="n">test</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">ca</span>
<span class="n">Generating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">RSA</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">key</span>
<span class="p">...................................................</span><span class="o">++</span>
<span class="p">...................................................</span><span class="o">++</span>
<span class="n">writing</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">&#39;</span><span class="n">ca</span><span class="p">.</span><span class="n">key</span><span class="err">&#39;</span>
<span class="o">-----</span>
<span class="n">You</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">asked</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">that</span>
<span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorporated</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">request</span><span class="p">.</span>
<span class="n">What</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">a</span>
<span class="n">Distinguished</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">DN</span><span class="p">.</span>
<span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">quite</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">few</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">leave</span><span class="w"> </span><span class="n">some</span>
<span class="n">blank</span><span class="p">.</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">value</span><span class="p">,</span>
<span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">blank</span><span class="p">.</span>
<span class="o">-----</span>
<span class="n">Country</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">letter</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">US</span><span class="p">]</span><span class="o">:</span>
<span class="n">State</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">Province</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">full</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Locality</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Silicon</span><span class="w"> </span><span class="n">Valley</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organization</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">company</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Linux</span><span class="w"> </span><span class="n">Journal</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organizational</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">SecTeam</span>
<span class="n">Common</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">server</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">hostname</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span>
<span class="n">Name</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span>
<span class="n">Email</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="p">[</span><span class="n">bill</span><span class="p">.</span><span class="n">childers</span><span class="p">@</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="p">]</span><span class="o">:</span>
</code></pre></div>

<h3>生成服务端证书</h3>
<p>一旦 CA 创建好了，你接着就可以生成客户端的 OpenVPN 证书了：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="p">@</span><span class="n">test</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">server</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span>
<span class="n">Generating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">RSA</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">key</span>
<span class="p">...................................................</span><span class="o">++</span>
<span class="n">writing</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">&#39;</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">key</span><span class="err">&#39;</span>
<span class="o">-----</span>
<span class="n">You</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">asked</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">that</span>
<span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorporated</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">request</span><span class="p">.</span>
<span class="n">What</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">a</span>
<span class="n">Distinguished</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">DN</span><span class="p">.</span>
<span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">quite</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">few</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">leave</span><span class="w"> </span><span class="n">some</span>
<span class="n">blank</span><span class="p">.</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">value</span><span class="p">,</span>
<span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">blank</span><span class="p">.</span>
<span class="o">-----</span>
<span class="n">Country</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">letter</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">US</span><span class="p">]</span><span class="o">:</span>
<span class="n">State</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">Province</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">full</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Locality</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Silicon</span><span class="w"> </span><span class="n">Valley</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organization</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">company</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Linux</span><span class="w"> </span><span class="n">Journal</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organizational</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">SecTeam</span>
<span class="n">Common</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">server</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">hostname</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="p">]</span><span class="o">:</span>
<span class="n">Name</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span>
<span class="n">Email</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="p">[</span><span class="n">bill</span><span class="p">.</span><span class="n">childers</span><span class="p">@</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="p">]</span><span class="o">:</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="err">&#39;</span><span class="n">extra</span><span class="err">&#39;</span><span class="w"> </span><span class="n">attributes</span>
<span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">request</span>
<span class="n">A</span><span class="w"> </span><span class="n">challenge</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="p">[]</span><span class="o">:</span>
<span class="n">An</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="n">company</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">[]</span><span class="o">:</span>
<span class="n">Using</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">openssl</span><span class="mf">-1.0.0</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">Check</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">signature</span>
<span class="n">Signature</span><span class="w"> </span><span class="n">ok</span>
<span class="n">The</span><span class="w"> </span><span class="n">Subject</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">Distinguished</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">follows</span>
<span class="nl">countryName</span><span class="w">           </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">US</span><span class="err">&#39;</span>
<span class="nl">stateOrProvinceName</span><span class="w">   </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">CA</span><span class="err">&#39;</span>
<span class="nl">localityName</span><span class="w">          </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">Silicon</span><span class="w"> </span><span class="n">Valley</span><span class="err">&#39;</span>
<span class="nl">organizationName</span><span class="w">      </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">Linux</span><span class="w"> </span><span class="n">Journal</span><span class="err">&#39;</span>
<span class="nl">organizationalUnitName</span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">SecTeam</span><span class="err">&#39;</span>
<span class="nl">commonName</span><span class="w">            </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
<span class="nl">name</span><span class="w">                  </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">test</span><span class="p">.</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
<span class="nl">emailAddress</span><span class="w">          </span><span class="p">:</span><span class="n">IA5STRING</span><span class="o">:</span><span class="err">&#39;</span><span class="n">bill</span><span class="p">.</span><span class="n">childers</span><span class="p">@</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
<span class="n">Certificate</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">certified</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">Sep</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="mo">06</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mi">59</span><span class="w"> </span><span class="mi">2025</span><span class="w"> </span><span class="n">GMT</span><span class="w"> </span><span class="p">(</span><span class="mi">3650</span><span class="w"> </span><span class="n">days</span><span class="p">)</span>
<span class="n">Sign</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">certificate</span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">:</span><span class="n">y</span>

<span class="mi">1</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">certified</span><span class="p">,</span><span class="w"> </span><span class="n">commit</span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="n">y</span>
<span class="n">Write</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">entries</span>
<span class="n">Data</span><span class="w"> </span><span class="n">Base</span><span class="w"> </span><span class="n">Updated</span>
</code></pre></div>

<p>下一步需要用掉一些时间来生成 OpenVPN 服务器需要的 Diffie-Hellman 密钥。这个步骤在一般的桌面级 CPU 上会需要几分钟的时间，但在 ARM 构架的树莓派上，会用掉超级超级长的时间。耐心点，只要终端上的点还在跳，那么一切就在按部就班运行（下面的示例省略了不少的点）：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">dh</span>
<span class="n">Generating</span><span class="w"> </span><span class="n">DH</span><span class="w"> </span><span class="k">parameters</span><span class="p">,</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="nc">bit</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">safe</span><span class="w"> </span><span class="n">prime</span><span class="p">,</span>
<span class="w"> </span><span class="err">↪</span><span class="n">generator</span><span class="w"> </span><span class="mi">2</span>
<span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">going</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="nc">time</span>
<span class="p">....................................................</span><span class="o">+</span>
<span class="o">&lt;</span><span class="n">省略了不少的点</span><span class="o">&gt;</span>
</code></pre></div>

<h3>生成客户端证书</h3>
<p>现在你要生成一下客户端用于登录 OpenVPN 的密钥。通常来说 OpenVPN 都会被配置成使用证书验证的加密方式，在这个配置下客户端需要持有由服务端签发的一份证书：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="p">@</span><span class="n">test</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span><span class="w"> </span><span class="n">bills</span><span class="o">-</span><span class="n">computer</span>
<span class="n">Generating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">RSA</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">key</span>
<span class="p">...................................................</span><span class="o">++</span>
<span class="p">...................................................</span><span class="o">++</span>
<span class="n">writing</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">&#39;</span><span class="n">bills</span><span class="o">-</span><span class="n">computer</span><span class="p">.</span><span class="n">key</span><span class="err">&#39;</span>
<span class="o">-----</span>
<span class="n">You</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">asked</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">that</span>
<span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">incorporated</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">request</span><span class="p">.</span>
<span class="n">What</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">a</span>
<span class="n">Distinguished</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">DN</span><span class="p">.</span><span class="w"> </span><span class="n">There</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">quite</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">few</span>
<span class="n">fields</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">leave</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">blank</span><span class="p">.</span>
<span class="n">For</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">value</span><span class="p">,</span>
<span class="n">If</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="n">blank</span><span class="p">.</span>
<span class="o">-----</span>
<span class="n">Country</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">letter</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">US</span><span class="p">]</span><span class="o">:</span>
<span class="n">State</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">Province</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">full</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">CA</span><span class="p">]</span><span class="o">:</span>
<span class="n">Locality</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">city</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Silicon</span><span class="w"> </span><span class="n">Valley</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organization</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">company</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">Linux</span><span class="w"> </span><span class="n">Journal</span><span class="p">]</span><span class="o">:</span>
<span class="n">Organizational</span><span class="w"> </span><span class="n">Unit</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">section</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">SecTeam</span>
<span class="n">Common</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">eg</span><span class="p">,</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">server</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">hostname</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">bills</span><span class="o">-</span><span class="n">computer</span><span class="p">]</span><span class="o">:</span>
<span class="n">Name</span><span class="w"> </span><span class="p">[</span><span class="n">changeme</span><span class="p">]</span><span class="o">:</span><span class="n">bills</span><span class="o">-</span><span class="n">computer</span>
<span class="n">Email</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="p">[</span><span class="n">bill</span><span class="p">.</span><span class="n">childers</span><span class="p">@</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="p">]</span><span class="o">:</span>

<span class="n">Please</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="err">&#39;</span><span class="n">extra</span><span class="err">&#39;</span><span class="w"> </span><span class="n">attributes</span>
<span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">request</span>
<span class="n">A</span><span class="w"> </span><span class="n">challenge</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="p">[]</span><span class="o">:</span>
<span class="n">An</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="n">company</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">[]</span><span class="o">:</span>
<span class="n">Using</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">openssl</span><span class="mf">-1.0.0</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">Check</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">signature</span>
<span class="n">Signature</span><span class="w"> </span><span class="n">ok</span>
<span class="n">The</span><span class="w"> </span><span class="n">Subject</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">Distinguished</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">follows</span>
<span class="nl">countryName</span><span class="w">           </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">US</span><span class="err">&#39;</span>
<span class="nl">stateOrProvinceName</span><span class="w">   </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">CA</span><span class="err">&#39;</span>
<span class="nl">localityName</span><span class="w">          </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">Silicon</span><span class="w"> </span><span class="n">Valley</span><span class="err">&#39;</span>
<span class="nl">organizationName</span><span class="w">      </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">Linux</span><span class="w"> </span><span class="n">Journal</span><span class="err">&#39;</span>
<span class="nl">organizationalUnitName</span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">SecTeam</span><span class="err">&#39;</span>
<span class="nl">commonName</span><span class="w">            </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">bills</span><span class="o">-</span><span class="n">computer</span><span class="err">&#39;</span>
<span class="nl">name</span><span class="w">                  </span><span class="p">:</span><span class="n">PRINTABLE</span><span class="o">:</span><span class="err">&#39;</span><span class="n">bills</span><span class="o">-</span><span class="n">computer</span><span class="err">&#39;</span>
<span class="nl">emailAddress</span><span class="w">          </span><span class="p">:</span><span class="n">IA5STRING</span><span class="o">:</span><span class="err">&#39;</span><span class="n">bill</span><span class="p">.</span><span class="n">childers</span><span class="p">@</span><span class="n">linuxjournal</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
<span class="n">Certificate</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">certified</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">Sep</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="mo">07</span><span class="o">:</span><span class="mi">35</span><span class="o">:</span><span class="mo">07</span><span class="w"> </span><span class="mi">2025</span><span class="w"> </span><span class="n">GMT</span><span class="w"> </span><span class="p">(</span><span class="mi">3650</span><span class="w"> </span><span class="n">days</span><span class="p">)</span>
<span class="n">Sign</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">certificate</span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="o">:</span><span class="n">y</span>

<span class="mi">1</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">certificate</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">certified</span><span class="p">,</span><span class="w"> </span><span class="n">commit</span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="n">y</span>
<span class="n">Write</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">entries</span>
<span class="n">Data</span><span class="w"> </span><span class="n">Base</span><span class="w"> </span><span class="n">Updated</span>
<span class="n">root</span><span class="p">@</span><span class="n">test</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="err">#</span>
</code></pre></div>

<p>现在你需要再生成一个 HMAC 码作为共享密钥来进一步增加整个加密提供的安全性：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">openvpn</span><span class="w"> </span><span class="c1">--genkey --secret /etc/openvpn/easy-rsa/keys/ta.key</span>
</code></pre></div>

<h3>配置服务器</h3>
<p>最后，我们到了配置 OpenVPN 服务的时候了。你需要创建一个 <code>/etc/openvpn/server.conf</code> 文件；这个配置文件的大多数地方都可以套用模板解决。设置 OpenVPN 服务的主要修改在于让它只用 TCP 而不是 UDP 链接。这是下一步所必需的---如果不是 TCP 连接那么你的服务将不能工作在端口 443 上。创建 <code>/etc/openvpn/server.conf</code> 然后把下述配置丢进去：</p>
<div class="highlight"><pre><span></span><code><span class="nx">port</span><span class="w"> </span><span class="mi">1194</span>
<span class="nx">proto</span><span class="w"> </span><span class="nx">tcp</span>
<span class="nx">dev</span><span class="w"> </span><span class="nx">tun</span>
<span class="nx">ca</span><span class="w"> </span><span class="nx">easy</span><span class="o">-</span><span class="nx">rsa</span><span class="o">/</span><span class="nx">keys</span><span class="o">/</span><span class="nx">ca</span><span class="p">.</span><span class="nx">crt</span>
<span class="nx">cert</span><span class="w"> </span><span class="nx">easy</span><span class="o">-</span><span class="nx">rsa</span><span class="o">/</span><span class="nx">keys</span><span class="o">/</span><span class="nx">test</span><span class="p">.</span><span class="nx">linuxjournal</span><span class="p">.</span><span class="nx">com</span><span class="p">.</span><span class="nx">crt</span><span class="w"> </span><span class="err">##</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">whatever</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">hostname</span><span class="w"> </span><span class="nx">was</span>
<span class="nx">key</span><span class="w"> </span><span class="nx">easy</span><span class="o">-</span><span class="nx">rsa</span><span class="o">/</span><span class="nx">keys</span><span class="o">/</span><span class="nx">test</span><span class="p">.</span><span class="nx">linuxjournal</span><span class="p">.</span><span class="nx">com</span><span class="p">.</span><span class="nx">key</span><span class="w">  </span><span class="err">##</span><span class="w"> </span><span class="nx">Hostname</span><span class="w"> </span><span class="nx">key</span><span class="o">-</span><span class="w"> </span><span class="nx">This</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">should</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">kept</span><span class="w"> </span><span class="nx">secret</span>
<span class="nx">management</span><span class="w"> </span><span class="nx">localhost</span><span class="w"> </span><span class="mi">7505</span>
<span class="nx">dh</span><span class="w"> </span><span class="nx">easy</span><span class="o">-</span><span class="nx">rsa</span><span class="o">/</span><span class="nx">keys</span><span class="o">/</span><span class="nx">dh4096</span><span class="p">.</span><span class="nx">pem</span>
<span class="nx">tls</span><span class="o">-</span><span class="nx">auth</span><span class="w"> </span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">openvpn</span><span class="o">/</span><span class="nx">certs</span><span class="o">/</span><span class="nx">ta</span><span class="p">.</span><span class="nx">key</span><span class="w"> </span><span class="mi">0</span>
<span class="nx">server</span><span class="w"> </span><span class="m m-Double">10.8.0.0</span><span class="w"> </span><span class="m m-Double">255.255.255.0</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">subnet</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">clients</span><span class="w"> </span><span class="nx">connecting</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">it</span>
<span class="nx">ifconfig</span><span class="o">-</span><span class="nx">pool</span><span class="o">-</span><span class="nx">persist</span><span class="w"> </span><span class="nx">ipp</span><span class="p">.</span><span class="nx">txt</span>
<span class="nx">push</span><span class="w"> </span><span class="s">&quot;redirect-gateway def1 bypass-dhcp&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Forces</span><span class="w"> </span><span class="nx">clients</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">redirect</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">traffic</span><span class="w"> </span><span class="nx">through</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">VPN</span>
<span class="nx">push</span><span class="w"> </span><span class="s">&quot;dhcp-option DNS 192.168.1.1&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Tells</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="m m-Double">192.168.1.1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">DNS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">replace</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">IP</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">OpenVPN</span><span class="w"> </span><span class="nx">machine</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">clients</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">BIND</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">setup</span><span class="w"> </span><span class="nx">earlier</span>
<span class="nx">keepalive</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">240</span>
<span class="nx">comp</span><span class="o">-</span><span class="nx">lzo</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Enable</span><span class="w"> </span><span class="nx">compression</span>
<span class="nx">persist</span><span class="o">-</span><span class="nx">key</span>
<span class="nx">persist</span><span class="o">-</span><span class="nx">tun</span>
<span class="nx">status</span><span class="w"> </span><span class="nx">openvpn</span><span class="o">-</span><span class="nx">status</span><span class="p">.</span><span class="nx">log</span>
<span class="nx">verb</span><span class="w"> </span><span class="mi">3</span>
</code></pre></div>

<p>最后，你将需要在服务器上启用 IP 转发，配置 OpenVPN 为开机启动，并立刻启动 OpenVPN 服务：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="err">#</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="ss">&quot;net.ipv4.ip_forward = 1&quot;</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="err">#</span><span class="w"> </span><span class="n">sysctl</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wmem_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rmem_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_rmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10240</span><span class="w"> </span><span class="mi">87380</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_wmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10240</span><span class="w"> </span><span class="mi">87380</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wmem_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rmem_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_rmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10240</span><span class="w"> </span><span class="mi">87380</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_wmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10240</span><span class="w"> </span><span class="mi">87380</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wmem_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rmem_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_rmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10240</span><span class="w"> </span><span class="mi">87380</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_wmem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10240</span><span class="w"> </span><span class="mi">87380</span><span class="w"> </span><span class="mi">12582912</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="err">#</span><span class="w"> </span><span class="k">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="n">openvpn</span><span class="w"> </span><span class="n">defaults</span>
<span class="k">update</span><span class="o">-</span><span class="n">rc</span><span class="p">.</span><span class="nl">d</span><span class="p">:</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">dependency</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">sequencing</span>

<span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">openvpn</span><span class="w"> </span><span class="k">start</span>
<span class="o">[</span><span class="n"> ok </span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="nl">daemon</span><span class="p">:.</span>
</code></pre></div>

<h3>配置 OpenVPN 客户端</h3>
<p>客户端的安装取决于客户端的操作系统，但你需要将之前生成的证书和密钥复制到你的客户端上，并导入你的 OpenVPN 客户端并新建一个配置文件。每种操作系统下的 OpenVPN 客户端在操作上会有些稍许不同，这也不在这篇文章的覆盖范围内，所以你最好去看看特定操作系统下的 OpenVPN 文档来获取更多信息。请参考本文档里的资源那一节。</p>
<h3>安装 SSLH —— "魔法"多协议切换工具</h3>
<p>本文章介绍的解决方案最有趣的部分就是运用 SSLH 了。SSLH 是一个多重协议工具——它可以监听 443 端口的流量，然后分析他们是 SSH，HTTPS 还是 OpenVPN 的通讯包，并把它们分别转发给正确的系统服务。这就是为何本解决方案可以让你绕过大多数端口封杀——你可以一直使用 HTTPS 通讯，因为它几乎从来不会被封杀。</p>
<p>同样，直接 <code>apt-get</code> 安装：</p>
<div class="highlight"><pre><span></span><code><span class="nx">root</span><span class="err">@</span><span class="nx">test</span><span class="p">:</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">openvpn</span><span class="o">/</span><span class="nx">easy</span><span class="o">-</span><span class="nx">rsa</span><span class="o">/</span><span class="nx">keys</span><span class="err">#</span><span class="w"> </span><span class="nx">apt</span><span class="o">-</span><span class="nx">get</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">sslh</span>
<span class="nx">Reading</span><span class="w"> </span><span class="kn">package</span><span class="w"> </span><span class="nx">lists</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span>
<span class="nx">Building</span><span class="w"> </span><span class="nx">dependency</span><span class="w"> </span><span class="nx">tree</span>
<span class="nx">Reading</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">information</span><span class="o">...</span><span class="w"> </span><span class="nx">Done</span>
<span class="nx">The</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">extra</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">installed</span><span class="p">:</span>
<span class="w">  </span><span class="nx">apache2</span><span class="w"> </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">mpm</span><span class="o">-</span><span class="nx">worker</span><span class="w"> </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">utils</span><span class="w"> </span><span class="nx">apache2</span><span class="m m-Double">.2</span><span class="o">-</span><span class="nx">bin</span><span class="w"> </span><span class="nx">apache2</span><span class="m m-Double">.2</span><span class="o">-</span><span class="nx">common</span>
<span class="w">  </span><span class="nx">libapr1</span><span class="w"> </span><span class="nx">libaprutil1</span><span class="w"> </span><span class="nx">libaprutil1</span><span class="o">-</span><span class="nx">dbd</span><span class="o">-</span><span class="nx">sqlite3</span><span class="w"> </span><span class="nx">libaprutil1</span><span class="o">-</span><span class="nx">ldap</span><span class="w"> </span><span class="nx">libconfig9</span>
<span class="nx">Suggested</span><span class="w"> </span><span class="nx">packages</span><span class="p">:</span>
<span class="w">  </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">doc</span><span class="w"> </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">suexec</span><span class="w"> </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">suexec</span><span class="o">-</span><span class="nx">custom</span><span class="w"> </span><span class="nx">openbsd</span><span class="o">-</span><span class="nx">inetd</span><span class="w"> </span><span class="nx">inet</span><span class="o">-</span><span class="nx">superserver</span>
<span class="nx">The</span><span class="w"> </span><span class="nx">following</span><span class="w"> </span><span class="nx">NEW</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">installed</span><span class="p">:</span>
<span class="w">  </span><span class="nx">apache2</span><span class="w"> </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">mpm</span><span class="o">-</span><span class="nx">worker</span><span class="w"> </span><span class="nx">apache2</span><span class="o">-</span><span class="nx">utils</span><span class="w"> </span><span class="nx">apache2</span><span class="m m-Double">.2</span><span class="o">-</span><span class="nx">bin</span><span class="w"> </span><span class="nx">apache2</span><span class="m m-Double">.2</span><span class="o">-</span><span class="nx">common</span>
<span class="w">  </span><span class="nx">libapr1</span><span class="w"> </span><span class="nx">libaprutil1</span><span class="w"> </span><span class="nx">libaprutil1</span><span class="o">-</span><span class="nx">dbd</span><span class="o">-</span><span class="nx">sqlite3</span><span class="w"> </span><span class="nx">libaprutil1</span><span class="o">-</span><span class="nx">ldap</span><span class="w"> </span><span class="nx">libconfig9</span><span class="w"> </span><span class="nx">sslh</span>
<span class="mi">0</span><span class="w"> </span><span class="nx">upgraded</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="nx">newly</span><span class="w"> </span><span class="nx">installed</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">remove</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">upgraded</span><span class="p">.</span>
<span class="nx">Need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">568</span><span class="w"> </span><span class="nx">kB</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">archives</span><span class="p">.</span>
<span class="nx">After</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">operation</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="mi">822</span><span class="w"> </span><span class="nx">kB</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">additional</span><span class="w"> </span><span class="nx">disk</span><span class="w"> </span><span class="nx">space</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">used</span><span class="p">.</span>
<span class="nx">Do</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">want</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">[</span><span class="nx">Y</span><span class="o">/</span><span class="nx">n</span><span class="p">]?</span><span class="w"> </span><span class="nx">y</span>
</code></pre></div>

<p>在 SSLH 被安装之后，包管理器会询问要在 inetd 还是 standalone 模式下允许。选择 standalone 模式，因为你希望 SSLH 在它自己的进程里运行。如果你没有安装 Apache，apt 包管理器会自动帮你下载并安装的，尽管它也不是完全不可或缺。如果你已经有 Apache 了，那你需要确保它只监听 localhost 端口而不是所有的端口（不然的话 SSLH 会无法运行，因为 443 端口已经被 Apache 监听占用）。安装后，你会看到一个如下所示的错误信息：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">....</span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">ssl</span><span class="o">/</span><span class="n">ssh</span><span class="w"> </span><span class="nl">multiplexer</span><span class="p">:</span><span class="w"> </span><span class="n">sslhsslh</span><span class="w"> </span><span class="n">disabled</span><span class="p">,</span><span class="w"> </span><span class="n">please</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">needs</span>
<span class="o">[</span><span class="n">FAIL</span><span class="o">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">RUN</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;yes&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">default</span><span class="o">/</span><span class="n">sslh</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">failed</span><span class="err">!</span>
<span class="n">failed</span><span class="err">!</span>
</code></pre></div>

<p>这其实并不是错误信息，只是 SSLH 在提醒你它还未被配置所以无法启动，这很正常。配置 SSLH 相对来说比较简单。它的配置文件放置在 <code>/etc/default/sslh</code>，你只需要修改 <code>RUN</code> 和 <code>DAEMON_OPTS</code> 变量就可以了。我的 SSLH 配置文件如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Default options for sslh initscript</span>
<span class="c1"># sourced by /etc/init.d/sslh</span>

<span class="c1"># Disabled by default, to force yourself</span>
<span class="c1"># to read the configuration:</span>
<span class="c1"># - /usr/share/doc/sslh/README.Debian (quick start)</span>
<span class="c1"># - /usr/share/doc/sslh/README, at &quot;Configuration&quot; section</span>
<span class="c1"># - sslh(8) via &quot;man sslh&quot; for more configuration details.</span>
<span class="c1"># Once configuration ready, you *must* set RUN to yes here</span>
<span class="c1"># and try to start sslh (standalone mode only)</span>

<span class="n">RUN</span><span class="o">=</span><span class="n">yes</span>

<span class="c1"># binary to use: forked (sslh) or single-thread (sslh-select) version</span>
<span class="n">DAEMON</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">sslh</span>

<span class="n">DAEMON_OPTS</span><span class="o">=</span><span class="s2">&quot;--user sslh --listen 0.0.0.0:443 --ssh 127.0.0.1:22 --ssl 127.0.0.1:443 --openvpn 127.0.0.1:1194 --pidfile /var/run/sslh/sslh.pid&quot;</span>
</code></pre></div>

<p>保存编辑并启动 SSLH：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="nv">@test</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">sslh</span><span class="w"> </span><span class="k">start</span>
<span class="o">[</span><span class="n"> ok </span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">ssl</span><span class="o">/</span><span class="n">ssh</span><span class="w"> </span><span class="nl">multiplexer</span><span class="p">:</span><span class="w"> </span><span class="n">sslh</span><span class="p">.</span>
</code></pre></div>

<p>现在你应该可以从 443 端口 ssh 到你的树莓派了，它会正确地使用 SSLH 转发：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh<span class="w"> </span>-p<span class="w"> </span><span class="m">443</span><span class="w"> </span>root@test.linuxjournal.com
root@test:~#
</code></pre></div>

<p>SSLH 现在开始监听端口 443 并且可以转发流量信息到 SSH、Apache 或者 OpenVPN ，这取决于抵达流量包的类型。这套系统现已整装待发了！</p>
<h3>结论</h3>
<p>现在你可以启动 OpenVPN 并且配置你的客户端连接到服务器的 443 端口了，然后 SSLH 会从那里把流量转发到服务器的 1194 端口。但鉴于你正在和服务器的 443 端口通信，你的 VPN 流量不会被封锁。现在你可以舒服地坐在陌生小镇的咖啡店里，畅通无阻地通过你的树莓派上的 OpenVPN 浏览互联网。你顺便还给你的链接增加了一些安全性，这个额外作用也会让你的链接更安全和私密一些。享受通过安全跳板浏览互联网把！</p>
<h3>参考资源</h3>
<ul>
<li>安装与配置 OpenVPN: <a href="https://wiki.debian.org/OpenVPN">https://wiki.debian.org/OpenVPN</a> 和 <a href="http://cryptotap.com/articles/openvpn">http://cryptotap.com/articles/openvpn</a></li>
<li>OpenVPN 客户端下载: <a href="https://openvpn.net/index.php/open-source/downloads.html">https://openvpn.net/index.php/open-source/downloads.html</a></li>
<li>OpenVPN iOS 客户端: <a href="https://itunes.apple.com/us/app/openvpn-connect/id590379981?mt=8">https://itunes.apple.com/us/app/openvpn-connect/id590379981?mt=8</a></li>
<li>OpenVPN Android 客户端: <a href="https://play.google.com/store/apps/details?id=net.openvpn.openvpn&amp;hl=en">https://play.google.com/store/apps/details?id=net.openvpn.openvpn&amp;hl=en</a></li>
<li>Tunnelblick for Mac OS X (OpenVPN 客户端): <a href="https://tunnelblick.net">https://tunnelblick.net</a></li>
<li>SSLH 介绍: <a href="http://www.rutschle.net/tech/sslh.shtml">http://www.rutschle.net/tech/sslh.shtml</a> 和 <a href="https://github.com/yrutschle/sslh">https://github.com/yrutschle/sslh</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>