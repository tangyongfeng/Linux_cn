<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Muhammad Arul Nextcloud 是一款自由 (开源) 的类 Dropbox 软件，由 ownCloud 分支演化形成。它使用 PHP 和 JavaScript 编写，支持多种数据库系统，比如 MySQL/MariaDB、PostgreSQL、Oracle 数据库 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2017/02/ru-he-zai-centos-7-zhong-shi-yong-nginx-he-php7-fpm-an-zhuang-nextcloud.html" rel="bookmark"
           title="Permalink to 如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud">如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-27T11:51:20+01:00">
                Published: Mon 27 February 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Muhammad Arul</p>
<p>Nextcloud 是一款自由 (开源) 的类 Dropbox 软件，由 ownCloud 分支演化形成。它使用 PHP 和 JavaScript 编写，支持多种数据库系统，比如 MySQL/MariaDB、PostgreSQL、Oracle 数据库和 SQLite。它可以使你的桌面系统和云服务器中的文件保持同步，Nextcloud 为 Windows、Linux、Mac、安卓以及苹果手机都提供了客户端支持。Nextcloud 并非只是 Dropbox 的克隆，它还提供了很多附加特性，如日历、联系人、计划任务以及流媒体 Ampache。</p>
<p>在这篇文章中，我将向你展示如何在 CentOS 7 服务器中安装和配置最新版本的 Nextcloud 10。我会通过 Nginx 和 PHP7-FPM 来运行 Nextcloud，同时使用 MariaDB 做为数据库系统。</p>
<p><img alt="" src="/data/attachment/album/201702/27/115114jv8a6y6awr83a6i3.jpg"></p>
<p><strong>先决条件</strong></p>
<ul>
<li>64 位的 CentOS 7</li>
<li>服务器的 Root 权限</li>
</ul>
<h3>步骤 1 - 在 CentOS 7 中安装 Nginx 和 PHP7-FPM</h3>
<p>在开始安装 Nginx 和 php7-fpm 之前，我们还学要先添加 EPEL 包的仓库源。使用如下命令：</p>
<div class="highlight"><pre><span></span><code>yum -y install epel-release
</code></pre></div>

<p>现在开始从 EPEL 仓库来安装 Nginx：</p>
<div class="highlight"><pre><span></span><code>yum -y install nginx
</code></pre></div>

<p>然后我们还需要为 php7-fpm 添加另外一个仓库。互联网中有很个远程仓库提供了 PHP 7 系列包，我在这里使用的是 webtatic。</p>
<p>添加 PHP7-FPM webtatic 仓库：</p>
<div class="highlight"><pre><span></span><code>rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
</code></pre></div>

<p>然后就是安装 PHP7-FPM 以及 Nextcloud 需要的一些包。</p>
<div class="highlight"><pre><span></span><code>yum -y install php70w-fpm php70w-cli php70w-gd php70w-mcrypt php70w-mysql php70w-pear php70w-xml php70w-mbstring php70w-pdo php70w-json php70w-pecl-apcu php70w-pecl-apcu-devel
</code></pre></div>

<p>最后，从服务器终端里查看 PHP 的版本号，以便验证 PHP 是否正确安装。</p>
<div class="highlight"><pre><span></span><code>php -v
</code></pre></div>

<p><img alt="查看 PHP 版本号" src="/data/attachment/album/201702/27/115122utlo8okp2g6ook02.png"></p>
<h3>步骤 2 - 配置 PHP7-FPM</h3>
<p>在这一个步骤中，我们将配置 php-fpm 与 Nginx 协同运行。Php7-fpm 将使用 <code>nginx</code> 用户来运行，并监听 <code>9000</code> 端口。</p>
<p>使用 vim 编辑默认的 php7-fpm 配置文件。</p>
<div class="highlight"><pre><span></span><code>vim /etc/php-fpm.d/www.conf
</code></pre></div>

<p>在第 8 行和第 10行，<code>user</code> 和 <code>group</code> 赋值为 <code>nginx</code>。</p>
<div class="highlight"><pre><span></span><code>user = nginx
group = nginx
</code></pre></div>

<p>在第 22 行，确保 php-fpm 运行在指定端口。</p>
<div class="highlight"><pre><span></span><code>listen = 127.0.0.1:9000
</code></pre></div>

<p>取消第 366-370 行的注释，启用 php-fpm 的系统环境变量。</p>
<div class="highlight"><pre><span></span><code><span class="n">env</span><span class="o">[</span><span class="n">HOSTNAME</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="n">HOSTNAME</span>
<span class="n">env</span><span class="o">[</span><span class="n">PATH</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">bin</span>
<span class="n">env</span><span class="o">[</span><span class="n">TMP</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span>
<span class="n">env</span><span class="o">[</span><span class="n">TMPDIR</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span>
<span class="n">env</span><span class="o">[</span><span class="n">TEMP</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span>
</code></pre></div>

<p>保存文件并退出 vim 编辑器。</p>
<p>下一步，就是在 <code>/var/lib/</code> 目录下创建一个新的文件夹 <code>session</code>，并将其拥有者变更为 <code>nginx</code> 用户。</p>
<div class="highlight"><pre><span></span><code><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">php</span><span class="o">/</span><span class="n">session</span>
<span class="n">chown</span><span class="w"> </span><span class="n">nginx</span><span class="p">:</span><span class="n">nginx</span><span class="w"> </span><span class="o">-</span><span class="n">R</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">php</span><span class="o">/</span><span class="n">session</span><span class="o">/</span>
</code></pre></div>

<p>然后启动 php-fpm 和 Nginx，并且将它们设置为随开机启动的服务。</p>
<div class="highlight"><pre><span></span><code>sudo systemctl start php-fpm
sudo systemctl start nginx

sudo systemctl enable php-fpm
sudo systemctl enable nginx
</code></pre></div>

<p><img alt="启动 php-fpm 和 Nginx" src="/data/attachment/album/201702/27/115123wc21ae2yl1e42akw.png"></p>
<p>PHP7-FPM 配置完成</p>
<h3>步骤 3 - 安装和配置 MariaDB</h3>
<p>我这里使用 MariaDB 作为 Nextcloud 的数据库。可以直接使用 <code>yum</code> 命令从 CentOS 默认远程仓库中安装 <code>mariadb-server</code> 包。</p>
<div class="highlight"><pre><span></span><code>yum -y install mariadb mariadb-server
</code></pre></div>

<p>启动 MariaDB，并将其添加到随系统启动的服务中去。</p>
<div class="highlight"><pre><span></span><code>systemctl start mariadb
systemctl enable mariadb
</code></pre></div>

<p>现在开始配置 MariaDB 的 root 用户密码。</p>
<div class="highlight"><pre><span></span><code>mysql_secure_installation
</code></pre></div>

<p>键入 <code>Y</code> ，然后设置 MariaDB 的 root 密码。</p>
<div class="highlight"><pre><span></span><code><span class="n">Set</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">password</span><span class="err">?</span><span class="w"> </span><span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="n">Y</span>
<span class="n">New</span><span class="w"> </span><span class="n">password</span><span class="p">:</span>
<span class="n">Re</span><span class="o">-</span><span class="n">enter</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">password</span><span class="p">:</span>

<span class="n">Remove</span><span class="w"> </span><span class="n">anonymous</span><span class="w"> </span><span class="n">users</span><span class="err">?</span><span class="w"> </span><span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="n">Y</span>
<span class="n">Disallow</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">remotely</span><span class="err">?</span><span class="w"> </span><span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="n">Y</span>
<span class="n">Remove</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">access</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">it</span><span class="err">?</span><span class="w"> </span><span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="n">Y</span>
<span class="n">Reload</span><span class="w"> </span><span class="n">privilege</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="n">now</span><span class="err">?</span><span class="w"> </span><span class="p">[</span><span class="n">Y</span><span class="o">/</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="n">Y</span>
</code></pre></div>

<p>这样就设置好了密码，现在登录到 mysql shell 并为 Nextcloud 创建一个新的数据库和用户。这里我创建名为 <code>nextcloud_db</code> 的数据库以及名为 <code>nextclouduser</code> 的用户，用户密码为 <code>nextclouduser@</code>。当然了，要给你自己的系统选用一个更安全的密码。</p>
<div class="highlight"><pre><span></span><code>mysql -u root -p
</code></pre></div>

<p>输入 MariaDB 的 root 密码，即可登录 mysql shell。</p>
<p>输入以下 mysql 查询语句来创建新的数据库和用户。</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">nextcloud_db</span><span class="p">;</span>
<span class="k">create</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">nextclouduser</span><span class="nv">@localhost</span><span class="w"> </span><span class="n">identified</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;nextclouduser@&#39;</span><span class="p">;</span>
<span class="k">grant</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="k">privileges</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">nextcloud_db</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">to</span><span class="o">&amp;</span><span class="n">nbsp</span><span class="p">;</span><span class="n">nextclouduser</span><span class="nv">@localhost</span><span class="w"> </span><span class="n">identified</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;nextclouduser@&#39;</span><span class="p">;</span>
<span class="n">flush</span><span class="w"> </span><span class="k">privileges</span><span class="p">;</span>
</code></pre></div>

<p><img alt="为 Nextcloud 创建一个新的数据库和用户" src="/data/attachment/album/201702/27/115123dk7wcda7ndfccnfz.png"></p>
<p><code>nextcloud_db</code> 数据库和 <code>nextclouduser</code> 数据库用户创建完成</p>
<h3>步骤 4 - 为 Nextcloud 生成一个自签名 SSL 证书</h3>
<p>在教程中，我会让客户端以 https 连接来运行 Nextcloud。你可以使用诸如 let's encrypt 等免费 SSL 证书，或者是自己创建自签名 (self signed) SSL 证书。这里我使用 OpenSSL 来创建自己的自签名 SSL 证书。</p>
<p>为 SSL 文件创建新目录：</p>
<div class="highlight"><pre><span></span><code>mkdir -p /etc/nginx/cert/
</code></pre></div>

<p>如下，使用 <code>openssl</code> 生成一个新的 SSL 证书。</p>
<div class="highlight"><pre><span></span><code>openssl req -new -x509 -days 365 -nodes -out /etc/nginx/cert/nextcloud.crt -keyout /etc/nginx/cert/nextcloud.key
</code></pre></div>

<p>最后使用 <code>chmod</code> 命令将所有证书文件的权限设置为 <code>600</code>。</p>
<div class="highlight"><pre><span></span><code>chmod 700 /etc/nginx/cert
chmod 600 /etc/nginx/cert/*
</code></pre></div>

<p><img alt="为 Nextcloud 生成一个自签名 SSL 证书" src="/data/attachment/album/201702/27/115124dmwotmrvuow3wrxu.png"></p>
<h3>步骤 5 - 下载和安装 Nextcloud</h3>
<p>我直接使用 <code>wget</code> 命令下载 Nextcloud 到服务器上，因此需要先行安装 <code>wget</code>。此外，还需要安装 <code>unzip</code> 来进行解压。使用 <code>yum</code> 命令来安装这两个程序。</p>
<div class="highlight"><pre><span></span><code>yum -y install wget unzip
</code></pre></div>

<p>先进入 <code>/tmp</code> 目录，然后使用 <code>wget</code> 从官网下载最新的 Nextcloud 10。</p>
<div class="highlight"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span>
<span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">nextcloud</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">nextcloud</span><span class="o">-</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">2.</span><span class="n">zip</span>
</code></pre></div>

<p>解压 Nextcloud，并将其移动到 <code>/usr/share/nginx/html/</code> 目录。</p>
<div class="highlight"><pre><span></span><code>unzip nextcloud-10.0.2.zip
mv nextcloud/ /usr/share/nginx/html/
</code></pre></div>

<p>下一步，转到 Nginx 的 web 根目录为 Nextcloud 创建一个 <code>data</code> 文件夹。</p>
<div class="highlight"><pre><span></span><code>cd /usr/share/nginx/html/
mkdir -p nextcloud/data/
</code></pre></div>

<p>变更 <code>nextcloud</code> 目录的拥有者为 <code>nginx</code> 用户和组。</p>
<div class="highlight"><pre><span></span><code>chown nginx:nginx -R nextcloud/
</code></pre></div>

<h3>步骤 6 - 在 Nginx 中为 Nextcloud 配置虚拟主机</h3>
<p>在步骤 5 我们已经下载好了 Nextcloud 源码，并配置好了让它运行于 Nginx 服务器中，但我们还需要为它配置一个虚拟主机。在 Nginx 的 <code>conf.d</code> 目录下创建一个新的虚拟主机配置文件 <code>nextcloud.conf</code>。</p>
<div class="highlight"><pre><span></span><code>cd /etc/nginx/conf.d/
vim nextcloud.conf
</code></pre></div>

<p>将以下内容粘贴到虚拟主机配置文件中：</p>
<div class="highlight"><pre><span></span><code><span class="n">upstream</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">handler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
<span class="w">    </span><span class="c1">#server unix:/var/run/php5-fpm.sock;</span>
<span class="p">}</span>

<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">cloud</span><span class="o">.</span><span class="n">nextcloud</span><span class="o">.</span><span class="n">co</span><span class="p">;</span>
<span class="w">    </span><span class="c1"># enforce https</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//$</span><span class="n">server_name</span><span class="o">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="n">cloud</span><span class="o">.</span><span class="n">nextcloud</span><span class="o">.</span><span class="n">co</span><span class="p">;</span>

<span class="w">    </span><span class="n">ssl_certificate</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cert</span><span class="o">/</span><span class="n">nextcloud</span><span class="o">.</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">cert</span><span class="o">/</span><span class="n">nextcloud</span><span class="o">.</span><span class="n">key</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Add headers to serve security related headers</span>
<span class="w">    </span><span class="c1"># Before enabling Strict-Transport-Security headers please read into this</span>
<span class="w">    </span><span class="c1"># topic first.</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span><span class="w"> </span><span class="s2">&quot;max-age=15768000;</span>
<span class="w">    </span><span class="n">includeSubDomains</span><span class="p">;</span><span class="w"> </span><span class="nb">preload</span><span class="p">;</span><span class="s2">&quot;;</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">nosniff</span><span class="p">;</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="s2">&quot;SAMEORIGIN&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">XSS</span><span class="o">-</span><span class="n">Protection</span><span class="w"> </span><span class="s2">&quot;1; mode=block&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Robots</span><span class="o">-</span><span class="n">Tag</span><span class="w"> </span><span class="n">none</span><span class="p">;</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Download</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">noopen</span><span class="p">;</span>
<span class="w">    </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Permitted</span><span class="o">-</span><span class="n">Cross</span><span class="o">-</span><span class="n">Domain</span><span class="o">-</span><span class="n">Policies</span><span class="w"> </span><span class="n">none</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Path to the root of your installation</span>
<span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">nextcloud</span><span class="o">/</span><span class="p">;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">robots</span><span class="o">.</span><span class="n">txt</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">allow</span><span class="w"> </span><span class="n">all</span><span class="p">;</span>
<span class="w">        </span><span class="n">log_not_found</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># The following 2 rules are only needed for the user_webfinger app.</span>
<span class="w">    </span><span class="c1"># Uncomment it if you&#39;re planning to use this app.</span>
<span class="w">    </span><span class="c1">#rewrite ^/.well-known/host-meta /public.php?service=host-meta last;</span>
<span class="w">    </span><span class="c1">#rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json</span>
<span class="w">    </span><span class="c1"># last;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">carddav</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="o">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//$</span><span class="n">host</span><span class="o">/</span><span class="k">remote</span><span class="o">.</span><span class="n">php</span><span class="o">/</span><span class="n">dav</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">caldav</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="o">$</span><span class="n">scheme</span><span class="p">:</span><span class="o">//$</span><span class="n">host</span><span class="o">/</span><span class="k">remote</span><span class="o">.</span><span class="n">php</span><span class="o">/</span><span class="n">dav</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># set max upload size</span>
<span class="w">    </span><span class="n">client_max_body_size</span><span class="w"> </span><span class="mi">512</span><span class="n">M</span><span class="p">;</span>
<span class="w">    </span><span class="n">fastcgi_buffers</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="mi">4</span><span class="n">K</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Disable gzip to avoid the removal of the ETag header</span>
<span class="w">    </span><span class="n">gzip</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>

<span class="w">    </span><span class="c1"># Uncomment if your server is build with the ngx_pagespeed module</span>
<span class="w">    </span><span class="c1"># This module is currently not supported.</span>
<span class="w">    </span><span class="c1">#pagespeed off;</span>

<span class="w">    </span><span class="n">error_page</span><span class="w"> </span><span class="mi">403</span><span class="w"> </span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mf">403.</span><span class="n">php</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_page</span><span class="w"> </span><span class="mi">404</span><span class="w"> </span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mf">404.</span><span class="n">php</span><span class="p">;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rewrite</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="n">uri</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="p">(</span><span class="err">?</span><span class="p">:</span><span class="n">build</span><span class="o">|</span><span class="n">tests</span><span class="o">|</span><span class="n">config</span><span class="o">|</span><span class="n">lib</span><span class="o">|</span><span class="mi">3</span><span class="n">rdparty</span><span class="o">|</span><span class="n">templates</span><span class="o">|</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">deny</span><span class="w"> </span><span class="n">all</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="p">(</span><span class="err">?</span><span class="p">:</span>\<span class="o">.|</span><span class="n">autotest</span><span class="o">|</span><span class="n">occ</span><span class="o">|</span><span class="n">issue</span><span class="o">|</span><span class="n">indie</span><span class="o">|</span><span class="n">db_</span><span class="o">|</span><span class="n">console</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">deny</span><span class="w"> </span><span class="n">all</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="p">(</span><span class="err">?</span><span class="p">:</span><span class="n">index</span><span class="o">|</span><span class="k">remote</span><span class="o">|</span><span class="n">public</span><span class="o">|</span><span class="n">cron</span><span class="o">|</span><span class="n">core</span><span class="o">/</span><span class="n">ajax</span><span class="o">/</span><span class="n">update</span><span class="o">|</span><span class="n">status</span><span class="o">|</span><span class="n">ocs</span><span class="o">/</span><span class="n">v</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">|</span><span class="n">updater</span><span class="o">/.+|</span><span class="n">ocs</span><span class="o">-</span><span class="n">provider</span><span class="o">/.+|</span><span class="n">core</span><span class="o">/</span><span class="n">templates</span><span class="o">/</span><span class="mi">40</span><span class="p">[</span><span class="mi">34</span><span class="p">])</span>\<span class="o">.</span><span class="n">php</span><span class="p">(</span><span class="err">?</span><span class="p">:</span><span class="o">$|/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">include</span><span class="w"> </span><span class="n">fastcgi_params</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_split_path_info</span><span class="w"> </span><span class="o">^</span><span class="p">(</span><span class="o">.+</span>\<span class="o">.</span><span class="n">php</span><span class="p">)(</span><span class="o">/.*</span><span class="p">)</span><span class="o">$</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">SCRIPT_FILENAME</span><span class="w"> </span><span class="o">$</span><span class="n">document_root</span><span class="o">$</span><span class="n">fastcgi_script_name</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">PATH_INFO</span><span class="w"> </span><span class="o">$</span><span class="n">fastcgi_path_info</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">HTTPS</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">        </span><span class="c1">#Avoid sending the security headers twice</span>
<span class="w">        </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">modHeadersAvailable</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_param</span><span class="w"> </span><span class="n">front_controller_active</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_pass</span><span class="w"> </span><span class="n">php</span><span class="o">-</span><span class="n">handler</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_intercept_errors</span><span class="w"> </span><span class="n">on</span><span class="p">;</span>
<span class="w">        </span><span class="n">fastcgi_request_buffering</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="o">^/</span><span class="p">(</span><span class="err">?</span><span class="p">:</span><span class="n">updater</span><span class="o">|</span><span class="n">ocs</span><span class="o">-</span><span class="n">provider</span><span class="p">)(</span><span class="err">?</span><span class="p">:</span><span class="o">$|/</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="o">/</span><span class="w"> </span><span class="o">=</span><span class="mi">404</span><span class="p">;</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1"># Adding the cache control header for js and css files</span>
<span class="w">    </span><span class="c1"># Make sure it is BELOW the PHP block</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span>\<span class="o">.</span><span class="p">(</span><span class="err">?</span><span class="p">:</span><span class="n">css</span><span class="o">|</span><span class="n">js</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="n">uri</span><span class="o">$</span><span class="n">is_args</span><span class="o">$</span><span class="n">args</span><span class="p">;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="w"> </span><span class="s2">&quot;public, max-age=7200&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="c1"># Add headers to serve security related headers (It is intended to</span>
<span class="w">        </span><span class="c1"># have those duplicated to the ones above)</span>
<span class="w">        </span><span class="c1"># Before enabling Strict-Transport-Security headers please read into</span>
<span class="w">        </span><span class="c1"># this topic first.</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span><span class="w"> </span><span class="s2">&quot;max-age=15768000;</span>
<span class="w">        </span><span class="n">includeSubDomains</span><span class="p">;</span><span class="w"> </span><span class="nb">preload</span><span class="p">;</span><span class="s2">&quot;;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">nosniff</span><span class="p">;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="s2">&quot;SAMEORIGIN&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">XSS</span><span class="o">-</span><span class="n">Protection</span><span class="w"> </span><span class="s2">&quot;1; mode=block&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Robots</span><span class="o">-</span><span class="n">Tag</span><span class="w"> </span><span class="n">none</span><span class="p">;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Download</span><span class="o">-</span><span class="n">Options</span><span class="w"> </span><span class="n">noopen</span><span class="p">;</span>
<span class="w">        </span><span class="n">add_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Permitted</span><span class="o">-</span><span class="n">Cross</span><span class="o">-</span><span class="n">Domain</span><span class="o">-</span><span class="n">Policies</span><span class="w"> </span><span class="n">none</span><span class="p">;</span>
<span class="w">        </span><span class="c1"># Optional: Don&#39;t log access to assets</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">~*</span><span class="w"> </span>\<span class="o">.</span><span class="p">(</span><span class="err">?</span><span class="p">:</span><span class="n">svg</span><span class="o">|</span><span class="n">gif</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">html</span><span class="o">|</span><span class="n">ttf</span><span class="o">|</span><span class="n">woff</span><span class="o">|</span><span class="n">ico</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">try_files</span><span class="w"> </span><span class="o">$</span><span class="n">uri</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span><span class="o">$</span><span class="n">uri</span><span class="o">$</span><span class="n">is_args</span><span class="o">$</span><span class="n">args</span><span class="p">;</span>
<span class="w">        </span><span class="c1"># Optional: Don&#39;t log access to other assets</span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>保存文件并退出 vim。</p>
<p>下载测试以下该 Nginx 配置文件是否有错误，没有的话就可以重启服务了。</p>
<div class="highlight"><pre><span></span><code>nginx -t
systemctl restart nginx
</code></pre></div>

<p><img alt="在 Nginx 中为 Nextcloud 配置虚拟主机" src="/data/attachment/album/201702/27/115124zj7jqngyvc9rjpyq.png"></p>
<h3>步骤 7 - 为 Nextcloud 配置 SELinux 和 FirewallD 规则</h3>
<p>本教程中，我们将以强制模式运行 SELinux，因此需要一个 SELinux 管理工具来为 Nextcloud 配置 SELinux。</p>
<p>使用以下命令安装 SELinux 管理工具。</p>
<div class="highlight"><pre><span></span><code>yum -y install policycoreutils-python
</code></pre></div>

<p>然后以 root 用户来运行以下命令，以便让 Nextcloud 运行于 SELinux 环境之下。如果你是用的其他名称的目录，记得将 <code>nextcloud</code> 替换掉。</p>
<div class="highlight"><pre><span></span><code>semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/data(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/config(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/apps(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/assets(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/.htaccess&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/.user.ini&#39;

restorecon -Rv &#39;/usr/share/nginx/html/nextcloud/&#39;
</code></pre></div>

<p>接下来，我们要启用 firewalld 服务，同时为 Nextcloud 开启 http 和 https 端口。</p>
<p>启动 firewalld 并设置随系统启动。</p>
<div class="highlight"><pre><span></span><code>systemctl start firewalld
systemctl enable firewalld
</code></pre></div>

<p>现在使用 <code>firewall-cmd</code> 命令来开启 http 和 https 端口，然后重新加载防火墙。</p>
<div class="highlight"><pre><span></span><code><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">permanent</span><span class="w"> </span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">http</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">permanent</span><span class="w"> </span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">https</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span><span class="w"> </span><span class="o">--</span><span class="n">reload</span>
</code></pre></div>

<p><img alt="为 Nextcloud 配置 FirewallD 规则" src="/data/attachment/album/201702/27/115125fcx3sr7sw317zc53.png"></p>
<p>至此，服务器配置完成。</p>
<h3>步骤 8 - Nextcloud 安装</h3>
<p>打开你的 Web 浏览器，输入你为 Nextcloud 设置的域名，我这里设置为 <code>cloud.nextcloud.co</code>，然后会重定向到安全性更好的 https 连接。</p>
<p>设置你的管理员用户名和密码，然后输入数据验证信息，点击 '<strong>完成安装 (Finish Setup)</strong>'。</p>
<p><img alt="Nextcloud 安装" src="/data/attachment/album/201702/27/115125gs4ojzf7h1fobrdo.png"></p>
<p>Nextcloud 管理面板大致如下：</p>
<p><img alt="Nextcloud 管理面板" src="/data/attachment/album/201702/27/115126kn65n94gi1nnd5i5.png"></p>
<p>Nextcloud 用户设置：</p>
<p><img alt="Nextcloud 用户设置" src="/data/attachment/album/201702/27/115126zo7y3krynetk9eek.png"></p>
<p>管理设置：</p>
<p><img alt="管理设置" src="/data/attachment/album/201702/27/115127rhpkkk7wv568whhj.png"></p>
<p>至此，我们在 CentOS 7 服务器上通过使用 Nginx、PHP7-FPM、MariaDB 完成了 Nextcloud 的安装。</p>
<h3>参考链接</h3>
<ul>
<li><a href="https://docs.nextcloud.com/">https://docs.nextcloud.com/</a></li>
</ul>
<p>via: <a href="https://www.howtoforge.com/tutorial/how-to-install-nextcloud-with-nginx-and-php-fpm-on-centos-7/">https://www.howtoforge.com/tutorial/how-to-install-nextcloud-with-nginx-and-php-fpm-on-centos-7/</a></p>
<p>作者：<a href="https://www.howtoforge.com/tutorial/how-to-install-nextcloud-with-nginx-and-php-fpm-on-centos-7/">Muhammad Arul</a> 译者：<a href="https://github.com/GHLandy">GHLandy</a> 校对：<a href="https://github.com/wxy">wxy</a></p>
<p>本文由 <a href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a href="https://linux.cn/">Linux中国</a> 荣誉推出</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>