<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Linux 系统中修复 SambaCry 漏洞（CVE-2017-7494）</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Gabriel Cánepa Samba 很久以来一直是为 *nix 系统上的 Windows 客户端提供共享文件和打印服务的标准。家庭用户，中型企业和大型公司都在 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2017/06/linux-xi-tong-zhong-xiu-fu-sambacry-lou-dong-cve-2017-7494.html" rel="bookmark"
           title="Permalink to Linux 系统中修复 SambaCry 漏洞（CVE-2017-7494）">Linux 系统中修复 SambaCry 漏洞（CVE-2017-7494）</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-06-10T09:57:38+02:00">
                Published: Sat 10 June 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Gabriel Cánepa</p>
<p><img alt="" src="/data/attachment/album/201706/10/095734grkg01cz9rnrclnk.png"></p>
<p>Samba 很久以来一直是为 *nix 系统上的 Windows 客户端提供共享文件和打印服务的标准。家庭用户，中型企业和大型公司都在使用它，它作为最佳解决方案在多种操作系统共存的环境中脱颖而出。</p>
<p>由于广泛使用的工具很可能发生这种情况，大多数 Samba 安装都面临着可能利用已知漏洞的攻击的风险，这个漏洞直到 WannaCry 勒索软件攻击的新闻出来之前都被认为是不重要的。</p>
<p>在本文中，我们将解释这个 Samba 漏洞是什么以及如何保护你负责的系统。根据你的安装类型（从仓库或者源码），你需要采取不同的方法。</p>
<p>如果你目前有在任何环境中使用 Samba 或者知道有人在使用，请继续阅读！</p>
<h3>漏洞</h3>
<p>过时和未修补的系统容易受到远程代码执行漏洞的攻击。简单来说，这意味着访问可写共享的人可以上传一段任意代码，并使用服务器中的 root 权限执行该代码。</p>
<p>这个问题在 Samba 网站上被描述为 <a href="https://www.samba.org/samba/security/CVE-2017-7494.html">CVE-2017-7494</a>，并且已知会影响 Samba v3.5（2010 年 3 月初发布）及以后版本。由于与 WannaCry 有相似之处，它被非官方地被命名为 SambaCry：它们均针对 SMB 协议，并且可能是蠕虫病毒 - 这可能导致其从一个系统传播到另一个系统中。</p>
<p>Debian、Ubuntu、CentOS 和 Red Hat 已采取快速的行动来保护它们的用户，并为其支持的版本发布了补丁。另外，还提供了不受支持的安全临时解决方案。</p>
<h3>更新 Samba</h3>
<p>如先前提到的那样，根据你之前安装的方法有两种方式更新：</p>
<h4>如果你从发行版的仓库中安装的 Samba</h4>
<p>让我们看下在这种情况下你需要做什么：</p>
<p><strong>在 Debian 下修复 SambaCry</strong></p>
<p>添加下面的行到你的源列表中（<code>/etc/apt/sources.list</code>）以确保 apt 能够获得最新的安全更新：</p>
<div class="highlight"><pre><span></span><code><span class="k">deb</span><span class="w"> </span><span class="s">http://security.debian.org</span><span class="w"> </span><span class="kp">stable/updates</span><span class="w"> </span><span class="kp">main</span>
<span class="k">deb-src</span><span class="w"> </span><span class="s">http://security.debian.org/</span><span class="w"> </span><span class="kp">stable/updates</span><span class="w"> </span><span class="kp">main</span>
</code></pre></div>

<p>接下来，更新可用的软件包：</p>
<div class="highlight"><pre><span></span><code># aptitude update
</code></pre></div>

<p>最后，确保 samba 软件包的版本符合漏洞修复的版本（见 <a href="https://security-tracker.debian.org/tracker/CVE-2017-7494">CVE-2017-7494</a>）：</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="nv">aptitude</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="nv">samba</span>
</code></pre></div>

<p><img alt="Fix Sambacry in Debian" src="/data/attachment/album/201706/10/095739iatdzb40jdk4pbzl.png"></p>
<p><em>在 Debian 中修复 SambaCry</em></p>
<p><strong>在 Ubuntu 中修复 SambaCry</strong></p>
<p>要开始修复，如下检查新的可用软件包并更新 Samba 软件包：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>samba
</code></pre></div>

<p>已经修复 CVE-2017-7494 的 Samba 版本有下面这些：</p>
<ul>
<li>17.04: samba 2:4.5.8+dfsg-0ubuntu0.17.04.2</li>
<li>16.10: samba 2:4.4.5+dfsg-2ubuntu5.6</li>
<li>16.04 LTS: samba 2:4.3.11+dfsg-0ubuntu0.16.04.7</li>
<li>14.04 LTS: samba 2:4.3.11+dfsg-0ubuntu0.14.04.8</li>
</ul>
<p>最后，运行下面命令验证你的 Ubuntu 已经安装了正确的版本。</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-cache<span class="w"> </span>show<span class="w"> </span>samba
</code></pre></div>

<p><strong>在 CentOS/RHEL 7 中修复 SambaCry</strong></p>
<p>在 EL 7 中打过补丁的 Samba 版本是 samba-4.4.4-14.el7_3。要安装它，这些做：</p>
<div class="highlight"><pre><span></span><code># yum makecache fast
# yum update samba
</code></pre></div>

<p>像先前那样，确保你已经安装了打补丁的 Samba 版本：</p>
<div class="highlight"><pre><span></span><code># yum info samba
</code></pre></div>

<p><img alt="Fix Sambacry in CentOS" src="/data/attachment/album/201706/10/095740l8j3383hjnhmd8ac.png"></p>
<p><em>在 CentOS 中修复 SambaCry</em></p>
<p>旧支持的 CentOS 以及 RHEL 更老的版本也有修复。参见 <a href="https://rhn.redhat.com/errata/RHSA-2017-1270.html">RHSA-2017-1270</a> 获取更多。</p>
<h4>如果你从源码安装的 Samba</h4>
<p>注意：下面的过程假设你先前从源码构建的 Samba。强烈建议你在部署到生产服务器之前先在测试环境尝试。</p>
<p>此外，开始之前确保你备份了 <code>smb.conf</code> 文件。</p>
<p>在这种情况下，我们也会从源码编译并更新 Samba。然而在开始之前，我们必须先确保安装了所有的依赖。注意这也许会花费几分钟。</p>
<p><strong>在 Debian 和 Ubuntu 中：</strong></p>
<div class="highlight"><pre><span></span><code># aptitude install acl attr autoconf bison build-essential \
debhelper dnsutils docbook-xml docbook-xsl flex gdb krb5-user \
libacl1-dev libaio-dev libattr1-dev libblkid-dev libbsd-dev \
libcap-dev libcups2-dev libgnutls28-dev libjson-perl \
libldap2-dev libncurses5-dev libpam0g-dev libparse-yapp-perl \
libpopt-dev libreadline-dev perl perl-modules pkg-config \
python-all-dev python-dev python-dnspython python-crypto xsltproc \
zlib1g-dev libsystemd-dev libgpgme11-dev python-gpgme python-m2crypto
</code></pre></div>

<p><strong>在 CentOS 7 或相似的版本中：</strong></p>
<div class="highlight"><pre><span></span><code># yum install attr bind-utils docbook-style-xsl gcc gdb krb5-workstation \
libsemanage-python libxslt perl perl-ExtUtils-MakeMaker \
perl-Parse-Yapp perl-Test-Base pkgconfig policycoreutils-python \
python-crypto gnutls-devel libattr-devel keyutils-libs-devel \
libacl-devel libaio-devel libblkid-devel libxml2-devel openldap-devel \
pam-devel popt-devel python-devel readline-devel zlib-devel
</code></pre></div>

<p>停止服务（LCTT 译注：此处不必要）：</p>
<div class="highlight"><pre><span></span><code># systemctl stop smbd
</code></pre></div>

<p>下载并解压源码（在写作时 4.6.4 是最新的版本）：</p>
<div class="highlight"><pre><span></span><code># wget https://www.samba.org/samba/ftp/samba-latest.tar.gz 
# tar xzf samba-latest.tar.gz
# cd samba-4.6.4
</code></pre></div>

<p>出于了解信息的目的，用以下命令检查可用的配置选项。</p>
<div class="highlight"><pre><span></span><code># ./configure --help
</code></pre></div>

<p>如果你在先前的版本的构建中有使用到一些选项，你或许可以在上面命令的返回中包含一些选项，或者你可以选择使用默认值：</p>
<div class="highlight"><pre><span></span><code># ./configure
# make
# make install
</code></pre></div>

<p>最后重启服务。</p>
<div class="highlight"><pre><span></span><code># systemctl restart smbd
</code></pre></div>

<p>并验证你正在使用的是更新后的版本：</p>
<div class="highlight"><pre><span></span><code># smbstatus --version
</code></pre></div>

<p>这里返回的应该是 4.6.4。</p>
<h3>其它情况</h3>
<p>如果你使用的是不受支持的发行版本，并且由于某些原因无法升级到最新版本，你或许要考虑下面这些建议：</p>
<ul>
<li>如果 SELinux 是启用的，你是处于保护之下的！</li>
<li>确保 Samba 共享是用 <code>noexec</code> 选项挂载的。这会阻止二进制文件从被挂载的文件系统中执行。</li>
</ul>
<p>还有将：</p>
<div class="highlight"><pre><span></span><code>nt pipe support = no
</code></pre></div>

<p>添加到 <code>smb.conf</code> 的 <code>[global]</code> 字段中。你或许要记住，根据 Samba 项目，这“或许禁用 Windows 客户端的某些功能”。</p>
<p>重要：注意 <code>nt pipe support = no</code> 选项会禁用 Windows 客户端的共享列表。比如：当你在一台 Samba 服务器的 Windows Explorer 中输入 <code>\\10.100.10.2\</code> 时，你会看到 “permission denied”。Windows 客户端不得不手动执行共享，如 <code>\\10.100.10.2\share_name</code> 来访问共享。</p>
<h3>总结</h3>
<p>在本篇中，我们已经描述了 SambaCry 漏洞以及如何减轻影响。我们希望你可以使用这个信息来保护你负责的系统。</p>
<p>如果你有关于这篇文章的任何提问以及评论，欢迎使用下面的评论栏让我们知道。</p>
<p>via: <a href="https://www.tecmint.com/fix-sambacry-vulnerability-cve-2017-7494-in-linux/">https://www.tecmint.com/fix-sambacry-vulnerability-cve-2017-7494-in-linux/</a></p>
<p>作者：<a href="https://www.tecmint.com/author/gacanepa/">Gabriel Cánepa</a> 译者：<a href="https://github.com/geekpi">geekpi</a> 校对：<a href="https://github.com/wxy">wxy</a></p>
<p>本文由 <a href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a href="https://linux.cn/">Linux中国</a> 荣誉推出</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>