<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Headless Chrome 入门</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Eric Bidelman 摘要 在 Chrome 59 中开始搭载 Headless Chrome。这是一种在 无需显示 headless 的环境下运行 Chrome 浏览器的方式。从本质上来说，就是不用 chrome 浏 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2017/09/headless-chrome-ru-men.html" rel="bookmark"
           title="Permalink to Headless Chrome 入门">Headless Chrome 入门</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-08T11:34:00+02:00">
                Published: Fri 08 September 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Eric Bidelman</p>
<p><img alt="" src="/data/attachment/album/201709/08/113337g9jjamqsizxmie3s.png"></p>
<h3>摘要</h3>
<p>在 Chrome 59　中开始搭载 <a href="https://chromium.googlesource.com/chromium/src/+/lkgr/headless/README.md">Headless Chrome</a>。这是一种在<ruby> 无需显示 <rt>  headless </rt></ruby>的环境下运行 Chrome 浏览器的方式。从本质上来说，就是不用 chrome 浏览器来运行 Chrome 的功能！它将 Chromium 和 Blink 渲染引擎提供的所有现代 Web 平台的功能都带入了命令行。</p>
<p>它有什么用？</p>
<p><ruby> 无需显示 <rt>  headless </rt></ruby>的浏览器对于自动化测试和不需要可视化 UI 界面的服务器环境是一个很好的工具。例如，你可能需要对真实的网页运行一些测试，创建一个 PDF，或者只是检查浏览器如何呈现 URL。</p>
<blockquote>
<p><strong>注意：</strong> Mac 和 Linux 上的 Chrome 59 都可以运行无需显示模式。<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=686608">对 Windows 的支持</a>将在 Chrome 60 中提供。要检查你使用的 Chrome 版本，请在浏览器中打开 <code>chrome://version</code>。</p>
</blockquote>
<h3>开启<ruby> 无需显示 <rt>  headless </rt></ruby>模式（命令行界面）</h3>
<p>开启<ruby> 无需显示 <rt>  headless </rt></ruby>模式最简单的方法是从命令行打开 Chrome 二进制文件。如果你已经安装了 Chrome 59 以上的版本，请使用 <code>--headless</code> 标志启动 Chrome：</p>
<div class="highlight"><pre><span></span><code><span class="nv">chrome</span><span class="w"> </span>\
<span class="w">  </span><span class="o">--</span><span class="nv">headless</span><span class="w"> </span>\<span class="w">                   </span>#<span class="w"> </span><span class="nv">Runs</span><span class="w"> </span><span class="nv">Chrome</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">headless</span><span class="w"> </span><span class="nv">mode</span>.
<span class="w">  </span><span class="o">--</span><span class="nv">disable</span><span class="o">-</span><span class="nv">gpu</span><span class="w"> </span>\<span class="w">                </span>#<span class="w"> </span><span class="nv">Temporarily</span><span class="w"> </span><span class="nv">needed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">now</span>.
<span class="w">  </span><span class="o">--</span><span class="nv">remote</span><span class="o">-</span><span class="nv">debugging</span><span class="o">-</span><span class="nv">port</span><span class="o">=</span><span class="mi">9222</span><span class="w"> </span>\
<span class="w">  </span><span class="nv">https</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">chromestatus</span>.<span class="nv">com</span><span class="w">   </span>#<span class="w"> </span><span class="nv">URL</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">open</span>.<span class="w"> </span><span class="nv">Defaults</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">about</span>:<span class="nv">blank</span>.
</code></pre></div>

<blockquote>
<p><strong>注意：</strong>目前你仍然需要使用 <code>--disable-gpu</code> 标志。但它最终会不需要的。</p>
</blockquote>
<p><code>chrome</code> 二进制文件应该指向你安装 Chrome 的位置。确切的位置会因平台差异而不同。当前我在 Mac 上操作，所以我为安装的每个版本的 Chrome 都创建了方便使用的别名。</p>
<p>如果您使用 Chrome 的稳定版，并且无法获得测试版，我建议您使用 <code>chrome-canary</code> 版本：</p>
<div class="highlight"><pre><span></span><code>alias chrome=&quot;/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome&quot;
alias chrome-canary=&quot;/Applications/Google\ Chrome\ Canary.app/Contents/MacOS/Google\ Chrome\ Canary&quot;
alias chromium=&quot;/Applications/Chromium.app/Contents/MacOS/Chromium&quot;
</code></pre></div>

<p>在<a href="https://www.google.com/chrome/browser/canary.html">这里</a>下载 Chrome Cannary。</p>
<h3>命令行的功能</h3>
<p>在某些情况下，你可能不需要<a href="https://developers.google.com/web/updates/2017/04/headless-chrome#node">以脚本编程的方式</a>操作 Headless Chrome。可以使用一些<a href="https://cs.chromium.org/chromium/src/headless/app/headless_shell_switches.cc">有用的命令行标志</a>来执行常见的任务。</p>
<h4>打印 DOM</h4>
<p><code>--dump-dom</code> 标志将打印 <code>document.body.innerHTML</code> 到标准输出：</p>
<div class="highlight"><pre><span></span><code>chrome --headless --disable-gpu --dump-dom https://www.chromestatus.com/
</code></pre></div>

<h4>创建一个 PDF</h4>
<p><code>--print-to-pdf</code> 标志将页面转出为 PDF 文件：</p>
<div class="highlight"><pre><span></span><code>chrome --headless --disable-gpu --print-to-pdf https://www.chromestatus.com/
</code></pre></div>

<h4>截图</h4>
<p>要捕获页面的屏幕截图，请使用 <code>--screenshot</code> 标志：</p>
<div class="highlight"><pre><span></span><code>chrome --headless --disable-gpu --screenshot https://www.chromestatus.com/

# Size of a standard letterhead.
chrome --headless --disable-gpu --screenshot --window-size=1280,1696 https://www.chromestatus.com/

# Nexus 5x
chrome --headless --disable-gpu --screenshot --window-size=412,732 https://www.chromestatus.com/
</code></pre></div>

<p>使用 <code>--screenshot</code> 标志运行 Headless Chrome 将在当前工作目录中生成一个名为 <code>screenshot.png</code> 的文件。如果你正在寻求整个页面的截图，那么会涉及到很多事情。来自 David Schnurr 的一篇很棒的博文已经介绍了这一内容。请查看 <a href="https://medium.com/@dschnr/using-headless-chrome-as-an-automated-screenshot-tool-4b07dffba79a">使用 headless Chrome 作为自动截屏工具</a>。</p>
<h4>REPL 模式 (read-eval-print loop)</h4>
<p><code>--repl</code> 标志可以使 Headless Chrome 运行在一个你可以使用浏览器评估 JS 表达式的模式下。执行下面的命令：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>chrome<span class="w"> </span>--headless<span class="w"> </span>--disable-gpu<span class="w"> </span>--repl<span class="w"> </span>https://www.chromestatus.com/
<span class="o">[</span><span class="m">0608</span>/112805.245285:INFO:headless_shell.cc<span class="o">(</span><span class="m">278</span><span class="o">)]</span><span class="w"> </span>Type<span class="w"> </span>a<span class="w"> </span>Javascript<span class="w"> </span>expression<span class="w"> </span>to<span class="w"> </span>evaluate<span class="w"> </span>or<span class="w"> </span><span class="s2">&quot;quit&quot;</span><span class="w"> </span>to<span class="w"> </span>exit.
&gt;&gt;&gt;<span class="w"> </span>location.href
<span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="o">{</span><span class="s2">&quot;type&quot;</span>:<span class="s2">&quot;string&quot;</span>,<span class="s2">&quot;value&quot;</span>:<span class="s2">&quot;https://www.chromestatus.com/features&quot;</span><span class="o">}}</span>
&gt;&gt;&gt;<span class="w"> </span>quit
</code></pre></div>

<h3>在没有浏览器界面的情况下调试 Chrome</h3>
<p>当你使用 <code>--remote-debugging-port=9222</code> 运行 Chrome 时，它会启动一个支持 <a href="https://chromedevtools.github.io/devtools-protocol/">DevTools 协议</a>的实例。该协议用于与 Chrome 进行通信，并且驱动 Headless Chrome 浏览器实例。它也是一个类似 Sublime、VS Code 和 Node 的工具，可用于应用程序的远程调试。#协同效应</p>
<p>由于你没有浏览器用户界面可用来查看网页，请在另一个浏览器中输入 <code>http://localhost:9222</code>，以检查一切是否正常。你将会看到一个<ruby> 可检查的 <rt>  inspectable </rt></ruby>页面的列表，可以点击它们来查看 Headless Chrome 正在呈现的内容：</p>
<p><img alt="" src="/data/attachment/album/201709/08/113716ghwls9r2wtu2mwhl.jpg"></p>
<p><em>DevTools 远程调试界面</em></p>
<p>从这里，你就可以像往常一样使用熟悉的 DevTools 来检查、调试和调整页面了。如果你以编程方式使用 Headless Chrome，这个页面也是一个功能强大的调试工具，用于查看所有通过网络与浏览器交互的原始 DevTools 协议命令。</p>
<h3>使用编程模式 （Node）</h3>
<h4>Puppeteer 库 API</h4>
<p><a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a> 是一个由 Chrome 团队开发的 Node 库。它提供了一个高层次的 API 来控制无需显示版（或 完全版）的 Chrome。它与其他自动化测试库，如 Phantom 和 NightmareJS 相类似，但是只适用于最新版本的 Chrome。</p>
<p>除此之外，Puppeteer 还可用于轻松截取屏幕截图，创建 PDF，页面间导航以及获取有关这些页面的信息。如果你想快速地自动化进行浏览器测试，我建议使用该库。它隐藏了 DevTools 协议的复杂性，并可以处理诸如启动 Chrome 调试实例等繁冗的任务。</p>
<p>安装：</p>
<div class="highlight"><pre><span></span><code>yarn add puppeteer
</code></pre></div>

<p><strong>例子</strong> - 打印用户代理：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">puppeteer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;puppeteer&#39;</span><span class="p">);</span>

<span class="p">(</span><span class="n">async</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">browser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">puppeteer</span><span class="o">.</span><span class="n">launch</span><span class="p">();</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="n">browser</span><span class="o">.</span><span class="n">version</span><span class="p">());</span>
<span class="w">  </span><span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">})();</span>
</code></pre></div>

<p><strong>例子</strong> - 获取页面的屏幕截图：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">puppeteer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;puppeteer&#39;</span><span class="p">);</span>

<span class="p">(</span><span class="n">async</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="k">const</span><span class="w"> </span><span class="n">browser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">puppeteer</span><span class="o">.</span><span class="n">launch</span><span class="p">();</span>
<span class="k">const</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">browser</span><span class="o">.</span><span class="n">newPage</span><span class="p">();</span>
<span class="n">await</span><span class="w"> </span><span class="n">page</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="s1">&#39;https://www.chromestatus.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">waitUntil</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;networkidle&#39;</span><span class="p">});</span>
<span class="n">await</span><span class="w"> </span><span class="n">page</span><span class="o">.</span><span class="n">pdf</span><span class="p">({</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;page.pdf&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;A4&#39;</span><span class="p">});</span>

<span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">})();</span>
</code></pre></div>

<p>查看 <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md">Puppeteer 的文档</a>，了解完整 API 的更多信息。</p>
<h4>CRI 库</h4>
<p><a href="https://www.npmjs.com/package/chrome-remote-interface">chrome-remote-interface</a> 是一个比 Puppeteer API 更低层次的库。如果你想要更接近原始信息和更直接地使用 <a href="https://chromedevtools.github.io/devtools-protocol/">DevTools 协议</a>的话，我推荐使用它。</p>
<p><strong>启动 Chrome</strong></p>
<p>chrome-remote-interface 不会为你启动 Chrome，所以你要自己启动它。</p>
<p>在前面的 CLI 章节中，我们使用 <code>--headless --remote-debugging-port=9222</code> <a href="https://developers.google.com/web/updates/2017/04/headless-chrome#cli">手动启动了 Chrome</a>。但是，要想做到完全自动化测试，你可能希望从你的应用程序中启动 Chrome。</p>
<p>其中一种方法是使用 <code>child_process</code>：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">execFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execFile</span><span class="p">;</span>

<span class="n">function</span><span class="w"> </span><span class="n">launchHeadlessChrome</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Assuming</span><span class="w"> </span><span class="n">MacOSx</span><span class="o">.</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">CHROME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="n">execFile</span><span class="p">(</span><span class="n">CHROME</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;--headless&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;--disable-gpu&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;--remote-debugging-port=9222&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">],</span><span class="w"> </span><span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">launchHeadlessChrome</span><span class="p">(</span><span class="s1">&#39;https://www.chromestatus.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">...</span>
<span class="p">});</span>
</code></pre></div>

<p>但是如果你想要在多个平台上运行可移植的解决方案，事情会变得很棘手。请注意 Chrome 的硬编码路径：</p>
<p><strong>使用 ChromeLauncher</strong></p>
<p><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> 是一个令人称奇的网络应用的质量测试工具。Lighthouse 内部开发了一个强大的用于启动 Chrome 的模块，现在已经被提取出来单独使用。<a href="https://www.npmjs.com/package/chrome-launcher">chrome-launcher NPM 模块</a> 可以找到 Chrome 的安装位置，设置调试实例，启动浏览器和在程序运行完之后将其杀死。它最好的一点是可以跨平台工作，感谢 Node！</p>
<p>默认情况下，<strong>chrome-launcher 会尝试启动 Chrome Canary</strong>（如果已经安装），但是你也可以更改它，手动选择使用的 Chrome 版本。要想使用它，首先从 npm 安装：</p>
<div class="highlight"><pre><span></span><code>yarn add chrome-launcher
</code></pre></div>

<p><strong>例子</strong> - 使用 <code>chrome-launcher</code> 启动 Headless Chrome：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">chromeLauncher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;chrome-launcher&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="w"> </span><span class="n">Optional</span><span class="p">:</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">logging</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">launcher</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">output</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">using</span><span class="p">:</span><span class="w"> </span><span class="n">yarn</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">lighthouse</span><span class="o">-</span><span class="n">logger</span>
<span class="o">//</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="nb">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;lighthouse-logger&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="w"> </span><span class="nb">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">);</span>

<span class="o">/**</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Launches</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Chrome</span><span class="o">.</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="n">param</span><span class="w"> </span><span class="p">{</span><span class="n">boolean</span><span class="o">=</span><span class="p">}</span><span class="w"> </span><span class="n">headless</span><span class="w"> </span><span class="n">True</span><span class="w"> </span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="w"> </span><span class="n">launches</span><span class="w"> </span><span class="n">Chrome</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">headless</span><span class="w"> </span><span class="n">mode</span><span class="o">.</span>
<span class="w"> </span><span class="o">*</span><span class="w">     </span><span class="n">False</span><span class="w"> </span><span class="n">launches</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Chrome</span><span class="o">.</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">@</span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">Promise</span><span class="o">&lt;</span><span class="n">ChromeLauncher</span><span class="o">&gt;</span><span class="p">}</span>
<span class="w"> </span><span class="o">*/</span>
<span class="n">function</span><span class="w"> </span><span class="n">launchChrome</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">chromeLauncher</span><span class="o">.</span><span class="n">launch</span><span class="p">({</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="mi">9222</span><span class="p">,</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Uncomment</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">force</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">choice</span><span class="o">.</span>
<span class="w">    </span><span class="n">chromeFlags</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s1">&#39;--window-size=412,732&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;--disable-gpu&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="n">headless</span><span class="w"> </span><span class="err">?</span><span class="w"> </span><span class="s1">&#39;--headless&#39;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="n">launchChrome</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">chrome</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="err">`</span><span class="n">Chrome</span><span class="w"> </span><span class="n">debuggable</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">chrome</span><span class="o">.</span><span class="n">port</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="w">  </span><span class="o">...</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">chrome</span><span class="o">.</span><span class="n">kill</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>

<p>运行这个脚本没有做太多的事情，但你应该能在任务管理器中看到启动了一个 Chrome 的实例，它加载了页面 <code>about:blank</code>。记住，它不会有任何的浏览器界面，我们是无需显示的。</p>
<p>为了控制浏览器，我们需要 DevTools 协议！</p>
<h4>检索有关页面的信息</h4>
<blockquote>
<p><strong>警告：</strong> DevTools 协议可以做一些有趣的事情，但是起初可能有点令人生畏。我建议先花点时间浏览 <a href="https://chromedevtools.github.io/devtools-protocol/">DevTools 协议查看器</a>。然后，转到 <code>chrome-remote-interface</code> 的 API 文档，看看它是如何包装原始协议的。</p>
</blockquote>
<p>我们来安装该库：</p>
<div class="highlight"><pre><span></span><code>yarn add chrome-remote-interface
</code></pre></div>

<p><strong>例子</strong> - 打印用户代理：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">CDP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;chrome-remote-interface&#39;</span><span class="p">);</span>

<span class="o">...</span>

<span class="n">launchChrome</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">chrome</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">CDP</span><span class="o">.</span><span class="n">Version</span><span class="p">({</span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="n">chrome</span><span class="o">.</span><span class="n">port</span><span class="p">});</span>
<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div>

<p>结果是类似这样的东西：<code>HeadlessChrome/60.0.3082.0</code>。</p>
<p><strong>例子</strong> - 检查网站是否有 <a href="https://developers.google.com/web/fundamentals/engage-and-retain/web-app-manifest/">Web 应用程序清单</a>：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">CDP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;chrome-remote-interface&#39;</span><span class="p">);</span>

<span class="o">...</span>

<span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="k">const</span><span class="w"> </span><span class="n">chrome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">launchChrome</span><span class="p">();</span>
<span class="k">const</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">CDP</span><span class="p">({</span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="n">chrome</span><span class="o">.</span><span class="n">port</span><span class="p">});</span>

<span class="o">//</span><span class="w"> </span><span class="n">Extract</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">DevTools</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">domains</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">them</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">docs</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">chromedevtools</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">devtools</span><span class="o">-</span><span class="n">protocol</span><span class="o">/</span>
<span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="n">Page</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">protocol</span><span class="p">;</span>
<span class="n">await</span><span class="w"> </span><span class="n">Page</span><span class="o">.</span><span class="n">enable</span><span class="p">();</span>

<span class="n">Page</span><span class="o">.</span><span class="n">navigate</span><span class="p">({</span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://www.chromestatus.com/&#39;</span><span class="p">});</span>

<span class="o">//</span><span class="w"> </span><span class="n">Wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">doing</span><span class="w"> </span><span class="n">stuff</span><span class="o">.</span>
<span class="n">Page</span><span class="o">.</span><span class="n">loadEventFired</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Page</span><span class="o">.</span><span class="n">getAppManifest</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Manifest: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">manifest</span><span class="o">.</span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Site has no app manifest&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">protocol</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="w">  </span><span class="n">chrome</span><span class="o">.</span><span class="n">kill</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Kill</span><span class="w"> </span><span class="n">Chrome</span><span class="o">.</span>
<span class="p">});</span>

<span class="p">})();</span>
</code></pre></div>

<p><strong>例子</strong> - 使用 DOM API 提取页面的 <code>&lt;title&gt;</code>：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">CDP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;chrome-remote-interface&#39;</span><span class="p">);</span>

<span class="o">...</span>

<span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="k">const</span><span class="w"> </span><span class="n">chrome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">launchChrome</span><span class="p">();</span>
<span class="k">const</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">CDP</span><span class="p">({</span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="n">chrome</span><span class="o">.</span><span class="n">port</span><span class="p">});</span>

<span class="o">//</span><span class="w"> </span><span class="n">Extract</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">DevTools</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="n">domains</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">them</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">docs</span><span class="p">:</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">chromedevtools</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">devtools</span><span class="o">-</span><span class="n">protocol</span><span class="o">/</span>
<span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="n">Page</span><span class="p">,</span><span class="w"> </span><span class="n">Runtime</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">protocol</span><span class="p">;</span>
<span class="n">await</span><span class="w"> </span><span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">Page</span><span class="o">.</span><span class="n">enable</span><span class="p">(),</span><span class="w"> </span><span class="n">Runtime</span><span class="o">.</span><span class="n">enable</span><span class="p">()]);</span>

<span class="n">Page</span><span class="o">.</span><span class="n">navigate</span><span class="p">({</span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://www.chromestatus.com/&#39;</span><span class="p">});</span>

<span class="o">//</span><span class="w"> </span><span class="n">Wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">onload</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">doing</span><span class="w"> </span><span class="n">stuff</span><span class="o">.</span>
<span class="n">Page</span><span class="o">.</span><span class="n">loadEventFired</span><span class="p">(</span><span class="n">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">js</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;document.querySelector(&#39;title&#39;).textContent&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Evaluate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">JS</span><span class="w"> </span><span class="n">expression</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">page</span><span class="o">.</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">Runtime</span><span class="o">.</span><span class="n">evaluate</span><span class="p">({</span><span class="n">expression</span><span class="p">:</span><span class="w"> </span><span class="n">js</span><span class="p">});</span>

<span class="w">  </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Title of page: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">value</span><span class="p">);</span>

<span class="w">  </span><span class="n">protocol</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="w">  </span><span class="n">chrome</span><span class="o">.</span><span class="n">kill</span><span class="p">();</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Kill</span><span class="w"> </span><span class="n">Chrome</span><span class="o">.</span>
<span class="p">});</span>

<span class="p">})();</span>
</code></pre></div>

<h3>使用 Selenium、WebDriver 和 ChromeDriver</h3>
<p>现在，Selenium 开启了 Chrome 的完整实例。换句话说，这是一个自动化的解决方案，但不是完全无需显示的。但是，Selenium 只需要进行小小的配置即可运行 Headless Chrome。如果你想要关于如何自己设置的完整说明，我建议你阅读“<a href="https://intoli.com/blog/running-selenium-with-headless-chrome/">使用 Headless Chrome 来运行 Selenium</a>”，不过你可以从下面的一些示例开始。</p>
<h4>使用 ChromeDriver</h4>
<p><a href="https://sites.google.com/a/chromium.org/chromedriver/">ChromeDriver</a> 2.3.0 支持 Chrome 59 及更新版本，可与 Headless Chrome 配合使用。在某些情况下，你可能需要等到 Chrome 60 以解决 bug。例如，Chrome 59 中屏幕截图已知存在问题。</p>
<p>安装：</p>
<div class="highlight"><pre><span></span><code>yarn add selenium-webdriver chromedriver
</code></pre></div>

<p>例子：</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">webdriver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;selenium-webdriver&#39;</span><span class="p">);</span>
<span class="k">const</span><span class="w"> </span><span class="n">chromedriver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;chromedriver&#39;</span><span class="p">);</span>

<span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">Canary</span><span class="w"> </span><span class="n">installation</span><span class="o">.</span>
<span class="o">//</span><span class="w"> </span><span class="n">I</span><span class="s1">&#39;m assuming Mac for the example.</span>
<span class="k">const</span><span class="w"> </span><span class="n">PATH_TO_CANARY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary&#39;</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">chromeCapabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">webdriver</span><span class="o">.</span><span class="n">Capabilities</span><span class="o">.</span><span class="n">chrome</span><span class="p">();</span>
<span class="n">chromeCapabilities</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;chromeOptions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">binary</span><span class="p">:</span><span class="w"> </span><span class="n">PATH_TO_CANARY</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">Screenshots</span><span class="w"> </span><span class="n">require</span><span class="w"> </span><span class="n">Chrome</span><span class="w"> </span><span class="mi">60</span>\<span class="o">.</span><span class="w"> </span><span class="n">Force</span><span class="w"> </span><span class="n">Canary</span><span class="o">.</span>
<span class="w">  </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;--headless&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">});</span>

<span class="k">const</span><span class="w"> </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">webdriver</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span>
<span class="w">  </span><span class="o">.</span><span class="n">forBrowser</span><span class="p">(</span><span class="s1">&#39;chrome&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="o">.</span><span class="n">withCapabilities</span><span class="p">(</span><span class="n">chromeCapabilities</span><span class="p">)</span>
<span class="w">  </span><span class="o">.</span><span class="n">build</span><span class="p">();</span>

<span class="o">//</span><span class="w"> </span><span class="n">Navigate</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">,</span><span class="w"> </span><span class="n">enter</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">search</span><span class="o">.</span>
<span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.google.com/&#39;</span><span class="p">);</span>
<span class="n">driver</span><span class="o">.</span><span class="n">findElement</span><span class="p">({</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;q&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">sendKeys</span><span class="p">(</span><span class="s1">&#39;webdriver&#39;</span><span class="p">);</span>
<span class="n">driver</span><span class="o">.</span><span class="n">findElement</span><span class="p">({</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;btnG&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">click</span><span class="p">();</span>
<span class="n">driver</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">webdriver</span><span class="o">.</span><span class="n">until</span><span class="o">.</span><span class="n">titleIs</span><span class="p">(</span><span class="s1">&#39;webdriver - Google Search&#39;</span><span class="p">),</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>

<span class="o">//</span><span class="w"> </span><span class="n">Take</span><span class="w"> </span><span class="n">screenshot</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">page</span><span class="o">.</span><span class="w"> </span><span class="n">Save</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">disk</span><span class="o">.</span>
<span class="n">driver</span><span class="o">.</span><span class="n">takeScreenshot</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">base64png</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fs</span><span class="o">.</span><span class="n">writeFileSync</span><span class="p">(</span><span class="s1">&#39;screenshot.png&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Buffer</span><span class="p">(</span><span class="n">base64png</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
<span class="p">});</span>

<span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">();</span>
</code></pre></div>

<h4>使用 WebDriverIO</h4>
<p><a href="http://webdriver.io/">WebDriverIO</a> 是一个在 Selenium WebDrive 上构建的更高层次的 API。</p>
<p>安装：</p>
<div class="highlight"><pre><span></span><code>yarn add webdriverio chromedriver
</code></pre></div>

<p>例子：过滤 chromestatus.com 上的 CSS 功能：</p>
<div class="highlight"><pre><span></span><code><span class="n">const</span> <span class="n">webdriverio</span> = <span class="k">require</span>(<span class="s">&#39;webdriverio&#39;</span>);
<span class="n">const</span> <span class="n">chromedriver</span> = <span class="k">require</span>(<span class="s">&#39;chromedriver&#39;</span>);

// <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">the</span> <span class="nb">path</span> <span class="nb">to</span> <span class="n">your</span> <span class="n">Canary</span> <span class="n">installation</span>.
// <span class="n">I&#39;m</span> <span class="nb">assuming</span> <span class="n">Mac</span> <span class="k">for</span> <span class="n">the</span> <span class="n">example</span>.
<span class="n">const</span> <span class="n">PATH_TO_CANARY</span> = <span class="s">&#39;/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary&#39;</span>;
<span class="n">const</span> <span class="n">PORT</span> = <span class="mi">9515</span>;

<span class="n">chromedriver</span>.<span class="nb">start</span>([
  <span class="s">&#39;--url-base=wd/hub&#39;</span>,
  `--<span class="n">port</span>=${<span class="n">PORT</span>}`,
  <span class="s">&#39;--verbose&#39;</span>
]);

(<span class="n">async</span> () =&gt; {

<span class="n">const</span> <span class="n">opts</span> = {
  <span class="n">port:</span> <span class="n">PORT</span>,
  <span class="n">desiredCapabilities:</span> {
    <span class="n">browserName:</span> <span class="s">&#39;chrome&#39;</span>,
    <span class="n">chromeOptions:</span> {
      <span class="n">binary:</span> <span class="n">PATH_TO_CANARY</span> // <span class="n">Screenshots</span> <span class="k">require</span> <span class="n">Chrome</span> <span class="mi">60</span>\. <span class="n">Force</span> <span class="n">Canary</span>.
      <span class="n">args:</span> [<span class="s">&#39;--headless&#39;</span>]
    }
  }
};

<span class="n">const</span> <span class="n">browser</span> = <span class="n">webdriverio</span>.<span class="n">remote</span>(<span class="n">opts</span>).<span class="n">init</span>();

<span class="nb">await</span> <span class="n">browser</span>.<span class="n">url</span>(<span class="s">&#39;https://www.chromestatus.com/features&#39;</span>);

<span class="n">const</span> <span class="n">title</span> = <span class="nb">await</span> <span class="n">browser</span>.<span class="n">getTitle</span>();
<span class="n">console</span>.<span class="nb">log</span>(`<span class="n">Title:</span> ${<span class="n">title</span>}`);

<span class="nb">await</span> <span class="n">browser</span>.<span class="n">waitForText</span>(<span class="s">&#39;.num-features&#39;</span>, <span class="mi">3000</span>);
<span class="k">let</span> <span class="n">numFeatures</span> = <span class="nb">await</span> <span class="n">browser</span>.<span class="n">getText</span>(<span class="s">&#39;.num-features&#39;</span>);
<span class="n">console</span>.<span class="nb">log</span>(`<span class="n">Chrome</span> <span class="k">has</span> ${<span class="n">numFeatures</span>} <span class="nb">total</span> <span class="n">features</span>`);

<span class="nb">await</span> <span class="n">browser</span>.<span class="n">setValue</span>(<span class="s">&#39;input[type=&quot;search&quot;]&#39;</span>, <span class="s">&#39;CSS&#39;</span>);
<span class="n">console</span>.<span class="nb">log</span>(<span class="s">&#39;Filtering features...&#39;</span>);
<span class="nb">await</span> <span class="n">browser</span>.<span class="n">pause</span>(<span class="mi">1000</span>);

<span class="n">numFeatures</span> = <span class="nb">await</span> <span class="n">browser</span>.<span class="n">getText</span>(<span class="s">&#39;.num-features&#39;</span>);
<span class="n">console</span>.<span class="nb">log</span>(`<span class="n">Chrome</span> <span class="k">has</span> ${<span class="n">numFeatures</span>} <span class="n">CSS</span> <span class="n">features</span>`);

<span class="n">const</span> <span class="n">buffer</span> = <span class="nb">await</span> <span class="n">browser</span>.<span class="n">saveScreenshot</span>(<span class="s">&#39;screenshot.png&#39;</span>);
<span class="n">console</span>.<span class="nb">log</span>(<span class="s">&#39;Saved screenshot...&#39;</span>);

<span class="n">chromedriver</span>.<span class="n">stop</span>();
<span class="n">browser</span>.<span class="nb">end</span>();

})();
</code></pre></div>

<h3>更多资源</h3>
<p>以下是一些可以带你入门的有用资源：</p>
<p>文档</p>
<ul>
<li><a href="https://chromedevtools.github.io/devtools-protocol/">DevTools Protocol Viewer</a> - API 参考文档</li>
</ul>
<p>工具</p>
<ul>
<li><a href="https://www.npmjs.com/package/chrome-remote-interface">chrome-remote-interface</a> - 基于 DevTools 协议的 node 模块</li>
<li><a href="https://github.com/GoogleChrome/lighthouse">Lighthouse</a> - 测试 Web 应用程序质量的自动化工具；大量使用了协议</li>
<li><a href="https://github.com/GoogleChrome/lighthouse/tree/master/chrome-launcher">chrome-launcher</a> - 用于启动 Chrome 的 node 模块，可以自动化</li>
</ul>
<p>样例</p>
<ul>
<li>"<a href="https://paul.kinlan.me/the-headless-web/">The Headless Web</a>" - Paul Kinlan 发布的使用了 Headless 和 api.ai 的精彩博客</li>
</ul>
<h3>常见问题</h3>
<p><strong>我需要 <code>--disable-gpu</code> 标志吗？</strong></p>
<p>目前是需要的。<code>--disable-gpu</code> 标志在处理一些 bug 时是需要的。在未来版本的 Chrome 中就不需要了。查看 <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=546953#c152">https://crbug.com/546953#c152</a> 和 <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=695212">https://crbug.com/695212</a> 获取更多信息。</p>
<p><strong>所以我仍然需要 Xvfb 吗？</strong></p>
<p>不。Headless Chrome 不使用窗口，所以不需要像 Xvfb 这样的显示服务器。没有它你也可以愉快地运行你的自动化测试。</p>
<p>什么是 Xvfb？Xvfb 是一个用于类 Unix 系统的运行于内存之内的显示服务器，可以让你运行图形应用程序（如 Chrome），而无需附加的物理显示器。许多人使用 Xvfb 运行早期版本的 Chrome 进行 “headless” 测试。</p>
<p><strong>如何创建一个运行 Headless Chrome 的 Docker 容器？</strong></p>
<p>查看 <a href="https://github.com/ebidel/lighthouse-ci">lighthouse-ci</a>。它有一个使用 Ubuntu 作为基础镜像的 <a href="https://github.com/ebidel/lighthouse-ci/blob/master/builder/Dockerfile.headless">Dockerfile 示例</a>，并且在 App Engine Flexible 容器中安装和运行了 Lighthouse。</p>
<p><strong>我可以把它和 Selenium / WebDriver / ChromeDriver 一起使用吗？</strong></p>
<p>是的。查看 <a href="https://developers.google.com/web/updates/2017/04/headless-chrome#drivers">Using Selenium, WebDrive, or ChromeDriver</a>。</p>
<p><strong>它和 PhantomJS 有什么关系？</strong></p>
<p>Headless Chrome 和 <a href="http://phantomjs.org/">PhantomJS</a> 是类似的工具。它们都可以用来在无需显示的环境中进行自动化测试。两者的主要不同在于 Phantom 使用了一个较老版本的 WebKit 作为它的渲染引擎，而 Headless Chrome 使用了最新版本的 Blink。</p>
<p>目前，Phantom 提供了比 <a href="https://chromedevtools.github.io/devtools-protocol/">DevTools protocol</a> 更高层次的 API。</p>
<p><strong>我在哪儿提交 bug？</strong></p>
<p>对于 Headless Chrome 的 bug，请提交到 <a href="https://bugs.chromium.org/p/chromium/issues/entry?components=Blink&amp;blocking=705916&amp;cc=skyostil%40chromium.org&amp;Proj=Headless">crbug.com</a>。</p>
<p>对于 DevTools 协议的 bug，请提交到 <a href="https://github.com/ChromeDevTools/devtools-protocol/issues/new">github.com/ChromeDevTools/devtools-protocol</a>。</p>
<p>via: <a href="https://developers.google.com/web/updates/2017/04/headless-chrome">https://developers.google.com/web/updates/2017/04/headless-chrome</a></p>
<p>作者：<a href="https://developers.google.com/web/resources/contributors#ericbidelman">Eric Bidelman</a> 译者：<a href="https://github.com/firmianay">firmianay</a> 校对：<a href="https://github.com/wxy">wxy</a></p>
<p>本文由 <a href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a href="https://linux.cn/">Linux中国</a> 荣誉推出</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>