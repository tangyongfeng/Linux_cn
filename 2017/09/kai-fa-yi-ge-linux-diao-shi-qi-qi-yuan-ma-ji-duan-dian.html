<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>开发一个 Linux 调试器（七）：源码级断点</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Simon Brand 在内存地址上设置断点虽然不错，但它并没有提供最方便用户的工具。我们希望能够在源代码行和函数入口地址 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li class="active"><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2017/09/kai-fa-yi-ge-linux-diao-shi-qi-qi-yuan-ma-ji-duan-dian.html" rel="bookmark"
           title="Permalink to 开发一个 Linux 调试器（七）：源码级断点">开发一个 Linux 调试器（七）：源码级断点</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-22T09:39:25+02:00">
                Published: Fri 22 September 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/ruan-jian-kai-fa">软件开发</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Simon Brand</p>
<p><img alt="" src="/data/attachment/album/201709/22/093850q8zlc89bpd1idpkc.jpg"></p>
<p>在内存地址上设置断点虽然不错，但它并没有提供最方便用户的工具。我们希望能够在源代码行和函数入口地址上设置断点，以便我们可以在与代码相同的抽象级别中进行调试。</p>
<p>这篇文章将会添加源码级断点到我们的调试器中。通过所有我们已经支持的功能，这要比起最初听起来容易得多。我们还将添加一个命令来获取符号的类型和地址，这对于定位代码或数据以及理解链接概念非常有用。</p>
<h3>系列索引</h3>
<p>随着后面文章的发布，这些链接会逐渐生效。</p>
<ol>
<li><a href="/article-8626-1.html">准备环境</a></li>
<li><a href="/article-8645-1.html">断点</a></li>
<li><a href="/article-8663-1.html">寄存器和内存</a></li>
<li><a href="/article-8719-1.html">Elves 和 dwarves</a></li>
<li><a href="/article-8812-1.html">源码和信号</a></li>
<li><a href="/article-8813-1.html">源码级逐步执行</a></li>
<li><a href="https://blog.tartanllama.xyz/c++/2017/06/19/writing-a-linux-debugger-source-break/">源码级断点</a></li>
<li><a href="https://blog.tartanllama.xyz/c++/2017/06/24/writing-a-linux-debugger-unwinding/">调用栈</a></li>
<li>读取变量</li>
<li>之后步骤</li>
</ol>
<h3>断点</h3>
<h4>DWARF</h4>
<p><a href="/article-8719-1.html">Elves 和 dwarves</a> 这篇文章，描述了 DWARF 调试信息是如何工作的，以及如何用它来将机器码映射到高层源码中。回想一下，DWARF 包含了函数的地址范围和一个允许你在抽象层之间转换代码位置的行表。我们将使用这些功能来实现我们的断点。</p>
<h4>函数入口</h4>
<p>如果你考虑重载、成员函数等等，那么在函数名上设置断点可能有点复杂，但是我们将遍历所有的编译单元，并搜索与我们正在寻找的名称匹配的函数。DWARF 信息如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;&lt;</span><span class="mh">0x0000000b</span><span class="o">&gt;</span><span class="w">  </span><span class="n">DW_TAG_compile_unit</span>
<span class="w">                    </span><span class="n">DW_AT_producer</span><span class="w">              </span><span class="n">clang</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mf">3.9</span><span class="o">.</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">tags</span><span class="o">/</span><span class="n">RELEASE_391</span><span class="o">/</span><span class="n">final</span><span class="p">)</span>
<span class="w">                    </span><span class="n">DW_AT_language</span><span class="w">              </span><span class="n">DW_LANG_C_plus_plus</span>
<span class="w">                    </span><span class="n">DW_AT_name</span><span class="w">                  </span><span class="o">/</span><span class="n">super</span><span class="o">/</span><span class="n">secret</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">MiniDbg</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">variable</span><span class="o">.</span><span class="n">cpp</span>
<span class="w">                    </span><span class="n">DW_AT_stmt_list</span><span class="w">             </span><span class="mh">0x00000000</span>
<span class="w">                    </span><span class="n">DW_AT_comp_dir</span><span class="w">              </span><span class="o">/</span><span class="n">super</span><span class="o">/</span><span class="n">secret</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">MiniDbg</span><span class="o">/</span><span class="n">build</span>
<span class="w">                    </span><span class="n">DW_AT_low_pc</span><span class="w">                </span><span class="mh">0x00400670</span>
<span class="w">                    </span><span class="n">DW_AT_high_pc</span><span class="w">               </span><span class="mh">0x0040069c</span>

<span class="n">LOCAL_SYMBOLS</span><span class="p">:</span>
<span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;&lt;</span><span class="mh">0x0000002e</span><span class="o">&gt;</span><span class="w">    </span><span class="n">DW_TAG_subprogram</span>
<span class="w">                      </span><span class="n">DW_AT_low_pc</span><span class="w">                </span><span class="mh">0x00400670</span>
<span class="w">                      </span><span class="n">DW_AT_high_pc</span><span class="w">               </span><span class="mh">0x0040069c</span>
<span class="w">                      </span><span class="n">DW_AT_name</span><span class="w">                  </span><span class="n">foo</span>
<span class="w">                      </span><span class="o">...</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="mi">14</span><span class="o">&gt;&lt;</span><span class="mh">0x000000b0</span><span class="o">&gt;</span><span class="w">    </span><span class="n">DW_TAG_subprogram</span>
<span class="w">                      </span><span class="n">DW_AT_low_pc</span><span class="w">                </span><span class="mh">0x00400700</span>
<span class="w">                      </span><span class="n">DW_AT_high_pc</span><span class="w">               </span><span class="mh">0x004007a0</span>
<span class="w">                      </span><span class="n">DW_AT_name</span><span class="w">                  </span><span class="n">bar</span>
<span class="w">                      </span><span class="o">...</span>
</code></pre></div>

<p>我们想要匹配 <code>DW_AT_name</code> 并使用 <code>DW_AT_low_pc</code>（函数的起始地址）来设置我们的断点。</p>
<div class="highlight"><pre><span></span><code><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">debugger</span><span class="p">::</span><span class="n">set_breakpoint_at_function</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cu</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">m_dwarf</span><span class="o">.</span><span class="n">compilation_units</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">die</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cu</span><span class="o">.</span><span class="n">root</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">die</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">dwarf</span><span class="p">::</span><span class="n">DW_AT</span><span class="p">::</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">at_name</span><span class="p">(</span><span class="n">die</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">auto</span><span class="w"> </span><span class="n">low_pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">at_low_pc</span><span class="p">(</span><span class="n">die</span><span class="p">);</span>
<span class="w">                </span><span class="n">auto</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_line_entry_from_pc</span><span class="p">(</span><span class="n">low_pc</span><span class="p">);</span>
<span class="w">                </span><span class="o">++</span><span class="n">entry</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="n">skip</span><span class="w"> </span><span class="n">prologue</span>
<span class="w">                </span><span class="n">set_breakpoint_at_address</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>这代码看起来有点奇怪的唯一一点是 <code>++entry</code>。 问题是函数的 <code>DW_AT_low_pc</code> 不指向该函数的用户代码的起始地址，它指向 prologue 的开始。编译器通常会输出一个函数的 prologue 和 epilogue，它们用于执行保存和恢复堆栈、操作堆栈指针等。这对我们来说不是很有用，所以我们将入口行加一来获取用户代码的第一行而不是 prologue。DWARF 行表实际上具有一些功能，用于将入口标记为函数 prologue 之后的第一行，但并不是所有编译器都输出它，因此我采用了原始的方法。</p>
<h4>源码行</h4>
<p>要在高层源码行上设置一个断点，我们要将这个行号转换成 DWARF 中的一个地址。我们将遍历编译单元，寻找一个名称与给定文件匹配的编译单元，然后查找与给定行对应的入口。</p>
<p>DWARF 看上去有点像这样：</p>
<div class="highlight"><pre><span></span><code><span class="nl">.debug_line:</span><span class="w"> </span><span class="nf">line</span><span class="w"> </span><span class="no">number</span><span class="w"> </span><span class="no">info</span><span class="w"> </span><span class="no">for</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">single</span><span class="w"> </span><span class="no">cu</span>
<span class="nf">Source</span><span class="w"> </span><span class="no">lines</span><span class="w"> </span><span class="p">(</span><span class="no">from</span><span class="w"> </span><span class="no">CU-DIE</span><span class="w"> </span><span class="no">at</span><span class="w"> </span><span class="no">.debug_info</span><span class="w"> </span><span class="no">offset</span><span class="w"> </span><span class="mi">0x0000000b</span><span class="p">):</span>

<span class="nf">NS</span><span class="w"> </span><span class="no">new</span><span class="w"> </span><span class="no">statement</span><span class="p">,</span><span class="w"> </span><span class="no">BB</span><span class="w"> </span><span class="no">new</span><span class="w"> </span><span class="no">basic</span><span class="w"> </span><span class="no">block</span><span class="p">,</span><span class="w"> </span><span class="no">ET</span><span class="w"> </span><span class="no">end</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">text</span><span class="w"> </span><span class="no">sequence</span>
<span class="nf">PE</span><span class="w"> </span><span class="no">prologue</span><span class="w"> </span><span class="no">end</span><span class="p">,</span><span class="w"> </span><span class="no">EB</span><span class="w"> </span><span class="no">epilogue</span><span class="w"> </span><span class="no">begin</span>
<span class="nf">IS</span><span class="err">=</span><span class="no">val</span><span class="w"> </span><span class="no">ISA</span><span class="w"> </span><span class="no">number</span><span class="p">,</span><span class="w"> </span><span class="no">DI</span><span class="err">=</span><span class="no">val</span><span class="w"> </span><span class="no">discriminator</span><span class="w"> </span><span class="no">value</span>
<span class="err">&lt;</span><span class="nf">pc</span><span class="err">&gt;</span><span class="w">        </span><span class="p">[</span><span class="no">lno</span><span class="p">,</span><span class="no">col</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span><span class="w"> </span><span class="no">BB</span><span class="w"> </span><span class="no">ET</span><span class="w"> </span><span class="no">PE</span><span class="w"> </span><span class="no">EB</span><span class="w"> </span><span class="no">IS</span><span class="err">=</span><span class="w"> </span><span class="no">DI</span><span class="err">=</span><span class="w"> </span><span class="no">uri</span><span class="p">:</span><span class="w"> </span><span class="err">&quot;</span><span class="no">filepath</span><span class="err">&quot;</span>
<span class="err">0</span><span class="nf">x004004a7</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span><span class="w"> </span><span class="no">uri</span><span class="p">:</span><span class="w"> </span><span class="err">&quot;/</span><span class="no">super</span><span class="err">/</span><span class="no">secret</span><span class="err">/</span><span class="no">path</span><span class="err">/</span><span class="no">a.hpp</span><span class="err">&quot;</span>
<span class="err">0</span><span class="nf">x004004ab</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004b2</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004b9</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004c1</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004c3</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span><span class="w"> </span><span class="no">uri</span><span class="p">:</span><span class="w"> </span><span class="err">&quot;/</span><span class="no">super</span><span class="err">/</span><span class="no">secret</span><span class="err">/</span><span class="no">path</span><span class="err">/</span><span class="no">b.hpp</span><span class="err">&quot;</span>
<span class="err">0</span><span class="nf">x004004c7</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004ce</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004d5</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004dd</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004df</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span><span class="w"> </span><span class="no">uri</span><span class="p">:</span><span class="w"> </span><span class="err">&quot;/</span><span class="no">super</span><span class="err">/</span><span class="no">secret</span><span class="err">/</span><span class="no">path</span><span class="err">/</span><span class="no">ab.cpp</span><span class="err">&quot;</span>
<span class="err">0</span><span class="nf">x004004e3</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004e8</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004ed</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span>
<span class="err">0</span><span class="nf">x004004f4</span><span class="w">  </span><span class="p">[</span><span class="w">   </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="no">NS</span><span class="w"> </span><span class="no">ET</span>
</code></pre></div>

<p>所以如果我们想要在 <code>ab.cpp</code> 的第五行设置一个断点，我们将查找与行 (<code>0x004004e3</code>) 相关的入口并设置一个断点。</p>
<div class="highlight"><pre><span></span><code><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">debugger</span><span class="p">::</span><span class="n">set_breakpoint_at_source_line</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cu</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">m_dwarf</span><span class="o">.</span><span class="n">compilation_units</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_suffix</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">at_name</span><span class="p">(</span><span class="n">cu</span><span class="o">.</span><span class="n">root</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cu</span><span class="o">.</span><span class="n">get_line_table</span><span class="p">();</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">lt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">is_stmt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry</span><span class="o">.</span><span class="n">line</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">set_breakpoint_at_address</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">address</span><span class="p">);</span>
<span class="w">                    </span><span class="k">return</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>我这里做了 <code>is_suffix</code> hack，这样你可以输入 <code>c.cpp</code> 代表 <code>a/b/c.cpp</code> 。当然你实际上应该使用大小写敏感路径处理库或者其它东西，但是我比较懒。<code>entry.is_stmt</code> 是检查行表入口是否被标记为一个语句的开头，这是由编译器根据它认为是断点的最佳目标的地址设置的。</p>
<h3>符号查找</h3>
<p>当我们在对象文件层时，符号是王者。函数用符号命名，全局变量用符号命名，你得到一个符号，我们得到一个符号，每个人都得到一个符号。 在给定的对象文件中，一些符号可能引用其他对象文件或共享库，链接器将从符号引用创建一个可执行程序。</p>
<p>可以在正确命名的符号表中查找符号，它存储在二进制文件的 ELF 部分中。幸运的是，<code>libelfin</code> 有一个不错的接口来做这件事，所以我们不需要自己处理所有的 ELF 的事情。为了让你知道我们在处理什么，下面是一个二进制文件的 <code>.symtab</code> 部分的转储，它由 <code>readelf</code> 生成：</p>
<div class="highlight"><pre><span></span><code><span class="n">Num</span><span class="o">:</span><span class="w">    </span><span class="n">Value</span><span class="w">          </span><span class="n">Size</span><span class="w"> </span><span class="n">Type</span><span class="w">    </span><span class="n">Bind</span><span class="w">   </span><span class="n">Vis</span><span class="w">      </span><span class="n">Ndx</span><span class="w"> </span><span class="n">Name</span>
<span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">UND</span>
<span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400238</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">1</span>
<span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400254</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">2</span>
<span class="w"> </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400278</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">3</span>
<span class="w"> </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="mi">00000000004002</span><span class="n">c8</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">4</span>
<span class="w"> </span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400430</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">5</span>
<span class="w"> </span><span class="mi">6</span><span class="o">:</span><span class="w"> </span><span class="mi">00000000004004</span><span class="n">e4</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">6</span>
<span class="w"> </span><span class="mi">7</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400508</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">7</span>
<span class="w"> </span><span class="mi">8</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400528</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">8</span>
<span class="w"> </span><span class="mi">9</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400558</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">9</span>
<span class="mi">10</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400570</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span>
<span class="mi">11</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400714</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">11</span>
<span class="mi">12</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400720</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">12</span>
<span class="mi">13</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400724</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">13</span>
<span class="mi">14</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400750</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">14</span>
<span class="mi">15</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e18</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">15</span>
<span class="mi">16</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e20</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">16</span>
<span class="mi">17</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e28</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">17</span>
<span class="mi">18</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e30</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">18</span>
<span class="mi">19</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">ff0</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">19</span>
<span class="mi">20</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">20</span>
<span class="mi">21</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601018</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">21</span>
<span class="mi">22</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601028</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">22</span>
<span class="mi">23</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">23</span>
<span class="mi">24</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">24</span>
<span class="mi">25</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">25</span>
<span class="mi">26</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">26</span>
<span class="mi">27</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">27</span>
<span class="mi">28</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">28</span>
<span class="mi">29</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">29</span>
<span class="mi">30</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">SECTION</span><span class="w"> </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">30</span>
<span class="mi">31</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FILE</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">ABS</span><span class="w"> </span><span class="n">init</span><span class="o">.</span><span class="na">c</span>
<span class="mi">32</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FILE</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">ABS</span><span class="w"> </span><span class="n">crtstuff</span><span class="o">.</span><span class="na">c</span>
<span class="mi">33</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e28</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">17</span><span class="w"> </span><span class="n">__JCR_LIST__</span>
<span class="mi">34</span><span class="o">:</span><span class="w"> </span><span class="mi">00000000004005</span><span class="n">a0</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">deregister_tm_clones</span>
<span class="mi">35</span><span class="o">:</span><span class="w"> </span><span class="mi">00000000004005</span><span class="n">e0</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">register_tm_clones</span>
<span class="mi">36</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400620</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">__do_global_dtors_aux</span>
<span class="mi">37</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601028</span><span class="w">     </span><span class="mi">1</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">22</span><span class="w"> </span><span class="n">completed</span><span class="o">.</span><span class="mi">6917</span>
<span class="mi">38</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e20</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">16</span><span class="w"> </span><span class="n">__do_global_dtors_aux_fin</span>
<span class="mi">39</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400640</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">frame_dummy</span>
<span class="mi">40</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e18</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">15</span><span class="w"> </span><span class="n">__frame_dummy_init_array_</span>
<span class="mi">41</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FILE</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">ABS</span><span class="w"> </span><span class="sr">/super/secret/path/MiniDbg/</span>
<span class="mi">42</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FILE</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">ABS</span><span class="w"> </span><span class="n">crtstuff</span><span class="o">.</span><span class="na">c</span>
<span class="mi">43</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400818</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">14</span><span class="w"> </span><span class="n">__FRAME_END__</span>
<span class="mi">44</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e28</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">17</span><span class="w"> </span><span class="n">__JCR_END__</span>
<span class="mi">45</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FILE</span><span class="w">    </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">ABS</span>
<span class="mi">46</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400724</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">13</span><span class="w"> </span><span class="n">__GNU_EH_FRAME_HDR</span>
<span class="mi">47</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">20</span><span class="w"> </span><span class="n">_GLOBAL_OFFSET_TABLE_</span>
<span class="mi">48</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601028</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">21</span><span class="w"> </span><span class="n">__TMC_END__</span>
<span class="mi">49</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601020</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">21</span><span class="w"> </span><span class="n">__dso_handle</span>
<span class="mi">50</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e20</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">15</span><span class="w"> </span><span class="n">__init_array_end</span>
<span class="mi">51</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e18</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">15</span><span class="w"> </span><span class="n">__init_array_start</span>
<span class="mi">52</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000600</span><span class="n">e30</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">LOCAL</span><span class="w">  </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">18</span><span class="w"> </span><span class="n">_DYNAMIC</span>
<span class="mi">53</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601018</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">WEAK</span><span class="w">   </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">21</span><span class="w"> </span><span class="n">data_start</span>
<span class="mi">54</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400710</span><span class="w">     </span><span class="mi">2</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">__libc_csu_fini</span>
<span class="mi">55</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400570</span><span class="w">    </span><span class="mi">43</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">_start</span>
<span class="mi">56</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">WEAK</span><span class="w">   </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">UND</span><span class="w"> </span><span class="n">__gmon_start__</span>
<span class="mi">57</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400714</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">11</span><span class="w"> </span><span class="n">_fini</span>
<span class="mi">58</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">  </span><span class="n">UND</span><span class="w"> </span><span class="n">__libc_start_main</span><span class="err">@@</span><span class="n">GLIBC_</span>
<span class="mi">59</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400720</span><span class="w">     </span><span class="mi">4</span><span class="w"> </span><span class="n">OBJECT</span><span class="w">  </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">12</span><span class="w"> </span><span class="n">_IO_stdin_used</span>
<span class="mi">60</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601018</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">21</span><span class="w"> </span><span class="n">__data_start</span>
<span class="mi">61</span><span class="o">:</span><span class="w"> </span><span class="mi">00000000004006</span><span class="n">a0</span><span class="w">   </span><span class="mi">101</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">__libc_csu_init</span>
<span class="mi">62</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601028</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">22</span><span class="w"> </span><span class="n">__bss_start</span>
<span class="mi">63</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601030</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">22</span><span class="w"> </span><span class="n">_end</span>
<span class="mi">64</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000601028</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">NOTYPE</span><span class="w">  </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">21</span><span class="w"> </span><span class="n">_edata</span>
<span class="mi">65</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400670</span><span class="w">    </span><span class="mi">44</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">   </span><span class="mi">10</span><span class="w"> </span><span class="n">main</span>
<span class="mi">66</span><span class="o">:</span><span class="w"> </span><span class="mi">0000000000400558</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">FUNC</span><span class="w">    </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w">    </span><span class="mi">9</span><span class="w"> </span><span class="n">_init</span>
</code></pre></div>

<p>你可以在对象文件中看到用于设置环境的很多符号，最后还可以看到 <code>main</code> 符号。</p>
<p>我们对符号的类型、名称和值（地址）感兴趣。我们有一个该类型的 <code>symbol_type</code> 枚举，并使用一个 <code>std::string</code> 作为名称，<code>std::uintptr_t</code> 作为地址：</p>
<div class="highlight"><pre><span></span><code><span class="nx">enum</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">symbol_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">notype</span><span class="p">,</span><span class="w">            </span><span class="c1">// No type (e.g., absolute symbol)</span>
<span class="w">    </span><span class="nx">object</span><span class="p">,</span><span class="w">            </span><span class="c1">// Data object</span>
<span class="w">    </span><span class="nx">func</span><span class="p">,</span><span class="w">              </span><span class="c1">// Function entry point</span>
<span class="w">    </span><span class="nx">section</span><span class="p">,</span><span class="w">           </span><span class="c1">// Symbol is associated with a section</span>
<span class="w">    </span><span class="nx">file</span><span class="p">,</span><span class="w">              </span><span class="c1">// Source file associated with the</span>
<span class="p">};</span><span class="w">                     </span><span class="c1">// object file</span>

<span class="nx">std</span><span class="o">::</span><span class="kt">string</span><span class="w"> </span><span class="nx">to_string</span><span class="w"> </span><span class="p">(</span><span class="nx">symbol_type</span><span class="w"> </span><span class="nx">st</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">st</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">notype</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;notype&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">object</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;object&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">func</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;func&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">section</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;section&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">file</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;file&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">struct</span><span class="w"> </span><span class="nx">symbol</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">symbol_type</span><span class="w"> </span><span class="k">type</span><span class="p">;</span>
<span class="w">    </span><span class="nx">std</span><span class="o">::</span><span class="kt">string</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">    </span><span class="nx">std</span><span class="o">::</span><span class="nx">uintptr_t</span><span class="w"> </span><span class="kd">addr</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p>我们需要将从 <code>libelfin</code> 获得的符号类型映射到我们的枚举，因为我们不希望依赖关系破环这个接口。幸运的是，我为所有的东西选了同样的名字，所以这样很简单：</p>
<div class="highlight"><pre><span></span><code><span class="nx">symbol_type</span><span class="w"> </span><span class="nx">to_symbol_type</span><span class="p">(</span><span class="nx">elf</span><span class="o">::</span><span class="nx">stt</span><span class="w"> </span><span class="nx">sym</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">sym</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">elf</span><span class="o">::</span><span class="nx">stt</span><span class="o">::</span><span class="nx">notype</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">notype</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">elf</span><span class="o">::</span><span class="nx">stt</span><span class="o">::</span><span class="nx">object</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">object</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">elf</span><span class="o">::</span><span class="nx">stt</span><span class="o">::</span><span class="nx">func</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">func</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">elf</span><span class="o">::</span><span class="nx">stt</span><span class="o">::</span><span class="nx">section</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">section</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">elf</span><span class="o">::</span><span class="nx">stt</span><span class="o">::</span><span class="nx">file</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">file</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">symbol_type</span><span class="o">::</span><span class="nx">notype</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>最后我们要查找符号。为了说明的目的，我循环查找符号表的 ELF 部分，然后收集我在其中找到的任意符号到 <code>std::vector</code> 中。更智能的实现可以建立从名称到符号的映射，这样你只需要查看一次数据就行了。</p>
<div class="highlight"><pre><span></span><code><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">symbol</span><span class="o">&gt;</span><span class="w"> </span><span class="n">debugger</span><span class="p">::</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">symbol</span><span class="o">&gt;</span><span class="w"> </span><span class="n">syms</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sec</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">m_elf</span><span class="o">.</span><span class="n">sections</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">get_hdr</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">elf</span><span class="p">::</span><span class="n">sht</span><span class="p">::</span><span class="n">symtab</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="n">get_hdr</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">elf</span><span class="p">::</span><span class="n">sht</span><span class="p">::</span><span class="n">dynsym</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">auto</span><span class="w"> </span><span class="n">sym</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">sec</span><span class="o">.</span><span class="n">as_symtab</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sym</span><span class="o">.</span><span class="n">get_data</span><span class="p">();</span>
<span class="w">                </span><span class="n">syms</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">symbol</span><span class="p">{</span><span class="n">to_symbol_type</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">()),</span><span class="w"> </span><span class="n">sym</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span><span class="w"> </span><span class="n">d</span><span class="o">.</span><span class="n">value</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">syms</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3>添加命令</h3>
<p>一如往常，我们需要添加一些更多的命令来向用户暴露功能。对于断点，我使用 GDB 风格的接口，其中断点类型是通过你传递的参数推断的，而不用要求显式切换：</p>
<ul>
<li><code>0x&lt;hexadecimal&gt;</code> -&gt; 断点地址</li>
<li><code>&lt;line&gt;:&lt;filename&gt;</code> -&gt; 断点行号</li>
<li><code>&lt;anything else&gt;</code> -&gt; 断点函数名</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">is_prefix</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;break&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;x&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">std</span><span class="o">::</span><span class="kt">string</span><span class="w"> </span><span class="kd">addr</span><span class="w"> </span><span class="p">{</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>
<span class="w">            </span><span class="nx">set_breakpoint_at_address</span><span class="p">(</span><span class="nx">std</span><span class="o">::</span><span class="nx">stol</span><span class="p">(</span><span class="kd">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">find</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">std</span><span class="o">::</span><span class="kt">string</span><span class="o">::</span><span class="nx">npos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">auto</span><span class="w"> </span><span class="nx">file_and_line</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">split</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">set_breakpoint_at_source_line</span><span class="p">(</span><span class="nx">file_and_line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nx">std</span><span class="o">::</span><span class="nx">stoi</span><span class="p">(</span><span class="nx">file_and_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">set_breakpoint_at_function</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>对于符号，我们将查找符号并打印出我们发现的任何匹配项：</p>
<div class="highlight"><pre><span></span><code><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">is_prefix</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;symbol&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">auto</span><span class="w"> </span><span class="nx">syms</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">lookup_symbol</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">auto</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">syms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">std</span><span class="o">::</span><span class="nx">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">to_string</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; 0x&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">std</span><span class="o">::</span><span class="nx">hex</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="kd">addr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="nx">std</span><span class="o">::</span><span class="nx">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>测试一下</h3>
<p>在一个简单的二进制文件上启动调试器，并设置源代码级别的断点。在一些 <code>foo</code> 函数上设置一个断点，看到我的调试器停在它上面是我这个项目最有价值的时刻之一。</p>
<p>符号查找可以通过在程序中添加一些函数或全局变量并查找它们的名称来进行测试。请注意，如果你正在编译 C++ 代码，你还需要考虑<a href="https://en.wikipedia.org/wiki/Name_mangling#C.2B.2B">名称重整</a>。</p>
<p>本文就这些了。下一次我将展示如何向调试器添加堆栈展开支持。</p>
<p>你可以在<a href="https://github.com/TartanLlama/minidbg/tree/tut_source_break">这里</a>找到这篇文章的代码。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>