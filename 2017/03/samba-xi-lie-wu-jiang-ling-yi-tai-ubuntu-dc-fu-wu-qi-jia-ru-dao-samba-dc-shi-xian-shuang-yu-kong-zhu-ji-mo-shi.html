<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Samba 系列（五）：将另一台 Ubuntu DC 服务器加入到 Samba DC 实现双域控主机模式</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Author: Ravi Saive 这篇文章将讲解如何使用 Ubuntu 16.04 服务器版系统来创建第二台 Samba4 域控制器，并将其加入到已创建好的 Samba AD DC 林环 …" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">linux_cn</a></h1>
                <nav><ul>
                    <li><a href="/category/chuan-shan-jia-zhuan-fang">穿山甲专访</a></li>
                    <li><a href="/category/dai-ma-ying-xiong">代码英雄</a></li>
                    <li><a href="/category/fen-xiang">分享</a></li>
                    <li><a href="/category/guan-dian">观点</a></li>
                    <li><a href="/category/huo-dong">活动</a></li>
                    <li><a href="/category/ji-ke-man-hua">极客漫画</a></li>
                    <li><a href="/category/ji-zhu">技术</a></li>
                    <li><a href="/category/kai-yuan-zhi-hui">开源智慧</a></li>
                    <li><a href="/category/linux-fa-xing-ban">Linux 发行版</a></li>
                    <li><a href="/category/mei-ri-an-quan-zi-xun">每日安全资讯</a></li>
                    <li><a href="/category/misc">Misc</a></li>
                    <li><a href="/category/qu-kuai-lian">区块链</a></li>
                    <li><a href="/category/rong-qi-yu-yun">容器与云</a></li>
                    <li><a href="/category/ruan-jian-kai-fa">软件开发</a></li>
                    <li><a href="/category/shu-mei-pai">树莓派</a></li>
                    <li class="active"><a href="/category/xi-tong-yun-wei">系统运维</a></li>
                    <li><a href="/category/xin-wen">新闻</a></li>
                    <li><a href="/category/ying-he-guan-cha">硬核观察</a></li>
                    <li><a href="/category/zhi-ye-sheng-ya">职业生涯</a></li>
                    <li><a href="/category/zhong-jiang-ming-dan">中奖名单</a></li>
                    <li><a href="/category/zhuo-mian-ying-yong">桌面应用</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/2017/03/samba-xi-lie-wu-jiang-ling-yi-tai-ubuntu-dc-fu-wu-qi-jia-ru-dao-samba-dc-shi-xian-shuang-yu-kong-zhu-ji-mo-shi.html" rel="bookmark"
           title="Permalink to Samba 系列（五）：将另一台 Ubuntu DC 服务器加入到 Samba DC 实现双域控主机模式">Samba 系列（五）：将另一台 Ubuntu DC 服务器加入到 Samba DC 实现双域控主机模式</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-31T09:28:00+02:00">
                Published: Fri 31 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/linux-fans-from-china.html">linux fans from china</a>
        </address>
<p>In <a href="/category/xi-tong-yun-wei">系统运维</a>.</p>

</footer><!-- /.post-info -->      <p>Author: Ravi Saive</p>
<p>这篇文章将讲解如何使用 <strong>Ubuntu 16.04</strong> 服务器版系统来创建第二台 <strong>Samba4</strong> 域控制器，并将其加入到已创建好的 <strong>Samba AD DC</strong> 林环境中，以便为一些关键的 AD DC 服务提供负载均衡及故障切换功能，尤其是为那些重要的服务，比如 DNS 服务和使用 SAM 数据库的 AD DC LDAP 模式。</p>
<p><img alt="" src="/data/attachment/album/201703/31/092100ye4goo4v1c1zefoe.jpg"></p>
<h3>需求</h3>
<p>这篇文章是 <strong>Samba4 AD DC</strong> 系列的第<strong>五</strong>篇，前边几篇如下：</p>
<p>1、<a href="/article-8065-1.html">在 Ubuntu 系统上使用 Samba4 来创建活动目录架构</a></p>
<p>2、<a href="/article-8070-1.html">在 Linux 命令行下管理 Samba4 AD 架构</a></p>
<p>3、<a href="/article-8097-1.html">使用 Windows 10 的 RSAT 工具来管理 Samba4 活动目录架构</a></p>
<p>4、<a href="/article-8258-1.html">在 Windows 下管理 Samba4 AD 域管制器 DNS 和组策略</a></p>
<h3>第一步：为设置 Samba4 进行初始化配置</h3>
<p>1、在开始把第二个 DC 服务器加入到 <strong>Samba4 AD DC</strong> 域环境之前，你需要注意一些初始化设置信息，首先，确保这个新系统的<strong>主机名</strong>包含描述性名称。</p>
<p>假设第一个域服务器的主机名叫做 <code>adc1</code> ，你可以把第二个域服务器命名为 <code>adc2</code>，以保持域控制器名称的一致性。</p>
<p>执行下面的命令来修改系统<strong>主机名</strong>：</p>
<div class="highlight"><pre><span></span><code># hostnamectl set-hostname adc2
</code></pre></div>

<p>或者你也可以手动编辑 <code>/etc/hostname</code> 文件，在新的一行输入你想设置的主机名。</p>
<div class="highlight"><pre><span></span><code># nano /etc/hostname
</code></pre></div>

<p>这里添加主机名。</p>
<div class="highlight"><pre><span></span><code>adc2
</code></pre></div>

<p>2、下一步，打开本地系统解析文件并添加一个条目，包含主域控制器的 IP 地址和 FQDN 名称。如下图所示：</p>
<p>在这篇教程中，主域控服务器的主机名为 <code>adc1.tecmint.lan</code> ，其对应的 IP 地址为 192.168.1.254 。</p>
<div class="highlight"><pre><span></span><code># nano /etc/hosts
</code></pre></div>

<p>添加如下行：</p>
<div class="highlight"><pre><span></span><code>IP_of_main_DC       FQDN_of_main_DC     short_name_of_main_DC
</code></pre></div>

<p><img alt="Set Hostname for Samba4 AD DC" src="/data/attachment/album/201703/31/092902lb7wwtt1f22fq2bl.jpg"></p>
<p><em>为 Samba4 AD DC 服务器设置主机名</em></p>
<p>3、下一步，打开 <code>/etc/network/interfaces</code> 配置文件并设置一个静态 IP 地址，如下图所示：</p>
<p>注意 <code>dns-nameservers</code> 和 <code>dns-search</code> 这两个参数的值。为了使 DNS 解析正常工作，需要把这两个值设置成主 Samba4 AD DC 服务器的 IP 地址和域名。</p>
<p>重启网卡服务以让修改的配置生效。检查 <code>/etc/resolv.conf</code> 文件，确保该网卡上配置的这两个 DNS 的值已更新到这个文件。</p>
<div class="highlight"><pre><span></span><code># nano /etc/network/interfaces
</code></pre></div>

<p>编辑并替换你自定义的 IP 设置：</p>
<div class="highlight"><pre><span></span><code><span class="kt">auto</span><span class="w"> </span><span class="nx">ens33</span>
<span class="nx">iface</span><span class="w"> </span><span class="nx">ens33</span><span class="w"> </span><span class="nx">inet</span><span class="w"> </span><span class="nx">static</span>
<span class="nx">address</span><span class="w"> </span><span class="m m-Double">192.168.1.253</span>
<span class="nx">netmask</span><span class="w"> </span><span class="m m-Double">255.255.255.0</span>
<span class="nx">brodcast</span><span class="w"> </span><span class="m m-Double">192.168.1.1</span>
<span class="nx">gateway</span><span class="w"> </span><span class="m m-Double">192.168.1.1</span>
<span class="nx">dns</span><span class="o">-</span><span class="nx">nameservers</span><span class="w"> </span><span class="m m-Double">192.168.1.254</span>
<span class="nx">dns</span><span class="o">-</span><span class="nx">search</span><span class="w"> </span><span class="nx">tecmint</span><span class="p">.</span><span class="nx">lan</span>
</code></pre></div>

<p>重启网卡服务并确认生效。</p>
<div class="highlight"><pre><span></span><code># systemctl restart networking.service
# cat /etc/resolv.conf
</code></pre></div>

<p><img alt="Configure DNS for Samba4 AD" src="/data/attachment/album/201703/31/092902r1xrlkgyax5ilony.jpg"></p>
<p><em>配置 Samba4 AD 服务器的 DNS</em></p>
<p>当你通过简写名称（用于构建 FQDN 名）查询主机名时， <code>dns-search</code> 值将会自动把域名添加上。</p>
<p>4、为了测试 DNS 解析是否正常，使用一系列 ping 命令测试，命令后分别为简写名， FQDN 名和域名，如下图所示：</p>
<p>在所有测试用例中，<strong>Samba4 AD DC DNS</strong> 服务器都应该返回主域控服务器的 IP 地址。</p>
<p><img alt="Verify DNS Resolution for Samba4 AD" src="/data/attachment/album/201703/31/092903ssewwslzosezosl1.png"></p>
<p><em>验证 Samba4 AD 环境 DNS 解析是否正常</em></p>
<p>5、最后你需要注意的是确保这个主机跟域控服务器时间同步。你可以通过下面的命令在系统上安装 <strong>NTP</strong> 客户端工具来实现时间同步功能：</p>
<div class="highlight"><pre><span></span><code># apt-get install ntpdate
</code></pre></div>

<p>6、假设你想手动强制本地服务器与 <strong>samba4 AD DC</strong> 服务器时间同步，使用 <code>ntpdate</code> 命令加上主域控服务器的主机名，如下所示：</p>
<div class="highlight"><pre><span></span><code># ntpdate adc1
</code></pre></div>

<p><img alt="Time Synchronize with Samba4 AD" src="/data/attachment/album/201703/31/092903dgozw96s8koy8swo.png"></p>
<p><em>与 Samba4 AD 服务器进行时间同步</em></p>
<h3>第 2 步：安装 Samba4 必须的依赖包</h3>
<p>7、为了让 <strong>Ubuntu 16.04</strong> 系统加入到你的域中，你需要通过下面的命令从 Ubuntu 官方软件库中安装 <strong>Samba4 套件、 Kerberos 客户端</strong> 和其它一些重要的软件包以便将来使用：</p>
<div class="highlight"><pre><span></span><code># apt-get install samba krb5-user krb5-config winbind libpam-winbind libnss-winbind
</code></pre></div>

<p><img alt="Install Samba4 in Ubuntu" src="/data/attachment/album/201703/31/092904zefchqcdhhreffhz.png"></p>
<p><em>在 Ubuntu 系统中安装 Samba4</em></p>
<p>8、在安装的过程中，你需要提供 Kerberos 域名。输入大写的域名然后按回车键完成安装过程。</p>
<p><img alt="Configure Kerberos Authentication for Samba4" src="/data/attachment/album/201703/31/092904wexmmieeey2eeq4n.png"></p>
<p><em>为 Samba4 配置 Kerberos 认证</em></p>
<p>9、所有依赖包安装完成后，通过使用 <code>kinit</code> 命令为域管理员请求一个 Kerberos 票据以验证设置是否正确。使用 <code>klist</code> 命令来列出已授权的 kerberos 票据信息。</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">kinit</span><span class="w"> </span><span class="k">domain</span><span class="o">-</span><span class="k">admin</span><span class="o">-</span><span class="k">user</span><span class="nv">@YOUR_DOMAIN</span><span class="p">.</span><span class="n">TLD</span>
<span class="err">#</span><span class="w"> </span><span class="n">klist</span>
</code></pre></div>

<p><img alt="Verify Kerberos on Samba4 Domain" src="/data/attachment/album/201703/31/092904wvwt33urc1ss3gwt.png"></p>
<p><em>在 Samba4 域环境中验证 Kerberos</em></p>
<h3>第 3 步：以域控制器的身份加入到 Samba4 AD DC</h3>
<p>10、在把你的机器集成到 <strong>Samba4 DC</strong> 环境之前，先把系统中所有运行着的 Samba4 服务停止，并且重命名默认的 Samba 配置文件以便从头开始。在域控制器配置的过程中， Samba 将会创建一个新的配置文件。</p>
<div class="highlight"><pre><span></span><code># systemctl stop samba-ad-dc smbd nmbd winbind
# mv /etc/samba/smb.conf /etc/samba/smb.conf.initial
</code></pre></div>

<p>11、在准备加入域前，先启动 <strong>samba-ad-dc</strong> 服务，之后使用域管理员账号运行 <code>samba-tool</code> 命令将服务器加入到域。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># samba-tool domain join your_domain -U &quot;your_domain_admin&quot;</span>
</code></pre></div>

<p>加入域过程部分截图:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># samba-tool domain join tecmint.lan DC -U &quot;tecmint_user&quot;</span>
</code></pre></div>

<p>输出示例：</p>
<div class="highlight"><pre><span></span><code><span class="n">Finding</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">writeable</span><span class="w"> </span><span class="n">DC</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="s1">&#39;tecmint.lan&#39;</span>
<span class="n">Found</span><span class="w"> </span><span class="n">DC</span><span class="w"> </span><span class="n">adc1</span><span class="o">.</span><span class="n">tecmint</span><span class="o">.</span><span class="n">lan</span>
<span class="n">Password</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">WORKGROUP</span>\<span class="n">tecmint_user</span><span class="p">]:</span>
<span class="n">workgroup</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">TECMINT</span>
<span class="n">realm</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">tecmint</span><span class="o">.</span><span class="n">lan</span>
<span class="n">checking</span><span class="w"> </span><span class="n">sAMAccountName</span>
<span class="n">Deleted</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">ADC2</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Computers</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Adding</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">ADC2</span><span class="p">,</span><span class="n">OU</span><span class="o">=</span><span class="n">Domain</span><span class="w"> </span><span class="n">Controllers</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Adding</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">ADC2</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Servers</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Sites</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Adding</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">NTDS</span><span class="w"> </span><span class="n">Settings</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">ADC2</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Servers</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Default</span><span class="o">-</span><span class="n">First</span><span class="o">-</span><span class="n">Site</span><span class="o">-</span><span class="n">Name</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Sites</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Adding</span><span class="w"> </span><span class="n">SPNs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">CN</span><span class="o">=</span><span class="n">ADC2</span><span class="p">,</span><span class="n">OU</span><span class="o">=</span><span class="n">Domain</span><span class="w"> </span><span class="n">Controllers</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ADC2</span><span class="o">$</span>
<span class="n">Enabling</span><span class="w"> </span><span class="n">account</span>
<span class="n">Calling</span><span class="w"> </span><span class="n">bare</span><span class="w"> </span><span class="n">provision</span>
<span class="n">Looking</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">IPv4</span><span class="w"> </span><span class="n">addresses</span>
<span class="n">Looking</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">IPv6</span><span class="w"> </span><span class="n">addresses</span>
<span class="n">No</span><span class="w"> </span><span class="n">IPv6</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">assigned</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">share</span><span class="o">.</span><span class="n">ldb</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="n">ldb</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">registry</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">privileges</span><span class="w"> </span><span class="n">database</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">idmap</span><span class="w"> </span><span class="n">db</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">SAM</span><span class="w"> </span><span class="n">db</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">sam</span><span class="o">.</span><span class="n">ldb</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">settings</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">sam</span><span class="o">.</span><span class="n">ldb</span><span class="w"> </span><span class="n">rootDSE</span>
<span class="n">Pre</span><span class="o">-</span><span class="n">loading</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Samba</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">AD</span><span class="w"> </span><span class="n">schema</span>
<span class="n">A</span><span class="w"> </span><span class="n">Kerberos</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">suitable</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Samba</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">samba</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">krb5</span><span class="o">.</span><span class="n">conf</span>
<span class="n">Provision</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="n">DN</span><span class="w"> </span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Starting</span><span class="w"> </span><span class="n">replication</span>
<span class="n">Schema</span><span class="o">-</span><span class="n">DN</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">402</span><span class="o">/</span><span class="mi">1550</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Schema</span><span class="o">-</span><span class="n">DN</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">804</span><span class="o">/</span><span class="mi">1550</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Schema</span><span class="o">-</span><span class="n">DN</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">1206</span><span class="o">/</span><span class="mi">1550</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Schema</span><span class="o">-</span><span class="n">DN</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">1550</span><span class="o">/</span><span class="mi">1550</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Analyze</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="n">objects</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">402</span><span class="o">/</span><span class="mi">1614</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">804</span><span class="o">/</span><span class="mi">1614</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">1206</span><span class="o">/</span><span class="mi">1614</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">1608</span><span class="o">/</span><span class="mi">1614</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">CN</span><span class="o">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">1614</span><span class="o">/</span><span class="mi">1614</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">28</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Replicating</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">objects</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="n">DN</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">domain</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">97</span><span class="o">/</span><span class="mi">97</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">24</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">380</span><span class="o">/</span><span class="mi">283</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">27</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Done</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">always</span><span class="w"> </span><span class="n">replicated</span><span class="w"> </span><span class="n">NC</span><span class="w"> </span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">schema</span><span class="p">)</span>
<span class="n">Replicating</span><span class="w"> </span><span class="n">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">45</span><span class="o">/</span><span class="mi">45</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Replicating</span><span class="w"> </span><span class="n">DC</span><span class="o">=</span><span class="n">ForestDnsZones</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span>
<span class="n">Partition</span><span class="p">[</span><span class="n">DC</span><span class="o">=</span><span class="n">ForestDnsZones</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">tecmint</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">lan</span><span class="p">]</span><span class="w"> </span><span class="n">objects</span><span class="p">[</span><span class="mi">18</span><span class="o">/</span><span class="mi">18</span><span class="p">]</span><span class="w"> </span><span class="n">linked_values</span><span class="p">[</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Committing</span><span class="w"> </span><span class="n">SAM</span><span class="w"> </span><span class="n">database</span>
<span class="n">Sending</span><span class="w"> </span><span class="n">DsReplicaUpdateRefs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">replicated</span><span class="w"> </span><span class="n">partitions</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">isSynchronized</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">dsServiceName</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">secrets</span><span class="w"> </span><span class="n">database</span>
<span class="n">Joined</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="n">TECMINT</span><span class="w"> </span><span class="p">(</span><span class="n">SID</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">715537322</span><span class="o">-</span><span class="mi">3397311598</span><span class="o">-</span><span class="mi">55032968</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">DC</span>
</code></pre></div>

<p><img alt="Join Domain to Samba4 AD DC" src="/data/attachment/album/201703/31/092907a7nbjl8eenlp8e5b.png"></p>
<p><em>把域加入到 Samba4 AD DC</em></p>
<p>12、在已安装了 Samba4 套件的 Ubuntu 系统加入域之后，打开 Samba 主配置文件添加如下行：</p>
<div class="highlight"><pre><span></span><code># nano /etc/samba/smb.conf
</code></pre></div>

<p>添加以下内容到 <code>smb.conf</code> 配置文件中。</p>
<div class="highlight"><pre><span></span><code><span class="n">dns</span><span class="w"> </span><span class="n">forwarder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span>
<span class="n">idmap_ldb</span><span class="p">:</span><span class="n">use</span><span class="w"> </span><span class="n">rfc2307</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="n">template</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">winbind</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
<span class="n">winbind</span><span class="w"> </span><span class="n">offline</span><span class="w"> </span><span class="n">logon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span>
<span class="n">winbind</span><span class="w"> </span><span class="n">nss</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rfc2307</span>
<span class="n">winbind</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
<span class="n">winbind</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span>
</code></pre></div>

<p>使用你自己的 <strong>DNS 转发器 IP</strong> 地址替换掉上面 <code>dns forwarder</code> 地址。 Samba 将会把域权威区之外的所有 DNS 解析查询转发到这个 IP 地址。</p>
<p>13、最后，重启 samba 服务以使修改的配置生效，然后执行如下命令来检查活动目录复制功能是否正常。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># systemctl restart samba-ad-dc</span>
<span class="c1"># samba-tool drs showrepl</span>
</code></pre></div>

<p><img alt="Configure Samba4 DNS" src="/data/attachment/album/201703/31/092908ybi0bx0bedxx66jc.png"></p>
<p><em>配置 Samba4 DNS</em></p>
<p>14、另外，还需要重命名原来的 <code>/etc</code>下的 kerberos 配置文件，并使用在加入域的过程中 Samba 生成的新配置文件 krb5.conf 替换它。</p>
<p>Samba 生成的新配置文件在 <code>/var/lib/samba/private</code> 目录下。使用 Linux 的符号链接将该文件链接到 <code>/etc</code> 目录。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># mv /etc/krb6.conf /etc/krb5.conf.initial</span>
<span class="c1"># ln -s /var/lib/samba/private/krb5.conf /etc/</span>
<span class="c1"># cat /etc/krb5.conf</span>
</code></pre></div>

<p><img alt="Configure Kerberos" src="/data/attachment/album/201703/31/092909y8poxc8nuxccnxhq.jpg"></p>
<p><em>配置 Kerberos</em></p>
<p>15、同样，使用 samba 的 <code>krb5.conf</code> 配置文件验证 Kerberos 认证是否正常。通过以下命令来请求一个管理员账号的票据并且列出已缓存的票据信息。</p>
<div class="highlight"><pre><span></span><code># kinit administrator
# klist
</code></pre></div>

<p><img alt="Verify Kerberos Authentication with Samba" src="/data/attachment/album/201703/31/092910hxx38nqageecd28x.jpg"></p>
<p><em>使用 Samba 验证 Kerberos 认证是否正常</em></p>
<h3>第 4 步：验证其它域服务</h3>
<p>16、你首先要做的一个测试就是验证 <strong>Samba4 DC DNS</strong> 解析服务是否正常。要验证域 DNS 解析情况，使用 <code>host</code> 命令，加上一些重要的 AD DNS 记录，进行域名查询，如下图所示：</p>
<p>每一次查询，DNS 服务器都应该返回两个 IP 地址。</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> host your_domain.tld
<span class="gh">#</span> host -t SRV _kerberos._udp.your_domain.tld  # UDP Kerberos SRV record
<span class="gh">#</span> host -t SRV _ldap._tcp.your_domain.tld  # TCP LDAP SRV record
</code></pre></div>

<p><img alt="Verify Samba4 DC DNS" src="/data/attachment/album/201703/31/092911l93w4ek4g1s13ww9.png"></p>
<p>*验证 Samba4 DC DNS *</p>
<p>17、这些 DNS 记录也可以从注册过的<a href="/article-8097-1.html">已安装了 RSAT 工具的 Windows 机器</a>上查询到。打开 DNS 管理器，展开到你的域 tcp 记录，如下图所示：</p>
<p><img alt="Verify DNS Records on Windows RSAT Tool" src="/data/attachment/album/201703/31/092911ummmz2nbnm37aw2a.png"></p>
<p><em>通过 Windows RSAT 工具来验证 DNS 记录</em></p>
<p>18、下一个验证是检查域 LDAP 复制同步是否正常。使用 <code>samba-tool</code> 工具，在第二个域控制器上创建一个账号，然后检查该账号是否自动同步到第一个 Samba4 AD DC 服务器上。</p>
<p>在 adc2 上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># samba-tool user add test_user</span>
</code></pre></div>

<p>在 adc1 上：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># samba-tool user list | grep test_user</span>
</code></pre></div>

<p><img alt="Create User Account on Samba4 AD" src="/data/attachment/album/201703/31/092911sm5yzi7hslh7ius5.jpg"></p>
<p><em>在 Samba4 AD 服务器上创建账号</em></p>
<p><img alt="Verify Replication on Samba4 AD" src="/data/attachment/album/201703/31/092912pli70kisv8if7i9e.jpg"></p>
<p><em>在 Samba4 AD 服务器上验证同步功能</em></p>
<p>19、你也可以从 <strong>Microsoft AD DC</strong> 控制台创建一个账号，然后验证该账号是否都出现在两个域控服务器上。</p>
<p>默认情况下，这个账号都应该在两个 samba 域控制器上自动创建完成。在 <code>adc1</code> 服务器上使用 <code>wbinfo</code> 命令查询该账号名。</p>
<p><img alt="Create Account from Microsoft AD UC" src="/data/attachment/album/201703/31/092912v77qh57ctyq888cq.png"></p>
<p><em>从 Microsoft AD UC 创建账号</em></p>
<p><img alt="Verify Account Replication On Samba4 AD" src="/data/attachment/album/201703/31/092913tcuuee4iktupieau.png"></p>
<p><em>在 Samba4 AD 服务器上验证账号同步功能</em></p>
<p>20、实际上，打开 Windows 机器上的 <strong>AD DC</strong> 控制台，展开到域控制器，你应该看到两个已注册的 DC 服务器。</p>
<p><img alt="Verify Samba4 Domain Controllers" src="/data/attachment/album/201703/31/092913lmcmahfc9sam86cb.png"></p>
<p><em>验证 Samba4 域控制器</em></p>
<h3>第 5 步：启用 Samba4 AD DC 服务</h3>
<p>21、要在整个系统启用 Samba4 AD DC 的服务，首先你得禁用原来的不需要的 Samba 服务，然后执行如下命令仅启用 samba-ad-dc 服务：</p>
<div class="highlight"><pre><span></span><code># systemctl disable smbd nmbd winbind
# systemctl enable samba-ad-dc
</code></pre></div>

<p><img alt="Enable Samba4 AD DC Services" src="/data/attachment/album/201703/31/092914lw1q2rfafcqr6nc7.png"></p>
<p><em>启用 Samba4 AD DC 服务</em></p>
<p>22、如果你从 Microsoft 客户端远程管理 Samba4 域控制器，或者有其它 Linux 或 Windows 客户机集成到当前域中，请确保在它们的网卡 DNS 服务器地址设置中提及 <code>adc2</code> 服务器的 IP 地址，以实现某种程序上的冗余。</p>
<p>下图显示 Windows 和 Debian/Ubuntu 客户机的网卡配置要求。</p>
<p><img alt="Configure Client to Administer Samba4 DC" src="/data/attachment/album/201703/31/092914puutuxox6tu64bmu.png"></p>
<p><em>配置 Windows 客户端来管理 Samba4 DC</em></p>
<p><img alt="Configure Linux Client to Administer Samba4 DC" src="/data/attachment/album/201703/31/092915li8kg6a98ok6roa6.png"></p>
<p><em>配置 Linux 客户端来管理 Samba4 DC</em></p>
<p>如果第一台 DC 服务器 192.168.1.254 网络不通，则调整配置文件中 DNS 服务器 IP 地址的顺序，以免先查询这台不可用的 DNS 服务器。</p>
<p>最后，如果你想在 Linux 系统上使用 Samba4 活动目录账号来进行本地认证，或者为 AD LDAP 账号授予 root 权限，请查看<a href="/article-8070-1.html">在 Linux 命令行下管理 Samba4 AD 架构</a> 这篇教程的 第 2 步和第 3 步。</p>
<p>via: <a href="http://www.tecmint.com/join-additional-ubuntu-dc-to-samba4-ad-dc-failover-replication/">http://www.tecmint.com/join-additional-ubuntu-dc-to-samba4-ad-dc-failover-replication/</a></p>
<p>作者：<a href="http://www.tecmint.com/author/admin/">Ravi Saive</a> 译者：<a href="https://github.com/rusking">rusking</a> 校对：<a href="https://github.com/jasminepeng">jasminepeng</a></p>
<p>本文由 <a href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a href="https://linux.cn/">Linux中国</a> 荣誉推出</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>